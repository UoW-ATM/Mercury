<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.1.0"/>
    <title>Mercury.agents.airline_operating_centre API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../agents.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;Mercury.agents</a>

            <img src="https://github.com/UoW-ATM/Mercury/blob/master/mercury_logo_small.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#AirlineOperatingCentre">AirlineOperatingCentre</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.__init__">AirlineOperatingCentre</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.dic_role">dic_role</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.afp">afp</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.pr">pr</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.tro">tro</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aph">aph</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.dcic">dcic</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.fps">fps</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aoc_flights_info">aoc_flights_info</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aoc_flight_plans">aoc_flight_plans</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aoc_pax_info">aoc_pax_info</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aoc_airports_info">aoc_airports_info</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aircraft_list">aircraft_list</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.other_aoc_flight_plans">other_aoc_flight_plans</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.aoc_delay_recovery_info">aoc_delay_recovery_info</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.fp_waiting_atfm">fp_waiting_atfm</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.new_paxs">new_paxs</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.times">times</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.duty_of_care">duty_of_care</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.compensation">compensation</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.non_pax_cost">non_pax_cost</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.non_atfm_delay_dist">non_atfm_delay_dist</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.trajectory_pool">trajectory_pool</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.fp_pool">fp_pool</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.alliance">alliance</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.nm_uid">nm_uid</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineOperatingCentre.cr">cr</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.set_log_file">set_log_file</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.average_missed_pax_cost">average_missed_pax_cost</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.average_cost_function">average_cost_function</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_reactionary_buffer">get_reactionary_buffer</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_curfew_buffer">get_curfew_buffer</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_obt">get_obt</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_origin">get_origin</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_destination">get_destination</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_status">get_status</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_pax_to_board">get_pax_to_board</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_ibt">get_ibt</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_mct">get_mct</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_airlines_in_alliance">get_airlines_in_alliance</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_flights">get_flights</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_all_airlines">get_all_airlines</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_airline_of_flight">get_airline_of_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_tat">get_tat</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_number_seats_flight">get_number_seats_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_number_seats_itinerary">get_number_seats_itinerary</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_average_price_on_leg">get_average_price_on_leg</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_total_travelling_time">get_total_travelling_time</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_last_ibt">get_last_ibt</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_first_obt">get_first_obt</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.get_n_pax_to_board">get_n_pax_to_board</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.give_duty_of_care_func">give_duty_of_care_func</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.give_compensation_func">give_compensation_func</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.give_non_pax_cost_delay">give_non_pax_cost_delay</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.give_delay_distr">give_delay_distr</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.own_flights">own_flights</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_list_aircraft">register_list_aircraft</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_aircraft">register_aircraft</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_airport">register_airport</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_pax_itinerary_group">register_pax_itinerary_group</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_trajectories_pool">register_trajectories_pool</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_fp_pool">register_fp_pool</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_nm">register_nm</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.register_flight">register_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineOperatingCentre.receive">receive</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FlightPlanSelector">FlightPlanSelector</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FlightPlanSelector.__init__">FlightPlanSelector</a>
                        </li>
                        <li>
                                <a class="variable" href="#FlightPlanSelector.option_selected">option_selected</a>
                        </li>
                        <li>
                                <a class="function" href="#FlightPlanSelector.wait_for_fp_selection_request">wait_for_fp_selection_request</a>
                        </li>
                        <li>
                                <a class="function" href="#FlightPlanSelector.decide_fp">decide_fp</a>
                        </li>
                        <li>
                                <a class="function" href="#FlightPlanSelector.select_fp">select_fp</a>
                        </li>
                        <li>
                                <a class="function" href="#FlightPlanSelector.send_option_selected">send_option_selected</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AirlineFlightPlanner">AirlineFlightPlanner</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.__init__">AirlineFlightPlanner</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineFlightPlanner.compute_FP_options">compute_FP_options</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineFlightPlanner.build_delay_cost_functions">build_delay_cost_functions</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineFlightPlanner.option_selected_for_fp">option_selected_for_fp</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineFlightPlanner.fp_waiting_option_events">fp_waiting_option_events</a>
                        </li>
                        <li>
                                <a class="variable" href="#AirlineFlightPlanner.dict_decide_options">dict_decide_options</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.cancel_flight">cancel_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_cancel_flight">send_cancel_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_cancel_flight_request">wait_for_cancel_flight_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.check_FP_submission">check_FP_submission</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.compute_FP">compute_FP</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool">compute_FP_options_from_fp_pool</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.estimate_curfew_buffer_old">estimate_curfew_buffer_old</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.estimate_curfew_buffer">estimate_curfew_buffer</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.estimate_curfew_buffer_rec">estimate_curfew_buffer_rec</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic">build_delay_cost_functions_heuristic</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight">build_delay_cost_functions_heuristic_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax">build_delay_cost_functions_heuristic_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic">build_delay_cost_functions_air_heuristic</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.compute_reactionary_delays">compute_reactionary_delays</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.compute_time_propagate_delay">compute_time_propagate_delay</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.return_propagation_delay_time">return_propagation_delay_time</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_request_propagation_delay_time">wait_for_request_propagation_delay_time</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.compute_cost_delay_function_air">compute_cost_delay_function_air</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.return_cost_delay_function">return_cost_delay_function</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_cost_delay_function_request">wait_for_cost_delay_function_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_advanced">build_delay_cost_functions_advanced</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.decide_options_alternatives">decide_options_alternatives</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.get_option">get_option</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.check_pax_ready_to_board">check_pax_ready_to_board</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.consider_waiting_pax">consider_waiting_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.save_wfp_info">save_wfp_info</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old">build_delay_cost_functions_dci_l2_old</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2">build_delay_cost_functions_dci_l2</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.calculate_missing_pax_delays">calculate_missing_pax_delays</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.cost_wait_for_pax_group">cost_wait_for_pax_group</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.cost_not_wait_for_pax_group">cost_not_wait_for_pax_group</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.cost_non_pax_curfew">cost_non_pax_curfew</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.estimate_pax_curfew_cost">estimate_pax_curfew_cost</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.calculate_overnight_care">calculate_overnight_care</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.plot_wait_pax_costs">plot_wait_pax_costs</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.reassess_departure_turnaround">reassess_departure_turnaround</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_request_select_option">send_request_select_option</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_ATFM_request">send_ATFM_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_flight_plan_update_no_compute">send_flight_plan_update_no_compute</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_cancellation_flight_message">send_cancellation_flight_message</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_flight_plan_submission">send_flight_plan_submission</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_FP_update">send_FP_update</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_reallocation_pax_request">send_reallocation_pax_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.update_eobt_processes">update_eobt_processes</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_atfm_slot">wait_for_atfm_slot</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_FP_acceptance">wait_for_FP_acceptance</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request">wait_for_departing_reassessment_turnaround_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_until_delay_estimation">wait_until_delay_estimation</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_until_FP_submission">wait_until_FP_submission</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_until_push_back_ready">wait_until_push_back_ready</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_request_flight_plan">send_request_flight_plan</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_request_flight_plan">wait_for_request_flight_plan</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan">wait_for_return_requested_flight_plan</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_fp_option_selection">wait_for_fp_option_selection</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_for_request_hotspot_decision">wait_for_request_hotspot_decision</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.make_hotspot_decision">make_hotspot_decision</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.send_hotspot_decision">send_hotspot_decision</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlineFlightPlanner.wait_until_pax_check">wait_until_pax_check</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DynamicCostIndexComputer">DynamicCostIndexComputer</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.__init__">DynamicCostIndexComputer</a>
                        </li>
                        <li>
                                <a class="variable" href="#DynamicCostIndexComputer.build_delay_cost_functions">build_delay_cost_functions</a>
                        </li>
                        <li>
                                <a class="variable" href="#DynamicCostIndexComputer.toc_event">toc_event</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.request_potential_delay_recovery_info">request_potential_delay_recovery_info</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info">wait_for_potential_delay_recovery_info</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.wait_for_toc_reached_message">wait_for_toc_reached_message</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.cost_index_assessment">cost_index_assessment</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed">decide_if_delay_recovery_performed</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.plot_costs_dci">plot_costs_dci</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old">build_delay_cost_functions_dci_l1_old</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1">build_delay_cost_functions_dci_l1</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.reassess_cost_index_TA0">reassess_cost_index_TA0</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.reassess_cost_index_TA1">reassess_cost_index_TA1</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.reassess_cost_index_TA2">reassess_cost_index_TA2</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu">send_speed_up_msg_to_fpu</a>
                        </li>
                        <li>
                                <a class="function" href="#DynamicCostIndexComputer.save_dci_decision_info">save_dci_decision_info</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#PassengerReallocation">PassengerReallocation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#PassengerReallocation.check_push_back">check_push_back</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.compute_missed_connecting_pax">compute_missed_connecting_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.compute_reallocation_options">compute_reallocation_options</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.do_reallocation">do_reallocation</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.reallocate_pax">reallocate_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.send_allocation_pax_request">send_allocation_pax_request</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.send_remove_pax_from_boarding_list_request">send_remove_pax_from_boarding_list_request</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request">wait_for_remove_pax_from_boarding_list_request</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.wait_for_allocation_pax_request">wait_for_allocation_pax_request</a>
                        </li>
                        <li>
                                <a class="function" href="#PassengerReallocation.wait_for_reallocation_pax_request">wait_for_reallocation_pax_request</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TurnaroundOperations">TurnaroundOperations</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TurnaroundOperations.check_arrival">check_arrival</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.check_delay_estimation">check_delay_estimation</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.process_following_flight">process_following_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.request_process_arrival_pax">request_process_arrival_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.request_turnaround">request_turnaround</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.request_departing_reassessment">request_departing_reassessment</a>
                        </li>
                        <li>
                                <a class="function" href="#TurnaroundOperations.wait_for_turnaround_time">wait_for_turnaround_time</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AirlinePaxHandler">AirlinePaxHandler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AirlinePaxHandler.check_push_back">check_push_back</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.check_delay_liability">check_delay_liability</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.do_pax_care">do_pax_care</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.board_pax">board_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.arrive_pax">arrive_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost">find_blame_for_compensation_and_soft_cost</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.pay_pax_cost">pay_pax_cost</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.follow_blame_flight">follow_blame_flight</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.request_reallocate_pax">request_reallocate_pax</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.request_connecting_times">request_connecting_times</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.request_pax_connection_handling">request_pax_connection_handling</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.handle_pax_connection">handle_pax_connection</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.send_cost_blame">send_cost_blame</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.send_follow_blame_request">send_follow_blame_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.wait_for_connecting_times">wait_for_connecting_times</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.wait_for_cost_blame">wait_for_cost_blame</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.wait_for_follow_blame">wait_for_follow_blame</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.wait_for_pax_connection_handling_request">wait_for_pax_connection_handling_request</a>
                        </li>
                        <li>
                                <a class="function" href="#AirlinePaxHandler.wait_for_process_arrival_pax_request">wait_for_process_arrival_pax_request</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../Mercury.html">Mercury</a><wbr>.<a href="./../agents.html">agents</a><wbr>.airline_operating_centre    </h1>

                
                        <input id="mod-airline_operating_centre-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-airline_operating_centre-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">uuid</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">simpy</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">compress</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">..core.delivery_system</span> <span class="kn">import</span> <span class="n">Letter</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">from</span> <span class="nn">..libs.other_tools</span> <span class="kn">import</span> <span class="n">clone_pax</span><span class="p">,</span> <span class="n">flight_str</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">from</span> <span class="nn">..libs.uow_tool_belt.general_tools</span> <span class="kn">import</span> <span class="n">keep_time</span><span class="p">,</span> <span class="n">build_col_print_func</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">..libs</span> <span class="kn">import</span> <span class="n">Hotspot</span> <span class="k">as</span> <span class="n">hspt</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">.agent_base</span> <span class="kn">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">Role</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="c1"># from .commodities.debug_flights import flight_uid_DEBUG</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="k">class</span> <span class="nc">AirlineOperatingCentre</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="sd">	Agent representing an airline operating centre.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">	This includes:</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="sd">	- Processes related to flight and fleet management, such as:</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">		- selection of flight plan</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="sd">		- planning of flight plan</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">		- compute dynamic cost index for speed adjustment of flights</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="sd">		- turnaround operation management</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">	- Processes related to management of passengers, such as:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">		- Passengers reallocation</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">		- Passenger handler</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="sd">	The decisions are mostly driven by expected cost of delay</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>	<span class="c1">#  Dictionary with roles contained in the Agent</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>	<span class="n">dic_role</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AirlineFlightPlanner&#39;</span><span class="p">:</span> <span class="s1">&#39;afp&#39;</span><span class="p">,</span>  <span class="c1"># Flight planning</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>				<span class="s1">&#39;PassengerReallocation&#39;</span><span class="p">:</span> <span class="s1">&#39;pr&#39;</span><span class="p">,</span>  <span class="c1"># Reallocation of passengers if miss connections</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>				<span class="s1">&#39;TurnaroundOperations&#39;</span><span class="p">:</span> <span class="s1">&#39;tro&#39;</span><span class="p">,</span>  <span class="c1"># Turnaround management (incl. FP recomputation and pax management)</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>				<span class="s1">&#39;AirlinePaxHandler&#39;</span><span class="p">:</span> <span class="s1">&#39;aph&#39;</span><span class="p">,</span>  <span class="c1"># Handling of passengers (arrival)</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>				<span class="s1">&#39;DynamicCostIndexComputer&#39;</span><span class="p">:</span> <span class="s1">&#39;dcic&#39;</span><span class="p">,</span>  <span class="c1"># Dynamic cost index computation to compute if speed up flights</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>				<span class="s1">&#39;FlightPlanSelector&#39;</span><span class="p">:</span> <span class="s1">&#39;fps&#39;</span><span class="p">}</span>  <span class="c1"># Selection of flight plan (flight plan dispatching)</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>		<span class="c1"># Roles</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">afp</span> <span class="o">=</span> <span class="n">AirlineFlightPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">PassengerReallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">tro</span> <span class="o">=</span> <span class="n">TurnaroundOperations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aph</span> <span class="o">=</span> <span class="n">AirlinePaxHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span> <span class="o">=</span> <span class="n">DynamicCostIndexComputer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">FlightPlanSelector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Decides which flight plan to use for a given flight</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>		<span class="c1"># Apply modifications due to modules</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">apply_agent_modifications</span><span class="p">()</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>		<span class="c1"># Internal knowledge</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flights for the airline and their status (load factors, schedules, operated, etc.)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flight plans for given flights (flight key)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_pax_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># In theory, this should only be used for pax reallocation</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on airports used by flight from the airline</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># List of aircraft used by the airline</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Temporary save flight plan for flights</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on the delay recovery for a flight aoc gets from pdrp (role in Flight)</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_atfm</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information of flight waiting to recieve ATFM info</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">new_paxs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of new passenger groups created (e.g. split from groups)</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># CPU time for code performance assessment</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Duty of care function</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function to give compensation</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function for non pax costs</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Distribution of Non ATFM delay</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of trajectories between o-d to be used if FP generated on the fly based on trajectories</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of FPs</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">alliance</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Alliance for the arline. To be filled when registering airline into alliance</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NetworkManager Agent UID</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pointer to the Central Registry. To be filled when registering airline to CR</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>		<span class="c1"># Atributes passed on construction in init</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>		<span class="c1"># We could have passed information asking to use pool of flight plans or not</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;use_pool_fp&#39;</span><span class="p">):</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;compensation_uptake&#39;</span><span class="p">):</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;icao&#39;</span><span class="p">):</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;airline_type&#39;</span><span class="p">):</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>	<span class="k">def</span> <span class="nf">set_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">		Set log file for the Agent.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">		TBC by logging system</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>		<span class="k">global</span> <span class="n">aprint</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>		<span class="n">aprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aprint</span> <span class="o">=</span> <span class="n">aprint</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>		<span class="k">global</span> <span class="n">mprint</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>		<span class="n">mprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">mprint</span> <span class="o">=</span> <span class="n">mprint</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>	<span class="k">def</span> <span class="nf">average_missed_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="sd">		Function to obtain average cost of passenger missing connection</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">		pax: passenger type</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">		TODO: cost now hard coded, at least passed as parameter</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;economy&#39;</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>			<span class="k">return</span> <span class="mf">1000.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>		<span class="k">elif</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">:</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>			<span class="k">return</span> <span class="mf">5000.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>	<span class="k">def</span> <span class="nf">average_cost_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">		Very high-level/averaged, only to be used for rough estimation.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">		delay: minutes of delay</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">		TODO: average cost now hard coded, at least passed as parameter</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>		<span class="k">return</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">delay</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>	<span class="k">def</span> <span class="nf">get_reactionary_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">		Get reactionary buffer for a given flight, i.e., delay after which the propagation of the delay</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">		might trigger a breach of a curfew</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>	<span class="k">def</span> <span class="nf">get_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">		Get buffer for flight before reaching curfew. Using central registry.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>	<span class="k">def</span> <span class="nf">get_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">		Get OBT of a flight. Using central registry.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>	<span class="k">def</span> <span class="nf">get_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">		Get origin of a flight. Using central registry.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>	<span class="k">def</span> <span class="nf">get_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">		Get destination of a flight. Using central registry.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>	<span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">		Get flight status. Using central registry.</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>	<span class="k">def</span> <span class="nf">get_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">		Get pax to board a flight. Using central registry.</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>	<span class="k">def</span> <span class="nf">get_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">		Get IBT of a flight. Using central registry.</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>	<span class="k">def</span> <span class="nf">get_mct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">		Get MCT between two flights for a given pax type. Using central registry.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">)</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>	<span class="k">def</span> <span class="nf">get_airlines_in_alliance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">		Get alliance for the airline Using central registry.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">alliance_composition</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alliance</span><span class="p">]</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>	<span class="k">def</span> <span class="nf">get_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">):</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">		Get flights for a given AOC. Using central registry.</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>		<span class="c1"># TODO: move this to get_flights_of_other_airlines and how_flights go get_own_flights or get_flights</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>	<span class="k">def</span> <span class="nf">get_all_airlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">		Get all airlines using central registry.</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">()</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>	<span class="k">def</span> <span class="nf">get_airline_of_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">		Get airline for a given flight. Using central registry.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>	<span class="k">def</span> <span class="nf">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">		Returns a typical turnaround time based on the type of aircraft of flight_uid. Using central registry.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>		<span class="c1"># aircraft = self.aoc_flights_info[flight_uid][&#39;aircraft&#39;]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>		<span class="c1"># return self.aoc_airports_info[airport_uid][&#39;tats&#39;][aircraft.bada_performances.wtc][self.airline_type]</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">		Get number seats available for a flight. Using central registry.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_itinerary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a><span class="sd">		Get number seats available for a given itinerary. Using central registry.</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>	<span class="k">def</span> <span class="nf">get_average_price_on_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a><span class="sd">		This is computed using only the price paid by passengers without</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="sd">		connection if possible. If there is none, use the number of legs as weight.</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a><span class="sd">		Using the central registry</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>	<span class="k">def</span> <span class="nf">get_total_travelling_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a><span class="sd">		Note: this assumes that the connections are feasible.</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">		Note: it uses the most up-to-date information.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">		Using the central registry</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>	<span class="k">def</span> <span class="nf">get_last_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">		Get last IBT for an itinerary. Using central registry.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>	<span class="k">def</span> <span class="nf">get_first_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">		Get fist OBT for an itinerary. Using central registry.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>	<span class="k">def</span> <span class="nf">get_n_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">		Get number pax to board a flight.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>		<span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]])</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>	<span class="k">def</span> <span class="nf">give_duty_of_care_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty_of_care_func</span><span class="p">):</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>		<span class="c1"># self.duty_of_care = duty_of_care_func</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>			<span class="k">return</span> <span class="n">duty_of_care_func</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>	<span class="k">def</span> <span class="nf">give_compensation_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compensation_func</span><span class="p">):</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>		<span class="c1"># self.compensation = compensation_func</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>			<span class="k">return</span> <span class="n">compensation_func</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>		<span class="c1"># The following is for quick computation (but is approximated).</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>		<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mf">60.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>		<span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4000.</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>		<span class="n">compensation_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">compensation_func</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xx</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">])</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation_quick</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">delay</span><span class="o">&lt;</span><span class="mf">0.</span> <span class="k">else</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="o">*</span><span class="n">compensation_values</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">399</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="o">/</span><span class="mi">10</span><span class="p">))][</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay</span><span class="p">))]</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>	<span class="k">def</span> <span class="nf">give_non_pax_cost_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">):</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">		For &#39;dict_np_cost&#39;, the first level key should be the type of aircraft.</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">		The second level key be the phase of flight:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">		-at_gate,</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">		-taxi,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">		-airborne</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">		The values are the cost (in euros) per minute of a delay.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">		For &#39;dict_np_cost_fit&#39;, the first level should the phase of flight. The second</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">		level should have &#39;a&#39; and &#39;b&#39;. These coefficients should used when the aircraft type</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">		if no available in the first dictionary, using the sqrt of the MTOW of the aircraft:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">		c = a + b * sqrt(MTWO),</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">		where c is the cost of one minute of delay, as per above.</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>			<span class="k">if</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span> <span class="ow">in</span> <span class="n">dict_np_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>	<span class="k">def</span> <span class="nf">give_delay_distr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">		random numbers following dist should be drawn using dist.rvs(random_state=self.agent.rs) or dist.rvs(5)</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="n">dist</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>	<span class="k">def</span> <span class="nf">own_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">		Get list of own flight by the airline</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>		<span class="c1"># Merge with get_flights...</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>	<span class="k">def</span> <span class="nf">register_list_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a><span class="sd">		Register list of aircraft in AOC</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="n">aircraft</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>	<span class="k">def</span> <span class="nf">register_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a><span class="sd">		Add one aircraft to the list of aircraft registered in the AOC</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aircraft</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>	<span class="k">def</span> <span class="nf">register_airport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport</span><span class="p">):</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a><span class="sd">		Add one airport to the list of airports in the AOC</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a><span class="sd">		mcts are designed so that one can do:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a><span class="sd">		mcts = self.aoc_airports_info[airport_uid][&#39;mcts&#39;]</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a><span class="sd">		mct = mcts[(self.aoc_flights_info[flight_uid1][&#39;international&#39;], self.aoc_flights_info[flight_uid2][&#39;international&#39;])]</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">airport</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mcts&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">mcts</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>												<span class="s1">&#39;tats&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">tats</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>												<span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_out_time</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>												<span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_in_time</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>												<span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>												<span class="s1">&#39;dman_uid&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">dman_uid</span><span class="p">,</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>												<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">curfew</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>												<span class="s1">&#39;ICAO&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">icao</span><span class="p">}</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>	<span class="k">def</span> <span class="nf">register_pax_itinerary_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a><span class="sd">		Register pax group (with its itineraries) in the airline</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board_initial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>	<span class="k">def</span> <span class="nf">register_trajectories_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_pool</span><span class="p">):</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="sd">		Register pool of trajectories. If generating FP on the fly</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="n">trajectory_pool</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>	<span class="k">def</span> <span class="nf">register_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp_pool</span><span class="p">):</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">		Register poool of flight plans.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="n">fp_pool</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>	<span class="k">def</span> <span class="nf">register_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">		Register NetworkManager</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>	
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>	<span class="k">def</span> <span class="nf">register_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight</span><span class="p">):</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">		Register a flight in the AOC.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>		<span class="c1"># Give DMAN id to flight</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">dman_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;dman_uid&#39;</span><span class="p">]</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>		<span class="c1"># # Add flight to the list that the aircraft needs to operate</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>		<span class="c1"># self.aircraft_list[flight.ac_uid].add_flight(flight.uid)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>									<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>									<span class="s1">&#39;flight_db_id&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>									<span class="s1">&#39;callsign&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">callsign</span><span class="p">,</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>									<span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;scheduled&#39;</span><span class="p">,</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>									<span class="s1">&#39;international&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">international</span><span class="p">,</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>									<span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">,</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>									<span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">destination_airport_uid</span><span class="p">,</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>									<span class="s1">&#39;sobt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sobt</span><span class="p">),</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>									<span class="s1">&#39;sibt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sibt</span><span class="p">),</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>									<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">curfew</span><span class="p">),</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>									<span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">can_propagate_to_curfew</span><span class="p">),</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>									<span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">],</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>									<span class="s1">&#39;fp_options&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>									<span class="s1">&#39;fp_option&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>									<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>									<span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>									<span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>									<span class="s2">&quot;pax_to_board_initial&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>									<span class="s2">&quot;pax_to_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>									<span class="s2">&quot;pax_on_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>									<span class="c1"># pax lists for waiting pax</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>									<span class="s2">&quot;pax_ready_to_board_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>									<span class="s2">&quot;pax_to_wait_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>									<span class="s2">&quot;pax_check_already_performed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>									<span class="s1">&#39;FP_submission_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>									<span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>									<span class="s1">&#39;push_back_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">,</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>									<span class="s1">&#39;pax_check_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">,</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>									<span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">,</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>									<span class="s1">&#39;takeoff_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">takeoff_event</span><span class="p">,</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>									<span class="s1">&#39;DOC&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>									<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>									<span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>									<span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>									<span class="s1">&#39;non_pax_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>									<span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>									<span class="s1">&#39;main_reason_delay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>									<span class="c1"># &#39;flight_swaps&#39;:[],</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>									<span class="c1"># &#39;cost_swaps&#39;:[],</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>									<span class="c1"># &#39;id_swaps&#39;:[]</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>									<span class="p">}</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>		<span class="c1"># Give aircraft to flight</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">]</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span><span class="o">.</span><span class="n">add_flight</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>		<span class="c1"># Give some info to flight on airline</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_icao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;aoc_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>		<span class="c1"># Using wait_until allows to wait for a time and then succeed the event.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>		<span class="c1"># The event should not be the process itself, because if a reschedule</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>		<span class="c1"># happens, one needs to cancel the wait_until process but keep the pointer</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>		<span class="c1"># to the event itself, since it is likely to be shared with other agents.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>		<span class="c1"># This procedure should be used for anything with a waiting time (which may be rescheduled).</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>		<span class="c1"># There is no need for this in the case of the event happens at the end of a given process</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>		<span class="c1"># (e.g. flying a segment).</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">))</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">))</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_pax_ready_to_board</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">))</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_arrival</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">arrival_event</span><span class="p">))</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>		<span class="c1"># for dci</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">cost_index_assessment</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">))</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># for connecting pax wait!</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>													<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>													<span class="p">}</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a><span class="sd">		Receive and distribute messages within the Agent</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;allocation_pax_request&#39;</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_allocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;connecting_times&#39;</span><span class="p">:</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_connecting_times</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>		<span class="c1"># elif msg[&#39;type&#39;] == &#39;flight_plan_request&#39;:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>		<span class="c1"># 	self.afp.wait_for_FP_request(msg)</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_plan_acceptance&#39;</span><span class="p">:</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_FP_acceptance</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;atfm_delay&#39;</span><span class="p">:</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_atfm_slot</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;turnaround_time&#39;</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">wait_for_turnaround_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;departing_reassessment_request&#39;</span><span class="p">:</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pax_connection_handling&#39;</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cost_blame&#39;</span><span class="p">:</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_cost_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;follow_blame&#39;</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_follow_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>		<span class="c1"># wfp &amp; dci</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_flight_plan&#39;</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_potential_delay_recover_information&#39;</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;toc_reached&#39;</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_toc_reached_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_time_propagate_delay&#39;</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_cost_delay_function&#39;</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancel_flight_request&#39;</span><span class="p">:</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cancel_flight_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;select_flight_option_request&#39;</span><span class="p">:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="o">.</span><span class="n">wait_for_fp_selection_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reply_option_selected&#39;</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_fp_option_selection</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_hotspot_decision&#39;</span><span class="p">:</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>			<span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>			<span class="k">for</span> <span class="n">receive_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_module_functions</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>				<span class="n">hit</span> <span class="o">=</span> <span class="n">receive_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>				<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: unrecognised message type received by&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">		Provide textual id of the AOC</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>		<span class="k">return</span> <span class="s2">&quot;AOC &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="k">class</span> <span class="nc">FlightPlanSelector</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">	FPS: Flight Plan Selector</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">	This role decides which FP to use considering the expected cost of different flight plan alternatives.</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">	It does the role of the dispatcher when selecting between alternative FP possibilities for a given flight.</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">	The need for this role is to provide the extraction of these functionalities to be done by an external agent.</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary for each flight which flight plan has been selected</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_selection_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">		Entry point for the role. Getting a request to select a flight plan for a given flight from a list of</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">		alternatives.</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">		This only initialise the FP selected for the flight to nothing and calls the function to decide with FP to use</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialise the flight plan for the flight with nothing selected</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>		<span class="c1"># yield self.agent.env.process(self.select_fp(cost_options=msg[&#39;body&#39;][&#39;cost_options&#39;],flight_uid=msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>		<span class="c1"># Request the process of decide which fp to do for the flight</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_fp</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>	<span class="k">def</span> <span class="nf">decide_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">		It requests the select_fp function do to the selection, updates the option selected and provides the</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">		fp selected back.</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>		<span class="c1"># 	print(&#39;AOC will decide which FP to choose for flight {}&#39;.format(flight_uid))</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_fp</span><span class="p">(</span><span class="n">cost_options</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_options&#39;</span><span class="p">],</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>														<span class="n">flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>		<span class="c1"># option_selected_fp = self.option_selected[flight_uid]</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>		<span class="c1"># self.send_option_selected(msg[&#39;to&#39;],option_selected_fp,msg[&#39;body&#39;][&#39;flight_uid&#39;])</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_option_selected</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">],</span> <span class="n">option</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>	<span class="k">def</span> <span class="nf">select_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="sd">		This is yield rather than a return to take into account the case</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="sd">		where the agent is asynchronuous, e.g. when there is a human operator</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="sd">		(see HMI_FP_SEL module).</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>		<span class="n">costs</span> <span class="o">=</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;delay_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;crco_cost&#39;</span><span class="p">]</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>		<span class="c1"># 	print(&quot;SELECT FP {} (costs length: {})&quot;.format(flight_uid, len(costs)))</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>		<span class="n">costs_bis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">costs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">smoothness_fp</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>		<span class="k">if</span> <span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">costs_bis</span><span class="o">/</span><span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">))</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>			<span class="n">prob</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">))),</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>	<span class="k">def</span> <span class="nf">send_option_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">		Reply back with the fp that has been selected for the flight.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reply_option_selected&#39;</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">:</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="k">class</span> <span class="nc">AirlineFlightPlanner</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">	AFP: Airline Flight Planner</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">	Description:</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">	Select which flight plan will be executed. This means selecting the 4D trajectory (including delayed departing time (e.g., waiting for passengers)) and possibly cancelling flight (i.e., the Airline Flight Planner decides to cancel the flight plan).</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">	1. Check which flights are ready for pre-departure (less than 3 hours before their EOBT and in scheduled status) or get a request to recompute the flight plan selection of a given flight.</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">	2. Submit flight plan which might lead to ATFM delay update.</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">	3. Check different flight plan options and their costs.</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">	4. Decide which flight plan to execute tactically.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">	The liveness of AFP will depend on the mechanism 4DT and the FP implementation.</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">	The action of RequestATFMSlot will depend on the FP mechanism:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">		- FP_0: Request ATFM slot</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">		- FP_1 and FP_2: Request ATFM slot and then prioritise the flight and optionally request a flight swap.</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">	The action of DecideOption depends on 4DT:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">		- 4DT_0: Rule of thumb to decide between speed-up, wait-for-passengers and cancellation</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">		- 4DT_1 and 4DT_2: Selection of option based on cost provided by CheckFPOption</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options_from_fp_pool</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>		<span class="c1"># self.build_delay_cost_functions = self.build_delay_cost_functions_advanced</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>	<span class="k">def</span> <span class="nf">cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="s1">&#39;due to&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>		<span class="c1"># Mark the flight as cancelled. This needs to be before reallocating</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>		<span class="c1"># passengers, so they are not rellocated on an itinerary including this flight.</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>		<span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>			<span class="c1"># print(&quot;WTC cancel: &quot;,self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].wtc)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>			<span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;CANCEL_CF&quot;</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>				<span class="c1"># We cancelled due to curfew add extra non-pax costs of Laurent</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>		<span class="c1"># Pax will blame ANY compensation, soft cost, or transfer cost on the cancelled flight</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames soft cost on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames compensation on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>		<span class="c1"># Reallocate passenger which are already in transit</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>		<span class="n">pax_to_reallocate</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>								<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;, because&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>				<span class="s1">&#39;has been cancelled, the following paxs need to be reallocated:&#39;</span><span class="p">,</span> <span class="n">pax_to_reallocate</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>				<span class="s1">&#39;(the rest will be reallocated when they reach the airport of departure of the cancelled flight)&#39;</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>		<span class="c1"># # All victims of cancellations can be compensated.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>		<span class="c1"># for pax in self.agent.aoc_flights_info[flight_uid][&#39;pax_to_board&#39;]:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>		<span class="c1"># 	pax.force_entitled = True</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>		<span class="c1"># Check liability for compensation</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_reallocation_pax_request</span><span class="p">(</span><span class="n">pax_to_reallocate</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>		<span class="c1"># Disseminate the cancellation of the flight plan, if any</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_cancellation_flight_message</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>		<span class="c1"># Cancel all events linked to flight</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling all events of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_event&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_proc&#39;</span><span class="p">):</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>				<span class="k">try</span><span class="p">:</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>					<span class="n">value</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>				<span class="k">except</span><span class="p">:</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>					<span class="k">pass</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>		<span class="c1"># Prepare next flight (using turnaround operator)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>		<span class="c1"># self.agent.tro.process_following_flight(flight_uid)</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>			<span class="n">next_flights_uids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>			<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights_uids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>				<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">next_flights_uids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>			<span class="k">raise</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>			<span class="nb">print</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>			<span class="k">raise</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cancel_cascade_curfew</span><span class="p">:</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>			<span class="c1"># Cancel in cascade after curfew</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Because flight&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;has been cancelled due to curfew, AOC sends a cancelling signal to flight&#39;</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>				   <span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;cascade cancelation&#39;</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>			<span class="c1">#     aprint(flight_str(flight_uid), &#39;has&#39;, aircraft, \</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>			<span class="c1">#             &#39;status of current request (triggered, processed, defused):&#39;, request.triggered,\</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>			<span class="c1">#             request.processed,\</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>			<span class="c1">#             request.defused)</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_cancel_flight</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">)</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>	<span class="k">def</span> <span class="nf">send_cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancel_flight_request&#39;</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>						<span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">}</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>	<span class="k">def</span> <span class="nf">wait_for_cancel_flight_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>	<span class="k">def</span> <span class="nf">check_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP_submission_event</span><span class="p">):</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>		<span class="k">yield</span> <span class="n">FP_submission_event</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>		<span class="c1"># 	print(&quot;{} does the first FP submission for flight {}&quot;.format(self.agent, flight_uid))</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_FP_submission&#39;</span><span class="p">):</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>													<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>	<span class="k">def</span> <span class="nf">compute_FP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fp_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>		<span class="c1"># aoc_flight_info = self.agent.aoc_flights_info[flight_uid]</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes the flight plan options for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>		<span class="c1"># 	print(&#39;\nAOC tries to find a FP for flight {} with sobt {} (t={})&#39;.format(flight_uid,</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>		<span class="c1"># 																				self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;],</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>		<span class="c1"># 																				self.agent.env.now))</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>		<span class="c1"># just_computed = False</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>		<span class="c1"># if self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;] is None:</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>		<span class="c1">#  This flight does not have a flight plan yet, so it</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>		<span class="c1">#  needs to find one.</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>		<span class="c1"># Compute all possible flight plan options</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>		<span class="k">if</span> <span class="n">fp_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>			<span class="c1"># 	print(&#39;AOC RECOMPUTES FPs FOR FLIGHT {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>													<span class="n">eobt</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>				<span class="k">raise</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>		<span class="c1"># 	print(&#39;ELT FOR EACH FP OPTION FOR FLIGHT {}:&#39;.format(flight_uid), [fp.get_eta_wo_atfm() for fp in fp_options])</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a><span class="w">		</span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">		print(&#39;FP options:&#39;)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">		for option in fp_options:</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="sd">			print(option)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a><span class="sd">			print(&#39;with eobt:&#39;, option.eobt)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="sd">			print(&#39;with eibt:&#39;, option.eibt)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="sd">		&#39;&#39;&#39;</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>		<span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>			<span class="c1"># 	print(&#39;OPTION NOT FOUND FOR FLIGHT {}&#39;.format(flight_uid))</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_options_alternatives</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>																			<span class="n">fp_options</span><span class="p">,</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>																			<span class="n">current_option</span><span class="o">=</span><span class="n">option</span><span class="p">))</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>			<span class="c1"># 	print(&#39;AOC considers FP option {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>				<span class="c1"># print(&#39;BORNE2 {} (found: {}, fp_options length: {})&#39;.format(flight_uid, found, len(fp_options)))</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>			<span class="c1"># An option is selected, but might not be accepted yet because</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>			<span class="c1"># in general it needs to have an ATFM slot. The following does exactly this.</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp_options[option].get_unique_id()] = received_atfm_message_event</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>				<span class="c1"># 	print(&#39;AOC sends ATFM request for flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>				<span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;submitted&#39;</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>				<span class="c1"># 	print(&#39;BORNE4 {}&#39;.format(flight_uid))</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;has made a decision. Cancellation:&quot;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span> <span class="s1">&#39;; option chosen:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="s2">&quot;among&quot;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>		<span class="c1"># 	print(&quot;AOC has reached a decision. Cancellation:&quot;,</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>		<span class="c1"># 				cancellation,</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>		<span class="c1"># 				&#39;; option chosen:&#39;,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>		<span class="c1"># 				option,</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>		<span class="c1"># 				&quot;among&quot;,</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>		<span class="c1"># 				fp_options,</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>		<span class="c1"># 				&#39; ; ETA without ATFM delay:&#39;,</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>		<span class="c1"># 				fp_options[option].get_eta_wo_atfm())</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>		<span class="c1"># 	# print(&#39;OPTION CHOSEN FOR FLIGHT (ETA without ATFM delay):&#39;, option, fp_options[option].get_eta_wo_atfm())</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>		<span class="k">if</span> <span class="n">cancellation</span><span class="p">:</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">])</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>			<span class="c1"># If accepted, mark it as the FP adopted and send an FP submission.</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>			<span class="n">reception_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>			<span class="c1"># 	print(&#39;AOC submits flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">reception_event</span><span class="o">=</span><span class="n">reception_event</span><span class="p">)</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>			<span class="k">yield</span> <span class="n">reception_event</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>			<span class="c1"># Then consider potential flight swapping.</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>			<span class="c1"># BEWARE: the flight plan needs to be already accepted and returned before</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>			<span class="c1"># the airline considers the flight swapping.</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>			<span class="c1"># self.consider_flight_swap(flight_uid, fp_options[option])</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>		<span class="c1"># just_computed = True</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>		<span class="c1"># if (not cancellation) and (ac_ready_at_time is None) and (self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;] is not None):</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>		<span class="c1"># 	# We got the ac_ready time before the first flight plan submitted. Update ac_ready_time</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>		<span class="c1"># 	self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].reactionary_delay = self.agent.aoc_flights_info[flight_uid][&#39;reactionary_delay_prior_FP&#39;]</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>		<span class="c1"># 	ac_ready_at_time = self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>		<span class="c1"># #if (not cancellation) and (not ac_ready_at_time is None) and (not just_computed):</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>		<span class="c1"># 	#mprint(flight_str(flight_uid), &#39;has an ac_ready_time of&#39;, ac_ready_at_time)</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>		<span class="c1"># 	# This flight has a flight plan and it is a recomputation that might be needed</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>		<span class="c1"># 	current_fp = self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;]#[&#39;fp_options&#39;][self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;]]</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>		<span class="c1"># 	new_eobt = max(ac_ready_at_time, current_fp.eobt)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>		<span class="c1"># 	# if not (new_eobt==current_fp.eobt and just_computed):</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>		<span class="c1"># 	 	print(&#39;AOC will update EOBT of flight {} because the aircraft was not ready in time (OLD EOBT IS {}, NEW EOBT IS {}, OLD ELT IS {})&#39;.format(flight_uid, current_fp.eobt, new_eobt, current_fp.get_estimated_landing_time()))</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>		<span class="c1"># 	mprint(flight_str(flight_uid), &#39;has a new eobt of&#39;, new_eobt,</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>		<span class="c1"># 		&#39;and resubmits its flight plan.&#39;)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>		<span class="c1"># 	current_fp.update_eobt(new_eobt)</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>		<span class="c1"># 		print(&#39;AOC has modified the flight plan ({}) EOBT for flight {} and resubmits it (ELT IS {})&#39;.format(flight_uid, current_fp, current_fp.get_estimated_landing_time()))</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>		<span class="c1"># 	self.send_flight_plan_submission(flight_uid, current_fp)</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>	<span class="k">def</span> <span class="nf">compute_FP_options_from_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">,</span> <span class="n">eobt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is creating the possible flight plans for flight&#39;</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>		<span class="c1"># if aoc_flight_info[&#39;flight_uid&#39;] in flight_uid_DEBUG:</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>		<span class="c1"># 	print(&quot;{} compute the FP options from fp pool for flight {} with EOBT {}&quot;.format(self.agent, aoc_flight_info[&#39;flight_uid&#39;], eobt))</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>		<span class="k">if</span> <span class="n">eobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eobt</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>		<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>		<span class="n">destination_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>		<span class="c1"># ac_performances_bada = aoc_flight_info[&#39;aircraft&#39;].bada_performances</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>		<span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bada_code_ac_model</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>			<span class="n">possible_fp_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="p">[(</span><span class="n">origin_airport_uid</span><span class="p">,</span> <span class="n">destination_airport_uid</span><span class="p">,</span> <span class="n">bada_code_ac_model</span><span class="p">)]</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COICOIN&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>			<span class="k">raise</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>		<span class="k">for</span> <span class="n">pfp</span> <span class="ow">in</span> <span class="n">possible_fp_pool</span><span class="p">:</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>			<span class="n">fp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>			<span class="c1"># fp.eobt = aoc_flight_info[&#39;sobt&#39;]</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">eobt</span> <span class="o">=</span> <span class="n">eobt</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sibt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">destination_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">bada_code_ac_model</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">flight_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">compute_eibt</span><span class="p">()</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">add_event_to_point</span><span class="p">(</span><span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;takeoff_event&#39;</span><span class="p">],</span> <span class="s1">&#39;takeoff&#39;</span><span class="p">)</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">get_unique_id</span><span class="p">()]</span> <span class="o">=</span> <span class="n">fp</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options</span> <span class="o">+</span> <span class="p">[</span><span class="n">fp</span><span class="p">]</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">remove_shorter_route_calibration</span><span class="p">:</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">option</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">get_total_planned_distance</span><span class="p">())</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">fp_options</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>		<span class="k">return</span> <span class="n">fp_options</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>		<span class="n">buf</span> <span class="o">=</span> <span class="mi">999999999991</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>			<span class="c1"># Get minimum buffer to avoid curfews on downstream flights</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>			<span class="c1"># Note: not taking into account curfew for this flight, because flight plan</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>			<span class="c1"># has been accepted and thus should be legit (arriving before curfew).</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>			<span class="c1"># Get all flights after this one using the same aircraft</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>			<span class="n">next_flights</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">next_flights</span><span class="p">):</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>				<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>					<span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">)</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>				<span class="n">buf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">),</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Buffer computed for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>		<span class="k">return</span> <span class="n">buf</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>			<span class="k">return</span> <span class="mi">999999999991</span><span class="p">,</span> <span class="n">flight_uid</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">):</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>				<span class="n">curfew_buffer_downstream</span><span class="p">,</span> <span class="n">flight_uid_propagates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>			<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>				<span class="c1"># There is no next flight, the reason is because that flight has been cancelled. Therefore, you are not propagating anymore</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>			<span class="n">propaget_to_curfew</span> <span class="o">=</span> <span class="n">curfew_buffer_downstream</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>			<span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)])</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>			<span class="k">return</span> <span class="p">[</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">flight_uid_propagates</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>		<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">		to scheduled departure or scheduled arrival) for a given flight, given the last</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="sd">		the cost with all</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>			<span class="c1"># X is the arrival (or departure delay?) with respect to schedule</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>						<span class="k">if</span> <span class="ow">not</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>			<span class="c1"># DOC</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>				<span class="k">raise</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">		VERSION ONLY WITH FLIGHT COST</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">		the cost with all</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>  <span class="c1"># + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span>  <span class="c1"># + cost_soft_cost + cost_doc + cost_compensation</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>																										  <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>				<span class="k">raise</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">		VERSION ONLY WITH PAX COST</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="sd">		the cost with all</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>			<span class="c1"># DOC</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>				<span class="c1"># cost_curfew = self.agent.afp.cost_non_pax_curfew(flight_uid_curfew) + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>				<span class="k">raise</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">		This is based on build_delay_cost_functions_heuristic</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">		simplified to keep minimum required to compute cost of delay</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">		based on arrival total delay with respect to sibt.</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">		You call the function passing the total delay at arrival.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>		<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_missed_connections&#39;</span><span class="p">):</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>				<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>					<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>					<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest1&#39;</span><span class="p">):</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>				<span class="c1"># Soft cost</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>				<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest2&#39;</span><span class="p">):</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>				<span class="c1"># Compensation</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>				<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>				<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>				<span class="n">cost</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>				<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>				<span class="k">raise</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>			<span class="c1"># TODO: this is strange, there should always be at list one flight in this list</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a>			<span class="c1"># if len(flights_after)&gt;0:</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>				<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>	<span class="k">def</span> <span class="nf">compute_reactionary_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">		Computes all the delays in the next flights of the day</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">		using the same aircraft than flight_uid.</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">		Parameters</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">		==========</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">		flight_uid: int,</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">			uid of the flight having the delay</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">		x: float,</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">			primary delay of the flight flight_uid</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">		Returns</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">		=======</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a><span class="sd">		delay: list,</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="sd">			Amount of delay of each flight of the day.</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a><span class="sd">			These delay are between 0 (buffers are large enough)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a><span class="sd">			and x (no buffer).</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a><span class="sd">		Note: assumes no recovery strategy.</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>		<span class="c1"># flights_aircraft = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_queue_uids(include_current_user=True)</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>		<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>		<span class="c1"># Compute buffers between each pair of flights</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>		<span class="n">buffs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>							<span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>								<span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>							<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>		<span class="n">delays</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffs</span><span class="p">)):</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>			<span class="c1"># delay for each fight is delay of previous minus the buffer.</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>				<span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">buffs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">flights_aircraft</span><span class="p">)</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">delays</span><span class="p">)</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>				<span class="k">raise</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>		<span class="k">return</span> <span class="n">delays</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>	<span class="k">def</span> <span class="nf">compute_time_propagate_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>		<span class="n">next_flights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>		<span class="n">time_prop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>			<span class="n">time_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>		<span class="k">return</span> <span class="n">time_prop</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>	<span class="k">def</span> <span class="nf">return_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;propagation_delay_time&#39;</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_prop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_propagate_delay</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)}</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>	<span class="k">def</span> <span class="nf">compute_cost_delay_function_air</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>		<span class="c1"># TODO: remove this function?</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>	<span class="k">def</span> <span class="nf">return_cost_delay_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest_uid</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_delay_function&#39;</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_delay_func&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_cost_delay_function_air</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span><span class="n">flight_uid</span><span class="p">}</span>                        
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">]</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_cost_delay_function</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_advanced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a><span class="sd">		available information. It uses explicit information on aircraft</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="sd">		and passenger for knock-on effects.</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factorbuild_delay_cost_functionsed in already.</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a><span class="sd">		the cost with all</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a><span class="sd">		Note: this is probably slow.</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_building&#39;</span><span class="p">):</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>			<span class="c1"># Get all passengers on the flights using in the future using the same aircraft</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>			<span class="c1"># than the current flight.</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>			<span class="c1"># These passengers cannot miss a flight, by definition!</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>			<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>			<span class="c1"># Rmk: maybe some pax are on different flights...</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">pax</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flights_aircraft</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>								<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">}</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>			<span class="n">from_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot; Non diff version&quot;&quot;&quot;</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>												<span class="n">X</span><span class="p">,</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>												<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>			<span class="c1"># Their cost is simply due to delay, taking buffers into account.</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>			<span class="c1"># Assumes paxs can always make it if the aircraft is below its min tat.</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>			<span class="c1"># Compute reactionary delays for all flights of the day</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>			<span class="n">delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reactionary_delays</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>			<span class="c1"># DOC</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>			<span class="c1"># aprint(&#39;First part of costs in cost function for&#39;, flight_str(flight_uid), &#39;:&#39;, cost_np, cost_soft_cost,</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>			<span class="c1">#         cost_doc, cost_compensation, &#39;(x0+x=&#39;, X, &#39;, number of pax:&#39;, len(paxs), &#39;)&#39;)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>			<span class="c1"># Check if pax have a flight after this one</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>			<span class="n">paxs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pax</span><span class="o">.</span><span class="n">is_last_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)]</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs2</span><span class="p">:</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>				<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing1&#39;</span><span class="p">):</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>					<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>					<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>					<span class="c1"># now (like the one it missed).</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>					<span class="c1"># Note: this can include the original flight intented (pax.get_flight_after(flight_uid))</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>					<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">()</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>					<span class="c1"># outbound_flights = [f for f in self.agent.flights_per_origin[from_airport]</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>					<span class="c1">#                             if (self.agent.get_obt(f) &gt; from_time + 1)</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>					<span class="c1">#                                 and self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing2&#39;</span><span class="p">):</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>					<span class="c1"># Select direct itineraries</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>													<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>					<span class="c1"># itineraries = [((f, self.agent.uid), ) for f in self.agent.flights_per_destination[pax.destination_uid]</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>					<span class="c1">#                                 if self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing3&#39;</span><span class="p">):</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing4&#39;</span><span class="p">):</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>						<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>						<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>						<span class="n">soft_cost_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>						<span class="n">compensation_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>						<span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">dt</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">departure_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>	<span class="k">def</span> <span class="nf">decide_options_alternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">current_option</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="sd">		Options is decided based on delay and estimated fuel consumption.</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>			<span class="c1"># print(&#39;STOP1 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>		<span class="n">fp_options_orig</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>		<span class="c1"># Keep the following line for tests.</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>		<span class="c1"># cancellation = len(fp_options)==2</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>		<span class="c1"># Keep only fp_options with eibt earlier than the curfew</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>		<span class="n">options_respect_curfew</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">eibt</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>		<span class="c1"># costs = np.asarray(list(compress(costs, options_respect_curfew)))</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>		<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>			<span class="c1"># Converting current_option to tis new index</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>			<span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fp_options_orig</span><span class="p">)))</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>			<span class="n">new_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_option</span> <span class="ow">in</span> <span class="n">new_indices</span><span class="p">:</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="n">new_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">current_option</span><span class="p">)</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>		<span class="c1"># print(&#39;STOP1.5 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>			<span class="c1"># There are no options which meet the curfew. Cancel the flight</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;CANCEL_CF&quot;</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>			<span class="c1"># Select as option the one which would arrive earlier to the destination</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>			<span class="n">list_eibt</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">eibt</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fp_options_orig</span><span class="p">]</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options_orig</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="n">list_eibt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">list_eibt</span><span class="p">))</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>			<span class="c1"># Estimated fuel consumption</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">get_estimated_fuel_consumption</span><span class="p">()</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>			<span class="c1"># CRCO costs</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>			<span class="n">crco_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">crco_cost_EUR</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>			<span class="c1"># Estimated delay cost</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>			<span class="n">delay_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">average_cost_function</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">())</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>			<span class="n">costs</span> <span class="o">=</span> <span class="n">fuel_cost</span> <span class="o">+</span> <span class="n">delay_cost</span> <span class="o">+</span> <span class="n">crco_cost</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>			<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_option</span><span class="p">:</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>				<span class="n">costs</span><span class="p">[</span><span class="n">current_option</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_anchor</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>				<span class="c1"># print(&#39;STOP2 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">),</span> <span class="s1">&#39;options&#39;</span><span class="p">)</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>				<span class="c1"># print(&#39;STOP3 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">:</span> <span class="n">fuel_cost</span><span class="p">,</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a>																				   <span class="s1">&#39;delay_cost&#39;</span><span class="p">:</span> <span class="n">delay_cost</span><span class="p">,</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>																				   <span class="s1">&#39;crco_cost&#39;</span><span class="p">:</span> <span class="n">crco_cost</span><span class="p">}))</span>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>				<span class="c1"># print(&#39;STOP4 {}&#39;.format(flight_uid))</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>				<span class="k">if</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;submitted&#39;</span><span class="p">:</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>					<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PROBLEM:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">])</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>				<span class="k">raise</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="n">found</span> <span class="ow">or</span> <span class="n">cancellation</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>		<span class="c1"># 	print(&#39;STOP5 {}&#39;.format(flight_uid))</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has decided this found:&#39;</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="s1">&#39;cancel:&#39;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>			   <span class="s1">&#39;option:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>			   <span class="s1">&#39;reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="s1">&#39;fp_options:&#39;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancellation</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>	<span class="k">def</span> <span class="nf">get_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">):</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>		<span class="n">received_option_selection_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">received_option_selection_message_event</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_request_select_option</span><span class="p">(</span><span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a>		<span class="k">yield</span> <span class="n">received_option_selection_message_event</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a>	<span class="k">def</span> <span class="nf">check_pax_ready_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax_check_event</span><span class="p">):</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a>		<span class="k">yield</span> <span class="n">pax_check_event</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a>		<span class="c1"># 	print(&quot;{} checks  performs check for pax not ready to board flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs check for pax not ready to board the&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a><span class="sd">		Check pax readiness to board, 5 minutes before pushback_ready.</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a><span class="sd">		pax_ready_to_board_checklist - list of pax who are estimated to be at the gate in 5min and ready to board</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a><span class="sd">		pax_to_wait_checklist - list of pax not est. to be at the gate in time for boarding --&gt; potential wait</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]:</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># make sure to perform wait for pax once per flight</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>				<span class="n">previous_flight_idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>				<span class="k">if</span> <span class="n">previous_flight_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># pax with no previous flight in their itinerary</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>				<span class="k">elif</span> <span class="n">previous_flight_idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>					<span class="c1"># calculate MCT</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>					<span class="n">ft1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>					<span class="n">ft2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">ft2</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a>					<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a>					<span class="n">mcts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;mcts&#39;</span><span class="p">][</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">]</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">mcts</span><span class="p">[(</span><span class="n">ft1</span><span class="p">,</span> <span class="n">ft2</span><span class="p">)]</span>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>					<span class="c1"># self.agent.aph.request_connecting_times(pax, (ft1, ft2))</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>					<span class="c1"># check if ft1 is from the same company as ft2 and calc. its in-block time</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>					<span class="c1"># if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>					<span class="c1">#     #print(&quot;It&#39;s not the same company.&quot;)</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>					<span class="c1">#     self.send_request_flight_plan(previous_flight)</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>					<span class="c1">#     previous_eibt = self.agent.get_obt(previous_flight) #self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>					<span class="c1"># else:</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>						<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>  <span class="c1"># self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>						<span class="k">raise</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>					<span class="k">if</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>						<span class="c1"># pax who won&#39;t make it in time</span>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>						<span class="c1"># TESTING</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>						<span class="c1"># print(&quot;This passenger&#39;s connecting time is: &quot;, pax.ct, &quot; and minimum CT is: &quot;, pax.mct)</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>						<span class="c1"># print(&quot;Time now: &quot;, self.agent.env.now)</span>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>						<span class="c1"># print(&quot;This passenger&#39;s previous flight will land at: &quot;, self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt)</span>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a>						<span class="c1"># print(&quot;Them missing &quot;, pax.pax_type)</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;The passengers not making their connecting&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; are: &quot;</span><span class="p">,</span>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a>				   <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Passengers ready to board&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;are: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">])</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; states there are no missing passengers for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; asks: Should we wait for missing pax on flight &#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">consider_waiting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a>	<span class="k">def</span> <span class="nf">consider_waiting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is considering to wait pax that are up to 15 minutes away.&quot;</span><span class="p">)</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>		<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>		<span class="n">num_missing_pax_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">)</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>		<span class="k">if</span> <span class="n">num_missing_pax_groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>				<span class="n">current_eobt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>				<span class="k">raise</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>				<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>				<span class="n">pax_delay</span> <span class="o">=</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>				<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax_delay</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">wait_for_passenger_thr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">):</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>					<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>  <span class="c1"># total wait time for this flight</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>			<span class="c1"># for saving</span>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>			<span class="n">wait_time_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>			<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">wait_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>			<span class="c1"># delay sobt of flight_uid for wait_time</span>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>			<span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="n">current_eobt</span> <span class="o">+</span> <span class="n">wait_time</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is requesting departing reassessment in order to wait for pax, wait time: &quot;</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a>				<span class="c1"># 	print(&quot;{} will request a departing reassessment because it considers waiting pax for flight {} (t={})&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">)</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>				<span class="c1"># EOBT changed: update eobt processes</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>				<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>			<span class="c1"># for saving</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>			<span class="n">wait_time_max</span><span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>		<span class="c1"># save the wfp info</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_missing_pax_groups</span><span class="p">,</span> <span class="n">wait_time_min</span><span class="p">,</span> <span class="n">wait_time_max</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">]</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_wfp_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>	<span class="k">def</span> <span class="nf">save_wfp_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a>		<span class="n">wfp_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_missing_pax_groups&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a>						<span class="s1">&#39;wait_time_min&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>						<span class="s1">&#39;wait_time_max&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a>						<span class="s1">&#39;wait_time_chosen&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>						<span class="p">}</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfp_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfp_decision</span><span class="p">)</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t=</span><span class="si">{}</span><span class="s1">, PROBLEM, FP MISSING FOR FLIGHT </span><span class="si">{}</span><span class="s1"> WITH SOBT: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]))</span>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a>			<span class="k">raise</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="sd">			- Up to EOBT: I have only potentital cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>				<span class="c1"># Soft cost</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>				<span class="c1"># DOC</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>				<span class="c1"># Compensation</span>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a>				<span class="c1"># cost_transfer0 = 0.</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a>				<span class="c1"># Curfew</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a><span class="sd">			- Up to EOBT: I have only potential cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a>			<span class="c1"># Curfew</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l2&#39;</span><span class="p">):</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>	<span class="k">def</span> <span class="nf">calculate_missing_pax_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># how long needed to wait for all pax in missing_pax</span>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>			<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>			<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a><span class="sd">			if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a><span class="sd">				previous_eibt = self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a><span class="sd">			else:</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a><span class="sd">				previous_eibt = self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>			<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>		<span class="c1"># tuples of pax groups and their estimated delays (times they need to be waited for)</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>		<span class="n">delayed_pax_groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delays</span><span class="p">)]</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>		<span class="c1"># sort from the smallest delay</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>		<span class="n">delayed_pax_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">delayed_pax_groups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>		<span class="k">return</span> <span class="n">delayed_pax_sorted</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>	<span class="k">def</span> <span class="nf">cost_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a><span class="sd">		Cost of waiting for pax group for pax_delay time, i.e. cost of delaying</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a><span class="sd">		flight_uid for pax_delay time</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>		<span class="n">cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;non_atfm_delay&#39;</span><span class="p">],</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>		<span class="k">return</span> <span class="n">cost_func</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>	<span class="k">def</span> <span class="nf">cost_not_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a><span class="sd">		Cost of not waiting for pax groups &quot;missing_pax</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a><span class="sd">		If I don&#39;t wait for a pax group, I will have to deal with the following potential costs:</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a><span class="sd">			- rebooking them (transfer costs) - definitely</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a><span class="sd">			- soft costs</span>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a><span class="sd">			- compensation</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a><span class="sd">			- duty of care</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>		<span class="n">not_wait_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>		<span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>							<span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># DELAY ALREADY ACCOUNTS FOR MCT!!</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>							<span class="n">from_airport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">])</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>			<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>			<span class="c1"># itineraries_cost_matrix = np.concatenate((soft_cost_pp, transfer_costs_pp, compensation_costs_pp, doc_costs_pp), axis=0)</span>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>			<span class="c1"># print(&quot;Itineraries costs are: &quot;, soft_cost_pp.shape, transfer_costs_pp.shape, compensation_costs_pp, doc_costs_pp)</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>			<span class="c1"># print(&quot;Itinerary cost matrix is: &quot;, itineraries_cost_matrix)</span>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a>			<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>				<span class="c1"># print(&quot;Total cost pp is: &quot;, total_cost_pp)</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>				<span class="c1"># print(&quot;Foud reallocation options for &quot;, pax, &quot; are: &quot;, reallocation_options)</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>				<span class="c1"># print(&quot;There are no found itineraries. Cost of the overnight stay!&quot;)</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>				<span class="c1"># pax has to be cared for overnight</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_overnight_care</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>		<span class="k">return</span> <span class="n">not_wait_cost</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>	<span class="k">def</span> <span class="nf">cost_non_pax_curfew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a>	<span class="k">def</span> <span class="nf">estimate_pax_curfew_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a>		<span class="n">dict_estimated_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a>		<span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_duty_of_care&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_soft_cost&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_transfer_cost&#39;</span><span class="p">]</span>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a>						<span class="c1">#avg_compensation_cost</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>		<span class="k">return</span> <span class="n">estimated_cost</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a>	<span class="k">def</span> <span class="nf">calculate_overnight_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a>		<span class="k">return</span> <span class="n">doc</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>	<span class="nd">@staticmethod</span>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>	<span class="k">def</span> <span class="nf">plot_wait_pax_costs</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">):</span>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">)),</span> <span class="n">wait_costs</span><span class="p">)</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost of wait/no-wait options: no-wait + each pax group wait&quot;</span><span class="p">)</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>	<span class="k">def</span> <span class="nf">reassess_departure_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a><span class="sd">		!!!Black magic warning!!!</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a><span class="sd">		This function is tricky to understand and should not be changed lightly.</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a><span class="sd">		In short, it checks if the ac_ready_time is after the eobt. If not,</span>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a><span class="sd">		the flight tries to pull the eobt as close as possible to the sobt.</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a><span class="sd">		If the ac_ready_time is indeed after the eobt, the flight requests</span>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a><span class="sd">		another ATFM slot if missed its own. After it got another slot (or not),</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a><span class="sd">		it completely recomputes its options if the delay is big enough (30 minutes),</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a><span class="sd">		or just resubmits its delayed flight plan to the NM otherwise.</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a><span class="sd">		In any case, if the eobt is changed, the flight plan is resubmitted.</span>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>		<span class="n">aoc_flight_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>		<span class="c1"># try:</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>		<span class="c1"># 	fp = aoc_flight_info[&#39;fp_options&#39;][aoc_flight_info[&#39;fp_option&#39;]]</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>		<span class="c1"># except:</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>		<span class="c1"># 	print(flight_uid)</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_option&#39;])</span>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_options&#39;])</span>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a>		<span class="c1"># 	raise</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a>		<span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>		<span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a>		<span class="n">eobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>		<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>		<span class="n">reactionary_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ac_ready_at_time</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>		<span class="c1"># 	print(&#39;AOC is reassessing the TAT for {}. Reactionary delay: {}; EOBT {}&#39;.format(flight_uid, reactionary_delay, eobt))</span>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>		<span class="n">extra_delay</span> <span class="o">=</span> <span class="n">reactionary_delay</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>		<span class="k">if</span> <span class="n">reactionary_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>			<span class="c1"># 	print(&#39;AOC did not find any reactionary delay for flight {} with {}, it will adjust the EOBT and resubmit if needed&#39;.format(fp, flight_uid))</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>			<span class="c1"># There is no extra delay, so just update the eobt with the current to do the</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>			<span class="c1"># wait_for_push_back_ready</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>			<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>				<span class="c1"># Try to bring closer the eobt</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sobt</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>				<span class="k">if</span> <span class="n">new_eobt</span><span class="o">!=</span><span class="n">eobt</span><span class="p">:</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;updates eobt and send a flight plan submission&#39;</span><span class="p">)</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>					<span class="c1"># 	print(&#39;AOC has updated the EOBT based on the aircraft ready time and is resubmitting the {} for flight {}&#39;.format(fp, flight_uid))</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a>					<span class="c1"># This is the only place where &quot;manually&quot; we need to</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a>					<span class="c1"># update_eobt_processes as fp is the same (we don&#39;t resubmit it)</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>					<span class="c1"># everywhere else we resubmit the fp and as we &quot;own&quot; the ac</span>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a>					<span class="c1"># that triggers the update_eobt_process via send_flight_plan_submission</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a>					<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a>					<span class="c1"># aprint(flight_str(flight_uid), &#39;does not do anything&#39;)</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a>					<span class="k">pass</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>			<span class="c1"># 	print(&#39;AOC found some reactionary delay for flight {} with {}, it will reassess how bad the situation is&#39;.format(fp, flight_uid))</span>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a>			<span class="c1"># There has been an additional delay, reassess where we are.</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">):</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has an extra delay of:&#39;</span><span class="p">,</span> <span class="n">extra_delay</span><span class="p">,</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a>						<span class="s1">&#39;and is regulated (missed the ATFM slot)&#39;</span><span class="p">)</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a>				<span class="c1"># We missed the ATFM slot</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp.get_unique_id()] = received_atfm_message_event</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>				<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>				<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">cobt</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>					<span class="c1"># This could happen if prevoulsy flight has regulation at airport</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>					<span class="c1"># and not it&#39;s so late that it&#39;s not regulated anymore. cobt will be None</span>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>				<span class="c1"># mprint(flight_str(flight_uid), &#39;has an extra delay of:&#39;, extra_delay,</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>				<span class="c1"># 		&#39;and a cobt of&#39;, cobt)</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>			<span class="c1"># Whether or not you got a new slot, you kept it, or you did not have one,</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>			<span class="c1"># you check if the delay is greater than 30. If so, you recompute a completely</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>			<span class="c1"># new FP. Otherwise you just resubmit the same FP with a new eobt.</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>			<span class="c1"># print(&#39;IN AOC CHECKING STUFF FOR FLIGHT {} (with ELT {}, extra_delay: {})&#39;.format(flight_uid, fp.get_estimated_landing_time(), extra_delay))</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>			<span class="k">if</span> <span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">min_time_for_FP_recomputation</span><span class="p">:</span>  <span class="c1"># TODO: no need to recompute if not in ATFM regulation, check that...</span>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;asks for a recomputation of the FP&#39;</span><span class="p">)</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time and is asking for a complete recomputation of the flight plan for flight {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a>				<span class="c1"># PROBLEM: cobt can be before ac_ready_at_time!!!</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">,</span> <span class="n">eobt</span> <span class="o">+</span> <span class="n">extra_delay</span><span class="p">)</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;sets new eobt of fp to&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;, then resubmit the flight plan&#39;</span><span class="p">)</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time, updated the EOBT and resubmit the same flight plan ({}) for flight {} (new EOBT: {})&#39;.format(fp, flight_uid, new_eobt))</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>				<span class="c1">#    print(&#39;IN AOC SUBMITTING FLIGHT PLAN FOR FLIGHT 4 {} (with ELT {})&#39;.format(flight_uid, fp.get_estimated_landing_time()))</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>  <span class="c1"># if missed curfew pick up by NM</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>	<span class="k">def</span> <span class="nf">send_request_select_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;select_flight_option_request&#39;</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_options&#39;</span><span class="p">:</span> <span class="n">cost_options</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a>	<span class="k">def</span> <span class="nf">send_ATFM_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a>		<span class="c1"># 	print(&#39;send_ATFM_request for {}&#39;.format(FP.flight_uid))</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ATFM_request&#39;</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a>						<span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">}</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_assigned_no_compute&#39;</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>	<span class="k">def</span> <span class="nf">send_cancellation_flight_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_cancellation&#39;</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">reception_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_submission&#39;</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a>						<span class="s1">&#39;reception_event&#39;</span><span class="p">:</span> <span class="n">reception_event</span><span class="p">}</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a>		<span class="c1"># print(self.agent, &#39;is submitting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>		<span class="c1">#  	print(&#39;t= {} ; IN AOC SENDING FLIGHT PLAN SUBMISSION FOR {} WITH ELT {} (WITHOUT ATFM DELAY {})&#39;.format(self.agent.env.now,</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>		<span class="c1"># 				flight_uid,</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_eta_wo_atfm(),</span>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>		<span class="c1"># 				))</span>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a>	<span class="k">def</span> <span class="nf">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_update&#39;</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>	<span class="k">def</span> <span class="nf">send_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>		<span class="c1"># This is an intra-agent message, so we use direct memory access</span>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>		<span class="c1"># for optimsation.</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(AFP role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>		<span class="c1"># self.send(msg) # uncomment this to use the messaging server</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>	<span class="k">def</span> <span class="nf">update_eobt_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">):</span>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;EOBT update for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;(new_eobt:&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a>		<span class="c1"># 	print(&quot;{} updates EOBT for flight {} (new_eobt: {})&quot;.format(self.agent, flight_uid, new_eobt))</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>			<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Delay estimation process has already been terminated, cannot interrupt it.&#39;</span><span class="p">)</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>				<span class="k">pass</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>		<span class="c1"># Check if aircraft is already available for the flight</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>	<span class="k">def</span> <span class="nf">wait_for_atfm_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>		<span class="k">if</span> <span class="s1">&#39;fp_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;fp_uid&#39;</span><span class="p">]]</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>		<span class="k">elif</span> <span class="s1">&#39;flight_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT {}&#39;.format(FP.flight_uid))</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">set_atfm_delay</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">])</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 2 {}&#39;.format(FP.flight_uid))</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">regulation</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">excempt</span><span class="p">)</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 3 {}&#39;.format(FP.flight_uid))</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a>		<span class="k">if</span> <span class="s1">&#39;event&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 4 {}&#39;.format(FP.flight_uid))</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>	<span class="k">def</span> <span class="nf">wait_for_FP_acceptance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]:</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight plan&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">],</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has been accepted&#39;</span><span class="p">)</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s2">&quot;Flight plan aoc thinks FP for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a>			<span class="c1"># Clean other FP data in case they are re-used in the future</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>			<span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]:</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>				<span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique_id</span><span class="p">:</span>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;non-submitted&#39;</span><span class="p">)</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">atfm_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prepare_accepted_fp</span><span class="p">()</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>			<span class="c1"># 	print(&#39;AOC triggers FP update for flight {}&#39;.format(flight_uid))</span>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>  <span class="c1"># msg[&#39;body&#39;][&#39;FP&#39;])</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">update_eobt_processes</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span><span class="p">)</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>			<span class="c1"># 	print(&#39;AOC records have been updated for flight {} with FP {}\n&#39;.format(flight_uid, msg[&#39;body&#39;][&#39;FP&#39;]))</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>			<span class="c1"># Flight plan has not been accepted: curfew missed</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>			<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;CURFEW&quot;</span><span class="p">:</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;FP for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;rejected due to curfew&#39;</span><span class="p">)</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>				<span class="c1"># Try other options</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>														<span class="n">fp_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">],</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>														<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>	<span class="c1"># def wait_for_FP_request(self, msg):</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>	<span class="c1"># 	mprint(&#39;Received FP request from&#39;, msg[&#39;from&#39;], &#39;for&#39;, flight_str(msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a>	<span class="c1"># 	self.agent.env.process(self.compute_FP(msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a>	<span class="k">def</span> <span class="nf">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Received departing reassessment request from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]))</span>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">]</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>		<span class="c1"># 	print(&quot;{} received a departing reassessment request from {} for flight {}&quot;.format(self.agent, msg[&#39;from&#39;], flight_uid))</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a>				<span class="c1"># We have already sent the fp for that flight so reassess</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>					<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;should have fligtht plan but option is None, fp status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reassess_departure_turnaround</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">icao</span><span class="p">)</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>			<span class="k">raise</span>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>	<span class="k">def</span> <span class="nf">wait_until_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>		<span class="c1"># interrupted = False</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a>			<span class="c1"># aprint(&#39;Non-ATFM delay estimation event created for&#39;, flight_str(flight_uid), &#39;at t=&#39;, self.agent.env.now)</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span><span class="p">))</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Non-ATFM delay estimation triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>			<span class="c1"># 	print(&#39;ALERT!!!&#39;)</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>			<span class="k">pass</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>			<span class="c1"># aprint(&#39;wait_until_delay_estimation process interrupted for&#39;, flight_str(flight_uid))</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>	<span class="k">def</span> <span class="nf">wait_until_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;starts flight plan submission for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>			<span class="k">pass</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>	<span class="k">def</span> <span class="nf">wait_until_push_back_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a>			<span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft_request&#39;</span><span class="p">]</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is ready to go but waits on the&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;to be released at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>			<span class="k">assert</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_queue_req</span><span class="p">(</span><span class="n">include_current_user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>			<span class="k">yield</span> <span class="n">request</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft is ready, push-back ready triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pushed-back&#39;</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>			<span class="k">pass</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>			<span class="k">raise</span>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a>	<span class="k">def</span> <span class="nf">send_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;request_flight_plan&#39;</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aoc2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a>					   <span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>		<span class="c1"># print(self.agent, &#39;is requesting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Agent &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot; received flight plan request from&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">],</span> <span class="s2">&quot;for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>		<span class="c1"># print(&quot;Received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>		<span class="n">fplan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>		<span class="c1"># send the flight plan back to the AOC who requested it</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a>		<span class="c1"># print(&quot;Agent &quot;, self.agent.uid, &quot; received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a>		<span class="n">msg2</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">]</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">],</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>					   <span class="s1">&#39;flight_plan&#39;</span><span class="p">:</span> <span class="n">fplan</span><span class="p">}</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>	<span class="k">def</span> <span class="nf">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Received requested flight plan for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_plan&#39;</span><span class="p">]</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a>		<span class="c1"># the AOC that originally requested this flight plan should now have it</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_option_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">]</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Issue with flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>			<span class="k">raise</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>		<span class="c1"># self.agent.env.process(self.make_hotspot_decision(msg[&#39;body&#39;][&#39;regulation_info&#39;], msg[&#39;body&#39;][&#39;event&#39;]))</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">make_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;regulation_info&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">])</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>	<span class="k">def</span> <span class="nf">make_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_info</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a>		<span class="c1"># if regulation_info[&#39;solver&#39;]==&#39;udpp_merge&#39;:</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_cost_vect[regulation_info[&#39;solver&#39;]]</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>		<span class="c1"># else:</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_approx[regulation_info[&#39;solver&#39;]]</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>		<span class="n">engine_local</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">LocalEngine</span><span class="p">(</span><span class="n">algo</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a>		<span class="n">hh</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">HotspotHandler</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine_local</span><span class="p">,</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>								<span class="n">cost_func_archetype</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;archetype_cost_function&#39;</span><span class="p">],</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a>								<span class="n">alternative_allocation_rule</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>								<span class="p">)</span>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a>		<span class="c1"># Note: here we are not using the most up to date ETA for this FP.</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>		<span class="c1"># Instead, we use the one recorded in the regulation when the FP</span>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a>		<span class="c1"># was accepted by the NM. The up to date ETA can be different from</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a>		<span class="c1"># the latter because the flight does not need to resubmit a FP if the</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a>		<span class="c1"># ETA does not change by more than -5, +10 minutes.</span>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>		<span class="c1"># This gives the cost as a function of the delay with respect to scheduled in block time</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>		<span class="n">cfs_old</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>														<span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>														<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>														<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>														<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>														<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>		<span class="c1"># We transform the functions to have the cost as a function of delay w.r.t. to eta,</span>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a>		<span class="c1"># estimated landing.</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>		<span class="k">def</span> <span class="nf">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">sibt</span><span class="p">):</span>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>			<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>				<span class="k">return</span> <span class="n">cf</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sibt</span><span class="p">)))</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>			<span class="k">return</span> <span class="n">f</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>		<span class="n">cfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">fid</span><span class="p">:</span> <span class="n">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>							<span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">][</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>							<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">cfs_old</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>		<span class="n">flights_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;flight_name&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>						<span class="s1">&#39;airline_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>						<span class="c1"># &#39;eta&#39;: self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>						<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_eta_wo_atfm</span><span class="p">(),</span>  <span class="c1"># int(d[&#39;eta&#39;]),</span>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>						<span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="n">cfs</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>						<span class="s1">&#39;slot&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>						<span class="p">}</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>		<span class="c1"># Here we pass directly the real cost function, because we want to ask for an approximation</span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>		<span class="c1"># computed by the udpp_local engine.</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>		<span class="c1"># print(&#39;SLOTS in AOC (&#39;, len(regulation_info[&#39;slots&#39;]), &#39;):&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>		<span class="c1"># print(&#39;flights_dict in {}:&#39;.format(msg[&#39;body&#39;][&#39;regulation_info&#39;][&#39;regulation_uid&#39;]))</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>		<span class="c1"># for d in flights_dict:</span>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>		<span class="c1"># 	print(d)</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>		<span class="n">_</span><span class="p">,</span> <span class="n">flights_airline</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">prepare_hotspot_from_dict</span><span class="p">(</span><span class="n">attr_list</span><span class="o">=</span><span class="n">flights_dict</span><span class="p">,</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>															<span class="n">slots</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;slots&#39;</span><span class="p">],</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>															<span class="n">set_cost_function_with</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="s1">&#39;cost_function&#39;</span><span class="p">,</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>																					<span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>																					<span class="s1">&#39;absolute&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>																					<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="s1">&#39;eta&#39;</span><span class="p">},</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>															<span class="p">)</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>		<span class="c1"># Prepare flights for engine</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>		<span class="n">hh</span><span class="o">.</span><span class="n">prepare_all_flights</span><span class="p">()</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>		<span class="c1"># Use following code to save costs for external use</span>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>		<span class="c1"># import pandas as pd</span>
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>		<span class="c1"># try:</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>		<span class="c1"># 	df = pd.read_csv(&#39;cost_matrix_before.csv&#39;, index_col=0)</span>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>		<span class="c1"># except:</span>
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>		<span class="c1"># 	df = pd.DataFrame([], columns=regulation_info[&#39;slots&#39;])</span>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>		<span class="c1"># for flight in hh.get_flight_list():</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>		<span class="c1"># 	df.loc[flight.name, :] = flight.costVect</span>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>		<span class="c1"># df.to_csv(&#39;cost_matrix_before.csv&#39;)</span>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>		<span class="c1"># print(&#39;SLOTS:&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>		<span class="c1"># print(&#39;Flight characs before computing local optimisation in AOC:&#39;, [(f.name, f.eta, f.costVect[-3:]) for f in hh.get_flight_list()])</span>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>		<span class="c1"># print(&#39;Hotspot summary in airline {}&#39;.format(self.agent))</span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>		<span class="c1"># hh.print_summary()</span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>		<span class="c1"># Compute preferences (parameters approximating the cost function)</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>		<span class="n">preferences</span> <span class="o">=</span> <span class="n">engine_local</span><span class="o">.</span><span class="n">compute_optimal_parameters</span><span class="p">(</span><span class="n">hotspot_handler</span><span class="o">=</span><span class="n">hh</span><span class="p">,</span>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>																<span class="n">kwargs_init</span><span class="o">=</span><span class="p">{})</span>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a>		<span class="c1"># print(&#39;PREFERENCES FROM HOTSPOT ({}): {}&#39;.format(self.agent.icao, preferences))</span>
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_hotspot_decision</span><span class="p">(</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">],</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a>									<span class="n">event</span><span class="p">,</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a>									<span class="n">preferences</span><span class="p">,</span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a>									<span class="n">real_cost_funcs</span><span class="o">=</span><span class="n">cfs</span><span class="p">)</span>  <span class="c1"># Just for metrics, TODO we need to build metrics computers</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a>
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a>	<span class="k">def</span> <span class="nf">send_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">decision</span><span class="p">,</span> <span class="n">real_cost_funcs</span><span class="p">):</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hotspot_decision&#39;</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">:</span> <span class="n">regulation_id</span><span class="p">,</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>					   <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a>					   <span class="s1">&#39;hotspot_decision&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">,</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a>					   <span class="s1">&#39;real_cost_funcs&#39;</span><span class="p">:</span> <span class="n">real_cost_funcs</span><span class="p">}</span>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a>
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>	<span class="k">def</span> <span class="nf">wait_until_pax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>		<span class="c1"># checking for missing passengers 5 minutes before push_back_ready</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs pre-check for missing passengers on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a>			<span class="c1"># aprint(&#39;wait_until_pax_check interrupted&#39;)</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a>			<span class="k">pass</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a><span class="k">class</span> <span class="nc">DynamicCostIndexComputer</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a><span class="sd">	DCIC</span>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a><span class="sd">	Description: Compute the new cost index of a given flight. It communicates</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a><span class="sd">	with the role PotentialDelayRecoveryProvider (in Flight, PDRP), to get options for speeding up.</span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">TA</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a>		<span class="k">if</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a>		<span class="k">elif</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA2</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA0</span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">toc_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>  <span class="c1"># not used for now (just msgs)</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a>	<span class="k">def</span> <span class="nf">request_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;potential_delay_recovery_request&#39;</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;use_dci_landing&#39;</span><span class="p">:</span> <span class="n">use_dci_landing</span><span class="p">}</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>	<span class="k">def</span> <span class="nf">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a>		<span class="c1"># dictionary with potential delay recovery info received from a flight</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>		<span class="n">delay_recovery_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;potential_delay_recovery&#39;</span><span class="p">]</span>  <span class="c1"># dictionary</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a>		<span class="c1"># save dictionary into aoc_delay_recovery_info --&gt; it can be accessed just with flight_uid then</span>
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay_recovery_info</span>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a>		<span class="c1"># TESTING</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a>		<span class="c1"># print(&quot;Delay information dictionary for&quot;, flight_str(flight_uid))</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a>		<span class="c1"># print(self.agent.aoc_delay_recovery_info[flight_uid])</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a>	<span class="k">def</span> <span class="nf">wait_for_toc_reached_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a>		<span class="k">pass</span>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a>	<span class="k">def</span> <span class="nf">cost_index_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_ready_event</span><span class="p">):</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a><span class="sd">		Decides how the CI assessment is done depending on the level.</span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a><span class="sd">		Level 0: only at pushback ready</span>
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a><span class="sd">		Level 1: at top of climb (and therefore not needed at pushback ready? Or is it?</span>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a><span class="sd">		CHANGE IF TURNS OUT THAT ALSO NEEDED AT PUSHBACK READY.</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a>		<span class="c1"># if self.agent.TA == 0:</span>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a>		<span class="k">yield</span> <span class="n">push_back_ready_event</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a>		<span class="c1"># print(&quot;Checking cost index at pushback ready.&quot;)</span>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a>		<span class="c1"># else:</span>
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a>		<span class="c1"># 	#do nothing - wait for top of climb.</span>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a>		<span class="c1"># 	#yield self.toc_event</span>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a>		<span class="c1"># 	pass</span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a>
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a>	<span class="k">def</span> <span class="nf">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a><span class="sd">		Probabilistically decide whether the flight is performing delay recovery</span>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a><span class="sd">		for the amount of delay &quot;delay&quot;.</span>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>		<span class="n">min_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_min_delay</span>  <span class="c1"># gray area: below this value never recover</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>		<span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_max_delay</span>  <span class="c1"># above this value always recover</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>		<span class="n">p_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_p_bias</span>  <span class="c1"># minimum probability of delay recovery (from min_delay)</span>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>		<span class="c1"># probability of performing delay recovery: p</span>
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a>		<span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="n">min_delay</span><span class="p">:</span>
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># never recover</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a>		<span class="k">elif</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">max_delay</span><span class="p">:</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">max_delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_bias</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>		<span class="c1"># decision on performing delay recovery</span>
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>		<span class="n">do_it</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">p</span>
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>		<span class="c1"># print(&quot;For the delay &quot;, delay, &quot; this flight is performing delay recovery: &quot;, do_it, &quot; with the probability &quot;, p)</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>		<span class="k">return</span> <span class="n">do_it</span>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a>
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a>	<span class="nd">@staticmethod</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a>	<span class="k">def</span> <span class="nf">plot_costs_dci</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a><span class="sd">		If one wants to plot cost functions used to make dci decisions.</span>
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a>		<span class="c1">#####################</span>
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a>		<span class="c1"># FUEL COST</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a>		<span class="c1">#####################</span>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">fuel</span><span class="p">)</span>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Fuel cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a>
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a>		<span class="c1">#####################</span>
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a>		<span class="c1"># TIME COST</span>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a>		<span class="c1">#####################</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a>		<span class="c1">#####################</span>
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a>		<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a>		<span class="c1">#####################</span>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a>		<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">fuel</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">total_cost</span><span class="p">)</span>
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost function (delta_t): time + fuel&quot;</span><span class="p">)</span>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a>
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a>
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a>
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a><span class="sd">			else:</span>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a><span class="sd">				if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a><span class="sd">				if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a>
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a>
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a><span class="sd">			else:</span>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a>
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a>				<span class="c1"># Soft cost</span>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a>
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a>				<span class="c1"># DOC</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>				<span class="c1"># cost_doc0 = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>				<span class="c1"># Compensation</span>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>				<span class="n">cost_transfer0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>				<span class="c1"># Curfew costs</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_transfer0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a><span class="sd">		else:</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a><span class="sd">			if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a><span class="sd">			if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="L-2937"><a href="#L-2937"><span class="linenos">2937</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="L-2938"><a href="#L-2938"><span class="linenos">2938</span></a>
</span><span id="L-2939"><a href="#L-2939"><span class="linenos">2939</span></a>
</span><span id="L-2940"><a href="#L-2940"><span class="linenos">2940</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="L-2941"><a href="#L-2941"><span class="linenos">2941</span></a>
</span><span id="L-2942"><a href="#L-2942"><span class="linenos">2942</span></a>			<span class="c1"># Soft cost</span>
</span><span id="L-2943"><a href="#L-2943"><span class="linenos">2943</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2944"><a href="#L-2944"><span class="linenos">2944</span></a>
</span><span id="L-2945"><a href="#L-2945"><span class="linenos">2945</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2946"><a href="#L-2946"><span class="linenos">2946</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="L-2947"><a href="#L-2947"><span class="linenos">2947</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="L-2948"><a href="#L-2948"><span class="linenos">2948</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="L-2949"><a href="#L-2949"><span class="linenos">2949</span></a>
</span><span id="L-2950"><a href="#L-2950"><span class="linenos">2950</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="L-2951"><a href="#L-2951"><span class="linenos">2951</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="L-2952"><a href="#L-2952"><span class="linenos">2952</span></a>
</span><span id="L-2953"><a href="#L-2953"><span class="linenos">2953</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="L-2954"><a href="#L-2954"><span class="linenos">2954</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="L-2955"><a href="#L-2955"><span class="linenos">2955</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="L-2956"><a href="#L-2956"><span class="linenos">2956</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="L-2957"><a href="#L-2957"><span class="linenos">2957</span></a>
</span><span id="L-2958"><a href="#L-2958"><span class="linenos">2958</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="L-2959"><a href="#L-2959"><span class="linenos">2959</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="L-2960"><a href="#L-2960"><span class="linenos">2960</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="L-2961"><a href="#L-2961"><span class="linenos">2961</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="L-2962"><a href="#L-2962"><span class="linenos">2962</span></a><span class="sd">			else:</span>
</span><span id="L-2963"><a href="#L-2963"><span class="linenos">2963</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="L-2964"><a href="#L-2964"><span class="linenos">2964</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="L-2965"><a href="#L-2965"><span class="linenos">2965</span></a>
</span><span id="L-2966"><a href="#L-2966"><span class="linenos">2966</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="L-2967"><a href="#L-2967"><span class="linenos">2967</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-2968"><a href="#L-2968"><span class="linenos">2968</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2969"><a href="#L-2969"><span class="linenos">2969</span></a>
</span><span id="L-2970"><a href="#L-2970"><span class="linenos">2970</span></a>			<span class="c1"># Compensation</span>
</span><span id="L-2971"><a href="#L-2971"><span class="linenos">2971</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-2972"><a href="#L-2972"><span class="linenos">2972</span></a>
</span><span id="L-2973"><a href="#L-2973"><span class="linenos">2973</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="L-2974"><a href="#L-2974"><span class="linenos">2974</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2975"><a href="#L-2975"><span class="linenos">2975</span></a>
</span><span id="L-2976"><a href="#L-2976"><span class="linenos">2976</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="L-2977"><a href="#L-2977"><span class="linenos">2977</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="L-2978"><a href="#L-2978"><span class="linenos">2978</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="L-2979"><a href="#L-2979"><span class="linenos">2979</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-2980"><a href="#L-2980"><span class="linenos">2980</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-2981"><a href="#L-2981"><span class="linenos">2981</span></a>
</span><span id="L-2982"><a href="#L-2982"><span class="linenos">2982</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="L-2983"><a href="#L-2983"><span class="linenos">2983</span></a>
</span><span id="L-2984"><a href="#L-2984"><span class="linenos">2984</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="L-2985"><a href="#L-2985"><span class="linenos">2985</span></a>
</span><span id="L-2986"><a href="#L-2986"><span class="linenos">2986</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-2987"><a href="#L-2987"><span class="linenos">2987</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l1&#39;</span><span class="p">):</span>
</span><span id="L-2988"><a href="#L-2988"><span class="linenos">2988</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="L-2989"><a href="#L-2989"><span class="linenos">2989</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-2990"><a href="#L-2990"><span class="linenos">2990</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-2991"><a href="#L-2991"><span class="linenos">2991</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-2992"><a href="#L-2992"><span class="linenos">2992</span></a>
</span><span id="L-2993"><a href="#L-2993"><span class="linenos">2993</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="L-2994"><a href="#L-2994"><span class="linenos">2994</span></a>
</span><span id="L-2995"><a href="#L-2995"><span class="linenos">2995</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-2996"><a href="#L-2996"><span class="linenos">2996</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2997"><a href="#L-2997"><span class="linenos">2997</span></a><span class="sd">		RULE OF THUMB FOR LEVEL 0:</span>
</span><span id="L-2998"><a href="#L-2998"><span class="linenos">2998</span></a><span class="sd">			The cost index is assessed only pre-departure (at pushback_ready), there is no dynamic changing (DCI).</span>
</span><span id="L-2999"><a href="#L-2999"><span class="linenos">2999</span></a><span class="sd">			Departure delays greater than 60 minutes always try to be amortised. Lower than 15 - never.</span>
</span><span id="L-3000"><a href="#L-3000"><span class="linenos">3000</span></a><span class="sd">			If between, probabilistic decision is made according to a linear prob. distribution (from 20% at 15 mins).</span>
</span><span id="L-3001"><a href="#L-3001"><span class="linenos">3001</span></a><span class="sd">			As a general rule, we try to reduce the delay as much as possible to 5 minutes.</span>
</span><span id="L-3002"><a href="#L-3002"><span class="linenos">3002</span></a>
</span><span id="L-3003"><a href="#L-3003"><span class="linenos">3003</span></a><span class="sd">			Therefore, if enough fuel - reduce delay to 5 minutes. If not enough fuel to reduce to 5,</span>
</span><span id="L-3004"><a href="#L-3004"><span class="linenos">3004</span></a><span class="sd">			use max_fuel to achieve maximum possible delay reduction.</span>
</span><span id="L-3005"><a href="#L-3005"><span class="linenos">3005</span></a>
</span><span id="L-3006"><a href="#L-3006"><span class="linenos">3006</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3007"><a href="#L-3007"><span class="linenos">3007</span></a>
</span><span id="L-3008"><a href="#L-3008"><span class="linenos">3008</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 0 for&quot;, flight_str(flight_uid))</span>
</span><span id="L-3009"><a href="#L-3009"><span class="linenos">3009</span></a>
</span><span id="L-3010"><a href="#L-3010"><span class="linenos">3010</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3011"><a href="#L-3011"><span class="linenos">3011</span></a>
</span><span id="L-3012"><a href="#L-3012"><span class="linenos">3012</span></a>		<span class="c1"># retrieve cost dictionary for the flight provided by pdrp</span>
</span><span id="L-3013"><a href="#L-3013"><span class="linenos">3013</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-3014"><a href="#L-3014"><span class="linenos">3014</span></a>
</span><span id="L-3015"><a href="#L-3015"><span class="linenos">3015</span></a>		<span class="c1"># init - needed if not speed change is going to occur, for saving to DB</span>
</span><span id="L-3016"><a href="#L-3016"><span class="linenos">3016</span></a>		<span class="n">dep_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3017"><a href="#L-3017"><span class="linenos">3017</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3018"><a href="#L-3018"><span class="linenos">3018</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3019"><a href="#L-3019"><span class="linenos">3019</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3020"><a href="#L-3020"><span class="linenos">3020</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3021"><a href="#L-3021"><span class="linenos">3021</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3022"><a href="#L-3022"><span class="linenos">3022</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3023"><a href="#L-3023"><span class="linenos">3023</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3024"><a href="#L-3024"><span class="linenos">3024</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3025"><a href="#L-3025"><span class="linenos">3025</span></a>
</span><span id="L-3026"><a href="#L-3026"><span class="linenos">3026</span></a>		<span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-3027"><a href="#L-3027"><span class="linenos">3027</span></a>			<span class="c1"># We can change the speed</span>
</span><span id="L-3028"><a href="#L-3028"><span class="linenos">3028</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;We can change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;before departure.&quot;</span><span class="p">)</span>
</span><span id="L-3029"><a href="#L-3029"><span class="linenos">3029</span></a>
</span><span id="L-3030"><a href="#L-3030"><span class="linenos">3030</span></a>			<span class="c1"># check departure delay at pushback ready</span>
</span><span id="L-3031"><a href="#L-3031"><span class="linenos">3031</span></a>			<span class="n">dep_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sobt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3032"><a href="#L-3032"><span class="linenos">3032</span></a>
</span><span id="L-3033"><a href="#L-3033"><span class="linenos">3033</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">)</span>
</span><span id="L-3034"><a href="#L-3034"><span class="linenos">3034</span></a>
</span><span id="L-3035"><a href="#L-3035"><span class="linenos">3035</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="L-3036"><a href="#L-3036"><span class="linenos">3036</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">dep_delay</span> <span class="o">-</span> <span class="mi">5</span>  <span class="c1"># 5 minutes delay never recovered. delta_t is now the time a flight would like to recover.</span>
</span><span id="L-3037"><a href="#L-3037"><span class="linenos">3037</span></a>
</span><span id="L-3038"><a href="#L-3038"><span class="linenos">3038</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>  <span class="c1"># if what I want to recover is larger than max time I can recover</span>
</span><span id="L-3039"><a href="#L-3039"><span class="linenos">3039</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># then recover maximum time possible</span>
</span><span id="L-3040"><a href="#L-3040"><span class="linenos">3040</span></a>				<span class="c1"># otherwise recover full delta_t. delta_t is now true time I can and want to recover with the fuel I have</span>
</span><span id="L-3041"><a href="#L-3041"><span class="linenos">3041</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3042"><a href="#L-3042"><span class="linenos">3042</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># delta_t is now the max time a flight can recover (it&#39;s negative now!)</span>
</span><span id="L-3043"><a href="#L-3043"><span class="linenos">3043</span></a>
</span><span id="L-3044"><a href="#L-3044"><span class="linenos">3044</span></a>				<span class="c1"># delta_t CAN STILL CHANGE due to the fact we limit perc_selected to 0.9</span>
</span><span id="L-3045"><a href="#L-3045"><span class="linenos">3045</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)))),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># new speed capped at 0.9*nominal</span>
</span><span id="L-3046"><a href="#L-3046"><span class="linenos">3046</span></a>
</span><span id="L-3047"><a href="#L-3047"><span class="linenos">3047</span></a>				<span class="k">if</span> <span class="n">perc_selected</span> <span class="o">==</span> <span class="mf">0.9</span><span class="p">:</span>
</span><span id="L-3048"><a href="#L-3048"><span class="linenos">3048</span></a>					<span class="c1"># use triangle similarity to find REAL delta_t</span>
</span><span id="L-3049"><a href="#L-3049"><span class="linenos">3049</span></a>					<span class="n">p1_time</span> <span class="o">=</span> <span class="n">delta_t</span><span class="o">-</span><span class="mi">10</span>
</span><span id="L-3050"><a href="#L-3050"><span class="linenos">3050</span></a>					<span class="n">p1</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">p1_time</span><span class="p">)</span>
</span><span id="L-3051"><a href="#L-3051"><span class="linenos">3051</span></a>					<span class="n">p2</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)</span>
</span><span id="L-3052"><a href="#L-3052"><span class="linenos">3052</span></a>					<span class="n">real_delta_t</span> <span class="o">=</span> <span class="p">((</span><span class="n">p2</span> <span class="o">-</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1_time</span> <span class="o">-</span> <span class="n">delta_t</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_t</span>
</span><span id="L-3053"><a href="#L-3053"><span class="linenos">3053</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">real_delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3054"><a href="#L-3054"><span class="linenos">3054</span></a>
</span><span id="L-3055"><a href="#L-3055"><span class="linenos">3055</span></a>				<span class="c1"># If after checking with the fuel function, a flight cannot recover more than 5 minutes, do not recover anything</span>
</span><span id="L-3056"><a href="#L-3056"><span class="linenos">3056</span></a>				<span class="c1"># AND limit the usage of extra fuel to self.agent.max_extra_fuel_used percent of extra_fuel_available</span>
</span><span id="L-3057"><a href="#L-3057"><span class="linenos">3057</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># the extra fuel needed to recover delta_t</span>
</span><span id="L-3058"><a href="#L-3058"><span class="linenos">3058</span></a>				<span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dfuel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">max_extra_fuel_used</span> <span class="o">*</span> <span class="n">extra_fuel_available</span><span class="p">):</span>
</span><span id="L-3059"><a href="#L-3059"><span class="linenos">3059</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3060"><a href="#L-3060"><span class="linenos">3060</span></a>					<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3061"><a href="#L-3061"><span class="linenos">3061</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3062"><a href="#L-3062"><span class="linenos">3062</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3063"><a href="#L-3063"><span class="linenos">3063</span></a>					<span class="c1"># 	print(&quot;Recovering delay of &quot;, delta_t, &quot;minutes, with % of fuel &quot;, round(dfuel/extra_fuel_available*100, 2))</span>
</span><span id="L-3064"><a href="#L-3064"><span class="linenos">3064</span></a>					<span class="c1"># 	print(&quot;I got a perc from tfsc: &quot;, tfsc[&#39;perc_variation_func&#39;](delta_t))</span>
</span><span id="L-3065"><a href="#L-3065"><span class="linenos">3065</span></a>					<span class="c1"># 	print(&quot;Flight &quot;, flight_uid, &quot;is deciding to speed up with selected perc &quot;, perc_selected*100)</span>
</span><span id="L-3066"><a href="#L-3066"><span class="linenos">3066</span></a>
</span><span id="L-3067"><a href="#L-3067"><span class="linenos">3067</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span>
</span><span id="L-3068"><a href="#L-3068"><span class="linenos">3068</span></a>						   <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; before take-off. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="L-3069"><a href="#L-3069"><span class="linenos">3069</span></a>
</span><span id="L-3070"><a href="#L-3070"><span class="linenos">3070</span></a>					<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="L-3071"><a href="#L-3071"><span class="linenos">3071</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="L-3072"><a href="#L-3072"><span class="linenos">3072</span></a>
</span><span id="L-3073"><a href="#L-3073"><span class="linenos">3073</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-3074"><a href="#L-3074"><span class="linenos">3074</span></a>
</span><span id="L-3075"><a href="#L-3075"><span class="linenos">3075</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="L-3076"><a href="#L-3076"><span class="linenos">3076</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pushback_ready&#39;</span><span class="p">,</span> <span class="n">dep_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="L-3077"><a href="#L-3077"><span class="linenos">3077</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-3078"><a href="#L-3078"><span class="linenos">3078</span></a>
</span><span id="L-3079"><a href="#L-3079"><span class="linenos">3079</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3080"><a href="#L-3080"><span class="linenos">3080</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3081"><a href="#L-3081"><span class="linenos">3081</span></a><span class="sd">		On level 1, the first time CI is assessed is at top of the climb.</span>
</span><span id="L-3082"><a href="#L-3082"><span class="linenos">3082</span></a>
</span><span id="L-3083"><a href="#L-3083"><span class="linenos">3083</span></a><span class="sd">		From deliverable: Dynamic cost indexing for flights, with a simplified in-flight delay and</span>
</span><span id="L-3084"><a href="#L-3084"><span class="linenos">3084</span></a><span class="sd">		cost estimation based on heuristics and general cost of delay rules.</span>
</span><span id="L-3085"><a href="#L-3085"><span class="linenos">3085</span></a>
</span><span id="L-3086"><a href="#L-3086"><span class="linenos">3086</span></a><span class="sd">		At TOC: Estimate times I can recover and fuel needed. Compute time and fuel costs, and choose</span>
</span><span id="L-3087"><a href="#L-3087"><span class="linenos">3087</span></a><span class="sd">		the cheapest option.</span>
</span><span id="L-3088"><a href="#L-3088"><span class="linenos">3088</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3089"><a href="#L-3089"><span class="linenos">3089</span></a>
</span><span id="L-3090"><a href="#L-3090"><span class="linenos">3090</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="L-3091"><a href="#L-3091"><span class="linenos">3091</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="L-3092"><a href="#L-3092"><span class="linenos">3092</span></a>
</span><span id="L-3093"><a href="#L-3093"><span class="linenos">3093</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3094"><a href="#L-3094"><span class="linenos">3094</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-3095"><a href="#L-3095"><span class="linenos">3095</span></a>
</span><span id="L-3096"><a href="#L-3096"><span class="linenos">3096</span></a>		<span class="n">estimated_delay</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># fill with exp_arr_delay when estimation is done</span>
</span><span id="L-3097"><a href="#L-3097"><span class="linenos">3097</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3098"><a href="#L-3098"><span class="linenos">3098</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3099"><a href="#L-3099"><span class="linenos">3099</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3100"><a href="#L-3100"><span class="linenos">3100</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3101"><a href="#L-3101"><span class="linenos">3101</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3102"><a href="#L-3102"><span class="linenos">3102</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3103"><a href="#L-3103"><span class="linenos">3103</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3104"><a href="#L-3104"><span class="linenos">3104</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3105"><a href="#L-3105"><span class="linenos">3105</span></a>
</span><span id="L-3106"><a href="#L-3106"><span class="linenos">3106</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-3107"><a href="#L-3107"><span class="linenos">3107</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="L-3108"><a href="#L-3108"><span class="linenos">3108</span></a>
</span><span id="L-3109"><a href="#L-3109"><span class="linenos">3109</span></a>			<span class="c1"># Assess expected arrival delay at TOC</span>
</span><span id="L-3110"><a href="#L-3110"><span class="linenos">3110</span></a>			<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="L-3111"><a href="#L-3111"><span class="linenos">3111</span></a>
</span><span id="L-3112"><a href="#L-3112"><span class="linenos">3112</span></a>			<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-3113"><a href="#L-3113"><span class="linenos">3113</span></a>			<span class="n">estimated_delay</span> <span class="o">=</span> <span class="n">exp_arr_delay</span>  <span class="c1"># for saving</span>
</span><span id="L-3114"><a href="#L-3114"><span class="linenos">3114</span></a>			<span class="c1"># print(&quot;Expected arrival delay is &quot;, exp_arr_delay)</span>
</span><span id="L-3115"><a href="#L-3115"><span class="linenos">3115</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;estimates at TOC that the expected arrival delay is&quot;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="s2">&quot; minutes.&quot;</span><span class="p">)</span>
</span><span id="L-3116"><a href="#L-3116"><span class="linenos">3116</span></a>
</span><span id="L-3117"><a href="#L-3117"><span class="linenos">3117</span></a>			<span class="c1">#####################</span>
</span><span id="L-3118"><a href="#L-3118"><span class="linenos">3118</span></a>			<span class="c1"># FUEL COST</span>
</span><span id="L-3119"><a href="#L-3119"><span class="linenos">3119</span></a>			<span class="c1">#####################</span>
</span><span id="L-3120"><a href="#L-3120"><span class="linenos">3120</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3121"><a href="#L-3121"><span class="linenos">3121</span></a><span class="sd">			x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="L-3122"><a href="#L-3122"><span class="linenos">3122</span></a><span class="sd">			plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="L-3123"><a href="#L-3123"><span class="linenos">3123</span></a><span class="sd">			plt.show()</span>
</span><span id="L-3124"><a href="#L-3124"><span class="linenos">3124</span></a><span class="sd">			plt.clf()</span>
</span><span id="L-3125"><a href="#L-3125"><span class="linenos">3125</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-3126"><a href="#L-3126"><span class="linenos">3126</span></a>
</span><span id="L-3127"><a href="#L-3127"><span class="linenos">3127</span></a>			<span class="n">fuel_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span>
</span><span id="L-3128"><a href="#L-3128"><span class="linenos">3128</span></a>			<span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">])),</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-3129"><a href="#L-3129"><span class="linenos">3129</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">fuel_cost_func</span><span class="p">(</span><span class="o">-</span><span class="n">x_cont</span><span class="p">)</span>  <span class="c1"># for recovering -fuel cost needs negative values</span>
</span><span id="L-3130"><a href="#L-3130"><span class="linenos">3130</span></a>
</span><span id="L-3131"><a href="#L-3131"><span class="linenos">3131</span></a>			<span class="c1">#####################</span>
</span><span id="L-3132"><a href="#L-3132"><span class="linenos">3132</span></a>			<span class="c1"># TIME COST</span>
</span><span id="L-3133"><a href="#L-3133"><span class="linenos">3133</span></a>			<span class="c1">#####################</span>
</span><span id="L-3134"><a href="#L-3134"><span class="linenos">3134</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3135"><a href="#L-3135"><span class="linenos">3135</span></a><span class="sd">			ABOUT TIME COST FUNCTION</span>
</span><span id="L-3136"><a href="#L-3136"><span class="linenos">3136</span></a>
</span><span id="L-3137"><a href="#L-3137"><span class="linenos">3137</span></a><span class="sd">			Time cost function is a function of the recovered delay, i.e. on x-axis we have</span>
</span><span id="L-3138"><a href="#L-3138"><span class="linenos">3138</span></a><span class="sd">			minutes of delay a flight decides to recover by speeding up.</span>
</span><span id="L-3139"><a href="#L-3139"><span class="linenos">3139</span></a><span class="sd">			E.g. Let&#39;s say a flight, at TOC, estimates arrival delay of 20 minutes</span>
</span><span id="L-3140"><a href="#L-3140"><span class="linenos">3140</span></a><span class="sd">			and decides to recover 3 minutes. time_cost(3) is the cost  when the flight decides to speed up</span>
</span><span id="L-3141"><a href="#L-3141"><span class="linenos">3141</span></a><span class="sd">			so to recover 3 minutes, so it is the cost of the 17 minutes delay that is left.</span>
</span><span id="L-3142"><a href="#L-3142"><span class="linenos">3142</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-3143"><a href="#L-3143"><span class="linenos">3143</span></a>
</span><span id="L-3144"><a href="#L-3144"><span class="linenos">3144</span></a>			<span class="n">time_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3145"><a href="#L-3145"><span class="linenos">3145</span></a>			<span class="n">time_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cost_func</span><span class="p">(</span><span class="n">exp_arr_delay</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_cont</span><span class="p">]</span>
</span><span id="L-3146"><a href="#L-3146"><span class="linenos">3146</span></a>
</span><span id="L-3147"><a href="#L-3147"><span class="linenos">3147</span></a>			<span class="c1">#####################</span>
</span><span id="L-3148"><a href="#L-3148"><span class="linenos">3148</span></a>			<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="L-3149"><a href="#L-3149"><span class="linenos">3149</span></a>			<span class="c1">#####################</span>
</span><span id="L-3150"><a href="#L-3150"><span class="linenos">3150</span></a>			<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time_cost</span> <span class="o">+</span> <span class="n">fuel_cost</span>
</span><span id="L-3151"><a href="#L-3151"><span class="linenos">3151</span></a>
</span><span id="L-3152"><a href="#L-3152"><span class="linenos">3152</span></a>			<span class="n">delay_to_recover</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_cont</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">total_cost</span><span class="p">)])</span>  <span class="c1"># recover with a resolution of one minute</span>
</span><span id="L-3153"><a href="#L-3153"><span class="linenos">3153</span></a>
</span><span id="L-3154"><a href="#L-3154"><span class="linenos">3154</span></a>			<span class="c1"># print(flight_str(flight_uid), &quot; decides to recover &quot;, delay_to_recover, &quot; minutes.&quot;)</span>
</span><span id="L-3155"><a href="#L-3155"><span class="linenos">3155</span></a>
</span><span id="L-3156"><a href="#L-3156"><span class="linenos">3156</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3157"><a href="#L-3157"><span class="linenos">3157</span></a><span class="sd">			#### PLOT THE COST FUNCs - uncomment for plotting costs when flight recovers some delay</span>
</span><span id="L-3158"><a href="#L-3158"><span class="linenos">3158</span></a><span class="sd">			if delay_to_recover &gt; 0:</span>
</span><span id="L-3159"><a href="#L-3159"><span class="linenos">3159</span></a><span class="sd">				self.plot_costs_dci(time_cost, fuel_cost, x_cont)</span>
</span><span id="L-3160"><a href="#L-3160"><span class="linenos">3160</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="L-3161"><a href="#L-3161"><span class="linenos">3161</span></a>
</span><span id="L-3162"><a href="#L-3162"><span class="linenos">3162</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="n">delay_to_recover</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-3163"><a href="#L-3163"><span class="linenos">3163</span></a>
</span><span id="L-3164"><a href="#L-3164"><span class="linenos">3164</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="L-3165"><a href="#L-3165"><span class="linenos">3165</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">delay_to_recover</span>
</span><span id="L-3166"><a href="#L-3166"><span class="linenos">3166</span></a>
</span><span id="L-3167"><a href="#L-3167"><span class="linenos">3167</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>
</span><span id="L-3168"><a href="#L-3168"><span class="linenos">3168</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3169"><a href="#L-3169"><span class="linenos">3169</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3170"><a href="#L-3170"><span class="linenos">3170</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3171"><a href="#L-3171"><span class="linenos">3171</span></a>
</span><span id="L-3172"><a href="#L-3172"><span class="linenos">3172</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3173"><a href="#L-3173"><span class="linenos">3173</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot;is deciding to speed up with selected perc &quot;, perc_selected)</span>
</span><span id="L-3174"><a href="#L-3174"><span class="linenos">3174</span></a>
</span><span id="L-3175"><a href="#L-3175"><span class="linenos">3175</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3176"><a href="#L-3176"><span class="linenos">3176</span></a>				<span class="c1"># print(&quot;The price of the extra fuel &quot;, dfuel, &quot; is &quot;, dfuel * self.agent.fuel_price, &quot; with fuel price set to &quot;, self.agent.fuel_price)</span>
</span><span id="L-3177"><a href="#L-3177"><span class="linenos">3177</span></a>
</span><span id="L-3178"><a href="#L-3178"><span class="linenos">3178</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; at top of climb. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="L-3179"><a href="#L-3179"><span class="linenos">3179</span></a>
</span><span id="L-3180"><a href="#L-3180"><span class="linenos">3180</span></a>				<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="L-3181"><a href="#L-3181"><span class="linenos">3181</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="L-3182"><a href="#L-3182"><span class="linenos">3182</span></a>
</span><span id="L-3183"><a href="#L-3183"><span class="linenos">3183</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-3184"><a href="#L-3184"><span class="linenos">3184</span></a>
</span><span id="L-3185"><a href="#L-3185"><span class="linenos">3185</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="L-3186"><a href="#L-3186"><span class="linenos">3186</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb&#39;</span><span class="p">,</span> <span class="n">estimated_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="L-3187"><a href="#L-3187"><span class="linenos">3187</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-3188"><a href="#L-3188"><span class="linenos">3188</span></a>		<span class="c1"># print(&quot;Reassessment of  cost index FINISHED for&quot;, flight_str(flight_uid))</span>
</span><span id="L-3189"><a href="#L-3189"><span class="linenos">3189</span></a>
</span><span id="L-3190"><a href="#L-3190"><span class="linenos">3190</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3191"><a href="#L-3191"><span class="linenos">3191</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 2 for&quot;, flight_str(flight_uid))</span>
</span><span id="L-3192"><a href="#L-3192"><span class="linenos">3192</span></a>
</span><span id="L-3193"><a href="#L-3193"><span class="linenos">3193</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3194"><a href="#L-3194"><span class="linenos">3194</span></a><span class="sd">		Doing the same as on level 1, but allowing to slow down if estimated arrival</span>
</span><span id="L-3195"><a href="#L-3195"><span class="linenos">3195</span></a><span class="sd">		more than 15 minutes earlier than scheduled. Slow down to 15 minutes.</span>
</span><span id="L-3196"><a href="#L-3196"><span class="linenos">3196</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3197"><a href="#L-3197"><span class="linenos">3197</span></a>
</span><span id="L-3198"><a href="#L-3198"><span class="linenos">3198</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="L-3199"><a href="#L-3199"><span class="linenos">3199</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="L-3200"><a href="#L-3200"><span class="linenos">3200</span></a>
</span><span id="L-3201"><a href="#L-3201"><span class="linenos">3201</span></a>		<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="L-3202"><a href="#L-3202"><span class="linenos">3202</span></a>		<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># allow it to be negative to detect early arrivals</span>
</span><span id="L-3203"><a href="#L-3203"><span class="linenos">3203</span></a>
</span><span id="L-3204"><a href="#L-3204"><span class="linenos">3204</span></a>		<span class="k">if</span> <span class="n">exp_arr_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3205"><a href="#L-3205"><span class="linenos">3205</span></a>			<span class="c1"># do the same as on level 1: try to speed up further</span>
</span><span id="L-3206"><a href="#L-3206"><span class="linenos">3206</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3207"><a href="#L-3207"><span class="linenos">3207</span></a>
</span><span id="L-3208"><a href="#L-3208"><span class="linenos">3208</span></a>		<span class="k">elif</span> <span class="n">exp_arr_delay</span> <span class="o">&lt;=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span><span class="p">:</span> <span class="c1"># default -30, arriving more than 30 minutes earlier than planned</span>
</span><span id="L-3209"><a href="#L-3209"><span class="linenos">3209</span></a>			<span class="c1"># print(&quot;Flight &quot;, flight_uid ,&quot; expects to arrive &quot;, abs(exp_arr_delay), &quot; minutes earlier than scheduled.&quot;)</span>
</span><span id="L-3210"><a href="#L-3210"><span class="linenos">3210</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; expects to arrive &quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="s2">&quot; minutes earlier than scheduled.&quot;</span><span class="p">)</span>
</span><span id="L-3211"><a href="#L-3211"><span class="linenos">3211</span></a>
</span><span id="L-3212"><a href="#L-3212"><span class="linenos">3212</span></a>			<span class="c1"># add add_mins minutes to the flight</span>
</span><span id="L-3213"><a href="#L-3213"><span class="linenos">3213</span></a>			<span class="n">add_mins</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span>
</span><span id="L-3214"><a href="#L-3214"><span class="linenos">3214</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3215"><a href="#L-3215"><span class="linenos">3215</span></a>			<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-3216"><a href="#L-3216"><span class="linenos">3216</span></a>
</span><span id="L-3217"><a href="#L-3217"><span class="linenos">3217</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3218"><a href="#L-3218"><span class="linenos">3218</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3219"><a href="#L-3219"><span class="linenos">3219</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3220"><a href="#L-3220"><span class="linenos">3220</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3221"><a href="#L-3221"><span class="linenos">3221</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3222"><a href="#L-3222"><span class="linenos">3222</span></a>
</span><span id="L-3223"><a href="#L-3223"><span class="linenos">3223</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-3224"><a href="#L-3224"><span class="linenos">3224</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to decrease the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="L-3225"><a href="#L-3225"><span class="linenos">3225</span></a>
</span><span id="L-3226"><a href="#L-3226"><span class="linenos">3226</span></a><span class="w">				</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3227"><a href="#L-3227"><span class="linenos">3227</span></a><span class="sd">				x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="L-3228"><a href="#L-3228"><span class="linenos">3228</span></a><span class="sd">				plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="L-3229"><a href="#L-3229"><span class="linenos">3229</span></a><span class="sd">				plt.show()</span>
</span><span id="L-3230"><a href="#L-3230"><span class="linenos">3230</span></a><span class="sd">				plt.clf()</span>
</span><span id="L-3231"><a href="#L-3231"><span class="linenos">3231</span></a><span class="sd">				&quot;&quot;&quot;</span>
</span><span id="L-3232"><a href="#L-3232"><span class="linenos">3232</span></a>
</span><span id="L-3233"><a href="#L-3233"><span class="linenos">3233</span></a>				<span class="c1"># real extra minutes that are going to be added to the flight - depends on max_time_w_fuel</span>
</span><span id="L-3234"><a href="#L-3234"><span class="linenos">3234</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">],</span> <span class="n">add_mins</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3235"><a href="#L-3235"><span class="linenos">3235</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot; decides to add &quot;, delta_t, &quot; minutes as the maximum is &quot;, tfsc[&#39;max_time_w_fuel&#39;])</span>
</span><span id="L-3236"><a href="#L-3236"><span class="linenos">3236</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3237"><a href="#L-3237"><span class="linenos">3237</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3238"><a href="#L-3238"><span class="linenos">3238</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is adding&quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot;minutes to the flying time at top of climb. Saving&quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg of fuel.&quot;</span><span class="p">)</span>
</span><span id="L-3239"><a href="#L-3239"><span class="linenos">3239</span></a>
</span><span id="L-3240"><a href="#L-3240"><span class="linenos">3240</span></a>				<span class="c1"># send msg to flight plan updater to update speed - USE DCI_TOD_LANDING</span>
</span><span id="L-3241"><a href="#L-3241"><span class="linenos">3241</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-3242"><a href="#L-3242"><span class="linenos">3242</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage&quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="L-3243"><a href="#L-3243"><span class="linenos">3243</span></a>				<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-3244"><a href="#L-3244"><span class="linenos">3244</span></a>
</span><span id="L-3245"><a href="#L-3245"><span class="linenos">3245</span></a>				<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="L-3246"><a href="#L-3246"><span class="linenos">3246</span></a>				<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="L-3247"><a href="#L-3247"><span class="linenos">3247</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-3248"><a href="#L-3248"><span class="linenos">3248</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3249"><a href="#L-3249"><span class="linenos">3249</span></a>			<span class="c1"># just save the info (flight didn&#39;t do anything on TOC)</span>
</span><span id="L-3250"><a href="#L-3250"><span class="linenos">3250</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3251"><a href="#L-3251"><span class="linenos">3251</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3252"><a href="#L-3252"><span class="linenos">3252</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3253"><a href="#L-3253"><span class="linenos">3253</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3254"><a href="#L-3254"><span class="linenos">3254</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3255"><a href="#L-3255"><span class="linenos">3255</span></a>			<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="L-3256"><a href="#L-3256"><span class="linenos">3256</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="L-3257"><a href="#L-3257"><span class="linenos">3257</span></a>
</span><span id="L-3258"><a href="#L-3258"><span class="linenos">3258</span></a>		<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="L-3259"><a href="#L-3259"><span class="linenos">3259</span></a>		<span class="c1"># params = [&#39;top_of_climb_slow_down&#39;, exp_arr_delay, -delta_t, perc_selected, dfuel, extra_fuel_available, recoverable_delay]</span>
</span><span id="L-3260"><a href="#L-3260"><span class="linenos">3260</span></a>		<span class="c1"># self.save_dci_decision_info(flight_uid, params)</span>
</span><span id="L-3261"><a href="#L-3261"><span class="linenos">3261</span></a>
</span><span id="L-3262"><a href="#L-3262"><span class="linenos">3262</span></a>	<span class="k">def</span> <span class="nf">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-3263"><a href="#L-3263"><span class="linenos">3263</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3264"><a href="#L-3264"><span class="linenos">3264</span></a><span class="sd">		Sends a message to the flight plan updater who updates the speed by</span>
</span><span id="L-3265"><a href="#L-3265"><span class="linenos">3265</span></a><span class="sd">		increasing it by perc_selected.</span>
</span><span id="L-3266"><a href="#L-3266"><span class="linenos">3266</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3267"><a href="#L-3267"><span class="linenos">3267</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3268"><a href="#L-3268"><span class="linenos">3268</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-3269"><a href="#L-3269"><span class="linenos">3269</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;speed_update&#39;</span>
</span><span id="L-3270"><a href="#L-3270"><span class="linenos">3270</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">perc_selected</span><span class="p">,</span>
</span><span id="L-3271"><a href="#L-3271"><span class="linenos">3271</span></a>					   <span class="s1">&#39;change_tod_dci&#39;</span><span class="p">:</span> <span class="n">change_tod_dci</span><span class="p">}</span>
</span><span id="L-3272"><a href="#L-3272"><span class="linenos">3272</span></a>
</span><span id="L-3273"><a href="#L-3273"><span class="linenos">3273</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3274"><a href="#L-3274"><span class="linenos">3274</span></a>
</span><span id="L-3275"><a href="#L-3275"><span class="linenos">3275</span></a>	<span class="k">def</span> <span class="nf">save_dci_decision_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="L-3276"><a href="#L-3276"><span class="linenos">3276</span></a>		<span class="n">dci_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dci_check_timestamp&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-3277"><a href="#L-3277"><span class="linenos">3277</span></a>						<span class="s1">&#39;estimated_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-3278"><a href="#L-3278"><span class="linenos">3278</span></a>						<span class="s1">&#39;recovering_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="L-3279"><a href="#L-3279"><span class="linenos">3279</span></a>						<span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="L-3280"><a href="#L-3280"><span class="linenos">3280</span></a>						<span class="s1">&#39;dfuel&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="L-3281"><a href="#L-3281"><span class="linenos">3281</span></a>						<span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="L-3282"><a href="#L-3282"><span class="linenos">3282</span></a>						<span class="s1">&#39;recoverable_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="L-3283"><a href="#L-3283"><span class="linenos">3283</span></a>						<span class="p">}</span>
</span><span id="L-3284"><a href="#L-3284"><span class="linenos">3284</span></a>
</span><span id="L-3285"><a href="#L-3285"><span class="linenos">3285</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dci_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dci_decision</span><span class="p">)</span>
</span><span id="L-3286"><a href="#L-3286"><span class="linenos">3286</span></a>
</span><span id="L-3287"><a href="#L-3287"><span class="linenos">3287</span></a>		<span class="c1"># test</span>
</span><span id="L-3288"><a href="#L-3288"><span class="linenos">3288</span></a>		<span class="c1"># print(self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].dci_decisions)</span>
</span><span id="L-3289"><a href="#L-3289"><span class="linenos">3289</span></a>
</span><span id="L-3290"><a href="#L-3290"><span class="linenos">3290</span></a>
</span><span id="L-3291"><a href="#L-3291"><span class="linenos">3291</span></a><span class="k">class</span> <span class="nc">PassengerReallocation</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-3292"><a href="#L-3292"><span class="linenos">3292</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3293"><a href="#L-3293"><span class="linenos">3293</span></a><span class="sd">	PR</span>
</span><span id="L-3294"><a href="#L-3294"><span class="linenos">3294</span></a>
</span><span id="L-3295"><a href="#L-3295"><span class="linenos">3295</span></a><span class="sd">	Description: Decide how to manage connecting passengers when a flight has left.</span>
</span><span id="L-3296"><a href="#L-3296"><span class="linenos">3296</span></a><span class="sd">	1. Check passenger that should have been in the flight that has left and have missed their connection</span>
</span><span id="L-3297"><a href="#L-3297"><span class="linenos">3297</span></a><span class="sd">	2. Rebook them onto following flights to destination, compensate compute_missed_connecting_paxand return them to destination, pay for care, and potentially put them in hotels by checking preferences with passengers.</span>
</span><span id="L-3298"><a href="#L-3298"><span class="linenos">3298</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-3299"><a href="#L-3299"><span class="linenos">3299</span></a>
</span><span id="L-3300"><a href="#L-3300"><span class="linenos">3300</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="L-3301"><a href="#L-3301"><span class="linenos">3301</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="L-3302"><a href="#L-3302"><span class="linenos">3302</span></a>
</span><span id="L-3303"><a href="#L-3303"><span class="linenos">3303</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="L-3304"><a href="#L-3304"><span class="linenos">3304</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_missed_connecting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3305"><a href="#L-3305"><span class="linenos">3305</span></a>
</span><span id="L-3306"><a href="#L-3306"><span class="linenos">3306</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from check_push_back of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3307"><a href="#L-3307"><span class="linenos">3307</span></a>
</span><span id="L-3308"><a href="#L-3308"><span class="linenos">3308</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">paxs</span><span class="p">)</span>
</span><span id="L-3309"><a href="#L-3309"><span class="linenos">3309</span></a>
</span><span id="L-3310"><a href="#L-3310"><span class="linenos">3310</span></a>	<span class="k">def</span> <span class="nf">compute_missed_connecting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3311"><a href="#L-3311"><span class="linenos">3311</span></a>		<span class="n">pax_needing_reallocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="L-3312"><a href="#L-3312"><span class="linenos">3312</span></a>									<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="L-3313"><a href="#L-3313"><span class="linenos">3313</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_needing_reallocation</span><span class="p">:</span>
</span><span id="L-3314"><a href="#L-3314"><span class="linenos">3314</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3315"><a href="#L-3315"><span class="linenos">3315</span></a>
</span><span id="L-3316"><a href="#L-3316"><span class="linenos">3316</span></a>			<span class="c1"># Check if pax has taken more time than what the airline was expecting</span>
</span><span id="L-3317"><a href="#L-3317"><span class="linenos">3317</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="o">&gt;</span><span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">:</span>
</span><span id="L-3318"><a href="#L-3318"><span class="linenos">3318</span></a>				<span class="c1"># If so, blame the pax for any compensation</span>
</span><span id="L-3319"><a href="#L-3319"><span class="linenos">3319</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has taken&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="p">,</span> <span class="s1">&#39;as connecting time vs. an MCT of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">,</span>
</span><span id="L-3320"><a href="#L-3320"><span class="linenos">3320</span></a>						<span class="s1">&#39;; it blames itself for any future compensation&#39;</span><span class="p">)</span>
</span><span id="L-3321"><a href="#L-3321"><span class="linenos">3321</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="s1">&#39;self&#39;</span>
</span><span id="L-3322"><a href="#L-3322"><span class="linenos">3322</span></a>
</span><span id="L-3323"><a href="#L-3323"><span class="linenos">3323</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax already at airport left behind by&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">pax_needing_reallocation</span><span class="p">)</span>
</span><span id="L-3324"><a href="#L-3324"><span class="linenos">3324</span></a>
</span><span id="L-3325"><a href="#L-3325"><span class="linenos">3325</span></a>		<span class="k">return</span> <span class="n">pax_needing_reallocation</span>
</span><span id="L-3326"><a href="#L-3326"><span class="linenos">3326</span></a>
</span><span id="L-3327"><a href="#L-3327"><span class="linenos">3327</span></a>	<span class="k">def</span> <span class="nf">compute_reallocation_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-3328"><a href="#L-3328"><span class="linenos">3328</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3329"><a href="#L-3329"><span class="linenos">3329</span></a><span class="sd">		Note: only direct flights and flights with one connection</span>
</span><span id="L-3330"><a href="#L-3330"><span class="linenos">3330</span></a><span class="sd">		are considered.</span>
</span><span id="L-3331"><a href="#L-3331"><span class="linenos">3331</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3332"><a href="#L-3332"><span class="linenos">3332</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;compute_reallocation_options&#39;</span><span class="p">):</span>
</span><span id="L-3333"><a href="#L-3333"><span class="linenos">3333</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3334"><a href="#L-3334"><span class="linenos">3334</span></a>			<span class="n">itineraries</span><span class="p">,</span> <span class="n">travelling_times</span><span class="p">,</span> <span class="n">capacities</span><span class="p">,</span> <span class="n">arrival_times</span><span class="p">,</span> <span class="n">departure_times</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="L-3335"><a href="#L-3335"><span class="linenos">3335</span></a>			<span class="n">transfer_costs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3336"><a href="#L-3336"><span class="linenos">3336</span></a>
</span><span id="L-3337"><a href="#L-3337"><span class="linenos">3337</span></a>			<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="L-3338"><a href="#L-3338"><span class="linenos">3338</span></a>			<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="L-3339"><a href="#L-3339"><span class="linenos">3339</span></a>			<span class="c1"># now (like the one it missed).</span>
</span><span id="L-3340"><a href="#L-3340"><span class="linenos">3340</span></a>			<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-3341"><a href="#L-3341"><span class="linenos">3341</span></a>										<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">from_airport</span><span class="p">)</span>
</span><span id="L-3342"><a href="#L-3342"><span class="linenos">3342</span></a>										<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3343"><a href="#L-3343"><span class="linenos">3343</span></a>										<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3344"><a href="#L-3344"><span class="linenos">3344</span></a>
</span><span id="L-3345"><a href="#L-3345"><span class="linenos">3345</span></a>			<span class="c1"># First select direct itineraries</span>
</span><span id="L-3346"><a href="#L-3346"><span class="linenos">3346</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="L-3347"><a href="#L-3347"><span class="linenos">3347</span></a>											<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="L-3348"><a href="#L-3348"><span class="linenos">3348</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3349"><a href="#L-3349"><span class="linenos">3349</span></a>
</span><span id="L-3350"><a href="#L-3350"><span class="linenos">3350</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3351"><a href="#L-3351"><span class="linenos">3351</span></a>
</span><span id="L-3352"><a href="#L-3352"><span class="linenos">3352</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3353"><a href="#L-3353"><span class="linenos">3353</span></a>
</span><span id="L-3354"><a href="#L-3354"><span class="linenos">3354</span></a>			<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="L-3355"><a href="#L-3355"><span class="linenos">3355</span></a>			<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="L-3356"><a href="#L-3356"><span class="linenos">3356</span></a>			<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="L-3357"><a href="#L-3357"><span class="linenos">3357</span></a>			<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="L-3358"><a href="#L-3358"><span class="linenos">3358</span></a>			<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="L-3359"><a href="#L-3359"><span class="linenos">3359</span></a>			<span class="c1"># aprint(&#39;capacity:&#39;, sum(capacities))</span>
</span><span id="L-3360"><a href="#L-3360"><span class="linenos">3360</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="L-3361"><a href="#L-3361"><span class="linenos">3361</span></a>				<span class="c1"># Then search indirect itineraries</span>
</span><span id="L-3362"><a href="#L-3362"><span class="linenos">3362</span></a>				<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="L-3363"><a href="#L-3363"><span class="linenos">3363</span></a>				<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-3364"><a href="#L-3364"><span class="linenos">3364</span></a>											<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="L-3365"><a href="#L-3365"><span class="linenos">3365</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="L-3366"><a href="#L-3366"><span class="linenos">3366</span></a>											<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3367"><a href="#L-3367"><span class="linenos">3367</span></a>
</span><span id="L-3368"><a href="#L-3368"><span class="linenos">3368</span></a>				<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="L-3369"><a href="#L-3369"><span class="linenos">3369</span></a>
</span><span id="L-3370"><a href="#L-3370"><span class="linenos">3370</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span> <span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">outbound_flights</span> <span class="k">for</span> <span class="n">f2</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="L-3371"><a href="#L-3371"><span class="linenos">3371</span></a>											<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-3372"><a href="#L-3372"><span class="linenos">3372</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="L-3373"><a href="#L-3373"><span class="linenos">3373</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="L-3374"><a href="#L-3374"><span class="linenos">3374</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3375"><a href="#L-3375"><span class="linenos">3375</span></a>
</span><span id="L-3376"><a href="#L-3376"><span class="linenos">3376</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-3377"><a href="#L-3377"><span class="linenos">3377</span></a>
</span><span id="L-3378"><a href="#L-3378"><span class="linenos">3378</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential indirect flights:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3379"><a href="#L-3379"><span class="linenos">3379</span></a>
</span><span id="L-3380"><a href="#L-3380"><span class="linenos">3380</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="L-3381"><a href="#L-3381"><span class="linenos">3381</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="L-3382"><a href="#L-3382"><span class="linenos">3382</span></a>				<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="L-3383"><a href="#L-3383"><span class="linenos">3383</span></a>				<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="L-3384"><a href="#L-3384"><span class="linenos">3384</span></a>				<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="L-3385"><a href="#L-3385"><span class="linenos">3385</span></a>				<span class="c1"># aprint(&#39;capacity:&#39;, sum(self.capacities))</span>
</span><span id="L-3386"><a href="#L-3386"><span class="linenos">3386</span></a>
</span><span id="L-3387"><a href="#L-3387"><span class="linenos">3387</span></a>			<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="L-3388"><a href="#L-3388"><span class="linenos">3388</span></a>			<span class="c1"># capacity_functions += [self.agent.get_number_seats_itinerary]*len(itineraries)</span>
</span><span id="L-3389"><a href="#L-3389"><span class="linenos">3389</span></a>
</span><span id="L-3390"><a href="#L-3390"><span class="linenos">3390</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="L-3391"><a href="#L-3391"><span class="linenos">3391</span></a>				<span class="c1"># Look for itineraries within alliance and outside of alliance.</span>
</span><span id="L-3392"><a href="#L-3392"><span class="linenos">3392</span></a>
</span><span id="L-3393"><a href="#L-3393"><span class="linenos">3393</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;looks for more itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3394"><a href="#L-3394"><span class="linenos">3394</span></a>
</span><span id="L-3395"><a href="#L-3395"><span class="linenos">3395</span></a>				<span class="n">capacity_needed</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span>
</span><span id="L-3396"><a href="#L-3396"><span class="linenos">3396</span></a>
</span><span id="L-3397"><a href="#L-3397"><span class="linenos">3397</span></a>				<span class="c1"># First try intra-alliance itineraries</span>
</span><span id="L-3398"><a href="#L-3398"><span class="linenos">3398</span></a>				<span class="c1"># Outbound flights (including the initial airline&#39;s)</span>
</span><span id="L-3399"><a href="#L-3399"><span class="linenos">3399</span></a>				<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>  <span class="c1"># self.airlines[aoc_uid2][&#39;aoc&#39;])</span>
</span><span id="L-3400"><a href="#L-3400"><span class="linenos">3400</span></a>										<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="L-3401"><a href="#L-3401"><span class="linenos">3401</span></a>											<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="L-3402"><a href="#L-3402"><span class="linenos">3402</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="L-3403"><a href="#L-3403"><span class="linenos">3403</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-3404"><a href="#L-3404"><span class="linenos">3404</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3405"><a href="#L-3405"><span class="linenos">3405</span></a>
</span><span id="L-3406"><a href="#L-3406"><span class="linenos">3406</span></a>				<span class="c1"># Select direct flights</span>
</span><span id="L-3407"><a href="#L-3407"><span class="linenos">3407</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="L-3408"><a href="#L-3408"><span class="linenos">3408</span></a>												<span class="k">if</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="L-3409"><a href="#L-3409"><span class="linenos">3409</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3410"><a href="#L-3410"><span class="linenos">3410</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-3411"><a href="#L-3411"><span class="linenos">3411</span></a>
</span><span id="L-3412"><a href="#L-3412"><span class="linenos">3412</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="L-3413"><a href="#L-3413"><span class="linenos">3413</span></a>				<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">direct_itineraries</span><span class="p">)</span>
</span><span id="L-3414"><a href="#L-3414"><span class="linenos">3414</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance direct flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">direct_itineraries</span><span class="p">,</span>
</span><span id="L-3415"><a href="#L-3415"><span class="linenos">3415</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3416"><a href="#L-3416"><span class="linenos">3416</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="L-3417"><a href="#L-3417"><span class="linenos">3417</span></a>
</span><span id="L-3418"><a href="#L-3418"><span class="linenos">3418</span></a>				<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">:</span>
</span><span id="L-3419"><a href="#L-3419"><span class="linenos">3419</span></a>
</span><span id="L-3420"><a href="#L-3420"><span class="linenos">3420</span></a>					<span class="c1"># Search indirect flights</span>
</span><span id="L-3421"><a href="#L-3421"><span class="linenos">3421</span></a>					<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="L-3422"><a href="#L-3422"><span class="linenos">3422</span></a>					<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="L-3423"><a href="#L-3423"><span class="linenos">3423</span></a>											<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="L-3424"><a href="#L-3424"><span class="linenos">3424</span></a>											 <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="L-3425"><a href="#L-3425"><span class="linenos">3425</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="L-3426"><a href="#L-3426"><span class="linenos">3426</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="L-3427"><a href="#L-3427"><span class="linenos">3427</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3428"><a href="#L-3428"><span class="linenos">3428</span></a>
</span><span id="L-3429"><a href="#L-3429"><span class="linenos">3429</span></a>					<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="L-3430"><a href="#L-3430"><span class="linenos">3430</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">))</span>
</span><span id="L-3431"><a href="#L-3431"><span class="linenos">3431</span></a>												<span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="L-3432"><a href="#L-3432"><span class="linenos">3432</span></a>												<span class="k">for</span> <span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="L-3433"><a href="#L-3433"><span class="linenos">3433</span></a>												<span class="k">if</span> <span class="p">((</span><span class="n">aoc1_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
</span><span id="L-3434"><a href="#L-3434"><span class="linenos">3434</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="L-3435"><a href="#L-3435"><span class="linenos">3435</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="L-3436"><a href="#L-3436"><span class="linenos">3436</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="L-3437"><a href="#L-3437"><span class="linenos">3437</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="L-3438"><a href="#L-3438"><span class="linenos">3438</span></a>
</span><span id="L-3439"><a href="#L-3439"><span class="linenos">3439</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-3440"><a href="#L-3440"><span class="linenos">3440</span></a>
</span><span id="L-3441"><a href="#L-3441"><span class="linenos">3441</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance indirect flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span>
</span><span id="L-3442"><a href="#L-3442"><span class="linenos">3442</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3443"><a href="#L-3443"><span class="linenos">3443</span></a>
</span><span id="L-3444"><a href="#L-3444"><span class="linenos">3444</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="L-3445"><a href="#L-3445"><span class="linenos">3445</span></a>					<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">indirect_itineraries</span><span class="p">)</span>
</span><span id="L-3446"><a href="#L-3446"><span class="linenos">3446</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="L-3447"><a href="#L-3447"><span class="linenos">3447</span></a>
</span><span id="L-3448"><a href="#L-3448"><span class="linenos">3448</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">):</span>
</span><span id="L-3449"><a href="#L-3449"><span class="linenos">3449</span></a>					<span class="c1"># Try airlines outside of alliance. Check only direct flights. Compute the price of rebooking.</span>
</span><span id="L-3450"><a href="#L-3450"><span class="linenos">3450</span></a>					<span class="n">indirect_outside_itineraries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3451"><a href="#L-3451"><span class="linenos">3451</span></a>					<span class="k">for</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">():</span>
</span><span id="L-3452"><a href="#L-3452"><span class="linenos">3452</span></a>						<span class="k">if</span> <span class="n">aoc2_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">():</span>
</span><span id="L-3453"><a href="#L-3453"><span class="linenos">3453</span></a>							<span class="c1"># for flight_uid, flight_info in self.airlines[aoc2_uid][&#39;aoc&#39;].aoc_flights_info.items():</span>
</span><span id="L-3454"><a href="#L-3454"><span class="linenos">3454</span></a>							<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc2_uid</span><span class="p">):</span>
</span><span id="L-3455"><a href="#L-3455"><span class="linenos">3455</span></a>								<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>\
</span><span id="L-3456"><a href="#L-3456"><span class="linenos">3456</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>\
</span><span id="L-3457"><a href="#L-3457"><span class="linenos">3457</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>\
</span><span id="L-3458"><a href="#L-3458"><span class="linenos">3458</span></a>									<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">:</span>
</span><span id="L-3459"><a href="#L-3459"><span class="linenos">3459</span></a>										<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3460"><a href="#L-3460"><span class="linenos">3460</span></a>											<span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3461"><a href="#L-3461"><span class="linenos">3461</span></a>											<span class="n">indirect_outside_itineraries</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span>
</span><span id="L-3462"><a href="#L-3462"><span class="linenos">3462</span></a>											<span class="n">transfer_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
</span><span id="L-3463"><a href="#L-3463"><span class="linenos">3463</span></a>
</span><span id="L-3464"><a href="#L-3464"><span class="linenos">3464</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights outside of alliance for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_outside_itineraries</span><span class="p">,</span>
</span><span id="L-3465"><a href="#L-3465"><span class="linenos">3465</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3466"><a href="#L-3466"><span class="linenos">3466</span></a>
</span><span id="L-3467"><a href="#L-3467"><span class="linenos">3467</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_outside_itineraries</span>
</span><span id="L-3468"><a href="#L-3468"><span class="linenos">3468</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">]</span>
</span><span id="L-3469"><a href="#L-3469"><span class="linenos">3469</span></a>
</span><span id="L-3470"><a href="#L-3470"><span class="linenos">3470</span></a>				<span class="n">travelling_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="L-3471"><a href="#L-3471"><span class="linenos">3471</span></a>				<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="L-3472"><a href="#L-3472"><span class="linenos">3472</span></a>				<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="L-3473"><a href="#L-3473"><span class="linenos">3473</span></a>
</span><span id="L-3474"><a href="#L-3474"><span class="linenos">3474</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3475"><a href="#L-3475"><span class="linenos">3475</span></a>
</span><span id="L-3476"><a href="#L-3476"><span class="linenos">3476</span></a>			<span class="n">capacity_functions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="L-3477"><a href="#L-3477"><span class="linenos">3477</span></a>
</span><span id="L-3478"><a href="#L-3478"><span class="linenos">3478</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;itineraries&#39;</span><span class="p">:</span> <span class="n">itineraries</span><span class="p">,</span>
</span><span id="L-3479"><a href="#L-3479"><span class="linenos">3479</span></a>									<span class="s1">&#39;capacities&#39;</span><span class="p">:</span> <span class="n">capacities</span><span class="p">,</span>
</span><span id="L-3480"><a href="#L-3480"><span class="linenos">3480</span></a>									<span class="s1">&#39;travelling_times&#39;</span><span class="p">:</span> <span class="n">travelling_times</span><span class="p">,</span>
</span><span id="L-3481"><a href="#L-3481"><span class="linenos">3481</span></a>									<span class="s1">&#39;transfer_costs&#39;</span><span class="p">:</span> <span class="n">transfer_costs</span><span class="p">,</span>
</span><span id="L-3482"><a href="#L-3482"><span class="linenos">3482</span></a>									<span class="s1">&#39;arrival_times&#39;</span><span class="p">:</span> <span class="n">arrival_times</span><span class="p">,</span>
</span><span id="L-3483"><a href="#L-3483"><span class="linenos">3483</span></a>									<span class="s1">&#39;departure_times&#39;</span><span class="p">:</span> <span class="n">departure_times</span><span class="p">,</span>
</span><span id="L-3484"><a href="#L-3484"><span class="linenos">3484</span></a>									<span class="s1">&#39;capacity_functions&#39;</span><span class="p">:</span> <span class="n">capacity_functions</span><span class="p">}</span>
</span><span id="L-3485"><a href="#L-3485"><span class="linenos">3485</span></a>
</span><span id="L-3486"><a href="#L-3486"><span class="linenos">3486</span></a>		<span class="k">return</span> <span class="n">reallocation_options</span>
</span><span id="L-3487"><a href="#L-3487"><span class="linenos">3487</span></a>
</span><span id="L-3488"><a href="#L-3488"><span class="linenos">3488</span></a>	<span class="k">def</span> <span class="nf">do_reallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="L-3489"><a href="#L-3489"><span class="linenos">3489</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3490"><a href="#L-3490"><span class="linenos">3490</span></a><span class="sd">		Note: I added that to have processes to wait for answer from itinerary provider.</span>
</span><span id="L-3491"><a href="#L-3491"><span class="linenos">3491</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3492"><a href="#L-3492"><span class="linenos">3492</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-3493"><a href="#L-3493"><span class="linenos">3493</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3494"><a href="#L-3494"><span class="linenos">3494</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span><span class="p">)</span>
</span><span id="L-3495"><a href="#L-3495"><span class="linenos">3495</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Options for reallocation for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span>
</span><span id="L-3496"><a href="#L-3496"><span class="linenos">3496</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Capacities of pot. new itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])</span>
</span><span id="L-3497"><a href="#L-3497"><span class="linenos">3497</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3498"><a href="#L-3498"><span class="linenos">3498</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">reallocate_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="L-3499"><a href="#L-3499"><span class="linenos">3499</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-3500"><a href="#L-3500"><span class="linenos">3500</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;could not find any other itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3501"><a href="#L-3501"><span class="linenos">3501</span></a>				<span class="c1"># Remove passengers from boarding lists of all remaining flights.</span>
</span><span id="L-3502"><a href="#L-3502"><span class="linenos">3502</span></a>				<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flights</span><span class="p">():</span>
</span><span id="L-3503"><a href="#L-3503"><span class="linenos">3503</span></a>					<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-3504"><a href="#L-3504"><span class="linenos">3504</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3505"><a href="#L-3505"><span class="linenos">3505</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="L-3506"><a href="#L-3506"><span class="linenos">3506</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3507"><a href="#L-3507"><span class="linenos">3507</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3508"><a href="#L-3508"><span class="linenos">3508</span></a>
</span><span id="L-3509"><a href="#L-3509"><span class="linenos">3509</span></a>	<span class="k">def</span> <span class="nf">_cost_of_itineraries_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">):</span>
</span><span id="L-3510"><a href="#L-3510"><span class="linenos">3510</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3511"><a href="#L-3511"><span class="linenos">3511</span></a><span class="sd">		Requires that the self.agent.aoc_pax_info[pax.id] dict has been filled already.</span>
</span><span id="L-3512"><a href="#L-3512"><span class="linenos">3512</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3513"><a href="#L-3513"><span class="linenos">3513</span></a>
</span><span id="L-3514"><a href="#L-3514"><span class="linenos">3514</span></a>		<span class="n">soft_cost_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;arrival_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-3515"><a href="#L-3515"><span class="linenos">3515</span></a>		<span class="n">transfer_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;transfer_costs&#39;</span><span class="p">])</span>
</span><span id="L-3516"><a href="#L-3516"><span class="linenos">3516</span></a>		<span class="n">compensation_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;arrival_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-3517"><a href="#L-3517"><span class="linenos">3517</span></a>		<span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">dt</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;departure_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-3518"><a href="#L-3518"><span class="linenos">3518</span></a>
</span><span id="L-3519"><a href="#L-3519"><span class="linenos">3519</span></a>		<span class="k">return</span> <span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span>
</span><span id="L-3520"><a href="#L-3520"><span class="linenos">3520</span></a>
</span><span id="L-3521"><a href="#L-3521"><span class="linenos">3521</span></a>	<span class="k">def</span> <span class="nf">reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">):</span>
</span><span id="L-3522"><a href="#L-3522"><span class="linenos">3522</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3523"><a href="#L-3523"><span class="linenos">3523</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3524"><a href="#L-3524"><span class="linenos">3524</span></a>		<span class="c1"># Reallocate passengers</span>
</span><span id="L-3525"><a href="#L-3525"><span class="linenos">3525</span></a>		<span class="c1"># For duty of care, take only into account current wait</span>
</span><span id="L-3526"><a href="#L-3526"><span class="linenos">3526</span></a>		<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="L-3527"><a href="#L-3527"><span class="linenos">3527</span></a>
</span><span id="L-3528"><a href="#L-3528"><span class="linenos">3528</span></a>		<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="L-3529"><a href="#L-3529"><span class="linenos">3529</span></a>
</span><span id="L-3530"><a href="#L-3530"><span class="linenos">3530</span></a>		<span class="c1"># Sort options</span>
</span><span id="L-3531"><a href="#L-3531"><span class="linenos">3531</span></a>		<span class="n">idx_ranked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span>
</span><span id="L-3532"><a href="#L-3532"><span class="linenos">3532</span></a>		<span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="L-3533"><a href="#L-3533"><span class="linenos">3533</span></a>		<span class="n">capacities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>  <span class="c1"># These are theoretical capacities!</span>
</span><span id="L-3534"><a href="#L-3534"><span class="linenos">3534</span></a>		<span class="n">transfer_costs_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="L-3535"><a href="#L-3535"><span class="linenos">3535</span></a>		<span class="n">capacity_functions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacity_functions&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="L-3536"><a href="#L-3536"><span class="linenos">3536</span></a>
</span><span id="L-3537"><a href="#L-3537"><span class="linenos">3537</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-3538"><a href="#L-3538"><span class="linenos">3538</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked capacities for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">)</span>
</span><span id="L-3539"><a href="#L-3539"><span class="linenos">3539</span></a>
</span><span id="L-3540"><a href="#L-3540"><span class="linenos">3540</span></a>		<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="L-3541"><a href="#L-3541"><span class="linenos">3541</span></a>
</span><span id="L-3542"><a href="#L-3542"><span class="linenos">3542</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;reallocates&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3543"><a href="#L-3543"><span class="linenos">3543</span></a>		<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3544"><a href="#L-3544"><span class="linenos">3544</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)):</span>
</span><span id="L-3545"><a href="#L-3545"><span class="linenos">3545</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; before update:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3546"><a href="#L-3546"><span class="linenos">3546</span></a>			<span class="n">available_seats</span> <span class="o">=</span> <span class="n">capacity_functions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># self.agent.get_number_seats_itinerary(options[i])</span>
</span><span id="L-3547"><a href="#L-3547"><span class="linenos">3547</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; after update:&#39;</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3548"><a href="#L-3548"><span class="linenos">3548</span></a>
</span><span id="L-3549"><a href="#L-3549"><span class="linenos">3549</span></a>			<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3550"><a href="#L-3550"><span class="linenos">3550</span></a>				<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="L-3551"><a href="#L-3551"><span class="linenos">3551</span></a>					<span class="c1"># All remaining passengers can be fitted into this itinerary</span>
</span><span id="L-3552"><a href="#L-3552"><span class="linenos">3552</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Putting all remaining pax in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;in itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="L-3553"><a href="#L-3553"><span class="linenos">3553</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">pax</span>
</span><span id="L-3554"><a href="#L-3554"><span class="linenos">3554</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3555"><a href="#L-3555"><span class="linenos">3555</span></a>					<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3556"><a href="#L-3556"><span class="linenos">3556</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3557"><a href="#L-3557"><span class="linenos">3557</span></a>					<span class="c1"># Split passengers</span>
</span><span id="L-3558"><a href="#L-3558"><span class="linenos">3558</span></a>					<span class="n">new_pax</span> <span class="o">=</span> <span class="n">clone_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">)</span>
</span><span id="L-3559"><a href="#L-3559"><span class="linenos">3559</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">new_paxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pax</span><span class="p">)</span>
</span><span id="L-3560"><a href="#L-3560"><span class="linenos">3560</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-=</span> <span class="n">available_seats</span>
</span><span id="L-3561"><a href="#L-3561"><span class="linenos">3561</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Splitting pax. New clone of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">new_pax</span><span class="p">)</span>
</span><span id="L-3562"><a href="#L-3562"><span class="linenos">3562</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Remaining pax:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3563"><a href="#L-3563"><span class="linenos">3563</span></a>
</span><span id="L-3564"><a href="#L-3564"><span class="linenos">3564</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">new_pax</span>
</span><span id="L-3565"><a href="#L-3565"><span class="linenos">3565</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3566"><a href="#L-3566"><span class="linenos">3566</span></a>
</span><span id="L-3567"><a href="#L-3567"><span class="linenos">3567</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_reallocate_pax_to_itinerary</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">)</span>
</span><span id="L-3568"><a href="#L-3568"><span class="linenos">3568</span></a>
</span><span id="L-3569"><a href="#L-3569"><span class="linenos">3569</span></a>				<span class="k">if</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3570"><a href="#L-3570"><span class="linenos">3570</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">)</span>
</span><span id="L-3571"><a href="#L-3571"><span class="linenos">3571</span></a>					<span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">last_flight</span>
</span><span id="L-3572"><a href="#L-3572"><span class="linenos">3572</span></a>
</span><span id="L-3573"><a href="#L-3573"><span class="linenos">3573</span></a>				<span class="n">transfer_cost</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="L-3574"><a href="#L-3574"><span class="linenos">3574</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">transfer_cost</span><span class="p">,</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">)</span>
</span><span id="L-3575"><a href="#L-3575"><span class="linenos">3575</span></a>
</span><span id="L-3576"><a href="#L-3576"><span class="linenos">3576</span></a>				<span class="k">if</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="L-3577"><a href="#L-3577"><span class="linenos">3577</span></a>					<span class="k">break</span>
</span><span id="L-3578"><a href="#L-3578"><span class="linenos">3578</span></a>
</span><span id="L-3579"><a href="#L-3579"><span class="linenos">3579</span></a>		<span class="c1"># If some passengers are remaining, maybe they could be reallocated in</span>
</span><span id="L-3580"><a href="#L-3580"><span class="linenos">3580</span></a>		<span class="c1"># further, so redo a round</span>
</span><span id="L-3581"><a href="#L-3581"><span class="linenos">3581</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="L-3582"><a href="#L-3582"><span class="linenos">3582</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;No more capacity for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;, so&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;retries a complete recomputation of itineraries&#39;</span><span class="p">)</span>
</span><span id="L-3583"><a href="#L-3583"><span class="linenos">3583</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">([</span><span class="n">pax</span><span class="p">])</span>
</span><span id="L-3584"><a href="#L-3584"><span class="linenos">3584</span></a>
</span><span id="L-3585"><a href="#L-3585"><span class="linenos">3585</span></a>	<span class="k">def</span> <span class="nf">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3586"><a href="#L-3586"><span class="linenos">3586</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;removes&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;boarding list&#39;</span><span class="p">)</span>
</span><span id="L-3587"><a href="#L-3587"><span class="linenos">3587</span></a>		<span class="c1"># aprint(self.agent.aoc_flights_info[flight_uid][&#39;push_back_event&#39;].triggered)</span>
</span><span id="L-3588"><a href="#L-3588"><span class="linenos">3588</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3589"><a href="#L-3589"><span class="linenos">3589</span></a>
</span><span id="L-3590"><a href="#L-3590"><span class="linenos">3590</span></a>	<span class="k">def</span> <span class="nf">_reallocate_pax_to_itinerary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-3591"><a href="#L-3591"><span class="linenos">3591</span></a>		<span class="c1"># Take out aoc_uids from itinerary</span>
</span><span id="L-3592"><a href="#L-3592"><span class="linenos">3592</span></a>		<span class="n">itinerary_flights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">itinerary</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3593"><a href="#L-3593"><span class="linenos">3593</span></a>
</span><span id="L-3594"><a href="#L-3594"><span class="linenos">3594</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is reallocating&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;to itinerary&#39;</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3595"><a href="#L-3595"><span class="linenos">3595</span></a>
</span><span id="L-3596"><a href="#L-3596"><span class="linenos">3596</span></a>		<span class="c1"># Reallocate pax to option</span>
</span><span id="L-3597"><a href="#L-3597"><span class="linenos">3597</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># to make sure that they don&#39;t miss the new flight</span>
</span><span id="L-3598"><a href="#L-3598"><span class="linenos">3598</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">copy</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)]</span>
</span><span id="L-3599"><a href="#L-3599"><span class="linenos">3599</span></a>
</span><span id="L-3600"><a href="#L-3600"><span class="linenos">3600</span></a>		<span class="c1"># Remove passengers from boarding listing of flights in old itinerary</span>
</span><span id="L-3601"><a href="#L-3601"><span class="linenos">3601</span></a>		<span class="c1"># which have not departed already.</span>
</span><span id="L-3602"><a href="#L-3602"><span class="linenos">3602</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
</span><span id="L-3603"><a href="#L-3603"><span class="linenos">3603</span></a>			<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flights</span><span class="p">():</span>
</span><span id="L-3604"><a href="#L-3604"><span class="linenos">3604</span></a>				<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-3605"><a href="#L-3605"><span class="linenos">3605</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;local boarding list removal for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3606"><a href="#L-3606"><span class="linenos">3606</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3607"><a href="#L-3607"><span class="linenos">3607</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3608"><a href="#L-3608"><span class="linenos">3608</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3609"><a href="#L-3609"><span class="linenos">3609</span></a>
</span><span id="L-3610"><a href="#L-3610"><span class="linenos">3610</span></a>		<span class="c1"># aprint(&#39;old itinerary:&#39;, pax.itinerary)</span>
</span><span id="L-3611"><a href="#L-3611"><span class="linenos">3611</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary_from_last_flight</span><span class="p">(</span><span class="n">itinerary_flights</span><span class="p">)</span>
</span><span id="L-3612"><a href="#L-3612"><span class="linenos">3612</span></a>
</span><span id="L-3613"><a href="#L-3613"><span class="linenos">3613</span></a>		<span class="c1"># aprint(&#39;DEBUG&#39;, &#39;new itinerary:&#39;, list(pax.itinerary[:pax.idx_current_flight]) + list(itinerary_flights))</span>
</span><span id="L-3614"><a href="#L-3614"><span class="linenos">3614</span></a>
</span><span id="L-3615"><a href="#L-3615"><span class="linenos">3615</span></a>		<span class="c1"># pax.active_flight = itinerary_flights[0]</span>
</span><span id="L-3616"><a href="#L-3616"><span class="linenos">3616</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="L-3617"><a href="#L-3617"><span class="linenos">3617</span></a>
</span><span id="L-3618"><a href="#L-3618"><span class="linenos">3618</span></a>		<span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid</span> <span class="ow">in</span> <span class="n">itinerary</span><span class="p">:</span>
</span><span id="L-3619"><a href="#L-3619"><span class="linenos">3619</span></a>			<span class="k">if</span> <span class="n">aoc_uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
</span><span id="L-3620"><a href="#L-3620"><span class="linenos">3620</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;local boarding list addition for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3621"><a href="#L-3621"><span class="linenos">3621</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_add_pax_to_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3622"><a href="#L-3622"><span class="linenos">3622</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-3623"><a href="#L-3623"><span class="linenos">3623</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_allocation_pax_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3624"><a href="#L-3624"><span class="linenos">3624</span></a>
</span><span id="L-3625"><a href="#L-3625"><span class="linenos">3625</span></a>	<span class="k">def</span> <span class="nf">_add_pax_to_boarding_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3626"><a href="#L-3626"><span class="linenos">3626</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;adds&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;to boarding list of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3627"><a href="#L-3627"><span class="linenos">3627</span></a>		<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-3628"><a href="#L-3628"><span class="linenos">3628</span></a>				<span class="s1">&#39;pax to board before (capacity is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3629"><a href="#L-3629"><span class="linenos">3629</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3630"><a href="#L-3630"><span class="linenos">3630</span></a>		<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-3631"><a href="#L-3631"><span class="linenos">3631</span></a>				<span class="s1">&#39;pax to board after (capacity is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3632"><a href="#L-3632"><span class="linenos">3632</span></a>		<span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;n_pax_to_board&#39;] += pax.n_pax</span>
</span><span id="L-3633"><a href="#L-3633"><span class="linenos">3633</span></a>
</span><span id="L-3634"><a href="#L-3634"><span class="linenos">3634</span></a>	<span class="k">def</span> <span class="nf">send_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3635"><a href="#L-3635"><span class="linenos">3635</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3636"><a href="#L-3636"><span class="linenos">3636</span></a><span class="sd">		Used to ask another airline to put a pax group on the list of</span>
</span><span id="L-3637"><a href="#L-3637"><span class="linenos">3637</span></a><span class="sd">		pax to board.</span>
</span><span id="L-3638"><a href="#L-3638"><span class="linenos">3638</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3639"><a href="#L-3639"><span class="linenos">3639</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3640"><a href="#L-3640"><span class="linenos">3640</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="L-3641"><a href="#L-3641"><span class="linenos">3641</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;allocation_pax_request&#39;</span>
</span><span id="L-3642"><a href="#L-3642"><span class="linenos">3642</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-3643"><a href="#L-3643"><span class="linenos">3643</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="L-3644"><a href="#L-3644"><span class="linenos">3644</span></a>
</span><span id="L-3645"><a href="#L-3645"><span class="linenos">3645</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3646"><a href="#L-3646"><span class="linenos">3646</span></a>
</span><span id="L-3647"><a href="#L-3647"><span class="linenos">3647</span></a>	<span class="k">def</span> <span class="nf">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3648"><a href="#L-3648"><span class="linenos">3648</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;sends a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="L-3649"><a href="#L-3649"><span class="linenos">3649</span></a>				<span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;to airline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3650"><a href="#L-3650"><span class="linenos">3650</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3651"><a href="#L-3651"><span class="linenos">3651</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>  <span class="c1"># self.agent.itinerary_provider_uid</span>
</span><span id="L-3652"><a href="#L-3652"><span class="linenos">3652</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span>
</span><span id="L-3653"><a href="#L-3653"><span class="linenos">3653</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="L-3654"><a href="#L-3654"><span class="linenos">3654</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-3655"><a href="#L-3655"><span class="linenos">3655</span></a>
</span><span id="L-3656"><a href="#L-3656"><span class="linenos">3656</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3657"><a href="#L-3657"><span class="linenos">3657</span></a>
</span><span id="L-3658"><a href="#L-3658"><span class="linenos">3658</span></a>	<span class="k">def</span> <span class="nf">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-3659"><a href="#L-3659"><span class="linenos">3659</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3660"><a href="#L-3660"><span class="linenos">3660</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="L-3661"><a href="#L-3661"><span class="linenos">3661</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3662"><a href="#L-3662"><span class="linenos">3662</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="L-3663"><a href="#L-3663"><span class="linenos">3663</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="L-3664"><a href="#L-3664"><span class="linenos">3664</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Old itineraries of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="L-3665"><a href="#L-3665"><span class="linenos">3665</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Newest itinerary of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="L-3666"><a href="#L-3666"><span class="linenos">3666</span></a>
</span><span id="L-3667"><a href="#L-3667"><span class="linenos">3667</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="L-3668"><a href="#L-3668"><span class="linenos">3668</span></a>		<span class="c1"># self.agent.env.process(self._remove_pax_from_boarding_list(msg[&#39;body&#39;][&#39;pax&#39;], msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="L-3669"><a href="#L-3669"><span class="linenos">3669</span></a>
</span><span id="L-3670"><a href="#L-3670"><span class="linenos">3670</span></a>	<span class="k">def</span> <span class="nf">wait_for_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-3671"><a href="#L-3671"><span class="linenos">3671</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3672"><a href="#L-3672"><span class="linenos">3672</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="L-3673"><a href="#L-3673"><span class="linenos">3673</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3674"><a href="#L-3674"><span class="linenos">3674</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_add_pax_to_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="L-3675"><a href="#L-3675"><span class="linenos">3675</span></a>
</span><span id="L-3676"><a href="#L-3676"><span class="linenos">3676</span></a>	<span class="k">def</span> <span class="nf">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-3677"><a href="#L-3677"><span class="linenos">3677</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3678"><a href="#L-3678"><span class="linenos">3678</span></a><span class="sd">		Note: ok with creating a process here? ANSWER: PROBABLY.</span>
</span><span id="L-3679"><a href="#L-3679"><span class="linenos">3679</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3680"><a href="#L-3680"><span class="linenos">3680</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from wait_for_reallocation_pax_request for paxs:&#39;</span><span class="p">,</span>
</span><span id="L-3681"><a href="#L-3681"><span class="linenos">3681</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3682"><a href="#L-3682"><span class="linenos">3682</span></a>		<span class="c1"># self.agent.env.process(self.do_reallocation(msg[&#39;body&#39;][&#39;paxs&#39;]))</span>
</span><span id="L-3683"><a href="#L-3683"><span class="linenos">3683</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="L-3684"><a href="#L-3684"><span class="linenos">3684</span></a>
</span><span id="L-3685"><a href="#L-3685"><span class="linenos">3685</span></a>
</span><span id="L-3686"><a href="#L-3686"><span class="linenos">3686</span></a><span class="k">class</span> <span class="nc">TurnaroundOperations</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-3687"><a href="#L-3687"><span class="linenos">3687</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3688"><a href="#L-3688"><span class="linenos">3688</span></a><span class="sd">	TRO</span>
</span><span id="L-3689"><a href="#L-3689"><span class="linenos">3689</span></a>
</span><span id="L-3690"><a href="#L-3690"><span class="linenos">3690</span></a><span class="sd">	Description: When a flight arrives to the gate computes the turnaround time required, generates the ready to depart time of the subsequent flight.</span>
</span><span id="L-3691"><a href="#L-3691"><span class="linenos">3691</span></a>
</span><span id="L-3692"><a href="#L-3692"><span class="linenos">3692</span></a><span class="sd">	1. Reallocate passengers of arriving flight if needed</span>
</span><span id="L-3693"><a href="#L-3693"><span class="linenos">3693</span></a><span class="sd">	2. Computes the turnaround time.</span>
</span><span id="L-3694"><a href="#L-3694"><span class="linenos">3694</span></a><span class="sd">	3. Computes delay due to non-ATFM causes</span>
</span><span id="L-3695"><a href="#L-3695"><span class="linenos">3695</span></a><span class="sd">	4. Updates the EOBT</span>
</span><span id="L-3696"><a href="#L-3696"><span class="linenos">3696</span></a><span class="sd">	5. Requests reassessment of flight departure in case extra delay has been incurred</span>
</span><span id="L-3697"><a href="#L-3697"><span class="linenos">3697</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-3698"><a href="#L-3698"><span class="linenos">3698</span></a>
</span><span id="L-3699"><a href="#L-3699"><span class="linenos">3699</span></a>	<span class="k">def</span> <span class="nf">check_arrival</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">arrival_event</span><span class="p">):</span>
</span><span id="L-3700"><a href="#L-3700"><span class="linenos">3700</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3701"><a href="#L-3701"><span class="linenos">3701</span></a><span class="sd">		Note: keep the aircraft release at the end of this method to make sure</span>
</span><span id="L-3702"><a href="#L-3702"><span class="linenos">3702</span></a><span class="sd">		that EOBT is updated before.</span>
</span><span id="L-3703"><a href="#L-3703"><span class="linenos">3703</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3704"><a href="#L-3704"><span class="linenos">3704</span></a>
</span><span id="L-3705"><a href="#L-3705"><span class="linenos">3705</span></a>		<span class="c1"># aprint(&quot;Waiting arrival event for &quot;, flight_str(flight_uid), &quot;:&quot;, arrival_event)</span>
</span><span id="L-3706"><a href="#L-3706"><span class="linenos">3706</span></a>		<span class="k">yield</span> <span class="n">arrival_event</span>
</span><span id="L-3707"><a href="#L-3707"><span class="linenos">3707</span></a>		<span class="c1"># aprint(&quot;Arrival event for &quot;, flight_str(flight_uid), &quot;triggered&quot;)</span>
</span><span id="L-3708"><a href="#L-3708"><span class="linenos">3708</span></a>
</span><span id="L-3709"><a href="#L-3709"><span class="linenos">3709</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_arrival&#39;</span><span class="p">):</span>
</span><span id="L-3710"><a href="#L-3710"><span class="linenos">3710</span></a>			<span class="c1"># Mark the real arrival time</span>
</span><span id="L-3711"><a href="#L-3711"><span class="linenos">3711</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aibt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
</span><span id="L-3712"><a href="#L-3712"><span class="linenos">3712</span></a>
</span><span id="L-3713"><a href="#L-3713"><span class="linenos">3713</span></a>			<span class="c1"># Take care of pax</span>
</span><span id="L-3714"><a href="#L-3714"><span class="linenos">3714</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_process_arrival_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3715"><a href="#L-3715"><span class="linenos">3715</span></a>
</span><span id="L-3716"><a href="#L-3716"><span class="linenos">3716</span></a>			<span class="c1"># Take care of aircraft</span>
</span><span id="L-3717"><a href="#L-3717"><span class="linenos">3717</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">process_following_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3718"><a href="#L-3718"><span class="linenos">3718</span></a>
</span><span id="L-3719"><a href="#L-3719"><span class="linenos">3719</span></a>	<span class="k">def</span> <span class="nf">check_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">delay_estimation_event</span><span class="p">):</span>
</span><span id="L-3720"><a href="#L-3720"><span class="linenos">3720</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3721"><a href="#L-3721"><span class="linenos">3721</span></a><span class="sd">		This, in theory, should happen only exactly 60 minutes before most up to date EOBT.</span>
</span><span id="L-3722"><a href="#L-3722"><span class="linenos">3722</span></a><span class="sd">		Delay is added to the current now + 60 minutes,</span>
</span><span id="L-3723"><a href="#L-3723"><span class="linenos">3723</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3724"><a href="#L-3724"><span class="linenos">3724</span></a>		<span class="k">yield</span> <span class="n">delay_estimation_event</span>
</span><span id="L-3725"><a href="#L-3725"><span class="linenos">3725</span></a>
</span><span id="L-3726"><a href="#L-3726"><span class="linenos">3726</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3727"><a href="#L-3727"><span class="linenos">3727</span></a>		<span class="c1"># 	print(&quot;{} checks estimates additional delay for flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="L-3728"><a href="#L-3728"><span class="linenos">3728</span></a>
</span><span id="L-3729"><a href="#L-3729"><span class="linenos">3729</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_delay_estimation&#39;</span><span class="p">):</span>
</span><span id="L-3730"><a href="#L-3730"><span class="linenos">3730</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">p_cancellation</span><span class="p">:</span>
</span><span id="L-3731"><a href="#L-3731"><span class="linenos">3731</span></a>				<span class="n">non_atfm_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="p">)</span>
</span><span id="L-3732"><a href="#L-3732"><span class="linenos">3732</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Computing non-ATFM delay for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">non_atfm_delay</span><span class="p">,</span> <span class="s1">&#39;at time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3733"><a href="#L-3733"><span class="linenos">3733</span></a>
</span><span id="L-3734"><a href="#L-3734"><span class="linenos">3734</span></a>				<span class="c1"># Keep the non-atfm delay in memory for liability</span>
</span><span id="L-3735"><a href="#L-3735"><span class="linenos">3735</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_atfm_delay</span>
</span><span id="L-3736"><a href="#L-3736"><span class="linenos">3736</span></a>
</span><span id="L-3737"><a href="#L-3737"><span class="linenos">3737</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-3738"><a href="#L-3738"><span class="linenos">3738</span></a>				<span class="c1"># if aircraft.idx_current_flight==0:</span>
</span><span id="L-3739"><a href="#L-3739"><span class="linenos">3739</span></a>				<span class="c1"># If flight first of the day with this aircraft</span>
</span><span id="L-3740"><a href="#L-3740"><span class="linenos">3740</span></a>				<span class="c1"># aprint(&#39;Requesting turnaround time for&#39;, flight_str(flight_uid), &#39;(first of the day)&#39;)</span>
</span><span id="L-3741"><a href="#L-3741"><span class="linenos">3741</span></a>				<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span> <span class="o">+</span> <span class="n">non_atfm_delay</span>
</span><span id="L-3742"><a href="#L-3742"><span class="linenos">3742</span></a>
</span><span id="L-3743"><a href="#L-3743"><span class="linenos">3743</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3744"><a href="#L-3744"><span class="linenos">3744</span></a>				<span class="c1"># 	print(&quot;{} requests a departing reassessment for flight {} after the delay check estimation&quot;.format(self.agent, flight_uid))</span>
</span><span id="L-3745"><a href="#L-3745"><span class="linenos">3745</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-3746"><a href="#L-3746"><span class="linenos">3746</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-3747"><a href="#L-3747"><span class="linenos">3747</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;CANCEL&quot;</span><span class="p">)</span>
</span><span id="L-3748"><a href="#L-3748"><span class="linenos">3748</span></a>
</span><span id="L-3749"><a href="#L-3749"><span class="linenos">3749</span></a>	<span class="k">def</span> <span class="nf">process_following_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3750"><a href="#L-3750"><span class="linenos">3750</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="L-3751"><a href="#L-3751"><span class="linenos">3751</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="L-3752"><a href="#L-3752"><span class="linenos">3752</span></a>
</span><span id="L-3753"><a href="#L-3753"><span class="linenos">3753</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;checks if there is a next flight after&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3754"><a href="#L-3754"><span class="linenos">3754</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">FP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-3755"><a href="#L-3755"><span class="linenos">3755</span></a>			<span class="c1"># Compute delays and cost of delays</span>
</span><span id="L-3756"><a href="#L-3756"><span class="linenos">3756</span></a>			<span class="c1"># Compute delay spent at gate</span>
</span><span id="L-3757"><a href="#L-3757"><span class="linenos">3757</span></a>			<span class="n">delay_at_gate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">sobt</span><span class="p">)</span>
</span><span id="L-3758"><a href="#L-3758"><span class="linenos">3758</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_at_gate</span><span class="p">,</span> <span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="L-3759"><a href="#L-3759"><span class="linenos">3759</span></a>
</span><span id="L-3760"><a href="#L-3760"><span class="linenos">3760</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="L-3761"><a href="#L-3761"><span class="linenos">3761</span></a>
</span><span id="L-3762"><a href="#L-3762"><span class="linenos">3762</span></a>			<span class="c1"># sch_taxi_duration = FP.points[&#39;takeoff&#39;].time_min - FP.sobt</span>
</span><span id="L-3763"><a href="#L-3763"><span class="linenos">3763</span></a>			<span class="c1"># actual_taxi_duration = FP.points_executed[&#39;takeoff&#39;].time_min - FP.aobt</span>
</span><span id="L-3764"><a href="#L-3764"><span class="linenos">3764</span></a>			<span class="c1"># delay_taxi = actual_taxi_duration - sch_taxi_duration</span>
</span><span id="L-3765"><a href="#L-3765"><span class="linenos">3765</span></a>			<span class="c1"># delay_taxi = 0</span>
</span><span id="L-3766"><a href="#L-3766"><span class="linenos">3766</span></a>			<span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;non_pax_cost&#39;] += self.agent.non_pax_cost(aircraft, delay_taxi, &#39;taxi&#39;)</span>
</span><span id="L-3767"><a href="#L-3767"><span class="linenos">3767</span></a>
</span><span id="L-3768"><a href="#L-3768"><span class="linenos">3768</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="L-3769"><a href="#L-3769"><span class="linenos">3769</span></a>			<span class="n">sch_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;landing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;takeoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="L-3770"><a href="#L-3770"><span class="linenos">3770</span></a>			<span class="n">actual_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="L-3771"><a href="#L-3771"><span class="linenos">3771</span></a>			<span class="n">delay_airborne</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">actual_air_duration</span> <span class="o">-</span> <span class="n">sch_air_duration</span><span class="p">)</span>
</span><span id="L-3772"><a href="#L-3772"><span class="linenos">3772</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_airborne</span><span class="p">,</span> <span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="L-3773"><a href="#L-3773"><span class="linenos">3773</span></a>
</span><span id="L-3774"><a href="#L-3774"><span class="linenos">3774</span></a>		<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="L-3775"><a href="#L-3775"><span class="linenos">3775</span></a>
</span><span id="L-3776"><a href="#L-3776"><span class="linenos">3776</span></a>		<span class="k">if</span> <span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3777"><a href="#L-3777"><span class="linenos">3777</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3778"><a href="#L-3778"><span class="linenos">3778</span></a>			<span class="c1"># 	print(&quot;{} request turnaround time for aircraft {} after flight {} and before flight {}&quot;.format(self.agent, aircraft, flight_uid, next_flight_uid))</span>
</span><span id="L-3779"><a href="#L-3779"><span class="linenos">3779</span></a>			<span class="c1"># There is a next flight with this aircraft</span>
</span><span id="L-3780"><a href="#L-3780"><span class="linenos">3780</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;requests turnaround operations for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;and before flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">))</span>
</span><span id="L-3781"><a href="#L-3781"><span class="linenos">3781</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_turnaround</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">)</span>
</span><span id="L-3782"><a href="#L-3782"><span class="linenos">3782</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3783"><a href="#L-3783"><span class="linenos">3783</span></a>			<span class="c1"># Flight was the last one of the day for the aircraft</span>
</span><span id="L-3784"><a href="#L-3784"><span class="linenos">3784</span></a>			<span class="c1"># Release resource to clean queue</span>
</span><span id="L-3785"><a href="#L-3785"><span class="linenos">3785</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;: there is no more flight for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3786"><a href="#L-3786"><span class="linenos">3786</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-3787"><a href="#L-3787"><span class="linenos">3787</span></a>
</span><span id="L-3788"><a href="#L-3788"><span class="linenos">3788</span></a>	<span class="k">def</span> <span class="nf">request_process_arrival_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3789"><a href="#L-3789"><span class="linenos">3789</span></a>		<span class="c1"># This is an internal message</span>
</span><span id="L-3790"><a href="#L-3790"><span class="linenos">3790</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3791"><a href="#L-3791"><span class="linenos">3791</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-3792"><a href="#L-3792"><span class="linenos">3792</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span>
</span><span id="L-3793"><a href="#L-3793"><span class="linenos">3793</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="L-3794"><a href="#L-3794"><span class="linenos">3794</span></a>
</span><span id="L-3795"><a href="#L-3795"><span class="linenos">3795</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3796"><a href="#L-3796"><span class="linenos">3796</span></a>
</span><span id="L-3797"><a href="#L-3797"><span class="linenos">3797</span></a>		<span class="c1"># self.send(msg) # uncomment this to use messaging server</span>
</span><span id="L-3798"><a href="#L-3798"><span class="linenos">3798</span></a>
</span><span id="L-3799"><a href="#L-3799"><span class="linenos">3799</span></a>	<span class="k">def</span> <span class="nf">request_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="n">last_flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">):</span>
</span><span id="L-3800"><a href="#L-3800"><span class="linenos">3800</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3801"><a href="#L-3801"><span class="linenos">3801</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;turnaround_request&#39;</span>
</span><span id="L-3802"><a href="#L-3802"><span class="linenos">3802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">last_flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-3803"><a href="#L-3803"><span class="linenos">3803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="n">aircraft</span><span class="p">,</span>
</span><span id="L-3804"><a href="#L-3804"><span class="linenos">3804</span></a>						<span class="s1">&#39;ao_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">airline_type</span><span class="p">,</span>
</span><span id="L-3805"><a href="#L-3805"><span class="linenos">3805</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">next_flight_uid</span>
</span><span id="L-3806"><a href="#L-3806"><span class="linenos">3806</span></a>						<span class="p">}</span>
</span><span id="L-3807"><a href="#L-3807"><span class="linenos">3807</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3808"><a href="#L-3808"><span class="linenos">3808</span></a>
</span><span id="L-3809"><a href="#L-3809"><span class="linenos">3809</span></a>	<span class="k">def</span> <span class="nf">request_departing_reassessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="L-3810"><a href="#L-3810"><span class="linenos">3810</span></a>		<span class="c1"># Internal message.</span>
</span><span id="L-3811"><a href="#L-3811"><span class="linenos">3811</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-3812"><a href="#L-3812"><span class="linenos">3812</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;departing_reassessment_request&#39;</span>
</span><span id="L-3813"><a href="#L-3813"><span class="linenos">3813</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-3814"><a href="#L-3814"><span class="linenos">3814</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-3815"><a href="#L-3815"><span class="linenos">3815</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-3816"><a href="#L-3816"><span class="linenos">3816</span></a>						<span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">:</span> <span class="n">ac_ready_at_time</span><span class="p">}</span>
</span><span id="L-3817"><a href="#L-3817"><span class="linenos">3817</span></a>
</span><span id="L-3818"><a href="#L-3818"><span class="linenos">3818</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-3819"><a href="#L-3819"><span class="linenos">3819</span></a>
</span><span id="L-3820"><a href="#L-3820"><span class="linenos">3820</span></a>		<span class="c1"># Uncomment the following line if you want to use the central messaging server.</span>
</span><span id="L-3821"><a href="#L-3821"><span class="linenos">3821</span></a>		<span class="c1"># self.send(msg)</span>
</span><span id="L-3822"><a href="#L-3822"><span class="linenos">3822</span></a>
</span><span id="L-3823"><a href="#L-3823"><span class="linenos">3823</span></a>	<span class="k">def</span> <span class="nf">wait_for_turnaround_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-3824"><a href="#L-3824"><span class="linenos">3824</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives turnaround time for flight&#39;</span><span class="p">,</span>
</span><span id="L-3825"><a href="#L-3825"><span class="linenos">3825</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">],</span>
</span><span id="L-3826"><a href="#L-3826"><span class="linenos">3826</span></a>				<span class="s1">&#39;at time t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="L-3827"><a href="#L-3827"><span class="linenos">3827</span></a>
</span><span id="L-3828"><a href="#L-3828"><span class="linenos">3828</span></a>		<span class="n">flight_uid</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">]</span>
</span><span id="L-3829"><a href="#L-3829"><span class="linenos">3829</span></a>
</span><span id="L-3830"><a href="#L-3830"><span class="linenos">3830</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3831"><a href="#L-3831"><span class="linenos">3831</span></a>		<span class="c1"># 	print(&quot;{} received turnaround time for flight {}: {} (t={})&quot;.format(self.agent, flight_uid, tt, self.agent.env.now))</span>
</span><span id="L-3832"><a href="#L-3832"><span class="linenos">3832</span></a>
</span><span id="L-3833"><a href="#L-3833"><span class="linenos">3833</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">tt</span>
</span><span id="L-3834"><a href="#L-3834"><span class="linenos">3834</span></a>
</span><span id="L-3835"><a href="#L-3835"><span class="linenos">3835</span></a>		<span class="c1"># print(ac_ready_at_time, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].bada_code_ac_model)</span>
</span><span id="L-3836"><a href="#L-3836"><span class="linenos">3836</span></a>
</span><span id="L-3837"><a href="#L-3837"><span class="linenos">3837</span></a>		<span class="n">reactionar_del</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="L-3838"><a href="#L-3838"><span class="linenos">3838</span></a>
</span><span id="L-3839"><a href="#L-3839"><span class="linenos">3839</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3840"><a href="#L-3840"><span class="linenos">3840</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="L-3841"><a href="#L-3841"><span class="linenos">3841</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac_ready_at_time</span>
</span><span id="L-3842"><a href="#L-3842"><span class="linenos">3842</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3843"><a href="#L-3843"><span class="linenos">3843</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="L-3844"><a href="#L-3844"><span class="linenos">3844</span></a>
</span><span id="L-3845"><a href="#L-3845"><span class="linenos">3845</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft will be ready for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span>
</span><span id="L-3846"><a href="#L-3846"><span class="linenos">3846</span></a>				<span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-3847"><a href="#L-3847"><span class="linenos">3847</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Flight has&#39;</span><span class="p">,</span> <span class="n">reactionar_del</span><span class="p">,</span> <span class="s1">&#39;of reactionary_delay.&#39;</span><span class="p">)</span>
</span><span id="L-3848"><a href="#L-3848"><span class="linenos">3848</span></a>
</span><span id="L-3849"><a href="#L-3849"><span class="linenos">3849</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="L-3850"><a href="#L-3850"><span class="linenos">3850</span></a>		<span class="c1"># 	print(&quot;{} requests departing reassessment for flight {} with ac_ready_at_time {}&quot;.format(self.agent, flight_uid, ac_ready_at_time))</span>
</span><span id="L-3851"><a href="#L-3851"><span class="linenos">3851</span></a>
</span><span id="L-3852"><a href="#L-3852"><span class="linenos">3852</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="L-3853"><a href="#L-3853"><span class="linenos">3853</span></a>
</span><span id="L-3854"><a href="#L-3854"><span class="linenos">3854</span></a>
</span><span id="L-3855"><a href="#L-3855"><span class="linenos">3855</span></a><span class="k">class</span> <span class="nc">AirlinePaxHandler</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="L-3856"><a href="#L-3856"><span class="linenos">3856</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3857"><a href="#L-3857"><span class="linenos">3857</span></a><span class="sd">	APH</span>
</span><span id="L-3858"><a href="#L-3858"><span class="linenos">3858</span></a>
</span><span id="L-3859"><a href="#L-3859"><span class="linenos">3859</span></a><span class="sd">	Description: When a flight arrives direct passengers to connecting flights. All passengers connecting to flight that have already left are requested to be rebooked.</span>
</span><span id="L-3860"><a href="#L-3860"><span class="linenos">3860</span></a>
</span><span id="L-3861"><a href="#L-3861"><span class="linenos">3861</span></a><span class="sd">	Added from D4.1 description:</span>
</span><span id="L-3862"><a href="#L-3862"><span class="linenos">3862</span></a><span class="sd">	Embark passengers ready to be embarked.</span>
</span><span id="L-3863"><a href="#L-3863"><span class="linenos">3863</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="L-3864"><a href="#L-3864"><span class="linenos">3864</span></a>
</span><span id="L-3865"><a href="#L-3865"><span class="linenos">3865</span></a>	<span class="k">def</span> <span class="nf">_assume_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">):</span>
</span><span id="L-3866"><a href="#L-3866"><span class="linenos">3866</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;pays&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3867"><a href="#L-3867"><span class="linenos">3867</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="n">cost_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cost</span>
</span><span id="L-3868"><a href="#L-3868"><span class="linenos">3868</span></a>
</span><span id="L-3869"><a href="#L-3869"><span class="linenos">3869</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="L-3870"><a href="#L-3870"><span class="linenos">3870</span></a>		<span class="c1"># Added from D4.1</span>
</span><span id="L-3871"><a href="#L-3871"><span class="linenos">3871</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="L-3872"><a href="#L-3872"><span class="linenos">3872</span></a>
</span><span id="L-3873"><a href="#L-3873"><span class="linenos">3873</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="L-3874"><a href="#L-3874"><span class="linenos">3874</span></a>			<span class="c1"># Compute main cause of delays</span>
</span><span id="L-3875"><a href="#L-3875"><span class="linenos">3875</span></a>			<span class="c1"># Non-ATFM</span>
</span><span id="L-3876"><a href="#L-3876"><span class="linenos">3876</span></a>			<span class="n">delay_non_atfm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="L-3877"><a href="#L-3877"><span class="linenos">3877</span></a>
</span><span id="L-3878"><a href="#L-3878"><span class="linenos">3878</span></a>			<span class="c1"># ATFM</span>
</span><span id="L-3879"><a href="#L-3879"><span class="linenos">3879</span></a>			<span class="n">delay_ATFM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">()</span>
</span><span id="L-3880"><a href="#L-3880"><span class="linenos">3880</span></a>
</span><span id="L-3881"><a href="#L-3881"><span class="linenos">3881</span></a>			<span class="c1"># Reactionary delay</span>
</span><span id="L-3882"><a href="#L-3882"><span class="linenos">3882</span></a>			<span class="n">delay_reac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span>
</span><span id="L-3883"><a href="#L-3883"><span class="linenos">3883</span></a>
</span><span id="L-3884"><a href="#L-3884"><span class="linenos">3884</span></a>			<span class="k">if</span> <span class="n">delay_non_atfm</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_ATFM</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_reac</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="L-3885"><a href="#L-3885"><span class="linenos">3885</span></a>				<span class="c1"># Find out the biggest delay</span>
</span><span id="L-3886"><a href="#L-3886"><span class="linenos">3886</span></a>				<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="L-3887"><a href="#L-3887"><span class="linenos">3887</span></a>
</span><span id="L-3888"><a href="#L-3888"><span class="linenos">3888</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;finds its biggest delay among:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="L-3889"><a href="#L-3889"><span class="linenos">3889</span></a>
</span><span id="L-3890"><a href="#L-3890"><span class="linenos">3890</span></a>				<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3891"><a href="#L-3891"><span class="linenos">3891</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TA&#39;</span>  <span class="c1"># for turnaround</span>
</span><span id="L-3892"><a href="#L-3892"><span class="linenos">3892</span></a>				<span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-3893"><a href="#L-3893"><span class="linenos">3893</span></a>					<span class="c1"># if not self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay is None:</span>
</span><span id="L-3894"><a href="#L-3894"><span class="linenos">3894</span></a>					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="L-3895"><a href="#L-3895"><span class="linenos">3895</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
</span><span id="L-3896"><a href="#L-3896"><span class="linenos">3896</span></a>					<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;C_AP&#39;</span><span class="p">:</span>
</span><span id="L-3897"><a href="#L-3897"><span class="linenos">3897</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
</span><span id="L-3898"><a href="#L-3898"><span class="linenos">3898</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="L-3899"><a href="#L-3899"><span class="linenos">3899</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ER&#39;</span>  <span class="c1"># for en-route</span>
</span><span id="L-3900"><a href="#L-3900"><span class="linenos">3900</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-3901"><a href="#L-3901"><span class="linenos">3901</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RD&#39;</span>  <span class="c1"># for reactionary delay</span>
</span><span id="L-3902"><a href="#L-3902"><span class="linenos">3902</span></a>
</span><span id="L-3903"><a href="#L-3903"><span class="linenos">3903</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">board_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-3904"><a href="#L-3904"><span class="linenos">3904</span></a>
</span><span id="L-3905"><a href="#L-3905"><span class="linenos">3905</span></a>	<span class="k">def</span> <span class="nf">check_delay_liability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-3906"><a href="#L-3906"><span class="linenos">3906</span></a>		<span class="k">if</span> <span class="n">current_flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3907"><a href="#L-3907"><span class="linenos">3907</span></a>			<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="L-3908"><a href="#L-3908"><span class="linenos">3908</span></a>
</span><span id="L-3909"><a href="#L-3909"><span class="linenos">3909</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TA&#39;</span><span class="p">:</span>
</span><span id="L-3910"><a href="#L-3910"><span class="linenos">3910</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3911"><a href="#L-3911"><span class="linenos">3911</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3912"><a href="#L-3912"><span class="linenos">3912</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="L-3913"><a href="#L-3913"><span class="linenos">3913</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3914"><a href="#L-3914"><span class="linenos">3914</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3915"><a href="#L-3915"><span class="linenos">3915</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
</span><span id="L-3916"><a href="#L-3916"><span class="linenos">3916</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3917"><a href="#L-3917"><span class="linenos">3917</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3918"><a href="#L-3918"><span class="linenos">3918</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">:</span>
</span><span id="L-3919"><a href="#L-3919"><span class="linenos">3919</span></a>			<span class="c1"># pax.entitled = pax.reac_entitled</span>
</span><span id="L-3920"><a href="#L-3920"><span class="linenos">3920</span></a>			<span class="c1"># This could be better done by understanding the main reason for this flight to</span>
</span><span id="L-3921"><a href="#L-3921"><span class="linenos">3921</span></a>			<span class="c1"># be cancelled.</span>
</span><span id="L-3922"><a href="#L-3922"><span class="linenos">3922</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3923"><a href="#L-3923"><span class="linenos">3923</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3924"><a href="#L-3924"><span class="linenos">3924</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL&#39;</span><span class="p">:</span>
</span><span id="L-3925"><a href="#L-3925"><span class="linenos">3925</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3926"><a href="#L-3926"><span class="linenos">3926</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3927"><a href="#L-3927"><span class="linenos">3927</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3928"><a href="#L-3928"><span class="linenos">3928</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span>
</span><span id="L-3929"><a href="#L-3929"><span class="linenos">3929</span></a>
</span><span id="L-3930"><a href="#L-3930"><span class="linenos">3930</span></a>	<span class="k">def</span> <span class="nf">do_pax_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="L-3931"><a href="#L-3931"><span class="linenos">3931</span></a>		<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="L-3932"><a href="#L-3932"><span class="linenos">3932</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="L-3933"><a href="#L-3933"><span class="linenos">3933</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">+=</span> <span class="n">doc</span>
</span><span id="L-3934"><a href="#L-3934"><span class="linenos">3934</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;blames&#39;</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="p">,</span> <span class="s1">&#39;for the DOC cost:&#39;</span><span class="p">,</span>
</span><span id="L-3935"><a href="#L-3935"><span class="linenos">3935</span></a>				<span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3936"><a href="#L-3936"><span class="linenos">3936</span></a>
</span><span id="L-3937"><a href="#L-3937"><span class="linenos">3937</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;DOC&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="n">current_flight_uid</span><span class="p">)</span>
</span><span id="L-3938"><a href="#L-3938"><span class="linenos">3938</span></a>		<span class="c1"># if current_flight_uid in self.agent.own_flights():</span>
</span><span id="L-3939"><a href="#L-3939"><span class="linenos">3939</span></a>		<span class="c1">#     self.agent.aoc_flights_info[current_flight_uid][&#39;DOC&#39;] += doc</span>
</span><span id="L-3940"><a href="#L-3940"><span class="linenos">3940</span></a>		<span class="c1"># else:</span>
</span><span id="L-3941"><a href="#L-3941"><span class="linenos">3941</span></a>		<span class="c1">#     self.agent.aph.send_cost_blame(current_flight_uid, doc, &#39;DOC&#39;)</span>
</span><span id="L-3942"><a href="#L-3942"><span class="linenos">3942</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has been cared for (&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;euros in total) for a delay of &#39;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="L-3943"><a href="#L-3943"><span class="linenos">3943</span></a>
</span><span id="L-3944"><a href="#L-3944"><span class="linenos">3944</span></a>	<span class="k">def</span> <span class="nf">board_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="L-3945"><a href="#L-3945"><span class="linenos">3945</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3946"><a href="#L-3946"><span class="linenos">3946</span></a><span class="sd">		Note: added from D4.1</span>
</span><span id="L-3947"><a href="#L-3947"><span class="linenos">3947</span></a><span class="sd">		Note: duty of care is now given to passengers just before their boarding,</span>
</span><span id="L-3948"><a href="#L-3948"><span class="linenos">3948</span></a><span class="sd">		based on how much they waited to depart. Note that end of boarding</span>
</span><span id="L-3949"><a href="#L-3949"><span class="linenos">3949</span></a><span class="sd">		coincides with off-block, so we now exactly how long they waited up</span>
</span><span id="L-3950"><a href="#L-3950"><span class="linenos">3950</span></a><span class="sd">		until their real departure.</span>
</span><span id="L-3951"><a href="#L-3951"><span class="linenos">3951</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3952"><a href="#L-3952"><span class="linenos">3952</span></a>		<span class="n">pax_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-3953"><a href="#L-3953"><span class="linenos">3953</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax to board for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">])</span>
</span><span id="L-3954"><a href="#L-3954"><span class="linenos">3954</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="L-3955"><a href="#L-3955"><span class="linenos">3955</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span> <span class="ow">and</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">:</span>
</span><span id="L-3956"><a href="#L-3956"><span class="linenos">3956</span></a>				<span class="c1"># pax ready to board</span>
</span><span id="L-3957"><a href="#L-3957"><span class="linenos">3957</span></a>				<span class="n">pax_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3958"><a href="#L-3958"><span class="linenos">3958</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3959"><a href="#L-3959"><span class="linenos">3959</span></a>
</span><span id="L-3960"><a href="#L-3960"><span class="linenos">3960</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">board_next_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-3961"><a href="#L-3961"><span class="linenos">3961</span></a>
</span><span id="L-3962"><a href="#L-3962"><span class="linenos">3962</span></a>				<span class="c1"># Check duty of care</span>
</span><span id="L-3963"><a href="#L-3963"><span class="linenos">3963</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span>  <span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;]</span>
</span><span id="L-3964"><a href="#L-3964"><span class="linenos">3964</span></a>
</span><span id="L-3965"><a href="#L-3965"><span class="linenos">3965</span></a>				<span class="c1"># Do pax care</span>
</span><span id="L-3966"><a href="#L-3966"><span class="linenos">3966</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-3967"><a href="#L-3967"><span class="linenos">3967</span></a>
</span><span id="L-3968"><a href="#L-3968"><span class="linenos">3968</span></a>				<span class="c1"># Check for future compensation entitlement</span>
</span><span id="L-3969"><a href="#L-3969"><span class="linenos">3969</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3970"><a href="#L-3970"><span class="linenos">3970</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-3971"><a href="#L-3971"><span class="linenos">3971</span></a>				<span class="c1"># pax not ready to board</span>
</span><span id="L-3972"><a href="#L-3972"><span class="linenos">3972</span></a>				<span class="c1"># The passenger reallocation role picks them up and reallocate them</span>
</span><span id="L-3973"><a href="#L-3973"><span class="linenos">3973</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is not ready to board:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;; arrival time at gate:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span><span class="p">)</span>
</span><span id="L-3974"><a href="#L-3974"><span class="linenos">3974</span></a>				<span class="c1"># pax.idx_current_flight -= 1</span>
</span><span id="L-3975"><a href="#L-3975"><span class="linenos">3975</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="L-3976"><a href="#L-3976"><span class="linenos">3976</span></a>				<span class="c1"># mprint(pax, &#39;active flight is reverted to previous one:&#39;, pax.active_flight)</span>
</span><span id="L-3977"><a href="#L-3977"><span class="linenos">3977</span></a>
</span><span id="L-3978"><a href="#L-3978"><span class="linenos">3978</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_to_remove</span><span class="p">:</span>
</span><span id="L-3979"><a href="#L-3979"><span class="linenos">3979</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-3980"><a href="#L-3980"><span class="linenos">3980</span></a>
</span><span id="L-3981"><a href="#L-3981"><span class="linenos">3981</span></a>	<span class="k">def</span> <span class="nf">arrive_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-3982"><a href="#L-3982"><span class="linenos">3982</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3983"><a href="#L-3983"><span class="linenos">3983</span></a><span class="sd">		If overnight is True, the passenger need to be cared for for the night.</span>
</span><span id="L-3984"><a href="#L-3984"><span class="linenos">3984</span></a><span class="sd">		WARNING: this method assumes that it is executed exactly when at the in-block</span>
</span><span id="L-3985"><a href="#L-3985"><span class="linenos">3985</span></a><span class="sd">		time of the last flight.</span>
</span><span id="L-3986"><a href="#L-3986"><span class="linenos">3986</span></a><span class="sd">		Note: paxs are paid first, then costs for airlines are computed.</span>
</span><span id="L-3987"><a href="#L-3987"><span class="linenos">3987</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="L-3988"><a href="#L-3988"><span class="linenos">3988</span></a>		<span class="c1"># Passengers arrived</span>
</span><span id="L-3989"><a href="#L-3989"><span class="linenos">3989</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;arrived&#39;</span>
</span><span id="L-3990"><a href="#L-3990"><span class="linenos">3990</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has finished their journey.&#39;</span><span class="p">)</span>
</span><span id="L-3991"><a href="#L-3991"><span class="linenos">3991</span></a>
</span><span id="L-3992"><a href="#L-3992"><span class="linenos">3992</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-3993"><a href="#L-3993"><span class="linenos">3993</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3994"><a href="#L-3994"><span class="linenos">3994</span></a>			<span class="c1"># mprint(pax, &#39;has an initial_aobt:&#39;, pax.initial_aobt)</span>
</span><span id="L-3995"><a href="#L-3995"><span class="linenos">3995</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-3996"><a href="#L-3996"><span class="linenos">3996</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3997"><a href="#L-3997"><span class="linenos">3997</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has not taken any flight.&#39;</span><span class="p">)</span>
</span><span id="L-3998"><a href="#L-3998"><span class="linenos">3998</span></a>
</span><span id="L-3999"><a href="#L-3999"><span class="linenos">3999</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4000"><a href="#L-4000"><span class="linenos">4000</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-4001"><a href="#L-4001"><span class="linenos">4001</span></a>			<span class="c1"># mprint(pax, &#39;has an final_aibt:&#39;, pax.final_aibt)</span>
</span><span id="L-4002"><a href="#L-4002"><span class="linenos">4002</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-4003"><a href="#L-4003"><span class="linenos">4003</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-4004"><a href="#L-4004"><span class="linenos">4004</span></a>			<span class="c1"># mprint(pax, &#39;has not taken any flight (bis).&#39;)</span>
</span><span id="L-4005"><a href="#L-4005"><span class="linenos">4005</span></a>
</span><span id="L-4006"><a href="#L-4006"><span class="linenos">4006</span></a>		<span class="n">it_so_far</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span>
</span><span id="L-4007"><a href="#L-4007"><span class="linenos">4007</span></a>
</span><span id="L-4008"><a href="#L-4008"><span class="linenos">4008</span></a>		<span class="k">if</span> <span class="n">overnight</span><span class="p">:</span>
</span><span id="L-4009"><a href="#L-4009"><span class="linenos">4009</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span id="L-4010"><a href="#L-4010"><span class="linenos">4010</span></a>			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="L-4011"><a href="#L-4011"><span class="linenos">4011</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-4012"><a href="#L-4012"><span class="linenos">4012</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-4013"><a href="#L-4013"><span class="linenos">4013</span></a>
</span><span id="L-4014"><a href="#L-4014"><span class="linenos">4014</span></a>			<span class="c1"># Duty of care here (because there is no more flight!)</span>
</span><span id="L-4015"><a href="#L-4015"><span class="linenos">4015</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-4016"><a href="#L-4016"><span class="linenos">4016</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span>
</span><span id="L-4017"><a href="#L-4017"><span class="linenos">4017</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-4018"><a href="#L-4018"><span class="linenos">4018</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span>
</span><span id="L-4019"><a href="#L-4019"><span class="linenos">4019</span></a>
</span><span id="L-4020"><a href="#L-4020"><span class="linenos">4020</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="n">tot_arrival_delay</span>
</span><span id="L-4021"><a href="#L-4021"><span class="linenos">4021</span></a>
</span><span id="L-4022"><a href="#L-4022"><span class="linenos">4022</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">final_destination_reached</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_airport</span>
</span><span id="L-4023"><a href="#L-4023"><span class="linenos">4023</span></a>
</span><span id="L-4024"><a href="#L-4024"><span class="linenos">4024</span></a>		<span class="c1"># Soft cost is payed with compensation, during the blame</span>
</span><span id="L-4025"><a href="#L-4025"><span class="linenos">4025</span></a>		<span class="n">soft_cost</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">))</span>
</span><span id="L-4026"><a href="#L-4026"><span class="linenos">4026</span></a>
</span><span id="L-4027"><a href="#L-4027"><span class="linenos">4027</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="n">soft_cost</span>
</span><span id="L-4028"><a href="#L-4028"><span class="linenos">4028</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has triggered a soft cost for delay (&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="L-4029"><a href="#L-4029"><span class="linenos">4029</span></a>
</span><span id="L-4030"><a href="#L-4030"><span class="linenos">4030</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="ow">or</span> <span class="n">pax</span><span class="o">.</span><span class="n">force_entitled</span><span class="p">:</span>
</span><span id="L-4031"><a href="#L-4031"><span class="linenos">4031</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is entitled to compensation. Total arrival delay:&#39;</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="s1">&#39;with a distance:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>
</span><span id="L-4032"><a href="#L-4032"><span class="linenos">4032</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">)</span>  <span class="c1"># * pax.n_pax * self.agent.compensation_uptake`</span>
</span><span id="L-4033"><a href="#L-4033"><span class="linenos">4033</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-4034"><a href="#L-4034"><span class="linenos">4034</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-4035"><a href="#L-4035"><span class="linenos">4035</span></a>
</span><span id="L-4036"><a href="#L-4036"><span class="linenos">4036</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">compensation</span>
</span><span id="L-4037"><a href="#L-4037"><span class="linenos">4037</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;have been compensated for delay (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="L-4038"><a href="#L-4038"><span class="linenos">4038</span></a>
</span><span id="L-4039"><a href="#L-4039"><span class="linenos">4039</span></a>		<span class="k">if</span> <span class="n">compensation</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">soft_cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="L-4040"><a href="#L-4040"><span class="linenos">4040</span></a>			<span class="c1"># Find out who is mainly responsible for the compensation</span>
</span><span id="L-4041"><a href="#L-4041"><span class="linenos">4041</span></a>			<span class="c1"># Note: if it is because of a cancelled flight,</span>
</span><span id="L-4042"><a href="#L-4042"><span class="linenos">4042</span></a>			<span class="c1"># the blame is already given.</span>
</span><span id="L-4043"><a href="#L-4043"><span class="linenos">4043</span></a>			<span class="c1"># The following function is cancelling the compensation if it finds</span>
</span><span id="L-4044"><a href="#L-4044"><span class="linenos">4044</span></a>			<span class="c1"># that the pax is ultimately responsible for its delay.</span>
</span><span id="L-4045"><a href="#L-4045"><span class="linenos">4045</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="L-4046"><a href="#L-4046"><span class="linenos">4046</span></a>
</span><span id="L-4047"><a href="#L-4047"><span class="linenos">4047</span></a>		<span class="c1"># Record the real itinerary. `If&#39; is here to avoid flag modified if true itinerary.</span>
</span><span id="L-4048"><a href="#L-4048"><span class="linenos">4048</span></a>		<span class="c1"># KEEP THIS BIT AT THE END THE METHOD UNLESS YOU KNOW WHAT YOU ARE DOING</span>
</span><span id="L-4049"><a href="#L-4049"><span class="linenos">4049</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
</span><span id="L-4050"><a href="#L-4050"><span class="linenos">4050</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">())</span>
</span><span id="L-4051"><a href="#L-4051"><span class="linenos">4051</span></a>
</span><span id="L-4052"><a href="#L-4052"><span class="linenos">4052</span></a>	<span class="k">def</span> <span class="nf">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="L-4053"><a href="#L-4053"><span class="linenos">4053</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;tries to find the flight to blame for compensation and soft cost&#39;</span><span class="p">)</span>
</span><span id="L-4054"><a href="#L-4054"><span class="linenos">4054</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4055"><a href="#L-4055"><span class="linenos">4055</span></a>			<span class="c1"># if should be entered only if pax was not on a flight which has</span>
</span><span id="L-4056"><a href="#L-4056"><span class="linenos">4056</span></a>			<span class="c1"># been cancelled</span>
</span><span id="L-4057"><a href="#L-4057"><span class="linenos">4057</span></a>			<span class="c1"># if len(pax.old_itineraries) == 0 or :</span>
</span><span id="L-4058"><a href="#L-4058"><span class="linenos">4058</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4059"><a href="#L-4059"><span class="linenos">4059</span></a>				<span class="c1"># Passenger has followed its planned itinerary</span>
</span><span id="L-4060"><a href="#L-4060"><span class="linenos">4060</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;did not miss a flight, it tries to blame its last flight first (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="L-4061"><a href="#L-4061"><span class="linenos">4061</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="L-4062"><a href="#L-4062"><span class="linenos">4062</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4063"><a href="#L-4063"><span class="linenos">4063</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;missed at least a flight, it tries to blame the last flight of the original itinerary first&#39;</span><span class="p">)</span>
</span><span id="L-4064"><a href="#L-4064"><span class="linenos">4064</span></a>				<span class="c1"># Passenger has missed a flight at some point. Two cases can happen: either</span>
</span><span id="L-4065"><a href="#L-4065"><span class="linenos">4065</span></a>				<span class="c1"># they were reallocated, or they were not.</span>
</span><span id="L-4066"><a href="#L-4066"><span class="linenos">4066</span></a>				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4067"><a href="#L-4067"><span class="linenos">4067</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has at least one old itinerary&#39;</span><span class="p">)</span>
</span><span id="L-4068"><a href="#L-4068"><span class="linenos">4068</span></a>					<span class="c1"># In this case, the pax has been reallocated at least once.</span>
</span><span id="L-4069"><a href="#L-4069"><span class="linenos">4069</span></a>					<span class="c1"># Find the last flight taken by the pax in the original itinerary</span>
</span><span id="L-4070"><a href="#L-4070"><span class="linenos">4070</span></a>					<span class="n">original_itinerary</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-4071"><a href="#L-4071"><span class="linenos">4071</span></a>					<span class="c1"># Find idx of first flight different in original and actual itinerary</span>
</span><span id="L-4072"><a href="#L-4072"><span class="linenos">4072</span></a>					<span class="c1"># #idx = next(i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]!=pax.itinerary[i])</span>
</span><span id="L-4073"><a href="#L-4073"><span class="linenos">4073</span></a>					<span class="c1"># try:</span>
</span><span id="L-4074"><a href="#L-4074"><span class="linenos">4074</span></a>					<span class="c1">#     idxs = [i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]==pax.itinerary[i]]</span>
</span><span id="L-4075"><a href="#L-4075"><span class="linenos">4075</span></a>					<span class="c1">#     idx = idxs[-1]</span>
</span><span id="L-4076"><a href="#L-4076"><span class="linenos">4076</span></a>					<span class="c1"># except:</span>
</span><span id="L-4077"><a href="#L-4077"><span class="linenos">4077</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;, original_itinerary, pax.itinerary, pax.old_itineraries)</span>
</span><span id="L-4078"><a href="#L-4078"><span class="linenos">4078</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;)</span>
</span><span id="L-4079"><a href="#L-4079"><span class="linenos">4079</span></a>					<span class="c1">#     raise</span>
</span><span id="L-4080"><a href="#L-4080"><span class="linenos">4080</span></a>
</span><span id="L-4081"><a href="#L-4081"><span class="linenos">4081</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-4082"><a href="#L-4082"><span class="linenos">4082</span></a>					<span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_itinerary</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">))))</span> <span class="ow">and</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
</span><span id="L-4083"><a href="#L-4083"><span class="linenos">4083</span></a>						<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-4084"><a href="#L-4084"><span class="linenos">4084</span></a>					<span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-4085"><a href="#L-4085"><span class="linenos">4085</span></a>
</span><span id="L-4086"><a href="#L-4086"><span class="linenos">4086</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="L-4087"><a href="#L-4087"><span class="linenos">4087</span></a>						<span class="k">assert</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="L-4088"><a href="#L-4088"><span class="linenos">4088</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="L-4089"><a href="#L-4089"><span class="linenos">4089</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">original_itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="L-4090"><a href="#L-4090"><span class="linenos">4090</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span><span id="L-4091"><a href="#L-4091"><span class="linenos">4091</span></a>						<span class="k">raise</span>
</span><span id="L-4092"><a href="#L-4092"><span class="linenos">4092</span></a>					<span class="c1"># Rmq: idx should not be -1, because it would mean that they missed the first</span>
</span><span id="L-4093"><a href="#L-4093"><span class="linenos">4093</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="L-4094"><a href="#L-4094"><span class="linenos">4094</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="L-4095"><a href="#L-4095"><span class="linenos">4095</span></a>
</span><span id="L-4096"><a href="#L-4096"><span class="linenos">4096</span></a>					<span class="c1"># Last common flight between origin and actual itinerary</span>
</span><span id="L-4097"><a href="#L-4097"><span class="linenos">4097</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># [idx-1]</span>
</span><span id="L-4098"><a href="#L-4098"><span class="linenos">4098</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-4099"><a href="#L-4099"><span class="linenos">4099</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has no old itinerary&#39;</span><span class="p">)</span>
</span><span id="L-4100"><a href="#L-4100"><span class="linenos">4100</span></a>					<span class="c1"># In this case, the pax has not been reallocated once (it missed its flight and)</span>
</span><span id="L-4101"><a href="#L-4101"><span class="linenos">4101</span></a>					<span class="c1"># could not find a suitable replacement.</span>
</span><span id="L-4102"><a href="#L-4102"><span class="linenos">4102</span></a>					<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>    <span class="c1"># this list should have exactly one element</span>
</span><span id="L-4103"><a href="#L-4103"><span class="linenos">4103</span></a>
</span><span id="L-4104"><a href="#L-4104"><span class="linenos">4104</span></a>					<span class="c1"># Find the idx of the missed flight.</span>
</span><span id="L-4105"><a href="#L-4105"><span class="linenos">4105</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-4106"><a href="#L-4106"><span class="linenos">4106</span></a>					<span class="c1"># Rmq: idx should not be 0, because it would mean that they missed the first</span>
</span><span id="L-4107"><a href="#L-4107"><span class="linenos">4107</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="L-4108"><a href="#L-4108"><span class="linenos">4108</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="L-4109"><a href="#L-4109"><span class="linenos">4109</span></a>					<span class="c1"># The last flight taken is the one before the missed flight.</span>
</span><span id="L-4110"><a href="#L-4110"><span class="linenos">4110</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-4111"><a href="#L-4111"><span class="linenos">4111</span></a>
</span><span id="L-4112"><a href="#L-4112"><span class="linenos">4112</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;took the flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">,</span> <span class="s1">&#39;last in its original itinerary&#39;</span><span class="p">)</span>
</span><span id="L-4113"><a href="#L-4113"><span class="linenos">4113</span></a>
</span><span id="L-4114"><a href="#L-4114"><span class="linenos">4114</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">last_flight</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="L-4115"><a href="#L-4115"><span class="linenos">4115</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-4116"><a href="#L-4116"><span class="linenos">4116</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
</span><span id="L-4117"><a href="#L-4117"><span class="linenos">4117</span></a>				<span class="c1"># self.blame_compensation_of_pax(pax, compensation)</span>
</span><span id="L-4118"><a href="#L-4118"><span class="linenos">4118</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="L-4119"><a href="#L-4119"><span class="linenos">4119</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="L-4120"><a href="#L-4120"><span class="linenos">4120</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4121"><a href="#L-4121"><span class="linenos">4121</span></a>				<span class="c1"># Remove the compensation from the pax, it should not have it!</span>
</span><span id="L-4122"><a href="#L-4122"><span class="linenos">4122</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-4123"><a href="#L-4123"><span class="linenos">4123</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="L-4124"><a href="#L-4124"><span class="linenos">4124</span></a>
</span><span id="L-4125"><a href="#L-4125"><span class="linenos">4125</span></a>	<span class="k">def</span> <span class="nf">pay_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-4126"><a href="#L-4126"><span class="linenos">4126</span></a>		<span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="L-4127"><a href="#L-4127"><span class="linenos">4127</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4128"><a href="#L-4128"><span class="linenos">4128</span></a>				<span class="k">if</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span>
</span><span id="L-4129"><a href="#L-4129"><span class="linenos">4129</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span>
</span><span id="L-4130"><a href="#L-4130"><span class="linenos">4130</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span>
</span><span id="L-4131"><a href="#L-4131"><span class="linenos">4131</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span>
</span><span id="L-4132"><a href="#L-4132"><span class="linenos">4132</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span>
</span><span id="L-4133"><a href="#L-4133"><span class="linenos">4133</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span>
</span><span id="L-4134"><a href="#L-4134"><span class="linenos">4134</span></a>
</span><span id="L-4135"><a href="#L-4135"><span class="linenos">4135</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">():</span>
</span><span id="L-4136"><a href="#L-4136"><span class="linenos">4136</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="L-4137"><a href="#L-4137"><span class="linenos">4137</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4138"><a href="#L-4138"><span class="linenos">4138</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_cost_blame</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="L-4139"><a href="#L-4139"><span class="linenos">4139</span></a>
</span><span id="L-4140"><a href="#L-4140"><span class="linenos">4140</span></a>	<span class="k">def</span> <span class="nf">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="L-4141"><a href="#L-4141"><span class="linenos">4141</span></a>		<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-4142"><a href="#L-4142"><span class="linenos">4142</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_follow_blame_request</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="L-4143"><a href="#L-4143"><span class="linenos">4143</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="L-4144"><a href="#L-4144"><span class="linenos">4144</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4145"><a href="#L-4145"><span class="linenos">4145</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The main reason for delay of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">])</span>
</span><span id="L-4146"><a href="#L-4146"><span class="linenos">4146</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RD&#39;</span><span class="p">:</span>
</span><span id="L-4147"><a href="#L-4147"><span class="linenos">4147</span></a>					<span class="c1"># If main cause is reactionary delay, find previous flight using the</span>
</span><span id="L-4148"><a href="#L-4148"><span class="linenos">4148</span></a>					<span class="c1"># same aircraft and redo the same procedure</span>
</span><span id="L-4149"><a href="#L-4149"><span class="linenos">4149</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="L-4150"><a href="#L-4150"><span class="linenos">4150</span></a>					<span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4151"><a href="#L-4151"><span class="linenos">4151</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;tries to blame the previous flight (&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="L-4152"><a href="#L-4152"><span class="linenos">4152</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-4153"><a href="#L-4153"><span class="linenos">4153</span></a>												<span class="n">pax</span><span class="p">,</span>
</span><span id="L-4154"><a href="#L-4154"><span class="linenos">4154</span></a>												<span class="n">compensation</span><span class="p">,</span>
</span><span id="L-4155"><a href="#L-4155"><span class="linenos">4155</span></a>												<span class="n">soft_cost</span><span class="p">)</span>
</span><span id="L-4156"><a href="#L-4156"><span class="linenos">4156</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="L-4157"><a href="#L-4157"><span class="linenos">4157</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was the first one, it gets the blame&#39;</span><span class="p">)</span>
</span><span id="L-4158"><a href="#L-4158"><span class="linenos">4158</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4159"><a href="#L-4159"><span class="linenos">4159</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4160"><a href="#L-4160"><span class="linenos">4160</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="L-4161"><a href="#L-4161"><span class="linenos">4161</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="L-4162"><a href="#L-4162"><span class="linenos">4162</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-4163"><a href="#L-4163"><span class="linenos">4163</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;gets the blame&#39;</span><span class="p">)</span>
</span><span id="L-4164"><a href="#L-4164"><span class="linenos">4164</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4165"><a href="#L-4165"><span class="linenos">4165</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4166"><a href="#L-4166"><span class="linenos">4166</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="L-4167"><a href="#L-4167"><span class="linenos">4167</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="L-4168"><a href="#L-4168"><span class="linenos">4168</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4169"><a href="#L-4169"><span class="linenos">4169</span></a>				<span class="c1"># This can happen either if the flight was cancelled of if it did not have</span>
</span><span id="L-4170"><a href="#L-4170"><span class="linenos">4170</span></a>				<span class="c1"># any delay at departure.</span>
</span><span id="L-4171"><a href="#L-4171"><span class="linenos">4171</span></a>				<span class="c1"># assert self.agent.aoc_flights_info[flight_uid][&#39;status&#39;] == &#39;cancelled&#39;</span>
</span><span id="L-4172"><a href="#L-4172"><span class="linenos">4172</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was cancelled, so it gets the blame.&#39;</span><span class="p">)</span>
</span><span id="L-4173"><a href="#L-4173"><span class="linenos">4173</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4174"><a href="#L-4174"><span class="linenos">4174</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4175"><a href="#L-4175"><span class="linenos">4175</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="L-4176"><a href="#L-4176"><span class="linenos">4176</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="L-4177"><a href="#L-4177"><span class="linenos">4177</span></a>
</span><span id="L-4178"><a href="#L-4178"><span class="linenos">4178</span></a>	<span class="k">def</span> <span class="nf">request_reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="L-4179"><a href="#L-4179"><span class="linenos">4179</span></a>		<span class="c1"># This is an internal message.</span>
</span><span id="L-4180"><a href="#L-4180"><span class="linenos">4180</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-4181"><a href="#L-4181"><span class="linenos">4181</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-4182"><a href="#L-4182"><span class="linenos">4182</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="L-4183"><a href="#L-4183"><span class="linenos">4183</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="L-4184"><a href="#L-4184"><span class="linenos">4184</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="L-4185"><a href="#L-4185"><span class="linenos">4185</span></a>
</span><span id="L-4186"><a href="#L-4186"><span class="linenos">4186</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(APH role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="L-4187"><a href="#L-4187"><span class="linenos">4187</span></a>
</span><span id="L-4188"><a href="#L-4188"><span class="linenos">4188</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-4189"><a href="#L-4189"><span class="linenos">4189</span></a>
</span><span id="L-4190"><a href="#L-4190"><span class="linenos">4190</span></a>		<span class="c1"># Uncomment the following line if you want to use central server.</span>
</span><span id="L-4191"><a href="#L-4191"><span class="linenos">4191</span></a>		<span class="c1"># self.send(msg)</span>
</span><span id="L-4192"><a href="#L-4192"><span class="linenos">4192</span></a>
</span><span id="L-4193"><a href="#L-4193"><span class="linenos">4193</span></a>	<span class="k">def</span> <span class="nf">request_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">connection_type</span><span class="p">):</span>
</span><span id="L-4194"><a href="#L-4194"><span class="linenos">4194</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-4195"><a href="#L-4195"><span class="linenos">4195</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span>
</span><span id="L-4196"><a href="#L-4196"><span class="linenos">4196</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;connecting_times_request&#39;</span>
</span><span id="L-4197"><a href="#L-4197"><span class="linenos">4197</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="L-4198"><a href="#L-4198"><span class="linenos">4198</span></a>						<span class="s1">&#39;connection_type&#39;</span><span class="p">:</span> <span class="n">connection_type</span><span class="p">}</span>
</span><span id="L-4199"><a href="#L-4199"><span class="linenos">4199</span></a>
</span><span id="L-4200"><a href="#L-4200"><span class="linenos">4200</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-4201"><a href="#L-4201"><span class="linenos">4201</span></a>
</span><span id="L-4202"><a href="#L-4202"><span class="linenos">4202</span></a>	<span class="k">def</span> <span class="nf">request_pax_connection_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="L-4203"><a href="#L-4203"><span class="linenos">4203</span></a>		<span class="n">pax_per_aoc</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-4204"><a href="#L-4204"><span class="linenos">4204</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-4205"><a href="#L-4205"><span class="linenos">4205</span></a>			<span class="c1"># aoc_uid = self.flight_registery[pax.itinerary[pax.idx_current_flight+1]][&#39;aoc_uid&#39;]</span>
</span><span id="L-4206"><a href="#L-4206"><span class="linenos">4206</span></a>			<span class="n">aoc_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">())</span>
</span><span id="L-4207"><a href="#L-4207"><span class="linenos">4207</span></a>			<span class="n">pax_per_aoc</span><span class="p">[</span><span class="n">aoc_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">pax</span><span class="p">]</span>
</span><span id="L-4208"><a href="#L-4208"><span class="linenos">4208</span></a>
</span><span id="L-4209"><a href="#L-4209"><span class="linenos">4209</span></a>		<span class="k">for</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">paxs2</span> <span class="ow">in</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-4210"><a href="#L-4210"><span class="linenos">4210</span></a>			<span class="n">new_msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-4211"><a href="#L-4211"><span class="linenos">4211</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pax_connection_handling&#39;</span>
</span><span id="L-4212"><a href="#L-4212"><span class="linenos">4212</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="L-4213"><a href="#L-4213"><span class="linenos">4213</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs2</span><span class="p">}</span>
</span><span id="L-4214"><a href="#L-4214"><span class="linenos">4214</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending pax connection handling request for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs2</span><span class="p">)</span>
</span><span id="L-4215"><a href="#L-4215"><span class="linenos">4215</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new_msg</span><span class="p">)</span>
</span><span id="L-4216"><a href="#L-4216"><span class="linenos">4216</span></a>
</span><span id="L-4217"><a href="#L-4217"><span class="linenos">4217</span></a>	<span class="k">def</span> <span class="nf">handle_pax_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="L-4218"><a href="#L-4218"><span class="linenos">4218</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles the paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="L-4219"><a href="#L-4219"><span class="linenos">4219</span></a>
</span><span id="L-4220"><a href="#L-4220"><span class="linenos">4220</span></a>		<span class="n">missed_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4221"><a href="#L-4221"><span class="linenos">4221</span></a>
</span><span id="L-4222"><a href="#L-4222"><span class="linenos">4222</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-4223"><a href="#L-4223"><span class="linenos">4223</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-4224"><a href="#L-4224"><span class="linenos">4224</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="L-4225"><a href="#L-4225"><span class="linenos">4225</span></a>			<span class="c1"># Remember the theoretical departure for duty of care</span>
</span><span id="L-4226"><a href="#L-4226"><span class="linenos">4226</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="L-4227"><a href="#L-4227"><span class="linenos">4227</span></a>
</span><span id="L-4228"><a href="#L-4228"><span class="linenos">4228</span></a>			<span class="c1"># Compute the connecting times for these pax.</span>
</span><span id="L-4229"><a href="#L-4229"><span class="linenos">4229</span></a>			<span class="n">int1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="L-4230"><a href="#L-4230"><span class="linenos">4230</span></a>			<span class="n">int2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="L-4231"><a href="#L-4231"><span class="linenos">4231</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">int2</span>
</span><span id="L-4232"><a href="#L-4232"><span class="linenos">4232</span></a>
</span><span id="L-4233"><a href="#L-4233"><span class="linenos">4233</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_connecting_times</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="p">(</span><span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">))</span>
</span><span id="L-4234"><a href="#L-4234"><span class="linenos">4234</span></a>
</span><span id="L-4235"><a href="#L-4235"><span class="linenos">4235</span></a>			<span class="c1"># Check next flight has already departed or is cancelled.</span>
</span><span id="L-4236"><a href="#L-4236"><span class="linenos">4236</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span> \
</span><span id="L-4237"><a href="#L-4237"><span class="linenos">4237</span></a>				<span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">):</span>
</span><span id="L-4238"><a href="#L-4238"><span class="linenos">4238</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is added to pax with missed connection list for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight</span><span class="p">),</span>
</span><span id="L-4239"><a href="#L-4239"><span class="linenos">4239</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span>
</span><span id="L-4240"><a href="#L-4240"><span class="linenos">4240</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">)</span>
</span><span id="L-4241"><a href="#L-4241"><span class="linenos">4241</span></a>				<span class="n">missed_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-4242"><a href="#L-4242"><span class="linenos">4242</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span>
</span><span id="L-4243"><a href="#L-4243"><span class="linenos">4243</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4244"><a href="#L-4244"><span class="linenos">4244</span></a>				<span class="c1"># Try to make it to the next flight. The active flight is reverted to the</span>
</span><span id="L-4245"><a href="#L-4245"><span class="linenos">4245</span></a>				<span class="c1"># previous one if the pax does not make it.</span>
</span><span id="L-4246"><a href="#L-4246"><span class="linenos">4246</span></a>				<span class="c1"># pax.idx_current_flight += 1</span>
</span><span id="L-4247"><a href="#L-4247"><span class="linenos">4247</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="L-4248"><a href="#L-4248"><span class="linenos">4248</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">=</span> <span class="n">next_flight</span>
</span><span id="L-4249"><a href="#L-4249"><span class="linenos">4249</span></a>
</span><span id="L-4250"><a href="#L-4250"><span class="linenos">4250</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4251"><a href="#L-4251"><span class="linenos">4251</span></a>			<span class="c1"># mprint(&#39;Pax who missed their connection at arrival of flight&#39;, missed_connecting_pax[0].itinerary[missed_connecting_pax[0].idx_current_flight], &#39;:&#39;, missed_connecting_pax)</span>
</span><span id="L-4252"><a href="#L-4252"><span class="linenos">4252</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax who missed their connection at arrival of flight&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">(),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">missed_connecting_pax</span><span class="p">)</span>
</span><span id="L-4253"><a href="#L-4253"><span class="linenos">4253</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_reallocate_pax</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span>
</span><span id="L-4254"><a href="#L-4254"><span class="linenos">4254</span></a>
</span><span id="L-4255"><a href="#L-4255"><span class="linenos">4255</span></a>	<span class="k">def</span> <span class="nf">send_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">):</span>
</span><span id="L-4256"><a href="#L-4256"><span class="linenos">4256</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending cost blame to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for cost:&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="L-4257"><a href="#L-4257"><span class="linenos">4257</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-4258"><a href="#L-4258"><span class="linenos">4258</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4259"><a href="#L-4259"><span class="linenos">4259</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_blame&#39;</span>
</span><span id="L-4260"><a href="#L-4260"><span class="linenos">4260</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
</span><span id="L-4261"><a href="#L-4261"><span class="linenos">4261</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-4262"><a href="#L-4262"><span class="linenos">4262</span></a>						<span class="s1">&#39;cost_type&#39;</span><span class="p">:</span> <span class="n">cost_type</span><span class="p">}</span>
</span><span id="L-4263"><a href="#L-4263"><span class="linenos">4263</span></a>
</span><span id="L-4264"><a href="#L-4264"><span class="linenos">4264</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-4265"><a href="#L-4265"><span class="linenos">4265</span></a>
</span><span id="L-4266"><a href="#L-4266"><span class="linenos">4266</span></a>	<span class="k">def</span> <span class="nf">send_follow_blame_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="L-4267"><a href="#L-4267"><span class="linenos">4267</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending follow blame request to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="L-4268"><a href="#L-4268"><span class="linenos">4268</span></a>				<span class="s1">&#39;for compensation:&#39;</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;and soft cost:&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;of &#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="L-4269"><a href="#L-4269"><span class="linenos">4269</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="L-4270"><a href="#L-4270"><span class="linenos">4270</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="L-4271"><a href="#L-4271"><span class="linenos">4271</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;follow_blame&#39;</span>
</span><span id="L-4272"><a href="#L-4272"><span class="linenos">4272</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;compensation&#39;</span><span class="p">:</span> <span class="n">compensation</span><span class="p">,</span>
</span><span id="L-4273"><a href="#L-4273"><span class="linenos">4273</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="L-4274"><a href="#L-4274"><span class="linenos">4274</span></a>						<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="n">soft_cost</span><span class="p">,</span>
</span><span id="L-4275"><a href="#L-4275"><span class="linenos">4275</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="L-4276"><a href="#L-4276"><span class="linenos">4276</span></a>
</span><span id="L-4277"><a href="#L-4277"><span class="linenos">4277</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-4278"><a href="#L-4278"><span class="linenos">4278</span></a>
</span><span id="L-4279"><a href="#L-4279"><span class="linenos">4279</span></a>	<span class="k">def</span> <span class="nf">wait_for_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-4280"><a href="#L-4280"><span class="linenos">4280</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span>
</span><span id="L-4281"><a href="#L-4281"><span class="linenos">4281</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives connecting times for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">])</span>
</span><span id="L-4282"><a href="#L-4282"><span class="linenos">4282</span></a>		<span class="c1"># pax.mcts.append(msg[&#39;body&#39;][&#39;mct&#39;])</span>
</span><span id="L-4283"><a href="#L-4283"><span class="linenos">4283</span></a>		<span class="c1"># pax.cts.append(msg[&#39;body&#39;][&#39;ct&#39;])</span>
</span><span id="L-4284"><a href="#L-4284"><span class="linenos">4284</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;mct&#39;</span><span class="p">]</span>
</span><span id="L-4285"><a href="#L-4285"><span class="linenos">4285</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span><span id="L-4286"><a href="#L-4286"><span class="linenos">4286</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span><span id="L-4287"><a href="#L-4287"><span class="linenos">4287</span></a>
</span><span id="L-4288"><a href="#L-4288"><span class="linenos">4288</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-4289"><a href="#L-4289"><span class="linenos">4289</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_type&#39;</span><span class="p">])</span>
</span><span id="L-4290"><a href="#L-4290"><span class="linenos">4290</span></a>
</span><span id="L-4291"><a href="#L-4291"><span class="linenos">4291</span></a>	<span class="k">def</span> <span class="nf">wait_for_follow_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-4292"><a href="#L-4292"><span class="linenos">4292</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;compensation&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;soft_cost&#39;</span><span class="p">])</span>
</span><span id="L-4293"><a href="#L-4293"><span class="linenos">4293</span></a>
</span><span id="L-4294"><a href="#L-4294"><span class="linenos">4294</span></a>	<span class="k">def</span> <span class="nf">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-4295"><a href="#L-4295"><span class="linenos">4295</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received pax connection handling request from IP for paxs:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="L-4296"><a href="#L-4296"><span class="linenos">4296</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="L-4297"><a href="#L-4297"><span class="linenos">4297</span></a>
</span><span id="L-4298"><a href="#L-4298"><span class="linenos">4298</span></a>	<span class="k">def</span> <span class="nf">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="L-4299"><a href="#L-4299"><span class="linenos">4299</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="L-4300"><a href="#L-4300"><span class="linenos">4300</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is considering arrival pax request for flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-4301"><a href="#L-4301"><span class="linenos">4301</span></a>		<span class="n">connecting_pax_other_company</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4302"><a href="#L-4302"><span class="linenos">4302</span></a>		<span class="n">own_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-4303"><a href="#L-4303"><span class="linenos">4303</span></a>
</span><span id="L-4304"><a href="#L-4304"><span class="linenos">4304</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="L-4305"><a href="#L-4305"><span class="linenos">4305</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="L-4306"><a href="#L-4306"><span class="linenos">4306</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">unboard_from_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-4307"><a href="#L-4307"><span class="linenos">4307</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="L-4308"><a href="#L-4308"><span class="linenos">4308</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="L-4309"><a href="#L-4309"><span class="linenos">4309</span></a>
</span><span id="L-4310"><a href="#L-4310"><span class="linenos">4310</span></a>			<span class="c1"># Check if pax has a next flight</span>
</span><span id="L-4311"><a href="#L-4311"><span class="linenos">4311</span></a>			<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-4312"><a href="#L-4312"><span class="linenos">4312</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is connecting&#39;</span><span class="p">)</span>
</span><span id="L-4313"><a href="#L-4313"><span class="linenos">4313</span></a>
</span><span id="L-4314"><a href="#L-4314"><span class="linenos">4314</span></a>				<span class="c1"># Check if next flight belongs to this company</span>
</span><span id="L-4315"><a href="#L-4315"><span class="linenos">4315</span></a>				<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-4316"><a href="#L-4316"><span class="linenos">4316</span></a>					<span class="n">own_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-4317"><a href="#L-4317"><span class="linenos">4317</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="L-4318"><a href="#L-4318"><span class="linenos">4318</span></a>					<span class="c1"># Find the company operating the next flight</span>
</span><span id="L-4319"><a href="#L-4319"><span class="linenos">4319</span></a>					<span class="n">connecting_pax_other_company</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-4320"><a href="#L-4320"><span class="linenos">4320</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="L-4321"><a href="#L-4321"><span class="linenos">4321</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="L-4322"><a href="#L-4322"><span class="linenos">4322</span></a>
</span><span id="L-4323"><a href="#L-4323"><span class="linenos">4323</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles his own connecting paxs&#39;</span><span class="p">,</span> <span class="n">own_connecting_pax</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-4324"><a href="#L-4324"><span class="linenos">4324</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4325"><a href="#L-4325"><span class="linenos">4325</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span>
</span><span id="L-4326"><a href="#L-4326"><span class="linenos">4326</span></a>
</span><span id="L-4327"><a href="#L-4327"><span class="linenos">4327</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;will request connection handling for the paxs&#39;</span><span class="p">,</span> <span class="n">connecting_pax_other_company</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="L-4328"><a href="#L-4328"><span class="linenos">4328</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-4329"><a href="#L-4329"><span class="linenos">4329</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_pax_connection_handling</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="AirlineOperatingCentre">
                            <input id="AirlineOperatingCentre-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AirlineOperatingCentre</span><wbr>(<span class="base"><a href="agent_base.html#Agent">Mercury.agents.agent_base.Agent</a></span>):

                <label class="view-source-button" for="AirlineOperatingCentre-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre-18"><a href="#AirlineOperatingCentre-18"><span class="linenos"> 18</span></a><span class="k">class</span> <span class="nc">AirlineOperatingCentre</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-19"><a href="#AirlineOperatingCentre-19"><span class="linenos"> 19</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-20"><a href="#AirlineOperatingCentre-20"><span class="linenos"> 20</span></a><span class="sd">	Agent representing an airline operating centre.</span>
</span><span id="AirlineOperatingCentre-21"><a href="#AirlineOperatingCentre-21"><span class="linenos"> 21</span></a>
</span><span id="AirlineOperatingCentre-22"><a href="#AirlineOperatingCentre-22"><span class="linenos"> 22</span></a><span class="sd">	This includes:</span>
</span><span id="AirlineOperatingCentre-23"><a href="#AirlineOperatingCentre-23"><span class="linenos"> 23</span></a><span class="sd">	- Processes related to flight and fleet management, such as:</span>
</span><span id="AirlineOperatingCentre-24"><a href="#AirlineOperatingCentre-24"><span class="linenos"> 24</span></a><span class="sd">		- selection of flight plan</span>
</span><span id="AirlineOperatingCentre-25"><a href="#AirlineOperatingCentre-25"><span class="linenos"> 25</span></a><span class="sd">		- planning of flight plan</span>
</span><span id="AirlineOperatingCentre-26"><a href="#AirlineOperatingCentre-26"><span class="linenos"> 26</span></a><span class="sd">		- compute dynamic cost index for speed adjustment of flights</span>
</span><span id="AirlineOperatingCentre-27"><a href="#AirlineOperatingCentre-27"><span class="linenos"> 27</span></a><span class="sd">		- turnaround operation management</span>
</span><span id="AirlineOperatingCentre-28"><a href="#AirlineOperatingCentre-28"><span class="linenos"> 28</span></a><span class="sd">	- Processes related to management of passengers, such as:</span>
</span><span id="AirlineOperatingCentre-29"><a href="#AirlineOperatingCentre-29"><span class="linenos"> 29</span></a><span class="sd">		- Passengers reallocation</span>
</span><span id="AirlineOperatingCentre-30"><a href="#AirlineOperatingCentre-30"><span class="linenos"> 30</span></a><span class="sd">		- Passenger handler</span>
</span><span id="AirlineOperatingCentre-31"><a href="#AirlineOperatingCentre-31"><span class="linenos"> 31</span></a>
</span><span id="AirlineOperatingCentre-32"><a href="#AirlineOperatingCentre-32"><span class="linenos"> 32</span></a><span class="sd">	The decisions are mostly driven by expected cost of delay</span>
</span><span id="AirlineOperatingCentre-33"><a href="#AirlineOperatingCentre-33"><span class="linenos"> 33</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-34"><a href="#AirlineOperatingCentre-34"><span class="linenos"> 34</span></a>
</span><span id="AirlineOperatingCentre-35"><a href="#AirlineOperatingCentre-35"><span class="linenos"> 35</span></a>	<span class="c1">#  Dictionary with roles contained in the Agent</span>
</span><span id="AirlineOperatingCentre-36"><a href="#AirlineOperatingCentre-36"><span class="linenos"> 36</span></a>	<span class="n">dic_role</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;AirlineFlightPlanner&#39;</span><span class="p">:</span> <span class="s1">&#39;afp&#39;</span><span class="p">,</span>  <span class="c1"># Flight planning</span>
</span><span id="AirlineOperatingCentre-37"><a href="#AirlineOperatingCentre-37"><span class="linenos"> 37</span></a>				<span class="s1">&#39;PassengerReallocation&#39;</span><span class="p">:</span> <span class="s1">&#39;pr&#39;</span><span class="p">,</span>  <span class="c1"># Reallocation of passengers if miss connections</span>
</span><span id="AirlineOperatingCentre-38"><a href="#AirlineOperatingCentre-38"><span class="linenos"> 38</span></a>				<span class="s1">&#39;TurnaroundOperations&#39;</span><span class="p">:</span> <span class="s1">&#39;tro&#39;</span><span class="p">,</span>  <span class="c1"># Turnaround management (incl. FP recomputation and pax management)</span>
</span><span id="AirlineOperatingCentre-39"><a href="#AirlineOperatingCentre-39"><span class="linenos"> 39</span></a>				<span class="s1">&#39;AirlinePaxHandler&#39;</span><span class="p">:</span> <span class="s1">&#39;aph&#39;</span><span class="p">,</span>  <span class="c1"># Handling of passengers (arrival)</span>
</span><span id="AirlineOperatingCentre-40"><a href="#AirlineOperatingCentre-40"><span class="linenos"> 40</span></a>				<span class="s1">&#39;DynamicCostIndexComputer&#39;</span><span class="p">:</span> <span class="s1">&#39;dcic&#39;</span><span class="p">,</span>  <span class="c1"># Dynamic cost index computation to compute if speed up flights</span>
</span><span id="AirlineOperatingCentre-41"><a href="#AirlineOperatingCentre-41"><span class="linenos"> 41</span></a>				<span class="s1">&#39;FlightPlanSelector&#39;</span><span class="p">:</span> <span class="s1">&#39;fps&#39;</span><span class="p">}</span>  <span class="c1"># Selection of flight plan (flight plan dispatching)</span>
</span><span id="AirlineOperatingCentre-42"><a href="#AirlineOperatingCentre-42"><span class="linenos"> 42</span></a>
</span><span id="AirlineOperatingCentre-43"><a href="#AirlineOperatingCentre-43"><span class="linenos"> 43</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-44"><a href="#AirlineOperatingCentre-44"><span class="linenos"> 44</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-45"><a href="#AirlineOperatingCentre-45"><span class="linenos"> 45</span></a>
</span><span id="AirlineOperatingCentre-46"><a href="#AirlineOperatingCentre-46"><span class="linenos"> 46</span></a>		<span class="c1"># Roles</span>
</span><span id="AirlineOperatingCentre-47"><a href="#AirlineOperatingCentre-47"><span class="linenos"> 47</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">afp</span> <span class="o">=</span> <span class="n">AirlineFlightPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-48"><a href="#AirlineOperatingCentre-48"><span class="linenos"> 48</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">PassengerReallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-49"><a href="#AirlineOperatingCentre-49"><span class="linenos"> 49</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">tro</span> <span class="o">=</span> <span class="n">TurnaroundOperations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-50"><a href="#AirlineOperatingCentre-50"><span class="linenos"> 50</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aph</span> <span class="o">=</span> <span class="n">AirlinePaxHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-51"><a href="#AirlineOperatingCentre-51"><span class="linenos"> 51</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span> <span class="o">=</span> <span class="n">DynamicCostIndexComputer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-52"><a href="#AirlineOperatingCentre-52"><span class="linenos"> 52</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">FlightPlanSelector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Decides which flight plan to use for a given flight</span>
</span><span id="AirlineOperatingCentre-53"><a href="#AirlineOperatingCentre-53"><span class="linenos"> 53</span></a>
</span><span id="AirlineOperatingCentre-54"><a href="#AirlineOperatingCentre-54"><span class="linenos"> 54</span></a>		<span class="c1"># Apply modifications due to modules</span>
</span><span id="AirlineOperatingCentre-55"><a href="#AirlineOperatingCentre-55"><span class="linenos"> 55</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">apply_agent_modifications</span><span class="p">()</span>
</span><span id="AirlineOperatingCentre-56"><a href="#AirlineOperatingCentre-56"><span class="linenos"> 56</span></a>
</span><span id="AirlineOperatingCentre-57"><a href="#AirlineOperatingCentre-57"><span class="linenos"> 57</span></a>		<span class="c1"># Internal knowledge</span>
</span><span id="AirlineOperatingCentre-58"><a href="#AirlineOperatingCentre-58"><span class="linenos"> 58</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flights for the airline and their status (load factors, schedules, operated, etc.)</span>
</span><span id="AirlineOperatingCentre-59"><a href="#AirlineOperatingCentre-59"><span class="linenos"> 59</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flight plans for given flights (flight key)</span>
</span><span id="AirlineOperatingCentre-60"><a href="#AirlineOperatingCentre-60"><span class="linenos"> 60</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_pax_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># In theory, this should only be used for pax reallocation</span>
</span><span id="AirlineOperatingCentre-61"><a href="#AirlineOperatingCentre-61"><span class="linenos"> 61</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on airports used by flight from the airline</span>
</span><span id="AirlineOperatingCentre-62"><a href="#AirlineOperatingCentre-62"><span class="linenos"> 62</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># List of aircraft used by the airline</span>
</span><span id="AirlineOperatingCentre-63"><a href="#AirlineOperatingCentre-63"><span class="linenos"> 63</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Temporary save flight plan for flights</span>
</span><span id="AirlineOperatingCentre-64"><a href="#AirlineOperatingCentre-64"><span class="linenos"> 64</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on the delay recovery for a flight aoc gets from pdrp (role in Flight)</span>
</span><span id="AirlineOperatingCentre-65"><a href="#AirlineOperatingCentre-65"><span class="linenos"> 65</span></a>
</span><span id="AirlineOperatingCentre-66"><a href="#AirlineOperatingCentre-66"><span class="linenos"> 66</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_atfm</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information of flight waiting to recieve ATFM info</span>
</span><span id="AirlineOperatingCentre-67"><a href="#AirlineOperatingCentre-67"><span class="linenos"> 67</span></a>
</span><span id="AirlineOperatingCentre-68"><a href="#AirlineOperatingCentre-68"><span class="linenos"> 68</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">new_paxs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of new passenger groups created (e.g. split from groups)</span>
</span><span id="AirlineOperatingCentre-69"><a href="#AirlineOperatingCentre-69"><span class="linenos"> 69</span></a>
</span><span id="AirlineOperatingCentre-70"><a href="#AirlineOperatingCentre-70"><span class="linenos"> 70</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># CPU time for code performance assessment</span>
</span><span id="AirlineOperatingCentre-71"><a href="#AirlineOperatingCentre-71"><span class="linenos"> 71</span></a>
</span><span id="AirlineOperatingCentre-72"><a href="#AirlineOperatingCentre-72"><span class="linenos"> 72</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Duty of care function</span>
</span><span id="AirlineOperatingCentre-73"><a href="#AirlineOperatingCentre-73"><span class="linenos"> 73</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function to give compensation</span>
</span><span id="AirlineOperatingCentre-74"><a href="#AirlineOperatingCentre-74"><span class="linenos"> 74</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function for non pax costs</span>
</span><span id="AirlineOperatingCentre-75"><a href="#AirlineOperatingCentre-75"><span class="linenos"> 75</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Distribution of Non ATFM delay</span>
</span><span id="AirlineOperatingCentre-76"><a href="#AirlineOperatingCentre-76"><span class="linenos"> 76</span></a>
</span><span id="AirlineOperatingCentre-77"><a href="#AirlineOperatingCentre-77"><span class="linenos"> 77</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of trajectories between o-d to be used if FP generated on the fly based on trajectories</span>
</span><span id="AirlineOperatingCentre-78"><a href="#AirlineOperatingCentre-78"><span class="linenos"> 78</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of FPs</span>
</span><span id="AirlineOperatingCentre-79"><a href="#AirlineOperatingCentre-79"><span class="linenos"> 79</span></a>
</span><span id="AirlineOperatingCentre-80"><a href="#AirlineOperatingCentre-80"><span class="linenos"> 80</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">alliance</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Alliance for the arline. To be filled when registering airline into alliance</span>
</span><span id="AirlineOperatingCentre-81"><a href="#AirlineOperatingCentre-81"><span class="linenos"> 81</span></a>
</span><span id="AirlineOperatingCentre-82"><a href="#AirlineOperatingCentre-82"><span class="linenos"> 82</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NetworkManager Agent UID</span>
</span><span id="AirlineOperatingCentre-83"><a href="#AirlineOperatingCentre-83"><span class="linenos"> 83</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pointer to the Central Registry. To be filled when registering airline to CR</span>
</span><span id="AirlineOperatingCentre-84"><a href="#AirlineOperatingCentre-84"><span class="linenos"> 84</span></a>
</span><span id="AirlineOperatingCentre-85"><a href="#AirlineOperatingCentre-85"><span class="linenos"> 85</span></a>		<span class="c1"># Atributes passed on construction in init</span>
</span><span id="AirlineOperatingCentre-86"><a href="#AirlineOperatingCentre-86"><span class="linenos"> 86</span></a>		<span class="c1"># We could have passed information asking to use pool of flight plans or not</span>
</span><span id="AirlineOperatingCentre-87"><a href="#AirlineOperatingCentre-87"><span class="linenos"> 87</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;use_pool_fp&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-88"><a href="#AirlineOperatingCentre-88"><span class="linenos"> 88</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span>
</span><span id="AirlineOperatingCentre-89"><a href="#AirlineOperatingCentre-89"><span class="linenos"> 89</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-90"><a href="#AirlineOperatingCentre-90"><span class="linenos"> 90</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineOperatingCentre-91"><a href="#AirlineOperatingCentre-91"><span class="linenos"> 91</span></a>
</span><span id="AirlineOperatingCentre-92"><a href="#AirlineOperatingCentre-92"><span class="linenos"> 92</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;compensation_uptake&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-93"><a href="#AirlineOperatingCentre-93"><span class="linenos"> 93</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="AirlineOperatingCentre-94"><a href="#AirlineOperatingCentre-94"><span class="linenos"> 94</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-95"><a href="#AirlineOperatingCentre-95"><span class="linenos"> 95</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineOperatingCentre-96"><a href="#AirlineOperatingCentre-96"><span class="linenos"> 96</span></a>
</span><span id="AirlineOperatingCentre-97"><a href="#AirlineOperatingCentre-97"><span class="linenos"> 97</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;icao&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-98"><a href="#AirlineOperatingCentre-98"><span class="linenos"> 98</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="AirlineOperatingCentre-99"><a href="#AirlineOperatingCentre-99"><span class="linenos"> 99</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-100"><a href="#AirlineOperatingCentre-100"><span class="linenos">100</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineOperatingCentre-101"><a href="#AirlineOperatingCentre-101"><span class="linenos">101</span></a>
</span><span id="AirlineOperatingCentre-102"><a href="#AirlineOperatingCentre-102"><span class="linenos">102</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;airline_type&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-103"><a href="#AirlineOperatingCentre-103"><span class="linenos">103</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="AirlineOperatingCentre-104"><a href="#AirlineOperatingCentre-104"><span class="linenos">104</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-105"><a href="#AirlineOperatingCentre-105"><span class="linenos">105</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineOperatingCentre-106"><a href="#AirlineOperatingCentre-106"><span class="linenos">106</span></a>
</span><span id="AirlineOperatingCentre-107"><a href="#AirlineOperatingCentre-107"><span class="linenos">107</span></a>	<span class="k">def</span> <span class="nf">set_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-108"><a href="#AirlineOperatingCentre-108"><span class="linenos">108</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-109"><a href="#AirlineOperatingCentre-109"><span class="linenos">109</span></a><span class="sd">		Set log file for the Agent.</span>
</span><span id="AirlineOperatingCentre-110"><a href="#AirlineOperatingCentre-110"><span class="linenos">110</span></a><span class="sd">		TBC by logging system</span>
</span><span id="AirlineOperatingCentre-111"><a href="#AirlineOperatingCentre-111"><span class="linenos">111</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-112"><a href="#AirlineOperatingCentre-112"><span class="linenos">112</span></a>		<span class="k">global</span> <span class="n">aprint</span>
</span><span id="AirlineOperatingCentre-113"><a href="#AirlineOperatingCentre-113"><span class="linenos">113</span></a>		<span class="n">aprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-114"><a href="#AirlineOperatingCentre-114"><span class="linenos">114</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aprint</span> <span class="o">=</span> <span class="n">aprint</span>
</span><span id="AirlineOperatingCentre-115"><a href="#AirlineOperatingCentre-115"><span class="linenos">115</span></a>
</span><span id="AirlineOperatingCentre-116"><a href="#AirlineOperatingCentre-116"><span class="linenos">116</span></a>		<span class="k">global</span> <span class="n">mprint</span>
</span><span id="AirlineOperatingCentre-117"><a href="#AirlineOperatingCentre-117"><span class="linenos">117</span></a>		<span class="n">mprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-118"><a href="#AirlineOperatingCentre-118"><span class="linenos">118</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">mprint</span> <span class="o">=</span> <span class="n">mprint</span>
</span><span id="AirlineOperatingCentre-119"><a href="#AirlineOperatingCentre-119"><span class="linenos">119</span></a>
</span><span id="AirlineOperatingCentre-120"><a href="#AirlineOperatingCentre-120"><span class="linenos">120</span></a>	<span class="k">def</span> <span class="nf">average_missed_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-121"><a href="#AirlineOperatingCentre-121"><span class="linenos">121</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-122"><a href="#AirlineOperatingCentre-122"><span class="linenos">122</span></a><span class="sd">		Function to obtain average cost of passenger missing connection</span>
</span><span id="AirlineOperatingCentre-123"><a href="#AirlineOperatingCentre-123"><span class="linenos">123</span></a><span class="sd">		pax: passenger type</span>
</span><span id="AirlineOperatingCentre-124"><a href="#AirlineOperatingCentre-124"><span class="linenos">124</span></a>
</span><span id="AirlineOperatingCentre-125"><a href="#AirlineOperatingCentre-125"><span class="linenos">125</span></a><span class="sd">		TODO: cost now hard coded, at least passed as parameter</span>
</span><span id="AirlineOperatingCentre-126"><a href="#AirlineOperatingCentre-126"><span class="linenos">126</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-127"><a href="#AirlineOperatingCentre-127"><span class="linenos">127</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;economy&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-128"><a href="#AirlineOperatingCentre-128"><span class="linenos">128</span></a>			<span class="k">return</span> <span class="mf">1000.</span>
</span><span id="AirlineOperatingCentre-129"><a href="#AirlineOperatingCentre-129"><span class="linenos">129</span></a>		<span class="k">elif</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-130"><a href="#AirlineOperatingCentre-130"><span class="linenos">130</span></a>			<span class="k">return</span> <span class="mf">5000.</span>
</span><span id="AirlineOperatingCentre-131"><a href="#AirlineOperatingCentre-131"><span class="linenos">131</span></a>
</span><span id="AirlineOperatingCentre-132"><a href="#AirlineOperatingCentre-132"><span class="linenos">132</span></a>	<span class="k">def</span> <span class="nf">average_cost_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-133"><a href="#AirlineOperatingCentre-133"><span class="linenos">133</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-134"><a href="#AirlineOperatingCentre-134"><span class="linenos">134</span></a><span class="sd">		Very high-level/averaged, only to be used for rough estimation.</span>
</span><span id="AirlineOperatingCentre-135"><a href="#AirlineOperatingCentre-135"><span class="linenos">135</span></a>
</span><span id="AirlineOperatingCentre-136"><a href="#AirlineOperatingCentre-136"><span class="linenos">136</span></a><span class="sd">		delay: minutes of delay</span>
</span><span id="AirlineOperatingCentre-137"><a href="#AirlineOperatingCentre-137"><span class="linenos">137</span></a>
</span><span id="AirlineOperatingCentre-138"><a href="#AirlineOperatingCentre-138"><span class="linenos">138</span></a><span class="sd">		TODO: average cost now hard coded, at least passed as parameter</span>
</span><span id="AirlineOperatingCentre-139"><a href="#AirlineOperatingCentre-139"><span class="linenos">139</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-140"><a href="#AirlineOperatingCentre-140"><span class="linenos">140</span></a>
</span><span id="AirlineOperatingCentre-141"><a href="#AirlineOperatingCentre-141"><span class="linenos">141</span></a>		<span class="k">return</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">delay</span>
</span><span id="AirlineOperatingCentre-142"><a href="#AirlineOperatingCentre-142"><span class="linenos">142</span></a>
</span><span id="AirlineOperatingCentre-143"><a href="#AirlineOperatingCentre-143"><span class="linenos">143</span></a>	<span class="k">def</span> <span class="nf">get_reactionary_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-144"><a href="#AirlineOperatingCentre-144"><span class="linenos">144</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-145"><a href="#AirlineOperatingCentre-145"><span class="linenos">145</span></a><span class="sd">		Get reactionary buffer for a given flight, i.e., delay after which the propagation of the delay</span>
</span><span id="AirlineOperatingCentre-146"><a href="#AirlineOperatingCentre-146"><span class="linenos">146</span></a><span class="sd">		might trigger a breach of a curfew</span>
</span><span id="AirlineOperatingCentre-147"><a href="#AirlineOperatingCentre-147"><span class="linenos">147</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-148"><a href="#AirlineOperatingCentre-148"><span class="linenos">148</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre-149"><a href="#AirlineOperatingCentre-149"><span class="linenos">149</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-150"><a href="#AirlineOperatingCentre-150"><span class="linenos">150</span></a>
</span><span id="AirlineOperatingCentre-151"><a href="#AirlineOperatingCentre-151"><span class="linenos">151</span></a>	<span class="k">def</span> <span class="nf">get_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-152"><a href="#AirlineOperatingCentre-152"><span class="linenos">152</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-153"><a href="#AirlineOperatingCentre-153"><span class="linenos">153</span></a><span class="sd">		Get buffer for flight before reaching curfew. Using central registry.</span>
</span><span id="AirlineOperatingCentre-154"><a href="#AirlineOperatingCentre-154"><span class="linenos">154</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-155"><a href="#AirlineOperatingCentre-155"><span class="linenos">155</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre-156"><a href="#AirlineOperatingCentre-156"><span class="linenos">156</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-157"><a href="#AirlineOperatingCentre-157"><span class="linenos">157</span></a>
</span><span id="AirlineOperatingCentre-158"><a href="#AirlineOperatingCentre-158"><span class="linenos">158</span></a>	<span class="k">def</span> <span class="nf">get_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-159"><a href="#AirlineOperatingCentre-159"><span class="linenos">159</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-160"><a href="#AirlineOperatingCentre-160"><span class="linenos">160</span></a><span class="sd">		Get OBT of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-161"><a href="#AirlineOperatingCentre-161"><span class="linenos">161</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-162"><a href="#AirlineOperatingCentre-162"><span class="linenos">162</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre-163"><a href="#AirlineOperatingCentre-163"><span class="linenos">163</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-164"><a href="#AirlineOperatingCentre-164"><span class="linenos">164</span></a>
</span><span id="AirlineOperatingCentre-165"><a href="#AirlineOperatingCentre-165"><span class="linenos">165</span></a>	<span class="k">def</span> <span class="nf">get_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-166"><a href="#AirlineOperatingCentre-166"><span class="linenos">166</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-167"><a href="#AirlineOperatingCentre-167"><span class="linenos">167</span></a><span class="sd">		Get origin of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-168"><a href="#AirlineOperatingCentre-168"><span class="linenos">168</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-169"><a href="#AirlineOperatingCentre-169"><span class="linenos">169</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre-170"><a href="#AirlineOperatingCentre-170"><span class="linenos">170</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-171"><a href="#AirlineOperatingCentre-171"><span class="linenos">171</span></a>
</span><span id="AirlineOperatingCentre-172"><a href="#AirlineOperatingCentre-172"><span class="linenos">172</span></a>	<span class="k">def</span> <span class="nf">get_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-173"><a href="#AirlineOperatingCentre-173"><span class="linenos">173</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-174"><a href="#AirlineOperatingCentre-174"><span class="linenos">174</span></a><span class="sd">		Get destination of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-175"><a href="#AirlineOperatingCentre-175"><span class="linenos">175</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-176"><a href="#AirlineOperatingCentre-176"><span class="linenos">176</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre-177"><a href="#AirlineOperatingCentre-177"><span class="linenos">177</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-178"><a href="#AirlineOperatingCentre-178"><span class="linenos">178</span></a>
</span><span id="AirlineOperatingCentre-179"><a href="#AirlineOperatingCentre-179"><span class="linenos">179</span></a>	<span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-180"><a href="#AirlineOperatingCentre-180"><span class="linenos">180</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-181"><a href="#AirlineOperatingCentre-181"><span class="linenos">181</span></a><span class="sd">		Get flight status. Using central registry.</span>
</span><span id="AirlineOperatingCentre-182"><a href="#AirlineOperatingCentre-182"><span class="linenos">182</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-183"><a href="#AirlineOperatingCentre-183"><span class="linenos">183</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-184"><a href="#AirlineOperatingCentre-184"><span class="linenos">184</span></a>
</span><span id="AirlineOperatingCentre-185"><a href="#AirlineOperatingCentre-185"><span class="linenos">185</span></a>	<span class="k">def</span> <span class="nf">get_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-186"><a href="#AirlineOperatingCentre-186"><span class="linenos">186</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-187"><a href="#AirlineOperatingCentre-187"><span class="linenos">187</span></a><span class="sd">		Get pax to board a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-188"><a href="#AirlineOperatingCentre-188"><span class="linenos">188</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-189"><a href="#AirlineOperatingCentre-189"><span class="linenos">189</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-190"><a href="#AirlineOperatingCentre-190"><span class="linenos">190</span></a>
</span><span id="AirlineOperatingCentre-191"><a href="#AirlineOperatingCentre-191"><span class="linenos">191</span></a>	<span class="k">def</span> <span class="nf">get_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-192"><a href="#AirlineOperatingCentre-192"><span class="linenos">192</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-193"><a href="#AirlineOperatingCentre-193"><span class="linenos">193</span></a><span class="sd">		Get IBT of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-194"><a href="#AirlineOperatingCentre-194"><span class="linenos">194</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-195"><a href="#AirlineOperatingCentre-195"><span class="linenos">195</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-196"><a href="#AirlineOperatingCentre-196"><span class="linenos">196</span></a>
</span><span id="AirlineOperatingCentre-197"><a href="#AirlineOperatingCentre-197"><span class="linenos">197</span></a>	<span class="k">def</span> <span class="nf">get_mct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-198"><a href="#AirlineOperatingCentre-198"><span class="linenos">198</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-199"><a href="#AirlineOperatingCentre-199"><span class="linenos">199</span></a><span class="sd">		Get MCT between two flights for a given pax type. Using central registry.</span>
</span><span id="AirlineOperatingCentre-200"><a href="#AirlineOperatingCentre-200"><span class="linenos">200</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-201"><a href="#AirlineOperatingCentre-201"><span class="linenos">201</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-202"><a href="#AirlineOperatingCentre-202"><span class="linenos">202</span></a>
</span><span id="AirlineOperatingCentre-203"><a href="#AirlineOperatingCentre-203"><span class="linenos">203</span></a>	<span class="k">def</span> <span class="nf">get_airlines_in_alliance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-204"><a href="#AirlineOperatingCentre-204"><span class="linenos">204</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-205"><a href="#AirlineOperatingCentre-205"><span class="linenos">205</span></a><span class="sd">		Get alliance for the airline Using central registry.</span>
</span><span id="AirlineOperatingCentre-206"><a href="#AirlineOperatingCentre-206"><span class="linenos">206</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-207"><a href="#AirlineOperatingCentre-207"><span class="linenos">207</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">alliance_composition</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alliance</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre-208"><a href="#AirlineOperatingCentre-208"><span class="linenos">208</span></a>
</span><span id="AirlineOperatingCentre-209"><a href="#AirlineOperatingCentre-209"><span class="linenos">209</span></a>	<span class="k">def</span> <span class="nf">get_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-210"><a href="#AirlineOperatingCentre-210"><span class="linenos">210</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-211"><a href="#AirlineOperatingCentre-211"><span class="linenos">211</span></a><span class="sd">		Get flights for a given AOC. Using central registry.</span>
</span><span id="AirlineOperatingCentre-212"><a href="#AirlineOperatingCentre-212"><span class="linenos">212</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-213"><a href="#AirlineOperatingCentre-213"><span class="linenos">213</span></a>		<span class="c1"># TODO: move this to get_flights_of_other_airlines and how_flights go get_own_flights or get_flights</span>
</span><span id="AirlineOperatingCentre-214"><a href="#AirlineOperatingCentre-214"><span class="linenos">214</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-215"><a href="#AirlineOperatingCentre-215"><span class="linenos">215</span></a>
</span><span id="AirlineOperatingCentre-216"><a href="#AirlineOperatingCentre-216"><span class="linenos">216</span></a>	<span class="k">def</span> <span class="nf">get_all_airlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-217"><a href="#AirlineOperatingCentre-217"><span class="linenos">217</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-218"><a href="#AirlineOperatingCentre-218"><span class="linenos">218</span></a><span class="sd">		Get all airlines using central registry.</span>
</span><span id="AirlineOperatingCentre-219"><a href="#AirlineOperatingCentre-219"><span class="linenos">219</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-220"><a href="#AirlineOperatingCentre-220"><span class="linenos">220</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">()</span>
</span><span id="AirlineOperatingCentre-221"><a href="#AirlineOperatingCentre-221"><span class="linenos">221</span></a>
</span><span id="AirlineOperatingCentre-222"><a href="#AirlineOperatingCentre-222"><span class="linenos">222</span></a>	<span class="k">def</span> <span class="nf">get_airline_of_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-223"><a href="#AirlineOperatingCentre-223"><span class="linenos">223</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-224"><a href="#AirlineOperatingCentre-224"><span class="linenos">224</span></a><span class="sd">		Get airline for a given flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-225"><a href="#AirlineOperatingCentre-225"><span class="linenos">225</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-226"><a href="#AirlineOperatingCentre-226"><span class="linenos">226</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre-227"><a href="#AirlineOperatingCentre-227"><span class="linenos">227</span></a>
</span><span id="AirlineOperatingCentre-228"><a href="#AirlineOperatingCentre-228"><span class="linenos">228</span></a>	<span class="k">def</span> <span class="nf">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-229"><a href="#AirlineOperatingCentre-229"><span class="linenos">229</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-230"><a href="#AirlineOperatingCentre-230"><span class="linenos">230</span></a><span class="sd">		Returns a typical turnaround time based on the type of aircraft of flight_uid. Using central registry.</span>
</span><span id="AirlineOperatingCentre-231"><a href="#AirlineOperatingCentre-231"><span class="linenos">231</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-232"><a href="#AirlineOperatingCentre-232"><span class="linenos">232</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-233"><a href="#AirlineOperatingCentre-233"><span class="linenos">233</span></a>		<span class="c1"># aircraft = self.aoc_flights_info[flight_uid][&#39;aircraft&#39;]</span>
</span><span id="AirlineOperatingCentre-234"><a href="#AirlineOperatingCentre-234"><span class="linenos">234</span></a>		<span class="c1"># return self.aoc_airports_info[airport_uid][&#39;tats&#39;][aircraft.bada_performances.wtc][self.airline_type]</span>
</span><span id="AirlineOperatingCentre-235"><a href="#AirlineOperatingCentre-235"><span class="linenos">235</span></a>
</span><span id="AirlineOperatingCentre-236"><a href="#AirlineOperatingCentre-236"><span class="linenos">236</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-237"><a href="#AirlineOperatingCentre-237"><span class="linenos">237</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-238"><a href="#AirlineOperatingCentre-238"><span class="linenos">238</span></a><span class="sd">		Get number seats available for a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre-239"><a href="#AirlineOperatingCentre-239"><span class="linenos">239</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-240"><a href="#AirlineOperatingCentre-240"><span class="linenos">240</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-241"><a href="#AirlineOperatingCentre-241"><span class="linenos">241</span></a>
</span><span id="AirlineOperatingCentre-242"><a href="#AirlineOperatingCentre-242"><span class="linenos">242</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_itinerary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-243"><a href="#AirlineOperatingCentre-243"><span class="linenos">243</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-244"><a href="#AirlineOperatingCentre-244"><span class="linenos">244</span></a><span class="sd">		Get number seats available for a given itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre-245"><a href="#AirlineOperatingCentre-245"><span class="linenos">245</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-246"><a href="#AirlineOperatingCentre-246"><span class="linenos">246</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-247"><a href="#AirlineOperatingCentre-247"><span class="linenos">247</span></a>
</span><span id="AirlineOperatingCentre-248"><a href="#AirlineOperatingCentre-248"><span class="linenos">248</span></a>	<span class="k">def</span> <span class="nf">get_average_price_on_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-249"><a href="#AirlineOperatingCentre-249"><span class="linenos">249</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-250"><a href="#AirlineOperatingCentre-250"><span class="linenos">250</span></a><span class="sd">		This is computed using only the price paid by passengers without</span>
</span><span id="AirlineOperatingCentre-251"><a href="#AirlineOperatingCentre-251"><span class="linenos">251</span></a><span class="sd">		connection if possible. If there is none, use the number of legs as weight.</span>
</span><span id="AirlineOperatingCentre-252"><a href="#AirlineOperatingCentre-252"><span class="linenos">252</span></a><span class="sd">		Using the central registry</span>
</span><span id="AirlineOperatingCentre-253"><a href="#AirlineOperatingCentre-253"><span class="linenos">253</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-254"><a href="#AirlineOperatingCentre-254"><span class="linenos">254</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-255"><a href="#AirlineOperatingCentre-255"><span class="linenos">255</span></a>
</span><span id="AirlineOperatingCentre-256"><a href="#AirlineOperatingCentre-256"><span class="linenos">256</span></a>	<span class="k">def</span> <span class="nf">get_total_travelling_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-257"><a href="#AirlineOperatingCentre-257"><span class="linenos">257</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-258"><a href="#AirlineOperatingCentre-258"><span class="linenos">258</span></a><span class="sd">		Note: this assumes that the connections are feasible.</span>
</span><span id="AirlineOperatingCentre-259"><a href="#AirlineOperatingCentre-259"><span class="linenos">259</span></a><span class="sd">		Note: it uses the most up-to-date information.</span>
</span><span id="AirlineOperatingCentre-260"><a href="#AirlineOperatingCentre-260"><span class="linenos">260</span></a><span class="sd">		Using the central registry</span>
</span><span id="AirlineOperatingCentre-261"><a href="#AirlineOperatingCentre-261"><span class="linenos">261</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-262"><a href="#AirlineOperatingCentre-262"><span class="linenos">262</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-263"><a href="#AirlineOperatingCentre-263"><span class="linenos">263</span></a>
</span><span id="AirlineOperatingCentre-264"><a href="#AirlineOperatingCentre-264"><span class="linenos">264</span></a>	<span class="k">def</span> <span class="nf">get_last_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-265"><a href="#AirlineOperatingCentre-265"><span class="linenos">265</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-266"><a href="#AirlineOperatingCentre-266"><span class="linenos">266</span></a><span class="sd">		Get last IBT for an itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre-267"><a href="#AirlineOperatingCentre-267"><span class="linenos">267</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-268"><a href="#AirlineOperatingCentre-268"><span class="linenos">268</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-269"><a href="#AirlineOperatingCentre-269"><span class="linenos">269</span></a>
</span><span id="AirlineOperatingCentre-270"><a href="#AirlineOperatingCentre-270"><span class="linenos">270</span></a>	<span class="k">def</span> <span class="nf">get_first_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-271"><a href="#AirlineOperatingCentre-271"><span class="linenos">271</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-272"><a href="#AirlineOperatingCentre-272"><span class="linenos">272</span></a><span class="sd">		Get fist OBT for an itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre-273"><a href="#AirlineOperatingCentre-273"><span class="linenos">273</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-274"><a href="#AirlineOperatingCentre-274"><span class="linenos">274</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-275"><a href="#AirlineOperatingCentre-275"><span class="linenos">275</span></a>
</span><span id="AirlineOperatingCentre-276"><a href="#AirlineOperatingCentre-276"><span class="linenos">276</span></a>	<span class="k">def</span> <span class="nf">get_n_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-277"><a href="#AirlineOperatingCentre-277"><span class="linenos">277</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-278"><a href="#AirlineOperatingCentre-278"><span class="linenos">278</span></a><span class="sd">		Get number pax to board a flight.</span>
</span><span id="AirlineOperatingCentre-279"><a href="#AirlineOperatingCentre-279"><span class="linenos">279</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-280"><a href="#AirlineOperatingCentre-280"><span class="linenos">280</span></a>		<span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]])</span>
</span><span id="AirlineOperatingCentre-281"><a href="#AirlineOperatingCentre-281"><span class="linenos">281</span></a>
</span><span id="AirlineOperatingCentre-282"><a href="#AirlineOperatingCentre-282"><span class="linenos">282</span></a>	<span class="k">def</span> <span class="nf">give_duty_of_care_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty_of_care_func</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-283"><a href="#AirlineOperatingCentre-283"><span class="linenos">283</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-284"><a href="#AirlineOperatingCentre-284"><span class="linenos">284</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="AirlineOperatingCentre-285"><a href="#AirlineOperatingCentre-285"><span class="linenos">285</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="AirlineOperatingCentre-286"><a href="#AirlineOperatingCentre-286"><span class="linenos">286</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-287"><a href="#AirlineOperatingCentre-287"><span class="linenos">287</span></a>		<span class="c1"># self.duty_of_care = duty_of_care_func</span>
</span><span id="AirlineOperatingCentre-288"><a href="#AirlineOperatingCentre-288"><span class="linenos">288</span></a>
</span><span id="AirlineOperatingCentre-289"><a href="#AirlineOperatingCentre-289"><span class="linenos">289</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-290"><a href="#AirlineOperatingCentre-290"><span class="linenos">290</span></a>			<span class="k">return</span> <span class="n">duty_of_care_func</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineOperatingCentre-291"><a href="#AirlineOperatingCentre-291"><span class="linenos">291</span></a>
</span><span id="AirlineOperatingCentre-292"><a href="#AirlineOperatingCentre-292"><span class="linenos">292</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="AirlineOperatingCentre-293"><a href="#AirlineOperatingCentre-293"><span class="linenos">293</span></a>
</span><span id="AirlineOperatingCentre-294"><a href="#AirlineOperatingCentre-294"><span class="linenos">294</span></a>	<span class="k">def</span> <span class="nf">give_compensation_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compensation_func</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-295"><a href="#AirlineOperatingCentre-295"><span class="linenos">295</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-296"><a href="#AirlineOperatingCentre-296"><span class="linenos">296</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="AirlineOperatingCentre-297"><a href="#AirlineOperatingCentre-297"><span class="linenos">297</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="AirlineOperatingCentre-298"><a href="#AirlineOperatingCentre-298"><span class="linenos">298</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-299"><a href="#AirlineOperatingCentre-299"><span class="linenos">299</span></a>		<span class="c1"># self.compensation = compensation_func</span>
</span><span id="AirlineOperatingCentre-300"><a href="#AirlineOperatingCentre-300"><span class="linenos">300</span></a>
</span><span id="AirlineOperatingCentre-301"><a href="#AirlineOperatingCentre-301"><span class="linenos">301</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-302"><a href="#AirlineOperatingCentre-302"><span class="linenos">302</span></a>			<span class="k">return</span> <span class="n">compensation_func</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="AirlineOperatingCentre-303"><a href="#AirlineOperatingCentre-303"><span class="linenos">303</span></a>
</span><span id="AirlineOperatingCentre-304"><a href="#AirlineOperatingCentre-304"><span class="linenos">304</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="AirlineOperatingCentre-305"><a href="#AirlineOperatingCentre-305"><span class="linenos">305</span></a>
</span><span id="AirlineOperatingCentre-306"><a href="#AirlineOperatingCentre-306"><span class="linenos">306</span></a>		<span class="c1"># The following is for quick computation (but is approximated).</span>
</span><span id="AirlineOperatingCentre-307"><a href="#AirlineOperatingCentre-307"><span class="linenos">307</span></a>		<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mf">60.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-308"><a href="#AirlineOperatingCentre-308"><span class="linenos">308</span></a>		<span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4000.</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-309"><a href="#AirlineOperatingCentre-309"><span class="linenos">309</span></a>		<span class="n">compensation_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">compensation_func</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xx</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">])</span>
</span><span id="AirlineOperatingCentre-310"><a href="#AirlineOperatingCentre-310"><span class="linenos">310</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation_quick</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">delay</span><span class="o">&lt;</span><span class="mf">0.</span> <span class="k">else</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="o">*</span><span class="n">compensation_values</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">399</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="o">/</span><span class="mi">10</span><span class="p">))][</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay</span><span class="p">))]</span>
</span><span id="AirlineOperatingCentre-311"><a href="#AirlineOperatingCentre-311"><span class="linenos">311</span></a>
</span><span id="AirlineOperatingCentre-312"><a href="#AirlineOperatingCentre-312"><span class="linenos">312</span></a>	<span class="k">def</span> <span class="nf">give_non_pax_cost_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-313"><a href="#AirlineOperatingCentre-313"><span class="linenos">313</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-314"><a href="#AirlineOperatingCentre-314"><span class="linenos">314</span></a><span class="sd">		For &#39;dict_np_cost&#39;, the first level key should be the type of aircraft.</span>
</span><span id="AirlineOperatingCentre-315"><a href="#AirlineOperatingCentre-315"><span class="linenos">315</span></a><span class="sd">		The second level key be the phase of flight:</span>
</span><span id="AirlineOperatingCentre-316"><a href="#AirlineOperatingCentre-316"><span class="linenos">316</span></a><span class="sd">		-at_gate,</span>
</span><span id="AirlineOperatingCentre-317"><a href="#AirlineOperatingCentre-317"><span class="linenos">317</span></a><span class="sd">		-taxi,</span>
</span><span id="AirlineOperatingCentre-318"><a href="#AirlineOperatingCentre-318"><span class="linenos">318</span></a><span class="sd">		-airborne</span>
</span><span id="AirlineOperatingCentre-319"><a href="#AirlineOperatingCentre-319"><span class="linenos">319</span></a><span class="sd">		The values are the cost (in euros) per minute of a delay.</span>
</span><span id="AirlineOperatingCentre-320"><a href="#AirlineOperatingCentre-320"><span class="linenos">320</span></a>
</span><span id="AirlineOperatingCentre-321"><a href="#AirlineOperatingCentre-321"><span class="linenos">321</span></a><span class="sd">		For &#39;dict_np_cost_fit&#39;, the first level should the phase of flight. The second</span>
</span><span id="AirlineOperatingCentre-322"><a href="#AirlineOperatingCentre-322"><span class="linenos">322</span></a><span class="sd">		level should have &#39;a&#39; and &#39;b&#39;. These coefficients should used when the aircraft type</span>
</span><span id="AirlineOperatingCentre-323"><a href="#AirlineOperatingCentre-323"><span class="linenos">323</span></a><span class="sd">		if no available in the first dictionary, using the sqrt of the MTOW of the aircraft:</span>
</span><span id="AirlineOperatingCentre-324"><a href="#AirlineOperatingCentre-324"><span class="linenos">324</span></a><span class="sd">		c = a + b * sqrt(MTWO),</span>
</span><span id="AirlineOperatingCentre-325"><a href="#AirlineOperatingCentre-325"><span class="linenos">325</span></a><span class="sd">		where c is the cost of one minute of delay, as per above.</span>
</span><span id="AirlineOperatingCentre-326"><a href="#AirlineOperatingCentre-326"><span class="linenos">326</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-327"><a href="#AirlineOperatingCentre-327"><span class="linenos">327</span></a>
</span><span id="AirlineOperatingCentre-328"><a href="#AirlineOperatingCentre-328"><span class="linenos">328</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-329"><a href="#AirlineOperatingCentre-329"><span class="linenos">329</span></a>			<span class="k">if</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span> <span class="ow">in</span> <span class="n">dict_np_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineOperatingCentre-330"><a href="#AirlineOperatingCentre-330"><span class="linenos">330</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-331"><a href="#AirlineOperatingCentre-331"><span class="linenos">331</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-332"><a href="#AirlineOperatingCentre-332"><span class="linenos">332</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-333"><a href="#AirlineOperatingCentre-333"><span class="linenos">333</span></a>
</span><span id="AirlineOperatingCentre-334"><a href="#AirlineOperatingCentre-334"><span class="linenos">334</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="AirlineOperatingCentre-335"><a href="#AirlineOperatingCentre-335"><span class="linenos">335</span></a>
</span><span id="AirlineOperatingCentre-336"><a href="#AirlineOperatingCentre-336"><span class="linenos">336</span></a>	<span class="k">def</span> <span class="nf">give_delay_distr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-337"><a href="#AirlineOperatingCentre-337"><span class="linenos">337</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-338"><a href="#AirlineOperatingCentre-338"><span class="linenos">338</span></a><span class="sd">		random numbers following dist should be drawn using dist.rvs(random_state=self.agent.rs) or dist.rvs(5)</span>
</span><span id="AirlineOperatingCentre-339"><a href="#AirlineOperatingCentre-339"><span class="linenos">339</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-340"><a href="#AirlineOperatingCentre-340"><span class="linenos">340</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="n">dist</span>
</span><span id="AirlineOperatingCentre-341"><a href="#AirlineOperatingCentre-341"><span class="linenos">341</span></a>
</span><span id="AirlineOperatingCentre-342"><a href="#AirlineOperatingCentre-342"><span class="linenos">342</span></a>	<span class="k">def</span> <span class="nf">own_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-343"><a href="#AirlineOperatingCentre-343"><span class="linenos">343</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-344"><a href="#AirlineOperatingCentre-344"><span class="linenos">344</span></a><span class="sd">		Get list of own flight by the airline</span>
</span><span id="AirlineOperatingCentre-345"><a href="#AirlineOperatingCentre-345"><span class="linenos">345</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-346"><a href="#AirlineOperatingCentre-346"><span class="linenos">346</span></a>		<span class="c1"># Merge with get_flights...</span>
</span><span id="AirlineOperatingCentre-347"><a href="#AirlineOperatingCentre-347"><span class="linenos">347</span></a>		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="AirlineOperatingCentre-348"><a href="#AirlineOperatingCentre-348"><span class="linenos">348</span></a>
</span><span id="AirlineOperatingCentre-349"><a href="#AirlineOperatingCentre-349"><span class="linenos">349</span></a>	<span class="k">def</span> <span class="nf">register_list_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-350"><a href="#AirlineOperatingCentre-350"><span class="linenos">350</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-351"><a href="#AirlineOperatingCentre-351"><span class="linenos">351</span></a><span class="sd">		Register list of aircraft in AOC</span>
</span><span id="AirlineOperatingCentre-352"><a href="#AirlineOperatingCentre-352"><span class="linenos">352</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-353"><a href="#AirlineOperatingCentre-353"><span class="linenos">353</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="n">aircraft</span>
</span><span id="AirlineOperatingCentre-354"><a href="#AirlineOperatingCentre-354"><span class="linenos">354</span></a>
</span><span id="AirlineOperatingCentre-355"><a href="#AirlineOperatingCentre-355"><span class="linenos">355</span></a>	<span class="k">def</span> <span class="nf">register_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-356"><a href="#AirlineOperatingCentre-356"><span class="linenos">356</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-357"><a href="#AirlineOperatingCentre-357"><span class="linenos">357</span></a><span class="sd">		Add one aircraft to the list of aircraft registered in the AOC</span>
</span><span id="AirlineOperatingCentre-358"><a href="#AirlineOperatingCentre-358"><span class="linenos">358</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-359"><a href="#AirlineOperatingCentre-359"><span class="linenos">359</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aircraft</span>
</span><span id="AirlineOperatingCentre-360"><a href="#AirlineOperatingCentre-360"><span class="linenos">360</span></a>
</span><span id="AirlineOperatingCentre-361"><a href="#AirlineOperatingCentre-361"><span class="linenos">361</span></a>	<span class="k">def</span> <span class="nf">register_airport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-362"><a href="#AirlineOperatingCentre-362"><span class="linenos">362</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-363"><a href="#AirlineOperatingCentre-363"><span class="linenos">363</span></a><span class="sd">		Add one airport to the list of airports in the AOC</span>
</span><span id="AirlineOperatingCentre-364"><a href="#AirlineOperatingCentre-364"><span class="linenos">364</span></a>
</span><span id="AirlineOperatingCentre-365"><a href="#AirlineOperatingCentre-365"><span class="linenos">365</span></a><span class="sd">		mcts are designed so that one can do:</span>
</span><span id="AirlineOperatingCentre-366"><a href="#AirlineOperatingCentre-366"><span class="linenos">366</span></a><span class="sd">		mcts = self.aoc_airports_info[airport_uid][&#39;mcts&#39;]</span>
</span><span id="AirlineOperatingCentre-367"><a href="#AirlineOperatingCentre-367"><span class="linenos">367</span></a><span class="sd">		mct = mcts[(self.aoc_flights_info[flight_uid1][&#39;international&#39;], self.aoc_flights_info[flight_uid2][&#39;international&#39;])]</span>
</span><span id="AirlineOperatingCentre-368"><a href="#AirlineOperatingCentre-368"><span class="linenos">368</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-369"><a href="#AirlineOperatingCentre-369"><span class="linenos">369</span></a>
</span><span id="AirlineOperatingCentre-370"><a href="#AirlineOperatingCentre-370"><span class="linenos">370</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">airport</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mcts&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">mcts</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-371"><a href="#AirlineOperatingCentre-371"><span class="linenos">371</span></a>												<span class="s1">&#39;tats&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">tats</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-372"><a href="#AirlineOperatingCentre-372"><span class="linenos">372</span></a>												<span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_out_time</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-373"><a href="#AirlineOperatingCentre-373"><span class="linenos">373</span></a>												<span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_in_time</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-374"><a href="#AirlineOperatingCentre-374"><span class="linenos">374</span></a>												<span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-375"><a href="#AirlineOperatingCentre-375"><span class="linenos">375</span></a>												<span class="s1">&#39;dman_uid&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">dman_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-376"><a href="#AirlineOperatingCentre-376"><span class="linenos">376</span></a>												<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">curfew</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-377"><a href="#AirlineOperatingCentre-377"><span class="linenos">377</span></a>												<span class="s1">&#39;ICAO&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">icao</span><span class="p">}</span>
</span><span id="AirlineOperatingCentre-378"><a href="#AirlineOperatingCentre-378"><span class="linenos">378</span></a>
</span><span id="AirlineOperatingCentre-379"><a href="#AirlineOperatingCentre-379"><span class="linenos">379</span></a>	<span class="k">def</span> <span class="nf">register_pax_itinerary_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-380"><a href="#AirlineOperatingCentre-380"><span class="linenos">380</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-381"><a href="#AirlineOperatingCentre-381"><span class="linenos">381</span></a><span class="sd">		Register pax group (with its itineraries) in the airline</span>
</span><span id="AirlineOperatingCentre-382"><a href="#AirlineOperatingCentre-382"><span class="linenos">382</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-383"><a href="#AirlineOperatingCentre-383"><span class="linenos">383</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="AirlineOperatingCentre-384"><a href="#AirlineOperatingCentre-384"><span class="linenos">384</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineOperatingCentre-385"><a href="#AirlineOperatingCentre-385"><span class="linenos">385</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-386"><a href="#AirlineOperatingCentre-386"><span class="linenos">386</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board_initial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-387"><a href="#AirlineOperatingCentre-387"><span class="linenos">387</span></a>
</span><span id="AirlineOperatingCentre-388"><a href="#AirlineOperatingCentre-388"><span class="linenos">388</span></a>	<span class="k">def</span> <span class="nf">register_trajectories_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_pool</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-389"><a href="#AirlineOperatingCentre-389"><span class="linenos">389</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-390"><a href="#AirlineOperatingCentre-390"><span class="linenos">390</span></a><span class="sd">		Register pool of trajectories. If generating FP on the fly</span>
</span><span id="AirlineOperatingCentre-391"><a href="#AirlineOperatingCentre-391"><span class="linenos">391</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-392"><a href="#AirlineOperatingCentre-392"><span class="linenos">392</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="n">trajectory_pool</span>
</span><span id="AirlineOperatingCentre-393"><a href="#AirlineOperatingCentre-393"><span class="linenos">393</span></a>
</span><span id="AirlineOperatingCentre-394"><a href="#AirlineOperatingCentre-394"><span class="linenos">394</span></a>	<span class="k">def</span> <span class="nf">register_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp_pool</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-395"><a href="#AirlineOperatingCentre-395"><span class="linenos">395</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-396"><a href="#AirlineOperatingCentre-396"><span class="linenos">396</span></a><span class="sd">		Register poool of flight plans.</span>
</span><span id="AirlineOperatingCentre-397"><a href="#AirlineOperatingCentre-397"><span class="linenos">397</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-398"><a href="#AirlineOperatingCentre-398"><span class="linenos">398</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="n">fp_pool</span>
</span><span id="AirlineOperatingCentre-399"><a href="#AirlineOperatingCentre-399"><span class="linenos">399</span></a>
</span><span id="AirlineOperatingCentre-400"><a href="#AirlineOperatingCentre-400"><span class="linenos">400</span></a>	<span class="k">def</span> <span class="nf">register_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-401"><a href="#AirlineOperatingCentre-401"><span class="linenos">401</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-402"><a href="#AirlineOperatingCentre-402"><span class="linenos">402</span></a><span class="sd">		Register NetworkManager</span>
</span><span id="AirlineOperatingCentre-403"><a href="#AirlineOperatingCentre-403"><span class="linenos">403</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-404"><a href="#AirlineOperatingCentre-404"><span class="linenos">404</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineOperatingCentre-405"><a href="#AirlineOperatingCentre-405"><span class="linenos">405</span></a>	
</span><span id="AirlineOperatingCentre-406"><a href="#AirlineOperatingCentre-406"><span class="linenos">406</span></a>	<span class="k">def</span> <span class="nf">register_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-407"><a href="#AirlineOperatingCentre-407"><span class="linenos">407</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-408"><a href="#AirlineOperatingCentre-408"><span class="linenos">408</span></a><span class="sd">		Register a flight in the AOC.</span>
</span><span id="AirlineOperatingCentre-409"><a href="#AirlineOperatingCentre-409"><span class="linenos">409</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-410"><a href="#AirlineOperatingCentre-410"><span class="linenos">410</span></a>
</span><span id="AirlineOperatingCentre-411"><a href="#AirlineOperatingCentre-411"><span class="linenos">411</span></a>		<span class="c1"># Give DMAN id to flight</span>
</span><span id="AirlineOperatingCentre-412"><a href="#AirlineOperatingCentre-412"><span class="linenos">412</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">dman_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;dman_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre-413"><a href="#AirlineOperatingCentre-413"><span class="linenos">413</span></a>
</span><span id="AirlineOperatingCentre-414"><a href="#AirlineOperatingCentre-414"><span class="linenos">414</span></a>		<span class="c1"># # Add flight to the list that the aircraft needs to operate</span>
</span><span id="AirlineOperatingCentre-415"><a href="#AirlineOperatingCentre-415"><span class="linenos">415</span></a>		<span class="c1"># self.aircraft_list[flight.ac_uid].add_flight(flight.uid)</span>
</span><span id="AirlineOperatingCentre-416"><a href="#AirlineOperatingCentre-416"><span class="linenos">416</span></a>
</span><span id="AirlineOperatingCentre-417"><a href="#AirlineOperatingCentre-417"><span class="linenos">417</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AirlineOperatingCentre-418"><a href="#AirlineOperatingCentre-418"><span class="linenos">418</span></a>									<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-419"><a href="#AirlineOperatingCentre-419"><span class="linenos">419</span></a>									<span class="s1">&#39;flight_db_id&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-420"><a href="#AirlineOperatingCentre-420"><span class="linenos">420</span></a>									<span class="s1">&#39;callsign&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">callsign</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-421"><a href="#AirlineOperatingCentre-421"><span class="linenos">421</span></a>									<span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;scheduled&#39;</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-422"><a href="#AirlineOperatingCentre-422"><span class="linenos">422</span></a>									<span class="s1">&#39;international&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">international</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-423"><a href="#AirlineOperatingCentre-423"><span class="linenos">423</span></a>
</span><span id="AirlineOperatingCentre-424"><a href="#AirlineOperatingCentre-424"><span class="linenos">424</span></a>									<span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-425"><a href="#AirlineOperatingCentre-425"><span class="linenos">425</span></a>									<span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">destination_airport_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-426"><a href="#AirlineOperatingCentre-426"><span class="linenos">426</span></a>
</span><span id="AirlineOperatingCentre-427"><a href="#AirlineOperatingCentre-427"><span class="linenos">427</span></a>									<span class="s1">&#39;sobt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sobt</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre-428"><a href="#AirlineOperatingCentre-428"><span class="linenos">428</span></a>									<span class="s1">&#39;sibt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sibt</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre-429"><a href="#AirlineOperatingCentre-429"><span class="linenos">429</span></a>									<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">curfew</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre-430"><a href="#AirlineOperatingCentre-430"><span class="linenos">430</span></a>									<span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">can_propagate_to_curfew</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre-431"><a href="#AirlineOperatingCentre-431"><span class="linenos">431</span></a>
</span><span id="AirlineOperatingCentre-432"><a href="#AirlineOperatingCentre-432"><span class="linenos">432</span></a>									<span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">],</span>
</span><span id="AirlineOperatingCentre-433"><a href="#AirlineOperatingCentre-433"><span class="linenos">433</span></a>
</span><span id="AirlineOperatingCentre-434"><a href="#AirlineOperatingCentre-434"><span class="linenos">434</span></a>									<span class="s1">&#39;fp_options&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-435"><a href="#AirlineOperatingCentre-435"><span class="linenos">435</span></a>									<span class="s1">&#39;fp_option&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-436"><a href="#AirlineOperatingCentre-436"><span class="linenos">436</span></a>									<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-437"><a href="#AirlineOperatingCentre-437"><span class="linenos">437</span></a>									<span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-438"><a href="#AirlineOperatingCentre-438"><span class="linenos">438</span></a>									<span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-439"><a href="#AirlineOperatingCentre-439"><span class="linenos">439</span></a>
</span><span id="AirlineOperatingCentre-440"><a href="#AirlineOperatingCentre-440"><span class="linenos">440</span></a>									<span class="s2">&quot;pax_to_board_initial&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-441"><a href="#AirlineOperatingCentre-441"><span class="linenos">441</span></a>									<span class="s2">&quot;pax_to_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-442"><a href="#AirlineOperatingCentre-442"><span class="linenos">442</span></a>									<span class="s2">&quot;pax_on_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-443"><a href="#AirlineOperatingCentre-443"><span class="linenos">443</span></a>
</span><span id="AirlineOperatingCentre-444"><a href="#AirlineOperatingCentre-444"><span class="linenos">444</span></a>									<span class="c1"># pax lists for waiting pax</span>
</span><span id="AirlineOperatingCentre-445"><a href="#AirlineOperatingCentre-445"><span class="linenos">445</span></a>									<span class="s2">&quot;pax_ready_to_board_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-446"><a href="#AirlineOperatingCentre-446"><span class="linenos">446</span></a>									<span class="s2">&quot;pax_to_wait_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre-447"><a href="#AirlineOperatingCentre-447"><span class="linenos">447</span></a>									<span class="s2">&quot;pax_check_already_performed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-448"><a href="#AirlineOperatingCentre-448"><span class="linenos">448</span></a>
</span><span id="AirlineOperatingCentre-449"><a href="#AirlineOperatingCentre-449"><span class="linenos">449</span></a>									<span class="s1">&#39;FP_submission_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-450"><a href="#AirlineOperatingCentre-450"><span class="linenos">450</span></a>									<span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-451"><a href="#AirlineOperatingCentre-451"><span class="linenos">451</span></a>									<span class="s1">&#39;push_back_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-452"><a href="#AirlineOperatingCentre-452"><span class="linenos">452</span></a>									<span class="s1">&#39;pax_check_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-453"><a href="#AirlineOperatingCentre-453"><span class="linenos">453</span></a>									<span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-454"><a href="#AirlineOperatingCentre-454"><span class="linenos">454</span></a>									<span class="s1">&#39;takeoff_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">takeoff_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-455"><a href="#AirlineOperatingCentre-455"><span class="linenos">455</span></a>
</span><span id="AirlineOperatingCentre-456"><a href="#AirlineOperatingCentre-456"><span class="linenos">456</span></a>									<span class="s1">&#39;DOC&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-457"><a href="#AirlineOperatingCentre-457"><span class="linenos">457</span></a>									<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-458"><a href="#AirlineOperatingCentre-458"><span class="linenos">458</span></a>									<span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-459"><a href="#AirlineOperatingCentre-459"><span class="linenos">459</span></a>									<span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-460"><a href="#AirlineOperatingCentre-460"><span class="linenos">460</span></a>									<span class="s1">&#39;non_pax_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-461"><a href="#AirlineOperatingCentre-461"><span class="linenos">461</span></a>									<span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-462"><a href="#AirlineOperatingCentre-462"><span class="linenos">462</span></a>
</span><span id="AirlineOperatingCentre-463"><a href="#AirlineOperatingCentre-463"><span class="linenos">463</span></a>									<span class="s1">&#39;main_reason_delay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-464"><a href="#AirlineOperatingCentre-464"><span class="linenos">464</span></a>
</span><span id="AirlineOperatingCentre-465"><a href="#AirlineOperatingCentre-465"><span class="linenos">465</span></a>									<span class="c1"># &#39;flight_swaps&#39;:[],</span>
</span><span id="AirlineOperatingCentre-466"><a href="#AirlineOperatingCentre-466"><span class="linenos">466</span></a>									<span class="c1"># &#39;cost_swaps&#39;:[],</span>
</span><span id="AirlineOperatingCentre-467"><a href="#AirlineOperatingCentre-467"><span class="linenos">467</span></a>									<span class="c1"># &#39;id_swaps&#39;:[]</span>
</span><span id="AirlineOperatingCentre-468"><a href="#AirlineOperatingCentre-468"><span class="linenos">468</span></a>									<span class="p">}</span>
</span><span id="AirlineOperatingCentre-469"><a href="#AirlineOperatingCentre-469"><span class="linenos">469</span></a>
</span><span id="AirlineOperatingCentre-470"><a href="#AirlineOperatingCentre-470"><span class="linenos">470</span></a>		<span class="c1"># Give aircraft to flight</span>
</span><span id="AirlineOperatingCentre-471"><a href="#AirlineOperatingCentre-471"><span class="linenos">471</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre-472"><a href="#AirlineOperatingCentre-472"><span class="linenos">472</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span><span class="o">.</span><span class="n">add_flight</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-473"><a href="#AirlineOperatingCentre-473"><span class="linenos">473</span></a>
</span><span id="AirlineOperatingCentre-474"><a href="#AirlineOperatingCentre-474"><span class="linenos">474</span></a>		<span class="c1"># Give some info to flight on airline</span>
</span><span id="AirlineOperatingCentre-475"><a href="#AirlineOperatingCentre-475"><span class="linenos">475</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="AirlineOperatingCentre-476"><a href="#AirlineOperatingCentre-476"><span class="linenos">476</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_icao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="AirlineOperatingCentre-477"><a href="#AirlineOperatingCentre-477"><span class="linenos">477</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;aoc_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineOperatingCentre-478"><a href="#AirlineOperatingCentre-478"><span class="linenos">478</span></a>
</span><span id="AirlineOperatingCentre-479"><a href="#AirlineOperatingCentre-479"><span class="linenos">479</span></a>		<span class="c1"># Using wait_until allows to wait for a time and then succeed the event.</span>
</span><span id="AirlineOperatingCentre-480"><a href="#AirlineOperatingCentre-480"><span class="linenos">480</span></a>		<span class="c1"># The event should not be the process itself, because if a reschedule</span>
</span><span id="AirlineOperatingCentre-481"><a href="#AirlineOperatingCentre-481"><span class="linenos">481</span></a>		<span class="c1"># happens, one needs to cancel the wait_until process but keep the pointer</span>
</span><span id="AirlineOperatingCentre-482"><a href="#AirlineOperatingCentre-482"><span class="linenos">482</span></a>		<span class="c1"># to the event itself, since it is likely to be shared with other agents.</span>
</span><span id="AirlineOperatingCentre-483"><a href="#AirlineOperatingCentre-483"><span class="linenos">483</span></a>		<span class="c1"># This procedure should be used for anything with a waiting time (which may be rescheduled).</span>
</span><span id="AirlineOperatingCentre-484"><a href="#AirlineOperatingCentre-484"><span class="linenos">484</span></a>		<span class="c1"># There is no need for this in the case of the event happens at the end of a given process</span>
</span><span id="AirlineOperatingCentre-485"><a href="#AirlineOperatingCentre-485"><span class="linenos">485</span></a>		<span class="c1"># (e.g. flying a segment).</span>
</span><span id="AirlineOperatingCentre-486"><a href="#AirlineOperatingCentre-486"><span class="linenos">486</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre-487"><a href="#AirlineOperatingCentre-487"><span class="linenos">487</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre-488"><a href="#AirlineOperatingCentre-488"><span class="linenos">488</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre-489"><a href="#AirlineOperatingCentre-489"><span class="linenos">489</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre-490"><a href="#AirlineOperatingCentre-490"><span class="linenos">490</span></a>
</span><span id="AirlineOperatingCentre-491"><a href="#AirlineOperatingCentre-491"><span class="linenos">491</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-492"><a href="#AirlineOperatingCentre-492"><span class="linenos">492</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-493"><a href="#AirlineOperatingCentre-493"><span class="linenos">493</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_pax_ready_to_board</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-494"><a href="#AirlineOperatingCentre-494"><span class="linenos">494</span></a>
</span><span id="AirlineOperatingCentre-495"><a href="#AirlineOperatingCentre-495"><span class="linenos">495</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-496"><a href="#AirlineOperatingCentre-496"><span class="linenos">496</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-497"><a href="#AirlineOperatingCentre-497"><span class="linenos">497</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_arrival</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">arrival_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-498"><a href="#AirlineOperatingCentre-498"><span class="linenos">498</span></a>
</span><span id="AirlineOperatingCentre-499"><a href="#AirlineOperatingCentre-499"><span class="linenos">499</span></a>		<span class="c1"># for dci</span>
</span><span id="AirlineOperatingCentre-500"><a href="#AirlineOperatingCentre-500"><span class="linenos">500</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">cost_index_assessment</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre-501"><a href="#AirlineOperatingCentre-501"><span class="linenos">501</span></a>
</span><span id="AirlineOperatingCentre-502"><a href="#AirlineOperatingCentre-502"><span class="linenos">502</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># for connecting pax wait!</span>
</span><span id="AirlineOperatingCentre-503"><a href="#AirlineOperatingCentre-503"><span class="linenos">503</span></a>													<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre-504"><a href="#AirlineOperatingCentre-504"><span class="linenos">504</span></a>													<span class="p">}</span>
</span><span id="AirlineOperatingCentre-505"><a href="#AirlineOperatingCentre-505"><span class="linenos">505</span></a>
</span><span id="AirlineOperatingCentre-506"><a href="#AirlineOperatingCentre-506"><span class="linenos">506</span></a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-507"><a href="#AirlineOperatingCentre-507"><span class="linenos">507</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-508"><a href="#AirlineOperatingCentre-508"><span class="linenos">508</span></a><span class="sd">		Receive and distribute messages within the Agent</span>
</span><span id="AirlineOperatingCentre-509"><a href="#AirlineOperatingCentre-509"><span class="linenos">509</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-510"><a href="#AirlineOperatingCentre-510"><span class="linenos">510</span></a>
</span><span id="AirlineOperatingCentre-511"><a href="#AirlineOperatingCentre-511"><span class="linenos">511</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;allocation_pax_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-512"><a href="#AirlineOperatingCentre-512"><span class="linenos">512</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_allocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-513"><a href="#AirlineOperatingCentre-513"><span class="linenos">513</span></a>
</span><span id="AirlineOperatingCentre-514"><a href="#AirlineOperatingCentre-514"><span class="linenos">514</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;connecting_times&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-515"><a href="#AirlineOperatingCentre-515"><span class="linenos">515</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_connecting_times</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-516"><a href="#AirlineOperatingCentre-516"><span class="linenos">516</span></a>
</span><span id="AirlineOperatingCentre-517"><a href="#AirlineOperatingCentre-517"><span class="linenos">517</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-518"><a href="#AirlineOperatingCentre-518"><span class="linenos">518</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-519"><a href="#AirlineOperatingCentre-519"><span class="linenos">519</span></a>
</span><span id="AirlineOperatingCentre-520"><a href="#AirlineOperatingCentre-520"><span class="linenos">520</span></a>		<span class="c1"># elif msg[&#39;type&#39;] == &#39;flight_plan_request&#39;:</span>
</span><span id="AirlineOperatingCentre-521"><a href="#AirlineOperatingCentre-521"><span class="linenos">521</span></a>		<span class="c1"># 	self.afp.wait_for_FP_request(msg)</span>
</span><span id="AirlineOperatingCentre-522"><a href="#AirlineOperatingCentre-522"><span class="linenos">522</span></a>
</span><span id="AirlineOperatingCentre-523"><a href="#AirlineOperatingCentre-523"><span class="linenos">523</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_plan_acceptance&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-524"><a href="#AirlineOperatingCentre-524"><span class="linenos">524</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_FP_acceptance</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-525"><a href="#AirlineOperatingCentre-525"><span class="linenos">525</span></a>
</span><span id="AirlineOperatingCentre-526"><a href="#AirlineOperatingCentre-526"><span class="linenos">526</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;atfm_delay&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-527"><a href="#AirlineOperatingCentre-527"><span class="linenos">527</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_atfm_slot</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-528"><a href="#AirlineOperatingCentre-528"><span class="linenos">528</span></a>
</span><span id="AirlineOperatingCentre-529"><a href="#AirlineOperatingCentre-529"><span class="linenos">529</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;turnaround_time&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-530"><a href="#AirlineOperatingCentre-530"><span class="linenos">530</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">wait_for_turnaround_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-531"><a href="#AirlineOperatingCentre-531"><span class="linenos">531</span></a>
</span><span id="AirlineOperatingCentre-532"><a href="#AirlineOperatingCentre-532"><span class="linenos">532</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;departing_reassessment_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-533"><a href="#AirlineOperatingCentre-533"><span class="linenos">533</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-534"><a href="#AirlineOperatingCentre-534"><span class="linenos">534</span></a>
</span><span id="AirlineOperatingCentre-535"><a href="#AirlineOperatingCentre-535"><span class="linenos">535</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pax_connection_handling&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-536"><a href="#AirlineOperatingCentre-536"><span class="linenos">536</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-537"><a href="#AirlineOperatingCentre-537"><span class="linenos">537</span></a>
</span><span id="AirlineOperatingCentre-538"><a href="#AirlineOperatingCentre-538"><span class="linenos">538</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-539"><a href="#AirlineOperatingCentre-539"><span class="linenos">539</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-540"><a href="#AirlineOperatingCentre-540"><span class="linenos">540</span></a>
</span><span id="AirlineOperatingCentre-541"><a href="#AirlineOperatingCentre-541"><span class="linenos">541</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cost_blame&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-542"><a href="#AirlineOperatingCentre-542"><span class="linenos">542</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_cost_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-543"><a href="#AirlineOperatingCentre-543"><span class="linenos">543</span></a>
</span><span id="AirlineOperatingCentre-544"><a href="#AirlineOperatingCentre-544"><span class="linenos">544</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;follow_blame&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-545"><a href="#AirlineOperatingCentre-545"><span class="linenos">545</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_follow_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-546"><a href="#AirlineOperatingCentre-546"><span class="linenos">546</span></a>
</span><span id="AirlineOperatingCentre-547"><a href="#AirlineOperatingCentre-547"><span class="linenos">547</span></a>		<span class="c1"># wfp &amp; dci</span>
</span><span id="AirlineOperatingCentre-548"><a href="#AirlineOperatingCentre-548"><span class="linenos">548</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_flight_plan&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-549"><a href="#AirlineOperatingCentre-549"><span class="linenos">549</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-550"><a href="#AirlineOperatingCentre-550"><span class="linenos">550</span></a>
</span><span id="AirlineOperatingCentre-551"><a href="#AirlineOperatingCentre-551"><span class="linenos">551</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-552"><a href="#AirlineOperatingCentre-552"><span class="linenos">552</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-553"><a href="#AirlineOperatingCentre-553"><span class="linenos">553</span></a>
</span><span id="AirlineOperatingCentre-554"><a href="#AirlineOperatingCentre-554"><span class="linenos">554</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_potential_delay_recover_information&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-555"><a href="#AirlineOperatingCentre-555"><span class="linenos">555</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-556"><a href="#AirlineOperatingCentre-556"><span class="linenos">556</span></a>
</span><span id="AirlineOperatingCentre-557"><a href="#AirlineOperatingCentre-557"><span class="linenos">557</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;toc_reached&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-558"><a href="#AirlineOperatingCentre-558"><span class="linenos">558</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_toc_reached_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-559"><a href="#AirlineOperatingCentre-559"><span class="linenos">559</span></a>
</span><span id="AirlineOperatingCentre-560"><a href="#AirlineOperatingCentre-560"><span class="linenos">560</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_time_propagate_delay&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-561"><a href="#AirlineOperatingCentre-561"><span class="linenos">561</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-562"><a href="#AirlineOperatingCentre-562"><span class="linenos">562</span></a>
</span><span id="AirlineOperatingCentre-563"><a href="#AirlineOperatingCentre-563"><span class="linenos">563</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_cost_delay_function&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-564"><a href="#AirlineOperatingCentre-564"><span class="linenos">564</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-565"><a href="#AirlineOperatingCentre-565"><span class="linenos">565</span></a>
</span><span id="AirlineOperatingCentre-566"><a href="#AirlineOperatingCentre-566"><span class="linenos">566</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancel_flight_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-567"><a href="#AirlineOperatingCentre-567"><span class="linenos">567</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cancel_flight_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-568"><a href="#AirlineOperatingCentre-568"><span class="linenos">568</span></a>
</span><span id="AirlineOperatingCentre-569"><a href="#AirlineOperatingCentre-569"><span class="linenos">569</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;select_flight_option_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-570"><a href="#AirlineOperatingCentre-570"><span class="linenos">570</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="o">.</span><span class="n">wait_for_fp_selection_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-571"><a href="#AirlineOperatingCentre-571"><span class="linenos">571</span></a>
</span><span id="AirlineOperatingCentre-572"><a href="#AirlineOperatingCentre-572"><span class="linenos">572</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reply_option_selected&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-573"><a href="#AirlineOperatingCentre-573"><span class="linenos">573</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_fp_option_selection</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-574"><a href="#AirlineOperatingCentre-574"><span class="linenos">574</span></a>
</span><span id="AirlineOperatingCentre-575"><a href="#AirlineOperatingCentre-575"><span class="linenos">575</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_hotspot_decision&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-576"><a href="#AirlineOperatingCentre-576"><span class="linenos">576</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-577"><a href="#AirlineOperatingCentre-577"><span class="linenos">577</span></a>
</span><span id="AirlineOperatingCentre-578"><a href="#AirlineOperatingCentre-578"><span class="linenos">578</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-579"><a href="#AirlineOperatingCentre-579"><span class="linenos">579</span></a>			<span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineOperatingCentre-580"><a href="#AirlineOperatingCentre-580"><span class="linenos">580</span></a>			<span class="k">for</span> <span class="n">receive_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_module_functions</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-581"><a href="#AirlineOperatingCentre-581"><span class="linenos">581</span></a>				<span class="n">hit</span> <span class="o">=</span> <span class="n">receive_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre-582"><a href="#AirlineOperatingCentre-582"><span class="linenos">582</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre-583"><a href="#AirlineOperatingCentre-583"><span class="linenos">583</span></a>				<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: unrecognised message type received by&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="AirlineOperatingCentre-584"><a href="#AirlineOperatingCentre-584"><span class="linenos">584</span></a>
</span><span id="AirlineOperatingCentre-585"><a href="#AirlineOperatingCentre-585"><span class="linenos">585</span></a>	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre-586"><a href="#AirlineOperatingCentre-586"><span class="linenos">586</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-587"><a href="#AirlineOperatingCentre-587"><span class="linenos">587</span></a><span class="sd">		Provide textual id of the AOC</span>
</span><span id="AirlineOperatingCentre-588"><a href="#AirlineOperatingCentre-588"><span class="linenos">588</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre-589"><a href="#AirlineOperatingCentre-589"><span class="linenos">589</span></a>		<span class="k">return</span> <span class="s2">&quot;AOC &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Agent representing an airline operating centre.</p>

<p>This includes:</p>

<ul>
<li>Processes related to flight and fleet management, such as:
<ul>
<li>selection of flight plan</li>
<li>planning of flight plan</li>
<li>compute dynamic cost index for speed adjustment of flights</li>
<li>turnaround operation management</li>
</ul></li>
<li>Processes related to management of passengers, such as:
<ul>
<li>Passengers reallocation</li>
<li>Passenger handler</li>
</ul></li>
</ul>

<p>The decisions are mostly driven by expected cost of delay</p>
</div>


                            <div id="AirlineOperatingCentre.__init__" class="classattr">
                                        <input id="AirlineOperatingCentre.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AirlineOperatingCentre</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="AirlineOperatingCentre.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.__init__-43"><a href="#AirlineOperatingCentre.__init__-43"><span class="linenos"> 43</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.__init__-44"><a href="#AirlineOperatingCentre.__init__-44"><span class="linenos"> 44</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-45"><a href="#AirlineOperatingCentre.__init__-45"><span class="linenos"> 45</span></a>
</span><span id="AirlineOperatingCentre.__init__-46"><a href="#AirlineOperatingCentre.__init__-46"><span class="linenos"> 46</span></a>		<span class="c1"># Roles</span>
</span><span id="AirlineOperatingCentre.__init__-47"><a href="#AirlineOperatingCentre.__init__-47"><span class="linenos"> 47</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">afp</span> <span class="o">=</span> <span class="n">AirlineFlightPlanner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-48"><a href="#AirlineOperatingCentre.__init__-48"><span class="linenos"> 48</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pr</span> <span class="o">=</span> <span class="n">PassengerReallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-49"><a href="#AirlineOperatingCentre.__init__-49"><span class="linenos"> 49</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">tro</span> <span class="o">=</span> <span class="n">TurnaroundOperations</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-50"><a href="#AirlineOperatingCentre.__init__-50"><span class="linenos"> 50</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aph</span> <span class="o">=</span> <span class="n">AirlinePaxHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-51"><a href="#AirlineOperatingCentre.__init__-51"><span class="linenos"> 51</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span> <span class="o">=</span> <span class="n">DynamicCostIndexComputer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.__init__-52"><a href="#AirlineOperatingCentre.__init__-52"><span class="linenos"> 52</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">FlightPlanSelector</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># Decides which flight plan to use for a given flight</span>
</span><span id="AirlineOperatingCentre.__init__-53"><a href="#AirlineOperatingCentre.__init__-53"><span class="linenos"> 53</span></a>
</span><span id="AirlineOperatingCentre.__init__-54"><a href="#AirlineOperatingCentre.__init__-54"><span class="linenos"> 54</span></a>		<span class="c1"># Apply modifications due to modules</span>
</span><span id="AirlineOperatingCentre.__init__-55"><a href="#AirlineOperatingCentre.__init__-55"><span class="linenos"> 55</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">apply_agent_modifications</span><span class="p">()</span>
</span><span id="AirlineOperatingCentre.__init__-56"><a href="#AirlineOperatingCentre.__init__-56"><span class="linenos"> 56</span></a>
</span><span id="AirlineOperatingCentre.__init__-57"><a href="#AirlineOperatingCentre.__init__-57"><span class="linenos"> 57</span></a>		<span class="c1"># Internal knowledge</span>
</span><span id="AirlineOperatingCentre.__init__-58"><a href="#AirlineOperatingCentre.__init__-58"><span class="linenos"> 58</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flights for the airline and their status (load factors, schedules, operated, etc.)</span>
</span><span id="AirlineOperatingCentre.__init__-59"><a href="#AirlineOperatingCentre.__init__-59"><span class="linenos"> 59</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Flight plans for given flights (flight key)</span>
</span><span id="AirlineOperatingCentre.__init__-60"><a href="#AirlineOperatingCentre.__init__-60"><span class="linenos"> 60</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_pax_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># In theory, this should only be used for pax reallocation</span>
</span><span id="AirlineOperatingCentre.__init__-61"><a href="#AirlineOperatingCentre.__init__-61"><span class="linenos"> 61</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on airports used by flight from the airline</span>
</span><span id="AirlineOperatingCentre.__init__-62"><a href="#AirlineOperatingCentre.__init__-62"><span class="linenos"> 62</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># List of aircraft used by the airline</span>
</span><span id="AirlineOperatingCentre.__init__-63"><a href="#AirlineOperatingCentre.__init__-63"><span class="linenos"> 63</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Temporary save flight plan for flights</span>
</span><span id="AirlineOperatingCentre.__init__-64"><a href="#AirlineOperatingCentre.__init__-64"><span class="linenos"> 64</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information on the delay recovery for a flight aoc gets from pdrp (role in Flight)</span>
</span><span id="AirlineOperatingCentre.__init__-65"><a href="#AirlineOperatingCentre.__init__-65"><span class="linenos"> 65</span></a>
</span><span id="AirlineOperatingCentre.__init__-66"><a href="#AirlineOperatingCentre.__init__-66"><span class="linenos"> 66</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_atfm</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Information of flight waiting to recieve ATFM info</span>
</span><span id="AirlineOperatingCentre.__init__-67"><a href="#AirlineOperatingCentre.__init__-67"><span class="linenos"> 67</span></a>
</span><span id="AirlineOperatingCentre.__init__-68"><a href="#AirlineOperatingCentre.__init__-68"><span class="linenos"> 68</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">new_paxs</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># List of new passenger groups created (e.g. split from groups)</span>
</span><span id="AirlineOperatingCentre.__init__-69"><a href="#AirlineOperatingCentre.__init__-69"><span class="linenos"> 69</span></a>
</span><span id="AirlineOperatingCentre.__init__-70"><a href="#AirlineOperatingCentre.__init__-70"><span class="linenos"> 70</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># CPU time for code performance assessment</span>
</span><span id="AirlineOperatingCentre.__init__-71"><a href="#AirlineOperatingCentre.__init__-71"><span class="linenos"> 71</span></a>
</span><span id="AirlineOperatingCentre.__init__-72"><a href="#AirlineOperatingCentre.__init__-72"><span class="linenos"> 72</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Duty of care function</span>
</span><span id="AirlineOperatingCentre.__init__-73"><a href="#AirlineOperatingCentre.__init__-73"><span class="linenos"> 73</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function to give compensation</span>
</span><span id="AirlineOperatingCentre.__init__-74"><a href="#AirlineOperatingCentre.__init__-74"><span class="linenos"> 74</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function for non pax costs</span>
</span><span id="AirlineOperatingCentre.__init__-75"><a href="#AirlineOperatingCentre.__init__-75"><span class="linenos"> 75</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Distribution of Non ATFM delay</span>
</span><span id="AirlineOperatingCentre.__init__-76"><a href="#AirlineOperatingCentre.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="AirlineOperatingCentre.__init__-77"><a href="#AirlineOperatingCentre.__init__-77"><span class="linenos"> 77</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of trajectories between o-d to be used if FP generated on the fly based on trajectories</span>
</span><span id="AirlineOperatingCentre.__init__-78"><a href="#AirlineOperatingCentre.__init__-78"><span class="linenos"> 78</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pool of FPs</span>
</span><span id="AirlineOperatingCentre.__init__-79"><a href="#AirlineOperatingCentre.__init__-79"><span class="linenos"> 79</span></a>
</span><span id="AirlineOperatingCentre.__init__-80"><a href="#AirlineOperatingCentre.__init__-80"><span class="linenos"> 80</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">alliance</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Alliance for the arline. To be filled when registering airline into alliance</span>
</span><span id="AirlineOperatingCentre.__init__-81"><a href="#AirlineOperatingCentre.__init__-81"><span class="linenos"> 81</span></a>
</span><span id="AirlineOperatingCentre.__init__-82"><a href="#AirlineOperatingCentre.__init__-82"><span class="linenos"> 82</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># NetworkManager Agent UID</span>
</span><span id="AirlineOperatingCentre.__init__-83"><a href="#AirlineOperatingCentre.__init__-83"><span class="linenos"> 83</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cr</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Pointer to the Central Registry. To be filled when registering airline to CR</span>
</span><span id="AirlineOperatingCentre.__init__-84"><a href="#AirlineOperatingCentre.__init__-84"><span class="linenos"> 84</span></a>
</span><span id="AirlineOperatingCentre.__init__-85"><a href="#AirlineOperatingCentre.__init__-85"><span class="linenos"> 85</span></a>		<span class="c1"># Atributes passed on construction in init</span>
</span><span id="AirlineOperatingCentre.__init__-86"><a href="#AirlineOperatingCentre.__init__-86"><span class="linenos"> 86</span></a>		<span class="c1"># We could have passed information asking to use pool of flight plans or not</span>
</span><span id="AirlineOperatingCentre.__init__-87"><a href="#AirlineOperatingCentre.__init__-87"><span class="linenos"> 87</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;use_pool_fp&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.__init__-88"><a href="#AirlineOperatingCentre.__init__-88"><span class="linenos"> 88</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span>
</span><span id="AirlineOperatingCentre.__init__-89"><a href="#AirlineOperatingCentre.__init__-89"><span class="linenos"> 89</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.__init__-90"><a href="#AirlineOperatingCentre.__init__-90"><span class="linenos"> 90</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">use_pool_fp</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineOperatingCentre.__init__-91"><a href="#AirlineOperatingCentre.__init__-91"><span class="linenos"> 91</span></a>
</span><span id="AirlineOperatingCentre.__init__-92"><a href="#AirlineOperatingCentre.__init__-92"><span class="linenos"> 92</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;compensation_uptake&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.__init__-93"><a href="#AirlineOperatingCentre.__init__-93"><span class="linenos"> 93</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="AirlineOperatingCentre.__init__-94"><a href="#AirlineOperatingCentre.__init__-94"><span class="linenos"> 94</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.__init__-95"><a href="#AirlineOperatingCentre.__init__-95"><span class="linenos"> 95</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineOperatingCentre.__init__-96"><a href="#AirlineOperatingCentre.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="AirlineOperatingCentre.__init__-97"><a href="#AirlineOperatingCentre.__init__-97"><span class="linenos"> 97</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;icao&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.__init__-98"><a href="#AirlineOperatingCentre.__init__-98"><span class="linenos"> 98</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="AirlineOperatingCentre.__init__-99"><a href="#AirlineOperatingCentre.__init__-99"><span class="linenos"> 99</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.__init__-100"><a href="#AirlineOperatingCentre.__init__-100"><span class="linenos">100</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">icao</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineOperatingCentre.__init__-101"><a href="#AirlineOperatingCentre.__init__-101"><span class="linenos">101</span></a>
</span><span id="AirlineOperatingCentre.__init__-102"><a href="#AirlineOperatingCentre.__init__-102"><span class="linenos">102</span></a>		<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;airline_type&#39;</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.__init__-103"><a href="#AirlineOperatingCentre.__init__-103"><span class="linenos">103</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="AirlineOperatingCentre.__init__-104"><a href="#AirlineOperatingCentre.__init__-104"><span class="linenos">104</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.__init__-105"><a href="#AirlineOperatingCentre.__init__-105"><span class="linenos">105</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineOperatingCentre.dic_role" class="classattr">
                                <div class="attr variable">
            <span class="name">dic_role</span>        =
<input id="AirlineOperatingCentre.dic_role-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="AirlineOperatingCentre.dic_role-view-value"></label><span class="default_value">{&#39;AirlineFlightPlanner&#39;: &#39;afp&#39;, &#39;PassengerReallocation&#39;: &#39;pr&#39;, &#39;TurnaroundOperations&#39;: &#39;tro&#39;, &#39;AirlinePaxHandler&#39;: &#39;aph&#39;, &#39;DynamicCostIndexComputer&#39;: &#39;dcic&#39;, &#39;FlightPlanSelector&#39;: &#39;fps&#39;}</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.dic_role"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.afp" class="classattr">
                                <div class="attr variable">
            <span class="name">afp</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.afp"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.pr" class="classattr">
                                <div class="attr variable">
            <span class="name">pr</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.pr"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.tro" class="classattr">
                                <div class="attr variable">
            <span class="name">tro</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.tro"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aph" class="classattr">
                                <div class="attr variable">
            <span class="name">aph</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aph"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.dcic" class="classattr">
                                <div class="attr variable">
            <span class="name">dcic</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.dcic"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.fps" class="classattr">
                                <div class="attr variable">
            <span class="name">fps</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.fps"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aoc_flights_info" class="classattr">
                                <div class="attr variable">
            <span class="name">aoc_flights_info</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aoc_flights_info"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aoc_flight_plans" class="classattr">
                                <div class="attr variable">
            <span class="name">aoc_flight_plans</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aoc_flight_plans"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aoc_pax_info" class="classattr">
                                <div class="attr variable">
            <span class="name">aoc_pax_info</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aoc_pax_info"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aoc_airports_info" class="classattr">
                                <div class="attr variable">
            <span class="name">aoc_airports_info</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aoc_airports_info"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aircraft_list" class="classattr">
                                <div class="attr variable">
            <span class="name">aircraft_list</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aircraft_list"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.other_aoc_flight_plans" class="classattr">
                                <div class="attr variable">
            <span class="name">other_aoc_flight_plans</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.other_aoc_flight_plans"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.aoc_delay_recovery_info" class="classattr">
                                <div class="attr variable">
            <span class="name">aoc_delay_recovery_info</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.aoc_delay_recovery_info"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.fp_waiting_atfm" class="classattr">
                                <div class="attr variable">
            <span class="name">fp_waiting_atfm</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.fp_waiting_atfm"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.new_paxs" class="classattr">
                                <div class="attr variable">
            <span class="name">new_paxs</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.new_paxs"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.times" class="classattr">
                                <div class="attr variable">
            <span class="name">times</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.times"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.duty_of_care" class="classattr">
                                <div class="attr variable">
            <span class="name">duty_of_care</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.duty_of_care"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.compensation" class="classattr">
                                <div class="attr variable">
            <span class="name">compensation</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.compensation"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.non_pax_cost" class="classattr">
                                <div class="attr variable">
            <span class="name">non_pax_cost</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.non_pax_cost"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.non_atfm_delay_dist" class="classattr">
                                <div class="attr variable">
            <span class="name">non_atfm_delay_dist</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.non_atfm_delay_dist"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.trajectory_pool" class="classattr">
                                <div class="attr variable">
            <span class="name">trajectory_pool</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.trajectory_pool"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.fp_pool" class="classattr">
                                <div class="attr variable">
            <span class="name">fp_pool</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.fp_pool"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.alliance" class="classattr">
                                <div class="attr variable">
            <span class="name">alliance</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.alliance"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.nm_uid" class="classattr">
                                <div class="attr variable">
            <span class="name">nm_uid</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.nm_uid"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.cr" class="classattr">
                                <div class="attr variable">
            <span class="name">cr</span>

        
    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.cr"></a>
    
    

                            </div>
                            <div id="AirlineOperatingCentre.set_log_file" class="classattr">
                                        <input id="AirlineOperatingCentre.set_log_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_log_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">log_file</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.set_log_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.set_log_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.set_log_file-107"><a href="#AirlineOperatingCentre.set_log_file-107"><span class="linenos">107</span></a>	<span class="k">def</span> <span class="nf">set_log_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_file</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.set_log_file-108"><a href="#AirlineOperatingCentre.set_log_file-108"><span class="linenos">108</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.set_log_file-109"><a href="#AirlineOperatingCentre.set_log_file-109"><span class="linenos">109</span></a><span class="sd">		Set log file for the Agent.</span>
</span><span id="AirlineOperatingCentre.set_log_file-110"><a href="#AirlineOperatingCentre.set_log_file-110"><span class="linenos">110</span></a><span class="sd">		TBC by logging system</span>
</span><span id="AirlineOperatingCentre.set_log_file-111"><a href="#AirlineOperatingCentre.set_log_file-111"><span class="linenos">111</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.set_log_file-112"><a href="#AirlineOperatingCentre.set_log_file-112"><span class="linenos">112</span></a>		<span class="k">global</span> <span class="n">aprint</span>
</span><span id="AirlineOperatingCentre.set_log_file-113"><a href="#AirlineOperatingCentre.set_log_file-113"><span class="linenos">113</span></a>		<span class="n">aprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.set_log_file-114"><a href="#AirlineOperatingCentre.set_log_file-114"><span class="linenos">114</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aprint</span> <span class="o">=</span> <span class="n">aprint</span>
</span><span id="AirlineOperatingCentre.set_log_file-115"><a href="#AirlineOperatingCentre.set_log_file-115"><span class="linenos">115</span></a>
</span><span id="AirlineOperatingCentre.set_log_file-116"><a href="#AirlineOperatingCentre.set_log_file-116"><span class="linenos">116</span></a>		<span class="k">global</span> <span class="n">mprint</span>
</span><span id="AirlineOperatingCentre.set_log_file-117"><a href="#AirlineOperatingCentre.set_log_file-117"><span class="linenos">117</span></a>		<span class="n">mprint</span> <span class="o">=</span> <span class="n">build_col_print_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcolor</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.set_log_file-118"><a href="#AirlineOperatingCentre.set_log_file-118"><span class="linenos">118</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">mprint</span> <span class="o">=</span> <span class="n">mprint</span>
</span></pre></div>


            <div class="docstring"><p>Set log file for the Agent.
TBC by logging system</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.average_missed_pax_cost" class="classattr">
                                        <input id="AirlineOperatingCentre.average_missed_pax_cost-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">average_missed_pax_cost</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.average_missed_pax_cost-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.average_missed_pax_cost"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.average_missed_pax_cost-120"><a href="#AirlineOperatingCentre.average_missed_pax_cost-120"><span class="linenos">120</span></a>	<span class="k">def</span> <span class="nf">average_missed_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-121"><a href="#AirlineOperatingCentre.average_missed_pax_cost-121"><span class="linenos">121</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-122"><a href="#AirlineOperatingCentre.average_missed_pax_cost-122"><span class="linenos">122</span></a><span class="sd">		Function to obtain average cost of passenger missing connection</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-123"><a href="#AirlineOperatingCentre.average_missed_pax_cost-123"><span class="linenos">123</span></a><span class="sd">		pax: passenger type</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-124"><a href="#AirlineOperatingCentre.average_missed_pax_cost-124"><span class="linenos">124</span></a>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-125"><a href="#AirlineOperatingCentre.average_missed_pax_cost-125"><span class="linenos">125</span></a><span class="sd">		TODO: cost now hard coded, at least passed as parameter</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-126"><a href="#AirlineOperatingCentre.average_missed_pax_cost-126"><span class="linenos">126</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-127"><a href="#AirlineOperatingCentre.average_missed_pax_cost-127"><span class="linenos">127</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;economy&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-128"><a href="#AirlineOperatingCentre.average_missed_pax_cost-128"><span class="linenos">128</span></a>			<span class="k">return</span> <span class="mf">1000.</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-129"><a href="#AirlineOperatingCentre.average_missed_pax_cost-129"><span class="linenos">129</span></a>		<span class="k">elif</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.average_missed_pax_cost-130"><a href="#AirlineOperatingCentre.average_missed_pax_cost-130"><span class="linenos">130</span></a>			<span class="k">return</span> <span class="mf">5000.</span>
</span></pre></div>


            <div class="docstring"><p>Function to obtain average cost of passenger missing connection
pax: passenger type</p>

<p>TODO: cost now hard coded, at least passed as parameter</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.average_cost_function" class="classattr">
                                        <input id="AirlineOperatingCentre.average_cost_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">average_cost_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">delay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.average_cost_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.average_cost_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.average_cost_function-132"><a href="#AirlineOperatingCentre.average_cost_function-132"><span class="linenos">132</span></a>	<span class="k">def</span> <span class="nf">average_cost_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.average_cost_function-133"><a href="#AirlineOperatingCentre.average_cost_function-133"><span class="linenos">133</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.average_cost_function-134"><a href="#AirlineOperatingCentre.average_cost_function-134"><span class="linenos">134</span></a><span class="sd">		Very high-level/averaged, only to be used for rough estimation.</span>
</span><span id="AirlineOperatingCentre.average_cost_function-135"><a href="#AirlineOperatingCentre.average_cost_function-135"><span class="linenos">135</span></a>
</span><span id="AirlineOperatingCentre.average_cost_function-136"><a href="#AirlineOperatingCentre.average_cost_function-136"><span class="linenos">136</span></a><span class="sd">		delay: minutes of delay</span>
</span><span id="AirlineOperatingCentre.average_cost_function-137"><a href="#AirlineOperatingCentre.average_cost_function-137"><span class="linenos">137</span></a>
</span><span id="AirlineOperatingCentre.average_cost_function-138"><a href="#AirlineOperatingCentre.average_cost_function-138"><span class="linenos">138</span></a><span class="sd">		TODO: average cost now hard coded, at least passed as parameter</span>
</span><span id="AirlineOperatingCentre.average_cost_function-139"><a href="#AirlineOperatingCentre.average_cost_function-139"><span class="linenos">139</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.average_cost_function-140"><a href="#AirlineOperatingCentre.average_cost_function-140"><span class="linenos">140</span></a>
</span><span id="AirlineOperatingCentre.average_cost_function-141"><a href="#AirlineOperatingCentre.average_cost_function-141"><span class="linenos">141</span></a>		<span class="k">return</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">delay</span>
</span></pre></div>


            <div class="docstring"><p>Very high-level/averaged, only to be used for rough estimation.</p>

<p>delay: minutes of delay</p>

<p>TODO: average cost now hard coded, at least passed as parameter</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_reactionary_buffer" class="classattr">
                                        <input id="AirlineOperatingCentre.get_reactionary_buffer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_reactionary_buffer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_reactionary_buffer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_reactionary_buffer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_reactionary_buffer-143"><a href="#AirlineOperatingCentre.get_reactionary_buffer-143"><span class="linenos">143</span></a>	<span class="k">def</span> <span class="nf">get_reactionary_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-144"><a href="#AirlineOperatingCentre.get_reactionary_buffer-144"><span class="linenos">144</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-145"><a href="#AirlineOperatingCentre.get_reactionary_buffer-145"><span class="linenos">145</span></a><span class="sd">		Get reactionary buffer for a given flight, i.e., delay after which the propagation of the delay</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-146"><a href="#AirlineOperatingCentre.get_reactionary_buffer-146"><span class="linenos">146</span></a><span class="sd">		might trigger a breach of a curfew</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-147"><a href="#AirlineOperatingCentre.get_reactionary_buffer-147"><span class="linenos">147</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-148"><a href="#AirlineOperatingCentre.get_reactionary_buffer-148"><span class="linenos">148</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre.get_reactionary_buffer-149"><a href="#AirlineOperatingCentre.get_reactionary_buffer-149"><span class="linenos">149</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get reactionary buffer for a given flight, i.e., delay after which the propagation of the delay
might trigger a breach of a curfew</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_curfew_buffer" class="classattr">
                                        <input id="AirlineOperatingCentre.get_curfew_buffer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_curfew_buffer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_curfew_buffer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_curfew_buffer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_curfew_buffer-151"><a href="#AirlineOperatingCentre.get_curfew_buffer-151"><span class="linenos">151</span></a>	<span class="k">def</span> <span class="nf">get_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_curfew_buffer-152"><a href="#AirlineOperatingCentre.get_curfew_buffer-152"><span class="linenos">152</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_curfew_buffer-153"><a href="#AirlineOperatingCentre.get_curfew_buffer-153"><span class="linenos">153</span></a><span class="sd">		Get buffer for flight before reaching curfew. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_curfew_buffer-154"><a href="#AirlineOperatingCentre.get_curfew_buffer-154"><span class="linenos">154</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_curfew_buffer-155"><a href="#AirlineOperatingCentre.get_curfew_buffer-155"><span class="linenos">155</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre.get_curfew_buffer-156"><a href="#AirlineOperatingCentre.get_curfew_buffer-156"><span class="linenos">156</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get buffer for flight before reaching curfew. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_obt" class="classattr">
                                        <input id="AirlineOperatingCentre.get_obt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_obt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_obt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_obt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_obt-158"><a href="#AirlineOperatingCentre.get_obt-158"><span class="linenos">158</span></a>	<span class="k">def</span> <span class="nf">get_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_obt-159"><a href="#AirlineOperatingCentre.get_obt-159"><span class="linenos">159</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_obt-160"><a href="#AirlineOperatingCentre.get_obt-160"><span class="linenos">160</span></a><span class="sd">		Get OBT of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_obt-161"><a href="#AirlineOperatingCentre.get_obt-161"><span class="linenos">161</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_obt-162"><a href="#AirlineOperatingCentre.get_obt-162"><span class="linenos">162</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre.get_obt-163"><a href="#AirlineOperatingCentre.get_obt-163"><span class="linenos">163</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get OBT of a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_origin" class="classattr">
                                        <input id="AirlineOperatingCentre.get_origin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_origin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_origin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_origin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_origin-165"><a href="#AirlineOperatingCentre.get_origin-165"><span class="linenos">165</span></a>	<span class="k">def</span> <span class="nf">get_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_origin-166"><a href="#AirlineOperatingCentre.get_origin-166"><span class="linenos">166</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_origin-167"><a href="#AirlineOperatingCentre.get_origin-167"><span class="linenos">167</span></a><span class="sd">		Get origin of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_origin-168"><a href="#AirlineOperatingCentre.get_origin-168"><span class="linenos">168</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_origin-169"><a href="#AirlineOperatingCentre.get_origin-169"><span class="linenos">169</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre.get_origin-170"><a href="#AirlineOperatingCentre.get_origin-170"><span class="linenos">170</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get origin of a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_destination" class="classattr">
                                        <input id="AirlineOperatingCentre.get_destination-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_destination</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_destination-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_destination"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_destination-172"><a href="#AirlineOperatingCentre.get_destination-172"><span class="linenos">172</span></a>	<span class="k">def</span> <span class="nf">get_destination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_destination-173"><a href="#AirlineOperatingCentre.get_destination-173"><span class="linenos">173</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_destination-174"><a href="#AirlineOperatingCentre.get_destination-174"><span class="linenos">174</span></a><span class="sd">		Get destination of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_destination-175"><a href="#AirlineOperatingCentre.get_destination-175"><span class="linenos">175</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_destination-176"><a href="#AirlineOperatingCentre.get_destination-176"><span class="linenos">176</span></a>		<span class="c1"># It should be a message to keep ABM but access directly for performance</span>
</span><span id="AirlineOperatingCentre.get_destination-177"><a href="#AirlineOperatingCentre.get_destination-177"><span class="linenos">177</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get destination of a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_status" class="classattr">
                                        <input id="AirlineOperatingCentre.get_status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_status-179"><a href="#AirlineOperatingCentre.get_status-179"><span class="linenos">179</span></a>	<span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_status-180"><a href="#AirlineOperatingCentre.get_status-180"><span class="linenos">180</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_status-181"><a href="#AirlineOperatingCentre.get_status-181"><span class="linenos">181</span></a><span class="sd">		Get flight status. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_status-182"><a href="#AirlineOperatingCentre.get_status-182"><span class="linenos">182</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_status-183"><a href="#AirlineOperatingCentre.get_status-183"><span class="linenos">183</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get flight status. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_pax_to_board" class="classattr">
                                        <input id="AirlineOperatingCentre.get_pax_to_board-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_pax_to_board</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_pax_to_board-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_pax_to_board"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_pax_to_board-185"><a href="#AirlineOperatingCentre.get_pax_to_board-185"><span class="linenos">185</span></a>	<span class="k">def</span> <span class="nf">get_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_pax_to_board-186"><a href="#AirlineOperatingCentre.get_pax_to_board-186"><span class="linenos">186</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_pax_to_board-187"><a href="#AirlineOperatingCentre.get_pax_to_board-187"><span class="linenos">187</span></a><span class="sd">		Get pax to board a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_pax_to_board-188"><a href="#AirlineOperatingCentre.get_pax_to_board-188"><span class="linenos">188</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_pax_to_board-189"><a href="#AirlineOperatingCentre.get_pax_to_board-189"><span class="linenos">189</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get pax to board a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_ibt" class="classattr">
                                        <input id="AirlineOperatingCentre.get_ibt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_ibt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_ibt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_ibt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_ibt-191"><a href="#AirlineOperatingCentre.get_ibt-191"><span class="linenos">191</span></a>	<span class="k">def</span> <span class="nf">get_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_ibt-192"><a href="#AirlineOperatingCentre.get_ibt-192"><span class="linenos">192</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_ibt-193"><a href="#AirlineOperatingCentre.get_ibt-193"><span class="linenos">193</span></a><span class="sd">		Get IBT of a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_ibt-194"><a href="#AirlineOperatingCentre.get_ibt-194"><span class="linenos">194</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_ibt-195"><a href="#AirlineOperatingCentre.get_ibt-195"><span class="linenos">195</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get IBT of a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_mct" class="classattr">
                                        <input id="AirlineOperatingCentre.get_mct-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_mct</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid1</span>, </span><span class="param"><span class="n">flight_uid2</span>, </span><span class="param"><span class="n">pax_type</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_mct-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_mct"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_mct-197"><a href="#AirlineOperatingCentre.get_mct-197"><span class="linenos">197</span></a>	<span class="k">def</span> <span class="nf">get_mct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_mct-198"><a href="#AirlineOperatingCentre.get_mct-198"><span class="linenos">198</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_mct-199"><a href="#AirlineOperatingCentre.get_mct-199"><span class="linenos">199</span></a><span class="sd">		Get MCT between two flights for a given pax type. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_mct-200"><a href="#AirlineOperatingCentre.get_mct-200"><span class="linenos">200</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_mct-201"><a href="#AirlineOperatingCentre.get_mct-201"><span class="linenos">201</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid1</span><span class="p">,</span> <span class="n">flight_uid2</span><span class="p">,</span> <span class="n">pax_type</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get MCT between two flights for a given pax type. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_airlines_in_alliance" class="classattr">
                                        <input id="AirlineOperatingCentre.get_airlines_in_alliance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_airlines_in_alliance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_airlines_in_alliance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_airlines_in_alliance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_airlines_in_alliance-203"><a href="#AirlineOperatingCentre.get_airlines_in_alliance-203"><span class="linenos">203</span></a>	<span class="k">def</span> <span class="nf">get_airlines_in_alliance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_airlines_in_alliance-204"><a href="#AirlineOperatingCentre.get_airlines_in_alliance-204"><span class="linenos">204</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_airlines_in_alliance-205"><a href="#AirlineOperatingCentre.get_airlines_in_alliance-205"><span class="linenos">205</span></a><span class="sd">		Get alliance for the airline Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_airlines_in_alliance-206"><a href="#AirlineOperatingCentre.get_airlines_in_alliance-206"><span class="linenos">206</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_airlines_in_alliance-207"><a href="#AirlineOperatingCentre.get_airlines_in_alliance-207"><span class="linenos">207</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">alliance_composition</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">alliance</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get alliance for the airline Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_flights" class="classattr">
                                        <input id="AirlineOperatingCentre.get_flights-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_flights</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">aoc_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_flights-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_flights"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_flights-209"><a href="#AirlineOperatingCentre.get_flights-209"><span class="linenos">209</span></a>	<span class="k">def</span> <span class="nf">get_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_flights-210"><a href="#AirlineOperatingCentre.get_flights-210"><span class="linenos">210</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_flights-211"><a href="#AirlineOperatingCentre.get_flights-211"><span class="linenos">211</span></a><span class="sd">		Get flights for a given AOC. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_flights-212"><a href="#AirlineOperatingCentre.get_flights-212"><span class="linenos">212</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_flights-213"><a href="#AirlineOperatingCentre.get_flights-213"><span class="linenos">213</span></a>		<span class="c1"># TODO: move this to get_flights_of_other_airlines and how_flights go get_own_flights or get_flights</span>
</span><span id="AirlineOperatingCentre.get_flights-214"><a href="#AirlineOperatingCentre.get_flights-214"><span class="linenos">214</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get flights for a given AOC. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_all_airlines" class="classattr">
                                        <input id="AirlineOperatingCentre.get_all_airlines-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_all_airlines</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_all_airlines-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_all_airlines"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_all_airlines-216"><a href="#AirlineOperatingCentre.get_all_airlines-216"><span class="linenos">216</span></a>	<span class="k">def</span> <span class="nf">get_all_airlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_all_airlines-217"><a href="#AirlineOperatingCentre.get_all_airlines-217"><span class="linenos">217</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_all_airlines-218"><a href="#AirlineOperatingCentre.get_all_airlines-218"><span class="linenos">218</span></a><span class="sd">		Get all airlines using central registry.</span>
</span><span id="AirlineOperatingCentre.get_all_airlines-219"><a href="#AirlineOperatingCentre.get_all_airlines-219"><span class="linenos">219</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_all_airlines-220"><a href="#AirlineOperatingCentre.get_all_airlines-220"><span class="linenos">220</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Get all airlines using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_airline_of_flight" class="classattr">
                                        <input id="AirlineOperatingCentre.get_airline_of_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_airline_of_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_airline_of_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_airline_of_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_airline_of_flight-222"><a href="#AirlineOperatingCentre.get_airline_of_flight-222"><span class="linenos">222</span></a>	<span class="k">def</span> <span class="nf">get_airline_of_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_airline_of_flight-223"><a href="#AirlineOperatingCentre.get_airline_of_flight-223"><span class="linenos">223</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_airline_of_flight-224"><a href="#AirlineOperatingCentre.get_airline_of_flight-224"><span class="linenos">224</span></a><span class="sd">		Get airline for a given flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_airline_of_flight-225"><a href="#AirlineOperatingCentre.get_airline_of_flight-225"><span class="linenos">225</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_airline_of_flight-226"><a href="#AirlineOperatingCentre.get_airline_of_flight-226"><span class="linenos">226</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Get airline for a given flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_tat" class="classattr">
                                        <input id="AirlineOperatingCentre.get_tat-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_tat</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">airport_uid</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_tat-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_tat"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_tat-228"><a href="#AirlineOperatingCentre.get_tat-228"><span class="linenos">228</span></a>	<span class="k">def</span> <span class="nf">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_tat-229"><a href="#AirlineOperatingCentre.get_tat-229"><span class="linenos">229</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_tat-230"><a href="#AirlineOperatingCentre.get_tat-230"><span class="linenos">230</span></a><span class="sd">		Returns a typical turnaround time based on the type of aircraft of flight_uid. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_tat-231"><a href="#AirlineOperatingCentre.get_tat-231"><span class="linenos">231</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_tat-232"><a href="#AirlineOperatingCentre.get_tat-232"><span class="linenos">232</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="n">airport_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.get_tat-233"><a href="#AirlineOperatingCentre.get_tat-233"><span class="linenos">233</span></a>		<span class="c1"># aircraft = self.aoc_flights_info[flight_uid][&#39;aircraft&#39;]</span>
</span><span id="AirlineOperatingCentre.get_tat-234"><a href="#AirlineOperatingCentre.get_tat-234"><span class="linenos">234</span></a>		<span class="c1"># return self.aoc_airports_info[airport_uid][&#39;tats&#39;][aircraft.bada_performances.wtc][self.airline_type]</span>
</span></pre></div>


            <div class="docstring"><p>Returns a typical turnaround time based on the type of aircraft of flight_uid. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_number_seats_flight" class="classattr">
                                        <input id="AirlineOperatingCentre.get_number_seats_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_number_seats_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_number_seats_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_number_seats_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_number_seats_flight-236"><a href="#AirlineOperatingCentre.get_number_seats_flight-236"><span class="linenos">236</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_number_seats_flight-237"><a href="#AirlineOperatingCentre.get_number_seats_flight-237"><span class="linenos">237</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_number_seats_flight-238"><a href="#AirlineOperatingCentre.get_number_seats_flight-238"><span class="linenos">238</span></a><span class="sd">		Get number seats available for a flight. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_number_seats_flight-239"><a href="#AirlineOperatingCentre.get_number_seats_flight-239"><span class="linenos">239</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_number_seats_flight-240"><a href="#AirlineOperatingCentre.get_number_seats_flight-240"><span class="linenos">240</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number seats available for a flight. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_number_seats_itinerary" class="classattr">
                                        <input id="AirlineOperatingCentre.get_number_seats_itinerary-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_number_seats_itinerary</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">itinerary</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_number_seats_itinerary-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_number_seats_itinerary"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_number_seats_itinerary-242"><a href="#AirlineOperatingCentre.get_number_seats_itinerary-242"><span class="linenos">242</span></a>	<span class="k">def</span> <span class="nf">get_number_seats_itinerary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_number_seats_itinerary-243"><a href="#AirlineOperatingCentre.get_number_seats_itinerary-243"><span class="linenos">243</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_number_seats_itinerary-244"><a href="#AirlineOperatingCentre.get_number_seats_itinerary-244"><span class="linenos">244</span></a><span class="sd">		Get number seats available for a given itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_number_seats_itinerary-245"><a href="#AirlineOperatingCentre.get_number_seats_itinerary-245"><span class="linenos">245</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_number_seats_itinerary-246"><a href="#AirlineOperatingCentre.get_number_seats_itinerary-246"><span class="linenos">246</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get number seats available for a given itinerary. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_average_price_on_leg" class="classattr">
                                        <input id="AirlineOperatingCentre.get_average_price_on_leg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_average_price_on_leg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_average_price_on_leg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_average_price_on_leg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_average_price_on_leg-248"><a href="#AirlineOperatingCentre.get_average_price_on_leg-248"><span class="linenos">248</span></a>	<span class="k">def</span> <span class="nf">get_average_price_on_leg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-249"><a href="#AirlineOperatingCentre.get_average_price_on_leg-249"><span class="linenos">249</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-250"><a href="#AirlineOperatingCentre.get_average_price_on_leg-250"><span class="linenos">250</span></a><span class="sd">		This is computed using only the price paid by passengers without</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-251"><a href="#AirlineOperatingCentre.get_average_price_on_leg-251"><span class="linenos">251</span></a><span class="sd">		connection if possible. If there is none, use the number of legs as weight.</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-252"><a href="#AirlineOperatingCentre.get_average_price_on_leg-252"><span class="linenos">252</span></a><span class="sd">		Using the central registry</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-253"><a href="#AirlineOperatingCentre.get_average_price_on_leg-253"><span class="linenos">253</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_average_price_on_leg-254"><a href="#AirlineOperatingCentre.get_average_price_on_leg-254"><span class="linenos">254</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This is computed using only the price paid by passengers without
connection if possible. If there is none, use the number of legs as weight.
Using the central registry</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_total_travelling_time" class="classattr">
                                        <input id="AirlineOperatingCentre.get_total_travelling_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_total_travelling_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">itinerary</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_total_travelling_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_total_travelling_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_total_travelling_time-256"><a href="#AirlineOperatingCentre.get_total_travelling_time-256"><span class="linenos">256</span></a>	<span class="k">def</span> <span class="nf">get_total_travelling_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-257"><a href="#AirlineOperatingCentre.get_total_travelling_time-257"><span class="linenos">257</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-258"><a href="#AirlineOperatingCentre.get_total_travelling_time-258"><span class="linenos">258</span></a><span class="sd">		Note: this assumes that the connections are feasible.</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-259"><a href="#AirlineOperatingCentre.get_total_travelling_time-259"><span class="linenos">259</span></a><span class="sd">		Note: it uses the most up-to-date information.</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-260"><a href="#AirlineOperatingCentre.get_total_travelling_time-260"><span class="linenos">260</span></a><span class="sd">		Using the central registry</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-261"><a href="#AirlineOperatingCentre.get_total_travelling_time-261"><span class="linenos">261</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_total_travelling_time-262"><a href="#AirlineOperatingCentre.get_total_travelling_time-262"><span class="linenos">262</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note: this assumes that the connections are feasible.
Note: it uses the most up-to-date information.
Using the central registry</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_last_ibt" class="classattr">
                                        <input id="AirlineOperatingCentre.get_last_ibt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_last_ibt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">itinerary</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_last_ibt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_last_ibt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_last_ibt-264"><a href="#AirlineOperatingCentre.get_last_ibt-264"><span class="linenos">264</span></a>	<span class="k">def</span> <span class="nf">get_last_ibt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_last_ibt-265"><a href="#AirlineOperatingCentre.get_last_ibt-265"><span class="linenos">265</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_last_ibt-266"><a href="#AirlineOperatingCentre.get_last_ibt-266"><span class="linenos">266</span></a><span class="sd">		Get last IBT for an itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_last_ibt-267"><a href="#AirlineOperatingCentre.get_last_ibt-267"><span class="linenos">267</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_last_ibt-268"><a href="#AirlineOperatingCentre.get_last_ibt-268"><span class="linenos">268</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get last IBT for an itinerary. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_first_obt" class="classattr">
                                        <input id="AirlineOperatingCentre.get_first_obt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_first_obt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">itinerary</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_first_obt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_first_obt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_first_obt-270"><a href="#AirlineOperatingCentre.get_first_obt-270"><span class="linenos">270</span></a>	<span class="k">def</span> <span class="nf">get_first_obt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_first_obt-271"><a href="#AirlineOperatingCentre.get_first_obt-271"><span class="linenos">271</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_first_obt-272"><a href="#AirlineOperatingCentre.get_first_obt-272"><span class="linenos">272</span></a><span class="sd">		Get fist OBT for an itinerary. Using central registry.</span>
</span><span id="AirlineOperatingCentre.get_first_obt-273"><a href="#AirlineOperatingCentre.get_first_obt-273"><span class="linenos">273</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_first_obt-274"><a href="#AirlineOperatingCentre.get_first_obt-274"><span class="linenos">274</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get fist OBT for an itinerary. Using central registry.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.get_n_pax_to_board" class="classattr">
                                        <input id="AirlineOperatingCentre.get_n_pax_to_board-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_n_pax_to_board</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.get_n_pax_to_board-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.get_n_pax_to_board"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.get_n_pax_to_board-276"><a href="#AirlineOperatingCentre.get_n_pax_to_board-276"><span class="linenos">276</span></a>	<span class="k">def</span> <span class="nf">get_n_pax_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.get_n_pax_to_board-277"><a href="#AirlineOperatingCentre.get_n_pax_to_board-277"><span class="linenos">277</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_n_pax_to_board-278"><a href="#AirlineOperatingCentre.get_n_pax_to_board-278"><span class="linenos">278</span></a><span class="sd">		Get number pax to board a flight.</span>
</span><span id="AirlineOperatingCentre.get_n_pax_to_board-279"><a href="#AirlineOperatingCentre.get_n_pax_to_board-279"><span class="linenos">279</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.get_n_pax_to_board-280"><a href="#AirlineOperatingCentre.get_n_pax_to_board-280"><span class="linenos">280</span></a>		<span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]])</span>
</span></pre></div>


            <div class="docstring"><p>Get number pax to board a flight.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.give_duty_of_care_func" class="classattr">
                                        <input id="AirlineOperatingCentre.give_duty_of_care_func-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">give_duty_of_care_func</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">duty_of_care_func</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.give_duty_of_care_func-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.give_duty_of_care_func"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.give_duty_of_care_func-282"><a href="#AirlineOperatingCentre.give_duty_of_care_func-282"><span class="linenos">282</span></a>	<span class="k">def</span> <span class="nf">give_duty_of_care_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duty_of_care_func</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-283"><a href="#AirlineOperatingCentre.give_duty_of_care_func-283"><span class="linenos">283</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-284"><a href="#AirlineOperatingCentre.give_duty_of_care_func-284"><span class="linenos">284</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-285"><a href="#AirlineOperatingCentre.give_duty_of_care_func-285"><span class="linenos">285</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-286"><a href="#AirlineOperatingCentre.give_duty_of_care_func-286"><span class="linenos">286</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-287"><a href="#AirlineOperatingCentre.give_duty_of_care_func-287"><span class="linenos">287</span></a>		<span class="c1"># self.duty_of_care = duty_of_care_func</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-288"><a href="#AirlineOperatingCentre.give_duty_of_care_func-288"><span class="linenos">288</span></a>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-289"><a href="#AirlineOperatingCentre.give_duty_of_care_func-289"><span class="linenos">289</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-290"><a href="#AirlineOperatingCentre.give_duty_of_care_func-290"><span class="linenos">290</span></a>			<span class="k">return</span> <span class="n">duty_of_care_func</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-291"><a href="#AirlineOperatingCentre.give_duty_of_care_func-291"><span class="linenos">291</span></a>
</span><span id="AirlineOperatingCentre.give_duty_of_care_func-292"><a href="#AirlineOperatingCentre.give_duty_of_care_func-292"><span class="linenos">292</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">=</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>Compensation should a function taking as first argument the delay
and as second one the type of passenger.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.give_compensation_func" class="classattr">
                                        <input id="AirlineOperatingCentre.give_compensation_func-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">give_compensation_func</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">compensation_func</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.give_compensation_func-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.give_compensation_func"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.give_compensation_func-294"><a href="#AirlineOperatingCentre.give_compensation_func-294"><span class="linenos">294</span></a>	<span class="k">def</span> <span class="nf">give_compensation_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compensation_func</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-295"><a href="#AirlineOperatingCentre.give_compensation_func-295"><span class="linenos">295</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-296"><a href="#AirlineOperatingCentre.give_compensation_func-296"><span class="linenos">296</span></a><span class="sd">		Compensation should a function taking as first argument the delay</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-297"><a href="#AirlineOperatingCentre.give_compensation_func-297"><span class="linenos">297</span></a><span class="sd">		and as second one the type of passenger.</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-298"><a href="#AirlineOperatingCentre.give_compensation_func-298"><span class="linenos">298</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-299"><a href="#AirlineOperatingCentre.give_compensation_func-299"><span class="linenos">299</span></a>		<span class="c1"># self.compensation = compensation_func</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-300"><a href="#AirlineOperatingCentre.give_compensation_func-300"><span class="linenos">300</span></a>
</span><span id="AirlineOperatingCentre.give_compensation_func-301"><a href="#AirlineOperatingCentre.give_compensation_func-301"><span class="linenos">301</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-302"><a href="#AirlineOperatingCentre.give_compensation_func-302"><span class="linenos">302</span></a>			<span class="k">return</span> <span class="n">compensation_func</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-303"><a href="#AirlineOperatingCentre.give_compensation_func-303"><span class="linenos">303</span></a>
</span><span id="AirlineOperatingCentre.give_compensation_func-304"><a href="#AirlineOperatingCentre.give_compensation_func-304"><span class="linenos">304</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">f</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-305"><a href="#AirlineOperatingCentre.give_compensation_func-305"><span class="linenos">305</span></a>
</span><span id="AirlineOperatingCentre.give_compensation_func-306"><a href="#AirlineOperatingCentre.give_compensation_func-306"><span class="linenos">306</span></a>		<span class="c1"># The following is for quick computation (but is approximated).</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-307"><a href="#AirlineOperatingCentre.give_compensation_func-307"><span class="linenos">307</span></a>		<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mf">60.</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-308"><a href="#AirlineOperatingCentre.give_compensation_func-308"><span class="linenos">308</span></a>		<span class="n">dd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4000.</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-309"><a href="#AirlineOperatingCentre.give_compensation_func-309"><span class="linenos">309</span></a>		<span class="n">compensation_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compensation_uptake</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">compensation_func</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xx</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">])</span>
</span><span id="AirlineOperatingCentre.give_compensation_func-310"><a href="#AirlineOperatingCentre.give_compensation_func-310"><span class="linenos">310</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compensation_quick</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="mf">0.</span> <span class="k">if</span> <span class="n">delay</span><span class="o">&lt;</span><span class="mf">0.</span> <span class="k">else</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="o">*</span><span class="n">compensation_values</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">399</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">kilometers</span><span class="o">/</span><span class="mi">10</span><span class="p">))][</span><span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">60</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">delay</span><span class="p">))]</span>
</span></pre></div>


            <div class="docstring"><p>Compensation should a function taking as first argument the delay
and as second one the type of passenger.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.give_non_pax_cost_delay" class="classattr">
                                        <input id="AirlineOperatingCentre.give_non_pax_cost_delay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">give_non_pax_cost_delay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dict_np_cost</span>, </span><span class="param"><span class="n">dict_np_cost_fit</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.give_non_pax_cost_delay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.give_non_pax_cost_delay"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-312"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-312"><span class="linenos">312</span></a>	<span class="k">def</span> <span class="nf">give_non_pax_cost_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-313"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-313"><span class="linenos">313</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-314"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-314"><span class="linenos">314</span></a><span class="sd">		For &#39;dict_np_cost&#39;, the first level key should be the type of aircraft.</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-315"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-315"><span class="linenos">315</span></a><span class="sd">		The second level key be the phase of flight:</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-316"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-316"><span class="linenos">316</span></a><span class="sd">		-at_gate,</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-317"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-317"><span class="linenos">317</span></a><span class="sd">		-taxi,</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-318"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-318"><span class="linenos">318</span></a><span class="sd">		-airborne</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-319"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-319"><span class="linenos">319</span></a><span class="sd">		The values are the cost (in euros) per minute of a delay.</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-320"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-320"><span class="linenos">320</span></a>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-321"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-321"><span class="linenos">321</span></a><span class="sd">		For &#39;dict_np_cost_fit&#39;, the first level should the phase of flight. The second</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-322"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-322"><span class="linenos">322</span></a><span class="sd">		level should have &#39;a&#39; and &#39;b&#39;. These coefficients should used when the aircraft type</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-323"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-323"><span class="linenos">323</span></a><span class="sd">		if no available in the first dictionary, using the sqrt of the MTOW of the aircraft:</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-324"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-324"><span class="linenos">324</span></a><span class="sd">		c = a + b * sqrt(MTWO),</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-325"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-325"><span class="linenos">325</span></a><span class="sd">		where c is the cost of one minute of delay, as per above.</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-326"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-326"><span class="linenos">326</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-327"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-327"><span class="linenos">327</span></a>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-328"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-328"><span class="linenos">328</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">phase</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-329"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-329"><span class="linenos">329</span></a>			<span class="k">if</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span> <span class="ow">in</span> <span class="n">dict_np_cost</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-330"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-330"><span class="linenos">330</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">ac_type</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-331"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-331"><span class="linenos">331</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-332"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-332"><span class="linenos">332</span></a>				<span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict_np_cost_fit</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-333"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-333"><span class="linenos">333</span></a>
</span><span id="AirlineOperatingCentre.give_non_pax_cost_delay-334"><a href="#AirlineOperatingCentre.give_non_pax_cost_delay-334"><span class="linenos">334</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_pax_cost</span> <span class="o">=</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>For 'dict_np_cost', the first level key should be the type of aircraft.
The second level key be the phase of flight:
-at_gate,
-taxi,
-airborne
The values are the cost (in euros) per minute of a delay.</p>

<p>For 'dict_np_cost_fit', the first level should the phase of flight. The second
level should have 'a' and 'b'. These coefficients should used when the aircraft type
if no available in the first dictionary, using the sqrt of the MTOW of the aircraft:
c = a + b * sqrt(MTWO),
where c is the cost of one minute of delay, as per above.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.give_delay_distr" class="classattr">
                                        <input id="AirlineOperatingCentre.give_delay_distr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">give_delay_distr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dist</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.give_delay_distr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.give_delay_distr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.give_delay_distr-336"><a href="#AirlineOperatingCentre.give_delay_distr-336"><span class="linenos">336</span></a>	<span class="k">def</span> <span class="nf">give_delay_distr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.give_delay_distr-337"><a href="#AirlineOperatingCentre.give_delay_distr-337"><span class="linenos">337</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_delay_distr-338"><a href="#AirlineOperatingCentre.give_delay_distr-338"><span class="linenos">338</span></a><span class="sd">		random numbers following dist should be drawn using dist.rvs(random_state=self.agent.rs) or dist.rvs(5)</span>
</span><span id="AirlineOperatingCentre.give_delay_distr-339"><a href="#AirlineOperatingCentre.give_delay_distr-339"><span class="linenos">339</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.give_delay_distr-340"><a href="#AirlineOperatingCentre.give_delay_distr-340"><span class="linenos">340</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span> <span class="o">=</span> <span class="n">dist</span>
</span></pre></div>


            <div class="docstring"><p>random numbers following dist should be drawn using dist.rvs(random_state=self.agent.rs) or dist.rvs(5)</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.own_flights" class="classattr">
                                        <input id="AirlineOperatingCentre.own_flights-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">own_flights</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.own_flights-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.own_flights"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.own_flights-342"><a href="#AirlineOperatingCentre.own_flights-342"><span class="linenos">342</span></a>	<span class="k">def</span> <span class="nf">own_flights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.own_flights-343"><a href="#AirlineOperatingCentre.own_flights-343"><span class="linenos">343</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.own_flights-344"><a href="#AirlineOperatingCentre.own_flights-344"><span class="linenos">344</span></a><span class="sd">		Get list of own flight by the airline</span>
</span><span id="AirlineOperatingCentre.own_flights-345"><a href="#AirlineOperatingCentre.own_flights-345"><span class="linenos">345</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.own_flights-346"><a href="#AirlineOperatingCentre.own_flights-346"><span class="linenos">346</span></a>		<span class="c1"># Merge with get_flights...</span>
</span><span id="AirlineOperatingCentre.own_flights-347"><a href="#AirlineOperatingCentre.own_flights-347"><span class="linenos">347</span></a>		<span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Get list of own flight by the airline</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_list_aircraft" class="classattr">
                                        <input id="AirlineOperatingCentre.register_list_aircraft-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_list_aircraft</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">aircraft</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_list_aircraft-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_list_aircraft"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_list_aircraft-349"><a href="#AirlineOperatingCentre.register_list_aircraft-349"><span class="linenos">349</span></a>	<span class="k">def</span> <span class="nf">register_list_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_list_aircraft-350"><a href="#AirlineOperatingCentre.register_list_aircraft-350"><span class="linenos">350</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_list_aircraft-351"><a href="#AirlineOperatingCentre.register_list_aircraft-351"><span class="linenos">351</span></a><span class="sd">		Register list of aircraft in AOC</span>
</span><span id="AirlineOperatingCentre.register_list_aircraft-352"><a href="#AirlineOperatingCentre.register_list_aircraft-352"><span class="linenos">352</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_list_aircraft-353"><a href="#AirlineOperatingCentre.register_list_aircraft-353"><span class="linenos">353</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span> <span class="o">=</span> <span class="n">aircraft</span>
</span></pre></div>


            <div class="docstring"><p>Register list of aircraft in AOC</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_aircraft" class="classattr">
                                        <input id="AirlineOperatingCentre.register_aircraft-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_aircraft</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">aircraft</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_aircraft-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_aircraft"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_aircraft-355"><a href="#AirlineOperatingCentre.register_aircraft-355"><span class="linenos">355</span></a>	<span class="k">def</span> <span class="nf">register_aircraft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_aircraft-356"><a href="#AirlineOperatingCentre.register_aircraft-356"><span class="linenos">356</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_aircraft-357"><a href="#AirlineOperatingCentre.register_aircraft-357"><span class="linenos">357</span></a><span class="sd">		Add one aircraft to the list of aircraft registered in the AOC</span>
</span><span id="AirlineOperatingCentre.register_aircraft-358"><a href="#AirlineOperatingCentre.register_aircraft-358"><span class="linenos">358</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_aircraft-359"><a href="#AirlineOperatingCentre.register_aircraft-359"><span class="linenos">359</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">aircraft</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">aircraft</span>
</span></pre></div>


            <div class="docstring"><p>Add one aircraft to the list of aircraft registered in the AOC</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_airport" class="classattr">
                                        <input id="AirlineOperatingCentre.register_airport-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_airport</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">airport</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_airport-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_airport"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_airport-361"><a href="#AirlineOperatingCentre.register_airport-361"><span class="linenos">361</span></a>	<span class="k">def</span> <span class="nf">register_airport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">airport</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_airport-362"><a href="#AirlineOperatingCentre.register_airport-362"><span class="linenos">362</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_airport-363"><a href="#AirlineOperatingCentre.register_airport-363"><span class="linenos">363</span></a><span class="sd">		Add one airport to the list of airports in the AOC</span>
</span><span id="AirlineOperatingCentre.register_airport-364"><a href="#AirlineOperatingCentre.register_airport-364"><span class="linenos">364</span></a>
</span><span id="AirlineOperatingCentre.register_airport-365"><a href="#AirlineOperatingCentre.register_airport-365"><span class="linenos">365</span></a><span class="sd">		mcts are designed so that one can do:</span>
</span><span id="AirlineOperatingCentre.register_airport-366"><a href="#AirlineOperatingCentre.register_airport-366"><span class="linenos">366</span></a><span class="sd">		mcts = self.aoc_airports_info[airport_uid][&#39;mcts&#39;]</span>
</span><span id="AirlineOperatingCentre.register_airport-367"><a href="#AirlineOperatingCentre.register_airport-367"><span class="linenos">367</span></a><span class="sd">		mct = mcts[(self.aoc_flights_info[flight_uid1][&#39;international&#39;], self.aoc_flights_info[flight_uid2][&#39;international&#39;])]</span>
</span><span id="AirlineOperatingCentre.register_airport-368"><a href="#AirlineOperatingCentre.register_airport-368"><span class="linenos">368</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_airport-369"><a href="#AirlineOperatingCentre.register_airport-369"><span class="linenos">369</span></a>
</span><span id="AirlineOperatingCentre.register_airport-370"><a href="#AirlineOperatingCentre.register_airport-370"><span class="linenos">370</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">airport</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mcts&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">mcts</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-371"><a href="#AirlineOperatingCentre.register_airport-371"><span class="linenos">371</span></a>												<span class="s1">&#39;tats&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">tats</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-372"><a href="#AirlineOperatingCentre.register_airport-372"><span class="linenos">372</span></a>												<span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_out_time</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-373"><a href="#AirlineOperatingCentre.register_airport-373"><span class="linenos">373</span></a>												<span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">avg_taxi_in_time</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-374"><a href="#AirlineOperatingCentre.register_airport-374"><span class="linenos">374</span></a>												<span class="s1">&#39;coords&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-375"><a href="#AirlineOperatingCentre.register_airport-375"><span class="linenos">375</span></a>												<span class="s1">&#39;dman_uid&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">dman_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-376"><a href="#AirlineOperatingCentre.register_airport-376"><span class="linenos">376</span></a>												<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">curfew</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_airport-377"><a href="#AirlineOperatingCentre.register_airport-377"><span class="linenos">377</span></a>												<span class="s1">&#39;ICAO&#39;</span><span class="p">:</span> <span class="n">airport</span><span class="o">.</span><span class="n">icao</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Add one airport to the list of airports in the AOC</p>

<p>mcts are designed so that one can do:
mcts = self.aoc_airports_info[airport_uid]['mcts']
mct = mcts[(self.aoc_flights_info[flight_uid1]['international'], self.aoc_flights_info[flight_uid2]['international'])]</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_pax_itinerary_group" class="classattr">
                                        <input id="AirlineOperatingCentre.register_pax_itinerary_group-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_pax_itinerary_group</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_pax_itinerary_group-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_pax_itinerary_group"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_pax_itinerary_group-379"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-379"><span class="linenos">379</span></a>	<span class="k">def</span> <span class="nf">register_pax_itinerary_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-380"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-380"><span class="linenos">380</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-381"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-381"><span class="linenos">381</span></a><span class="sd">		Register pax group (with its itineraries) in the airline</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-382"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-382"><span class="linenos">382</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-383"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-383"><span class="linenos">383</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-384"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-384"><span class="linenos">384</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-385"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-385"><span class="linenos">385</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.register_pax_itinerary_group-386"><a href="#AirlineOperatingCentre.register_pax_itinerary_group-386"><span class="linenos">386</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;pax_to_board_initial&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Register pax group (with its itineraries) in the airline</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_trajectories_pool" class="classattr">
                                        <input id="AirlineOperatingCentre.register_trajectories_pool-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_trajectories_pool</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">trajectory_pool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_trajectories_pool-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_trajectories_pool"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_trajectories_pool-388"><a href="#AirlineOperatingCentre.register_trajectories_pool-388"><span class="linenos">388</span></a>	<span class="k">def</span> <span class="nf">register_trajectories_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trajectory_pool</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_trajectories_pool-389"><a href="#AirlineOperatingCentre.register_trajectories_pool-389"><span class="linenos">389</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_trajectories_pool-390"><a href="#AirlineOperatingCentre.register_trajectories_pool-390"><span class="linenos">390</span></a><span class="sd">		Register pool of trajectories. If generating FP on the fly</span>
</span><span id="AirlineOperatingCentre.register_trajectories_pool-391"><a href="#AirlineOperatingCentre.register_trajectories_pool-391"><span class="linenos">391</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_trajectories_pool-392"><a href="#AirlineOperatingCentre.register_trajectories_pool-392"><span class="linenos">392</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">trajectory_pool</span> <span class="o">=</span> <span class="n">trajectory_pool</span>
</span></pre></div>


            <div class="docstring"><p>Register pool of trajectories. If generating FP on the fly</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_fp_pool" class="classattr">
                                        <input id="AirlineOperatingCentre.register_fp_pool-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_fp_pool</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">fp_pool</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_fp_pool-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_fp_pool"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_fp_pool-394"><a href="#AirlineOperatingCentre.register_fp_pool-394"><span class="linenos">394</span></a>	<span class="k">def</span> <span class="nf">register_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp_pool</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_fp_pool-395"><a href="#AirlineOperatingCentre.register_fp_pool-395"><span class="linenos">395</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_fp_pool-396"><a href="#AirlineOperatingCentre.register_fp_pool-396"><span class="linenos">396</span></a><span class="sd">		Register poool of flight plans.</span>
</span><span id="AirlineOperatingCentre.register_fp_pool-397"><a href="#AirlineOperatingCentre.register_fp_pool-397"><span class="linenos">397</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_fp_pool-398"><a href="#AirlineOperatingCentre.register_fp_pool-398"><span class="linenos">398</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_pool</span> <span class="o">=</span> <span class="n">fp_pool</span>
</span></pre></div>


            <div class="docstring"><p>Register poool of flight plans.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_nm" class="classattr">
                                        <input id="AirlineOperatingCentre.register_nm-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_nm</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">nm</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_nm-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_nm"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_nm-400"><a href="#AirlineOperatingCentre.register_nm-400"><span class="linenos">400</span></a>	<span class="k">def</span> <span class="nf">register_nm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_nm-401"><a href="#AirlineOperatingCentre.register_nm-401"><span class="linenos">401</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_nm-402"><a href="#AirlineOperatingCentre.register_nm-402"><span class="linenos">402</span></a><span class="sd">		Register NetworkManager</span>
</span><span id="AirlineOperatingCentre.register_nm-403"><a href="#AirlineOperatingCentre.register_nm-403"><span class="linenos">403</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_nm-404"><a href="#AirlineOperatingCentre.register_nm-404"><span class="linenos">404</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">nm_uid</span> <span class="o">=</span> <span class="n">nm</span><span class="o">.</span><span class="n">uid</span>
</span></pre></div>


            <div class="docstring"><p>Register NetworkManager</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.register_flight" class="classattr">
                                        <input id="AirlineOperatingCentre.register_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">register_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.register_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.register_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.register_flight-406"><a href="#AirlineOperatingCentre.register_flight-406"><span class="linenos">406</span></a>	<span class="k">def</span> <span class="nf">register_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.register_flight-407"><a href="#AirlineOperatingCentre.register_flight-407"><span class="linenos">407</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_flight-408"><a href="#AirlineOperatingCentre.register_flight-408"><span class="linenos">408</span></a><span class="sd">		Register a flight in the AOC.</span>
</span><span id="AirlineOperatingCentre.register_flight-409"><a href="#AirlineOperatingCentre.register_flight-409"><span class="linenos">409</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.register_flight-410"><a href="#AirlineOperatingCentre.register_flight-410"><span class="linenos">410</span></a>
</span><span id="AirlineOperatingCentre.register_flight-411"><a href="#AirlineOperatingCentre.register_flight-411"><span class="linenos">411</span></a>		<span class="c1"># Give DMAN id to flight</span>
</span><span id="AirlineOperatingCentre.register_flight-412"><a href="#AirlineOperatingCentre.register_flight-412"><span class="linenos">412</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">dman_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;dman_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre.register_flight-413"><a href="#AirlineOperatingCentre.register_flight-413"><span class="linenos">413</span></a>
</span><span id="AirlineOperatingCentre.register_flight-414"><a href="#AirlineOperatingCentre.register_flight-414"><span class="linenos">414</span></a>		<span class="c1"># # Add flight to the list that the aircraft needs to operate</span>
</span><span id="AirlineOperatingCentre.register_flight-415"><a href="#AirlineOperatingCentre.register_flight-415"><span class="linenos">415</span></a>		<span class="c1"># self.aircraft_list[flight.ac_uid].add_flight(flight.uid)</span>
</span><span id="AirlineOperatingCentre.register_flight-416"><a href="#AirlineOperatingCentre.register_flight-416"><span class="linenos">416</span></a>
</span><span id="AirlineOperatingCentre.register_flight-417"><a href="#AirlineOperatingCentre.register_flight-417"><span class="linenos">417</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AirlineOperatingCentre.register_flight-418"><a href="#AirlineOperatingCentre.register_flight-418"><span class="linenos">418</span></a>									<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-419"><a href="#AirlineOperatingCentre.register_flight-419"><span class="linenos">419</span></a>									<span class="s1">&#39;flight_db_id&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-420"><a href="#AirlineOperatingCentre.register_flight-420"><span class="linenos">420</span></a>									<span class="s1">&#39;callsign&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">callsign</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-421"><a href="#AirlineOperatingCentre.register_flight-421"><span class="linenos">421</span></a>									<span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;scheduled&#39;</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-422"><a href="#AirlineOperatingCentre.register_flight-422"><span class="linenos">422</span></a>									<span class="s1">&#39;international&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">international</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-423"><a href="#AirlineOperatingCentre.register_flight-423"><span class="linenos">423</span></a>
</span><span id="AirlineOperatingCentre.register_flight-424"><a href="#AirlineOperatingCentre.register_flight-424"><span class="linenos">424</span></a>									<span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">origin_airport_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-425"><a href="#AirlineOperatingCentre.register_flight-425"><span class="linenos">425</span></a>									<span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">destination_airport_uid</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-426"><a href="#AirlineOperatingCentre.register_flight-426"><span class="linenos">426</span></a>
</span><span id="AirlineOperatingCentre.register_flight-427"><a href="#AirlineOperatingCentre.register_flight-427"><span class="linenos">427</span></a>									<span class="s1">&#39;sobt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sobt</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre.register_flight-428"><a href="#AirlineOperatingCentre.register_flight-428"><span class="linenos">428</span></a>									<span class="s1">&#39;sibt&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">sibt</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre.register_flight-429"><a href="#AirlineOperatingCentre.register_flight-429"><span class="linenos">429</span></a>									<span class="s1">&#39;curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">curfew</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre.register_flight-430"><a href="#AirlineOperatingCentre.register_flight-430"><span class="linenos">430</span></a>									<span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">can_propagate_to_curfew</span><span class="p">),</span>
</span><span id="AirlineOperatingCentre.register_flight-431"><a href="#AirlineOperatingCentre.register_flight-431"><span class="linenos">431</span></a>
</span><span id="AirlineOperatingCentre.register_flight-432"><a href="#AirlineOperatingCentre.register_flight-432"><span class="linenos">432</span></a>									<span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">],</span>
</span><span id="AirlineOperatingCentre.register_flight-433"><a href="#AirlineOperatingCentre.register_flight-433"><span class="linenos">433</span></a>
</span><span id="AirlineOperatingCentre.register_flight-434"><a href="#AirlineOperatingCentre.register_flight-434"><span class="linenos">434</span></a>									<span class="s1">&#39;fp_options&#39;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-435"><a href="#AirlineOperatingCentre.register_flight-435"><span class="linenos">435</span></a>									<span class="s1">&#39;fp_option&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-436"><a href="#AirlineOperatingCentre.register_flight-436"><span class="linenos">436</span></a>									<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-437"><a href="#AirlineOperatingCentre.register_flight-437"><span class="linenos">437</span></a>									<span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-438"><a href="#AirlineOperatingCentre.register_flight-438"><span class="linenos">438</span></a>									<span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-439"><a href="#AirlineOperatingCentre.register_flight-439"><span class="linenos">439</span></a>
</span><span id="AirlineOperatingCentre.register_flight-440"><a href="#AirlineOperatingCentre.register_flight-440"><span class="linenos">440</span></a>									<span class="s2">&quot;pax_to_board_initial&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-441"><a href="#AirlineOperatingCentre.register_flight-441"><span class="linenos">441</span></a>									<span class="s2">&quot;pax_to_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-442"><a href="#AirlineOperatingCentre.register_flight-442"><span class="linenos">442</span></a>									<span class="s2">&quot;pax_on_board&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-443"><a href="#AirlineOperatingCentre.register_flight-443"><span class="linenos">443</span></a>
</span><span id="AirlineOperatingCentre.register_flight-444"><a href="#AirlineOperatingCentre.register_flight-444"><span class="linenos">444</span></a>									<span class="c1"># pax lists for waiting pax</span>
</span><span id="AirlineOperatingCentre.register_flight-445"><a href="#AirlineOperatingCentre.register_flight-445"><span class="linenos">445</span></a>									<span class="s2">&quot;pax_ready_to_board_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-446"><a href="#AirlineOperatingCentre.register_flight-446"><span class="linenos">446</span></a>									<span class="s2">&quot;pax_to_wait_checklist&quot;</span><span class="p">:</span> <span class="p">[],</span>
</span><span id="AirlineOperatingCentre.register_flight-447"><a href="#AirlineOperatingCentre.register_flight-447"><span class="linenos">447</span></a>									<span class="s2">&quot;pax_check_already_performed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-448"><a href="#AirlineOperatingCentre.register_flight-448"><span class="linenos">448</span></a>
</span><span id="AirlineOperatingCentre.register_flight-449"><a href="#AirlineOperatingCentre.register_flight-449"><span class="linenos">449</span></a>									<span class="s1">&#39;FP_submission_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-450"><a href="#AirlineOperatingCentre.register_flight-450"><span class="linenos">450</span></a>									<span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-451"><a href="#AirlineOperatingCentre.register_flight-451"><span class="linenos">451</span></a>									<span class="s1">&#39;push_back_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-452"><a href="#AirlineOperatingCentre.register_flight-452"><span class="linenos">452</span></a>									<span class="s1">&#39;pax_check_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-453"><a href="#AirlineOperatingCentre.register_flight-453"><span class="linenos">453</span></a>									<span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-454"><a href="#AirlineOperatingCentre.register_flight-454"><span class="linenos">454</span></a>									<span class="s1">&#39;takeoff_event&#39;</span><span class="p">:</span> <span class="n">flight</span><span class="o">.</span><span class="n">takeoff_event</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-455"><a href="#AirlineOperatingCentre.register_flight-455"><span class="linenos">455</span></a>
</span><span id="AirlineOperatingCentre.register_flight-456"><a href="#AirlineOperatingCentre.register_flight-456"><span class="linenos">456</span></a>									<span class="s1">&#39;DOC&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-457"><a href="#AirlineOperatingCentre.register_flight-457"><span class="linenos">457</span></a>									<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-458"><a href="#AirlineOperatingCentre.register_flight-458"><span class="linenos">458</span></a>									<span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-459"><a href="#AirlineOperatingCentre.register_flight-459"><span class="linenos">459</span></a>									<span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-460"><a href="#AirlineOperatingCentre.register_flight-460"><span class="linenos">460</span></a>									<span class="s1">&#39;non_pax_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-461"><a href="#AirlineOperatingCentre.register_flight-461"><span class="linenos">461</span></a>									<span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-462"><a href="#AirlineOperatingCentre.register_flight-462"><span class="linenos">462</span></a>
</span><span id="AirlineOperatingCentre.register_flight-463"><a href="#AirlineOperatingCentre.register_flight-463"><span class="linenos">463</span></a>									<span class="s1">&#39;main_reason_delay&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-464"><a href="#AirlineOperatingCentre.register_flight-464"><span class="linenos">464</span></a>
</span><span id="AirlineOperatingCentre.register_flight-465"><a href="#AirlineOperatingCentre.register_flight-465"><span class="linenos">465</span></a>									<span class="c1"># &#39;flight_swaps&#39;:[],</span>
</span><span id="AirlineOperatingCentre.register_flight-466"><a href="#AirlineOperatingCentre.register_flight-466"><span class="linenos">466</span></a>									<span class="c1"># &#39;cost_swaps&#39;:[],</span>
</span><span id="AirlineOperatingCentre.register_flight-467"><a href="#AirlineOperatingCentre.register_flight-467"><span class="linenos">467</span></a>									<span class="c1"># &#39;id_swaps&#39;:[]</span>
</span><span id="AirlineOperatingCentre.register_flight-468"><a href="#AirlineOperatingCentre.register_flight-468"><span class="linenos">468</span></a>									<span class="p">}</span>
</span><span id="AirlineOperatingCentre.register_flight-469"><a href="#AirlineOperatingCentre.register_flight-469"><span class="linenos">469</span></a>
</span><span id="AirlineOperatingCentre.register_flight-470"><a href="#AirlineOperatingCentre.register_flight-470"><span class="linenos">470</span></a>		<span class="c1"># Give aircraft to flight</span>
</span><span id="AirlineOperatingCentre.register_flight-471"><a href="#AirlineOperatingCentre.register_flight-471"><span class="linenos">471</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aircraft_list</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">ac_uid</span><span class="p">]</span>
</span><span id="AirlineOperatingCentre.register_flight-472"><a href="#AirlineOperatingCentre.register_flight-472"><span class="linenos">472</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aircraft</span><span class="o">.</span><span class="n">add_flight</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.register_flight-473"><a href="#AirlineOperatingCentre.register_flight-473"><span class="linenos">473</span></a>
</span><span id="AirlineOperatingCentre.register_flight-474"><a href="#AirlineOperatingCentre.register_flight-474"><span class="linenos">474</span></a>		<span class="c1"># Give some info to flight on airline</span>
</span><span id="AirlineOperatingCentre.register_flight-475"><a href="#AirlineOperatingCentre.register_flight-475"><span class="linenos">475</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">airline_type</span>
</span><span id="AirlineOperatingCentre.register_flight-476"><a href="#AirlineOperatingCentre.register_flight-476"><span class="linenos">476</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;ao_icao&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">icao</span>
</span><span id="AirlineOperatingCentre.register_flight-477"><a href="#AirlineOperatingCentre.register_flight-477"><span class="linenos">477</span></a>		<span class="n">flight</span><span class="o">.</span><span class="n">aoc_info</span><span class="p">[</span><span class="s1">&#39;aoc_uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineOperatingCentre.register_flight-478"><a href="#AirlineOperatingCentre.register_flight-478"><span class="linenos">478</span></a>
</span><span id="AirlineOperatingCentre.register_flight-479"><a href="#AirlineOperatingCentre.register_flight-479"><span class="linenos">479</span></a>		<span class="c1"># Using wait_until allows to wait for a time and then succeed the event.</span>
</span><span id="AirlineOperatingCentre.register_flight-480"><a href="#AirlineOperatingCentre.register_flight-480"><span class="linenos">480</span></a>		<span class="c1"># The event should not be the process itself, because if a reschedule</span>
</span><span id="AirlineOperatingCentre.register_flight-481"><a href="#AirlineOperatingCentre.register_flight-481"><span class="linenos">481</span></a>		<span class="c1"># happens, one needs to cancel the wait_until process but keep the pointer</span>
</span><span id="AirlineOperatingCentre.register_flight-482"><a href="#AirlineOperatingCentre.register_flight-482"><span class="linenos">482</span></a>		<span class="c1"># to the event itself, since it is likely to be shared with other agents.</span>
</span><span id="AirlineOperatingCentre.register_flight-483"><a href="#AirlineOperatingCentre.register_flight-483"><span class="linenos">483</span></a>		<span class="c1"># This procedure should be used for anything with a waiting time (which may be rescheduled).</span>
</span><span id="AirlineOperatingCentre.register_flight-484"><a href="#AirlineOperatingCentre.register_flight-484"><span class="linenos">484</span></a>		<span class="c1"># There is no need for this in the case of the event happens at the end of a given process</span>
</span><span id="AirlineOperatingCentre.register_flight-485"><a href="#AirlineOperatingCentre.register_flight-485"><span class="linenos">485</span></a>		<span class="c1"># (e.g. flying a segment).</span>
</span><span id="AirlineOperatingCentre.register_flight-486"><a href="#AirlineOperatingCentre.register_flight-486"><span class="linenos">486</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre.register_flight-487"><a href="#AirlineOperatingCentre.register_flight-487"><span class="linenos">487</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre.register_flight-488"><a href="#AirlineOperatingCentre.register_flight-488"><span class="linenos">488</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre.register_flight-489"><a href="#AirlineOperatingCentre.register_flight-489"><span class="linenos">489</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">fpip</span><span class="o">.</span><span class="n">get_eobt</span><span class="p">()))</span>
</span><span id="AirlineOperatingCentre.register_flight-490"><a href="#AirlineOperatingCentre.register_flight-490"><span class="linenos">490</span></a>
</span><span id="AirlineOperatingCentre.register_flight-491"><a href="#AirlineOperatingCentre.register_flight-491"><span class="linenos">491</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_FP_submission</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">FP_submission_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-492"><a href="#AirlineOperatingCentre.register_flight-492"><span class="linenos">492</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_delay_estimation</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">delay_estimation_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-493"><a href="#AirlineOperatingCentre.register_flight-493"><span class="linenos">493</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">check_pax_ready_to_board</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">pax_check_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-494"><a href="#AirlineOperatingCentre.register_flight-494"><span class="linenos">494</span></a>
</span><span id="AirlineOperatingCentre.register_flight-495"><a href="#AirlineOperatingCentre.register_flight-495"><span class="linenos">495</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-496"><a href="#AirlineOperatingCentre.register_flight-496"><span class="linenos">496</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">check_push_back</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-497"><a href="#AirlineOperatingCentre.register_flight-497"><span class="linenos">497</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">check_arrival</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">arrival_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-498"><a href="#AirlineOperatingCentre.register_flight-498"><span class="linenos">498</span></a>
</span><span id="AirlineOperatingCentre.register_flight-499"><a href="#AirlineOperatingCentre.register_flight-499"><span class="linenos">499</span></a>		<span class="c1"># for dci</span>
</span><span id="AirlineOperatingCentre.register_flight-500"><a href="#AirlineOperatingCentre.register_flight-500"><span class="linenos">500</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">cost_index_assessment</span><span class="p">(</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">flight</span><span class="o">.</span><span class="n">push_back_ready_event</span><span class="p">))</span>
</span><span id="AirlineOperatingCentre.register_flight-501"><a href="#AirlineOperatingCentre.register_flight-501"><span class="linenos">501</span></a>
</span><span id="AirlineOperatingCentre.register_flight-502"><a href="#AirlineOperatingCentre.register_flight-502"><span class="linenos">502</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">flight</span><span class="o">.</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># for connecting pax wait!</span>
</span><span id="AirlineOperatingCentre.register_flight-503"><a href="#AirlineOperatingCentre.register_flight-503"><span class="linenos">503</span></a>													<span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineOperatingCentre.register_flight-504"><a href="#AirlineOperatingCentre.register_flight-504"><span class="linenos">504</span></a>													<span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Register a flight in the AOC.</p>
</div>


                            </div>
                            <div id="AirlineOperatingCentre.receive" class="classattr">
                                        <input id="AirlineOperatingCentre.receive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">receive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineOperatingCentre.receive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineOperatingCentre.receive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineOperatingCentre.receive-506"><a href="#AirlineOperatingCentre.receive-506"><span class="linenos">506</span></a>	<span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineOperatingCentre.receive-507"><a href="#AirlineOperatingCentre.receive-507"><span class="linenos">507</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.receive-508"><a href="#AirlineOperatingCentre.receive-508"><span class="linenos">508</span></a><span class="sd">		Receive and distribute messages within the Agent</span>
</span><span id="AirlineOperatingCentre.receive-509"><a href="#AirlineOperatingCentre.receive-509"><span class="linenos">509</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineOperatingCentre.receive-510"><a href="#AirlineOperatingCentre.receive-510"><span class="linenos">510</span></a>
</span><span id="AirlineOperatingCentre.receive-511"><a href="#AirlineOperatingCentre.receive-511"><span class="linenos">511</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;allocation_pax_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-512"><a href="#AirlineOperatingCentre.receive-512"><span class="linenos">512</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_allocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-513"><a href="#AirlineOperatingCentre.receive-513"><span class="linenos">513</span></a>
</span><span id="AirlineOperatingCentre.receive-514"><a href="#AirlineOperatingCentre.receive-514"><span class="linenos">514</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;connecting_times&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-515"><a href="#AirlineOperatingCentre.receive-515"><span class="linenos">515</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_connecting_times</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-516"><a href="#AirlineOperatingCentre.receive-516"><span class="linenos">516</span></a>
</span><span id="AirlineOperatingCentre.receive-517"><a href="#AirlineOperatingCentre.receive-517"><span class="linenos">517</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-518"><a href="#AirlineOperatingCentre.receive-518"><span class="linenos">518</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-519"><a href="#AirlineOperatingCentre.receive-519"><span class="linenos">519</span></a>
</span><span id="AirlineOperatingCentre.receive-520"><a href="#AirlineOperatingCentre.receive-520"><span class="linenos">520</span></a>		<span class="c1"># elif msg[&#39;type&#39;] == &#39;flight_plan_request&#39;:</span>
</span><span id="AirlineOperatingCentre.receive-521"><a href="#AirlineOperatingCentre.receive-521"><span class="linenos">521</span></a>		<span class="c1"># 	self.afp.wait_for_FP_request(msg)</span>
</span><span id="AirlineOperatingCentre.receive-522"><a href="#AirlineOperatingCentre.receive-522"><span class="linenos">522</span></a>
</span><span id="AirlineOperatingCentre.receive-523"><a href="#AirlineOperatingCentre.receive-523"><span class="linenos">523</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_plan_acceptance&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-524"><a href="#AirlineOperatingCentre.receive-524"><span class="linenos">524</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_FP_acceptance</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-525"><a href="#AirlineOperatingCentre.receive-525"><span class="linenos">525</span></a>
</span><span id="AirlineOperatingCentre.receive-526"><a href="#AirlineOperatingCentre.receive-526"><span class="linenos">526</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;atfm_delay&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-527"><a href="#AirlineOperatingCentre.receive-527"><span class="linenos">527</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_atfm_slot</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-528"><a href="#AirlineOperatingCentre.receive-528"><span class="linenos">528</span></a>
</span><span id="AirlineOperatingCentre.receive-529"><a href="#AirlineOperatingCentre.receive-529"><span class="linenos">529</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;turnaround_time&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-530"><a href="#AirlineOperatingCentre.receive-530"><span class="linenos">530</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">wait_for_turnaround_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-531"><a href="#AirlineOperatingCentre.receive-531"><span class="linenos">531</span></a>
</span><span id="AirlineOperatingCentre.receive-532"><a href="#AirlineOperatingCentre.receive-532"><span class="linenos">532</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;departing_reassessment_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-533"><a href="#AirlineOperatingCentre.receive-533"><span class="linenos">533</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-534"><a href="#AirlineOperatingCentre.receive-534"><span class="linenos">534</span></a>
</span><span id="AirlineOperatingCentre.receive-535"><a href="#AirlineOperatingCentre.receive-535"><span class="linenos">535</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pax_connection_handling&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-536"><a href="#AirlineOperatingCentre.receive-536"><span class="linenos">536</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-537"><a href="#AirlineOperatingCentre.receive-537"><span class="linenos">537</span></a>
</span><span id="AirlineOperatingCentre.receive-538"><a href="#AirlineOperatingCentre.receive-538"><span class="linenos">538</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-539"><a href="#AirlineOperatingCentre.receive-539"><span class="linenos">539</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-540"><a href="#AirlineOperatingCentre.receive-540"><span class="linenos">540</span></a>
</span><span id="AirlineOperatingCentre.receive-541"><a href="#AirlineOperatingCentre.receive-541"><span class="linenos">541</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cost_blame&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-542"><a href="#AirlineOperatingCentre.receive-542"><span class="linenos">542</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_cost_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-543"><a href="#AirlineOperatingCentre.receive-543"><span class="linenos">543</span></a>
</span><span id="AirlineOperatingCentre.receive-544"><a href="#AirlineOperatingCentre.receive-544"><span class="linenos">544</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;follow_blame&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-545"><a href="#AirlineOperatingCentre.receive-545"><span class="linenos">545</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_follow_blame</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-546"><a href="#AirlineOperatingCentre.receive-546"><span class="linenos">546</span></a>
</span><span id="AirlineOperatingCentre.receive-547"><a href="#AirlineOperatingCentre.receive-547"><span class="linenos">547</span></a>		<span class="c1"># wfp &amp; dci</span>
</span><span id="AirlineOperatingCentre.receive-548"><a href="#AirlineOperatingCentre.receive-548"><span class="linenos">548</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_flight_plan&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-549"><a href="#AirlineOperatingCentre.receive-549"><span class="linenos">549</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-550"><a href="#AirlineOperatingCentre.receive-550"><span class="linenos">550</span></a>
</span><span id="AirlineOperatingCentre.receive-551"><a href="#AirlineOperatingCentre.receive-551"><span class="linenos">551</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-552"><a href="#AirlineOperatingCentre.receive-552"><span class="linenos">552</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-553"><a href="#AirlineOperatingCentre.receive-553"><span class="linenos">553</span></a>
</span><span id="AirlineOperatingCentre.receive-554"><a href="#AirlineOperatingCentre.receive-554"><span class="linenos">554</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;flight_potential_delay_recover_information&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-555"><a href="#AirlineOperatingCentre.receive-555"><span class="linenos">555</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-556"><a href="#AirlineOperatingCentre.receive-556"><span class="linenos">556</span></a>
</span><span id="AirlineOperatingCentre.receive-557"><a href="#AirlineOperatingCentre.receive-557"><span class="linenos">557</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;toc_reached&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-558"><a href="#AirlineOperatingCentre.receive-558"><span class="linenos">558</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dcic</span><span class="o">.</span><span class="n">wait_for_toc_reached_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-559"><a href="#AirlineOperatingCentre.receive-559"><span class="linenos">559</span></a>
</span><span id="AirlineOperatingCentre.receive-560"><a href="#AirlineOperatingCentre.receive-560"><span class="linenos">560</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_time_propagate_delay&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-561"><a href="#AirlineOperatingCentre.receive-561"><span class="linenos">561</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-562"><a href="#AirlineOperatingCentre.receive-562"><span class="linenos">562</span></a>
</span><span id="AirlineOperatingCentre.receive-563"><a href="#AirlineOperatingCentre.receive-563"><span class="linenos">563</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_cost_delay_function&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-564"><a href="#AirlineOperatingCentre.receive-564"><span class="linenos">564</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-565"><a href="#AirlineOperatingCentre.receive-565"><span class="linenos">565</span></a>
</span><span id="AirlineOperatingCentre.receive-566"><a href="#AirlineOperatingCentre.receive-566"><span class="linenos">566</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancel_flight_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-567"><a href="#AirlineOperatingCentre.receive-567"><span class="linenos">567</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_cancel_flight_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-568"><a href="#AirlineOperatingCentre.receive-568"><span class="linenos">568</span></a>
</span><span id="AirlineOperatingCentre.receive-569"><a href="#AirlineOperatingCentre.receive-569"><span class="linenos">569</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;select_flight_option_request&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-570"><a href="#AirlineOperatingCentre.receive-570"><span class="linenos">570</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fps</span><span class="o">.</span><span class="n">wait_for_fp_selection_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-571"><a href="#AirlineOperatingCentre.receive-571"><span class="linenos">571</span></a>
</span><span id="AirlineOperatingCentre.receive-572"><a href="#AirlineOperatingCentre.receive-572"><span class="linenos">572</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reply_option_selected&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-573"><a href="#AirlineOperatingCentre.receive-573"><span class="linenos">573</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_fp_option_selection</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-574"><a href="#AirlineOperatingCentre.receive-574"><span class="linenos">574</span></a>
</span><span id="AirlineOperatingCentre.receive-575"><a href="#AirlineOperatingCentre.receive-575"><span class="linenos">575</span></a>		<span class="k">elif</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;request_hotspot_decision&#39;</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-576"><a href="#AirlineOperatingCentre.receive-576"><span class="linenos">576</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-577"><a href="#AirlineOperatingCentre.receive-577"><span class="linenos">577</span></a>
</span><span id="AirlineOperatingCentre.receive-578"><a href="#AirlineOperatingCentre.receive-578"><span class="linenos">578</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-579"><a href="#AirlineOperatingCentre.receive-579"><span class="linenos">579</span></a>			<span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineOperatingCentre.receive-580"><a href="#AirlineOperatingCentre.receive-580"><span class="linenos">580</span></a>			<span class="k">for</span> <span class="n">receive_function</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">receive_module_functions</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-581"><a href="#AirlineOperatingCentre.receive-581"><span class="linenos">581</span></a>				<span class="n">hit</span> <span class="o">=</span> <span class="n">receive_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineOperatingCentre.receive-582"><a href="#AirlineOperatingCentre.receive-582"><span class="linenos">582</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
</span><span id="AirlineOperatingCentre.receive-583"><a href="#AirlineOperatingCentre.receive-583"><span class="linenos">583</span></a>				<span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;WARNING: unrecognised message type received by&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Receive and distribute messages within the Agent</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Agent">Mercury.agents.agent_base.Agent</a></dt>
                                <dd id="AirlineOperatingCentre.id" class="variable"><a href="agent_base.html#Agent.id">id</a></dd>
                <dd id="AirlineOperatingCentre.paras" class="variable"><a href="agent_base.html#Agent.paras">paras</a></dd>
                <dd id="AirlineOperatingCentre.letterbox" class="variable"><a href="agent_base.html#Agent.letterbox">letterbox</a></dd>
                <dd id="AirlineOperatingCentre.env" class="variable"><a href="agent_base.html#Agent.env">env</a></dd>
                <dd id="AirlineOperatingCentre.acolor" class="variable"><a href="agent_base.html#Agent.acolor">acolor</a></dd>
                <dd id="AirlineOperatingCentre.mcolor" class="variable"><a href="agent_base.html#Agent.mcolor">mcolor</a></dd>
                <dd id="AirlineOperatingCentre.verbose" class="variable"><a href="agent_base.html#Agent.verbose">verbose</a></dd>
                <dd id="AirlineOperatingCentre.log_file" class="variable"><a href="agent_base.html#Agent.log_file">log_file</a></dd>
                <dd id="AirlineOperatingCentre.receive_module_functions" class="variable"><a href="agent_base.html#Agent.receive_module_functions">receive_module_functions</a></dd>
                <dd id="AirlineOperatingCentre.on_prepare" class="variable"><a href="agent_base.html#Agent.on_prepare">on_prepare</a></dd>
                <dd id="AirlineOperatingCentre.on_finalise" class="variable"><a href="agent_base.html#Agent.on_finalise">on_finalise</a></dd>
                <dd id="AirlineOperatingCentre.on_init" class="variable"><a href="agent_base.html#Agent.on_init">on_init</a></dd>
                <dd id="AirlineOperatingCentre.apply_agent_modifications" class="function"><a href="agent_base.html#Agent.apply_agent_modifications">apply_agent_modifications</a></dd>
                <dd id="AirlineOperatingCentre.send" class="function"><a href="agent_base.html#Agent.send">send</a></dd>
                <dd id="AirlineOperatingCentre.prepare_for_simulation" class="function"><a href="agent_base.html#Agent.prepare_for_simulation">prepare_for_simulation</a></dd>
                <dd id="AirlineOperatingCentre.finalise" class="function"><a href="agent_base.html#Agent.finalise">finalise</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FlightPlanSelector">
                            <input id="FlightPlanSelector-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FlightPlanSelector</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="FlightPlanSelector-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector-592"><a href="#FlightPlanSelector-592"><span class="linenos">592</span></a><span class="k">class</span> <span class="nc">FlightPlanSelector</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="FlightPlanSelector-593"><a href="#FlightPlanSelector-593"><span class="linenos">593</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-594"><a href="#FlightPlanSelector-594"><span class="linenos">594</span></a><span class="sd">	FPS: Flight Plan Selector</span>
</span><span id="FlightPlanSelector-595"><a href="#FlightPlanSelector-595"><span class="linenos">595</span></a>
</span><span id="FlightPlanSelector-596"><a href="#FlightPlanSelector-596"><span class="linenos">596</span></a><span class="sd">	This role decides which FP to use considering the expected cost of different flight plan alternatives.</span>
</span><span id="FlightPlanSelector-597"><a href="#FlightPlanSelector-597"><span class="linenos">597</span></a><span class="sd">	It does the role of the dispatcher when selecting between alternative FP possibilities for a given flight.</span>
</span><span id="FlightPlanSelector-598"><a href="#FlightPlanSelector-598"><span class="linenos">598</span></a>
</span><span id="FlightPlanSelector-599"><a href="#FlightPlanSelector-599"><span class="linenos">599</span></a><span class="sd">	The need for this role is to provide the extraction of these functionalities to be done by an external agent.</span>
</span><span id="FlightPlanSelector-600"><a href="#FlightPlanSelector-600"><span class="linenos">600</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-601"><a href="#FlightPlanSelector-601"><span class="linenos">601</span></a>
</span><span id="FlightPlanSelector-602"><a href="#FlightPlanSelector-602"><span class="linenos">602</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="FlightPlanSelector-603"><a href="#FlightPlanSelector-603"><span class="linenos">603</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="FlightPlanSelector-604"><a href="#FlightPlanSelector-604"><span class="linenos">604</span></a>
</span><span id="FlightPlanSelector-605"><a href="#FlightPlanSelector-605"><span class="linenos">605</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary for each flight which flight plan has been selected</span>
</span><span id="FlightPlanSelector-606"><a href="#FlightPlanSelector-606"><span class="linenos">606</span></a>
</span><span id="FlightPlanSelector-607"><a href="#FlightPlanSelector-607"><span class="linenos">607</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_selection_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="FlightPlanSelector-608"><a href="#FlightPlanSelector-608"><span class="linenos">608</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-609"><a href="#FlightPlanSelector-609"><span class="linenos">609</span></a><span class="sd">		Entry point for the role. Getting a request to select a flight plan for a given flight from a list of</span>
</span><span id="FlightPlanSelector-610"><a href="#FlightPlanSelector-610"><span class="linenos">610</span></a><span class="sd">		alternatives.</span>
</span><span id="FlightPlanSelector-611"><a href="#FlightPlanSelector-611"><span class="linenos">611</span></a>
</span><span id="FlightPlanSelector-612"><a href="#FlightPlanSelector-612"><span class="linenos">612</span></a><span class="sd">		This only initialise the FP selected for the flight to nothing and calls the function to decide with FP to use</span>
</span><span id="FlightPlanSelector-613"><a href="#FlightPlanSelector-613"><span class="linenos">613</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-614"><a href="#FlightPlanSelector-614"><span class="linenos">614</span></a>
</span><span id="FlightPlanSelector-615"><a href="#FlightPlanSelector-615"><span class="linenos">615</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector-616"><a href="#FlightPlanSelector-616"><span class="linenos">616</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialise the flight plan for the flight with nothing selected</span>
</span><span id="FlightPlanSelector-617"><a href="#FlightPlanSelector-617"><span class="linenos">617</span></a>		<span class="c1"># yield self.agent.env.process(self.select_fp(cost_options=msg[&#39;body&#39;][&#39;cost_options&#39;],flight_uid=msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="FlightPlanSelector-618"><a href="#FlightPlanSelector-618"><span class="linenos">618</span></a>
</span><span id="FlightPlanSelector-619"><a href="#FlightPlanSelector-619"><span class="linenos">619</span></a>		<span class="c1"># Request the process of decide which fp to do for the flight</span>
</span><span id="FlightPlanSelector-620"><a href="#FlightPlanSelector-620"><span class="linenos">620</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_fp</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span><span id="FlightPlanSelector-621"><a href="#FlightPlanSelector-621"><span class="linenos">621</span></a>
</span><span id="FlightPlanSelector-622"><a href="#FlightPlanSelector-622"><span class="linenos">622</span></a>	<span class="k">def</span> <span class="nf">decide_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="FlightPlanSelector-623"><a href="#FlightPlanSelector-623"><span class="linenos">623</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-624"><a href="#FlightPlanSelector-624"><span class="linenos">624</span></a><span class="sd">		It requests the select_fp function do to the selection, updates the option selected and provides the</span>
</span><span id="FlightPlanSelector-625"><a href="#FlightPlanSelector-625"><span class="linenos">625</span></a><span class="sd">		fp selected back.</span>
</span><span id="FlightPlanSelector-626"><a href="#FlightPlanSelector-626"><span class="linenos">626</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-627"><a href="#FlightPlanSelector-627"><span class="linenos">627</span></a>
</span><span id="FlightPlanSelector-628"><a href="#FlightPlanSelector-628"><span class="linenos">628</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector-629"><a href="#FlightPlanSelector-629"><span class="linenos">629</span></a>
</span><span id="FlightPlanSelector-630"><a href="#FlightPlanSelector-630"><span class="linenos">630</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="FlightPlanSelector-631"><a href="#FlightPlanSelector-631"><span class="linenos">631</span></a>		<span class="c1"># 	print(&#39;AOC will decide which FP to choose for flight {}&#39;.format(flight_uid))</span>
</span><span id="FlightPlanSelector-632"><a href="#FlightPlanSelector-632"><span class="linenos">632</span></a>
</span><span id="FlightPlanSelector-633"><a href="#FlightPlanSelector-633"><span class="linenos">633</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_fp</span><span class="p">(</span><span class="n">cost_options</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_options&#39;</span><span class="p">],</span>
</span><span id="FlightPlanSelector-634"><a href="#FlightPlanSelector-634"><span class="linenos">634</span></a>														<span class="n">flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="FlightPlanSelector-635"><a href="#FlightPlanSelector-635"><span class="linenos">635</span></a>
</span><span id="FlightPlanSelector-636"><a href="#FlightPlanSelector-636"><span class="linenos">636</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="FlightPlanSelector-637"><a href="#FlightPlanSelector-637"><span class="linenos">637</span></a>
</span><span id="FlightPlanSelector-638"><a href="#FlightPlanSelector-638"><span class="linenos">638</span></a>		<span class="c1"># option_selected_fp = self.option_selected[flight_uid]</span>
</span><span id="FlightPlanSelector-639"><a href="#FlightPlanSelector-639"><span class="linenos">639</span></a>		<span class="c1"># self.send_option_selected(msg[&#39;to&#39;],option_selected_fp,msg[&#39;body&#39;][&#39;flight_uid&#39;])</span>
</span><span id="FlightPlanSelector-640"><a href="#FlightPlanSelector-640"><span class="linenos">640</span></a>
</span><span id="FlightPlanSelector-641"><a href="#FlightPlanSelector-641"><span class="linenos">641</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_option_selected</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">],</span> <span class="n">option</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="FlightPlanSelector-642"><a href="#FlightPlanSelector-642"><span class="linenos">642</span></a>
</span><span id="FlightPlanSelector-643"><a href="#FlightPlanSelector-643"><span class="linenos">643</span></a>	<span class="k">def</span> <span class="nf">select_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="FlightPlanSelector-644"><a href="#FlightPlanSelector-644"><span class="linenos">644</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-645"><a href="#FlightPlanSelector-645"><span class="linenos">645</span></a><span class="sd">		This is yield rather than a return to take into account the case</span>
</span><span id="FlightPlanSelector-646"><a href="#FlightPlanSelector-646"><span class="linenos">646</span></a><span class="sd">		where the agent is asynchronuous, e.g. when there is a human operator</span>
</span><span id="FlightPlanSelector-647"><a href="#FlightPlanSelector-647"><span class="linenos">647</span></a><span class="sd">		(see HMI_FP_SEL module).</span>
</span><span id="FlightPlanSelector-648"><a href="#FlightPlanSelector-648"><span class="linenos">648</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-649"><a href="#FlightPlanSelector-649"><span class="linenos">649</span></a>
</span><span id="FlightPlanSelector-650"><a href="#FlightPlanSelector-650"><span class="linenos">650</span></a>		<span class="n">costs</span> <span class="o">=</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;delay_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;crco_cost&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector-651"><a href="#FlightPlanSelector-651"><span class="linenos">651</span></a>
</span><span id="FlightPlanSelector-652"><a href="#FlightPlanSelector-652"><span class="linenos">652</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="FlightPlanSelector-653"><a href="#FlightPlanSelector-653"><span class="linenos">653</span></a>		<span class="c1"># 	print(&quot;SELECT FP {} (costs length: {})&quot;.format(flight_uid, len(costs)))</span>
</span><span id="FlightPlanSelector-654"><a href="#FlightPlanSelector-654"><span class="linenos">654</span></a>
</span><span id="FlightPlanSelector-655"><a href="#FlightPlanSelector-655"><span class="linenos">655</span></a>		<span class="n">costs_bis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">costs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">smoothness_fp</span><span class="p">)</span>
</span><span id="FlightPlanSelector-656"><a href="#FlightPlanSelector-656"><span class="linenos">656</span></a>		<span class="k">if</span> <span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
</span><span id="FlightPlanSelector-657"><a href="#FlightPlanSelector-657"><span class="linenos">657</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">costs_bis</span><span class="o">/</span><span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="FlightPlanSelector-658"><a href="#FlightPlanSelector-658"><span class="linenos">658</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="FlightPlanSelector-659"><a href="#FlightPlanSelector-659"><span class="linenos">659</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">))</span>
</span><span id="FlightPlanSelector-660"><a href="#FlightPlanSelector-660"><span class="linenos">660</span></a>			<span class="n">prob</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>
</span><span id="FlightPlanSelector-661"><a href="#FlightPlanSelector-661"><span class="linenos">661</span></a>
</span><span id="FlightPlanSelector-662"><a href="#FlightPlanSelector-662"><span class="linenos">662</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">))),</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
</span><span id="FlightPlanSelector-663"><a href="#FlightPlanSelector-663"><span class="linenos">663</span></a>
</span><span id="FlightPlanSelector-664"><a href="#FlightPlanSelector-664"><span class="linenos">664</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="FlightPlanSelector-665"><a href="#FlightPlanSelector-665"><span class="linenos">665</span></a>
</span><span id="FlightPlanSelector-666"><a href="#FlightPlanSelector-666"><span class="linenos">666</span></a>	<span class="k">def</span> <span class="nf">send_option_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="FlightPlanSelector-667"><a href="#FlightPlanSelector-667"><span class="linenos">667</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-668"><a href="#FlightPlanSelector-668"><span class="linenos">668</span></a><span class="sd">		Reply back with the fp that has been selected for the flight.</span>
</span><span id="FlightPlanSelector-669"><a href="#FlightPlanSelector-669"><span class="linenos">669</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector-670"><a href="#FlightPlanSelector-670"><span class="linenos">670</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="FlightPlanSelector-671"><a href="#FlightPlanSelector-671"><span class="linenos">671</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span>
</span><span id="FlightPlanSelector-672"><a href="#FlightPlanSelector-672"><span class="linenos">672</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reply_option_selected&#39;</span>
</span><span id="FlightPlanSelector-673"><a href="#FlightPlanSelector-673"><span class="linenos">673</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">:</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="FlightPlanSelector-674"><a href="#FlightPlanSelector-674"><span class="linenos">674</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>FPS: Flight Plan Selector</p>

<p>This role decides which FP to use considering the expected cost of different flight plan alternatives.
It does the role of the dispatcher when selecting between alternative FP possibilities for a given flight.</p>

<p>The need for this role is to provide the extraction of these functionalities to be done by an external agent.</p>
</div>


                            <div id="FlightPlanSelector.__init__" class="classattr">
                                        <input id="FlightPlanSelector.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FlightPlanSelector</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">agent</span></span>)</span>

                <label class="view-source-button" for="FlightPlanSelector.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector.__init__-602"><a href="#FlightPlanSelector.__init__-602"><span class="linenos">602</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="FlightPlanSelector.__init__-603"><a href="#FlightPlanSelector.__init__-603"><span class="linenos">603</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="FlightPlanSelector.__init__-604"><a href="#FlightPlanSelector.__init__-604"><span class="linenos">604</span></a>
</span><span id="FlightPlanSelector.__init__-605"><a href="#FlightPlanSelector.__init__-605"><span class="linenos">605</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary for each flight which flight plan has been selected</span>
</span></pre></div>


            <div class="docstring"><p>On initialisation of a Role, it gets a pointer to the Agent it belongs to.</p>
</div>


                            </div>
                            <div id="FlightPlanSelector.option_selected" class="classattr">
                                <div class="attr variable">
            <span class="name">option_selected</span>

        
    </div>
    <a class="headerlink" href="#FlightPlanSelector.option_selected"></a>
    
    

                            </div>
                            <div id="FlightPlanSelector.wait_for_fp_selection_request" class="classattr">
                                        <input id="FlightPlanSelector.wait_for_fp_selection_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_fp_selection_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FlightPlanSelector.wait_for_fp_selection_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector.wait_for_fp_selection_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector.wait_for_fp_selection_request-607"><a href="#FlightPlanSelector.wait_for_fp_selection_request-607"><span class="linenos">607</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_selection_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-608"><a href="#FlightPlanSelector.wait_for_fp_selection_request-608"><span class="linenos">608</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-609"><a href="#FlightPlanSelector.wait_for_fp_selection_request-609"><span class="linenos">609</span></a><span class="sd">		Entry point for the role. Getting a request to select a flight plan for a given flight from a list of</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-610"><a href="#FlightPlanSelector.wait_for_fp_selection_request-610"><span class="linenos">610</span></a><span class="sd">		alternatives.</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-611"><a href="#FlightPlanSelector.wait_for_fp_selection_request-611"><span class="linenos">611</span></a>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-612"><a href="#FlightPlanSelector.wait_for_fp_selection_request-612"><span class="linenos">612</span></a><span class="sd">		This only initialise the FP selected for the flight to nothing and calls the function to decide with FP to use</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-613"><a href="#FlightPlanSelector.wait_for_fp_selection_request-613"><span class="linenos">613</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-614"><a href="#FlightPlanSelector.wait_for_fp_selection_request-614"><span class="linenos">614</span></a>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-615"><a href="#FlightPlanSelector.wait_for_fp_selection_request-615"><span class="linenos">615</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-616"><a href="#FlightPlanSelector.wait_for_fp_selection_request-616"><span class="linenos">616</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Initialise the flight plan for the flight with nothing selected</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-617"><a href="#FlightPlanSelector.wait_for_fp_selection_request-617"><span class="linenos">617</span></a>		<span class="c1"># yield self.agent.env.process(self.select_fp(cost_options=msg[&#39;body&#39;][&#39;cost_options&#39;],flight_uid=msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-618"><a href="#FlightPlanSelector.wait_for_fp_selection_request-618"><span class="linenos">618</span></a>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-619"><a href="#FlightPlanSelector.wait_for_fp_selection_request-619"><span class="linenos">619</span></a>		<span class="c1"># Request the process of decide which fp to do for the flight</span>
</span><span id="FlightPlanSelector.wait_for_fp_selection_request-620"><a href="#FlightPlanSelector.wait_for_fp_selection_request-620"><span class="linenos">620</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_fp</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Entry point for the role. Getting a request to select a flight plan for a given flight from a list of
alternatives.</p>

<p>This only initialise the FP selected for the flight to nothing and calls the function to decide with FP to use</p>
</div>


                            </div>
                            <div id="FlightPlanSelector.decide_fp" class="classattr">
                                        <input id="FlightPlanSelector.decide_fp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">decide_fp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FlightPlanSelector.decide_fp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector.decide_fp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector.decide_fp-622"><a href="#FlightPlanSelector.decide_fp-622"><span class="linenos">622</span></a>	<span class="k">def</span> <span class="nf">decide_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="FlightPlanSelector.decide_fp-623"><a href="#FlightPlanSelector.decide_fp-623"><span class="linenos">623</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.decide_fp-624"><a href="#FlightPlanSelector.decide_fp-624"><span class="linenos">624</span></a><span class="sd">		It requests the select_fp function do to the selection, updates the option selected and provides the</span>
</span><span id="FlightPlanSelector.decide_fp-625"><a href="#FlightPlanSelector.decide_fp-625"><span class="linenos">625</span></a><span class="sd">		fp selected back.</span>
</span><span id="FlightPlanSelector.decide_fp-626"><a href="#FlightPlanSelector.decide_fp-626"><span class="linenos">626</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.decide_fp-627"><a href="#FlightPlanSelector.decide_fp-627"><span class="linenos">627</span></a>
</span><span id="FlightPlanSelector.decide_fp-628"><a href="#FlightPlanSelector.decide_fp-628"><span class="linenos">628</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector.decide_fp-629"><a href="#FlightPlanSelector.decide_fp-629"><span class="linenos">629</span></a>
</span><span id="FlightPlanSelector.decide_fp-630"><a href="#FlightPlanSelector.decide_fp-630"><span class="linenos">630</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="FlightPlanSelector.decide_fp-631"><a href="#FlightPlanSelector.decide_fp-631"><span class="linenos">631</span></a>		<span class="c1"># 	print(&#39;AOC will decide which FP to choose for flight {}&#39;.format(flight_uid))</span>
</span><span id="FlightPlanSelector.decide_fp-632"><a href="#FlightPlanSelector.decide_fp-632"><span class="linenos">632</span></a>
</span><span id="FlightPlanSelector.decide_fp-633"><a href="#FlightPlanSelector.decide_fp-633"><span class="linenos">633</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_fp</span><span class="p">(</span><span class="n">cost_options</span><span class="o">=</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_options&#39;</span><span class="p">],</span>
</span><span id="FlightPlanSelector.decide_fp-634"><a href="#FlightPlanSelector.decide_fp-634"><span class="linenos">634</span></a>														<span class="n">flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="FlightPlanSelector.decide_fp-635"><a href="#FlightPlanSelector.decide_fp-635"><span class="linenos">635</span></a>
</span><span id="FlightPlanSelector.decide_fp-636"><a href="#FlightPlanSelector.decide_fp-636"><span class="linenos">636</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="FlightPlanSelector.decide_fp-637"><a href="#FlightPlanSelector.decide_fp-637"><span class="linenos">637</span></a>
</span><span id="FlightPlanSelector.decide_fp-638"><a href="#FlightPlanSelector.decide_fp-638"><span class="linenos">638</span></a>		<span class="c1"># option_selected_fp = self.option_selected[flight_uid]</span>
</span><span id="FlightPlanSelector.decide_fp-639"><a href="#FlightPlanSelector.decide_fp-639"><span class="linenos">639</span></a>		<span class="c1"># self.send_option_selected(msg[&#39;to&#39;],option_selected_fp,msg[&#39;body&#39;][&#39;flight_uid&#39;])</span>
</span><span id="FlightPlanSelector.decide_fp-640"><a href="#FlightPlanSelector.decide_fp-640"><span class="linenos">640</span></a>
</span><span id="FlightPlanSelector.decide_fp-641"><a href="#FlightPlanSelector.decide_fp-641"><span class="linenos">641</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_option_selected</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">],</span> <span class="n">option</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>It requests the select_fp function do to the selection, updates the option selected and provides the
fp selected back.</p>
</div>


                            </div>
                            <div id="FlightPlanSelector.select_fp" class="classattr">
                                        <input id="FlightPlanSelector.select_fp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">select_fp</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cost_options</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FlightPlanSelector.select_fp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector.select_fp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector.select_fp-643"><a href="#FlightPlanSelector.select_fp-643"><span class="linenos">643</span></a>	<span class="k">def</span> <span class="nf">select_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="FlightPlanSelector.select_fp-644"><a href="#FlightPlanSelector.select_fp-644"><span class="linenos">644</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.select_fp-645"><a href="#FlightPlanSelector.select_fp-645"><span class="linenos">645</span></a><span class="sd">		This is yield rather than a return to take into account the case</span>
</span><span id="FlightPlanSelector.select_fp-646"><a href="#FlightPlanSelector.select_fp-646"><span class="linenos">646</span></a><span class="sd">		where the agent is asynchronuous, e.g. when there is a human operator</span>
</span><span id="FlightPlanSelector.select_fp-647"><a href="#FlightPlanSelector.select_fp-647"><span class="linenos">647</span></a><span class="sd">		(see HMI_FP_SEL module).</span>
</span><span id="FlightPlanSelector.select_fp-648"><a href="#FlightPlanSelector.select_fp-648"><span class="linenos">648</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.select_fp-649"><a href="#FlightPlanSelector.select_fp-649"><span class="linenos">649</span></a>
</span><span id="FlightPlanSelector.select_fp-650"><a href="#FlightPlanSelector.select_fp-650"><span class="linenos">650</span></a>		<span class="n">costs</span> <span class="o">=</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;delay_cost&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cost_options</span><span class="p">[</span><span class="s1">&#39;crco_cost&#39;</span><span class="p">]</span>
</span><span id="FlightPlanSelector.select_fp-651"><a href="#FlightPlanSelector.select_fp-651"><span class="linenos">651</span></a>
</span><span id="FlightPlanSelector.select_fp-652"><a href="#FlightPlanSelector.select_fp-652"><span class="linenos">652</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="FlightPlanSelector.select_fp-653"><a href="#FlightPlanSelector.select_fp-653"><span class="linenos">653</span></a>		<span class="c1"># 	print(&quot;SELECT FP {} (costs length: {})&quot;.format(flight_uid, len(costs)))</span>
</span><span id="FlightPlanSelector.select_fp-654"><a href="#FlightPlanSelector.select_fp-654"><span class="linenos">654</span></a>
</span><span id="FlightPlanSelector.select_fp-655"><a href="#FlightPlanSelector.select_fp-655"><span class="linenos">655</span></a>		<span class="n">costs_bis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">costs</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">smoothness_fp</span><span class="p">)</span>
</span><span id="FlightPlanSelector.select_fp-656"><a href="#FlightPlanSelector.select_fp-656"><span class="linenos">656</span></a>		<span class="k">if</span> <span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">:</span>
</span><span id="FlightPlanSelector.select_fp-657"><a href="#FlightPlanSelector.select_fp-657"><span class="linenos">657</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">costs_bis</span><span class="o">/</span><span class="n">costs_bis</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="FlightPlanSelector.select_fp-658"><a href="#FlightPlanSelector.select_fp-658"><span class="linenos">658</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="FlightPlanSelector.select_fp-659"><a href="#FlightPlanSelector.select_fp-659"><span class="linenos">659</span></a>			<span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">))</span>
</span><span id="FlightPlanSelector.select_fp-660"><a href="#FlightPlanSelector.select_fp-660"><span class="linenos">660</span></a>			<span class="n">prob</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">costs_bis</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">1.</span>
</span><span id="FlightPlanSelector.select_fp-661"><a href="#FlightPlanSelector.select_fp-661"><span class="linenos">661</span></a>
</span><span id="FlightPlanSelector.select_fp-662"><a href="#FlightPlanSelector.select_fp-662"><span class="linenos">662</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">costs</span><span class="p">))),</span> <span class="n">p</span><span class="o">=</span><span class="n">prob</span><span class="p">)</span>
</span><span id="FlightPlanSelector.select_fp-663"><a href="#FlightPlanSelector.select_fp-663"><span class="linenos">663</span></a>
</span><span id="FlightPlanSelector.select_fp-664"><a href="#FlightPlanSelector.select_fp-664"><span class="linenos">664</span></a>		<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This is yield rather than a return to take into account the case
where the agent is asynchronuous, e.g. when there is a human operator
(see HMI_FP_SEL module).</p>
</div>


                            </div>
                            <div id="FlightPlanSelector.send_option_selected" class="classattr">
                                        <input id="FlightPlanSelector.send_option_selected-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_option_selected</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">to</span>, </span><span class="param"><span class="n">option_selected_fp</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FlightPlanSelector.send_option_selected-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FlightPlanSelector.send_option_selected"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FlightPlanSelector.send_option_selected-666"><a href="#FlightPlanSelector.send_option_selected-666"><span class="linenos">666</span></a>	<span class="k">def</span> <span class="nf">send_option_selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="FlightPlanSelector.send_option_selected-667"><a href="#FlightPlanSelector.send_option_selected-667"><span class="linenos">667</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.send_option_selected-668"><a href="#FlightPlanSelector.send_option_selected-668"><span class="linenos">668</span></a><span class="sd">		Reply back with the fp that has been selected for the flight.</span>
</span><span id="FlightPlanSelector.send_option_selected-669"><a href="#FlightPlanSelector.send_option_selected-669"><span class="linenos">669</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="FlightPlanSelector.send_option_selected-670"><a href="#FlightPlanSelector.send_option_selected-670"><span class="linenos">670</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="FlightPlanSelector.send_option_selected-671"><a href="#FlightPlanSelector.send_option_selected-671"><span class="linenos">671</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to</span>
</span><span id="FlightPlanSelector.send_option_selected-672"><a href="#FlightPlanSelector.send_option_selected-672"><span class="linenos">672</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reply_option_selected&#39;</span>
</span><span id="FlightPlanSelector.send_option_selected-673"><a href="#FlightPlanSelector.send_option_selected-673"><span class="linenos">673</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">:</span> <span class="n">option_selected_fp</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="FlightPlanSelector.send_option_selected-674"><a href="#FlightPlanSelector.send_option_selected-674"><span class="linenos">674</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Reply back with the fp that has been selected for the flight.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="FlightPlanSelector.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="FlightPlanSelector.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AirlineFlightPlanner">
                            <input id="AirlineFlightPlanner-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AirlineFlightPlanner</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="AirlineFlightPlanner-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner-677"><a href="#AirlineFlightPlanner-677"><span class="linenos"> 677</span></a><span class="k">class</span> <span class="nc">AirlineFlightPlanner</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-678"><a href="#AirlineFlightPlanner-678"><span class="linenos"> 678</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-679"><a href="#AirlineFlightPlanner-679"><span class="linenos"> 679</span></a><span class="sd">	AFP: Airline Flight Planner</span>
</span><span id="AirlineFlightPlanner-680"><a href="#AirlineFlightPlanner-680"><span class="linenos"> 680</span></a>
</span><span id="AirlineFlightPlanner-681"><a href="#AirlineFlightPlanner-681"><span class="linenos"> 681</span></a><span class="sd">	Description:</span>
</span><span id="AirlineFlightPlanner-682"><a href="#AirlineFlightPlanner-682"><span class="linenos"> 682</span></a><span class="sd">	Select which flight plan will be executed. This means selecting the 4D trajectory (including delayed departing time (e.g., waiting for passengers)) and possibly cancelling flight (i.e., the Airline Flight Planner decides to cancel the flight plan).</span>
</span><span id="AirlineFlightPlanner-683"><a href="#AirlineFlightPlanner-683"><span class="linenos"> 683</span></a>
</span><span id="AirlineFlightPlanner-684"><a href="#AirlineFlightPlanner-684"><span class="linenos"> 684</span></a><span class="sd">	1. Check which flights are ready for pre-departure (less than 3 hours before their EOBT and in scheduled status) or get a request to recompute the flight plan selection of a given flight.</span>
</span><span id="AirlineFlightPlanner-685"><a href="#AirlineFlightPlanner-685"><span class="linenos"> 685</span></a><span class="sd">	2. Submit flight plan which might lead to ATFM delay update.</span>
</span><span id="AirlineFlightPlanner-686"><a href="#AirlineFlightPlanner-686"><span class="linenos"> 686</span></a><span class="sd">	3. Check different flight plan options and their costs.</span>
</span><span id="AirlineFlightPlanner-687"><a href="#AirlineFlightPlanner-687"><span class="linenos"> 687</span></a><span class="sd">	4. Decide which flight plan to execute tactically.</span>
</span><span id="AirlineFlightPlanner-688"><a href="#AirlineFlightPlanner-688"><span class="linenos"> 688</span></a>
</span><span id="AirlineFlightPlanner-689"><a href="#AirlineFlightPlanner-689"><span class="linenos"> 689</span></a><span class="sd">	The liveness of AFP will depend on the mechanism 4DT and the FP implementation.</span>
</span><span id="AirlineFlightPlanner-690"><a href="#AirlineFlightPlanner-690"><span class="linenos"> 690</span></a>
</span><span id="AirlineFlightPlanner-691"><a href="#AirlineFlightPlanner-691"><span class="linenos"> 691</span></a><span class="sd">	The action of RequestATFMSlot will depend on the FP mechanism:</span>
</span><span id="AirlineFlightPlanner-692"><a href="#AirlineFlightPlanner-692"><span class="linenos"> 692</span></a>
</span><span id="AirlineFlightPlanner-693"><a href="#AirlineFlightPlanner-693"><span class="linenos"> 693</span></a><span class="sd">		- FP_0: Request ATFM slot</span>
</span><span id="AirlineFlightPlanner-694"><a href="#AirlineFlightPlanner-694"><span class="linenos"> 694</span></a><span class="sd">		- FP_1 and FP_2: Request ATFM slot and then prioritise the flight and optionally request a flight swap.</span>
</span><span id="AirlineFlightPlanner-695"><a href="#AirlineFlightPlanner-695"><span class="linenos"> 695</span></a>
</span><span id="AirlineFlightPlanner-696"><a href="#AirlineFlightPlanner-696"><span class="linenos"> 696</span></a><span class="sd">	The action of DecideOption depends on 4DT:</span>
</span><span id="AirlineFlightPlanner-697"><a href="#AirlineFlightPlanner-697"><span class="linenos"> 697</span></a>
</span><span id="AirlineFlightPlanner-698"><a href="#AirlineFlightPlanner-698"><span class="linenos"> 698</span></a><span class="sd">		- 4DT_0: Rule of thumb to decide between speed-up, wait-for-passengers and cancellation</span>
</span><span id="AirlineFlightPlanner-699"><a href="#AirlineFlightPlanner-699"><span class="linenos"> 699</span></a><span class="sd">		- 4DT_1 and 4DT_2: Selection of option based on cost provided by CheckFPOption</span>
</span><span id="AirlineFlightPlanner-700"><a href="#AirlineFlightPlanner-700"><span class="linenos"> 700</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-701"><a href="#AirlineFlightPlanner-701"><span class="linenos"> 701</span></a>
</span><span id="AirlineFlightPlanner-702"><a href="#AirlineFlightPlanner-702"><span class="linenos"> 702</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-703"><a href="#AirlineFlightPlanner-703"><span class="linenos"> 703</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-704"><a href="#AirlineFlightPlanner-704"><span class="linenos"> 704</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options_from_fp_pool</span>
</span><span id="AirlineFlightPlanner-705"><a href="#AirlineFlightPlanner-705"><span class="linenos"> 705</span></a>
</span><span id="AirlineFlightPlanner-706"><a href="#AirlineFlightPlanner-706"><span class="linenos"> 706</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="AirlineFlightPlanner-707"><a href="#AirlineFlightPlanner-707"><span class="linenos"> 707</span></a>		<span class="c1"># self.build_delay_cost_functions = self.build_delay_cost_functions_advanced</span>
</span><span id="AirlineFlightPlanner-708"><a href="#AirlineFlightPlanner-708"><span class="linenos"> 708</span></a>
</span><span id="AirlineFlightPlanner-709"><a href="#AirlineFlightPlanner-709"><span class="linenos"> 709</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner-710"><a href="#AirlineFlightPlanner-710"><span class="linenos"> 710</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner-711"><a href="#AirlineFlightPlanner-711"><span class="linenos"> 711</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner-712"><a href="#AirlineFlightPlanner-712"><span class="linenos"> 712</span></a>
</span><span id="AirlineFlightPlanner-713"><a href="#AirlineFlightPlanner-713"><span class="linenos"> 713</span></a>	<span class="k">def</span> <span class="nf">cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-714"><a href="#AirlineFlightPlanner-714"><span class="linenos"> 714</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="s1">&#39;due to&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-715"><a href="#AirlineFlightPlanner-715"><span class="linenos"> 715</span></a>
</span><span id="AirlineFlightPlanner-716"><a href="#AirlineFlightPlanner-716"><span class="linenos"> 716</span></a>		<span class="c1"># Mark the flight as cancelled. This needs to be before reallocating</span>
</span><span id="AirlineFlightPlanner-717"><a href="#AirlineFlightPlanner-717"><span class="linenos"> 717</span></a>		<span class="c1"># passengers, so they are not rellocated on an itinerary including this flight.</span>
</span><span id="AirlineFlightPlanner-718"><a href="#AirlineFlightPlanner-718"><span class="linenos"> 718</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="AirlineFlightPlanner-719"><a href="#AirlineFlightPlanner-719"><span class="linenos"> 719</span></a>
</span><span id="AirlineFlightPlanner-720"><a href="#AirlineFlightPlanner-720"><span class="linenos"> 720</span></a>		<span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-721"><a href="#AirlineFlightPlanner-721"><span class="linenos"> 721</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="AirlineFlightPlanner-722"><a href="#AirlineFlightPlanner-722"><span class="linenos"> 722</span></a>			<span class="c1"># print(&quot;WTC cancel: &quot;,self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].wtc)</span>
</span><span id="AirlineFlightPlanner-723"><a href="#AirlineFlightPlanner-723"><span class="linenos"> 723</span></a>
</span><span id="AirlineFlightPlanner-724"><a href="#AirlineFlightPlanner-724"><span class="linenos"> 724</span></a>			<span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;CANCEL_CF&quot;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-725"><a href="#AirlineFlightPlanner-725"><span class="linenos"> 725</span></a>				<span class="c1"># We cancelled due to curfew add extra non-pax costs of Laurent</span>
</span><span id="AirlineFlightPlanner-726"><a href="#AirlineFlightPlanner-726"><span class="linenos"> 726</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-727"><a href="#AirlineFlightPlanner-727"><span class="linenos"> 727</span></a>
</span><span id="AirlineFlightPlanner-728"><a href="#AirlineFlightPlanner-728"><span class="linenos"> 728</span></a>		<span class="c1"># Pax will blame ANY compensation, soft cost, or transfer cost on the cancelled flight</span>
</span><span id="AirlineFlightPlanner-729"><a href="#AirlineFlightPlanner-729"><span class="linenos"> 729</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-730"><a href="#AirlineFlightPlanner-730"><span class="linenos"> 730</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames soft cost on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-731"><a href="#AirlineFlightPlanner-731"><span class="linenos"> 731</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-732"><a href="#AirlineFlightPlanner-732"><span class="linenos"> 732</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames compensation on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-733"><a href="#AirlineFlightPlanner-733"><span class="linenos"> 733</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-734"><a href="#AirlineFlightPlanner-734"><span class="linenos"> 734</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-735"><a href="#AirlineFlightPlanner-735"><span class="linenos"> 735</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-736"><a href="#AirlineFlightPlanner-736"><span class="linenos"> 736</span></a>
</span><span id="AirlineFlightPlanner-737"><a href="#AirlineFlightPlanner-737"><span class="linenos"> 737</span></a>		<span class="c1"># Reallocate passenger which are already in transit</span>
</span><span id="AirlineFlightPlanner-738"><a href="#AirlineFlightPlanner-738"><span class="linenos"> 738</span></a>		<span class="n">pax_to_reallocate</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-739"><a href="#AirlineFlightPlanner-739"><span class="linenos"> 739</span></a>								<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-740"><a href="#AirlineFlightPlanner-740"><span class="linenos"> 740</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;, because&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner-741"><a href="#AirlineFlightPlanner-741"><span class="linenos"> 741</span></a>				<span class="s1">&#39;has been cancelled, the following paxs need to be reallocated:&#39;</span><span class="p">,</span> <span class="n">pax_to_reallocate</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-742"><a href="#AirlineFlightPlanner-742"><span class="linenos"> 742</span></a>				<span class="s1">&#39;(the rest will be reallocated when they reach the airport of departure of the cancelled flight)&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-743"><a href="#AirlineFlightPlanner-743"><span class="linenos"> 743</span></a>
</span><span id="AirlineFlightPlanner-744"><a href="#AirlineFlightPlanner-744"><span class="linenos"> 744</span></a>		<span class="c1"># # All victims of cancellations can be compensated.</span>
</span><span id="AirlineFlightPlanner-745"><a href="#AirlineFlightPlanner-745"><span class="linenos"> 745</span></a>		<span class="c1"># for pax in self.agent.aoc_flights_info[flight_uid][&#39;pax_to_board&#39;]:</span>
</span><span id="AirlineFlightPlanner-746"><a href="#AirlineFlightPlanner-746"><span class="linenos"> 746</span></a>		<span class="c1"># 	pax.force_entitled = True</span>
</span><span id="AirlineFlightPlanner-747"><a href="#AirlineFlightPlanner-747"><span class="linenos"> 747</span></a>
</span><span id="AirlineFlightPlanner-748"><a href="#AirlineFlightPlanner-748"><span class="linenos"> 748</span></a>		<span class="c1"># Check liability for compensation</span>
</span><span id="AirlineFlightPlanner-749"><a href="#AirlineFlightPlanner-749"><span class="linenos"> 749</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-750"><a href="#AirlineFlightPlanner-750"><span class="linenos"> 750</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-751"><a href="#AirlineFlightPlanner-751"><span class="linenos"> 751</span></a>
</span><span id="AirlineFlightPlanner-752"><a href="#AirlineFlightPlanner-752"><span class="linenos"> 752</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_reallocation_pax_request</span><span class="p">(</span><span class="n">pax_to_reallocate</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-753"><a href="#AirlineFlightPlanner-753"><span class="linenos"> 753</span></a>
</span><span id="AirlineFlightPlanner-754"><a href="#AirlineFlightPlanner-754"><span class="linenos"> 754</span></a>		<span class="c1"># Disseminate the cancellation of the flight plan, if any</span>
</span><span id="AirlineFlightPlanner-755"><a href="#AirlineFlightPlanner-755"><span class="linenos"> 755</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_cancellation_flight_message</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-756"><a href="#AirlineFlightPlanner-756"><span class="linenos"> 756</span></a>
</span><span id="AirlineFlightPlanner-757"><a href="#AirlineFlightPlanner-757"><span class="linenos"> 757</span></a>		<span class="c1"># Cancel all events linked to flight</span>
</span><span id="AirlineFlightPlanner-758"><a href="#AirlineFlightPlanner-758"><span class="linenos"> 758</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling all events of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-759"><a href="#AirlineFlightPlanner-759"><span class="linenos"> 759</span></a>		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-760"><a href="#AirlineFlightPlanner-760"><span class="linenos"> 760</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_event&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_proc&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-761"><a href="#AirlineFlightPlanner-761"><span class="linenos"> 761</span></a>				<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-762"><a href="#AirlineFlightPlanner-762"><span class="linenos"> 762</span></a>					<span class="n">value</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-763"><a href="#AirlineFlightPlanner-763"><span class="linenos"> 763</span></a>				<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-764"><a href="#AirlineFlightPlanner-764"><span class="linenos"> 764</span></a>					<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-765"><a href="#AirlineFlightPlanner-765"><span class="linenos"> 765</span></a>
</span><span id="AirlineFlightPlanner-766"><a href="#AirlineFlightPlanner-766"><span class="linenos"> 766</span></a>		<span class="c1"># Prepare next flight (using turnaround operator)</span>
</span><span id="AirlineFlightPlanner-767"><a href="#AirlineFlightPlanner-767"><span class="linenos"> 767</span></a>		<span class="c1"># self.agent.tro.process_following_flight(flight_uid)</span>
</span><span id="AirlineFlightPlanner-768"><a href="#AirlineFlightPlanner-768"><span class="linenos"> 768</span></a>
</span><span id="AirlineFlightPlanner-769"><a href="#AirlineFlightPlanner-769"><span class="linenos"> 769</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-770"><a href="#AirlineFlightPlanner-770"><span class="linenos"> 770</span></a>			<span class="n">next_flights_uids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-771"><a href="#AirlineFlightPlanner-771"><span class="linenos"> 771</span></a>			<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-772"><a href="#AirlineFlightPlanner-772"><span class="linenos"> 772</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights_uids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-773"><a href="#AirlineFlightPlanner-773"><span class="linenos"> 773</span></a>				<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">next_flights_uids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-774"><a href="#AirlineFlightPlanner-774"><span class="linenos"> 774</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-775"><a href="#AirlineFlightPlanner-775"><span class="linenos"> 775</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-776"><a href="#AirlineFlightPlanner-776"><span class="linenos"> 776</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-777"><a href="#AirlineFlightPlanner-777"><span class="linenos"> 777</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-778"><a href="#AirlineFlightPlanner-778"><span class="linenos"> 778</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-779"><a href="#AirlineFlightPlanner-779"><span class="linenos"> 779</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-780"><a href="#AirlineFlightPlanner-780"><span class="linenos"> 780</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-781"><a href="#AirlineFlightPlanner-781"><span class="linenos"> 781</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-782"><a href="#AirlineFlightPlanner-782"><span class="linenos"> 782</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-783"><a href="#AirlineFlightPlanner-783"><span class="linenos"> 783</span></a>
</span><span id="AirlineFlightPlanner-784"><a href="#AirlineFlightPlanner-784"><span class="linenos"> 784</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-785"><a href="#AirlineFlightPlanner-785"><span class="linenos"> 785</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-786"><a href="#AirlineFlightPlanner-786"><span class="linenos"> 786</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-787"><a href="#AirlineFlightPlanner-787"><span class="linenos"> 787</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-788"><a href="#AirlineFlightPlanner-788"><span class="linenos"> 788</span></a>			<span class="nb">print</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-789"><a href="#AirlineFlightPlanner-789"><span class="linenos"> 789</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-790"><a href="#AirlineFlightPlanner-790"><span class="linenos"> 790</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cancel_cascade_curfew</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-791"><a href="#AirlineFlightPlanner-791"><span class="linenos"> 791</span></a>			<span class="c1"># Cancel in cascade after curfew</span>
</span><span id="AirlineFlightPlanner-792"><a href="#AirlineFlightPlanner-792"><span class="linenos"> 792</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Because flight&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;has been cancelled due to curfew, AOC sends a cancelling signal to flight&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-793"><a href="#AirlineFlightPlanner-793"><span class="linenos"> 793</span></a>				   <span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;cascade cancelation&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-794"><a href="#AirlineFlightPlanner-794"><span class="linenos"> 794</span></a>			<span class="c1">#     aprint(flight_str(flight_uid), &#39;has&#39;, aircraft, \</span>
</span><span id="AirlineFlightPlanner-795"><a href="#AirlineFlightPlanner-795"><span class="linenos"> 795</span></a>			<span class="c1">#             &#39;status of current request (triggered, processed, defused):&#39;, request.triggered,\</span>
</span><span id="AirlineFlightPlanner-796"><a href="#AirlineFlightPlanner-796"><span class="linenos"> 796</span></a>			<span class="c1">#             request.processed,\</span>
</span><span id="AirlineFlightPlanner-797"><a href="#AirlineFlightPlanner-797"><span class="linenos"> 797</span></a>			<span class="c1">#             request.defused)</span>
</span><span id="AirlineFlightPlanner-798"><a href="#AirlineFlightPlanner-798"><span class="linenos"> 798</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_cancel_flight</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-799"><a href="#AirlineFlightPlanner-799"><span class="linenos"> 799</span></a>
</span><span id="AirlineFlightPlanner-800"><a href="#AirlineFlightPlanner-800"><span class="linenos"> 800</span></a>	<span class="k">def</span> <span class="nf">send_cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-801"><a href="#AirlineFlightPlanner-801"><span class="linenos"> 801</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-802"><a href="#AirlineFlightPlanner-802"><span class="linenos"> 802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-803"><a href="#AirlineFlightPlanner-803"><span class="linenos"> 803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancel_flight_request&#39;</span>
</span><span id="AirlineFlightPlanner-804"><a href="#AirlineFlightPlanner-804"><span class="linenos"> 804</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-805"><a href="#AirlineFlightPlanner-805"><span class="linenos"> 805</span></a>						<span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-806"><a href="#AirlineFlightPlanner-806"><span class="linenos"> 806</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-807"><a href="#AirlineFlightPlanner-807"><span class="linenos"> 807</span></a>
</span><span id="AirlineFlightPlanner-808"><a href="#AirlineFlightPlanner-808"><span class="linenos"> 808</span></a>	<span class="k">def</span> <span class="nf">wait_for_cancel_flight_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-809"><a href="#AirlineFlightPlanner-809"><span class="linenos"> 809</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-810"><a href="#AirlineFlightPlanner-810"><span class="linenos"> 810</span></a>
</span><span id="AirlineFlightPlanner-811"><a href="#AirlineFlightPlanner-811"><span class="linenos"> 811</span></a>	<span class="k">def</span> <span class="nf">check_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP_submission_event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-812"><a href="#AirlineFlightPlanner-812"><span class="linenos"> 812</span></a>		<span class="k">yield</span> <span class="n">FP_submission_event</span>
</span><span id="AirlineFlightPlanner-813"><a href="#AirlineFlightPlanner-813"><span class="linenos"> 813</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-814"><a href="#AirlineFlightPlanner-814"><span class="linenos"> 814</span></a>		<span class="c1"># 	print(&quot;{} does the first FP submission for flight {}&quot;.format(self.agent, flight_uid))</span>
</span><span id="AirlineFlightPlanner-815"><a href="#AirlineFlightPlanner-815"><span class="linenos"> 815</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_FP_submission&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-816"><a href="#AirlineFlightPlanner-816"><span class="linenos"> 816</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-817"><a href="#AirlineFlightPlanner-817"><span class="linenos"> 817</span></a>													<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner-818"><a href="#AirlineFlightPlanner-818"><span class="linenos"> 818</span></a>
</span><span id="AirlineFlightPlanner-819"><a href="#AirlineFlightPlanner-819"><span class="linenos"> 819</span></a>	<span class="k">def</span> <span class="nf">compute_FP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fp_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-820"><a href="#AirlineFlightPlanner-820"><span class="linenos"> 820</span></a>		<span class="c1"># aoc_flight_info = self.agent.aoc_flights_info[flight_uid]</span>
</span><span id="AirlineFlightPlanner-821"><a href="#AirlineFlightPlanner-821"><span class="linenos"> 821</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes the flight plan options for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-822"><a href="#AirlineFlightPlanner-822"><span class="linenos"> 822</span></a>
</span><span id="AirlineFlightPlanner-823"><a href="#AirlineFlightPlanner-823"><span class="linenos"> 823</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-824"><a href="#AirlineFlightPlanner-824"><span class="linenos"> 824</span></a>		<span class="c1"># 	print(&#39;\nAOC tries to find a FP for flight {} with sobt {} (t={})&#39;.format(flight_uid,</span>
</span><span id="AirlineFlightPlanner-825"><a href="#AirlineFlightPlanner-825"><span class="linenos"> 825</span></a>		<span class="c1"># 																				self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;],</span>
</span><span id="AirlineFlightPlanner-826"><a href="#AirlineFlightPlanner-826"><span class="linenos"> 826</span></a>		<span class="c1"># 																				self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner-827"><a href="#AirlineFlightPlanner-827"><span class="linenos"> 827</span></a>		<span class="c1"># just_computed = False</span>
</span><span id="AirlineFlightPlanner-828"><a href="#AirlineFlightPlanner-828"><span class="linenos"> 828</span></a>		<span class="c1"># if self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;] is None:</span>
</span><span id="AirlineFlightPlanner-829"><a href="#AirlineFlightPlanner-829"><span class="linenos"> 829</span></a>		<span class="c1">#  This flight does not have a flight plan yet, so it</span>
</span><span id="AirlineFlightPlanner-830"><a href="#AirlineFlightPlanner-830"><span class="linenos"> 830</span></a>		<span class="c1">#  needs to find one.</span>
</span><span id="AirlineFlightPlanner-831"><a href="#AirlineFlightPlanner-831"><span class="linenos"> 831</span></a>
</span><span id="AirlineFlightPlanner-832"><a href="#AirlineFlightPlanner-832"><span class="linenos"> 832</span></a>		<span class="c1"># Compute all possible flight plan options</span>
</span><span id="AirlineFlightPlanner-833"><a href="#AirlineFlightPlanner-833"><span class="linenos"> 833</span></a>		<span class="k">if</span> <span class="n">fp_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-834"><a href="#AirlineFlightPlanner-834"><span class="linenos"> 834</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-835"><a href="#AirlineFlightPlanner-835"><span class="linenos"> 835</span></a>			<span class="c1"># 	print(&#39;AOC RECOMPUTES FPs FOR FLIGHT {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="AirlineFlightPlanner-836"><a href="#AirlineFlightPlanner-836"><span class="linenos"> 836</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-837"><a href="#AirlineFlightPlanner-837"><span class="linenos"> 837</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-838"><a href="#AirlineFlightPlanner-838"><span class="linenos"> 838</span></a>													<span class="n">eobt</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-839"><a href="#AirlineFlightPlanner-839"><span class="linenos"> 839</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-840"><a href="#AirlineFlightPlanner-840"><span class="linenos"> 840</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-841"><a href="#AirlineFlightPlanner-841"><span class="linenos"> 841</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-842"><a href="#AirlineFlightPlanner-842"><span class="linenos"> 842</span></a>
</span><span id="AirlineFlightPlanner-843"><a href="#AirlineFlightPlanner-843"><span class="linenos"> 843</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-844"><a href="#AirlineFlightPlanner-844"><span class="linenos"> 844</span></a>		<span class="c1"># 	print(&#39;ELT FOR EACH FP OPTION FOR FLIGHT {}:&#39;.format(flight_uid), [fp.get_eta_wo_atfm() for fp in fp_options])</span>
</span><span id="AirlineFlightPlanner-845"><a href="#AirlineFlightPlanner-845"><span class="linenos"> 845</span></a><span class="w">		</span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="AirlineFlightPlanner-846"><a href="#AirlineFlightPlanner-846"><span class="linenos"> 846</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="AirlineFlightPlanner-847"><a href="#AirlineFlightPlanner-847"><span class="linenos"> 847</span></a><span class="sd">		print(&#39;FP options:&#39;)</span>
</span><span id="AirlineFlightPlanner-848"><a href="#AirlineFlightPlanner-848"><span class="linenos"> 848</span></a><span class="sd">		for option in fp_options:</span>
</span><span id="AirlineFlightPlanner-849"><a href="#AirlineFlightPlanner-849"><span class="linenos"> 849</span></a><span class="sd">			print(option)</span>
</span><span id="AirlineFlightPlanner-850"><a href="#AirlineFlightPlanner-850"><span class="linenos"> 850</span></a><span class="sd">			print(&#39;with eobt:&#39;, option.eobt)</span>
</span><span id="AirlineFlightPlanner-851"><a href="#AirlineFlightPlanner-851"><span class="linenos"> 851</span></a><span class="sd">			print(&#39;with eibt:&#39;, option.eibt)</span>
</span><span id="AirlineFlightPlanner-852"><a href="#AirlineFlightPlanner-852"><span class="linenos"> 852</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="AirlineFlightPlanner-853"><a href="#AirlineFlightPlanner-853"><span class="linenos"> 853</span></a><span class="sd">		&#39;&#39;&#39;</span>
</span><span id="AirlineFlightPlanner-854"><a href="#AirlineFlightPlanner-854"><span class="linenos"> 854</span></a>
</span><span id="AirlineFlightPlanner-855"><a href="#AirlineFlightPlanner-855"><span class="linenos"> 855</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner-856"><a href="#AirlineFlightPlanner-856"><span class="linenos"> 856</span></a>
</span><span id="AirlineFlightPlanner-857"><a href="#AirlineFlightPlanner-857"><span class="linenos"> 857</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner-858"><a href="#AirlineFlightPlanner-858"><span class="linenos"> 858</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner-859"><a href="#AirlineFlightPlanner-859"><span class="linenos"> 859</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-860"><a href="#AirlineFlightPlanner-860"><span class="linenos"> 860</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-861"><a href="#AirlineFlightPlanner-861"><span class="linenos"> 861</span></a>
</span><span id="AirlineFlightPlanner-862"><a href="#AirlineFlightPlanner-862"><span class="linenos"> 862</span></a>		<span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-863"><a href="#AirlineFlightPlanner-863"><span class="linenos"> 863</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-864"><a href="#AirlineFlightPlanner-864"><span class="linenos"> 864</span></a>			<span class="c1"># 	print(&#39;OPTION NOT FOUND FOR FLIGHT {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner-865"><a href="#AirlineFlightPlanner-865"><span class="linenos"> 865</span></a>
</span><span id="AirlineFlightPlanner-866"><a href="#AirlineFlightPlanner-866"><span class="linenos"> 866</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner-867"><a href="#AirlineFlightPlanner-867"><span class="linenos"> 867</span></a>
</span><span id="AirlineFlightPlanner-868"><a href="#AirlineFlightPlanner-868"><span class="linenos"> 868</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_options_alternatives</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-869"><a href="#AirlineFlightPlanner-869"><span class="linenos"> 869</span></a>																			<span class="n">fp_options</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-870"><a href="#AirlineFlightPlanner-870"><span class="linenos"> 870</span></a>																			<span class="n">current_option</span><span class="o">=</span><span class="n">option</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-871"><a href="#AirlineFlightPlanner-871"><span class="linenos"> 871</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-872"><a href="#AirlineFlightPlanner-872"><span class="linenos"> 872</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-873"><a href="#AirlineFlightPlanner-873"><span class="linenos"> 873</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-874"><a href="#AirlineFlightPlanner-874"><span class="linenos"> 874</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-875"><a href="#AirlineFlightPlanner-875"><span class="linenos"> 875</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-876"><a href="#AirlineFlightPlanner-876"><span class="linenos"> 876</span></a>
</span><span id="AirlineFlightPlanner-877"><a href="#AirlineFlightPlanner-877"><span class="linenos"> 877</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-878"><a href="#AirlineFlightPlanner-878"><span class="linenos"> 878</span></a>			<span class="c1"># 	print(&#39;AOC considers FP option {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner-879"><a href="#AirlineFlightPlanner-879"><span class="linenos"> 879</span></a>
</span><span id="AirlineFlightPlanner-880"><a href="#AirlineFlightPlanner-880"><span class="linenos"> 880</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner-881"><a href="#AirlineFlightPlanner-881"><span class="linenos"> 881</span></a>
</span><span id="AirlineFlightPlanner-882"><a href="#AirlineFlightPlanner-882"><span class="linenos"> 882</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-883"><a href="#AirlineFlightPlanner-883"><span class="linenos"> 883</span></a>				<span class="c1"># print(&#39;BORNE2 {} (found: {}, fp_options length: {})&#39;.format(flight_uid, found, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner-884"><a href="#AirlineFlightPlanner-884"><span class="linenos"> 884</span></a>
</span><span id="AirlineFlightPlanner-885"><a href="#AirlineFlightPlanner-885"><span class="linenos"> 885</span></a>			<span class="c1"># An option is selected, but might not be accepted yet because</span>
</span><span id="AirlineFlightPlanner-886"><a href="#AirlineFlightPlanner-886"><span class="linenos"> 886</span></a>			<span class="c1"># in general it needs to have an ATFM slot. The following does exactly this.</span>
</span><span id="AirlineFlightPlanner-887"><a href="#AirlineFlightPlanner-887"><span class="linenos"> 887</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-888"><a href="#AirlineFlightPlanner-888"><span class="linenos"> 888</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-889"><a href="#AirlineFlightPlanner-889"><span class="linenos"> 889</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp_options[option].get_unique_id()] = received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner-890"><a href="#AirlineFlightPlanner-890"><span class="linenos"> 890</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-891"><a href="#AirlineFlightPlanner-891"><span class="linenos"> 891</span></a>				<span class="c1"># 	print(&#39;AOC sends ATFM request for flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner-892"><a href="#AirlineFlightPlanner-892"><span class="linenos"> 892</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-893"><a href="#AirlineFlightPlanner-893"><span class="linenos"> 893</span></a>				<span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;submitted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-894"><a href="#AirlineFlightPlanner-894"><span class="linenos"> 894</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner-895"><a href="#AirlineFlightPlanner-895"><span class="linenos"> 895</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-896"><a href="#AirlineFlightPlanner-896"><span class="linenos"> 896</span></a>				<span class="c1"># 	print(&#39;BORNE4 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner-897"><a href="#AirlineFlightPlanner-897"><span class="linenos"> 897</span></a>
</span><span id="AirlineFlightPlanner-898"><a href="#AirlineFlightPlanner-898"><span class="linenos"> 898</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;has made a decision. Cancellation:&quot;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span> <span class="s1">&#39;; option chosen:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="s2">&quot;among&quot;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-899"><a href="#AirlineFlightPlanner-899"><span class="linenos"> 899</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-900"><a href="#AirlineFlightPlanner-900"><span class="linenos"> 900</span></a>		<span class="c1"># 	print(&quot;AOC has reached a decision. Cancellation:&quot;,</span>
</span><span id="AirlineFlightPlanner-901"><a href="#AirlineFlightPlanner-901"><span class="linenos"> 901</span></a>		<span class="c1"># 				cancellation,</span>
</span><span id="AirlineFlightPlanner-902"><a href="#AirlineFlightPlanner-902"><span class="linenos"> 902</span></a>		<span class="c1"># 				&#39;; option chosen:&#39;,</span>
</span><span id="AirlineFlightPlanner-903"><a href="#AirlineFlightPlanner-903"><span class="linenos"> 903</span></a>		<span class="c1"># 				option,</span>
</span><span id="AirlineFlightPlanner-904"><a href="#AirlineFlightPlanner-904"><span class="linenos"> 904</span></a>		<span class="c1"># 				&quot;among&quot;,</span>
</span><span id="AirlineFlightPlanner-905"><a href="#AirlineFlightPlanner-905"><span class="linenos"> 905</span></a>		<span class="c1"># 				fp_options,</span>
</span><span id="AirlineFlightPlanner-906"><a href="#AirlineFlightPlanner-906"><span class="linenos"> 906</span></a>		<span class="c1"># 				&#39; ; ETA without ATFM delay:&#39;,</span>
</span><span id="AirlineFlightPlanner-907"><a href="#AirlineFlightPlanner-907"><span class="linenos"> 907</span></a>		<span class="c1"># 				fp_options[option].get_eta_wo_atfm())</span>
</span><span id="AirlineFlightPlanner-908"><a href="#AirlineFlightPlanner-908"><span class="linenos"> 908</span></a>		<span class="c1"># 	# print(&#39;OPTION CHOSEN FOR FLIGHT (ETA without ATFM delay):&#39;, option, fp_options[option].get_eta_wo_atfm())</span>
</span><span id="AirlineFlightPlanner-909"><a href="#AirlineFlightPlanner-909"><span class="linenos"> 909</span></a>
</span><span id="AirlineFlightPlanner-910"><a href="#AirlineFlightPlanner-910"><span class="linenos"> 910</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="AirlineFlightPlanner-911"><a href="#AirlineFlightPlanner-911"><span class="linenos"> 911</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner-912"><a href="#AirlineFlightPlanner-912"><span class="linenos"> 912</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-913"><a href="#AirlineFlightPlanner-913"><span class="linenos"> 913</span></a>
</span><span id="AirlineFlightPlanner-914"><a href="#AirlineFlightPlanner-914"><span class="linenos"> 914</span></a>		<span class="k">if</span> <span class="n">cancellation</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-915"><a href="#AirlineFlightPlanner-915"><span class="linenos"> 915</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-916"><a href="#AirlineFlightPlanner-916"><span class="linenos"> 916</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-917"><a href="#AirlineFlightPlanner-917"><span class="linenos"> 917</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-918"><a href="#AirlineFlightPlanner-918"><span class="linenos"> 918</span></a>			<span class="c1"># If accepted, mark it as the FP adopted and send an FP submission.</span>
</span><span id="AirlineFlightPlanner-919"><a href="#AirlineFlightPlanner-919"><span class="linenos"> 919</span></a>			<span class="n">reception_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-920"><a href="#AirlineFlightPlanner-920"><span class="linenos"> 920</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-921"><a href="#AirlineFlightPlanner-921"><span class="linenos"> 921</span></a>			<span class="c1"># 	print(&#39;AOC submits flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner-922"><a href="#AirlineFlightPlanner-922"><span class="linenos"> 922</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">reception_event</span><span class="o">=</span><span class="n">reception_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-923"><a href="#AirlineFlightPlanner-923"><span class="linenos"> 923</span></a>			<span class="k">yield</span> <span class="n">reception_event</span>
</span><span id="AirlineFlightPlanner-924"><a href="#AirlineFlightPlanner-924"><span class="linenos"> 924</span></a>
</span><span id="AirlineFlightPlanner-925"><a href="#AirlineFlightPlanner-925"><span class="linenos"> 925</span></a>			<span class="c1"># Then consider potential flight swapping.</span>
</span><span id="AirlineFlightPlanner-926"><a href="#AirlineFlightPlanner-926"><span class="linenos"> 926</span></a>			<span class="c1"># BEWARE: the flight plan needs to be already accepted and returned before</span>
</span><span id="AirlineFlightPlanner-927"><a href="#AirlineFlightPlanner-927"><span class="linenos"> 927</span></a>			<span class="c1"># the airline considers the flight swapping.</span>
</span><span id="AirlineFlightPlanner-928"><a href="#AirlineFlightPlanner-928"><span class="linenos"> 928</span></a>			<span class="c1"># self.consider_flight_swap(flight_uid, fp_options[option])</span>
</span><span id="AirlineFlightPlanner-929"><a href="#AirlineFlightPlanner-929"><span class="linenos"> 929</span></a>
</span><span id="AirlineFlightPlanner-930"><a href="#AirlineFlightPlanner-930"><span class="linenos"> 930</span></a>		<span class="c1"># just_computed = True</span>
</span><span id="AirlineFlightPlanner-931"><a href="#AirlineFlightPlanner-931"><span class="linenos"> 931</span></a>
</span><span id="AirlineFlightPlanner-932"><a href="#AirlineFlightPlanner-932"><span class="linenos"> 932</span></a>		<span class="c1"># if (not cancellation) and (ac_ready_at_time is None) and (self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;] is not None):</span>
</span><span id="AirlineFlightPlanner-933"><a href="#AirlineFlightPlanner-933"><span class="linenos"> 933</span></a>		<span class="c1"># 	# We got the ac_ready time before the first flight plan submitted. Update ac_ready_time</span>
</span><span id="AirlineFlightPlanner-934"><a href="#AirlineFlightPlanner-934"><span class="linenos"> 934</span></a>		<span class="c1"># 	self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].reactionary_delay = self.agent.aoc_flights_info[flight_uid][&#39;reactionary_delay_prior_FP&#39;]</span>
</span><span id="AirlineFlightPlanner-935"><a href="#AirlineFlightPlanner-935"><span class="linenos"> 935</span></a>		<span class="c1"># 	ac_ready_at_time = self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;]</span>
</span><span id="AirlineFlightPlanner-936"><a href="#AirlineFlightPlanner-936"><span class="linenos"> 936</span></a>
</span><span id="AirlineFlightPlanner-937"><a href="#AirlineFlightPlanner-937"><span class="linenos"> 937</span></a>		<span class="c1"># #if (not cancellation) and (not ac_ready_at_time is None) and (not just_computed):</span>
</span><span id="AirlineFlightPlanner-938"><a href="#AirlineFlightPlanner-938"><span class="linenos"> 938</span></a>		<span class="c1"># 	#mprint(flight_str(flight_uid), &#39;has an ac_ready_time of&#39;, ac_ready_at_time)</span>
</span><span id="AirlineFlightPlanner-939"><a href="#AirlineFlightPlanner-939"><span class="linenos"> 939</span></a>		<span class="c1"># 	# This flight has a flight plan and it is a recomputation that might be needed</span>
</span><span id="AirlineFlightPlanner-940"><a href="#AirlineFlightPlanner-940"><span class="linenos"> 940</span></a>		<span class="c1"># 	current_fp = self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;]#[&#39;fp_options&#39;][self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;]]</span>
</span><span id="AirlineFlightPlanner-941"><a href="#AirlineFlightPlanner-941"><span class="linenos"> 941</span></a>		<span class="c1"># 	new_eobt = max(ac_ready_at_time, current_fp.eobt)</span>
</span><span id="AirlineFlightPlanner-942"><a href="#AirlineFlightPlanner-942"><span class="linenos"> 942</span></a>
</span><span id="AirlineFlightPlanner-943"><a href="#AirlineFlightPlanner-943"><span class="linenos"> 943</span></a>		<span class="c1"># 	# if not (new_eobt==current_fp.eobt and just_computed):</span>
</span><span id="AirlineFlightPlanner-944"><a href="#AirlineFlightPlanner-944"><span class="linenos"> 944</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-945"><a href="#AirlineFlightPlanner-945"><span class="linenos"> 945</span></a>		<span class="c1"># 	 	print(&#39;AOC will update EOBT of flight {} because the aircraft was not ready in time (OLD EOBT IS {}, NEW EOBT IS {}, OLD ELT IS {})&#39;.format(flight_uid, current_fp.eobt, new_eobt, current_fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner-946"><a href="#AirlineFlightPlanner-946"><span class="linenos"> 946</span></a>
</span><span id="AirlineFlightPlanner-947"><a href="#AirlineFlightPlanner-947"><span class="linenos"> 947</span></a>		<span class="c1"># 	mprint(flight_str(flight_uid), &#39;has a new eobt of&#39;, new_eobt,</span>
</span><span id="AirlineFlightPlanner-948"><a href="#AirlineFlightPlanner-948"><span class="linenos"> 948</span></a>		<span class="c1"># 		&#39;and resubmits its flight plan.&#39;)</span>
</span><span id="AirlineFlightPlanner-949"><a href="#AirlineFlightPlanner-949"><span class="linenos"> 949</span></a>
</span><span id="AirlineFlightPlanner-950"><a href="#AirlineFlightPlanner-950"><span class="linenos"> 950</span></a>		<span class="c1"># 	current_fp.update_eobt(new_eobt)</span>
</span><span id="AirlineFlightPlanner-951"><a href="#AirlineFlightPlanner-951"><span class="linenos"> 951</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-952"><a href="#AirlineFlightPlanner-952"><span class="linenos"> 952</span></a>		<span class="c1"># 		print(&#39;AOC has modified the flight plan ({}) EOBT for flight {} and resubmits it (ELT IS {})&#39;.format(flight_uid, current_fp, current_fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner-953"><a href="#AirlineFlightPlanner-953"><span class="linenos"> 953</span></a>
</span><span id="AirlineFlightPlanner-954"><a href="#AirlineFlightPlanner-954"><span class="linenos"> 954</span></a>		<span class="c1"># 	self.send_flight_plan_submission(flight_uid, current_fp)</span>
</span><span id="AirlineFlightPlanner-955"><a href="#AirlineFlightPlanner-955"><span class="linenos"> 955</span></a>
</span><span id="AirlineFlightPlanner-956"><a href="#AirlineFlightPlanner-956"><span class="linenos"> 956</span></a>	<span class="k">def</span> <span class="nf">compute_FP_options_from_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">,</span> <span class="n">eobt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-957"><a href="#AirlineFlightPlanner-957"><span class="linenos"> 957</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is creating the possible flight plans for flight&#39;</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-958"><a href="#AirlineFlightPlanner-958"><span class="linenos"> 958</span></a>		<span class="c1"># if aoc_flight_info[&#39;flight_uid&#39;] in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-959"><a href="#AirlineFlightPlanner-959"><span class="linenos"> 959</span></a>		<span class="c1"># 	print(&quot;{} compute the FP options from fp pool for flight {} with EOBT {}&quot;.format(self.agent, aoc_flight_info[&#39;flight_uid&#39;], eobt))</span>
</span><span id="AirlineFlightPlanner-960"><a href="#AirlineFlightPlanner-960"><span class="linenos"> 960</span></a>		<span class="k">if</span> <span class="n">eobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-961"><a href="#AirlineFlightPlanner-961"><span class="linenos"> 961</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-962"><a href="#AirlineFlightPlanner-962"><span class="linenos"> 962</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-963"><a href="#AirlineFlightPlanner-963"><span class="linenos"> 963</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eobt</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-964"><a href="#AirlineFlightPlanner-964"><span class="linenos"> 964</span></a>		<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-965"><a href="#AirlineFlightPlanner-965"><span class="linenos"> 965</span></a>		<span class="n">destination_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-966"><a href="#AirlineFlightPlanner-966"><span class="linenos"> 966</span></a>		<span class="c1"># ac_performances_bada = aoc_flight_info[&#39;aircraft&#39;].bada_performances</span>
</span><span id="AirlineFlightPlanner-967"><a href="#AirlineFlightPlanner-967"><span class="linenos"> 967</span></a>		<span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bada_code_ac_model</span>
</span><span id="AirlineFlightPlanner-968"><a href="#AirlineFlightPlanner-968"><span class="linenos"> 968</span></a>
</span><span id="AirlineFlightPlanner-969"><a href="#AirlineFlightPlanner-969"><span class="linenos"> 969</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-970"><a href="#AirlineFlightPlanner-970"><span class="linenos"> 970</span></a>			<span class="n">possible_fp_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="p">[(</span><span class="n">origin_airport_uid</span><span class="p">,</span> <span class="n">destination_airport_uid</span><span class="p">,</span> <span class="n">bada_code_ac_model</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-971"><a href="#AirlineFlightPlanner-971"><span class="linenos"> 971</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-972"><a href="#AirlineFlightPlanner-972"><span class="linenos"> 972</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COICOIN&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="AirlineFlightPlanner-973"><a href="#AirlineFlightPlanner-973"><span class="linenos"> 973</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-974"><a href="#AirlineFlightPlanner-974"><span class="linenos"> 974</span></a>
</span><span id="AirlineFlightPlanner-975"><a href="#AirlineFlightPlanner-975"><span class="linenos"> 975</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-976"><a href="#AirlineFlightPlanner-976"><span class="linenos"> 976</span></a>		<span class="k">for</span> <span class="n">pfp</span> <span class="ow">in</span> <span class="n">possible_fp_pool</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-977"><a href="#AirlineFlightPlanner-977"><span class="linenos"> 977</span></a>			<span class="n">fp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-978"><a href="#AirlineFlightPlanner-978"><span class="linenos"> 978</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-979"><a href="#AirlineFlightPlanner-979"><span class="linenos"> 979</span></a>			<span class="c1"># fp.eobt = aoc_flight_info[&#39;sobt&#39;]</span>
</span><span id="AirlineFlightPlanner-980"><a href="#AirlineFlightPlanner-980"><span class="linenos"> 980</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">eobt</span> <span class="o">=</span> <span class="n">eobt</span>
</span><span id="AirlineFlightPlanner-981"><a href="#AirlineFlightPlanner-981"><span class="linenos"> 981</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-982"><a href="#AirlineFlightPlanner-982"><span class="linenos"> 982</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sibt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-983"><a href="#AirlineFlightPlanner-983"><span class="linenos"> 983</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-984"><a href="#AirlineFlightPlanner-984"><span class="linenos"> 984</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">destination_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-985"><a href="#AirlineFlightPlanner-985"><span class="linenos"> 985</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">bada_code_ac_model</span>
</span><span id="AirlineFlightPlanner-986"><a href="#AirlineFlightPlanner-986"><span class="linenos"> 986</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">flight_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-987"><a href="#AirlineFlightPlanner-987"><span class="linenos"> 987</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span>
</span><span id="AirlineFlightPlanner-988"><a href="#AirlineFlightPlanner-988"><span class="linenos"> 988</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">compute_eibt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-989"><a href="#AirlineFlightPlanner-989"><span class="linenos"> 989</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">add_event_to_point</span><span class="p">(</span><span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;takeoff_event&#39;</span><span class="p">],</span> <span class="s1">&#39;takeoff&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-990"><a href="#AirlineFlightPlanner-990"><span class="linenos"> 990</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">get_unique_id</span><span class="p">()]</span> <span class="o">=</span> <span class="n">fp</span>
</span><span id="AirlineFlightPlanner-991"><a href="#AirlineFlightPlanner-991"><span class="linenos"> 991</span></a>
</span><span id="AirlineFlightPlanner-992"><a href="#AirlineFlightPlanner-992"><span class="linenos"> 992</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options</span> <span class="o">+</span> <span class="p">[</span><span class="n">fp</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-993"><a href="#AirlineFlightPlanner-993"><span class="linenos"> 993</span></a>
</span><span id="AirlineFlightPlanner-994"><a href="#AirlineFlightPlanner-994"><span class="linenos"> 994</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">remove_shorter_route_calibration</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-995"><a href="#AirlineFlightPlanner-995"><span class="linenos"> 995</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-996"><a href="#AirlineFlightPlanner-996"><span class="linenos"> 996</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">option</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">get_total_planned_distance</span><span class="p">())</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-997"><a href="#AirlineFlightPlanner-997"><span class="linenos"> 997</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-998"><a href="#AirlineFlightPlanner-998"><span class="linenos"> 998</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">fp_options</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-999"><a href="#AirlineFlightPlanner-999"><span class="linenos"> 999</span></a>
</span><span id="AirlineFlightPlanner-1000"><a href="#AirlineFlightPlanner-1000"><span class="linenos">1000</span></a>		<span class="k">return</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner-1001"><a href="#AirlineFlightPlanner-1001"><span class="linenos">1001</span></a>
</span><span id="AirlineFlightPlanner-1002"><a href="#AirlineFlightPlanner-1002"><span class="linenos">1002</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1003"><a href="#AirlineFlightPlanner-1003"><span class="linenos">1003</span></a>		<span class="n">buf</span> <span class="o">=</span> <span class="mi">999999999991</span>
</span><span id="AirlineFlightPlanner-1004"><a href="#AirlineFlightPlanner-1004"><span class="linenos">1004</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-1005"><a href="#AirlineFlightPlanner-1005"><span class="linenos">1005</span></a>			<span class="c1"># Get minimum buffer to avoid curfews on downstream flights</span>
</span><span id="AirlineFlightPlanner-1006"><a href="#AirlineFlightPlanner-1006"><span class="linenos">1006</span></a>			<span class="c1"># Note: not taking into account curfew for this flight, because flight plan</span>
</span><span id="AirlineFlightPlanner-1007"><a href="#AirlineFlightPlanner-1007"><span class="linenos">1007</span></a>			<span class="c1"># has been accepted and thus should be legit (arriving before curfew).</span>
</span><span id="AirlineFlightPlanner-1008"><a href="#AirlineFlightPlanner-1008"><span class="linenos">1008</span></a>			<span class="c1"># Get all flights after this one using the same aircraft</span>
</span><span id="AirlineFlightPlanner-1009"><a href="#AirlineFlightPlanner-1009"><span class="linenos">1009</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1010"><a href="#AirlineFlightPlanner-1010"><span class="linenos">1010</span></a>			<span class="n">next_flights</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1011"><a href="#AirlineFlightPlanner-1011"><span class="linenos">1011</span></a>
</span><span id="AirlineFlightPlanner-1012"><a href="#AirlineFlightPlanner-1012"><span class="linenos">1012</span></a>			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">next_flights</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1013"><a href="#AirlineFlightPlanner-1013"><span class="linenos">1013</span></a>				<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1014"><a href="#AirlineFlightPlanner-1014"><span class="linenos">1014</span></a>					<span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1015"><a href="#AirlineFlightPlanner-1015"><span class="linenos">1015</span></a>				<span class="n">buf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">),</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1016"><a href="#AirlineFlightPlanner-1016"><span class="linenos">1016</span></a>
</span><span id="AirlineFlightPlanner-1017"><a href="#AirlineFlightPlanner-1017"><span class="linenos">1017</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Buffer computed for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1018"><a href="#AirlineFlightPlanner-1018"><span class="linenos">1018</span></a>		<span class="k">return</span> <span class="n">buf</span>
</span><span id="AirlineFlightPlanner-1019"><a href="#AirlineFlightPlanner-1019"><span class="linenos">1019</span></a>
</span><span id="AirlineFlightPlanner-1020"><a href="#AirlineFlightPlanner-1020"><span class="linenos">1020</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1021"><a href="#AirlineFlightPlanner-1021"><span class="linenos">1021</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-1022"><a href="#AirlineFlightPlanner-1022"><span class="linenos">1022</span></a>			<span class="k">return</span> <span class="mi">999999999991</span><span class="p">,</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-1023"><a href="#AirlineFlightPlanner-1023"><span class="linenos">1023</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1024"><a href="#AirlineFlightPlanner-1024"><span class="linenos">1024</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1025"><a href="#AirlineFlightPlanner-1025"><span class="linenos">1025</span></a>
</span><span id="AirlineFlightPlanner-1026"><a href="#AirlineFlightPlanner-1026"><span class="linenos">1026</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1027"><a href="#AirlineFlightPlanner-1027"><span class="linenos">1027</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1028"><a href="#AirlineFlightPlanner-1028"><span class="linenos">1028</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-1029"><a href="#AirlineFlightPlanner-1029"><span class="linenos">1029</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1030"><a href="#AirlineFlightPlanner-1030"><span class="linenos">1030</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1031"><a href="#AirlineFlightPlanner-1031"><span class="linenos">1031</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1032"><a href="#AirlineFlightPlanner-1032"><span class="linenos">1032</span></a>				<span class="n">curfew_buffer_downstream</span><span class="p">,</span> <span class="n">flight_uid_propagates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1033"><a href="#AirlineFlightPlanner-1033"><span class="linenos">1033</span></a>			<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1034"><a href="#AirlineFlightPlanner-1034"><span class="linenos">1034</span></a>				<span class="c1"># There is no next flight, the reason is because that flight has been cancelled. Therefore, you are not propagating anymore</span>
</span><span id="AirlineFlightPlanner-1035"><a href="#AirlineFlightPlanner-1035"><span class="linenos">1035</span></a>				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-1036"><a href="#AirlineFlightPlanner-1036"><span class="linenos">1036</span></a>
</span><span id="AirlineFlightPlanner-1037"><a href="#AirlineFlightPlanner-1037"><span class="linenos">1037</span></a>			<span class="n">propaget_to_curfew</span> <span class="o">=</span> <span class="n">curfew_buffer_downstream</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1038"><a href="#AirlineFlightPlanner-1038"><span class="linenos">1038</span></a>			<span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)])</span>
</span><span id="AirlineFlightPlanner-1039"><a href="#AirlineFlightPlanner-1039"><span class="linenos">1039</span></a>			<span class="k">return</span> <span class="p">[</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">flight_uid_propagates</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1040"><a href="#AirlineFlightPlanner-1040"><span class="linenos">1040</span></a>
</span><span id="AirlineFlightPlanner-1041"><a href="#AirlineFlightPlanner-1041"><span class="linenos">1041</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1042"><a href="#AirlineFlightPlanner-1042"><span class="linenos">1042</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1043"><a href="#AirlineFlightPlanner-1043"><span class="linenos">1043</span></a>		<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1044"><a href="#AirlineFlightPlanner-1044"><span class="linenos">1044</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1045"><a href="#AirlineFlightPlanner-1045"><span class="linenos">1045</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner-1046"><a href="#AirlineFlightPlanner-1046"><span class="linenos">1046</span></a><span class="sd">		to scheduled departure or scheduled arrival) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner-1047"><a href="#AirlineFlightPlanner-1047"><span class="linenos">1047</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner-1048"><a href="#AirlineFlightPlanner-1048"><span class="linenos">1048</span></a>
</span><span id="AirlineFlightPlanner-1049"><a href="#AirlineFlightPlanner-1049"><span class="linenos">1049</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner-1050"><a href="#AirlineFlightPlanner-1050"><span class="linenos">1050</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner-1051"><a href="#AirlineFlightPlanner-1051"><span class="linenos">1051</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner-1052"><a href="#AirlineFlightPlanner-1052"><span class="linenos">1052</span></a>
</span><span id="AirlineFlightPlanner-1053"><a href="#AirlineFlightPlanner-1053"><span class="linenos">1053</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner-1054"><a href="#AirlineFlightPlanner-1054"><span class="linenos">1054</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner-1055"><a href="#AirlineFlightPlanner-1055"><span class="linenos">1055</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner-1056"><a href="#AirlineFlightPlanner-1056"><span class="linenos">1056</span></a>
</span><span id="AirlineFlightPlanner-1057"><a href="#AirlineFlightPlanner-1057"><span class="linenos">1057</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner-1058"><a href="#AirlineFlightPlanner-1058"><span class="linenos">1058</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner-1059"><a href="#AirlineFlightPlanner-1059"><span class="linenos">1059</span></a>
</span><span id="AirlineFlightPlanner-1060"><a href="#AirlineFlightPlanner-1060"><span class="linenos">1060</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner-1061"><a href="#AirlineFlightPlanner-1061"><span class="linenos">1061</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner-1062"><a href="#AirlineFlightPlanner-1062"><span class="linenos">1062</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner-1063"><a href="#AirlineFlightPlanner-1063"><span class="linenos">1063</span></a>
</span><span id="AirlineFlightPlanner-1064"><a href="#AirlineFlightPlanner-1064"><span class="linenos">1064</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner-1065"><a href="#AirlineFlightPlanner-1065"><span class="linenos">1065</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner-1066"><a href="#AirlineFlightPlanner-1066"><span class="linenos">1066</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1067"><a href="#AirlineFlightPlanner-1067"><span class="linenos">1067</span></a>
</span><span id="AirlineFlightPlanner-1068"><a href="#AirlineFlightPlanner-1068"><span class="linenos">1068</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1069"><a href="#AirlineFlightPlanner-1069"><span class="linenos">1069</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1070"><a href="#AirlineFlightPlanner-1070"><span class="linenos">1070</span></a>
</span><span id="AirlineFlightPlanner-1071"><a href="#AirlineFlightPlanner-1071"><span class="linenos">1071</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner-1072"><a href="#AirlineFlightPlanner-1072"><span class="linenos">1072</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1073"><a href="#AirlineFlightPlanner-1073"><span class="linenos">1073</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1074"><a href="#AirlineFlightPlanner-1074"><span class="linenos">1074</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1075"><a href="#AirlineFlightPlanner-1075"><span class="linenos">1075</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1076"><a href="#AirlineFlightPlanner-1076"><span class="linenos">1076</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1077"><a href="#AirlineFlightPlanner-1077"><span class="linenos">1077</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1078"><a href="#AirlineFlightPlanner-1078"><span class="linenos">1078</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1079"><a href="#AirlineFlightPlanner-1079"><span class="linenos">1079</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1080"><a href="#AirlineFlightPlanner-1080"><span class="linenos">1080</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1081"><a href="#AirlineFlightPlanner-1081"><span class="linenos">1081</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner-1082"><a href="#AirlineFlightPlanner-1082"><span class="linenos">1082</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1083"><a href="#AirlineFlightPlanner-1083"><span class="linenos">1083</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1084"><a href="#AirlineFlightPlanner-1084"><span class="linenos">1084</span></a>
</span><span id="AirlineFlightPlanner-1085"><a href="#AirlineFlightPlanner-1085"><span class="linenos">1085</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-1086"><a href="#AirlineFlightPlanner-1086"><span class="linenos">1086</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1087"><a href="#AirlineFlightPlanner-1087"><span class="linenos">1087</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1088"><a href="#AirlineFlightPlanner-1088"><span class="linenos">1088</span></a>
</span><span id="AirlineFlightPlanner-1089"><a href="#AirlineFlightPlanner-1089"><span class="linenos">1089</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1090"><a href="#AirlineFlightPlanner-1090"><span class="linenos">1090</span></a>
</span><span id="AirlineFlightPlanner-1091"><a href="#AirlineFlightPlanner-1091"><span class="linenos">1091</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner-1092"><a href="#AirlineFlightPlanner-1092"><span class="linenos">1092</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1093"><a href="#AirlineFlightPlanner-1093"><span class="linenos">1093</span></a>
</span><span id="AirlineFlightPlanner-1094"><a href="#AirlineFlightPlanner-1094"><span class="linenos">1094</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1095"><a href="#AirlineFlightPlanner-1095"><span class="linenos">1095</span></a>			<span class="c1"># X is the arrival (or departure delay?) with respect to schedule</span>
</span><span id="AirlineFlightPlanner-1096"><a href="#AirlineFlightPlanner-1096"><span class="linenos">1096</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1097"><a href="#AirlineFlightPlanner-1097"><span class="linenos">1097</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1098"><a href="#AirlineFlightPlanner-1098"><span class="linenos">1098</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1099"><a href="#AirlineFlightPlanner-1099"><span class="linenos">1099</span></a>
</span><span id="AirlineFlightPlanner-1100"><a href="#AirlineFlightPlanner-1100"><span class="linenos">1100</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1101"><a href="#AirlineFlightPlanner-1101"><span class="linenos">1101</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner-1102"><a href="#AirlineFlightPlanner-1102"><span class="linenos">1102</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner-1103"><a href="#AirlineFlightPlanner-1103"><span class="linenos">1103</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1104"><a href="#AirlineFlightPlanner-1104"><span class="linenos">1104</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1105"><a href="#AirlineFlightPlanner-1105"><span class="linenos">1105</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1106"><a href="#AirlineFlightPlanner-1106"><span class="linenos">1106</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1107"><a href="#AirlineFlightPlanner-1107"><span class="linenos">1107</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1108"><a href="#AirlineFlightPlanner-1108"><span class="linenos">1108</span></a>						<span class="k">if</span> <span class="ow">not</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1109"><a href="#AirlineFlightPlanner-1109"><span class="linenos">1109</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1110"><a href="#AirlineFlightPlanner-1110"><span class="linenos">1110</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1111"><a href="#AirlineFlightPlanner-1111"><span class="linenos">1111</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1112"><a href="#AirlineFlightPlanner-1112"><span class="linenos">1112</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1113"><a href="#AirlineFlightPlanner-1113"><span class="linenos">1113</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1114"><a href="#AirlineFlightPlanner-1114"><span class="linenos">1114</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1115"><a href="#AirlineFlightPlanner-1115"><span class="linenos">1115</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1116"><a href="#AirlineFlightPlanner-1116"><span class="linenos">1116</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1117"><a href="#AirlineFlightPlanner-1117"><span class="linenos">1117</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1118"><a href="#AirlineFlightPlanner-1118"><span class="linenos">1118</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1119"><a href="#AirlineFlightPlanner-1119"><span class="linenos">1119</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1120"><a href="#AirlineFlightPlanner-1120"><span class="linenos">1120</span></a>
</span><span id="AirlineFlightPlanner-1121"><a href="#AirlineFlightPlanner-1121"><span class="linenos">1121</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1122"><a href="#AirlineFlightPlanner-1122"><span class="linenos">1122</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1123"><a href="#AirlineFlightPlanner-1123"><span class="linenos">1123</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1124"><a href="#AirlineFlightPlanner-1124"><span class="linenos">1124</span></a>
</span><span id="AirlineFlightPlanner-1125"><a href="#AirlineFlightPlanner-1125"><span class="linenos">1125</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1126"><a href="#AirlineFlightPlanner-1126"><span class="linenos">1126</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1127"><a href="#AirlineFlightPlanner-1127"><span class="linenos">1127</span></a>
</span><span id="AirlineFlightPlanner-1128"><a href="#AirlineFlightPlanner-1128"><span class="linenos">1128</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner-1129"><a href="#AirlineFlightPlanner-1129"><span class="linenos">1129</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1130"><a href="#AirlineFlightPlanner-1130"><span class="linenos">1130</span></a>
</span><span id="AirlineFlightPlanner-1131"><a href="#AirlineFlightPlanner-1131"><span class="linenos">1131</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-1132"><a href="#AirlineFlightPlanner-1132"><span class="linenos">1132</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1133"><a href="#AirlineFlightPlanner-1133"><span class="linenos">1133</span></a>
</span><span id="AirlineFlightPlanner-1134"><a href="#AirlineFlightPlanner-1134"><span class="linenos">1134</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-1135"><a href="#AirlineFlightPlanner-1135"><span class="linenos">1135</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1136"><a href="#AirlineFlightPlanner-1136"><span class="linenos">1136</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1137"><a href="#AirlineFlightPlanner-1137"><span class="linenos">1137</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1138"><a href="#AirlineFlightPlanner-1138"><span class="linenos">1138</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1139"><a href="#AirlineFlightPlanner-1139"><span class="linenos">1139</span></a>
</span><span id="AirlineFlightPlanner-1140"><a href="#AirlineFlightPlanner-1140"><span class="linenos">1140</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner-1141"><a href="#AirlineFlightPlanner-1141"><span class="linenos">1141</span></a>
</span><span id="AirlineFlightPlanner-1142"><a href="#AirlineFlightPlanner-1142"><span class="linenos">1142</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner-1143"><a href="#AirlineFlightPlanner-1143"><span class="linenos">1143</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1144"><a href="#AirlineFlightPlanner-1144"><span class="linenos">1144</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1145"><a href="#AirlineFlightPlanner-1145"><span class="linenos">1145</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1146"><a href="#AirlineFlightPlanner-1146"><span class="linenos">1146</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1147"><a href="#AirlineFlightPlanner-1147"><span class="linenos">1147</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1148"><a href="#AirlineFlightPlanner-1148"><span class="linenos">1148</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1149"><a href="#AirlineFlightPlanner-1149"><span class="linenos">1149</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1150"><a href="#AirlineFlightPlanner-1150"><span class="linenos">1150</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1151"><a href="#AirlineFlightPlanner-1151"><span class="linenos">1151</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1152"><a href="#AirlineFlightPlanner-1152"><span class="linenos">1152</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1153"><a href="#AirlineFlightPlanner-1153"><span class="linenos">1153</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1154"><a href="#AirlineFlightPlanner-1154"><span class="linenos">1154</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1155"><a href="#AirlineFlightPlanner-1155"><span class="linenos">1155</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1156"><a href="#AirlineFlightPlanner-1156"><span class="linenos">1156</span></a>
</span><span id="AirlineFlightPlanner-1157"><a href="#AirlineFlightPlanner-1157"><span class="linenos">1157</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner-1158"><a href="#AirlineFlightPlanner-1158"><span class="linenos">1158</span></a>
</span><span id="AirlineFlightPlanner-1159"><a href="#AirlineFlightPlanner-1159"><span class="linenos">1159</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-1160"><a href="#AirlineFlightPlanner-1160"><span class="linenos">1160</span></a>
</span><span id="AirlineFlightPlanner-1161"><a href="#AirlineFlightPlanner-1161"><span class="linenos">1161</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1162"><a href="#AirlineFlightPlanner-1162"><span class="linenos">1162</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1163"><a href="#AirlineFlightPlanner-1163"><span class="linenos">1163</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1164"><a href="#AirlineFlightPlanner-1164"><span class="linenos">1164</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1165"><a href="#AirlineFlightPlanner-1165"><span class="linenos">1165</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1166"><a href="#AirlineFlightPlanner-1166"><span class="linenos">1166</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1167"><a href="#AirlineFlightPlanner-1167"><span class="linenos">1167</span></a>
</span><span id="AirlineFlightPlanner-1168"><a href="#AirlineFlightPlanner-1168"><span class="linenos">1168</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-1169"><a href="#AirlineFlightPlanner-1169"><span class="linenos">1169</span></a>
</span><span id="AirlineFlightPlanner-1170"><a href="#AirlineFlightPlanner-1170"><span class="linenos">1170</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1171"><a href="#AirlineFlightPlanner-1171"><span class="linenos">1171</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1172"><a href="#AirlineFlightPlanner-1172"><span class="linenos">1172</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1173"><a href="#AirlineFlightPlanner-1173"><span class="linenos">1173</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1174"><a href="#AirlineFlightPlanner-1174"><span class="linenos">1174</span></a><span class="sd">		VERSION ONLY WITH FLIGHT COST</span>
</span><span id="AirlineFlightPlanner-1175"><a href="#AirlineFlightPlanner-1175"><span class="linenos">1175</span></a>
</span><span id="AirlineFlightPlanner-1176"><a href="#AirlineFlightPlanner-1176"><span class="linenos">1176</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner-1177"><a href="#AirlineFlightPlanner-1177"><span class="linenos">1177</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner-1178"><a href="#AirlineFlightPlanner-1178"><span class="linenos">1178</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner-1179"><a href="#AirlineFlightPlanner-1179"><span class="linenos">1179</span></a>
</span><span id="AirlineFlightPlanner-1180"><a href="#AirlineFlightPlanner-1180"><span class="linenos">1180</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner-1181"><a href="#AirlineFlightPlanner-1181"><span class="linenos">1181</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner-1182"><a href="#AirlineFlightPlanner-1182"><span class="linenos">1182</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner-1183"><a href="#AirlineFlightPlanner-1183"><span class="linenos">1183</span></a>
</span><span id="AirlineFlightPlanner-1184"><a href="#AirlineFlightPlanner-1184"><span class="linenos">1184</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner-1185"><a href="#AirlineFlightPlanner-1185"><span class="linenos">1185</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner-1186"><a href="#AirlineFlightPlanner-1186"><span class="linenos">1186</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner-1187"><a href="#AirlineFlightPlanner-1187"><span class="linenos">1187</span></a>
</span><span id="AirlineFlightPlanner-1188"><a href="#AirlineFlightPlanner-1188"><span class="linenos">1188</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner-1189"><a href="#AirlineFlightPlanner-1189"><span class="linenos">1189</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner-1190"><a href="#AirlineFlightPlanner-1190"><span class="linenos">1190</span></a>
</span><span id="AirlineFlightPlanner-1191"><a href="#AirlineFlightPlanner-1191"><span class="linenos">1191</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner-1192"><a href="#AirlineFlightPlanner-1192"><span class="linenos">1192</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner-1193"><a href="#AirlineFlightPlanner-1193"><span class="linenos">1193</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner-1194"><a href="#AirlineFlightPlanner-1194"><span class="linenos">1194</span></a>
</span><span id="AirlineFlightPlanner-1195"><a href="#AirlineFlightPlanner-1195"><span class="linenos">1195</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner-1196"><a href="#AirlineFlightPlanner-1196"><span class="linenos">1196</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner-1197"><a href="#AirlineFlightPlanner-1197"><span class="linenos">1197</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1198"><a href="#AirlineFlightPlanner-1198"><span class="linenos">1198</span></a>
</span><span id="AirlineFlightPlanner-1199"><a href="#AirlineFlightPlanner-1199"><span class="linenos">1199</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1200"><a href="#AirlineFlightPlanner-1200"><span class="linenos">1200</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1201"><a href="#AirlineFlightPlanner-1201"><span class="linenos">1201</span></a>
</span><span id="AirlineFlightPlanner-1202"><a href="#AirlineFlightPlanner-1202"><span class="linenos">1202</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner-1203"><a href="#AirlineFlightPlanner-1203"><span class="linenos">1203</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1204"><a href="#AirlineFlightPlanner-1204"><span class="linenos">1204</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1205"><a href="#AirlineFlightPlanner-1205"><span class="linenos">1205</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1206"><a href="#AirlineFlightPlanner-1206"><span class="linenos">1206</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1207"><a href="#AirlineFlightPlanner-1207"><span class="linenos">1207</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1208"><a href="#AirlineFlightPlanner-1208"><span class="linenos">1208</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1209"><a href="#AirlineFlightPlanner-1209"><span class="linenos">1209</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1210"><a href="#AirlineFlightPlanner-1210"><span class="linenos">1210</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1211"><a href="#AirlineFlightPlanner-1211"><span class="linenos">1211</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1212"><a href="#AirlineFlightPlanner-1212"><span class="linenos">1212</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner-1213"><a href="#AirlineFlightPlanner-1213"><span class="linenos">1213</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1214"><a href="#AirlineFlightPlanner-1214"><span class="linenos">1214</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1215"><a href="#AirlineFlightPlanner-1215"><span class="linenos">1215</span></a>
</span><span id="AirlineFlightPlanner-1216"><a href="#AirlineFlightPlanner-1216"><span class="linenos">1216</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-1217"><a href="#AirlineFlightPlanner-1217"><span class="linenos">1217</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1218"><a href="#AirlineFlightPlanner-1218"><span class="linenos">1218</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1219"><a href="#AirlineFlightPlanner-1219"><span class="linenos">1219</span></a>
</span><span id="AirlineFlightPlanner-1220"><a href="#AirlineFlightPlanner-1220"><span class="linenos">1220</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1221"><a href="#AirlineFlightPlanner-1221"><span class="linenos">1221</span></a>
</span><span id="AirlineFlightPlanner-1222"><a href="#AirlineFlightPlanner-1222"><span class="linenos">1222</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner-1223"><a href="#AirlineFlightPlanner-1223"><span class="linenos">1223</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1224"><a href="#AirlineFlightPlanner-1224"><span class="linenos">1224</span></a>
</span><span id="AirlineFlightPlanner-1225"><a href="#AirlineFlightPlanner-1225"><span class="linenos">1225</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1226"><a href="#AirlineFlightPlanner-1226"><span class="linenos">1226</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1227"><a href="#AirlineFlightPlanner-1227"><span class="linenos">1227</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1228"><a href="#AirlineFlightPlanner-1228"><span class="linenos">1228</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1229"><a href="#AirlineFlightPlanner-1229"><span class="linenos">1229</span></a>
</span><span id="AirlineFlightPlanner-1230"><a href="#AirlineFlightPlanner-1230"><span class="linenos">1230</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-1231"><a href="#AirlineFlightPlanner-1231"><span class="linenos">1231</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1232"><a href="#AirlineFlightPlanner-1232"><span class="linenos">1232</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>  <span class="c1"># + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="AirlineFlightPlanner-1233"><a href="#AirlineFlightPlanner-1233"><span class="linenos">1233</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1234"><a href="#AirlineFlightPlanner-1234"><span class="linenos">1234</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1235"><a href="#AirlineFlightPlanner-1235"><span class="linenos">1235</span></a>
</span><span id="AirlineFlightPlanner-1236"><a href="#AirlineFlightPlanner-1236"><span class="linenos">1236</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span>  <span class="c1"># + cost_soft_cost + cost_doc + cost_compensation</span>
</span><span id="AirlineFlightPlanner-1237"><a href="#AirlineFlightPlanner-1237"><span class="linenos">1237</span></a>
</span><span id="AirlineFlightPlanner-1238"><a href="#AirlineFlightPlanner-1238"><span class="linenos">1238</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner-1239"><a href="#AirlineFlightPlanner-1239"><span class="linenos">1239</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1240"><a href="#AirlineFlightPlanner-1240"><span class="linenos">1240</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1241"><a href="#AirlineFlightPlanner-1241"><span class="linenos">1241</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1242"><a href="#AirlineFlightPlanner-1242"><span class="linenos">1242</span></a>																										  <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1243"><a href="#AirlineFlightPlanner-1243"><span class="linenos">1243</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1244"><a href="#AirlineFlightPlanner-1244"><span class="linenos">1244</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1245"><a href="#AirlineFlightPlanner-1245"><span class="linenos">1245</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1246"><a href="#AirlineFlightPlanner-1246"><span class="linenos">1246</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1247"><a href="#AirlineFlightPlanner-1247"><span class="linenos">1247</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1248"><a href="#AirlineFlightPlanner-1248"><span class="linenos">1248</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1249"><a href="#AirlineFlightPlanner-1249"><span class="linenos">1249</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1250"><a href="#AirlineFlightPlanner-1250"><span class="linenos">1250</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1251"><a href="#AirlineFlightPlanner-1251"><span class="linenos">1251</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1252"><a href="#AirlineFlightPlanner-1252"><span class="linenos">1252</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1253"><a href="#AirlineFlightPlanner-1253"><span class="linenos">1253</span></a>
</span><span id="AirlineFlightPlanner-1254"><a href="#AirlineFlightPlanner-1254"><span class="linenos">1254</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner-1255"><a href="#AirlineFlightPlanner-1255"><span class="linenos">1255</span></a>
</span><span id="AirlineFlightPlanner-1256"><a href="#AirlineFlightPlanner-1256"><span class="linenos">1256</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-1257"><a href="#AirlineFlightPlanner-1257"><span class="linenos">1257</span></a>
</span><span id="AirlineFlightPlanner-1258"><a href="#AirlineFlightPlanner-1258"><span class="linenos">1258</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1259"><a href="#AirlineFlightPlanner-1259"><span class="linenos">1259</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1260"><a href="#AirlineFlightPlanner-1260"><span class="linenos">1260</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1261"><a href="#AirlineFlightPlanner-1261"><span class="linenos">1261</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1262"><a href="#AirlineFlightPlanner-1262"><span class="linenos">1262</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1263"><a href="#AirlineFlightPlanner-1263"><span class="linenos">1263</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1264"><a href="#AirlineFlightPlanner-1264"><span class="linenos">1264</span></a>
</span><span id="AirlineFlightPlanner-1265"><a href="#AirlineFlightPlanner-1265"><span class="linenos">1265</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-1266"><a href="#AirlineFlightPlanner-1266"><span class="linenos">1266</span></a>
</span><span id="AirlineFlightPlanner-1267"><a href="#AirlineFlightPlanner-1267"><span class="linenos">1267</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1268"><a href="#AirlineFlightPlanner-1268"><span class="linenos">1268</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1269"><a href="#AirlineFlightPlanner-1269"><span class="linenos">1269</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1270"><a href="#AirlineFlightPlanner-1270"><span class="linenos">1270</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1271"><a href="#AirlineFlightPlanner-1271"><span class="linenos">1271</span></a><span class="sd">		VERSION ONLY WITH PAX COST</span>
</span><span id="AirlineFlightPlanner-1272"><a href="#AirlineFlightPlanner-1272"><span class="linenos">1272</span></a>
</span><span id="AirlineFlightPlanner-1273"><a href="#AirlineFlightPlanner-1273"><span class="linenos">1273</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner-1274"><a href="#AirlineFlightPlanner-1274"><span class="linenos">1274</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner-1275"><a href="#AirlineFlightPlanner-1275"><span class="linenos">1275</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner-1276"><a href="#AirlineFlightPlanner-1276"><span class="linenos">1276</span></a>
</span><span id="AirlineFlightPlanner-1277"><a href="#AirlineFlightPlanner-1277"><span class="linenos">1277</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner-1278"><a href="#AirlineFlightPlanner-1278"><span class="linenos">1278</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner-1279"><a href="#AirlineFlightPlanner-1279"><span class="linenos">1279</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner-1280"><a href="#AirlineFlightPlanner-1280"><span class="linenos">1280</span></a>
</span><span id="AirlineFlightPlanner-1281"><a href="#AirlineFlightPlanner-1281"><span class="linenos">1281</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner-1282"><a href="#AirlineFlightPlanner-1282"><span class="linenos">1282</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner-1283"><a href="#AirlineFlightPlanner-1283"><span class="linenos">1283</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner-1284"><a href="#AirlineFlightPlanner-1284"><span class="linenos">1284</span></a>
</span><span id="AirlineFlightPlanner-1285"><a href="#AirlineFlightPlanner-1285"><span class="linenos">1285</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner-1286"><a href="#AirlineFlightPlanner-1286"><span class="linenos">1286</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner-1287"><a href="#AirlineFlightPlanner-1287"><span class="linenos">1287</span></a>
</span><span id="AirlineFlightPlanner-1288"><a href="#AirlineFlightPlanner-1288"><span class="linenos">1288</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner-1289"><a href="#AirlineFlightPlanner-1289"><span class="linenos">1289</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner-1290"><a href="#AirlineFlightPlanner-1290"><span class="linenos">1290</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner-1291"><a href="#AirlineFlightPlanner-1291"><span class="linenos">1291</span></a>
</span><span id="AirlineFlightPlanner-1292"><a href="#AirlineFlightPlanner-1292"><span class="linenos">1292</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner-1293"><a href="#AirlineFlightPlanner-1293"><span class="linenos">1293</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner-1294"><a href="#AirlineFlightPlanner-1294"><span class="linenos">1294</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1295"><a href="#AirlineFlightPlanner-1295"><span class="linenos">1295</span></a>
</span><span id="AirlineFlightPlanner-1296"><a href="#AirlineFlightPlanner-1296"><span class="linenos">1296</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1297"><a href="#AirlineFlightPlanner-1297"><span class="linenos">1297</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1298"><a href="#AirlineFlightPlanner-1298"><span class="linenos">1298</span></a>
</span><span id="AirlineFlightPlanner-1299"><a href="#AirlineFlightPlanner-1299"><span class="linenos">1299</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner-1300"><a href="#AirlineFlightPlanner-1300"><span class="linenos">1300</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1301"><a href="#AirlineFlightPlanner-1301"><span class="linenos">1301</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1302"><a href="#AirlineFlightPlanner-1302"><span class="linenos">1302</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1303"><a href="#AirlineFlightPlanner-1303"><span class="linenos">1303</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1304"><a href="#AirlineFlightPlanner-1304"><span class="linenos">1304</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1305"><a href="#AirlineFlightPlanner-1305"><span class="linenos">1305</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1306"><a href="#AirlineFlightPlanner-1306"><span class="linenos">1306</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1307"><a href="#AirlineFlightPlanner-1307"><span class="linenos">1307</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1308"><a href="#AirlineFlightPlanner-1308"><span class="linenos">1308</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1309"><a href="#AirlineFlightPlanner-1309"><span class="linenos">1309</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner-1310"><a href="#AirlineFlightPlanner-1310"><span class="linenos">1310</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1311"><a href="#AirlineFlightPlanner-1311"><span class="linenos">1311</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1312"><a href="#AirlineFlightPlanner-1312"><span class="linenos">1312</span></a>
</span><span id="AirlineFlightPlanner-1313"><a href="#AirlineFlightPlanner-1313"><span class="linenos">1313</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-1314"><a href="#AirlineFlightPlanner-1314"><span class="linenos">1314</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1315"><a href="#AirlineFlightPlanner-1315"><span class="linenos">1315</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1316"><a href="#AirlineFlightPlanner-1316"><span class="linenos">1316</span></a>
</span><span id="AirlineFlightPlanner-1317"><a href="#AirlineFlightPlanner-1317"><span class="linenos">1317</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1318"><a href="#AirlineFlightPlanner-1318"><span class="linenos">1318</span></a>
</span><span id="AirlineFlightPlanner-1319"><a href="#AirlineFlightPlanner-1319"><span class="linenos">1319</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner-1320"><a href="#AirlineFlightPlanner-1320"><span class="linenos">1320</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1321"><a href="#AirlineFlightPlanner-1321"><span class="linenos">1321</span></a>
</span><span id="AirlineFlightPlanner-1322"><a href="#AirlineFlightPlanner-1322"><span class="linenos">1322</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1323"><a href="#AirlineFlightPlanner-1323"><span class="linenos">1323</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1324"><a href="#AirlineFlightPlanner-1324"><span class="linenos">1324</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner-1325"><a href="#AirlineFlightPlanner-1325"><span class="linenos">1325</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner-1326"><a href="#AirlineFlightPlanner-1326"><span class="linenos">1326</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1327"><a href="#AirlineFlightPlanner-1327"><span class="linenos">1327</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1328"><a href="#AirlineFlightPlanner-1328"><span class="linenos">1328</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1329"><a href="#AirlineFlightPlanner-1329"><span class="linenos">1329</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1330"><a href="#AirlineFlightPlanner-1330"><span class="linenos">1330</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1331"><a href="#AirlineFlightPlanner-1331"><span class="linenos">1331</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1332"><a href="#AirlineFlightPlanner-1332"><span class="linenos">1332</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1333"><a href="#AirlineFlightPlanner-1333"><span class="linenos">1333</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1334"><a href="#AirlineFlightPlanner-1334"><span class="linenos">1334</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1335"><a href="#AirlineFlightPlanner-1335"><span class="linenos">1335</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1336"><a href="#AirlineFlightPlanner-1336"><span class="linenos">1336</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1337"><a href="#AirlineFlightPlanner-1337"><span class="linenos">1337</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1338"><a href="#AirlineFlightPlanner-1338"><span class="linenos">1338</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1339"><a href="#AirlineFlightPlanner-1339"><span class="linenos">1339</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1340"><a href="#AirlineFlightPlanner-1340"><span class="linenos">1340</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1341"><a href="#AirlineFlightPlanner-1341"><span class="linenos">1341</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1342"><a href="#AirlineFlightPlanner-1342"><span class="linenos">1342</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1343"><a href="#AirlineFlightPlanner-1343"><span class="linenos">1343</span></a>
</span><span id="AirlineFlightPlanner-1344"><a href="#AirlineFlightPlanner-1344"><span class="linenos">1344</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1345"><a href="#AirlineFlightPlanner-1345"><span class="linenos">1345</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1346"><a href="#AirlineFlightPlanner-1346"><span class="linenos">1346</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1347"><a href="#AirlineFlightPlanner-1347"><span class="linenos">1347</span></a>
</span><span id="AirlineFlightPlanner-1348"><a href="#AirlineFlightPlanner-1348"><span class="linenos">1348</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1349"><a href="#AirlineFlightPlanner-1349"><span class="linenos">1349</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1350"><a href="#AirlineFlightPlanner-1350"><span class="linenos">1350</span></a>
</span><span id="AirlineFlightPlanner-1351"><a href="#AirlineFlightPlanner-1351"><span class="linenos">1351</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner-1352"><a href="#AirlineFlightPlanner-1352"><span class="linenos">1352</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1353"><a href="#AirlineFlightPlanner-1353"><span class="linenos">1353</span></a>
</span><span id="AirlineFlightPlanner-1354"><a href="#AirlineFlightPlanner-1354"><span class="linenos">1354</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-1355"><a href="#AirlineFlightPlanner-1355"><span class="linenos">1355</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1356"><a href="#AirlineFlightPlanner-1356"><span class="linenos">1356</span></a>
</span><span id="AirlineFlightPlanner-1357"><a href="#AirlineFlightPlanner-1357"><span class="linenos">1357</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-1358"><a href="#AirlineFlightPlanner-1358"><span class="linenos">1358</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1359"><a href="#AirlineFlightPlanner-1359"><span class="linenos">1359</span></a>				<span class="c1"># cost_curfew = self.agent.afp.cost_non_pax_curfew(flight_uid_curfew) + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="AirlineFlightPlanner-1360"><a href="#AirlineFlightPlanner-1360"><span class="linenos">1360</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1361"><a href="#AirlineFlightPlanner-1361"><span class="linenos">1361</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1362"><a href="#AirlineFlightPlanner-1362"><span class="linenos">1362</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1363"><a href="#AirlineFlightPlanner-1363"><span class="linenos">1363</span></a>
</span><span id="AirlineFlightPlanner-1364"><a href="#AirlineFlightPlanner-1364"><span class="linenos">1364</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner-1365"><a href="#AirlineFlightPlanner-1365"><span class="linenos">1365</span></a>
</span><span id="AirlineFlightPlanner-1366"><a href="#AirlineFlightPlanner-1366"><span class="linenos">1366</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner-1367"><a href="#AirlineFlightPlanner-1367"><span class="linenos">1367</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1368"><a href="#AirlineFlightPlanner-1368"><span class="linenos">1368</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1369"><a href="#AirlineFlightPlanner-1369"><span class="linenos">1369</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1370"><a href="#AirlineFlightPlanner-1370"><span class="linenos">1370</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1371"><a href="#AirlineFlightPlanner-1371"><span class="linenos">1371</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1372"><a href="#AirlineFlightPlanner-1372"><span class="linenos">1372</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1373"><a href="#AirlineFlightPlanner-1373"><span class="linenos">1373</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1374"><a href="#AirlineFlightPlanner-1374"><span class="linenos">1374</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1375"><a href="#AirlineFlightPlanner-1375"><span class="linenos">1375</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1376"><a href="#AirlineFlightPlanner-1376"><span class="linenos">1376</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1377"><a href="#AirlineFlightPlanner-1377"><span class="linenos">1377</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1378"><a href="#AirlineFlightPlanner-1378"><span class="linenos">1378</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1379"><a href="#AirlineFlightPlanner-1379"><span class="linenos">1379</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1380"><a href="#AirlineFlightPlanner-1380"><span class="linenos">1380</span></a>
</span><span id="AirlineFlightPlanner-1381"><a href="#AirlineFlightPlanner-1381"><span class="linenos">1381</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner-1382"><a href="#AirlineFlightPlanner-1382"><span class="linenos">1382</span></a>
</span><span id="AirlineFlightPlanner-1383"><a href="#AirlineFlightPlanner-1383"><span class="linenos">1383</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-1384"><a href="#AirlineFlightPlanner-1384"><span class="linenos">1384</span></a>
</span><span id="AirlineFlightPlanner-1385"><a href="#AirlineFlightPlanner-1385"><span class="linenos">1385</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1386"><a href="#AirlineFlightPlanner-1386"><span class="linenos">1386</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1387"><a href="#AirlineFlightPlanner-1387"><span class="linenos">1387</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1388"><a href="#AirlineFlightPlanner-1388"><span class="linenos">1388</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1389"><a href="#AirlineFlightPlanner-1389"><span class="linenos">1389</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1390"><a href="#AirlineFlightPlanner-1390"><span class="linenos">1390</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1391"><a href="#AirlineFlightPlanner-1391"><span class="linenos">1391</span></a>
</span><span id="AirlineFlightPlanner-1392"><a href="#AirlineFlightPlanner-1392"><span class="linenos">1392</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-1393"><a href="#AirlineFlightPlanner-1393"><span class="linenos">1393</span></a>
</span><span id="AirlineFlightPlanner-1394"><a href="#AirlineFlightPlanner-1394"><span class="linenos">1394</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1395"><a href="#AirlineFlightPlanner-1395"><span class="linenos">1395</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1396"><a href="#AirlineFlightPlanner-1396"><span class="linenos">1396</span></a><span class="sd">		This is based on build_delay_cost_functions_heuristic</span>
</span><span id="AirlineFlightPlanner-1397"><a href="#AirlineFlightPlanner-1397"><span class="linenos">1397</span></a><span class="sd">		simplified to keep minimum required to compute cost of delay</span>
</span><span id="AirlineFlightPlanner-1398"><a href="#AirlineFlightPlanner-1398"><span class="linenos">1398</span></a><span class="sd">		based on arrival total delay with respect to sibt.</span>
</span><span id="AirlineFlightPlanner-1399"><a href="#AirlineFlightPlanner-1399"><span class="linenos">1399</span></a><span class="sd">		You call the function passing the total delay at arrival.</span>
</span><span id="AirlineFlightPlanner-1400"><a href="#AirlineFlightPlanner-1400"><span class="linenos">1400</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1401"><a href="#AirlineFlightPlanner-1401"><span class="linenos">1401</span></a>
</span><span id="AirlineFlightPlanner-1402"><a href="#AirlineFlightPlanner-1402"><span class="linenos">1402</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner-1403"><a href="#AirlineFlightPlanner-1403"><span class="linenos">1403</span></a>		<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1404"><a href="#AirlineFlightPlanner-1404"><span class="linenos">1404</span></a>
</span><span id="AirlineFlightPlanner-1405"><a href="#AirlineFlightPlanner-1405"><span class="linenos">1405</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1406"><a href="#AirlineFlightPlanner-1406"><span class="linenos">1406</span></a>
</span><span id="AirlineFlightPlanner-1407"><a href="#AirlineFlightPlanner-1407"><span class="linenos">1407</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1408"><a href="#AirlineFlightPlanner-1408"><span class="linenos">1408</span></a>
</span><span id="AirlineFlightPlanner-1409"><a href="#AirlineFlightPlanner-1409"><span class="linenos">1409</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1410"><a href="#AirlineFlightPlanner-1410"><span class="linenos">1410</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1411"><a href="#AirlineFlightPlanner-1411"><span class="linenos">1411</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1412"><a href="#AirlineFlightPlanner-1412"><span class="linenos">1412</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1413"><a href="#AirlineFlightPlanner-1413"><span class="linenos">1413</span></a>
</span><span id="AirlineFlightPlanner-1414"><a href="#AirlineFlightPlanner-1414"><span class="linenos">1414</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_missed_connections&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1415"><a href="#AirlineFlightPlanner-1415"><span class="linenos">1415</span></a>				<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1416"><a href="#AirlineFlightPlanner-1416"><span class="linenos">1416</span></a>					<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner-1417"><a href="#AirlineFlightPlanner-1417"><span class="linenos">1417</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner-1418"><a href="#AirlineFlightPlanner-1418"><span class="linenos">1418</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1419"><a href="#AirlineFlightPlanner-1419"><span class="linenos">1419</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1420"><a href="#AirlineFlightPlanner-1420"><span class="linenos">1420</span></a>					<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1421"><a href="#AirlineFlightPlanner-1421"><span class="linenos">1421</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1422"><a href="#AirlineFlightPlanner-1422"><span class="linenos">1422</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1423"><a href="#AirlineFlightPlanner-1423"><span class="linenos">1423</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1424"><a href="#AirlineFlightPlanner-1424"><span class="linenos">1424</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1425"><a href="#AirlineFlightPlanner-1425"><span class="linenos">1425</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1426"><a href="#AirlineFlightPlanner-1426"><span class="linenos">1426</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1427"><a href="#AirlineFlightPlanner-1427"><span class="linenos">1427</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1428"><a href="#AirlineFlightPlanner-1428"><span class="linenos">1428</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1429"><a href="#AirlineFlightPlanner-1429"><span class="linenos">1429</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1430"><a href="#AirlineFlightPlanner-1430"><span class="linenos">1430</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1431"><a href="#AirlineFlightPlanner-1431"><span class="linenos">1431</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1432"><a href="#AirlineFlightPlanner-1432"><span class="linenos">1432</span></a>
</span><span id="AirlineFlightPlanner-1433"><a href="#AirlineFlightPlanner-1433"><span class="linenos">1433</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest1&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1434"><a href="#AirlineFlightPlanner-1434"><span class="linenos">1434</span></a>				<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1435"><a href="#AirlineFlightPlanner-1435"><span class="linenos">1435</span></a>				<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1436"><a href="#AirlineFlightPlanner-1436"><span class="linenos">1436</span></a>
</span><span id="AirlineFlightPlanner-1437"><a href="#AirlineFlightPlanner-1437"><span class="linenos">1437</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1438"><a href="#AirlineFlightPlanner-1438"><span class="linenos">1438</span></a>				<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-1439"><a href="#AirlineFlightPlanner-1439"><span class="linenos">1439</span></a>				<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1440"><a href="#AirlineFlightPlanner-1440"><span class="linenos">1440</span></a>
</span><span id="AirlineFlightPlanner-1441"><a href="#AirlineFlightPlanner-1441"><span class="linenos">1441</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-1442"><a href="#AirlineFlightPlanner-1442"><span class="linenos">1442</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1443"><a href="#AirlineFlightPlanner-1443"><span class="linenos">1443</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1444"><a href="#AirlineFlightPlanner-1444"><span class="linenos">1444</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1445"><a href="#AirlineFlightPlanner-1445"><span class="linenos">1445</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1446"><a href="#AirlineFlightPlanner-1446"><span class="linenos">1446</span></a>
</span><span id="AirlineFlightPlanner-1447"><a href="#AirlineFlightPlanner-1447"><span class="linenos">1447</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner-1448"><a href="#AirlineFlightPlanner-1448"><span class="linenos">1448</span></a>
</span><span id="AirlineFlightPlanner-1449"><a href="#AirlineFlightPlanner-1449"><span class="linenos">1449</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner-1450"><a href="#AirlineFlightPlanner-1450"><span class="linenos">1450</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1451"><a href="#AirlineFlightPlanner-1451"><span class="linenos">1451</span></a>				<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1452"><a href="#AirlineFlightPlanner-1452"><span class="linenos">1452</span></a>				<span class="n">cost</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1453"><a href="#AirlineFlightPlanner-1453"><span class="linenos">1453</span></a>				<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner-1454"><a href="#AirlineFlightPlanner-1454"><span class="linenos">1454</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1455"><a href="#AirlineFlightPlanner-1455"><span class="linenos">1455</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1456"><a href="#AirlineFlightPlanner-1456"><span class="linenos">1456</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1457"><a href="#AirlineFlightPlanner-1457"><span class="linenos">1457</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1458"><a href="#AirlineFlightPlanner-1458"><span class="linenos">1458</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1459"><a href="#AirlineFlightPlanner-1459"><span class="linenos">1459</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner-1460"><a href="#AirlineFlightPlanner-1460"><span class="linenos">1460</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1461"><a href="#AirlineFlightPlanner-1461"><span class="linenos">1461</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1462"><a href="#AirlineFlightPlanner-1462"><span class="linenos">1462</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1463"><a href="#AirlineFlightPlanner-1463"><span class="linenos">1463</span></a>			<span class="c1"># TODO: this is strange, there should always be at list one flight in this list</span>
</span><span id="AirlineFlightPlanner-1464"><a href="#AirlineFlightPlanner-1464"><span class="linenos">1464</span></a>			<span class="c1"># if len(flights_after)&gt;0:</span>
</span><span id="AirlineFlightPlanner-1465"><a href="#AirlineFlightPlanner-1465"><span class="linenos">1465</span></a>
</span><span id="AirlineFlightPlanner-1466"><a href="#AirlineFlightPlanner-1466"><span class="linenos">1466</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-1467"><a href="#AirlineFlightPlanner-1467"><span class="linenos">1467</span></a>
</span><span id="AirlineFlightPlanner-1468"><a href="#AirlineFlightPlanner-1468"><span class="linenos">1468</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1469"><a href="#AirlineFlightPlanner-1469"><span class="linenos">1469</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1470"><a href="#AirlineFlightPlanner-1470"><span class="linenos">1470</span></a>				<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1471"><a href="#AirlineFlightPlanner-1471"><span class="linenos">1471</span></a>
</span><span id="AirlineFlightPlanner-1472"><a href="#AirlineFlightPlanner-1472"><span class="linenos">1472</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-1473"><a href="#AirlineFlightPlanner-1473"><span class="linenos">1473</span></a>
</span><span id="AirlineFlightPlanner-1474"><a href="#AirlineFlightPlanner-1474"><span class="linenos">1474</span></a>	<span class="k">def</span> <span class="nf">compute_reactionary_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1475"><a href="#AirlineFlightPlanner-1475"><span class="linenos">1475</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1476"><a href="#AirlineFlightPlanner-1476"><span class="linenos">1476</span></a><span class="sd">		Computes all the delays in the next flights of the day</span>
</span><span id="AirlineFlightPlanner-1477"><a href="#AirlineFlightPlanner-1477"><span class="linenos">1477</span></a><span class="sd">		using the same aircraft than flight_uid.</span>
</span><span id="AirlineFlightPlanner-1478"><a href="#AirlineFlightPlanner-1478"><span class="linenos">1478</span></a>
</span><span id="AirlineFlightPlanner-1479"><a href="#AirlineFlightPlanner-1479"><span class="linenos">1479</span></a><span class="sd">		Parameters</span>
</span><span id="AirlineFlightPlanner-1480"><a href="#AirlineFlightPlanner-1480"><span class="linenos">1480</span></a><span class="sd">		==========</span>
</span><span id="AirlineFlightPlanner-1481"><a href="#AirlineFlightPlanner-1481"><span class="linenos">1481</span></a><span class="sd">		flight_uid: int,</span>
</span><span id="AirlineFlightPlanner-1482"><a href="#AirlineFlightPlanner-1482"><span class="linenos">1482</span></a><span class="sd">			uid of the flight having the delay</span>
</span><span id="AirlineFlightPlanner-1483"><a href="#AirlineFlightPlanner-1483"><span class="linenos">1483</span></a><span class="sd">		x: float,</span>
</span><span id="AirlineFlightPlanner-1484"><a href="#AirlineFlightPlanner-1484"><span class="linenos">1484</span></a><span class="sd">			primary delay of the flight flight_uid</span>
</span><span id="AirlineFlightPlanner-1485"><a href="#AirlineFlightPlanner-1485"><span class="linenos">1485</span></a>
</span><span id="AirlineFlightPlanner-1486"><a href="#AirlineFlightPlanner-1486"><span class="linenos">1486</span></a><span class="sd">		Returns</span>
</span><span id="AirlineFlightPlanner-1487"><a href="#AirlineFlightPlanner-1487"><span class="linenos">1487</span></a><span class="sd">		=======</span>
</span><span id="AirlineFlightPlanner-1488"><a href="#AirlineFlightPlanner-1488"><span class="linenos">1488</span></a><span class="sd">		delay: list,</span>
</span><span id="AirlineFlightPlanner-1489"><a href="#AirlineFlightPlanner-1489"><span class="linenos">1489</span></a><span class="sd">			Amount of delay of each flight of the day.</span>
</span><span id="AirlineFlightPlanner-1490"><a href="#AirlineFlightPlanner-1490"><span class="linenos">1490</span></a><span class="sd">			These delay are between 0 (buffers are large enough)</span>
</span><span id="AirlineFlightPlanner-1491"><a href="#AirlineFlightPlanner-1491"><span class="linenos">1491</span></a><span class="sd">			and x (no buffer).</span>
</span><span id="AirlineFlightPlanner-1492"><a href="#AirlineFlightPlanner-1492"><span class="linenos">1492</span></a>
</span><span id="AirlineFlightPlanner-1493"><a href="#AirlineFlightPlanner-1493"><span class="linenos">1493</span></a><span class="sd">		Note: assumes no recovery strategy.</span>
</span><span id="AirlineFlightPlanner-1494"><a href="#AirlineFlightPlanner-1494"><span class="linenos">1494</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1495"><a href="#AirlineFlightPlanner-1495"><span class="linenos">1495</span></a>		<span class="c1"># flights_aircraft = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_queue_uids(include_current_user=True)</span>
</span><span id="AirlineFlightPlanner-1496"><a href="#AirlineFlightPlanner-1496"><span class="linenos">1496</span></a>		<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1497"><a href="#AirlineFlightPlanner-1497"><span class="linenos">1497</span></a>
</span><span id="AirlineFlightPlanner-1498"><a href="#AirlineFlightPlanner-1498"><span class="linenos">1498</span></a>		<span class="c1"># Compute buffers between each pair of flights</span>
</span><span id="AirlineFlightPlanner-1499"><a href="#AirlineFlightPlanner-1499"><span class="linenos">1499</span></a>		<span class="n">buffs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1500"><a href="#AirlineFlightPlanner-1500"><span class="linenos">1500</span></a>							<span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1501"><a href="#AirlineFlightPlanner-1501"><span class="linenos">1501</span></a>								<span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="AirlineFlightPlanner-1502"><a href="#AirlineFlightPlanner-1502"><span class="linenos">1502</span></a>							<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-1503"><a href="#AirlineFlightPlanner-1503"><span class="linenos">1503</span></a>
</span><span id="AirlineFlightPlanner-1504"><a href="#AirlineFlightPlanner-1504"><span class="linenos">1504</span></a>		<span class="n">delays</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-1505"><a href="#AirlineFlightPlanner-1505"><span class="linenos">1505</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffs</span><span class="p">)):</span>
</span><span id="AirlineFlightPlanner-1506"><a href="#AirlineFlightPlanner-1506"><span class="linenos">1506</span></a>			<span class="c1"># delay for each fight is delay of previous minus the buffer.</span>
</span><span id="AirlineFlightPlanner-1507"><a href="#AirlineFlightPlanner-1507"><span class="linenos">1507</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1508"><a href="#AirlineFlightPlanner-1508"><span class="linenos">1508</span></a>				<span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">buffs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1509"><a href="#AirlineFlightPlanner-1509"><span class="linenos">1509</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1510"><a href="#AirlineFlightPlanner-1510"><span class="linenos">1510</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">flights_aircraft</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1511"><a href="#AirlineFlightPlanner-1511"><span class="linenos">1511</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">delays</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1512"><a href="#AirlineFlightPlanner-1512"><span class="linenos">1512</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1513"><a href="#AirlineFlightPlanner-1513"><span class="linenos">1513</span></a>		<span class="k">return</span> <span class="n">delays</span>
</span><span id="AirlineFlightPlanner-1514"><a href="#AirlineFlightPlanner-1514"><span class="linenos">1514</span></a>
</span><span id="AirlineFlightPlanner-1515"><a href="#AirlineFlightPlanner-1515"><span class="linenos">1515</span></a>	<span class="k">def</span> <span class="nf">compute_time_propagate_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1516"><a href="#AirlineFlightPlanner-1516"><span class="linenos">1516</span></a>		<span class="n">next_flights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1517"><a href="#AirlineFlightPlanner-1517"><span class="linenos">1517</span></a>		<span class="n">time_prop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-1518"><a href="#AirlineFlightPlanner-1518"><span class="linenos">1518</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1519"><a href="#AirlineFlightPlanner-1519"><span class="linenos">1519</span></a>			<span class="n">time_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1520"><a href="#AirlineFlightPlanner-1520"><span class="linenos">1520</span></a>		<span class="k">return</span> <span class="n">time_prop</span>
</span><span id="AirlineFlightPlanner-1521"><a href="#AirlineFlightPlanner-1521"><span class="linenos">1521</span></a>
</span><span id="AirlineFlightPlanner-1522"><a href="#AirlineFlightPlanner-1522"><span class="linenos">1522</span></a>	<span class="k">def</span> <span class="nf">return_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1523"><a href="#AirlineFlightPlanner-1523"><span class="linenos">1523</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1524"><a href="#AirlineFlightPlanner-1524"><span class="linenos">1524</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-1525"><a href="#AirlineFlightPlanner-1525"><span class="linenos">1525</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner-1526"><a href="#AirlineFlightPlanner-1526"><span class="linenos">1526</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;propagation_delay_time&#39;</span>
</span><span id="AirlineFlightPlanner-1527"><a href="#AirlineFlightPlanner-1527"><span class="linenos">1527</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_prop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_propagate_delay</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)}</span>
</span><span id="AirlineFlightPlanner-1528"><a href="#AirlineFlightPlanner-1528"><span class="linenos">1528</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1529"><a href="#AirlineFlightPlanner-1529"><span class="linenos">1529</span></a>
</span><span id="AirlineFlightPlanner-1530"><a href="#AirlineFlightPlanner-1530"><span class="linenos">1530</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1531"><a href="#AirlineFlightPlanner-1531"><span class="linenos">1531</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1532"><a href="#AirlineFlightPlanner-1532"><span class="linenos">1532</span></a>
</span><span id="AirlineFlightPlanner-1533"><a href="#AirlineFlightPlanner-1533"><span class="linenos">1533</span></a>	<span class="k">def</span> <span class="nf">compute_cost_delay_function_air</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1534"><a href="#AirlineFlightPlanner-1534"><span class="linenos">1534</span></a>		<span class="c1"># TODO: remove this function?</span>
</span><span id="AirlineFlightPlanner-1535"><a href="#AirlineFlightPlanner-1535"><span class="linenos">1535</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1536"><a href="#AirlineFlightPlanner-1536"><span class="linenos">1536</span></a>
</span><span id="AirlineFlightPlanner-1537"><a href="#AirlineFlightPlanner-1537"><span class="linenos">1537</span></a>	<span class="k">def</span> <span class="nf">return_cost_delay_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1538"><a href="#AirlineFlightPlanner-1538"><span class="linenos">1538</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1539"><a href="#AirlineFlightPlanner-1539"><span class="linenos">1539</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest_uid</span>
</span><span id="AirlineFlightPlanner-1540"><a href="#AirlineFlightPlanner-1540"><span class="linenos">1540</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner-1541"><a href="#AirlineFlightPlanner-1541"><span class="linenos">1541</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_delay_function&#39;</span>
</span><span id="AirlineFlightPlanner-1542"><a href="#AirlineFlightPlanner-1542"><span class="linenos">1542</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_delay_func&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_cost_delay_function_air</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner-1543"><a href="#AirlineFlightPlanner-1543"><span class="linenos">1543</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span><span class="n">flight_uid</span><span class="p">}</span>                        
</span><span id="AirlineFlightPlanner-1544"><a href="#AirlineFlightPlanner-1544"><span class="linenos">1544</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1545"><a href="#AirlineFlightPlanner-1545"><span class="linenos">1545</span></a>
</span><span id="AirlineFlightPlanner-1546"><a href="#AirlineFlightPlanner-1546"><span class="linenos">1546</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1547"><a href="#AirlineFlightPlanner-1547"><span class="linenos">1547</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1548"><a href="#AirlineFlightPlanner-1548"><span class="linenos">1548</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1549"><a href="#AirlineFlightPlanner-1549"><span class="linenos">1549</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1550"><a href="#AirlineFlightPlanner-1550"><span class="linenos">1550</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1551"><a href="#AirlineFlightPlanner-1551"><span class="linenos">1551</span></a>
</span><span id="AirlineFlightPlanner-1552"><a href="#AirlineFlightPlanner-1552"><span class="linenos">1552</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1553"><a href="#AirlineFlightPlanner-1553"><span class="linenos">1553</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1554"><a href="#AirlineFlightPlanner-1554"><span class="linenos">1554</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1555"><a href="#AirlineFlightPlanner-1555"><span class="linenos">1555</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1556"><a href="#AirlineFlightPlanner-1556"><span class="linenos">1556</span></a>
</span><span id="AirlineFlightPlanner-1557"><a href="#AirlineFlightPlanner-1557"><span class="linenos">1557</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_cost_delay_function</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1558"><a href="#AirlineFlightPlanner-1558"><span class="linenos">1558</span></a>
</span><span id="AirlineFlightPlanner-1559"><a href="#AirlineFlightPlanner-1559"><span class="linenos">1559</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_advanced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="AirlineFlightPlanner-1560"><a href="#AirlineFlightPlanner-1560"><span class="linenos">1560</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1561"><a href="#AirlineFlightPlanner-1561"><span class="linenos">1561</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1562"><a href="#AirlineFlightPlanner-1562"><span class="linenos">1562</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner-1563"><a href="#AirlineFlightPlanner-1563"><span class="linenos">1563</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner-1564"><a href="#AirlineFlightPlanner-1564"><span class="linenos">1564</span></a><span class="sd">		available information. It uses explicit information on aircraft</span>
</span><span id="AirlineFlightPlanner-1565"><a href="#AirlineFlightPlanner-1565"><span class="linenos">1565</span></a><span class="sd">		and passenger for knock-on effects.</span>
</span><span id="AirlineFlightPlanner-1566"><a href="#AirlineFlightPlanner-1566"><span class="linenos">1566</span></a>
</span><span id="AirlineFlightPlanner-1567"><a href="#AirlineFlightPlanner-1567"><span class="linenos">1567</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factorbuild_delay_cost_functionsed in already.</span>
</span><span id="AirlineFlightPlanner-1568"><a href="#AirlineFlightPlanner-1568"><span class="linenos">1568</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner-1569"><a href="#AirlineFlightPlanner-1569"><span class="linenos">1569</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner-1570"><a href="#AirlineFlightPlanner-1570"><span class="linenos">1570</span></a>
</span><span id="AirlineFlightPlanner-1571"><a href="#AirlineFlightPlanner-1571"><span class="linenos">1571</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner-1572"><a href="#AirlineFlightPlanner-1572"><span class="linenos">1572</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner-1573"><a href="#AirlineFlightPlanner-1573"><span class="linenos">1573</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner-1574"><a href="#AirlineFlightPlanner-1574"><span class="linenos">1574</span></a>
</span><span id="AirlineFlightPlanner-1575"><a href="#AirlineFlightPlanner-1575"><span class="linenos">1575</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner-1576"><a href="#AirlineFlightPlanner-1576"><span class="linenos">1576</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner-1577"><a href="#AirlineFlightPlanner-1577"><span class="linenos">1577</span></a>
</span><span id="AirlineFlightPlanner-1578"><a href="#AirlineFlightPlanner-1578"><span class="linenos">1578</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner-1579"><a href="#AirlineFlightPlanner-1579"><span class="linenos">1579</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner-1580"><a href="#AirlineFlightPlanner-1580"><span class="linenos">1580</span></a><span class="sd">		Note: this is probably slow.</span>
</span><span id="AirlineFlightPlanner-1581"><a href="#AirlineFlightPlanner-1581"><span class="linenos">1581</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1582"><a href="#AirlineFlightPlanner-1582"><span class="linenos">1582</span></a>
</span><span id="AirlineFlightPlanner-1583"><a href="#AirlineFlightPlanner-1583"><span class="linenos">1583</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1584"><a href="#AirlineFlightPlanner-1584"><span class="linenos">1584</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1585"><a href="#AirlineFlightPlanner-1585"><span class="linenos">1585</span></a>
</span><span id="AirlineFlightPlanner-1586"><a href="#AirlineFlightPlanner-1586"><span class="linenos">1586</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner-1587"><a href="#AirlineFlightPlanner-1587"><span class="linenos">1587</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_building&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1588"><a href="#AirlineFlightPlanner-1588"><span class="linenos">1588</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1589"><a href="#AirlineFlightPlanner-1589"><span class="linenos">1589</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1590"><a href="#AirlineFlightPlanner-1590"><span class="linenos">1590</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1591"><a href="#AirlineFlightPlanner-1591"><span class="linenos">1591</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1592"><a href="#AirlineFlightPlanner-1592"><span class="linenos">1592</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1593"><a href="#AirlineFlightPlanner-1593"><span class="linenos">1593</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1594"><a href="#AirlineFlightPlanner-1594"><span class="linenos">1594</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner-1595"><a href="#AirlineFlightPlanner-1595"><span class="linenos">1595</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1596"><a href="#AirlineFlightPlanner-1596"><span class="linenos">1596</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1597"><a href="#AirlineFlightPlanner-1597"><span class="linenos">1597</span></a>
</span><span id="AirlineFlightPlanner-1598"><a href="#AirlineFlightPlanner-1598"><span class="linenos">1598</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-1599"><a href="#AirlineFlightPlanner-1599"><span class="linenos">1599</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1600"><a href="#AirlineFlightPlanner-1600"><span class="linenos">1600</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner-1601"><a href="#AirlineFlightPlanner-1601"><span class="linenos">1601</span></a>
</span><span id="AirlineFlightPlanner-1602"><a href="#AirlineFlightPlanner-1602"><span class="linenos">1602</span></a>			<span class="c1"># Get all passengers on the flights using in the future using the same aircraft</span>
</span><span id="AirlineFlightPlanner-1603"><a href="#AirlineFlightPlanner-1603"><span class="linenos">1603</span></a>			<span class="c1"># than the current flight.</span>
</span><span id="AirlineFlightPlanner-1604"><a href="#AirlineFlightPlanner-1604"><span class="linenos">1604</span></a>			<span class="c1"># These passengers cannot miss a flight, by definition!</span>
</span><span id="AirlineFlightPlanner-1605"><a href="#AirlineFlightPlanner-1605"><span class="linenos">1605</span></a>			<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1606"><a href="#AirlineFlightPlanner-1606"><span class="linenos">1606</span></a>
</span><span id="AirlineFlightPlanner-1607"><a href="#AirlineFlightPlanner-1607"><span class="linenos">1607</span></a>			<span class="c1"># Rmk: maybe some pax are on different flights...</span>
</span><span id="AirlineFlightPlanner-1608"><a href="#AirlineFlightPlanner-1608"><span class="linenos">1608</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">pax</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flights_aircraft</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1609"><a href="#AirlineFlightPlanner-1609"><span class="linenos">1609</span></a>								<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-1610"><a href="#AirlineFlightPlanner-1610"><span class="linenos">1610</span></a>
</span><span id="AirlineFlightPlanner-1611"><a href="#AirlineFlightPlanner-1611"><span class="linenos">1611</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="AirlineFlightPlanner-1612"><a href="#AirlineFlightPlanner-1612"><span class="linenos">1612</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="AirlineFlightPlanner-1613"><a href="#AirlineFlightPlanner-1613"><span class="linenos">1613</span></a>
</span><span id="AirlineFlightPlanner-1614"><a href="#AirlineFlightPlanner-1614"><span class="linenos">1614</span></a>			<span class="n">from_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1615"><a href="#AirlineFlightPlanner-1615"><span class="linenos">1615</span></a>
</span><span id="AirlineFlightPlanner-1616"><a href="#AirlineFlightPlanner-1616"><span class="linenos">1616</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1617"><a href="#AirlineFlightPlanner-1617"><span class="linenos">1617</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot; Non diff version&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1618"><a href="#AirlineFlightPlanner-1618"><span class="linenos">1618</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1619"><a href="#AirlineFlightPlanner-1619"><span class="linenos">1619</span></a>												<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1620"><a href="#AirlineFlightPlanner-1620"><span class="linenos">1620</span></a>												<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1621"><a href="#AirlineFlightPlanner-1621"><span class="linenos">1621</span></a>			<span class="c1"># Their cost is simply due to delay, taking buffers into account.</span>
</span><span id="AirlineFlightPlanner-1622"><a href="#AirlineFlightPlanner-1622"><span class="linenos">1622</span></a>			<span class="c1"># Assumes paxs can always make it if the aircraft is below its min tat.</span>
</span><span id="AirlineFlightPlanner-1623"><a href="#AirlineFlightPlanner-1623"><span class="linenos">1623</span></a>
</span><span id="AirlineFlightPlanner-1624"><a href="#AirlineFlightPlanner-1624"><span class="linenos">1624</span></a>			<span class="c1"># Compute reactionary delays for all flights of the day</span>
</span><span id="AirlineFlightPlanner-1625"><a href="#AirlineFlightPlanner-1625"><span class="linenos">1625</span></a>			<span class="n">delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reactionary_delays</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1626"><a href="#AirlineFlightPlanner-1626"><span class="linenos">1626</span></a>
</span><span id="AirlineFlightPlanner-1627"><a href="#AirlineFlightPlanner-1627"><span class="linenos">1627</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1628"><a href="#AirlineFlightPlanner-1628"><span class="linenos">1628</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1629"><a href="#AirlineFlightPlanner-1629"><span class="linenos">1629</span></a>
</span><span id="AirlineFlightPlanner-1630"><a href="#AirlineFlightPlanner-1630"><span class="linenos">1630</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner-1631"><a href="#AirlineFlightPlanner-1631"><span class="linenos">1631</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1632"><a href="#AirlineFlightPlanner-1632"><span class="linenos">1632</span></a>
</span><span id="AirlineFlightPlanner-1633"><a href="#AirlineFlightPlanner-1633"><span class="linenos">1633</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-1634"><a href="#AirlineFlightPlanner-1634"><span class="linenos">1634</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1635"><a href="#AirlineFlightPlanner-1635"><span class="linenos">1635</span></a>
</span><span id="AirlineFlightPlanner-1636"><a href="#AirlineFlightPlanner-1636"><span class="linenos">1636</span></a>			<span class="c1"># aprint(&#39;First part of costs in cost function for&#39;, flight_str(flight_uid), &#39;:&#39;, cost_np, cost_soft_cost,</span>
</span><span id="AirlineFlightPlanner-1637"><a href="#AirlineFlightPlanner-1637"><span class="linenos">1637</span></a>			<span class="c1">#         cost_doc, cost_compensation, &#39;(x0+x=&#39;, X, &#39;, number of pax:&#39;, len(paxs), &#39;)&#39;)</span>
</span><span id="AirlineFlightPlanner-1638"><a href="#AirlineFlightPlanner-1638"><span class="linenos">1638</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner-1639"><a href="#AirlineFlightPlanner-1639"><span class="linenos">1639</span></a>
</span><span id="AirlineFlightPlanner-1640"><a href="#AirlineFlightPlanner-1640"><span class="linenos">1640</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="AirlineFlightPlanner-1641"><a href="#AirlineFlightPlanner-1641"><span class="linenos">1641</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="AirlineFlightPlanner-1642"><a href="#AirlineFlightPlanner-1642"><span class="linenos">1642</span></a>
</span><span id="AirlineFlightPlanner-1643"><a href="#AirlineFlightPlanner-1643"><span class="linenos">1643</span></a>			<span class="c1"># Check if pax have a flight after this one</span>
</span><span id="AirlineFlightPlanner-1644"><a href="#AirlineFlightPlanner-1644"><span class="linenos">1644</span></a>			<span class="n">paxs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pax</span><span class="o">.</span><span class="n">is_last_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-1645"><a href="#AirlineFlightPlanner-1645"><span class="linenos">1645</span></a>
</span><span id="AirlineFlightPlanner-1646"><a href="#AirlineFlightPlanner-1646"><span class="linenos">1646</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs2</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1647"><a href="#AirlineFlightPlanner-1647"><span class="linenos">1647</span></a>				<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1648"><a href="#AirlineFlightPlanner-1648"><span class="linenos">1648</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner-1649"><a href="#AirlineFlightPlanner-1649"><span class="linenos">1649</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1650"><a href="#AirlineFlightPlanner-1650"><span class="linenos">1650</span></a>
</span><span id="AirlineFlightPlanner-1651"><a href="#AirlineFlightPlanner-1651"><span class="linenos">1651</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing1&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1652"><a href="#AirlineFlightPlanner-1652"><span class="linenos">1652</span></a>					<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="AirlineFlightPlanner-1653"><a href="#AirlineFlightPlanner-1653"><span class="linenos">1653</span></a>					<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="AirlineFlightPlanner-1654"><a href="#AirlineFlightPlanner-1654"><span class="linenos">1654</span></a>					<span class="c1"># now (like the one it missed).</span>
</span><span id="AirlineFlightPlanner-1655"><a href="#AirlineFlightPlanner-1655"><span class="linenos">1655</span></a>					<span class="c1"># Note: this can include the original flight intented (pax.get_flight_after(flight_uid))</span>
</span><span id="AirlineFlightPlanner-1656"><a href="#AirlineFlightPlanner-1656"><span class="linenos">1656</span></a>					<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1657"><a href="#AirlineFlightPlanner-1657"><span class="linenos">1657</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1658"><a href="#AirlineFlightPlanner-1658"><span class="linenos">1658</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1659"><a href="#AirlineFlightPlanner-1659"><span class="linenos">1659</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1660"><a href="#AirlineFlightPlanner-1660"><span class="linenos">1660</span></a>
</span><span id="AirlineFlightPlanner-1661"><a href="#AirlineFlightPlanner-1661"><span class="linenos">1661</span></a>					<span class="c1"># outbound_flights = [f for f in self.agent.flights_per_origin[from_airport]</span>
</span><span id="AirlineFlightPlanner-1662"><a href="#AirlineFlightPlanner-1662"><span class="linenos">1662</span></a>					<span class="c1">#                             if (self.agent.get_obt(f) &gt; from_time + 1)</span>
</span><span id="AirlineFlightPlanner-1663"><a href="#AirlineFlightPlanner-1663"><span class="linenos">1663</span></a>					<span class="c1">#                                 and self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="AirlineFlightPlanner-1664"><a href="#AirlineFlightPlanner-1664"><span class="linenos">1664</span></a>
</span><span id="AirlineFlightPlanner-1665"><a href="#AirlineFlightPlanner-1665"><span class="linenos">1665</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1666"><a href="#AirlineFlightPlanner-1666"><span class="linenos">1666</span></a>					<span class="c1"># Select direct itineraries</span>
</span><span id="AirlineFlightPlanner-1667"><a href="#AirlineFlightPlanner-1667"><span class="linenos">1667</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="AirlineFlightPlanner-1668"><a href="#AirlineFlightPlanner-1668"><span class="linenos">1668</span></a>													<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1669"><a href="#AirlineFlightPlanner-1669"><span class="linenos">1669</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1670"><a href="#AirlineFlightPlanner-1670"><span class="linenos">1670</span></a>
</span><span id="AirlineFlightPlanner-1671"><a href="#AirlineFlightPlanner-1671"><span class="linenos">1671</span></a>					<span class="c1"># itineraries = [((f, self.agent.uid), ) for f in self.agent.flights_per_destination[pax.destination_uid]</span>
</span><span id="AirlineFlightPlanner-1672"><a href="#AirlineFlightPlanner-1672"><span class="linenos">1672</span></a>					<span class="c1">#                                 if self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="AirlineFlightPlanner-1673"><a href="#AirlineFlightPlanner-1673"><span class="linenos">1673</span></a>
</span><span id="AirlineFlightPlanner-1674"><a href="#AirlineFlightPlanner-1674"><span class="linenos">1674</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing3&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1675"><a href="#AirlineFlightPlanner-1675"><span class="linenos">1675</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1676"><a href="#AirlineFlightPlanner-1676"><span class="linenos">1676</span></a>
</span><span id="AirlineFlightPlanner-1677"><a href="#AirlineFlightPlanner-1677"><span class="linenos">1677</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing4&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1678"><a href="#AirlineFlightPlanner-1678"><span class="linenos">1678</span></a>					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1679"><a href="#AirlineFlightPlanner-1679"><span class="linenos">1679</span></a>						<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1680"><a href="#AirlineFlightPlanner-1680"><span class="linenos">1680</span></a>						<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1681"><a href="#AirlineFlightPlanner-1681"><span class="linenos">1681</span></a>
</span><span id="AirlineFlightPlanner-1682"><a href="#AirlineFlightPlanner-1682"><span class="linenos">1682</span></a>						<span class="n">soft_cost_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-1683"><a href="#AirlineFlightPlanner-1683"><span class="linenos">1683</span></a>						<span class="n">compensation_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-1684"><a href="#AirlineFlightPlanner-1684"><span class="linenos">1684</span></a>						<span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">dt</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">departure_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-1685"><a href="#AirlineFlightPlanner-1685"><span class="linenos">1685</span></a>
</span><span id="AirlineFlightPlanner-1686"><a href="#AirlineFlightPlanner-1686"><span class="linenos">1686</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-1687"><a href="#AirlineFlightPlanner-1687"><span class="linenos">1687</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1688"><a href="#AirlineFlightPlanner-1688"><span class="linenos">1688</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1689"><a href="#AirlineFlightPlanner-1689"><span class="linenos">1689</span></a>
</span><span id="AirlineFlightPlanner-1690"><a href="#AirlineFlightPlanner-1690"><span class="linenos">1690</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-1691"><a href="#AirlineFlightPlanner-1691"><span class="linenos">1691</span></a>
</span><span id="AirlineFlightPlanner-1692"><a href="#AirlineFlightPlanner-1692"><span class="linenos">1692</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1693"><a href="#AirlineFlightPlanner-1693"><span class="linenos">1693</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1694"><a href="#AirlineFlightPlanner-1694"><span class="linenos">1694</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1695"><a href="#AirlineFlightPlanner-1695"><span class="linenos">1695</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1696"><a href="#AirlineFlightPlanner-1696"><span class="linenos">1696</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1697"><a href="#AirlineFlightPlanner-1697"><span class="linenos">1697</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1698"><a href="#AirlineFlightPlanner-1698"><span class="linenos">1698</span></a>
</span><span id="AirlineFlightPlanner-1699"><a href="#AirlineFlightPlanner-1699"><span class="linenos">1699</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-1700"><a href="#AirlineFlightPlanner-1700"><span class="linenos">1700</span></a>
</span><span id="AirlineFlightPlanner-1701"><a href="#AirlineFlightPlanner-1701"><span class="linenos">1701</span></a>	<span class="k">def</span> <span class="nf">decide_options_alternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">current_option</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1702"><a href="#AirlineFlightPlanner-1702"><span class="linenos">1702</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1703"><a href="#AirlineFlightPlanner-1703"><span class="linenos">1703</span></a><span class="sd">		Options is decided based on delay and estimated fuel consumption.</span>
</span><span id="AirlineFlightPlanner-1704"><a href="#AirlineFlightPlanner-1704"><span class="linenos">1704</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1705"><a href="#AirlineFlightPlanner-1705"><span class="linenos">1705</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1706"><a href="#AirlineFlightPlanner-1706"><span class="linenos">1706</span></a>			<span class="c1"># print(&#39;STOP1 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="AirlineFlightPlanner-1707"><a href="#AirlineFlightPlanner-1707"><span class="linenos">1707</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner-1708"><a href="#AirlineFlightPlanner-1708"><span class="linenos">1708</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner-1709"><a href="#AirlineFlightPlanner-1709"><span class="linenos">1709</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-1710"><a href="#AirlineFlightPlanner-1710"><span class="linenos">1710</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-1711"><a href="#AirlineFlightPlanner-1711"><span class="linenos">1711</span></a>		<span class="n">fp_options_orig</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner-1712"><a href="#AirlineFlightPlanner-1712"><span class="linenos">1712</span></a>
</span><span id="AirlineFlightPlanner-1713"><a href="#AirlineFlightPlanner-1713"><span class="linenos">1713</span></a>		<span class="c1"># Keep the following line for tests.</span>
</span><span id="AirlineFlightPlanner-1714"><a href="#AirlineFlightPlanner-1714"><span class="linenos">1714</span></a>		<span class="c1"># cancellation = len(fp_options)==2</span>
</span><span id="AirlineFlightPlanner-1715"><a href="#AirlineFlightPlanner-1715"><span class="linenos">1715</span></a>
</span><span id="AirlineFlightPlanner-1716"><a href="#AirlineFlightPlanner-1716"><span class="linenos">1716</span></a>		<span class="c1"># Keep only fp_options with eibt earlier than the curfew</span>
</span><span id="AirlineFlightPlanner-1717"><a href="#AirlineFlightPlanner-1717"><span class="linenos">1717</span></a>		<span class="n">options_respect_curfew</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">eibt</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1718"><a href="#AirlineFlightPlanner-1718"><span class="linenos">1718</span></a>		<span class="c1"># costs = np.asarray(list(compress(costs, options_respect_curfew)))</span>
</span><span id="AirlineFlightPlanner-1719"><a href="#AirlineFlightPlanner-1719"><span class="linenos">1719</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1720"><a href="#AirlineFlightPlanner-1720"><span class="linenos">1720</span></a>
</span><span id="AirlineFlightPlanner-1721"><a href="#AirlineFlightPlanner-1721"><span class="linenos">1721</span></a>		<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1722"><a href="#AirlineFlightPlanner-1722"><span class="linenos">1722</span></a>			<span class="c1"># Converting current_option to tis new index</span>
</span><span id="AirlineFlightPlanner-1723"><a href="#AirlineFlightPlanner-1723"><span class="linenos">1723</span></a>			<span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fp_options_orig</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner-1724"><a href="#AirlineFlightPlanner-1724"><span class="linenos">1724</span></a>			<span class="n">new_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1725"><a href="#AirlineFlightPlanner-1725"><span class="linenos">1725</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_option</span> <span class="ow">in</span> <span class="n">new_indices</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1726"><a href="#AirlineFlightPlanner-1726"><span class="linenos">1726</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="n">new_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">current_option</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1727"><a href="#AirlineFlightPlanner-1727"><span class="linenos">1727</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1728"><a href="#AirlineFlightPlanner-1728"><span class="linenos">1728</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-1729"><a href="#AirlineFlightPlanner-1729"><span class="linenos">1729</span></a>
</span><span id="AirlineFlightPlanner-1730"><a href="#AirlineFlightPlanner-1730"><span class="linenos">1730</span></a>		<span class="c1"># print(&#39;STOP1.5 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="AirlineFlightPlanner-1731"><a href="#AirlineFlightPlanner-1731"><span class="linenos">1731</span></a>
</span><span id="AirlineFlightPlanner-1732"><a href="#AirlineFlightPlanner-1732"><span class="linenos">1732</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1733"><a href="#AirlineFlightPlanner-1733"><span class="linenos">1733</span></a>			<span class="c1"># There are no options which meet the curfew. Cancel the flight</span>
</span><span id="AirlineFlightPlanner-1734"><a href="#AirlineFlightPlanner-1734"><span class="linenos">1734</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner-1735"><a href="#AirlineFlightPlanner-1735"><span class="linenos">1735</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner-1736"><a href="#AirlineFlightPlanner-1736"><span class="linenos">1736</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;CANCEL_CF&quot;</span>
</span><span id="AirlineFlightPlanner-1737"><a href="#AirlineFlightPlanner-1737"><span class="linenos">1737</span></a>			<span class="c1"># Select as option the one which would arrive earlier to the destination</span>
</span><span id="AirlineFlightPlanner-1738"><a href="#AirlineFlightPlanner-1738"><span class="linenos">1738</span></a>			<span class="n">list_eibt</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">eibt</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fp_options_orig</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1739"><a href="#AirlineFlightPlanner-1739"><span class="linenos">1739</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options_orig</span>
</span><span id="AirlineFlightPlanner-1740"><a href="#AirlineFlightPlanner-1740"><span class="linenos">1740</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="n">list_eibt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">list_eibt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1741"><a href="#AirlineFlightPlanner-1741"><span class="linenos">1741</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1742"><a href="#AirlineFlightPlanner-1742"><span class="linenos">1742</span></a>			<span class="c1"># Estimated fuel consumption</span>
</span><span id="AirlineFlightPlanner-1743"><a href="#AirlineFlightPlanner-1743"><span class="linenos">1743</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">get_estimated_fuel_consumption</span><span class="p">()</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1744"><a href="#AirlineFlightPlanner-1744"><span class="linenos">1744</span></a>
</span><span id="AirlineFlightPlanner-1745"><a href="#AirlineFlightPlanner-1745"><span class="linenos">1745</span></a>			<span class="c1"># CRCO costs</span>
</span><span id="AirlineFlightPlanner-1746"><a href="#AirlineFlightPlanner-1746"><span class="linenos">1746</span></a>			<span class="n">crco_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">crco_cost_EUR</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1747"><a href="#AirlineFlightPlanner-1747"><span class="linenos">1747</span></a>
</span><span id="AirlineFlightPlanner-1748"><a href="#AirlineFlightPlanner-1748"><span class="linenos">1748</span></a>			<span class="c1"># Estimated delay cost</span>
</span><span id="AirlineFlightPlanner-1749"><a href="#AirlineFlightPlanner-1749"><span class="linenos">1749</span></a>			<span class="n">delay_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">average_cost_function</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">())</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1750"><a href="#AirlineFlightPlanner-1750"><span class="linenos">1750</span></a>
</span><span id="AirlineFlightPlanner-1751"><a href="#AirlineFlightPlanner-1751"><span class="linenos">1751</span></a>			<span class="n">costs</span> <span class="o">=</span> <span class="n">fuel_cost</span> <span class="o">+</span> <span class="n">delay_cost</span> <span class="o">+</span> <span class="n">crco_cost</span>
</span><span id="AirlineFlightPlanner-1752"><a href="#AirlineFlightPlanner-1752"><span class="linenos">1752</span></a>
</span><span id="AirlineFlightPlanner-1753"><a href="#AirlineFlightPlanner-1753"><span class="linenos">1753</span></a>			<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_option</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1754"><a href="#AirlineFlightPlanner-1754"><span class="linenos">1754</span></a>				<span class="n">costs</span><span class="p">[</span><span class="n">current_option</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_anchor</span>
</span><span id="AirlineFlightPlanner-1755"><a href="#AirlineFlightPlanner-1755"><span class="linenos">1755</span></a>
</span><span id="AirlineFlightPlanner-1756"><a href="#AirlineFlightPlanner-1756"><span class="linenos">1756</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1757"><a href="#AirlineFlightPlanner-1757"><span class="linenos">1757</span></a>				<span class="c1"># print(&#39;STOP2 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner-1758"><a href="#AirlineFlightPlanner-1758"><span class="linenos">1758</span></a>
</span><span id="AirlineFlightPlanner-1759"><a href="#AirlineFlightPlanner-1759"><span class="linenos">1759</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">),</span> <span class="s1">&#39;options&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1760"><a href="#AirlineFlightPlanner-1760"><span class="linenos">1760</span></a>
</span><span id="AirlineFlightPlanner-1761"><a href="#AirlineFlightPlanner-1761"><span class="linenos">1761</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-1762"><a href="#AirlineFlightPlanner-1762"><span class="linenos">1762</span></a>
</span><span id="AirlineFlightPlanner-1763"><a href="#AirlineFlightPlanner-1763"><span class="linenos">1763</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1764"><a href="#AirlineFlightPlanner-1764"><span class="linenos">1764</span></a>				<span class="c1"># print(&#39;STOP3 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner-1765"><a href="#AirlineFlightPlanner-1765"><span class="linenos">1765</span></a>
</span><span id="AirlineFlightPlanner-1766"><a href="#AirlineFlightPlanner-1766"><span class="linenos">1766</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">:</span> <span class="n">fuel_cost</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1767"><a href="#AirlineFlightPlanner-1767"><span class="linenos">1767</span></a>																				   <span class="s1">&#39;delay_cost&#39;</span><span class="p">:</span> <span class="n">delay_cost</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1768"><a href="#AirlineFlightPlanner-1768"><span class="linenos">1768</span></a>																				   <span class="s1">&#39;crco_cost&#39;</span><span class="p">:</span> <span class="n">crco_cost</span><span class="p">}))</span>
</span><span id="AirlineFlightPlanner-1769"><a href="#AirlineFlightPlanner-1769"><span class="linenos">1769</span></a>
</span><span id="AirlineFlightPlanner-1770"><a href="#AirlineFlightPlanner-1770"><span class="linenos">1770</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1771"><a href="#AirlineFlightPlanner-1771"><span class="linenos">1771</span></a>				<span class="c1"># print(&#39;STOP4 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner-1772"><a href="#AirlineFlightPlanner-1772"><span class="linenos">1772</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1773"><a href="#AirlineFlightPlanner-1773"><span class="linenos">1773</span></a>
</span><span id="AirlineFlightPlanner-1774"><a href="#AirlineFlightPlanner-1774"><span class="linenos">1774</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1775"><a href="#AirlineFlightPlanner-1775"><span class="linenos">1775</span></a>				<span class="k">if</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;submitted&#39;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1776"><a href="#AirlineFlightPlanner-1776"><span class="linenos">1776</span></a>					<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner-1777"><a href="#AirlineFlightPlanner-1777"><span class="linenos">1777</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1778"><a href="#AirlineFlightPlanner-1778"><span class="linenos">1778</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PROBLEM:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1779"><a href="#AirlineFlightPlanner-1779"><span class="linenos">1779</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1780"><a href="#AirlineFlightPlanner-1780"><span class="linenos">1780</span></a>
</span><span id="AirlineFlightPlanner-1781"><a href="#AirlineFlightPlanner-1781"><span class="linenos">1781</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="n">found</span> <span class="ow">or</span> <span class="n">cancellation</span>
</span><span id="AirlineFlightPlanner-1782"><a href="#AirlineFlightPlanner-1782"><span class="linenos">1782</span></a>
</span><span id="AirlineFlightPlanner-1783"><a href="#AirlineFlightPlanner-1783"><span class="linenos">1783</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1784"><a href="#AirlineFlightPlanner-1784"><span class="linenos">1784</span></a>		<span class="c1"># 	print(&#39;STOP5 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner-1785"><a href="#AirlineFlightPlanner-1785"><span class="linenos">1785</span></a>
</span><span id="AirlineFlightPlanner-1786"><a href="#AirlineFlightPlanner-1786"><span class="linenos">1786</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has decided this found:&#39;</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="s1">&#39;cancel:&#39;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1787"><a href="#AirlineFlightPlanner-1787"><span class="linenos">1787</span></a>			   <span class="s1">&#39;option:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1788"><a href="#AirlineFlightPlanner-1788"><span class="linenos">1788</span></a>			   <span class="s1">&#39;reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="s1">&#39;fp_options:&#39;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1789"><a href="#AirlineFlightPlanner-1789"><span class="linenos">1789</span></a>
</span><span id="AirlineFlightPlanner-1790"><a href="#AirlineFlightPlanner-1790"><span class="linenos">1790</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>
</span><span id="AirlineFlightPlanner-1791"><a href="#AirlineFlightPlanner-1791"><span class="linenos">1791</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancellation</span>
</span><span id="AirlineFlightPlanner-1792"><a href="#AirlineFlightPlanner-1792"><span class="linenos">1792</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="AirlineFlightPlanner-1793"><a href="#AirlineFlightPlanner-1793"><span class="linenos">1793</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="AirlineFlightPlanner-1794"><a href="#AirlineFlightPlanner-1794"><span class="linenos">1794</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner-1795"><a href="#AirlineFlightPlanner-1795"><span class="linenos">1795</span></a>
</span><span id="AirlineFlightPlanner-1796"><a href="#AirlineFlightPlanner-1796"><span class="linenos">1796</span></a>	<span class="k">def</span> <span class="nf">get_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1797"><a href="#AirlineFlightPlanner-1797"><span class="linenos">1797</span></a>		<span class="n">received_option_selection_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1798"><a href="#AirlineFlightPlanner-1798"><span class="linenos">1798</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">received_option_selection_message_event</span>
</span><span id="AirlineFlightPlanner-1799"><a href="#AirlineFlightPlanner-1799"><span class="linenos">1799</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_request_select_option</span><span class="p">(</span><span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1800"><a href="#AirlineFlightPlanner-1800"><span class="linenos">1800</span></a>		<span class="k">yield</span> <span class="n">received_option_selection_message_event</span>
</span><span id="AirlineFlightPlanner-1801"><a href="#AirlineFlightPlanner-1801"><span class="linenos">1801</span></a>
</span><span id="AirlineFlightPlanner-1802"><a href="#AirlineFlightPlanner-1802"><span class="linenos">1802</span></a>	<span class="k">def</span> <span class="nf">check_pax_ready_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax_check_event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1803"><a href="#AirlineFlightPlanner-1803"><span class="linenos">1803</span></a>
</span><span id="AirlineFlightPlanner-1804"><a href="#AirlineFlightPlanner-1804"><span class="linenos">1804</span></a>		<span class="k">yield</span> <span class="n">pax_check_event</span>
</span><span id="AirlineFlightPlanner-1805"><a href="#AirlineFlightPlanner-1805"><span class="linenos">1805</span></a>
</span><span id="AirlineFlightPlanner-1806"><a href="#AirlineFlightPlanner-1806"><span class="linenos">1806</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1807"><a href="#AirlineFlightPlanner-1807"><span class="linenos">1807</span></a>		<span class="c1"># 	print(&quot;{} checks  performs check for pax not ready to board flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner-1808"><a href="#AirlineFlightPlanner-1808"><span class="linenos">1808</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs check for pax not ready to board the&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1809"><a href="#AirlineFlightPlanner-1809"><span class="linenos">1809</span></a>
</span><span id="AirlineFlightPlanner-1810"><a href="#AirlineFlightPlanner-1810"><span class="linenos">1810</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1811"><a href="#AirlineFlightPlanner-1811"><span class="linenos">1811</span></a><span class="sd">		Check pax readiness to board, 5 minutes before pushback_ready.</span>
</span><span id="AirlineFlightPlanner-1812"><a href="#AirlineFlightPlanner-1812"><span class="linenos">1812</span></a><span class="sd">		pax_ready_to_board_checklist - list of pax who are estimated to be at the gate in 5min and ready to board</span>
</span><span id="AirlineFlightPlanner-1813"><a href="#AirlineFlightPlanner-1813"><span class="linenos">1813</span></a><span class="sd">		pax_to_wait_checklist - list of pax not est. to be at the gate in time for boarding --&gt; potential wait</span>
</span><span id="AirlineFlightPlanner-1814"><a href="#AirlineFlightPlanner-1814"><span class="linenos">1814</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1815"><a href="#AirlineFlightPlanner-1815"><span class="linenos">1815</span></a>
</span><span id="AirlineFlightPlanner-1816"><a href="#AirlineFlightPlanner-1816"><span class="linenos">1816</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-1817"><a href="#AirlineFlightPlanner-1817"><span class="linenos">1817</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># make sure to perform wait for pax once per flight</span>
</span><span id="AirlineFlightPlanner-1818"><a href="#AirlineFlightPlanner-1818"><span class="linenos">1818</span></a>
</span><span id="AirlineFlightPlanner-1819"><a href="#AirlineFlightPlanner-1819"><span class="linenos">1819</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-1820"><a href="#AirlineFlightPlanner-1820"><span class="linenos">1820</span></a>
</span><span id="AirlineFlightPlanner-1821"><a href="#AirlineFlightPlanner-1821"><span class="linenos">1821</span></a>				<span class="n">previous_flight_idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="AirlineFlightPlanner-1822"><a href="#AirlineFlightPlanner-1822"><span class="linenos">1822</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-1823"><a href="#AirlineFlightPlanner-1823"><span class="linenos">1823</span></a>
</span><span id="AirlineFlightPlanner-1824"><a href="#AirlineFlightPlanner-1824"><span class="linenos">1824</span></a>				<span class="k">if</span> <span class="n">previous_flight_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># pax with no previous flight in their itinerary</span>
</span><span id="AirlineFlightPlanner-1825"><a href="#AirlineFlightPlanner-1825"><span class="linenos">1825</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1826"><a href="#AirlineFlightPlanner-1826"><span class="linenos">1826</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1827"><a href="#AirlineFlightPlanner-1827"><span class="linenos">1827</span></a>
</span><span id="AirlineFlightPlanner-1828"><a href="#AirlineFlightPlanner-1828"><span class="linenos">1828</span></a>				<span class="k">elif</span> <span class="n">previous_flight_idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1829"><a href="#AirlineFlightPlanner-1829"><span class="linenos">1829</span></a>					<span class="c1"># calculate MCT</span>
</span><span id="AirlineFlightPlanner-1830"><a href="#AirlineFlightPlanner-1830"><span class="linenos">1830</span></a>					<span class="n">ft1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1831"><a href="#AirlineFlightPlanner-1831"><span class="linenos">1831</span></a>					<span class="n">ft2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1832"><a href="#AirlineFlightPlanner-1832"><span class="linenos">1832</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">ft2</span>
</span><span id="AirlineFlightPlanner-1833"><a href="#AirlineFlightPlanner-1833"><span class="linenos">1833</span></a>
</span><span id="AirlineFlightPlanner-1834"><a href="#AirlineFlightPlanner-1834"><span class="linenos">1834</span></a>					<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1835"><a href="#AirlineFlightPlanner-1835"><span class="linenos">1835</span></a>					<span class="n">mcts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;mcts&#39;</span><span class="p">][</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1836"><a href="#AirlineFlightPlanner-1836"><span class="linenos">1836</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">mcts</span><span class="p">[(</span><span class="n">ft1</span><span class="p">,</span> <span class="n">ft2</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-1837"><a href="#AirlineFlightPlanner-1837"><span class="linenos">1837</span></a>					<span class="c1"># self.agent.aph.request_connecting_times(pax, (ft1, ft2))</span>
</span><span id="AirlineFlightPlanner-1838"><a href="#AirlineFlightPlanner-1838"><span class="linenos">1838</span></a>
</span><span id="AirlineFlightPlanner-1839"><a href="#AirlineFlightPlanner-1839"><span class="linenos">1839</span></a>					<span class="c1"># check if ft1 is from the same company as ft2 and calc. its in-block time</span>
</span><span id="AirlineFlightPlanner-1840"><a href="#AirlineFlightPlanner-1840"><span class="linenos">1840</span></a>					<span class="c1"># if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="AirlineFlightPlanner-1841"><a href="#AirlineFlightPlanner-1841"><span class="linenos">1841</span></a>					<span class="c1">#     #print(&quot;It&#39;s not the same company.&quot;)</span>
</span><span id="AirlineFlightPlanner-1842"><a href="#AirlineFlightPlanner-1842"><span class="linenos">1842</span></a>					<span class="c1">#     self.send_request_flight_plan(previous_flight)</span>
</span><span id="AirlineFlightPlanner-1843"><a href="#AirlineFlightPlanner-1843"><span class="linenos">1843</span></a>					<span class="c1">#     previous_eibt = self.agent.get_obt(previous_flight) #self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="AirlineFlightPlanner-1844"><a href="#AirlineFlightPlanner-1844"><span class="linenos">1844</span></a>					<span class="c1"># else:</span>
</span><span id="AirlineFlightPlanner-1845"><a href="#AirlineFlightPlanner-1845"><span class="linenos">1845</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1846"><a href="#AirlineFlightPlanner-1846"><span class="linenos">1846</span></a>						<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>  <span class="c1"># self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="AirlineFlightPlanner-1847"><a href="#AirlineFlightPlanner-1847"><span class="linenos">1847</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1848"><a href="#AirlineFlightPlanner-1848"><span class="linenos">1848</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1849"><a href="#AirlineFlightPlanner-1849"><span class="linenos">1849</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1850"><a href="#AirlineFlightPlanner-1850"><span class="linenos">1850</span></a>						<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1851"><a href="#AirlineFlightPlanner-1851"><span class="linenos">1851</span></a>
</span><span id="AirlineFlightPlanner-1852"><a href="#AirlineFlightPlanner-1852"><span class="linenos">1852</span></a>					<span class="k">if</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1853"><a href="#AirlineFlightPlanner-1853"><span class="linenos">1853</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1854"><a href="#AirlineFlightPlanner-1854"><span class="linenos">1854</span></a>
</span><span id="AirlineFlightPlanner-1855"><a href="#AirlineFlightPlanner-1855"><span class="linenos">1855</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1856"><a href="#AirlineFlightPlanner-1856"><span class="linenos">1856</span></a>						<span class="c1"># pax who won&#39;t make it in time</span>
</span><span id="AirlineFlightPlanner-1857"><a href="#AirlineFlightPlanner-1857"><span class="linenos">1857</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1858"><a href="#AirlineFlightPlanner-1858"><span class="linenos">1858</span></a>
</span><span id="AirlineFlightPlanner-1859"><a href="#AirlineFlightPlanner-1859"><span class="linenos">1859</span></a>						<span class="c1"># TESTING</span>
</span><span id="AirlineFlightPlanner-1860"><a href="#AirlineFlightPlanner-1860"><span class="linenos">1860</span></a>						<span class="c1"># print(&quot;This passenger&#39;s connecting time is: &quot;, pax.ct, &quot; and minimum CT is: &quot;, pax.mct)</span>
</span><span id="AirlineFlightPlanner-1861"><a href="#AirlineFlightPlanner-1861"><span class="linenos">1861</span></a>						<span class="c1"># print(&quot;Time now: &quot;, self.agent.env.now)</span>
</span><span id="AirlineFlightPlanner-1862"><a href="#AirlineFlightPlanner-1862"><span class="linenos">1862</span></a>						<span class="c1"># print(&quot;This passenger&#39;s previous flight will land at: &quot;, self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt)</span>
</span><span id="AirlineFlightPlanner-1863"><a href="#AirlineFlightPlanner-1863"><span class="linenos">1863</span></a>						<span class="c1"># print(&quot;Them missing &quot;, pax.pax_type)</span>
</span><span id="AirlineFlightPlanner-1864"><a href="#AirlineFlightPlanner-1864"><span class="linenos">1864</span></a>
</span><span id="AirlineFlightPlanner-1865"><a href="#AirlineFlightPlanner-1865"><span class="linenos">1865</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;The passengers not making their connecting&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; are: &quot;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1866"><a href="#AirlineFlightPlanner-1866"><span class="linenos">1866</span></a>				   <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1867"><a href="#AirlineFlightPlanner-1867"><span class="linenos">1867</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Passengers ready to board&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;are: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1868"><a href="#AirlineFlightPlanner-1868"><span class="linenos">1868</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1869"><a href="#AirlineFlightPlanner-1869"><span class="linenos">1869</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; states there are no missing passengers for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1870"><a href="#AirlineFlightPlanner-1870"><span class="linenos">1870</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1871"><a href="#AirlineFlightPlanner-1871"><span class="linenos">1871</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; asks: Should we wait for missing pax on flight &#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1872"><a href="#AirlineFlightPlanner-1872"><span class="linenos">1872</span></a>
</span><span id="AirlineFlightPlanner-1873"><a href="#AirlineFlightPlanner-1873"><span class="linenos">1873</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">consider_waiting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-1874"><a href="#AirlineFlightPlanner-1874"><span class="linenos">1874</span></a>
</span><span id="AirlineFlightPlanner-1875"><a href="#AirlineFlightPlanner-1875"><span class="linenos">1875</span></a>	<span class="k">def</span> <span class="nf">consider_waiting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1876"><a href="#AirlineFlightPlanner-1876"><span class="linenos">1876</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is considering to wait pax that are up to 15 minutes away.&quot;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1877"><a href="#AirlineFlightPlanner-1877"><span class="linenos">1877</span></a>
</span><span id="AirlineFlightPlanner-1878"><a href="#AirlineFlightPlanner-1878"><span class="linenos">1878</span></a>		<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner-1879"><a href="#AirlineFlightPlanner-1879"><span class="linenos">1879</span></a>		<span class="n">num_missing_pax_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1880"><a href="#AirlineFlightPlanner-1880"><span class="linenos">1880</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1881"><a href="#AirlineFlightPlanner-1881"><span class="linenos">1881</span></a>
</span><span id="AirlineFlightPlanner-1882"><a href="#AirlineFlightPlanner-1882"><span class="linenos">1882</span></a>		<span class="k">if</span> <span class="n">num_missing_pax_groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1883"><a href="#AirlineFlightPlanner-1883"><span class="linenos">1883</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1884"><a href="#AirlineFlightPlanner-1884"><span class="linenos">1884</span></a>				<span class="n">current_eobt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="AirlineFlightPlanner-1885"><a href="#AirlineFlightPlanner-1885"><span class="linenos">1885</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1886"><a href="#AirlineFlightPlanner-1886"><span class="linenos">1886</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1887"><a href="#AirlineFlightPlanner-1887"><span class="linenos">1887</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-1888"><a href="#AirlineFlightPlanner-1888"><span class="linenos">1888</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1889"><a href="#AirlineFlightPlanner-1889"><span class="linenos">1889</span></a>
</span><span id="AirlineFlightPlanner-1890"><a href="#AirlineFlightPlanner-1890"><span class="linenos">1890</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1891"><a href="#AirlineFlightPlanner-1891"><span class="linenos">1891</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-1892"><a href="#AirlineFlightPlanner-1892"><span class="linenos">1892</span></a>				<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1893"><a href="#AirlineFlightPlanner-1893"><span class="linenos">1893</span></a>
</span><span id="AirlineFlightPlanner-1894"><a href="#AirlineFlightPlanner-1894"><span class="linenos">1894</span></a>				<span class="n">pax_delay</span> <span class="o">=</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span>
</span><span id="AirlineFlightPlanner-1895"><a href="#AirlineFlightPlanner-1895"><span class="linenos">1895</span></a>				<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1896"><a href="#AirlineFlightPlanner-1896"><span class="linenos">1896</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax_delay</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">wait_for_passenger_thr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1897"><a href="#AirlineFlightPlanner-1897"><span class="linenos">1897</span></a>					<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>  <span class="c1"># total wait time for this flight</span>
</span><span id="AirlineFlightPlanner-1898"><a href="#AirlineFlightPlanner-1898"><span class="linenos">1898</span></a>
</span><span id="AirlineFlightPlanner-1899"><a href="#AirlineFlightPlanner-1899"><span class="linenos">1899</span></a>			<span class="c1"># for saving</span>
</span><span id="AirlineFlightPlanner-1900"><a href="#AirlineFlightPlanner-1900"><span class="linenos">1900</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1901"><a href="#AirlineFlightPlanner-1901"><span class="linenos">1901</span></a>			<span class="n">wait_time_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1902"><a href="#AirlineFlightPlanner-1902"><span class="linenos">1902</span></a>
</span><span id="AirlineFlightPlanner-1903"><a href="#AirlineFlightPlanner-1903"><span class="linenos">1903</span></a>			<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">wait_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1904"><a href="#AirlineFlightPlanner-1904"><span class="linenos">1904</span></a>
</span><span id="AirlineFlightPlanner-1905"><a href="#AirlineFlightPlanner-1905"><span class="linenos">1905</span></a>			<span class="c1"># delay sobt of flight_uid for wait_time</span>
</span><span id="AirlineFlightPlanner-1906"><a href="#AirlineFlightPlanner-1906"><span class="linenos">1906</span></a>			<span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1907"><a href="#AirlineFlightPlanner-1907"><span class="linenos">1907</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="n">current_eobt</span> <span class="o">+</span> <span class="n">wait_time</span>
</span><span id="AirlineFlightPlanner-1908"><a href="#AirlineFlightPlanner-1908"><span class="linenos">1908</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is requesting departing reassessment in order to wait for pax, wait time: &quot;</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1909"><a href="#AirlineFlightPlanner-1909"><span class="linenos">1909</span></a>
</span><span id="AirlineFlightPlanner-1910"><a href="#AirlineFlightPlanner-1910"><span class="linenos">1910</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-1911"><a href="#AirlineFlightPlanner-1911"><span class="linenos">1911</span></a>				<span class="c1"># 	print(&quot;{} will request a departing reassessment because it considers waiting pax for flight {} (t={})&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner-1912"><a href="#AirlineFlightPlanner-1912"><span class="linenos">1912</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1913"><a href="#AirlineFlightPlanner-1913"><span class="linenos">1913</span></a>
</span><span id="AirlineFlightPlanner-1914"><a href="#AirlineFlightPlanner-1914"><span class="linenos">1914</span></a>				<span class="c1"># EOBT changed: update eobt processes</span>
</span><span id="AirlineFlightPlanner-1915"><a href="#AirlineFlightPlanner-1915"><span class="linenos">1915</span></a>				<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="AirlineFlightPlanner-1916"><a href="#AirlineFlightPlanner-1916"><span class="linenos">1916</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1917"><a href="#AirlineFlightPlanner-1917"><span class="linenos">1917</span></a>			<span class="c1"># for saving</span>
</span><span id="AirlineFlightPlanner-1918"><a href="#AirlineFlightPlanner-1918"><span class="linenos">1918</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner-1919"><a href="#AirlineFlightPlanner-1919"><span class="linenos">1919</span></a>			<span class="n">wait_time_max</span><span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner-1920"><a href="#AirlineFlightPlanner-1920"><span class="linenos">1920</span></a>
</span><span id="AirlineFlightPlanner-1921"><a href="#AirlineFlightPlanner-1921"><span class="linenos">1921</span></a>		<span class="c1"># save the wfp info</span>
</span><span id="AirlineFlightPlanner-1922"><a href="#AirlineFlightPlanner-1922"><span class="linenos">1922</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_missing_pax_groups</span><span class="p">,</span> <span class="n">wait_time_min</span><span class="p">,</span> <span class="n">wait_time_max</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-1923"><a href="#AirlineFlightPlanner-1923"><span class="linenos">1923</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_wfp_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1924"><a href="#AirlineFlightPlanner-1924"><span class="linenos">1924</span></a>
</span><span id="AirlineFlightPlanner-1925"><a href="#AirlineFlightPlanner-1925"><span class="linenos">1925</span></a>	<span class="k">def</span> <span class="nf">save_wfp_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1926"><a href="#AirlineFlightPlanner-1926"><span class="linenos">1926</span></a>		<span class="n">wfp_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_missing_pax_groups&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1927"><a href="#AirlineFlightPlanner-1927"><span class="linenos">1927</span></a>						<span class="s1">&#39;wait_time_min&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1928"><a href="#AirlineFlightPlanner-1928"><span class="linenos">1928</span></a>						<span class="s1">&#39;wait_time_max&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1929"><a href="#AirlineFlightPlanner-1929"><span class="linenos">1929</span></a>						<span class="s1">&#39;wait_time_chosen&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1930"><a href="#AirlineFlightPlanner-1930"><span class="linenos">1930</span></a>						<span class="p">}</span>
</span><span id="AirlineFlightPlanner-1931"><a href="#AirlineFlightPlanner-1931"><span class="linenos">1931</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1932"><a href="#AirlineFlightPlanner-1932"><span class="linenos">1932</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfp_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfp_decision</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1933"><a href="#AirlineFlightPlanner-1933"><span class="linenos">1933</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1934"><a href="#AirlineFlightPlanner-1934"><span class="linenos">1934</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t=</span><span class="si">{}</span><span class="s1">, PROBLEM, FP MISSING FOR FLIGHT </span><span class="si">{}</span><span class="s1"> WITH SOBT: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]))</span>
</span><span id="AirlineFlightPlanner-1935"><a href="#AirlineFlightPlanner-1935"><span class="linenos">1935</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-1936"><a href="#AirlineFlightPlanner-1936"><span class="linenos">1936</span></a>
</span><span id="AirlineFlightPlanner-1937"><a href="#AirlineFlightPlanner-1937"><span class="linenos">1937</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1938"><a href="#AirlineFlightPlanner-1938"><span class="linenos">1938</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1939"><a href="#AirlineFlightPlanner-1939"><span class="linenos">1939</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="AirlineFlightPlanner-1940"><a href="#AirlineFlightPlanner-1940"><span class="linenos">1940</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="AirlineFlightPlanner-1941"><a href="#AirlineFlightPlanner-1941"><span class="linenos">1941</span></a>
</span><span id="AirlineFlightPlanner-1942"><a href="#AirlineFlightPlanner-1942"><span class="linenos">1942</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="AirlineFlightPlanner-1943"><a href="#AirlineFlightPlanner-1943"><span class="linenos">1943</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="AirlineFlightPlanner-1944"><a href="#AirlineFlightPlanner-1944"><span class="linenos">1944</span></a>
</span><span id="AirlineFlightPlanner-1945"><a href="#AirlineFlightPlanner-1945"><span class="linenos">1945</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="AirlineFlightPlanner-1946"><a href="#AirlineFlightPlanner-1946"><span class="linenos">1946</span></a><span class="sd">			- Up to EOBT: I have only potentital cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="AirlineFlightPlanner-1947"><a href="#AirlineFlightPlanner-1947"><span class="linenos">1947</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="AirlineFlightPlanner-1948"><a href="#AirlineFlightPlanner-1948"><span class="linenos">1948</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-1949"><a href="#AirlineFlightPlanner-1949"><span class="linenos">1949</span></a>
</span><span id="AirlineFlightPlanner-1950"><a href="#AirlineFlightPlanner-1950"><span class="linenos">1950</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1951"><a href="#AirlineFlightPlanner-1951"><span class="linenos">1951</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-1952"><a href="#AirlineFlightPlanner-1952"><span class="linenos">1952</span></a>
</span><span id="AirlineFlightPlanner-1953"><a href="#AirlineFlightPlanner-1953"><span class="linenos">1953</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1954"><a href="#AirlineFlightPlanner-1954"><span class="linenos">1954</span></a>
</span><span id="AirlineFlightPlanner-1955"><a href="#AirlineFlightPlanner-1955"><span class="linenos">1955</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-1956"><a href="#AirlineFlightPlanner-1956"><span class="linenos">1956</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1957"><a href="#AirlineFlightPlanner-1957"><span class="linenos">1957</span></a>
</span><span id="AirlineFlightPlanner-1958"><a href="#AirlineFlightPlanner-1958"><span class="linenos">1958</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="AirlineFlightPlanner-1959"><a href="#AirlineFlightPlanner-1959"><span class="linenos">1959</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1960"><a href="#AirlineFlightPlanner-1960"><span class="linenos">1960</span></a>
</span><span id="AirlineFlightPlanner-1961"><a href="#AirlineFlightPlanner-1961"><span class="linenos">1961</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1962"><a href="#AirlineFlightPlanner-1962"><span class="linenos">1962</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1963"><a href="#AirlineFlightPlanner-1963"><span class="linenos">1963</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1964"><a href="#AirlineFlightPlanner-1964"><span class="linenos">1964</span></a>
</span><span id="AirlineFlightPlanner-1965"><a href="#AirlineFlightPlanner-1965"><span class="linenos">1965</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="AirlineFlightPlanner-1966"><a href="#AirlineFlightPlanner-1966"><span class="linenos">1966</span></a>
</span><span id="AirlineFlightPlanner-1967"><a href="#AirlineFlightPlanner-1967"><span class="linenos">1967</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner-1968"><a href="#AirlineFlightPlanner-1968"><span class="linenos">1968</span></a>
</span><span id="AirlineFlightPlanner-1969"><a href="#AirlineFlightPlanner-1969"><span class="linenos">1969</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1970"><a href="#AirlineFlightPlanner-1970"><span class="linenos">1970</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1971"><a href="#AirlineFlightPlanner-1971"><span class="linenos">1971</span></a>
</span><span id="AirlineFlightPlanner-1972"><a href="#AirlineFlightPlanner-1972"><span class="linenos">1972</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1973"><a href="#AirlineFlightPlanner-1973"><span class="linenos">1973</span></a>
</span><span id="AirlineFlightPlanner-1974"><a href="#AirlineFlightPlanner-1974"><span class="linenos">1974</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-1975"><a href="#AirlineFlightPlanner-1975"><span class="linenos">1975</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1976"><a href="#AirlineFlightPlanner-1976"><span class="linenos">1976</span></a>
</span><span id="AirlineFlightPlanner-1977"><a href="#AirlineFlightPlanner-1977"><span class="linenos">1977</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner-1978"><a href="#AirlineFlightPlanner-1978"><span class="linenos">1978</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="AirlineFlightPlanner-1979"><a href="#AirlineFlightPlanner-1979"><span class="linenos">1979</span></a>
</span><span id="AirlineFlightPlanner-1980"><a href="#AirlineFlightPlanner-1980"><span class="linenos">1980</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-1981"><a href="#AirlineFlightPlanner-1981"><span class="linenos">1981</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1982"><a href="#AirlineFlightPlanner-1982"><span class="linenos">1982</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1983"><a href="#AirlineFlightPlanner-1983"><span class="linenos">1983</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1984"><a href="#AirlineFlightPlanner-1984"><span class="linenos">1984</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-1985"><a href="#AirlineFlightPlanner-1985"><span class="linenos">1985</span></a>
</span><span id="AirlineFlightPlanner-1986"><a href="#AirlineFlightPlanner-1986"><span class="linenos">1986</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="AirlineFlightPlanner-1987"><a href="#AirlineFlightPlanner-1987"><span class="linenos">1987</span></a>
</span><span id="AirlineFlightPlanner-1988"><a href="#AirlineFlightPlanner-1988"><span class="linenos">1988</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-1989"><a href="#AirlineFlightPlanner-1989"><span class="linenos">1989</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-1990"><a href="#AirlineFlightPlanner-1990"><span class="linenos">1990</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-1991"><a href="#AirlineFlightPlanner-1991"><span class="linenos">1991</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-1992"><a href="#AirlineFlightPlanner-1992"><span class="linenos">1992</span></a>
</span><span id="AirlineFlightPlanner-1993"><a href="#AirlineFlightPlanner-1993"><span class="linenos">1993</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner-1994"><a href="#AirlineFlightPlanner-1994"><span class="linenos">1994</span></a>
</span><span id="AirlineFlightPlanner-1995"><a href="#AirlineFlightPlanner-1995"><span class="linenos">1995</span></a>				<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-1996"><a href="#AirlineFlightPlanner-1996"><span class="linenos">1996</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-1997"><a href="#AirlineFlightPlanner-1997"><span class="linenos">1997</span></a>
</span><span id="AirlineFlightPlanner-1998"><a href="#AirlineFlightPlanner-1998"><span class="linenos">1998</span></a>				<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner-1999"><a href="#AirlineFlightPlanner-1999"><span class="linenos">1999</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2000"><a href="#AirlineFlightPlanner-2000"><span class="linenos">2000</span></a>
</span><span id="AirlineFlightPlanner-2001"><a href="#AirlineFlightPlanner-2001"><span class="linenos">2001</span></a>				<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-2002"><a href="#AirlineFlightPlanner-2002"><span class="linenos">2002</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2003"><a href="#AirlineFlightPlanner-2003"><span class="linenos">2003</span></a>
</span><span id="AirlineFlightPlanner-2004"><a href="#AirlineFlightPlanner-2004"><span class="linenos">2004</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner-2005"><a href="#AirlineFlightPlanner-2005"><span class="linenos">2005</span></a>				<span class="c1"># cost_transfer0 = 0.</span>
</span><span id="AirlineFlightPlanner-2006"><a href="#AirlineFlightPlanner-2006"><span class="linenos">2006</span></a>
</span><span id="AirlineFlightPlanner-2007"><a href="#AirlineFlightPlanner-2007"><span class="linenos">2007</span></a>				<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-2008"><a href="#AirlineFlightPlanner-2008"><span class="linenos">2008</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2009"><a href="#AirlineFlightPlanner-2009"><span class="linenos">2009</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2010"><a href="#AirlineFlightPlanner-2010"><span class="linenos">2010</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2011"><a href="#AirlineFlightPlanner-2011"><span class="linenos">2011</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-2012"><a href="#AirlineFlightPlanner-2012"><span class="linenos">2012</span></a>
</span><span id="AirlineFlightPlanner-2013"><a href="#AirlineFlightPlanner-2013"><span class="linenos">2013</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="AirlineFlightPlanner-2014"><a href="#AirlineFlightPlanner-2014"><span class="linenos">2014</span></a>
</span><span id="AirlineFlightPlanner-2015"><a href="#AirlineFlightPlanner-2015"><span class="linenos">2015</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="AirlineFlightPlanner-2016"><a href="#AirlineFlightPlanner-2016"><span class="linenos">2016</span></a>
</span><span id="AirlineFlightPlanner-2017"><a href="#AirlineFlightPlanner-2017"><span class="linenos">2017</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2018"><a href="#AirlineFlightPlanner-2018"><span class="linenos">2018</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-2019"><a href="#AirlineFlightPlanner-2019"><span class="linenos">2019</span></a>
</span><span id="AirlineFlightPlanner-2020"><a href="#AirlineFlightPlanner-2020"><span class="linenos">2020</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-2021"><a href="#AirlineFlightPlanner-2021"><span class="linenos">2021</span></a>
</span><span id="AirlineFlightPlanner-2022"><a href="#AirlineFlightPlanner-2022"><span class="linenos">2022</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2023"><a href="#AirlineFlightPlanner-2023"><span class="linenos">2023</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2024"><a href="#AirlineFlightPlanner-2024"><span class="linenos">2024</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="AirlineFlightPlanner-2025"><a href="#AirlineFlightPlanner-2025"><span class="linenos">2025</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="AirlineFlightPlanner-2026"><a href="#AirlineFlightPlanner-2026"><span class="linenos">2026</span></a>
</span><span id="AirlineFlightPlanner-2027"><a href="#AirlineFlightPlanner-2027"><span class="linenos">2027</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="AirlineFlightPlanner-2028"><a href="#AirlineFlightPlanner-2028"><span class="linenos">2028</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="AirlineFlightPlanner-2029"><a href="#AirlineFlightPlanner-2029"><span class="linenos">2029</span></a>
</span><span id="AirlineFlightPlanner-2030"><a href="#AirlineFlightPlanner-2030"><span class="linenos">2030</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="AirlineFlightPlanner-2031"><a href="#AirlineFlightPlanner-2031"><span class="linenos">2031</span></a><span class="sd">			- Up to EOBT: I have only potential cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="AirlineFlightPlanner-2032"><a href="#AirlineFlightPlanner-2032"><span class="linenos">2032</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="AirlineFlightPlanner-2033"><a href="#AirlineFlightPlanner-2033"><span class="linenos">2033</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2034"><a href="#AirlineFlightPlanner-2034"><span class="linenos">2034</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2035"><a href="#AirlineFlightPlanner-2035"><span class="linenos">2035</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner-2036"><a href="#AirlineFlightPlanner-2036"><span class="linenos">2036</span></a>
</span><span id="AirlineFlightPlanner-2037"><a href="#AirlineFlightPlanner-2037"><span class="linenos">2037</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-2038"><a href="#AirlineFlightPlanner-2038"><span class="linenos">2038</span></a>
</span><span id="AirlineFlightPlanner-2039"><a href="#AirlineFlightPlanner-2039"><span class="linenos">2039</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="AirlineFlightPlanner-2040"><a href="#AirlineFlightPlanner-2040"><span class="linenos">2040</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2041"><a href="#AirlineFlightPlanner-2041"><span class="linenos">2041</span></a>
</span><span id="AirlineFlightPlanner-2042"><a href="#AirlineFlightPlanner-2042"><span class="linenos">2042</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="AirlineFlightPlanner-2043"><a href="#AirlineFlightPlanner-2043"><span class="linenos">2043</span></a>
</span><span id="AirlineFlightPlanner-2044"><a href="#AirlineFlightPlanner-2044"><span class="linenos">2044</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2045"><a href="#AirlineFlightPlanner-2045"><span class="linenos">2045</span></a>
</span><span id="AirlineFlightPlanner-2046"><a href="#AirlineFlightPlanner-2046"><span class="linenos">2046</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2047"><a href="#AirlineFlightPlanner-2047"><span class="linenos">2047</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2048"><a href="#AirlineFlightPlanner-2048"><span class="linenos">2048</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2049"><a href="#AirlineFlightPlanner-2049"><span class="linenos">2049</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2050"><a href="#AirlineFlightPlanner-2050"><span class="linenos">2050</span></a>
</span><span id="AirlineFlightPlanner-2051"><a href="#AirlineFlightPlanner-2051"><span class="linenos">2051</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner-2052"><a href="#AirlineFlightPlanner-2052"><span class="linenos">2052</span></a>
</span><span id="AirlineFlightPlanner-2053"><a href="#AirlineFlightPlanner-2053"><span class="linenos">2053</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner-2054"><a href="#AirlineFlightPlanner-2054"><span class="linenos">2054</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2055"><a href="#AirlineFlightPlanner-2055"><span class="linenos">2055</span></a>
</span><span id="AirlineFlightPlanner-2056"><a href="#AirlineFlightPlanner-2056"><span class="linenos">2056</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2057"><a href="#AirlineFlightPlanner-2057"><span class="linenos">2057</span></a>
</span><span id="AirlineFlightPlanner-2058"><a href="#AirlineFlightPlanner-2058"><span class="linenos">2058</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner-2059"><a href="#AirlineFlightPlanner-2059"><span class="linenos">2059</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2060"><a href="#AirlineFlightPlanner-2060"><span class="linenos">2060</span></a>
</span><span id="AirlineFlightPlanner-2061"><a href="#AirlineFlightPlanner-2061"><span class="linenos">2061</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner-2062"><a href="#AirlineFlightPlanner-2062"><span class="linenos">2062</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="AirlineFlightPlanner-2063"><a href="#AirlineFlightPlanner-2063"><span class="linenos">2063</span></a>
</span><span id="AirlineFlightPlanner-2064"><a href="#AirlineFlightPlanner-2064"><span class="linenos">2064</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner-2065"><a href="#AirlineFlightPlanner-2065"><span class="linenos">2065</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2066"><a href="#AirlineFlightPlanner-2066"><span class="linenos">2066</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2067"><a href="#AirlineFlightPlanner-2067"><span class="linenos">2067</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2068"><a href="#AirlineFlightPlanner-2068"><span class="linenos">2068</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner-2069"><a href="#AirlineFlightPlanner-2069"><span class="linenos">2069</span></a>
</span><span id="AirlineFlightPlanner-2070"><a href="#AirlineFlightPlanner-2070"><span class="linenos">2070</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="AirlineFlightPlanner-2071"><a href="#AirlineFlightPlanner-2071"><span class="linenos">2071</span></a>
</span><span id="AirlineFlightPlanner-2072"><a href="#AirlineFlightPlanner-2072"><span class="linenos">2072</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner-2073"><a href="#AirlineFlightPlanner-2073"><span class="linenos">2073</span></a>
</span><span id="AirlineFlightPlanner-2074"><a href="#AirlineFlightPlanner-2074"><span class="linenos">2074</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2075"><a href="#AirlineFlightPlanner-2075"><span class="linenos">2075</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2076"><a href="#AirlineFlightPlanner-2076"><span class="linenos">2076</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2077"><a href="#AirlineFlightPlanner-2077"><span class="linenos">2077</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2078"><a href="#AirlineFlightPlanner-2078"><span class="linenos">2078</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2079"><a href="#AirlineFlightPlanner-2079"><span class="linenos">2079</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2080"><a href="#AirlineFlightPlanner-2080"><span class="linenos">2080</span></a>
</span><span id="AirlineFlightPlanner-2081"><a href="#AirlineFlightPlanner-2081"><span class="linenos">2081</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-2082"><a href="#AirlineFlightPlanner-2082"><span class="linenos">2082</span></a>
</span><span id="AirlineFlightPlanner-2083"><a href="#AirlineFlightPlanner-2083"><span class="linenos">2083</span></a>	<span class="k">def</span> <span class="nf">calculate_missing_pax_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2084"><a href="#AirlineFlightPlanner-2084"><span class="linenos">2084</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># how long needed to wait for all pax in missing_pax</span>
</span><span id="AirlineFlightPlanner-2085"><a href="#AirlineFlightPlanner-2085"><span class="linenos">2085</span></a>
</span><span id="AirlineFlightPlanner-2086"><a href="#AirlineFlightPlanner-2086"><span class="linenos">2086</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2087"><a href="#AirlineFlightPlanner-2087"><span class="linenos">2087</span></a>			<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-2088"><a href="#AirlineFlightPlanner-2088"><span class="linenos">2088</span></a>			<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2089"><a href="#AirlineFlightPlanner-2089"><span class="linenos">2089</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2090"><a href="#AirlineFlightPlanner-2090"><span class="linenos">2090</span></a><span class="sd">			if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="AirlineFlightPlanner-2091"><a href="#AirlineFlightPlanner-2091"><span class="linenos">2091</span></a><span class="sd">				previous_eibt = self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="AirlineFlightPlanner-2092"><a href="#AirlineFlightPlanner-2092"><span class="linenos">2092</span></a><span class="sd">			else:</span>
</span><span id="AirlineFlightPlanner-2093"><a href="#AirlineFlightPlanner-2093"><span class="linenos">2093</span></a><span class="sd">				previous_eibt = self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="AirlineFlightPlanner-2094"><a href="#AirlineFlightPlanner-2094"><span class="linenos">2094</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2095"><a href="#AirlineFlightPlanner-2095"><span class="linenos">2095</span></a>
</span><span id="AirlineFlightPlanner-2096"><a href="#AirlineFlightPlanner-2096"><span class="linenos">2096</span></a>			<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2097"><a href="#AirlineFlightPlanner-2097"><span class="linenos">2097</span></a>
</span><span id="AirlineFlightPlanner-2098"><a href="#AirlineFlightPlanner-2098"><span class="linenos">2098</span></a>		<span class="c1"># tuples of pax groups and their estimated delays (times they need to be waited for)</span>
</span><span id="AirlineFlightPlanner-2099"><a href="#AirlineFlightPlanner-2099"><span class="linenos">2099</span></a>		<span class="n">delayed_pax_groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delays</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner-2100"><a href="#AirlineFlightPlanner-2100"><span class="linenos">2100</span></a>
</span><span id="AirlineFlightPlanner-2101"><a href="#AirlineFlightPlanner-2101"><span class="linenos">2101</span></a>		<span class="c1"># sort from the smallest delay</span>
</span><span id="AirlineFlightPlanner-2102"><a href="#AirlineFlightPlanner-2102"><span class="linenos">2102</span></a>		<span class="n">delayed_pax_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">delayed_pax_groups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2103"><a href="#AirlineFlightPlanner-2103"><span class="linenos">2103</span></a>
</span><span id="AirlineFlightPlanner-2104"><a href="#AirlineFlightPlanner-2104"><span class="linenos">2104</span></a>		<span class="k">return</span> <span class="n">delayed_pax_sorted</span>
</span><span id="AirlineFlightPlanner-2105"><a href="#AirlineFlightPlanner-2105"><span class="linenos">2105</span></a>
</span><span id="AirlineFlightPlanner-2106"><a href="#AirlineFlightPlanner-2106"><span class="linenos">2106</span></a>	<span class="k">def</span> <span class="nf">cost_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2107"><a href="#AirlineFlightPlanner-2107"><span class="linenos">2107</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2108"><a href="#AirlineFlightPlanner-2108"><span class="linenos">2108</span></a><span class="sd">		Cost of waiting for pax group for pax_delay time, i.e. cost of delaying</span>
</span><span id="AirlineFlightPlanner-2109"><a href="#AirlineFlightPlanner-2109"><span class="linenos">2109</span></a><span class="sd">		flight_uid for pax_delay time</span>
</span><span id="AirlineFlightPlanner-2110"><a href="#AirlineFlightPlanner-2110"><span class="linenos">2110</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2111"><a href="#AirlineFlightPlanner-2111"><span class="linenos">2111</span></a>		<span class="n">cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;non_atfm_delay&#39;</span><span class="p">],</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2112"><a href="#AirlineFlightPlanner-2112"><span class="linenos">2112</span></a>
</span><span id="AirlineFlightPlanner-2113"><a href="#AirlineFlightPlanner-2113"><span class="linenos">2113</span></a>		<span class="k">return</span> <span class="n">cost_func</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2114"><a href="#AirlineFlightPlanner-2114"><span class="linenos">2114</span></a>
</span><span id="AirlineFlightPlanner-2115"><a href="#AirlineFlightPlanner-2115"><span class="linenos">2115</span></a>	<span class="k">def</span> <span class="nf">cost_not_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2116"><a href="#AirlineFlightPlanner-2116"><span class="linenos">2116</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2117"><a href="#AirlineFlightPlanner-2117"><span class="linenos">2117</span></a><span class="sd">		Cost of not waiting for pax groups &quot;missing_pax</span>
</span><span id="AirlineFlightPlanner-2118"><a href="#AirlineFlightPlanner-2118"><span class="linenos">2118</span></a>
</span><span id="AirlineFlightPlanner-2119"><a href="#AirlineFlightPlanner-2119"><span class="linenos">2119</span></a><span class="sd">		If I don&#39;t wait for a pax group, I will have to deal with the following potential costs:</span>
</span><span id="AirlineFlightPlanner-2120"><a href="#AirlineFlightPlanner-2120"><span class="linenos">2120</span></a><span class="sd">			- rebooking them (transfer costs) - definitely</span>
</span><span id="AirlineFlightPlanner-2121"><a href="#AirlineFlightPlanner-2121"><span class="linenos">2121</span></a><span class="sd">			- soft costs</span>
</span><span id="AirlineFlightPlanner-2122"><a href="#AirlineFlightPlanner-2122"><span class="linenos">2122</span></a><span class="sd">			- compensation</span>
</span><span id="AirlineFlightPlanner-2123"><a href="#AirlineFlightPlanner-2123"><span class="linenos">2123</span></a><span class="sd">			- duty of care</span>
</span><span id="AirlineFlightPlanner-2124"><a href="#AirlineFlightPlanner-2124"><span class="linenos">2124</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2125"><a href="#AirlineFlightPlanner-2125"><span class="linenos">2125</span></a>
</span><span id="AirlineFlightPlanner-2126"><a href="#AirlineFlightPlanner-2126"><span class="linenos">2126</span></a>		<span class="n">not_wait_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner-2127"><a href="#AirlineFlightPlanner-2127"><span class="linenos">2127</span></a>		<span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2128"><a href="#AirlineFlightPlanner-2128"><span class="linenos">2128</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2129"><a href="#AirlineFlightPlanner-2129"><span class="linenos">2129</span></a>							<span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># DELAY ALREADY ACCOUNTS FOR MCT!!</span>
</span><span id="AirlineFlightPlanner-2130"><a href="#AirlineFlightPlanner-2130"><span class="linenos">2130</span></a>							<span class="n">from_airport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2131"><a href="#AirlineFlightPlanner-2131"><span class="linenos">2131</span></a>
</span><span id="AirlineFlightPlanner-2132"><a href="#AirlineFlightPlanner-2132"><span class="linenos">2132</span></a>			<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2133"><a href="#AirlineFlightPlanner-2133"><span class="linenos">2133</span></a>
</span><span id="AirlineFlightPlanner-2134"><a href="#AirlineFlightPlanner-2134"><span class="linenos">2134</span></a>			<span class="c1"># itineraries_cost_matrix = np.concatenate((soft_cost_pp, transfer_costs_pp, compensation_costs_pp, doc_costs_pp), axis=0)</span>
</span><span id="AirlineFlightPlanner-2135"><a href="#AirlineFlightPlanner-2135"><span class="linenos">2135</span></a>			<span class="c1"># print(&quot;Itineraries costs are: &quot;, soft_cost_pp.shape, transfer_costs_pp.shape, compensation_costs_pp, doc_costs_pp)</span>
</span><span id="AirlineFlightPlanner-2136"><a href="#AirlineFlightPlanner-2136"><span class="linenos">2136</span></a>			<span class="c1"># print(&quot;Itinerary cost matrix is: &quot;, itineraries_cost_matrix)</span>
</span><span id="AirlineFlightPlanner-2137"><a href="#AirlineFlightPlanner-2137"><span class="linenos">2137</span></a>
</span><span id="AirlineFlightPlanner-2138"><a href="#AirlineFlightPlanner-2138"><span class="linenos">2138</span></a>			<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="AirlineFlightPlanner-2139"><a href="#AirlineFlightPlanner-2139"><span class="linenos">2139</span></a>
</span><span id="AirlineFlightPlanner-2140"><a href="#AirlineFlightPlanner-2140"><span class="linenos">2140</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2141"><a href="#AirlineFlightPlanner-2141"><span class="linenos">2141</span></a>				<span class="c1"># print(&quot;Total cost pp is: &quot;, total_cost_pp)</span>
</span><span id="AirlineFlightPlanner-2142"><a href="#AirlineFlightPlanner-2142"><span class="linenos">2142</span></a>				<span class="c1"># print(&quot;Foud reallocation options for &quot;, pax, &quot; are: &quot;, reallocation_options)</span>
</span><span id="AirlineFlightPlanner-2143"><a href="#AirlineFlightPlanner-2143"><span class="linenos">2143</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-2144"><a href="#AirlineFlightPlanner-2144"><span class="linenos">2144</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2145"><a href="#AirlineFlightPlanner-2145"><span class="linenos">2145</span></a>				<span class="c1"># print(&quot;There are no found itineraries. Cost of the overnight stay!&quot;)</span>
</span><span id="AirlineFlightPlanner-2146"><a href="#AirlineFlightPlanner-2146"><span class="linenos">2146</span></a>				<span class="c1"># pax has to be cared for overnight</span>
</span><span id="AirlineFlightPlanner-2147"><a href="#AirlineFlightPlanner-2147"><span class="linenos">2147</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_overnight_care</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner-2148"><a href="#AirlineFlightPlanner-2148"><span class="linenos">2148</span></a>
</span><span id="AirlineFlightPlanner-2149"><a href="#AirlineFlightPlanner-2149"><span class="linenos">2149</span></a>		<span class="k">return</span> <span class="n">not_wait_cost</span>
</span><span id="AirlineFlightPlanner-2150"><a href="#AirlineFlightPlanner-2150"><span class="linenos">2150</span></a>
</span><span id="AirlineFlightPlanner-2151"><a href="#AirlineFlightPlanner-2151"><span class="linenos">2151</span></a>	<span class="k">def</span> <span class="nf">cost_non_pax_curfew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2152"><a href="#AirlineFlightPlanner-2152"><span class="linenos">2152</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2153"><a href="#AirlineFlightPlanner-2153"><span class="linenos">2153</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="AirlineFlightPlanner-2154"><a href="#AirlineFlightPlanner-2154"><span class="linenos">2154</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2155"><a href="#AirlineFlightPlanner-2155"><span class="linenos">2155</span></a>
</span><span id="AirlineFlightPlanner-2156"><a href="#AirlineFlightPlanner-2156"><span class="linenos">2156</span></a>	<span class="k">def</span> <span class="nf">estimate_pax_curfew_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2157"><a href="#AirlineFlightPlanner-2157"><span class="linenos">2157</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2158"><a href="#AirlineFlightPlanner-2158"><span class="linenos">2158</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="AirlineFlightPlanner-2159"><a href="#AirlineFlightPlanner-2159"><span class="linenos">2159</span></a>		<span class="n">dict_estimated_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2160"><a href="#AirlineFlightPlanner-2160"><span class="linenos">2160</span></a>
</span><span id="AirlineFlightPlanner-2161"><a href="#AirlineFlightPlanner-2161"><span class="linenos">2161</span></a>		<span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_duty_of_care&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="AirlineFlightPlanner-2162"><a href="#AirlineFlightPlanner-2162"><span class="linenos">2162</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_soft_cost&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="AirlineFlightPlanner-2163"><a href="#AirlineFlightPlanner-2163"><span class="linenos">2163</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_transfer_cost&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2164"><a href="#AirlineFlightPlanner-2164"><span class="linenos">2164</span></a>						<span class="c1">#avg_compensation_cost</span>
</span><span id="AirlineFlightPlanner-2165"><a href="#AirlineFlightPlanner-2165"><span class="linenos">2165</span></a>
</span><span id="AirlineFlightPlanner-2166"><a href="#AirlineFlightPlanner-2166"><span class="linenos">2166</span></a>		<span class="k">return</span> <span class="n">estimated_cost</span>
</span><span id="AirlineFlightPlanner-2167"><a href="#AirlineFlightPlanner-2167"><span class="linenos">2167</span></a>
</span><span id="AirlineFlightPlanner-2168"><a href="#AirlineFlightPlanner-2168"><span class="linenos">2168</span></a>	<span class="k">def</span> <span class="nf">calculate_overnight_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2169"><a href="#AirlineFlightPlanner-2169"><span class="linenos">2169</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2170"><a href="#AirlineFlightPlanner-2170"><span class="linenos">2170</span></a>
</span><span id="AirlineFlightPlanner-2171"><a href="#AirlineFlightPlanner-2171"><span class="linenos">2171</span></a>		<span class="k">return</span> <span class="n">doc</span>
</span><span id="AirlineFlightPlanner-2172"><a href="#AirlineFlightPlanner-2172"><span class="linenos">2172</span></a>
</span><span id="AirlineFlightPlanner-2173"><a href="#AirlineFlightPlanner-2173"><span class="linenos">2173</span></a>	<span class="nd">@staticmethod</span>
</span><span id="AirlineFlightPlanner-2174"><a href="#AirlineFlightPlanner-2174"><span class="linenos">2174</span></a>	<span class="k">def</span> <span class="nf">plot_wait_pax_costs</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2175"><a href="#AirlineFlightPlanner-2175"><span class="linenos">2175</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">)),</span> <span class="n">wait_costs</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2176"><a href="#AirlineFlightPlanner-2176"><span class="linenos">2176</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost of wait/no-wait options: no-wait + each pax group wait&quot;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2177"><a href="#AirlineFlightPlanner-2177"><span class="linenos">2177</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2178"><a href="#AirlineFlightPlanner-2178"><span class="linenos">2178</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2179"><a href="#AirlineFlightPlanner-2179"><span class="linenos">2179</span></a>
</span><span id="AirlineFlightPlanner-2180"><a href="#AirlineFlightPlanner-2180"><span class="linenos">2180</span></a>	<span class="k">def</span> <span class="nf">reassess_departure_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2181"><a href="#AirlineFlightPlanner-2181"><span class="linenos">2181</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2182"><a href="#AirlineFlightPlanner-2182"><span class="linenos">2182</span></a><span class="sd">		!!!Black magic warning!!!</span>
</span><span id="AirlineFlightPlanner-2183"><a href="#AirlineFlightPlanner-2183"><span class="linenos">2183</span></a>
</span><span id="AirlineFlightPlanner-2184"><a href="#AirlineFlightPlanner-2184"><span class="linenos">2184</span></a><span class="sd">		This function is tricky to understand and should not be changed lightly.</span>
</span><span id="AirlineFlightPlanner-2185"><a href="#AirlineFlightPlanner-2185"><span class="linenos">2185</span></a><span class="sd">		In short, it checks if the ac_ready_time is after the eobt. If not,</span>
</span><span id="AirlineFlightPlanner-2186"><a href="#AirlineFlightPlanner-2186"><span class="linenos">2186</span></a><span class="sd">		the flight tries to pull the eobt as close as possible to the sobt.</span>
</span><span id="AirlineFlightPlanner-2187"><a href="#AirlineFlightPlanner-2187"><span class="linenos">2187</span></a><span class="sd">		If the ac_ready_time is indeed after the eobt, the flight requests</span>
</span><span id="AirlineFlightPlanner-2188"><a href="#AirlineFlightPlanner-2188"><span class="linenos">2188</span></a><span class="sd">		another ATFM slot if missed its own. After it got another slot (or not),</span>
</span><span id="AirlineFlightPlanner-2189"><a href="#AirlineFlightPlanner-2189"><span class="linenos">2189</span></a><span class="sd">		it completely recomputes its options if the delay is big enough (30 minutes),</span>
</span><span id="AirlineFlightPlanner-2190"><a href="#AirlineFlightPlanner-2190"><span class="linenos">2190</span></a><span class="sd">		or just resubmits its delayed flight plan to the NM otherwise.</span>
</span><span id="AirlineFlightPlanner-2191"><a href="#AirlineFlightPlanner-2191"><span class="linenos">2191</span></a>
</span><span id="AirlineFlightPlanner-2192"><a href="#AirlineFlightPlanner-2192"><span class="linenos">2192</span></a><span class="sd">		In any case, if the eobt is changed, the flight plan is resubmitted.</span>
</span><span id="AirlineFlightPlanner-2193"><a href="#AirlineFlightPlanner-2193"><span class="linenos">2193</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner-2194"><a href="#AirlineFlightPlanner-2194"><span class="linenos">2194</span></a>
</span><span id="AirlineFlightPlanner-2195"><a href="#AirlineFlightPlanner-2195"><span class="linenos">2195</span></a>		<span class="n">aoc_flight_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2196"><a href="#AirlineFlightPlanner-2196"><span class="linenos">2196</span></a>		<span class="c1"># try:</span>
</span><span id="AirlineFlightPlanner-2197"><a href="#AirlineFlightPlanner-2197"><span class="linenos">2197</span></a>		<span class="c1"># 	fp = aoc_flight_info[&#39;fp_options&#39;][aoc_flight_info[&#39;fp_option&#39;]]</span>
</span><span id="AirlineFlightPlanner-2198"><a href="#AirlineFlightPlanner-2198"><span class="linenos">2198</span></a>		<span class="c1"># except:</span>
</span><span id="AirlineFlightPlanner-2199"><a href="#AirlineFlightPlanner-2199"><span class="linenos">2199</span></a>		<span class="c1"># 	print(flight_uid)</span>
</span><span id="AirlineFlightPlanner-2200"><a href="#AirlineFlightPlanner-2200"><span class="linenos">2200</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_option&#39;])</span>
</span><span id="AirlineFlightPlanner-2201"><a href="#AirlineFlightPlanner-2201"><span class="linenos">2201</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_options&#39;])</span>
</span><span id="AirlineFlightPlanner-2202"><a href="#AirlineFlightPlanner-2202"><span class="linenos">2202</span></a>		<span class="c1"># 	raise</span>
</span><span id="AirlineFlightPlanner-2203"><a href="#AirlineFlightPlanner-2203"><span class="linenos">2203</span></a>		<span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2204"><a href="#AirlineFlightPlanner-2204"><span class="linenos">2204</span></a>		<span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2205"><a href="#AirlineFlightPlanner-2205"><span class="linenos">2205</span></a>		<span class="n">eobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="AirlineFlightPlanner-2206"><a href="#AirlineFlightPlanner-2206"><span class="linenos">2206</span></a>		<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="AirlineFlightPlanner-2207"><a href="#AirlineFlightPlanner-2207"><span class="linenos">2207</span></a>
</span><span id="AirlineFlightPlanner-2208"><a href="#AirlineFlightPlanner-2208"><span class="linenos">2208</span></a>		<span class="n">reactionary_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ac_ready_at_time</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2209"><a href="#AirlineFlightPlanner-2209"><span class="linenos">2209</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2210"><a href="#AirlineFlightPlanner-2210"><span class="linenos">2210</span></a>		<span class="c1"># 	print(&#39;AOC is reassessing the TAT for {}. Reactionary delay: {}; EOBT {}&#39;.format(flight_uid, reactionary_delay, eobt))</span>
</span><span id="AirlineFlightPlanner-2211"><a href="#AirlineFlightPlanner-2211"><span class="linenos">2211</span></a>
</span><span id="AirlineFlightPlanner-2212"><a href="#AirlineFlightPlanner-2212"><span class="linenos">2212</span></a>		<span class="n">extra_delay</span> <span class="o">=</span> <span class="n">reactionary_delay</span>
</span><span id="AirlineFlightPlanner-2213"><a href="#AirlineFlightPlanner-2213"><span class="linenos">2213</span></a>		<span class="k">if</span> <span class="n">reactionary_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2214"><a href="#AirlineFlightPlanner-2214"><span class="linenos">2214</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2215"><a href="#AirlineFlightPlanner-2215"><span class="linenos">2215</span></a>			<span class="c1"># 	print(&#39;AOC did not find any reactionary delay for flight {} with {}, it will adjust the EOBT and resubmit if needed&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner-2216"><a href="#AirlineFlightPlanner-2216"><span class="linenos">2216</span></a>
</span><span id="AirlineFlightPlanner-2217"><a href="#AirlineFlightPlanner-2217"><span class="linenos">2217</span></a>			<span class="c1"># There is no extra delay, so just update the eobt with the current to do the</span>
</span><span id="AirlineFlightPlanner-2218"><a href="#AirlineFlightPlanner-2218"><span class="linenos">2218</span></a>			<span class="c1"># wait_for_push_back_ready</span>
</span><span id="AirlineFlightPlanner-2219"><a href="#AirlineFlightPlanner-2219"><span class="linenos">2219</span></a>			<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2220"><a href="#AirlineFlightPlanner-2220"><span class="linenos">2220</span></a>				<span class="c1"># Try to bring closer the eobt</span>
</span><span id="AirlineFlightPlanner-2221"><a href="#AirlineFlightPlanner-2221"><span class="linenos">2221</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sobt</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2222"><a href="#AirlineFlightPlanner-2222"><span class="linenos">2222</span></a>
</span><span id="AirlineFlightPlanner-2223"><a href="#AirlineFlightPlanner-2223"><span class="linenos">2223</span></a>				<span class="k">if</span> <span class="n">new_eobt</span><span class="o">!=</span><span class="n">eobt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2224"><a href="#AirlineFlightPlanner-2224"><span class="linenos">2224</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;updates eobt and send a flight plan submission&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2225"><a href="#AirlineFlightPlanner-2225"><span class="linenos">2225</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2226"><a href="#AirlineFlightPlanner-2226"><span class="linenos">2226</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2227"><a href="#AirlineFlightPlanner-2227"><span class="linenos">2227</span></a>					<span class="c1"># 	print(&#39;AOC has updated the EOBT based on the aircraft ready time and is resubmitting the {} for flight {}&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner-2228"><a href="#AirlineFlightPlanner-2228"><span class="linenos">2228</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2229"><a href="#AirlineFlightPlanner-2229"><span class="linenos">2229</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2230"><a href="#AirlineFlightPlanner-2230"><span class="linenos">2230</span></a>					<span class="c1"># This is the only place where &quot;manually&quot; we need to</span>
</span><span id="AirlineFlightPlanner-2231"><a href="#AirlineFlightPlanner-2231"><span class="linenos">2231</span></a>					<span class="c1"># update_eobt_processes as fp is the same (we don&#39;t resubmit it)</span>
</span><span id="AirlineFlightPlanner-2232"><a href="#AirlineFlightPlanner-2232"><span class="linenos">2232</span></a>					<span class="c1"># everywhere else we resubmit the fp and as we &quot;own&quot; the ac</span>
</span><span id="AirlineFlightPlanner-2233"><a href="#AirlineFlightPlanner-2233"><span class="linenos">2233</span></a>					<span class="c1"># that triggers the update_eobt_process via send_flight_plan_submission</span>
</span><span id="AirlineFlightPlanner-2234"><a href="#AirlineFlightPlanner-2234"><span class="linenos">2234</span></a>					<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="AirlineFlightPlanner-2235"><a href="#AirlineFlightPlanner-2235"><span class="linenos">2235</span></a>					<span class="c1"># aprint(flight_str(flight_uid), &#39;does not do anything&#39;)</span>
</span><span id="AirlineFlightPlanner-2236"><a href="#AirlineFlightPlanner-2236"><span class="linenos">2236</span></a>					<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-2237"><a href="#AirlineFlightPlanner-2237"><span class="linenos">2237</span></a>
</span><span id="AirlineFlightPlanner-2238"><a href="#AirlineFlightPlanner-2238"><span class="linenos">2238</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2239"><a href="#AirlineFlightPlanner-2239"><span class="linenos">2239</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2240"><a href="#AirlineFlightPlanner-2240"><span class="linenos">2240</span></a>			<span class="c1"># 	print(&#39;AOC found some reactionary delay for flight {} with {}, it will reassess how bad the situation is&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner-2241"><a href="#AirlineFlightPlanner-2241"><span class="linenos">2241</span></a>
</span><span id="AirlineFlightPlanner-2242"><a href="#AirlineFlightPlanner-2242"><span class="linenos">2242</span></a>			<span class="c1"># There has been an additional delay, reassess where we are.</span>
</span><span id="AirlineFlightPlanner-2243"><a href="#AirlineFlightPlanner-2243"><span class="linenos">2243</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2244"><a href="#AirlineFlightPlanner-2244"><span class="linenos">2244</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has an extra delay of:&#39;</span><span class="p">,</span> <span class="n">extra_delay</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2245"><a href="#AirlineFlightPlanner-2245"><span class="linenos">2245</span></a>						<span class="s1">&#39;and is regulated (missed the ATFM slot)&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2246"><a href="#AirlineFlightPlanner-2246"><span class="linenos">2246</span></a>
</span><span id="AirlineFlightPlanner-2247"><a href="#AirlineFlightPlanner-2247"><span class="linenos">2247</span></a>				<span class="c1"># We missed the ATFM slot</span>
</span><span id="AirlineFlightPlanner-2248"><a href="#AirlineFlightPlanner-2248"><span class="linenos">2248</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2249"><a href="#AirlineFlightPlanner-2249"><span class="linenos">2249</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp.get_unique_id()] = received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner-2250"><a href="#AirlineFlightPlanner-2250"><span class="linenos">2250</span></a>
</span><span id="AirlineFlightPlanner-2251"><a href="#AirlineFlightPlanner-2251"><span class="linenos">2251</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2252"><a href="#AirlineFlightPlanner-2252"><span class="linenos">2252</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2253"><a href="#AirlineFlightPlanner-2253"><span class="linenos">2253</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner-2254"><a href="#AirlineFlightPlanner-2254"><span class="linenos">2254</span></a>
</span><span id="AirlineFlightPlanner-2255"><a href="#AirlineFlightPlanner-2255"><span class="linenos">2255</span></a>				<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="AirlineFlightPlanner-2256"><a href="#AirlineFlightPlanner-2256"><span class="linenos">2256</span></a>
</span><span id="AirlineFlightPlanner-2257"><a href="#AirlineFlightPlanner-2257"><span class="linenos">2257</span></a>				<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2258"><a href="#AirlineFlightPlanner-2258"><span class="linenos">2258</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">cobt</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2259"><a href="#AirlineFlightPlanner-2259"><span class="linenos">2259</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2260"><a href="#AirlineFlightPlanner-2260"><span class="linenos">2260</span></a>					<span class="c1"># This could happen if prevoulsy flight has regulation at airport</span>
</span><span id="AirlineFlightPlanner-2261"><a href="#AirlineFlightPlanner-2261"><span class="linenos">2261</span></a>					<span class="c1"># and not it&#39;s so late that it&#39;s not regulated anymore. cobt will be None</span>
</span><span id="AirlineFlightPlanner-2262"><a href="#AirlineFlightPlanner-2262"><span class="linenos">2262</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner-2263"><a href="#AirlineFlightPlanner-2263"><span class="linenos">2263</span></a>
</span><span id="AirlineFlightPlanner-2264"><a href="#AirlineFlightPlanner-2264"><span class="linenos">2264</span></a>				<span class="c1"># mprint(flight_str(flight_uid), &#39;has an extra delay of:&#39;, extra_delay,</span>
</span><span id="AirlineFlightPlanner-2265"><a href="#AirlineFlightPlanner-2265"><span class="linenos">2265</span></a>				<span class="c1"># 		&#39;and a cobt of&#39;, cobt)</span>
</span><span id="AirlineFlightPlanner-2266"><a href="#AirlineFlightPlanner-2266"><span class="linenos">2266</span></a>
</span><span id="AirlineFlightPlanner-2267"><a href="#AirlineFlightPlanner-2267"><span class="linenos">2267</span></a>			<span class="c1"># Whether or not you got a new slot, you kept it, or you did not have one,</span>
</span><span id="AirlineFlightPlanner-2268"><a href="#AirlineFlightPlanner-2268"><span class="linenos">2268</span></a>			<span class="c1"># you check if the delay is greater than 30. If so, you recompute a completely</span>
</span><span id="AirlineFlightPlanner-2269"><a href="#AirlineFlightPlanner-2269"><span class="linenos">2269</span></a>			<span class="c1"># new FP. Otherwise you just resubmit the same FP with a new eobt.</span>
</span><span id="AirlineFlightPlanner-2270"><a href="#AirlineFlightPlanner-2270"><span class="linenos">2270</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2271"><a href="#AirlineFlightPlanner-2271"><span class="linenos">2271</span></a>			<span class="c1"># print(&#39;IN AOC CHECKING STUFF FOR FLIGHT {} (with ELT {}, extra_delay: {})&#39;.format(flight_uid, fp.get_estimated_landing_time(), extra_delay))</span>
</span><span id="AirlineFlightPlanner-2272"><a href="#AirlineFlightPlanner-2272"><span class="linenos">2272</span></a>			<span class="k">if</span> <span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">min_time_for_FP_recomputation</span><span class="p">:</span>  <span class="c1"># TODO: no need to recompute if not in ATFM regulation, check that...</span>
</span><span id="AirlineFlightPlanner-2273"><a href="#AirlineFlightPlanner-2273"><span class="linenos">2273</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;asks for a recomputation of the FP&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2274"><a href="#AirlineFlightPlanner-2274"><span class="linenos">2274</span></a>
</span><span id="AirlineFlightPlanner-2275"><a href="#AirlineFlightPlanner-2275"><span class="linenos">2275</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2276"><a href="#AirlineFlightPlanner-2276"><span class="linenos">2276</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time and is asking for a complete recomputation of the flight plan for flight {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="AirlineFlightPlanner-2277"><a href="#AirlineFlightPlanner-2277"><span class="linenos">2277</span></a>
</span><span id="AirlineFlightPlanner-2278"><a href="#AirlineFlightPlanner-2278"><span class="linenos">2278</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-2279"><a href="#AirlineFlightPlanner-2279"><span class="linenos">2279</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2280"><a href="#AirlineFlightPlanner-2280"><span class="linenos">2280</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2281"><a href="#AirlineFlightPlanner-2281"><span class="linenos">2281</span></a>				<span class="c1"># PROBLEM: cobt can be before ac_ready_at_time!!!</span>
</span><span id="AirlineFlightPlanner-2282"><a href="#AirlineFlightPlanner-2282"><span class="linenos">2282</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">,</span> <span class="n">eobt</span> <span class="o">+</span> <span class="n">extra_delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2283"><a href="#AirlineFlightPlanner-2283"><span class="linenos">2283</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;sets new eobt of fp to&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;, then resubmit the flight plan&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2284"><a href="#AirlineFlightPlanner-2284"><span class="linenos">2284</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2285"><a href="#AirlineFlightPlanner-2285"><span class="linenos">2285</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time, updated the EOBT and resubmit the same flight plan ({}) for flight {} (new EOBT: {})&#39;.format(fp, flight_uid, new_eobt))</span>
</span><span id="AirlineFlightPlanner-2286"><a href="#AirlineFlightPlanner-2286"><span class="linenos">2286</span></a>
</span><span id="AirlineFlightPlanner-2287"><a href="#AirlineFlightPlanner-2287"><span class="linenos">2287</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2288"><a href="#AirlineFlightPlanner-2288"><span class="linenos">2288</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2289"><a href="#AirlineFlightPlanner-2289"><span class="linenos">2289</span></a>				<span class="c1">#    print(&#39;IN AOC SUBMITTING FLIGHT PLAN FOR FLIGHT 4 {} (with ELT {})&#39;.format(flight_uid, fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner-2290"><a href="#AirlineFlightPlanner-2290"><span class="linenos">2290</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>  <span class="c1"># if missed curfew pick up by NM</span>
</span><span id="AirlineFlightPlanner-2291"><a href="#AirlineFlightPlanner-2291"><span class="linenos">2291</span></a>
</span><span id="AirlineFlightPlanner-2292"><a href="#AirlineFlightPlanner-2292"><span class="linenos">2292</span></a>	<span class="k">def</span> <span class="nf">send_request_select_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2293"><a href="#AirlineFlightPlanner-2293"><span class="linenos">2293</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2294"><a href="#AirlineFlightPlanner-2294"><span class="linenos">2294</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner-2295"><a href="#AirlineFlightPlanner-2295"><span class="linenos">2295</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;select_flight_option_request&#39;</span>
</span><span id="AirlineFlightPlanner-2296"><a href="#AirlineFlightPlanner-2296"><span class="linenos">2296</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_options&#39;</span><span class="p">:</span> <span class="n">cost_options</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2297"><a href="#AirlineFlightPlanner-2297"><span class="linenos">2297</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2298"><a href="#AirlineFlightPlanner-2298"><span class="linenos">2298</span></a>
</span><span id="AirlineFlightPlanner-2299"><a href="#AirlineFlightPlanner-2299"><span class="linenos">2299</span></a>	<span class="k">def</span> <span class="nf">send_ATFM_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2300"><a href="#AirlineFlightPlanner-2300"><span class="linenos">2300</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2301"><a href="#AirlineFlightPlanner-2301"><span class="linenos">2301</span></a>		<span class="c1"># 	print(&#39;send_ATFM_request for {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner-2302"><a href="#AirlineFlightPlanner-2302"><span class="linenos">2302</span></a>
</span><span id="AirlineFlightPlanner-2303"><a href="#AirlineFlightPlanner-2303"><span class="linenos">2303</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2304"><a href="#AirlineFlightPlanner-2304"><span class="linenos">2304</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner-2305"><a href="#AirlineFlightPlanner-2305"><span class="linenos">2305</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ATFM_request&#39;</span>
</span><span id="AirlineFlightPlanner-2306"><a href="#AirlineFlightPlanner-2306"><span class="linenos">2306</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2307"><a href="#AirlineFlightPlanner-2307"><span class="linenos">2307</span></a>						<span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2308"><a href="#AirlineFlightPlanner-2308"><span class="linenos">2308</span></a>
</span><span id="AirlineFlightPlanner-2309"><a href="#AirlineFlightPlanner-2309"><span class="linenos">2309</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2310"><a href="#AirlineFlightPlanner-2310"><span class="linenos">2310</span></a>
</span><span id="AirlineFlightPlanner-2311"><a href="#AirlineFlightPlanner-2311"><span class="linenos">2311</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2312"><a href="#AirlineFlightPlanner-2312"><span class="linenos">2312</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2313"><a href="#AirlineFlightPlanner-2313"><span class="linenos">2313</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-2314"><a href="#AirlineFlightPlanner-2314"><span class="linenos">2314</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_assigned_no_compute&#39;</span>
</span><span id="AirlineFlightPlanner-2315"><a href="#AirlineFlightPlanner-2315"><span class="linenos">2315</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2316"><a href="#AirlineFlightPlanner-2316"><span class="linenos">2316</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2317"><a href="#AirlineFlightPlanner-2317"><span class="linenos">2317</span></a>
</span><span id="AirlineFlightPlanner-2318"><a href="#AirlineFlightPlanner-2318"><span class="linenos">2318</span></a>	<span class="k">def</span> <span class="nf">send_cancellation_flight_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2319"><a href="#AirlineFlightPlanner-2319"><span class="linenos">2319</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2320"><a href="#AirlineFlightPlanner-2320"><span class="linenos">2320</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner-2321"><a href="#AirlineFlightPlanner-2321"><span class="linenos">2321</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_cancellation&#39;</span>
</span><span id="AirlineFlightPlanner-2322"><a href="#AirlineFlightPlanner-2322"><span class="linenos">2322</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2323"><a href="#AirlineFlightPlanner-2323"><span class="linenos">2323</span></a>
</span><span id="AirlineFlightPlanner-2324"><a href="#AirlineFlightPlanner-2324"><span class="linenos">2324</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2325"><a href="#AirlineFlightPlanner-2325"><span class="linenos">2325</span></a>
</span><span id="AirlineFlightPlanner-2326"><a href="#AirlineFlightPlanner-2326"><span class="linenos">2326</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">reception_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2327"><a href="#AirlineFlightPlanner-2327"><span class="linenos">2327</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2328"><a href="#AirlineFlightPlanner-2328"><span class="linenos">2328</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2329"><a href="#AirlineFlightPlanner-2329"><span class="linenos">2329</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner-2330"><a href="#AirlineFlightPlanner-2330"><span class="linenos">2330</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_submission&#39;</span>
</span><span id="AirlineFlightPlanner-2331"><a href="#AirlineFlightPlanner-2331"><span class="linenos">2331</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2332"><a href="#AirlineFlightPlanner-2332"><span class="linenos">2332</span></a>						<span class="s1">&#39;reception_event&#39;</span><span class="p">:</span> <span class="n">reception_event</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2333"><a href="#AirlineFlightPlanner-2333"><span class="linenos">2333</span></a>		<span class="c1"># print(self.agent, &#39;is submitting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="AirlineFlightPlanner-2334"><a href="#AirlineFlightPlanner-2334"><span class="linenos">2334</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2335"><a href="#AirlineFlightPlanner-2335"><span class="linenos">2335</span></a>		<span class="c1">#  	print(&#39;t= {} ; IN AOC SENDING FLIGHT PLAN SUBMISSION FOR {} WITH ELT {} (WITHOUT ATFM DELAY {})&#39;.format(self.agent.env.now,</span>
</span><span id="AirlineFlightPlanner-2336"><a href="#AirlineFlightPlanner-2336"><span class="linenos">2336</span></a>		<span class="c1"># 				flight_uid,</span>
</span><span id="AirlineFlightPlanner-2337"><a href="#AirlineFlightPlanner-2337"><span class="linenos">2337</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="AirlineFlightPlanner-2338"><a href="#AirlineFlightPlanner-2338"><span class="linenos">2338</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_eta_wo_atfm(),</span>
</span><span id="AirlineFlightPlanner-2339"><a href="#AirlineFlightPlanner-2339"><span class="linenos">2339</span></a>		<span class="c1"># 				))</span>
</span><span id="AirlineFlightPlanner-2340"><a href="#AirlineFlightPlanner-2340"><span class="linenos">2340</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2341"><a href="#AirlineFlightPlanner-2341"><span class="linenos">2341</span></a>
</span><span id="AirlineFlightPlanner-2342"><a href="#AirlineFlightPlanner-2342"><span class="linenos">2342</span></a>	<span class="k">def</span> <span class="nf">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2343"><a href="#AirlineFlightPlanner-2343"><span class="linenos">2343</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2344"><a href="#AirlineFlightPlanner-2344"><span class="linenos">2344</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-2345"><a href="#AirlineFlightPlanner-2345"><span class="linenos">2345</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_update&#39;</span>
</span><span id="AirlineFlightPlanner-2346"><a href="#AirlineFlightPlanner-2346"><span class="linenos">2346</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2347"><a href="#AirlineFlightPlanner-2347"><span class="linenos">2347</span></a>
</span><span id="AirlineFlightPlanner-2348"><a href="#AirlineFlightPlanner-2348"><span class="linenos">2348</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2349"><a href="#AirlineFlightPlanner-2349"><span class="linenos">2349</span></a>
</span><span id="AirlineFlightPlanner-2350"><a href="#AirlineFlightPlanner-2350"><span class="linenos">2350</span></a>	<span class="k">def</span> <span class="nf">send_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2351"><a href="#AirlineFlightPlanner-2351"><span class="linenos">2351</span></a>		<span class="c1"># This is an intra-agent message, so we use direct memory access</span>
</span><span id="AirlineFlightPlanner-2352"><a href="#AirlineFlightPlanner-2352"><span class="linenos">2352</span></a>		<span class="c1"># for optimsation.</span>
</span><span id="AirlineFlightPlanner-2353"><a href="#AirlineFlightPlanner-2353"><span class="linenos">2353</span></a>
</span><span id="AirlineFlightPlanner-2354"><a href="#AirlineFlightPlanner-2354"><span class="linenos">2354</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2355"><a href="#AirlineFlightPlanner-2355"><span class="linenos">2355</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner-2356"><a href="#AirlineFlightPlanner-2356"><span class="linenos">2356</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner-2357"><a href="#AirlineFlightPlanner-2357"><span class="linenos">2357</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="AirlineFlightPlanner-2358"><a href="#AirlineFlightPlanner-2358"><span class="linenos">2358</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2359"><a href="#AirlineFlightPlanner-2359"><span class="linenos">2359</span></a>
</span><span id="AirlineFlightPlanner-2360"><a href="#AirlineFlightPlanner-2360"><span class="linenos">2360</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(AFP role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2361"><a href="#AirlineFlightPlanner-2361"><span class="linenos">2361</span></a>
</span><span id="AirlineFlightPlanner-2362"><a href="#AirlineFlightPlanner-2362"><span class="linenos">2362</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2363"><a href="#AirlineFlightPlanner-2363"><span class="linenos">2363</span></a>
</span><span id="AirlineFlightPlanner-2364"><a href="#AirlineFlightPlanner-2364"><span class="linenos">2364</span></a>		<span class="c1"># self.send(msg) # uncomment this to use the messaging server</span>
</span><span id="AirlineFlightPlanner-2365"><a href="#AirlineFlightPlanner-2365"><span class="linenos">2365</span></a>
</span><span id="AirlineFlightPlanner-2366"><a href="#AirlineFlightPlanner-2366"><span class="linenos">2366</span></a>	<span class="k">def</span> <span class="nf">update_eobt_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2367"><a href="#AirlineFlightPlanner-2367"><span class="linenos">2367</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;EOBT update for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;(new_eobt:&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2368"><a href="#AirlineFlightPlanner-2368"><span class="linenos">2368</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2369"><a href="#AirlineFlightPlanner-2369"><span class="linenos">2369</span></a>		<span class="c1"># 	print(&quot;{} updates EOBT for flight {} (new_eobt: {})&quot;.format(self.agent, flight_uid, new_eobt))</span>
</span><span id="AirlineFlightPlanner-2370"><a href="#AirlineFlightPlanner-2370"><span class="linenos">2370</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2371"><a href="#AirlineFlightPlanner-2371"><span class="linenos">2371</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2372"><a href="#AirlineFlightPlanner-2372"><span class="linenos">2372</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2373"><a href="#AirlineFlightPlanner-2373"><span class="linenos">2373</span></a>
</span><span id="AirlineFlightPlanner-2374"><a href="#AirlineFlightPlanner-2374"><span class="linenos">2374</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2375"><a href="#AirlineFlightPlanner-2375"><span class="linenos">2375</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2376"><a href="#AirlineFlightPlanner-2376"><span class="linenos">2376</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2377"><a href="#AirlineFlightPlanner-2377"><span class="linenos">2377</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2378"><a href="#AirlineFlightPlanner-2378"><span class="linenos">2378</span></a>			<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2379"><a href="#AirlineFlightPlanner-2379"><span class="linenos">2379</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Delay estimation process has already been terminated, cannot interrupt it.&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2380"><a href="#AirlineFlightPlanner-2380"><span class="linenos">2380</span></a>				<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-2381"><a href="#AirlineFlightPlanner-2381"><span class="linenos">2381</span></a>
</span><span id="AirlineFlightPlanner-2382"><a href="#AirlineFlightPlanner-2382"><span class="linenos">2382</span></a>		<span class="c1"># Check if aircraft is already available for the flight</span>
</span><span id="AirlineFlightPlanner-2383"><a href="#AirlineFlightPlanner-2383"><span class="linenos">2383</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2384"><a href="#AirlineFlightPlanner-2384"><span class="linenos">2384</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2385"><a href="#AirlineFlightPlanner-2385"><span class="linenos">2385</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2386"><a href="#AirlineFlightPlanner-2386"><span class="linenos">2386</span></a>
</span><span id="AirlineFlightPlanner-2387"><a href="#AirlineFlightPlanner-2387"><span class="linenos">2387</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2388"><a href="#AirlineFlightPlanner-2388"><span class="linenos">2388</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2389"><a href="#AirlineFlightPlanner-2389"><span class="linenos">2389</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2390"><a href="#AirlineFlightPlanner-2390"><span class="linenos">2390</span></a>
</span><span id="AirlineFlightPlanner-2391"><a href="#AirlineFlightPlanner-2391"><span class="linenos">2391</span></a>	<span class="k">def</span> <span class="nf">wait_for_atfm_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2392"><a href="#AirlineFlightPlanner-2392"><span class="linenos">2392</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-2393"><a href="#AirlineFlightPlanner-2393"><span class="linenos">2393</span></a>		<span class="k">if</span> <span class="s1">&#39;fp_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-2394"><a href="#AirlineFlightPlanner-2394"><span class="linenos">2394</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;fp_uid&#39;</span><span class="p">]]</span>
</span><span id="AirlineFlightPlanner-2395"><a href="#AirlineFlightPlanner-2395"><span class="linenos">2395</span></a>		<span class="k">elif</span> <span class="s1">&#39;flight_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-2396"><a href="#AirlineFlightPlanner-2396"><span class="linenos">2396</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2397"><a href="#AirlineFlightPlanner-2397"><span class="linenos">2397</span></a>
</span><span id="AirlineFlightPlanner-2398"><a href="#AirlineFlightPlanner-2398"><span class="linenos">2398</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2399"><a href="#AirlineFlightPlanner-2399"><span class="linenos">2399</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner-2400"><a href="#AirlineFlightPlanner-2400"><span class="linenos">2400</span></a>
</span><span id="AirlineFlightPlanner-2401"><a href="#AirlineFlightPlanner-2401"><span class="linenos">2401</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">set_atfm_delay</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2402"><a href="#AirlineFlightPlanner-2402"><span class="linenos">2402</span></a>
</span><span id="AirlineFlightPlanner-2403"><a href="#AirlineFlightPlanner-2403"><span class="linenos">2403</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2404"><a href="#AirlineFlightPlanner-2404"><span class="linenos">2404</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 2 {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner-2405"><a href="#AirlineFlightPlanner-2405"><span class="linenos">2405</span></a>
</span><span id="AirlineFlightPlanner-2406"><a href="#AirlineFlightPlanner-2406"><span class="linenos">2406</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2407"><a href="#AirlineFlightPlanner-2407"><span class="linenos">2407</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2408"><a href="#AirlineFlightPlanner-2408"><span class="linenos">2408</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2409"><a href="#AirlineFlightPlanner-2409"><span class="linenos">2409</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2410"><a href="#AirlineFlightPlanner-2410"><span class="linenos">2410</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2411"><a href="#AirlineFlightPlanner-2411"><span class="linenos">2411</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2412"><a href="#AirlineFlightPlanner-2412"><span class="linenos">2412</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2413"><a href="#AirlineFlightPlanner-2413"><span class="linenos">2413</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">regulation</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2414"><a href="#AirlineFlightPlanner-2414"><span class="linenos">2414</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">excempt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2415"><a href="#AirlineFlightPlanner-2415"><span class="linenos">2415</span></a>
</span><span id="AirlineFlightPlanner-2416"><a href="#AirlineFlightPlanner-2416"><span class="linenos">2416</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2417"><a href="#AirlineFlightPlanner-2417"><span class="linenos">2417</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 3 {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner-2418"><a href="#AirlineFlightPlanner-2418"><span class="linenos">2418</span></a>
</span><span id="AirlineFlightPlanner-2419"><a href="#AirlineFlightPlanner-2419"><span class="linenos">2419</span></a>		<span class="k">if</span> <span class="s1">&#39;event&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner-2420"><a href="#AirlineFlightPlanner-2420"><span class="linenos">2420</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2421"><a href="#AirlineFlightPlanner-2421"><span class="linenos">2421</span></a>
</span><span id="AirlineFlightPlanner-2422"><a href="#AirlineFlightPlanner-2422"><span class="linenos">2422</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2423"><a href="#AirlineFlightPlanner-2423"><span class="linenos">2423</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 4 {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner-2424"><a href="#AirlineFlightPlanner-2424"><span class="linenos">2424</span></a>
</span><span id="AirlineFlightPlanner-2425"><a href="#AirlineFlightPlanner-2425"><span class="linenos">2425</span></a>	<span class="k">def</span> <span class="nf">wait_for_FP_acceptance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2426"><a href="#AirlineFlightPlanner-2426"><span class="linenos">2426</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-2427"><a href="#AirlineFlightPlanner-2427"><span class="linenos">2427</span></a>
</span><span id="AirlineFlightPlanner-2428"><a href="#AirlineFlightPlanner-2428"><span class="linenos">2428</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2429"><a href="#AirlineFlightPlanner-2429"><span class="linenos">2429</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2430"><a href="#AirlineFlightPlanner-2430"><span class="linenos">2430</span></a>
</span><span id="AirlineFlightPlanner-2431"><a href="#AirlineFlightPlanner-2431"><span class="linenos">2431</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-2432"><a href="#AirlineFlightPlanner-2432"><span class="linenos">2432</span></a>
</span><span id="AirlineFlightPlanner-2433"><a href="#AirlineFlightPlanner-2433"><span class="linenos">2433</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight plan&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">],</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has been accepted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2434"><a href="#AirlineFlightPlanner-2434"><span class="linenos">2434</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s2">&quot;Flight plan aoc thinks FP for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2435"><a href="#AirlineFlightPlanner-2435"><span class="linenos">2435</span></a>
</span><span id="AirlineFlightPlanner-2436"><a href="#AirlineFlightPlanner-2436"><span class="linenos">2436</span></a>			<span class="c1"># Clean other FP data in case they are re-used in the future</span>
</span><span id="AirlineFlightPlanner-2437"><a href="#AirlineFlightPlanner-2437"><span class="linenos">2437</span></a>			<span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner-2438"><a href="#AirlineFlightPlanner-2438"><span class="linenos">2438</span></a>				<span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique_id</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2439"><a href="#AirlineFlightPlanner-2439"><span class="linenos">2439</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;non-submitted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2440"><a href="#AirlineFlightPlanner-2440"><span class="linenos">2440</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">atfm_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-2441"><a href="#AirlineFlightPlanner-2441"><span class="linenos">2441</span></a>
</span><span id="AirlineFlightPlanner-2442"><a href="#AirlineFlightPlanner-2442"><span class="linenos">2442</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2443"><a href="#AirlineFlightPlanner-2443"><span class="linenos">2443</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
</span><span id="AirlineFlightPlanner-2444"><a href="#AirlineFlightPlanner-2444"><span class="linenos">2444</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2445"><a href="#AirlineFlightPlanner-2445"><span class="linenos">2445</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prepare_accepted_fp</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2446"><a href="#AirlineFlightPlanner-2446"><span class="linenos">2446</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2447"><a href="#AirlineFlightPlanner-2447"><span class="linenos">2447</span></a>			<span class="c1"># 	print(&#39;AOC triggers FP update for flight {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner-2448"><a href="#AirlineFlightPlanner-2448"><span class="linenos">2448</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>  <span class="c1"># msg[&#39;body&#39;][&#39;FP&#39;])</span>
</span><span id="AirlineFlightPlanner-2449"><a href="#AirlineFlightPlanner-2449"><span class="linenos">2449</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">update_eobt_processes</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2450"><a href="#AirlineFlightPlanner-2450"><span class="linenos">2450</span></a>
</span><span id="AirlineFlightPlanner-2451"><a href="#AirlineFlightPlanner-2451"><span class="linenos">2451</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2452"><a href="#AirlineFlightPlanner-2452"><span class="linenos">2452</span></a>			<span class="c1"># 	print(&#39;AOC records have been updated for flight {} with FP {}\n&#39;.format(flight_uid, msg[&#39;body&#39;][&#39;FP&#39;]))</span>
</span><span id="AirlineFlightPlanner-2453"><a href="#AirlineFlightPlanner-2453"><span class="linenos">2453</span></a>
</span><span id="AirlineFlightPlanner-2454"><a href="#AirlineFlightPlanner-2454"><span class="linenos">2454</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2455"><a href="#AirlineFlightPlanner-2455"><span class="linenos">2455</span></a>			<span class="c1"># Flight plan has not been accepted: curfew missed</span>
</span><span id="AirlineFlightPlanner-2456"><a href="#AirlineFlightPlanner-2456"><span class="linenos">2456</span></a>			<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;CURFEW&quot;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2457"><a href="#AirlineFlightPlanner-2457"><span class="linenos">2457</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;FP for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;rejected due to curfew&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2458"><a href="#AirlineFlightPlanner-2458"><span class="linenos">2458</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner-2459"><a href="#AirlineFlightPlanner-2459"><span class="linenos">2459</span></a>				<span class="c1"># Try other options</span>
</span><span id="AirlineFlightPlanner-2460"><a href="#AirlineFlightPlanner-2460"><span class="linenos">2460</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2461"><a href="#AirlineFlightPlanner-2461"><span class="linenos">2461</span></a>														<span class="n">fp_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2462"><a href="#AirlineFlightPlanner-2462"><span class="linenos">2462</span></a>														<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner-2463"><a href="#AirlineFlightPlanner-2463"><span class="linenos">2463</span></a>
</span><span id="AirlineFlightPlanner-2464"><a href="#AirlineFlightPlanner-2464"><span class="linenos">2464</span></a>	<span class="c1"># def wait_for_FP_request(self, msg):</span>
</span><span id="AirlineFlightPlanner-2465"><a href="#AirlineFlightPlanner-2465"><span class="linenos">2465</span></a>	<span class="c1"># 	mprint(&#39;Received FP request from&#39;, msg[&#39;from&#39;], &#39;for&#39;, flight_str(msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="AirlineFlightPlanner-2466"><a href="#AirlineFlightPlanner-2466"><span class="linenos">2466</span></a>	<span class="c1"># 	self.agent.env.process(self.compute_FP(msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="AirlineFlightPlanner-2467"><a href="#AirlineFlightPlanner-2467"><span class="linenos">2467</span></a>
</span><span id="AirlineFlightPlanner-2468"><a href="#AirlineFlightPlanner-2468"><span class="linenos">2468</span></a>	<span class="k">def</span> <span class="nf">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2469"><a href="#AirlineFlightPlanner-2469"><span class="linenos">2469</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Received departing reassessment request from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]))</span>
</span><span id="AirlineFlightPlanner-2470"><a href="#AirlineFlightPlanner-2470"><span class="linenos">2470</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2471"><a href="#AirlineFlightPlanner-2471"><span class="linenos">2471</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2472"><a href="#AirlineFlightPlanner-2472"><span class="linenos">2472</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2473"><a href="#AirlineFlightPlanner-2473"><span class="linenos">2473</span></a>		<span class="c1"># 	print(&quot;{} received a departing reassessment request from {} for flight {}&quot;.format(self.agent, msg[&#39;from&#39;], flight_uid))</span>
</span><span id="AirlineFlightPlanner-2474"><a href="#AirlineFlightPlanner-2474"><span class="linenos">2474</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2475"><a href="#AirlineFlightPlanner-2475"><span class="linenos">2475</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2476"><a href="#AirlineFlightPlanner-2476"><span class="linenos">2476</span></a>				<span class="c1"># We have already sent the fp for that flight so reassess</span>
</span><span id="AirlineFlightPlanner-2477"><a href="#AirlineFlightPlanner-2477"><span class="linenos">2477</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2478"><a href="#AirlineFlightPlanner-2478"><span class="linenos">2478</span></a>					<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;should have fligtht plan but option is None, fp status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2479"><a href="#AirlineFlightPlanner-2479"><span class="linenos">2479</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reassess_departure_turnaround</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2480"><a href="#AirlineFlightPlanner-2480"><span class="linenos">2480</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2481"><a href="#AirlineFlightPlanner-2481"><span class="linenos">2481</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="AirlineFlightPlanner-2482"><a href="#AirlineFlightPlanner-2482"><span class="linenos">2482</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">icao</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2483"><a href="#AirlineFlightPlanner-2483"><span class="linenos">2483</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-2484"><a href="#AirlineFlightPlanner-2484"><span class="linenos">2484</span></a>
</span><span id="AirlineFlightPlanner-2485"><a href="#AirlineFlightPlanner-2485"><span class="linenos">2485</span></a>	<span class="k">def</span> <span class="nf">wait_until_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2486"><a href="#AirlineFlightPlanner-2486"><span class="linenos">2486</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="AirlineFlightPlanner-2487"><a href="#AirlineFlightPlanner-2487"><span class="linenos">2487</span></a>		<span class="c1"># interrupted = False</span>
</span><span id="AirlineFlightPlanner-2488"><a href="#AirlineFlightPlanner-2488"><span class="linenos">2488</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2489"><a href="#AirlineFlightPlanner-2489"><span class="linenos">2489</span></a>			<span class="c1"># aprint(&#39;Non-ATFM delay estimation event created for&#39;, flight_str(flight_uid), &#39;at t=&#39;, self.agent.env.now)</span>
</span><span id="AirlineFlightPlanner-2490"><a href="#AirlineFlightPlanner-2490"><span class="linenos">2490</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2491"><a href="#AirlineFlightPlanner-2491"><span class="linenos">2491</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Non-ATFM delay estimation triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2492"><a href="#AirlineFlightPlanner-2492"><span class="linenos">2492</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2493"><a href="#AirlineFlightPlanner-2493"><span class="linenos">2493</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2494"><a href="#AirlineFlightPlanner-2494"><span class="linenos">2494</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner-2495"><a href="#AirlineFlightPlanner-2495"><span class="linenos">2495</span></a>			<span class="c1"># 	print(&#39;ALERT!!!&#39;)</span>
</span><span id="AirlineFlightPlanner-2496"><a href="#AirlineFlightPlanner-2496"><span class="linenos">2496</span></a>			<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-2497"><a href="#AirlineFlightPlanner-2497"><span class="linenos">2497</span></a>			<span class="c1"># aprint(&#39;wait_until_delay_estimation process interrupted for&#39;, flight_str(flight_uid))</span>
</span><span id="AirlineFlightPlanner-2498"><a href="#AirlineFlightPlanner-2498"><span class="linenos">2498</span></a>
</span><span id="AirlineFlightPlanner-2499"><a href="#AirlineFlightPlanner-2499"><span class="linenos">2499</span></a>	<span class="k">def</span> <span class="nf">wait_until_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2500"><a href="#AirlineFlightPlanner-2500"><span class="linenos">2500</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="AirlineFlightPlanner-2501"><a href="#AirlineFlightPlanner-2501"><span class="linenos">2501</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2502"><a href="#AirlineFlightPlanner-2502"><span class="linenos">2502</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2503"><a href="#AirlineFlightPlanner-2503"><span class="linenos">2503</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;starts flight plan submission for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2504"><a href="#AirlineFlightPlanner-2504"><span class="linenos">2504</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2505"><a href="#AirlineFlightPlanner-2505"><span class="linenos">2505</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2506"><a href="#AirlineFlightPlanner-2506"><span class="linenos">2506</span></a>			<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-2507"><a href="#AirlineFlightPlanner-2507"><span class="linenos">2507</span></a>
</span><span id="AirlineFlightPlanner-2508"><a href="#AirlineFlightPlanner-2508"><span class="linenos">2508</span></a>	<span class="k">def</span> <span class="nf">wait_until_push_back_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2509"><a href="#AirlineFlightPlanner-2509"><span class="linenos">2509</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2510"><a href="#AirlineFlightPlanner-2510"><span class="linenos">2510</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2511"><a href="#AirlineFlightPlanner-2511"><span class="linenos">2511</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2512"><a href="#AirlineFlightPlanner-2512"><span class="linenos">2512</span></a>			<span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft_request&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2513"><a href="#AirlineFlightPlanner-2513"><span class="linenos">2513</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is ready to go but waits on the&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;to be released at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2514"><a href="#AirlineFlightPlanner-2514"><span class="linenos">2514</span></a>
</span><span id="AirlineFlightPlanner-2515"><a href="#AirlineFlightPlanner-2515"><span class="linenos">2515</span></a>			<span class="k">assert</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_queue_req</span><span class="p">(</span><span class="n">include_current_user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2516"><a href="#AirlineFlightPlanner-2516"><span class="linenos">2516</span></a>
</span><span id="AirlineFlightPlanner-2517"><a href="#AirlineFlightPlanner-2517"><span class="linenos">2517</span></a>			<span class="k">yield</span> <span class="n">request</span>
</span><span id="AirlineFlightPlanner-2518"><a href="#AirlineFlightPlanner-2518"><span class="linenos">2518</span></a>
</span><span id="AirlineFlightPlanner-2519"><a href="#AirlineFlightPlanner-2519"><span class="linenos">2519</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft is ready, push-back ready triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2520"><a href="#AirlineFlightPlanner-2520"><span class="linenos">2520</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2521"><a href="#AirlineFlightPlanner-2521"><span class="linenos">2521</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pushed-back&#39;</span>
</span><span id="AirlineFlightPlanner-2522"><a href="#AirlineFlightPlanner-2522"><span class="linenos">2522</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2523"><a href="#AirlineFlightPlanner-2523"><span class="linenos">2523</span></a>			<span class="k">pass</span>
</span><span id="AirlineFlightPlanner-2524"><a href="#AirlineFlightPlanner-2524"><span class="linenos">2524</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2525"><a href="#AirlineFlightPlanner-2525"><span class="linenos">2525</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-2526"><a href="#AirlineFlightPlanner-2526"><span class="linenos">2526</span></a>
</span><span id="AirlineFlightPlanner-2527"><a href="#AirlineFlightPlanner-2527"><span class="linenos">2527</span></a>	<span class="k">def</span> <span class="nf">send_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2528"><a href="#AirlineFlightPlanner-2528"><span class="linenos">2528</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2529"><a href="#AirlineFlightPlanner-2529"><span class="linenos">2529</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner-2530"><a href="#AirlineFlightPlanner-2530"><span class="linenos">2530</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;request_flight_plan&#39;</span>
</span><span id="AirlineFlightPlanner-2531"><a href="#AirlineFlightPlanner-2531"><span class="linenos">2531</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aoc2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2532"><a href="#AirlineFlightPlanner-2532"><span class="linenos">2532</span></a>					   <span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2533"><a href="#AirlineFlightPlanner-2533"><span class="linenos">2533</span></a>
</span><span id="AirlineFlightPlanner-2534"><a href="#AirlineFlightPlanner-2534"><span class="linenos">2534</span></a>		<span class="c1"># print(self.agent, &#39;is requesting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="AirlineFlightPlanner-2535"><a href="#AirlineFlightPlanner-2535"><span class="linenos">2535</span></a>
</span><span id="AirlineFlightPlanner-2536"><a href="#AirlineFlightPlanner-2536"><span class="linenos">2536</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2537"><a href="#AirlineFlightPlanner-2537"><span class="linenos">2537</span></a>
</span><span id="AirlineFlightPlanner-2538"><a href="#AirlineFlightPlanner-2538"><span class="linenos">2538</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2539"><a href="#AirlineFlightPlanner-2539"><span class="linenos">2539</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Agent &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot; received flight plan request from&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">],</span> <span class="s2">&quot;for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2540"><a href="#AirlineFlightPlanner-2540"><span class="linenos">2540</span></a>		<span class="c1"># print(&quot;Received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="AirlineFlightPlanner-2541"><a href="#AirlineFlightPlanner-2541"><span class="linenos">2541</span></a>		<span class="n">fplan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2542"><a href="#AirlineFlightPlanner-2542"><span class="linenos">2542</span></a>
</span><span id="AirlineFlightPlanner-2543"><a href="#AirlineFlightPlanner-2543"><span class="linenos">2543</span></a>		<span class="c1"># send the flight plan back to the AOC who requested it</span>
</span><span id="AirlineFlightPlanner-2544"><a href="#AirlineFlightPlanner-2544"><span class="linenos">2544</span></a>		<span class="c1"># print(&quot;Agent &quot;, self.agent.uid, &quot; received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="AirlineFlightPlanner-2545"><a href="#AirlineFlightPlanner-2545"><span class="linenos">2545</span></a>		<span class="n">msg2</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2546"><a href="#AirlineFlightPlanner-2546"><span class="linenos">2546</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2547"><a href="#AirlineFlightPlanner-2547"><span class="linenos">2547</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span>
</span><span id="AirlineFlightPlanner-2548"><a href="#AirlineFlightPlanner-2548"><span class="linenos">2548</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2549"><a href="#AirlineFlightPlanner-2549"><span class="linenos">2549</span></a>					   <span class="s1">&#39;flight_plan&#39;</span><span class="p">:</span> <span class="n">fplan</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2550"><a href="#AirlineFlightPlanner-2550"><span class="linenos">2550</span></a>
</span><span id="AirlineFlightPlanner-2551"><a href="#AirlineFlightPlanner-2551"><span class="linenos">2551</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2552"><a href="#AirlineFlightPlanner-2552"><span class="linenos">2552</span></a>
</span><span id="AirlineFlightPlanner-2553"><a href="#AirlineFlightPlanner-2553"><span class="linenos">2553</span></a>	<span class="k">def</span> <span class="nf">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2554"><a href="#AirlineFlightPlanner-2554"><span class="linenos">2554</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Received requested flight plan for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2555"><a href="#AirlineFlightPlanner-2555"><span class="linenos">2555</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_plan&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2556"><a href="#AirlineFlightPlanner-2556"><span class="linenos">2556</span></a>		<span class="c1"># the AOC that originally requested this flight plan should now have it</span>
</span><span id="AirlineFlightPlanner-2557"><a href="#AirlineFlightPlanner-2557"><span class="linenos">2557</span></a>
</span><span id="AirlineFlightPlanner-2558"><a href="#AirlineFlightPlanner-2558"><span class="linenos">2558</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_option_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2559"><a href="#AirlineFlightPlanner-2559"><span class="linenos">2559</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2560"><a href="#AirlineFlightPlanner-2560"><span class="linenos">2560</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2561"><a href="#AirlineFlightPlanner-2561"><span class="linenos">2561</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2562"><a href="#AirlineFlightPlanner-2562"><span class="linenos">2562</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2563"><a href="#AirlineFlightPlanner-2563"><span class="linenos">2563</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Issue with flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2564"><a href="#AirlineFlightPlanner-2564"><span class="linenos">2564</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner-2565"><a href="#AirlineFlightPlanner-2565"><span class="linenos">2565</span></a>
</span><span id="AirlineFlightPlanner-2566"><a href="#AirlineFlightPlanner-2566"><span class="linenos">2566</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2567"><a href="#AirlineFlightPlanner-2567"><span class="linenos">2567</span></a>		<span class="c1"># self.agent.env.process(self.make_hotspot_decision(msg[&#39;body&#39;][&#39;regulation_info&#39;], msg[&#39;body&#39;][&#39;event&#39;]))</span>
</span><span id="AirlineFlightPlanner-2568"><a href="#AirlineFlightPlanner-2568"><span class="linenos">2568</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">make_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;regulation_info&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2569"><a href="#AirlineFlightPlanner-2569"><span class="linenos">2569</span></a>
</span><span id="AirlineFlightPlanner-2570"><a href="#AirlineFlightPlanner-2570"><span class="linenos">2570</span></a>	<span class="k">def</span> <span class="nf">make_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_info</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2571"><a href="#AirlineFlightPlanner-2571"><span class="linenos">2571</span></a>		<span class="c1"># if regulation_info[&#39;solver&#39;]==&#39;udpp_merge&#39;:</span>
</span><span id="AirlineFlightPlanner-2572"><a href="#AirlineFlightPlanner-2572"><span class="linenos">2572</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_cost_vect[regulation_info[&#39;solver&#39;]]</span>
</span><span id="AirlineFlightPlanner-2573"><a href="#AirlineFlightPlanner-2573"><span class="linenos">2573</span></a>		<span class="c1"># else:</span>
</span><span id="AirlineFlightPlanner-2574"><a href="#AirlineFlightPlanner-2574"><span class="linenos">2574</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_approx[regulation_info[&#39;solver&#39;]]</span>
</span><span id="AirlineFlightPlanner-2575"><a href="#AirlineFlightPlanner-2575"><span class="linenos">2575</span></a>
</span><span id="AirlineFlightPlanner-2576"><a href="#AirlineFlightPlanner-2576"><span class="linenos">2576</span></a>		<span class="n">engine_local</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">LocalEngine</span><span class="p">(</span><span class="n">algo</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner-2577"><a href="#AirlineFlightPlanner-2577"><span class="linenos">2577</span></a>
</span><span id="AirlineFlightPlanner-2578"><a href="#AirlineFlightPlanner-2578"><span class="linenos">2578</span></a>		<span class="n">hh</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">HotspotHandler</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine_local</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2579"><a href="#AirlineFlightPlanner-2579"><span class="linenos">2579</span></a>								<span class="n">cost_func_archetype</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;archetype_cost_function&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2580"><a href="#AirlineFlightPlanner-2580"><span class="linenos">2580</span></a>								<span class="n">alternative_allocation_rule</span><span class="o">=</span><span class="kc">True</span>
</span><span id="AirlineFlightPlanner-2581"><a href="#AirlineFlightPlanner-2581"><span class="linenos">2581</span></a>								<span class="p">)</span>
</span><span id="AirlineFlightPlanner-2582"><a href="#AirlineFlightPlanner-2582"><span class="linenos">2582</span></a>
</span><span id="AirlineFlightPlanner-2583"><a href="#AirlineFlightPlanner-2583"><span class="linenos">2583</span></a>		<span class="c1"># Note: here we are not using the most up to date ETA for this FP.</span>
</span><span id="AirlineFlightPlanner-2584"><a href="#AirlineFlightPlanner-2584"><span class="linenos">2584</span></a>		<span class="c1"># Instead, we use the one recorded in the regulation when the FP</span>
</span><span id="AirlineFlightPlanner-2585"><a href="#AirlineFlightPlanner-2585"><span class="linenos">2585</span></a>		<span class="c1"># was accepted by the NM. The up to date ETA can be different from</span>
</span><span id="AirlineFlightPlanner-2586"><a href="#AirlineFlightPlanner-2586"><span class="linenos">2586</span></a>		<span class="c1"># the latter because the flight does not need to resubmit a FP if the</span>
</span><span id="AirlineFlightPlanner-2587"><a href="#AirlineFlightPlanner-2587"><span class="linenos">2587</span></a>		<span class="c1"># ETA does not change by more than -5, +10 minutes.</span>
</span><span id="AirlineFlightPlanner-2588"><a href="#AirlineFlightPlanner-2588"><span class="linenos">2588</span></a>
</span><span id="AirlineFlightPlanner-2589"><a href="#AirlineFlightPlanner-2589"><span class="linenos">2589</span></a>		<span class="c1"># This gives the cost as a function of the delay with respect to scheduled in block time</span>
</span><span id="AirlineFlightPlanner-2590"><a href="#AirlineFlightPlanner-2590"><span class="linenos">2590</span></a>		<span class="n">cfs_old</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2591"><a href="#AirlineFlightPlanner-2591"><span class="linenos">2591</span></a>														<span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="AirlineFlightPlanner-2592"><a href="#AirlineFlightPlanner-2592"><span class="linenos">2592</span></a>														<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2593"><a href="#AirlineFlightPlanner-2593"><span class="linenos">2593</span></a>														<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2594"><a href="#AirlineFlightPlanner-2594"><span class="linenos">2594</span></a>														<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2595"><a href="#AirlineFlightPlanner-2595"><span class="linenos">2595</span></a>														<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="AirlineFlightPlanner-2596"><a href="#AirlineFlightPlanner-2596"><span class="linenos">2596</span></a>
</span><span id="AirlineFlightPlanner-2597"><a href="#AirlineFlightPlanner-2597"><span class="linenos">2597</span></a>		<span class="c1"># We transform the functions to have the cost as a function of delay w.r.t. to eta,</span>
</span><span id="AirlineFlightPlanner-2598"><a href="#AirlineFlightPlanner-2598"><span class="linenos">2598</span></a>		<span class="c1"># estimated landing.</span>
</span><span id="AirlineFlightPlanner-2599"><a href="#AirlineFlightPlanner-2599"><span class="linenos">2599</span></a>		<span class="k">def</span> <span class="nf">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">sibt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2600"><a href="#AirlineFlightPlanner-2600"><span class="linenos">2600</span></a>			<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2601"><a href="#AirlineFlightPlanner-2601"><span class="linenos">2601</span></a>				<span class="k">return</span> <span class="n">cf</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sibt</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner-2602"><a href="#AirlineFlightPlanner-2602"><span class="linenos">2602</span></a>
</span><span id="AirlineFlightPlanner-2603"><a href="#AirlineFlightPlanner-2603"><span class="linenos">2603</span></a>			<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner-2604"><a href="#AirlineFlightPlanner-2604"><span class="linenos">2604</span></a>
</span><span id="AirlineFlightPlanner-2605"><a href="#AirlineFlightPlanner-2605"><span class="linenos">2605</span></a>		<span class="n">cfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">fid</span><span class="p">:</span> <span class="n">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2606"><a href="#AirlineFlightPlanner-2606"><span class="linenos">2606</span></a>							<span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">][</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2607"><a href="#AirlineFlightPlanner-2607"><span class="linenos">2607</span></a>							<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">cfs_old</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="AirlineFlightPlanner-2608"><a href="#AirlineFlightPlanner-2608"><span class="linenos">2608</span></a>
</span><span id="AirlineFlightPlanner-2609"><a href="#AirlineFlightPlanner-2609"><span class="linenos">2609</span></a>		<span class="n">flights_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;flight_name&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2610"><a href="#AirlineFlightPlanner-2610"><span class="linenos">2610</span></a>						<span class="s1">&#39;airline_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2611"><a href="#AirlineFlightPlanner-2611"><span class="linenos">2611</span></a>						<span class="c1"># &#39;eta&#39;: self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="AirlineFlightPlanner-2612"><a href="#AirlineFlightPlanner-2612"><span class="linenos">2612</span></a>						<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_eta_wo_atfm</span><span class="p">(),</span>  <span class="c1"># int(d[&#39;eta&#39;]),</span>
</span><span id="AirlineFlightPlanner-2613"><a href="#AirlineFlightPlanner-2613"><span class="linenos">2613</span></a>						<span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="n">cfs</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2614"><a href="#AirlineFlightPlanner-2614"><span class="linenos">2614</span></a>						<span class="s1">&#39;slot&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner-2615"><a href="#AirlineFlightPlanner-2615"><span class="linenos">2615</span></a>						<span class="p">}</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="AirlineFlightPlanner-2616"><a href="#AirlineFlightPlanner-2616"><span class="linenos">2616</span></a>
</span><span id="AirlineFlightPlanner-2617"><a href="#AirlineFlightPlanner-2617"><span class="linenos">2617</span></a>		<span class="c1"># Here we pass directly the real cost function, because we want to ask for an approximation</span>
</span><span id="AirlineFlightPlanner-2618"><a href="#AirlineFlightPlanner-2618"><span class="linenos">2618</span></a>		<span class="c1"># computed by the udpp_local engine.</span>
</span><span id="AirlineFlightPlanner-2619"><a href="#AirlineFlightPlanner-2619"><span class="linenos">2619</span></a>		<span class="c1"># print(&#39;SLOTS in AOC (&#39;, len(regulation_info[&#39;slots&#39;]), &#39;):&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner-2620"><a href="#AirlineFlightPlanner-2620"><span class="linenos">2620</span></a>		<span class="c1"># print(&#39;flights_dict in {}:&#39;.format(msg[&#39;body&#39;][&#39;regulation_info&#39;][&#39;regulation_uid&#39;]))</span>
</span><span id="AirlineFlightPlanner-2621"><a href="#AirlineFlightPlanner-2621"><span class="linenos">2621</span></a>		<span class="c1"># for d in flights_dict:</span>
</span><span id="AirlineFlightPlanner-2622"><a href="#AirlineFlightPlanner-2622"><span class="linenos">2622</span></a>		<span class="c1"># 	print(d)</span>
</span><span id="AirlineFlightPlanner-2623"><a href="#AirlineFlightPlanner-2623"><span class="linenos">2623</span></a>
</span><span id="AirlineFlightPlanner-2624"><a href="#AirlineFlightPlanner-2624"><span class="linenos">2624</span></a>		<span class="n">_</span><span class="p">,</span> <span class="n">flights_airline</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">prepare_hotspot_from_dict</span><span class="p">(</span><span class="n">attr_list</span><span class="o">=</span><span class="n">flights_dict</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2625"><a href="#AirlineFlightPlanner-2625"><span class="linenos">2625</span></a>															<span class="n">slots</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;slots&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2626"><a href="#AirlineFlightPlanner-2626"><span class="linenos">2626</span></a>															<span class="n">set_cost_function_with</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="s1">&#39;cost_function&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2627"><a href="#AirlineFlightPlanner-2627"><span class="linenos">2627</span></a>																					<span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2628"><a href="#AirlineFlightPlanner-2628"><span class="linenos">2628</span></a>																					<span class="s1">&#39;absolute&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2629"><a href="#AirlineFlightPlanner-2629"><span class="linenos">2629</span></a>																					<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="s1">&#39;eta&#39;</span><span class="p">},</span>
</span><span id="AirlineFlightPlanner-2630"><a href="#AirlineFlightPlanner-2630"><span class="linenos">2630</span></a>															<span class="p">)</span>
</span><span id="AirlineFlightPlanner-2631"><a href="#AirlineFlightPlanner-2631"><span class="linenos">2631</span></a>		<span class="c1"># Prepare flights for engine</span>
</span><span id="AirlineFlightPlanner-2632"><a href="#AirlineFlightPlanner-2632"><span class="linenos">2632</span></a>		<span class="n">hh</span><span class="o">.</span><span class="n">prepare_all_flights</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2633"><a href="#AirlineFlightPlanner-2633"><span class="linenos">2633</span></a>
</span><span id="AirlineFlightPlanner-2634"><a href="#AirlineFlightPlanner-2634"><span class="linenos">2634</span></a>		<span class="c1"># Use following code to save costs for external use</span>
</span><span id="AirlineFlightPlanner-2635"><a href="#AirlineFlightPlanner-2635"><span class="linenos">2635</span></a>		<span class="c1"># import pandas as pd</span>
</span><span id="AirlineFlightPlanner-2636"><a href="#AirlineFlightPlanner-2636"><span class="linenos">2636</span></a>		<span class="c1"># try:</span>
</span><span id="AirlineFlightPlanner-2637"><a href="#AirlineFlightPlanner-2637"><span class="linenos">2637</span></a>		<span class="c1"># 	df = pd.read_csv(&#39;cost_matrix_before.csv&#39;, index_col=0)</span>
</span><span id="AirlineFlightPlanner-2638"><a href="#AirlineFlightPlanner-2638"><span class="linenos">2638</span></a>		<span class="c1"># except:</span>
</span><span id="AirlineFlightPlanner-2639"><a href="#AirlineFlightPlanner-2639"><span class="linenos">2639</span></a>		<span class="c1"># 	df = pd.DataFrame([], columns=regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner-2640"><a href="#AirlineFlightPlanner-2640"><span class="linenos">2640</span></a>
</span><span id="AirlineFlightPlanner-2641"><a href="#AirlineFlightPlanner-2641"><span class="linenos">2641</span></a>		<span class="c1"># for flight in hh.get_flight_list():</span>
</span><span id="AirlineFlightPlanner-2642"><a href="#AirlineFlightPlanner-2642"><span class="linenos">2642</span></a>		<span class="c1"># 	df.loc[flight.name, :] = flight.costVect</span>
</span><span id="AirlineFlightPlanner-2643"><a href="#AirlineFlightPlanner-2643"><span class="linenos">2643</span></a>
</span><span id="AirlineFlightPlanner-2644"><a href="#AirlineFlightPlanner-2644"><span class="linenos">2644</span></a>		<span class="c1"># df.to_csv(&#39;cost_matrix_before.csv&#39;)</span>
</span><span id="AirlineFlightPlanner-2645"><a href="#AirlineFlightPlanner-2645"><span class="linenos">2645</span></a>
</span><span id="AirlineFlightPlanner-2646"><a href="#AirlineFlightPlanner-2646"><span class="linenos">2646</span></a>		<span class="c1"># print(&#39;SLOTS:&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner-2647"><a href="#AirlineFlightPlanner-2647"><span class="linenos">2647</span></a>
</span><span id="AirlineFlightPlanner-2648"><a href="#AirlineFlightPlanner-2648"><span class="linenos">2648</span></a>		<span class="c1"># print(&#39;Flight characs before computing local optimisation in AOC:&#39;, [(f.name, f.eta, f.costVect[-3:]) for f in hh.get_flight_list()])</span>
</span><span id="AirlineFlightPlanner-2649"><a href="#AirlineFlightPlanner-2649"><span class="linenos">2649</span></a>
</span><span id="AirlineFlightPlanner-2650"><a href="#AirlineFlightPlanner-2650"><span class="linenos">2650</span></a>		<span class="c1"># print(&#39;Hotspot summary in airline {}&#39;.format(self.agent))</span>
</span><span id="AirlineFlightPlanner-2651"><a href="#AirlineFlightPlanner-2651"><span class="linenos">2651</span></a>		<span class="c1"># hh.print_summary()</span>
</span><span id="AirlineFlightPlanner-2652"><a href="#AirlineFlightPlanner-2652"><span class="linenos">2652</span></a>		<span class="c1"># Compute preferences (parameters approximating the cost function)</span>
</span><span id="AirlineFlightPlanner-2653"><a href="#AirlineFlightPlanner-2653"><span class="linenos">2653</span></a>		<span class="n">preferences</span> <span class="o">=</span> <span class="n">engine_local</span><span class="o">.</span><span class="n">compute_optimal_parameters</span><span class="p">(</span><span class="n">hotspot_handler</span><span class="o">=</span><span class="n">hh</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2654"><a href="#AirlineFlightPlanner-2654"><span class="linenos">2654</span></a>																<span class="n">kwargs_init</span><span class="o">=</span><span class="p">{})</span>
</span><span id="AirlineFlightPlanner-2655"><a href="#AirlineFlightPlanner-2655"><span class="linenos">2655</span></a>		<span class="c1"># print(&#39;PREFERENCES FROM HOTSPOT ({}): {}&#39;.format(self.agent.icao, preferences))</span>
</span><span id="AirlineFlightPlanner-2656"><a href="#AirlineFlightPlanner-2656"><span class="linenos">2656</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_hotspot_decision</span><span class="p">(</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner-2657"><a href="#AirlineFlightPlanner-2657"><span class="linenos">2657</span></a>									<span class="n">event</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2658"><a href="#AirlineFlightPlanner-2658"><span class="linenos">2658</span></a>									<span class="n">preferences</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2659"><a href="#AirlineFlightPlanner-2659"><span class="linenos">2659</span></a>									<span class="n">real_cost_funcs</span><span class="o">=</span><span class="n">cfs</span><span class="p">)</span>  <span class="c1"># Just for metrics, TODO we need to build metrics computers</span>
</span><span id="AirlineFlightPlanner-2660"><a href="#AirlineFlightPlanner-2660"><span class="linenos">2660</span></a>
</span><span id="AirlineFlightPlanner-2661"><a href="#AirlineFlightPlanner-2661"><span class="linenos">2661</span></a>	<span class="k">def</span> <span class="nf">send_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">decision</span><span class="p">,</span> <span class="n">real_cost_funcs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2662"><a href="#AirlineFlightPlanner-2662"><span class="linenos">2662</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2663"><a href="#AirlineFlightPlanner-2663"><span class="linenos">2663</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner-2664"><a href="#AirlineFlightPlanner-2664"><span class="linenos">2664</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hotspot_decision&#39;</span>
</span><span id="AirlineFlightPlanner-2665"><a href="#AirlineFlightPlanner-2665"><span class="linenos">2665</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">:</span> <span class="n">regulation_id</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2666"><a href="#AirlineFlightPlanner-2666"><span class="linenos">2666</span></a>					   <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2667"><a href="#AirlineFlightPlanner-2667"><span class="linenos">2667</span></a>					   <span class="s1">&#39;hotspot_decision&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner-2668"><a href="#AirlineFlightPlanner-2668"><span class="linenos">2668</span></a>					   <span class="s1">&#39;real_cost_funcs&#39;</span><span class="p">:</span> <span class="n">real_cost_funcs</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner-2669"><a href="#AirlineFlightPlanner-2669"><span class="linenos">2669</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2670"><a href="#AirlineFlightPlanner-2670"><span class="linenos">2670</span></a>
</span><span id="AirlineFlightPlanner-2671"><a href="#AirlineFlightPlanner-2671"><span class="linenos">2671</span></a>	<span class="k">def</span> <span class="nf">wait_until_pax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner-2672"><a href="#AirlineFlightPlanner-2672"><span class="linenos">2672</span></a>		<span class="c1"># checking for missing passengers 5 minutes before push_back_ready</span>
</span><span id="AirlineFlightPlanner-2673"><a href="#AirlineFlightPlanner-2673"><span class="linenos">2673</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2674"><a href="#AirlineFlightPlanner-2674"><span class="linenos">2674</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner-2675"><a href="#AirlineFlightPlanner-2675"><span class="linenos">2675</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs pre-check for missing passengers on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner-2676"><a href="#AirlineFlightPlanner-2676"><span class="linenos">2676</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner-2677"><a href="#AirlineFlightPlanner-2677"><span class="linenos">2677</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner-2678"><a href="#AirlineFlightPlanner-2678"><span class="linenos">2678</span></a>			<span class="c1"># aprint(&#39;wait_until_pax_check interrupted&#39;)</span>
</span><span id="AirlineFlightPlanner-2679"><a href="#AirlineFlightPlanner-2679"><span class="linenos">2679</span></a>			<span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>AFP: Airline Flight Planner</p>

<p>Description:
Select which flight plan will be executed. This means selecting the 4D trajectory (including delayed departing time (e.g., waiting for passengers)) and possibly cancelling flight (i.e., the Airline Flight Planner decides to cancel the flight plan).</p>

<ol>
<li>Check which flights are ready for pre-departure (less than 3 hours before their EOBT and in scheduled status) or get a request to recompute the flight plan selection of a given flight.</li>
<li>Submit flight plan which might lead to ATFM delay update.</li>
<li>Check different flight plan options and their costs.</li>
<li>Decide which flight plan to execute tactically.</li>
</ol>

<p>The liveness of AFP will depend on the mechanism 4DT and the FP implementation.</p>

<p>The action of RequestATFMSlot will depend on the FP mechanism:</p>

<pre><code>    - FP_0: Request ATFM slot
    - FP_1 and FP_2: Request ATFM slot and then prioritise the flight and optionally request a flight swap.
</code></pre>

<p>The action of DecideOption depends on 4DT:</p>

<pre><code>    - 4DT_0: Rule of thumb to decide between speed-up, wait-for-passengers and cancellation
    - 4DT_1 and 4DT_2: Selection of option based on cost provided by CheckFPOption
</code></pre>
</div>


                            <div id="AirlineFlightPlanner.__init__" class="classattr">
                                        <input id="AirlineFlightPlanner.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AirlineFlightPlanner</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">agent</span></span>)</span>

                <label class="view-source-button" for="AirlineFlightPlanner.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.__init__-702"><a href="#AirlineFlightPlanner.__init__-702"><span class="linenos">702</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.__init__-703"><a href="#AirlineFlightPlanner.__init__-703"><span class="linenos">703</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.__init__-704"><a href="#AirlineFlightPlanner.__init__-704"><span class="linenos">704</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options_from_fp_pool</span>
</span><span id="AirlineFlightPlanner.__init__-705"><a href="#AirlineFlightPlanner.__init__-705"><span class="linenos">705</span></a>
</span><span id="AirlineFlightPlanner.__init__-706"><a href="#AirlineFlightPlanner.__init__-706"><span class="linenos">706</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="AirlineFlightPlanner.__init__-707"><a href="#AirlineFlightPlanner.__init__-707"><span class="linenos">707</span></a>		<span class="c1"># self.build_delay_cost_functions = self.build_delay_cost_functions_advanced</span>
</span><span id="AirlineFlightPlanner.__init__-708"><a href="#AirlineFlightPlanner.__init__-708"><span class="linenos">708</span></a>
</span><span id="AirlineFlightPlanner.__init__-709"><a href="#AirlineFlightPlanner.__init__-709"><span class="linenos">709</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner.__init__-710"><a href="#AirlineFlightPlanner.__init__-710"><span class="linenos">710</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner.__init__-711"><a href="#AirlineFlightPlanner.__init__-711"><span class="linenos">711</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span> <span class="o">=</span> <span class="p">{}</span>
</span></pre></div>


            <div class="docstring"><p>On initialisation of a Role, it gets a pointer to the Agent it belongs to.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.compute_FP_options" class="classattr">
                                <div class="attr variable">
            <span class="name">compute_FP_options</span>

        
    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_FP_options"></a>
    
    

                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions" class="classattr">
                                <div class="attr variable">
            <span class="name">build_delay_cost_functions</span>

        
    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions"></a>
    
    

                            </div>
                            <div id="AirlineFlightPlanner.option_selected_for_fp" class="classattr">
                                <div class="attr variable">
            <span class="name">option_selected_for_fp</span>

        
    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.option_selected_for_fp"></a>
    
    

                            </div>
                            <div id="AirlineFlightPlanner.fp_waiting_option_events" class="classattr">
                                <div class="attr variable">
            <span class="name">fp_waiting_option_events</span>

        
    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.fp_waiting_option_events"></a>
    
    

                            </div>
                            <div id="AirlineFlightPlanner.dict_decide_options" class="classattr">
                                <div class="attr variable">
            <span class="name">dict_decide_options</span>

        
    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.dict_decide_options"></a>
    
    

                            </div>
                            <div id="AirlineFlightPlanner.cancel_flight" class="classattr">
                                        <input id="AirlineFlightPlanner.cancel_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cancel_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">reason</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.cancel_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.cancel_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.cancel_flight-713"><a href="#AirlineFlightPlanner.cancel_flight-713"><span class="linenos">713</span></a>	<span class="k">def</span> <span class="nf">cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cancel_flight-714"><a href="#AirlineFlightPlanner.cancel_flight-714"><span class="linenos">714</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="s1">&#39;due to&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-715"><a href="#AirlineFlightPlanner.cancel_flight-715"><span class="linenos">715</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-716"><a href="#AirlineFlightPlanner.cancel_flight-716"><span class="linenos">716</span></a>		<span class="c1"># Mark the flight as cancelled. This needs to be before reallocating</span>
</span><span id="AirlineFlightPlanner.cancel_flight-717"><a href="#AirlineFlightPlanner.cancel_flight-717"><span class="linenos">717</span></a>		<span class="c1"># passengers, so they are not rellocated on an itinerary including this flight.</span>
</span><span id="AirlineFlightPlanner.cancel_flight-718"><a href="#AirlineFlightPlanner.cancel_flight-718"><span class="linenos">718</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="AirlineFlightPlanner.cancel_flight-719"><a href="#AirlineFlightPlanner.cancel_flight-719"><span class="linenos">719</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-720"><a href="#AirlineFlightPlanner.cancel_flight-720"><span class="linenos">720</span></a>		<span class="k">if</span> <span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-721"><a href="#AirlineFlightPlanner.cancel_flight-721"><span class="linenos">721</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="AirlineFlightPlanner.cancel_flight-722"><a href="#AirlineFlightPlanner.cancel_flight-722"><span class="linenos">722</span></a>			<span class="c1"># print(&quot;WTC cancel: &quot;,self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].wtc)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-723"><a href="#AirlineFlightPlanner.cancel_flight-723"><span class="linenos">723</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-724"><a href="#AirlineFlightPlanner.cancel_flight-724"><span class="linenos">724</span></a>			<span class="k">if</span> <span class="n">reason</span> <span class="o">==</span> <span class="s2">&quot;CANCEL_CF&quot;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-725"><a href="#AirlineFlightPlanner.cancel_flight-725"><span class="linenos">725</span></a>				<span class="c1"># We cancelled due to curfew add extra non-pax costs of Laurent</span>
</span><span id="AirlineFlightPlanner.cancel_flight-726"><a href="#AirlineFlightPlanner.cancel_flight-726"><span class="linenos">726</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_curfew_cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-727"><a href="#AirlineFlightPlanner.cancel_flight-727"><span class="linenos">727</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-728"><a href="#AirlineFlightPlanner.cancel_flight-728"><span class="linenos">728</span></a>		<span class="c1"># Pax will blame ANY compensation, soft cost, or transfer cost on the cancelled flight</span>
</span><span id="AirlineFlightPlanner.cancel_flight-729"><a href="#AirlineFlightPlanner.cancel_flight-729"><span class="linenos">729</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-730"><a href="#AirlineFlightPlanner.cancel_flight-730"><span class="linenos">730</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames soft cost on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-731"><a href="#AirlineFlightPlanner.cancel_flight-731"><span class="linenos">731</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.cancel_flight-732"><a href="#AirlineFlightPlanner.cancel_flight-732"><span class="linenos">732</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames compensation on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-733"><a href="#AirlineFlightPlanner.cancel_flight-733"><span class="linenos">733</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.cancel_flight-734"><a href="#AirlineFlightPlanner.cancel_flight-734"><span class="linenos">734</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-735"><a href="#AirlineFlightPlanner.cancel_flight-735"><span class="linenos">735</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.cancel_flight-736"><a href="#AirlineFlightPlanner.cancel_flight-736"><span class="linenos">736</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-737"><a href="#AirlineFlightPlanner.cancel_flight-737"><span class="linenos">737</span></a>		<span class="c1"># Reallocate passenger which are already in transit</span>
</span><span id="AirlineFlightPlanner.cancel_flight-738"><a href="#AirlineFlightPlanner.cancel_flight-738"><span class="linenos">738</span></a>		<span class="n">pax_to_reallocate</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.cancel_flight-739"><a href="#AirlineFlightPlanner.cancel_flight-739"><span class="linenos">739</span></a>								<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.cancel_flight-740"><a href="#AirlineFlightPlanner.cancel_flight-740"><span class="linenos">740</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;, because&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner.cancel_flight-741"><a href="#AirlineFlightPlanner.cancel_flight-741"><span class="linenos">741</span></a>				<span class="s1">&#39;has been cancelled, the following paxs need to be reallocated:&#39;</span><span class="p">,</span> <span class="n">pax_to_reallocate</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.cancel_flight-742"><a href="#AirlineFlightPlanner.cancel_flight-742"><span class="linenos">742</span></a>				<span class="s1">&#39;(the rest will be reallocated when they reach the airport of departure of the cancelled flight)&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-743"><a href="#AirlineFlightPlanner.cancel_flight-743"><span class="linenos">743</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-744"><a href="#AirlineFlightPlanner.cancel_flight-744"><span class="linenos">744</span></a>		<span class="c1"># # All victims of cancellations can be compensated.</span>
</span><span id="AirlineFlightPlanner.cancel_flight-745"><a href="#AirlineFlightPlanner.cancel_flight-745"><span class="linenos">745</span></a>		<span class="c1"># for pax in self.agent.aoc_flights_info[flight_uid][&#39;pax_to_board&#39;]:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-746"><a href="#AirlineFlightPlanner.cancel_flight-746"><span class="linenos">746</span></a>		<span class="c1"># 	pax.force_entitled = True</span>
</span><span id="AirlineFlightPlanner.cancel_flight-747"><a href="#AirlineFlightPlanner.cancel_flight-747"><span class="linenos">747</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-748"><a href="#AirlineFlightPlanner.cancel_flight-748"><span class="linenos">748</span></a>		<span class="c1"># Check liability for compensation</span>
</span><span id="AirlineFlightPlanner.cancel_flight-749"><a href="#AirlineFlightPlanner.cancel_flight-749"><span class="linenos">749</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-750"><a href="#AirlineFlightPlanner.cancel_flight-750"><span class="linenos">750</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-751"><a href="#AirlineFlightPlanner.cancel_flight-751"><span class="linenos">751</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-752"><a href="#AirlineFlightPlanner.cancel_flight-752"><span class="linenos">752</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_reallocation_pax_request</span><span class="p">(</span><span class="n">pax_to_reallocate</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-753"><a href="#AirlineFlightPlanner.cancel_flight-753"><span class="linenos">753</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-754"><a href="#AirlineFlightPlanner.cancel_flight-754"><span class="linenos">754</span></a>		<span class="c1"># Disseminate the cancellation of the flight plan, if any</span>
</span><span id="AirlineFlightPlanner.cancel_flight-755"><a href="#AirlineFlightPlanner.cancel_flight-755"><span class="linenos">755</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_cancellation_flight_message</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-756"><a href="#AirlineFlightPlanner.cancel_flight-756"><span class="linenos">756</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-757"><a href="#AirlineFlightPlanner.cancel_flight-757"><span class="linenos">757</span></a>		<span class="c1"># Cancel all events linked to flight</span>
</span><span id="AirlineFlightPlanner.cancel_flight-758"><a href="#AirlineFlightPlanner.cancel_flight-758"><span class="linenos">758</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Cancelling all events of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-759"><a href="#AirlineFlightPlanner.cancel_flight-759"><span class="linenos">759</span></a>		<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.cancel_flight-760"><a href="#AirlineFlightPlanner.cancel_flight-760"><span class="linenos">760</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_event&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_proc&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cancel_flight-761"><a href="#AirlineFlightPlanner.cancel_flight-761"><span class="linenos">761</span></a>				<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-762"><a href="#AirlineFlightPlanner.cancel_flight-762"><span class="linenos">762</span></a>					<span class="n">value</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.cancel_flight-763"><a href="#AirlineFlightPlanner.cancel_flight-763"><span class="linenos">763</span></a>				<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-764"><a href="#AirlineFlightPlanner.cancel_flight-764"><span class="linenos">764</span></a>					<span class="k">pass</span>
</span><span id="AirlineFlightPlanner.cancel_flight-765"><a href="#AirlineFlightPlanner.cancel_flight-765"><span class="linenos">765</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-766"><a href="#AirlineFlightPlanner.cancel_flight-766"><span class="linenos">766</span></a>		<span class="c1"># Prepare next flight (using turnaround operator)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-767"><a href="#AirlineFlightPlanner.cancel_flight-767"><span class="linenos">767</span></a>		<span class="c1"># self.agent.tro.process_following_flight(flight_uid)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-768"><a href="#AirlineFlightPlanner.cancel_flight-768"><span class="linenos">768</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-769"><a href="#AirlineFlightPlanner.cancel_flight-769"><span class="linenos">769</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-770"><a href="#AirlineFlightPlanner.cancel_flight-770"><span class="linenos">770</span></a>			<span class="n">next_flights_uids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-771"><a href="#AirlineFlightPlanner.cancel_flight-771"><span class="linenos">771</span></a>			<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.cancel_flight-772"><a href="#AirlineFlightPlanner.cancel_flight-772"><span class="linenos">772</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights_uids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-773"><a href="#AirlineFlightPlanner.cancel_flight-773"><span class="linenos">773</span></a>				<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">next_flights_uids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.cancel_flight-774"><a href="#AirlineFlightPlanner.cancel_flight-774"><span class="linenos">774</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-775"><a href="#AirlineFlightPlanner.cancel_flight-775"><span class="linenos">775</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.cancel_flight-776"><a href="#AirlineFlightPlanner.cancel_flight-776"><span class="linenos">776</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-777"><a href="#AirlineFlightPlanner.cancel_flight-777"><span class="linenos">777</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.cancel_flight-778"><a href="#AirlineFlightPlanner.cancel_flight-778"><span class="linenos">778</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-779"><a href="#AirlineFlightPlanner.cancel_flight-779"><span class="linenos">779</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.cancel_flight-780"><a href="#AirlineFlightPlanner.cancel_flight-780"><span class="linenos">780</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.cancel_flight-781"><a href="#AirlineFlightPlanner.cancel_flight-781"><span class="linenos">781</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-782"><a href="#AirlineFlightPlanner.cancel_flight-782"><span class="linenos">782</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.cancel_flight-783"><a href="#AirlineFlightPlanner.cancel_flight-783"><span class="linenos">783</span></a>
</span><span id="AirlineFlightPlanner.cancel_flight-784"><a href="#AirlineFlightPlanner.cancel_flight-784"><span class="linenos">784</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.cancel_flight-785"><a href="#AirlineFlightPlanner.cancel_flight-785"><span class="linenos">785</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-786"><a href="#AirlineFlightPlanner.cancel_flight-786"><span class="linenos">786</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-787"><a href="#AirlineFlightPlanner.cancel_flight-787"><span class="linenos">787</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-788"><a href="#AirlineFlightPlanner.cancel_flight-788"><span class="linenos">788</span></a>			<span class="nb">print</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-789"><a href="#AirlineFlightPlanner.cancel_flight-789"><span class="linenos">789</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.cancel_flight-790"><a href="#AirlineFlightPlanner.cancel_flight-790"><span class="linenos">790</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cancel_cascade_curfew</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cancel_flight-791"><a href="#AirlineFlightPlanner.cancel_flight-791"><span class="linenos">791</span></a>			<span class="c1"># Cancel in cascade after curfew</span>
</span><span id="AirlineFlightPlanner.cancel_flight-792"><a href="#AirlineFlightPlanner.cancel_flight-792"><span class="linenos">792</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Because flight&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;has been cancelled due to curfew, AOC sends a cancelling signal to flight&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.cancel_flight-793"><a href="#AirlineFlightPlanner.cancel_flight-793"><span class="linenos">793</span></a>				   <span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;cascade cancelation&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-794"><a href="#AirlineFlightPlanner.cancel_flight-794"><span class="linenos">794</span></a>			<span class="c1">#     aprint(flight_str(flight_uid), &#39;has&#39;, aircraft, \</span>
</span><span id="AirlineFlightPlanner.cancel_flight-795"><a href="#AirlineFlightPlanner.cancel_flight-795"><span class="linenos">795</span></a>			<span class="c1">#             &#39;status of current request (triggered, processed, defused):&#39;, request.triggered,\</span>
</span><span id="AirlineFlightPlanner.cancel_flight-796"><a href="#AirlineFlightPlanner.cancel_flight-796"><span class="linenos">796</span></a>			<span class="c1">#             request.processed,\</span>
</span><span id="AirlineFlightPlanner.cancel_flight-797"><a href="#AirlineFlightPlanner.cancel_flight-797"><span class="linenos">797</span></a>			<span class="c1">#             request.defused)</span>
</span><span id="AirlineFlightPlanner.cancel_flight-798"><a href="#AirlineFlightPlanner.cancel_flight-798"><span class="linenos">798</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_cancel_flight</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">,</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_cancel_flight" class="classattr">
                                        <input id="AirlineFlightPlanner.send_cancel_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_cancel_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">reason</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_cancel_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_cancel_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_cancel_flight-800"><a href="#AirlineFlightPlanner.send_cancel_flight-800"><span class="linenos">800</span></a>	<span class="k">def</span> <span class="nf">send_cancel_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-801"><a href="#AirlineFlightPlanner.send_cancel_flight-801"><span class="linenos">801</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-802"><a href="#AirlineFlightPlanner.send_cancel_flight-802"><span class="linenos">802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-803"><a href="#AirlineFlightPlanner.send_cancel_flight-803"><span class="linenos">803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancel_flight_request&#39;</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-804"><a href="#AirlineFlightPlanner.send_cancel_flight-804"><span class="linenos">804</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-805"><a href="#AirlineFlightPlanner.send_cancel_flight-805"><span class="linenos">805</span></a>						<span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_cancel_flight-806"><a href="#AirlineFlightPlanner.send_cancel_flight-806"><span class="linenos">806</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_cancel_flight_request" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_cancel_flight_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_cancel_flight_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_cancel_flight_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_cancel_flight_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_cancel_flight_request-808"><a href="#AirlineFlightPlanner.wait_for_cancel_flight_request-808"><span class="linenos">808</span></a>	<span class="k">def</span> <span class="nf">wait_for_cancel_flight_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_cancel_flight_request-809"><a href="#AirlineFlightPlanner.wait_for_cancel_flight_request-809"><span class="linenos">809</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.check_FP_submission" class="classattr">
                                        <input id="AirlineFlightPlanner.check_FP_submission-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_FP_submission</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">FP_submission_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.check_FP_submission-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.check_FP_submission"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.check_FP_submission-811"><a href="#AirlineFlightPlanner.check_FP_submission-811"><span class="linenos">811</span></a>	<span class="k">def</span> <span class="nf">check_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP_submission_event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-812"><a href="#AirlineFlightPlanner.check_FP_submission-812"><span class="linenos">812</span></a>		<span class="k">yield</span> <span class="n">FP_submission_event</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-813"><a href="#AirlineFlightPlanner.check_FP_submission-813"><span class="linenos">813</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-814"><a href="#AirlineFlightPlanner.check_FP_submission-814"><span class="linenos">814</span></a>		<span class="c1"># 	print(&quot;{} does the first FP submission for flight {}&quot;.format(self.agent, flight_uid))</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-815"><a href="#AirlineFlightPlanner.check_FP_submission-815"><span class="linenos">815</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_FP_submission&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-816"><a href="#AirlineFlightPlanner.check_FP_submission-816"><span class="linenos">816</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.check_FP_submission-817"><a href="#AirlineFlightPlanner.check_FP_submission-817"><span class="linenos">817</span></a>													<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.compute_FP" class="classattr">
                                        <input id="AirlineFlightPlanner.compute_FP-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_FP</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">ac_ready_at_time</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">fp_options</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.compute_FP-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_FP"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.compute_FP-819"><a href="#AirlineFlightPlanner.compute_FP-819"><span class="linenos">819</span></a>	<span class="k">def</span> <span class="nf">compute_FP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fp_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.compute_FP-820"><a href="#AirlineFlightPlanner.compute_FP-820"><span class="linenos">820</span></a>		<span class="c1"># aoc_flight_info = self.agent.aoc_flights_info[flight_uid]</span>
</span><span id="AirlineFlightPlanner.compute_FP-821"><a href="#AirlineFlightPlanner.compute_FP-821"><span class="linenos">821</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes the flight plan options for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.compute_FP-822"><a href="#AirlineFlightPlanner.compute_FP-822"><span class="linenos">822</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-823"><a href="#AirlineFlightPlanner.compute_FP-823"><span class="linenos">823</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-824"><a href="#AirlineFlightPlanner.compute_FP-824"><span class="linenos">824</span></a>		<span class="c1"># 	print(&#39;\nAOC tries to find a FP for flight {} with sobt {} (t={})&#39;.format(flight_uid,</span>
</span><span id="AirlineFlightPlanner.compute_FP-825"><a href="#AirlineFlightPlanner.compute_FP-825"><span class="linenos">825</span></a>		<span class="c1"># 																				self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;],</span>
</span><span id="AirlineFlightPlanner.compute_FP-826"><a href="#AirlineFlightPlanner.compute_FP-826"><span class="linenos">826</span></a>		<span class="c1"># 																				self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner.compute_FP-827"><a href="#AirlineFlightPlanner.compute_FP-827"><span class="linenos">827</span></a>		<span class="c1"># just_computed = False</span>
</span><span id="AirlineFlightPlanner.compute_FP-828"><a href="#AirlineFlightPlanner.compute_FP-828"><span class="linenos">828</span></a>		<span class="c1"># if self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;] is None:</span>
</span><span id="AirlineFlightPlanner.compute_FP-829"><a href="#AirlineFlightPlanner.compute_FP-829"><span class="linenos">829</span></a>		<span class="c1">#  This flight does not have a flight plan yet, so it</span>
</span><span id="AirlineFlightPlanner.compute_FP-830"><a href="#AirlineFlightPlanner.compute_FP-830"><span class="linenos">830</span></a>		<span class="c1">#  needs to find one.</span>
</span><span id="AirlineFlightPlanner.compute_FP-831"><a href="#AirlineFlightPlanner.compute_FP-831"><span class="linenos">831</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-832"><a href="#AirlineFlightPlanner.compute_FP-832"><span class="linenos">832</span></a>		<span class="c1"># Compute all possible flight plan options</span>
</span><span id="AirlineFlightPlanner.compute_FP-833"><a href="#AirlineFlightPlanner.compute_FP-833"><span class="linenos">833</span></a>		<span class="k">if</span> <span class="n">fp_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-834"><a href="#AirlineFlightPlanner.compute_FP-834"><span class="linenos">834</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-835"><a href="#AirlineFlightPlanner.compute_FP-835"><span class="linenos">835</span></a>			<span class="c1"># 	print(&#39;AOC RECOMPUTES FPs FOR FLIGHT {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="AirlineFlightPlanner.compute_FP-836"><a href="#AirlineFlightPlanner.compute_FP-836"><span class="linenos">836</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-837"><a href="#AirlineFlightPlanner.compute_FP-837"><span class="linenos">837</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_FP_options</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.compute_FP-838"><a href="#AirlineFlightPlanner.compute_FP-838"><span class="linenos">838</span></a>													<span class="n">eobt</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-839"><a href="#AirlineFlightPlanner.compute_FP-839"><span class="linenos">839</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-840"><a href="#AirlineFlightPlanner.compute_FP-840"><span class="linenos">840</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.compute_FP-841"><a href="#AirlineFlightPlanner.compute_FP-841"><span class="linenos">841</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.compute_FP-842"><a href="#AirlineFlightPlanner.compute_FP-842"><span class="linenos">842</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-843"><a href="#AirlineFlightPlanner.compute_FP-843"><span class="linenos">843</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-844"><a href="#AirlineFlightPlanner.compute_FP-844"><span class="linenos">844</span></a>		<span class="c1"># 	print(&#39;ELT FOR EACH FP OPTION FOR FLIGHT {}:&#39;.format(flight_uid), [fp.get_eta_wo_atfm() for fp in fp_options])</span>
</span><span id="AirlineFlightPlanner.compute_FP-845"><a href="#AirlineFlightPlanner.compute_FP-845"><span class="linenos">845</span></a><span class="w">		</span><span class="sd">&#39;&#39;&#39;</span>
</span><span id="AirlineFlightPlanner.compute_FP-846"><a href="#AirlineFlightPlanner.compute_FP-846"><span class="linenos">846</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="AirlineFlightPlanner.compute_FP-847"><a href="#AirlineFlightPlanner.compute_FP-847"><span class="linenos">847</span></a><span class="sd">		print(&#39;FP options:&#39;)</span>
</span><span id="AirlineFlightPlanner.compute_FP-848"><a href="#AirlineFlightPlanner.compute_FP-848"><span class="linenos">848</span></a><span class="sd">		for option in fp_options:</span>
</span><span id="AirlineFlightPlanner.compute_FP-849"><a href="#AirlineFlightPlanner.compute_FP-849"><span class="linenos">849</span></a><span class="sd">			print(option)</span>
</span><span id="AirlineFlightPlanner.compute_FP-850"><a href="#AirlineFlightPlanner.compute_FP-850"><span class="linenos">850</span></a><span class="sd">			print(&#39;with eobt:&#39;, option.eobt)</span>
</span><span id="AirlineFlightPlanner.compute_FP-851"><a href="#AirlineFlightPlanner.compute_FP-851"><span class="linenos">851</span></a><span class="sd">			print(&#39;with eibt:&#39;, option.eibt)</span>
</span><span id="AirlineFlightPlanner.compute_FP-852"><a href="#AirlineFlightPlanner.compute_FP-852"><span class="linenos">852</span></a><span class="sd">		print(&#39;----------------&#39;)</span>
</span><span id="AirlineFlightPlanner.compute_FP-853"><a href="#AirlineFlightPlanner.compute_FP-853"><span class="linenos">853</span></a><span class="sd">		&#39;&#39;&#39;</span>
</span><span id="AirlineFlightPlanner.compute_FP-854"><a href="#AirlineFlightPlanner.compute_FP-854"><span class="linenos">854</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-855"><a href="#AirlineFlightPlanner.compute_FP-855"><span class="linenos">855</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner.compute_FP-856"><a href="#AirlineFlightPlanner.compute_FP-856"><span class="linenos">856</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-857"><a href="#AirlineFlightPlanner.compute_FP-857"><span class="linenos">857</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner.compute_FP-858"><a href="#AirlineFlightPlanner.compute_FP-858"><span class="linenos">858</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner.compute_FP-859"><a href="#AirlineFlightPlanner.compute_FP-859"><span class="linenos">859</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.compute_FP-860"><a href="#AirlineFlightPlanner.compute_FP-860"><span class="linenos">860</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.compute_FP-861"><a href="#AirlineFlightPlanner.compute_FP-861"><span class="linenos">861</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-862"><a href="#AirlineFlightPlanner.compute_FP-862"><span class="linenos">862</span></a>		<span class="k">while</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-863"><a href="#AirlineFlightPlanner.compute_FP-863"><span class="linenos">863</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-864"><a href="#AirlineFlightPlanner.compute_FP-864"><span class="linenos">864</span></a>			<span class="c1"># 	print(&#39;OPTION NOT FOUND FOR FLIGHT {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner.compute_FP-865"><a href="#AirlineFlightPlanner.compute_FP-865"><span class="linenos">865</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-866"><a href="#AirlineFlightPlanner.compute_FP-866"><span class="linenos">866</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner.compute_FP-867"><a href="#AirlineFlightPlanner.compute_FP-867"><span class="linenos">867</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-868"><a href="#AirlineFlightPlanner.compute_FP-868"><span class="linenos">868</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">decide_options_alternatives</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.compute_FP-869"><a href="#AirlineFlightPlanner.compute_FP-869"><span class="linenos">869</span></a>																			<span class="n">fp_options</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.compute_FP-870"><a href="#AirlineFlightPlanner.compute_FP-870"><span class="linenos">870</span></a>																			<span class="n">current_option</span><span class="o">=</span><span class="n">option</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.compute_FP-871"><a href="#AirlineFlightPlanner.compute_FP-871"><span class="linenos">871</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-872"><a href="#AirlineFlightPlanner.compute_FP-872"><span class="linenos">872</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-873"><a href="#AirlineFlightPlanner.compute_FP-873"><span class="linenos">873</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-874"><a href="#AirlineFlightPlanner.compute_FP-874"><span class="linenos">874</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-875"><a href="#AirlineFlightPlanner.compute_FP-875"><span class="linenos">875</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-876"><a href="#AirlineFlightPlanner.compute_FP-876"><span class="linenos">876</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-877"><a href="#AirlineFlightPlanner.compute_FP-877"><span class="linenos">877</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-878"><a href="#AirlineFlightPlanner.compute_FP-878"><span class="linenos">878</span></a>			<span class="c1"># 	print(&#39;AOC considers FP option {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner.compute_FP-879"><a href="#AirlineFlightPlanner.compute_FP-879"><span class="linenos">879</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-880"><a href="#AirlineFlightPlanner.compute_FP-880"><span class="linenos">880</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlineFlightPlanner.compute_FP-881"><a href="#AirlineFlightPlanner.compute_FP-881"><span class="linenos">881</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-882"><a href="#AirlineFlightPlanner.compute_FP-882"><span class="linenos">882</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-883"><a href="#AirlineFlightPlanner.compute_FP-883"><span class="linenos">883</span></a>				<span class="c1"># print(&#39;BORNE2 {} (found: {}, fp_options length: {})&#39;.format(flight_uid, found, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner.compute_FP-884"><a href="#AirlineFlightPlanner.compute_FP-884"><span class="linenos">884</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-885"><a href="#AirlineFlightPlanner.compute_FP-885"><span class="linenos">885</span></a>			<span class="c1"># An option is selected, but might not be accepted yet because</span>
</span><span id="AirlineFlightPlanner.compute_FP-886"><a href="#AirlineFlightPlanner.compute_FP-886"><span class="linenos">886</span></a>			<span class="c1"># in general it needs to have an ATFM slot. The following does exactly this.</span>
</span><span id="AirlineFlightPlanner.compute_FP-887"><a href="#AirlineFlightPlanner.compute_FP-887"><span class="linenos">887</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-888"><a href="#AirlineFlightPlanner.compute_FP-888"><span class="linenos">888</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-889"><a href="#AirlineFlightPlanner.compute_FP-889"><span class="linenos">889</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp_options[option].get_unique_id()] = received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner.compute_FP-890"><a href="#AirlineFlightPlanner.compute_FP-890"><span class="linenos">890</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-891"><a href="#AirlineFlightPlanner.compute_FP-891"><span class="linenos">891</span></a>				<span class="c1"># 	print(&#39;AOC sends ATFM request for flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner.compute_FP-892"><a href="#AirlineFlightPlanner.compute_FP-892"><span class="linenos">892</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-893"><a href="#AirlineFlightPlanner.compute_FP-893"><span class="linenos">893</span></a>				<span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;submitted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-894"><a href="#AirlineFlightPlanner.compute_FP-894"><span class="linenos">894</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner.compute_FP-895"><a href="#AirlineFlightPlanner.compute_FP-895"><span class="linenos">895</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-896"><a href="#AirlineFlightPlanner.compute_FP-896"><span class="linenos">896</span></a>				<span class="c1"># 	print(&#39;BORNE4 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner.compute_FP-897"><a href="#AirlineFlightPlanner.compute_FP-897"><span class="linenos">897</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-898"><a href="#AirlineFlightPlanner.compute_FP-898"><span class="linenos">898</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;has made a decision. Cancellation:&quot;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span> <span class="s1">&#39;; option chosen:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="s2">&quot;among&quot;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-899"><a href="#AirlineFlightPlanner.compute_FP-899"><span class="linenos">899</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-900"><a href="#AirlineFlightPlanner.compute_FP-900"><span class="linenos">900</span></a>		<span class="c1"># 	print(&quot;AOC has reached a decision. Cancellation:&quot;,</span>
</span><span id="AirlineFlightPlanner.compute_FP-901"><a href="#AirlineFlightPlanner.compute_FP-901"><span class="linenos">901</span></a>		<span class="c1"># 				cancellation,</span>
</span><span id="AirlineFlightPlanner.compute_FP-902"><a href="#AirlineFlightPlanner.compute_FP-902"><span class="linenos">902</span></a>		<span class="c1"># 				&#39;; option chosen:&#39;,</span>
</span><span id="AirlineFlightPlanner.compute_FP-903"><a href="#AirlineFlightPlanner.compute_FP-903"><span class="linenos">903</span></a>		<span class="c1"># 				option,</span>
</span><span id="AirlineFlightPlanner.compute_FP-904"><a href="#AirlineFlightPlanner.compute_FP-904"><span class="linenos">904</span></a>		<span class="c1"># 				&quot;among&quot;,</span>
</span><span id="AirlineFlightPlanner.compute_FP-905"><a href="#AirlineFlightPlanner.compute_FP-905"><span class="linenos">905</span></a>		<span class="c1"># 				fp_options,</span>
</span><span id="AirlineFlightPlanner.compute_FP-906"><a href="#AirlineFlightPlanner.compute_FP-906"><span class="linenos">906</span></a>		<span class="c1"># 				&#39; ; ETA without ATFM delay:&#39;,</span>
</span><span id="AirlineFlightPlanner.compute_FP-907"><a href="#AirlineFlightPlanner.compute_FP-907"><span class="linenos">907</span></a>		<span class="c1"># 				fp_options[option].get_eta_wo_atfm())</span>
</span><span id="AirlineFlightPlanner.compute_FP-908"><a href="#AirlineFlightPlanner.compute_FP-908"><span class="linenos">908</span></a>		<span class="c1"># 	# print(&#39;OPTION CHOSEN FOR FLIGHT (ETA without ATFM delay):&#39;, option, fp_options[option].get_eta_wo_atfm())</span>
</span><span id="AirlineFlightPlanner.compute_FP-909"><a href="#AirlineFlightPlanner.compute_FP-909"><span class="linenos">909</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-910"><a href="#AirlineFlightPlanner.compute_FP-910"><span class="linenos">910</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="AirlineFlightPlanner.compute_FP-911"><a href="#AirlineFlightPlanner.compute_FP-911"><span class="linenos">911</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner.compute_FP-912"><a href="#AirlineFlightPlanner.compute_FP-912"><span class="linenos">912</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP-913"><a href="#AirlineFlightPlanner.compute_FP-913"><span class="linenos">913</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-914"><a href="#AirlineFlightPlanner.compute_FP-914"><span class="linenos">914</span></a>		<span class="k">if</span> <span class="n">cancellation</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-915"><a href="#AirlineFlightPlanner.compute_FP-915"><span class="linenos">915</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_FP-916"><a href="#AirlineFlightPlanner.compute_FP-916"><span class="linenos">916</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-917"><a href="#AirlineFlightPlanner.compute_FP-917"><span class="linenos">917</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP-918"><a href="#AirlineFlightPlanner.compute_FP-918"><span class="linenos">918</span></a>			<span class="c1"># If accepted, mark it as the FP adopted and send an FP submission.</span>
</span><span id="AirlineFlightPlanner.compute_FP-919"><a href="#AirlineFlightPlanner.compute_FP-919"><span class="linenos">919</span></a>			<span class="n">reception_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-920"><a href="#AirlineFlightPlanner.compute_FP-920"><span class="linenos">920</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-921"><a href="#AirlineFlightPlanner.compute_FP-921"><span class="linenos">921</span></a>			<span class="c1"># 	print(&#39;AOC submits flight plan {} for flight {}&#39;.format(fp_options[option], flight_uid))</span>
</span><span id="AirlineFlightPlanner.compute_FP-922"><a href="#AirlineFlightPlanner.compute_FP-922"><span class="linenos">922</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">],</span> <span class="n">reception_event</span><span class="o">=</span><span class="n">reception_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP-923"><a href="#AirlineFlightPlanner.compute_FP-923"><span class="linenos">923</span></a>			<span class="k">yield</span> <span class="n">reception_event</span>
</span><span id="AirlineFlightPlanner.compute_FP-924"><a href="#AirlineFlightPlanner.compute_FP-924"><span class="linenos">924</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-925"><a href="#AirlineFlightPlanner.compute_FP-925"><span class="linenos">925</span></a>			<span class="c1"># Then consider potential flight swapping.</span>
</span><span id="AirlineFlightPlanner.compute_FP-926"><a href="#AirlineFlightPlanner.compute_FP-926"><span class="linenos">926</span></a>			<span class="c1"># BEWARE: the flight plan needs to be already accepted and returned before</span>
</span><span id="AirlineFlightPlanner.compute_FP-927"><a href="#AirlineFlightPlanner.compute_FP-927"><span class="linenos">927</span></a>			<span class="c1"># the airline considers the flight swapping.</span>
</span><span id="AirlineFlightPlanner.compute_FP-928"><a href="#AirlineFlightPlanner.compute_FP-928"><span class="linenos">928</span></a>			<span class="c1"># self.consider_flight_swap(flight_uid, fp_options[option])</span>
</span><span id="AirlineFlightPlanner.compute_FP-929"><a href="#AirlineFlightPlanner.compute_FP-929"><span class="linenos">929</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-930"><a href="#AirlineFlightPlanner.compute_FP-930"><span class="linenos">930</span></a>		<span class="c1"># just_computed = True</span>
</span><span id="AirlineFlightPlanner.compute_FP-931"><a href="#AirlineFlightPlanner.compute_FP-931"><span class="linenos">931</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-932"><a href="#AirlineFlightPlanner.compute_FP-932"><span class="linenos">932</span></a>		<span class="c1"># if (not cancellation) and (ac_ready_at_time is None) and (self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;] is not None):</span>
</span><span id="AirlineFlightPlanner.compute_FP-933"><a href="#AirlineFlightPlanner.compute_FP-933"><span class="linenos">933</span></a>		<span class="c1"># 	# We got the ac_ready time before the first flight plan submitted. Update ac_ready_time</span>
</span><span id="AirlineFlightPlanner.compute_FP-934"><a href="#AirlineFlightPlanner.compute_FP-934"><span class="linenos">934</span></a>		<span class="c1"># 	self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].reactionary_delay = self.agent.aoc_flights_info[flight_uid][&#39;reactionary_delay_prior_FP&#39;]</span>
</span><span id="AirlineFlightPlanner.compute_FP-935"><a href="#AirlineFlightPlanner.compute_FP-935"><span class="linenos">935</span></a>		<span class="c1"># 	ac_ready_at_time = self.agent.aoc_flights_info[flight_uid][&#39;ac_ready_time_prior_FP&#39;]</span>
</span><span id="AirlineFlightPlanner.compute_FP-936"><a href="#AirlineFlightPlanner.compute_FP-936"><span class="linenos">936</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-937"><a href="#AirlineFlightPlanner.compute_FP-937"><span class="linenos">937</span></a>		<span class="c1"># #if (not cancellation) and (not ac_ready_at_time is None) and (not just_computed):</span>
</span><span id="AirlineFlightPlanner.compute_FP-938"><a href="#AirlineFlightPlanner.compute_FP-938"><span class="linenos">938</span></a>		<span class="c1"># 	#mprint(flight_str(flight_uid), &#39;has an ac_ready_time of&#39;, ac_ready_at_time)</span>
</span><span id="AirlineFlightPlanner.compute_FP-939"><a href="#AirlineFlightPlanner.compute_FP-939"><span class="linenos">939</span></a>		<span class="c1"># 	# This flight has a flight plan and it is a recomputation that might be needed</span>
</span><span id="AirlineFlightPlanner.compute_FP-940"><a href="#AirlineFlightPlanner.compute_FP-940"><span class="linenos">940</span></a>		<span class="c1"># 	current_fp = self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;]#[&#39;fp_options&#39;][self.agent.aoc_flights_info[flight_uid][&#39;fp_option&#39;]]</span>
</span><span id="AirlineFlightPlanner.compute_FP-941"><a href="#AirlineFlightPlanner.compute_FP-941"><span class="linenos">941</span></a>		<span class="c1"># 	new_eobt = max(ac_ready_at_time, current_fp.eobt)</span>
</span><span id="AirlineFlightPlanner.compute_FP-942"><a href="#AirlineFlightPlanner.compute_FP-942"><span class="linenos">942</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-943"><a href="#AirlineFlightPlanner.compute_FP-943"><span class="linenos">943</span></a>		<span class="c1"># 	# if not (new_eobt==current_fp.eobt and just_computed):</span>
</span><span id="AirlineFlightPlanner.compute_FP-944"><a href="#AirlineFlightPlanner.compute_FP-944"><span class="linenos">944</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-945"><a href="#AirlineFlightPlanner.compute_FP-945"><span class="linenos">945</span></a>		<span class="c1"># 	 	print(&#39;AOC will update EOBT of flight {} because the aircraft was not ready in time (OLD EOBT IS {}, NEW EOBT IS {}, OLD ELT IS {})&#39;.format(flight_uid, current_fp.eobt, new_eobt, current_fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner.compute_FP-946"><a href="#AirlineFlightPlanner.compute_FP-946"><span class="linenos">946</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-947"><a href="#AirlineFlightPlanner.compute_FP-947"><span class="linenos">947</span></a>		<span class="c1"># 	mprint(flight_str(flight_uid), &#39;has a new eobt of&#39;, new_eobt,</span>
</span><span id="AirlineFlightPlanner.compute_FP-948"><a href="#AirlineFlightPlanner.compute_FP-948"><span class="linenos">948</span></a>		<span class="c1"># 		&#39;and resubmits its flight plan.&#39;)</span>
</span><span id="AirlineFlightPlanner.compute_FP-949"><a href="#AirlineFlightPlanner.compute_FP-949"><span class="linenos">949</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-950"><a href="#AirlineFlightPlanner.compute_FP-950"><span class="linenos">950</span></a>		<span class="c1"># 	current_fp.update_eobt(new_eobt)</span>
</span><span id="AirlineFlightPlanner.compute_FP-951"><a href="#AirlineFlightPlanner.compute_FP-951"><span class="linenos">951</span></a>		<span class="c1"># 	if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP-952"><a href="#AirlineFlightPlanner.compute_FP-952"><span class="linenos">952</span></a>		<span class="c1"># 		print(&#39;AOC has modified the flight plan ({}) EOBT for flight {} and resubmits it (ELT IS {})&#39;.format(flight_uid, current_fp, current_fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner.compute_FP-953"><a href="#AirlineFlightPlanner.compute_FP-953"><span class="linenos">953</span></a>
</span><span id="AirlineFlightPlanner.compute_FP-954"><a href="#AirlineFlightPlanner.compute_FP-954"><span class="linenos">954</span></a>		<span class="c1"># 	self.send_flight_plan_submission(flight_uid, current_fp)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.compute_FP_options_from_fp_pool" class="classattr">
                                        <input id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_FP_options_from_fp_pool</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">aoc_flight_info</span>, </span><span class="param"><span class="n">eobt</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.compute_FP_options_from_fp_pool-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-956"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-956"><span class="linenos"> 956</span></a>	<span class="k">def</span> <span class="nf">compute_FP_options_from_fp_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">,</span> <span class="n">eobt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-957"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-957"><span class="linenos"> 957</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is creating the possible flight plans for flight&#39;</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-958"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-958"><span class="linenos"> 958</span></a>		<span class="c1"># if aoc_flight_info[&#39;flight_uid&#39;] in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-959"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-959"><span class="linenos"> 959</span></a>		<span class="c1"># 	print(&quot;{} compute the FP options from fp pool for flight {} with EOBT {}&quot;.format(self.agent, aoc_flight_info[&#39;flight_uid&#39;], eobt))</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-960"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-960"><span class="linenos"> 960</span></a>		<span class="k">if</span> <span class="n">eobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-961"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-961"><span class="linenos"> 961</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-962"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-962"><span class="linenos"> 962</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-963"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-963"><span class="linenos"> 963</span></a>			<span class="n">eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eobt</span><span class="p">,</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-964"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-964"><span class="linenos"> 964</span></a>		<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-965"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-965"><span class="linenos"> 965</span></a>		<span class="n">destination_airport_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-966"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-966"><span class="linenos"> 966</span></a>		<span class="c1"># ac_performances_bada = aoc_flight_info[&#39;aircraft&#39;].bada_performances</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-967"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-967"><span class="linenos"> 967</span></a>		<span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">bada_code_ac_model</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-968"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-968"><span class="linenos"> 968</span></a>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-969"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-969"><span class="linenos"> 969</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-970"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-970"><span class="linenos"> 970</span></a>			<span class="n">possible_fp_pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="p">[(</span><span class="n">origin_airport_uid</span><span class="p">,</span> <span class="n">destination_airport_uid</span><span class="p">,</span> <span class="n">bada_code_ac_model</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-971"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-971"><span class="linenos"> 971</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-972"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-972"><span class="linenos"> 972</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COICOIN&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_pool</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-973"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-973"><span class="linenos"> 973</span></a>			<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-974"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-974"><span class="linenos"> 974</span></a>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-975"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-975"><span class="linenos"> 975</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-976"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-976"><span class="linenos"> 976</span></a>		<span class="k">for</span> <span class="n">pfp</span> <span class="ow">in</span> <span class="n">possible_fp_pool</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-977"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-977"><span class="linenos"> 977</span></a>			<span class="n">fp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">pfp</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-978"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-978"><span class="linenos"> 978</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-979"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-979"><span class="linenos"> 979</span></a>			<span class="c1"># fp.eobt = aoc_flight_info[&#39;sobt&#39;]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-980"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-980"><span class="linenos"> 980</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">eobt</span> <span class="o">=</span> <span class="n">eobt</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-981"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-981"><span class="linenos"> 981</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-982"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-982"><span class="linenos"> 982</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">sibt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-983"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-983"><span class="linenos"> 983</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_out_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-984"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-984"><span class="linenos"> 984</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">destination_airport_uid</span><span class="p">][</span><span class="s1">&#39;avg_taxi_in_time&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-985"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-985"><span class="linenos"> 985</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">bada_code_ac_model</span> <span class="o">=</span> <span class="n">bada_code_ac_model</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-986"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-986"><span class="linenos"> 986</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">flight_uid</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-987"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-987"><span class="linenos"> 987</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-988"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-988"><span class="linenos"> 988</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">compute_eibt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-989"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-989"><span class="linenos"> 989</span></a>			<span class="n">fp</span><span class="o">.</span><span class="n">add_event_to_point</span><span class="p">(</span><span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;takeoff_event&#39;</span><span class="p">],</span> <span class="s1">&#39;takeoff&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-990"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-990"><span class="linenos"> 990</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">get_unique_id</span><span class="p">()]</span> <span class="o">=</span> <span class="n">fp</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-991"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-991"><span class="linenos"> 991</span></a>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-992"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-992"><span class="linenos"> 992</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options</span> <span class="o">+</span> <span class="p">[</span><span class="n">fp</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-993"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-993"><span class="linenos"> 993</span></a>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-994"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-994"><span class="linenos"> 994</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">remove_shorter_route_calibration</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-995"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-995"><span class="linenos"> 995</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-996"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-996"><span class="linenos"> 996</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="p">[(</span><span class="n">option</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">get_total_planned_distance</span><span class="p">())</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-997"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-997"><span class="linenos"> 997</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-998"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-998"><span class="linenos"> 998</span></a>				<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">fp_options</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-999"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-999"><span class="linenos"> 999</span></a>
</span><span id="AirlineFlightPlanner.compute_FP_options_from_fp_pool-1000"><a href="#AirlineFlightPlanner.compute_FP_options_from_fp_pool-1000"><span class="linenos">1000</span></a>		<span class="k">return</span> <span class="n">fp_options</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.estimate_curfew_buffer_old" class="classattr">
                                        <input id="AirlineFlightPlanner.estimate_curfew_buffer_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_curfew_buffer_old</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.estimate_curfew_buffer_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.estimate_curfew_buffer_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1002"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1002"><span class="linenos">1002</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1003"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1003"><span class="linenos">1003</span></a>		<span class="n">buf</span> <span class="o">=</span> <span class="mi">999999999991</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1004"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1004"><span class="linenos">1004</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1005"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1005"><span class="linenos">1005</span></a>			<span class="c1"># Get minimum buffer to avoid curfews on downstream flights</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1006"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1006"><span class="linenos">1006</span></a>			<span class="c1"># Note: not taking into account curfew for this flight, because flight plan</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1007"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1007"><span class="linenos">1007</span></a>			<span class="c1"># has been accepted and thus should be legit (arriving before curfew).</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1008"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1008"><span class="linenos">1008</span></a>			<span class="c1"># Get all flights after this one using the same aircraft</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1009"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1009"><span class="linenos">1009</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1010"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1010"><span class="linenos">1010</span></a>			<span class="n">next_flights</span> <span class="o">=</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1011"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1011"><span class="linenos">1011</span></a>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1012"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1012"><span class="linenos">1012</span></a>			<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">flight</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">next_flights</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1013"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1013"><span class="linenos">1013</span></a>				<span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1014"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1014"><span class="linenos">1014</span></a>					<span class="n">buf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1015"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1015"><span class="linenos">1015</span></a>				<span class="n">buf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight</span><span class="p">),</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1016"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1016"><span class="linenos">1016</span></a>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1017"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1017"><span class="linenos">1017</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Buffer computed for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_old-1018"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_old-1018"><span class="linenos">1018</span></a>		<span class="k">return</span> <span class="n">buf</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.estimate_curfew_buffer" class="classattr">
                                        <input id="AirlineFlightPlanner.estimate_curfew_buffer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_curfew_buffer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.estimate_curfew_buffer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.estimate_curfew_buffer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.estimate_curfew_buffer-1020"><a href="#AirlineFlightPlanner.estimate_curfew_buffer-1020"><span class="linenos">1020</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer-1021"><a href="#AirlineFlightPlanner.estimate_curfew_buffer-1021"><span class="linenos">1021</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer-1022"><a href="#AirlineFlightPlanner.estimate_curfew_buffer-1022"><span class="linenos">1022</span></a>			<span class="k">return</span> <span class="mi">999999999991</span><span class="p">,</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer-1023"><a href="#AirlineFlightPlanner.estimate_curfew_buffer-1023"><span class="linenos">1023</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer-1024"><a href="#AirlineFlightPlanner.estimate_curfew_buffer-1024"><span class="linenos">1024</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.estimate_curfew_buffer_rec" class="classattr">
                                        <input id="AirlineFlightPlanner.estimate_curfew_buffer_rec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_curfew_buffer_rec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.estimate_curfew_buffer_rec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.estimate_curfew_buffer_rec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1026"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1026"><span class="linenos">1026</span></a>	<span class="k">def</span> <span class="nf">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1027"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1027"><span class="linenos">1027</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="s1">&#39;can_propagate_to_curfew&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1028"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1028"><span class="linenos">1028</span></a>			<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1029"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1029"><span class="linenos">1029</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1030"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1030"><span class="linenos">1030</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1031"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1031"><span class="linenos">1031</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1032"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1032"><span class="linenos">1032</span></a>				<span class="n">curfew_buffer_downstream</span><span class="p">,</span> <span class="n">flight_uid_propagates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer_rec</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1033"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1033"><span class="linenos">1033</span></a>			<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1034"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1034"><span class="linenos">1034</span></a>				<span class="c1"># There is no next flight, the reason is because that flight has been cancelled. Therefore, you are not propagating anymore</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1035"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1035"><span class="linenos">1035</span></a>				<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1036"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1036"><span class="linenos">1036</span></a>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1037"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1037"><span class="linenos">1037</span></a>			<span class="n">propaget_to_curfew</span> <span class="o">=</span> <span class="n">curfew_buffer_downstream</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_reactionary_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1038"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1038"><span class="linenos">1038</span></a>			<span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)])</span>
</span><span id="AirlineFlightPlanner.estimate_curfew_buffer_rec-1039"><a href="#AirlineFlightPlanner.estimate_curfew_buffer_rec-1039"><span class="linenos">1039</span></a>			<span class="k">return</span> <span class="p">[</span><span class="n">propaget_to_curfew</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">flight_uid_propagates</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_heuristic" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_heuristic</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_heuristic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1041"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1041"><span class="linenos">1041</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1042"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1042"><span class="linenos">1042</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1043"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1043"><span class="linenos">1043</span></a>		<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1044"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1044"><span class="linenos">1044</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1045"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1045"><span class="linenos">1045</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1046"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1046"><span class="linenos">1046</span></a><span class="sd">		to scheduled departure or scheduled arrival) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1047"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1047"><span class="linenos">1047</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1048"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1048"><span class="linenos">1048</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1049"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1049"><span class="linenos">1049</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1050"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1050"><span class="linenos">1050</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1051"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1051"><span class="linenos">1051</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1052"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1052"><span class="linenos">1052</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1053"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1053"><span class="linenos">1053</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1054"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1054"><span class="linenos">1054</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1055"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1055"><span class="linenos">1055</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1056"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1056"><span class="linenos">1056</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1057"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1057"><span class="linenos">1057</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1058"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1058"><span class="linenos">1058</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1059"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1059"><span class="linenos">1059</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1060"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1060"><span class="linenos">1060</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1061"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1061"><span class="linenos">1061</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1062"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1062"><span class="linenos">1062</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1063"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1063"><span class="linenos">1063</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1064"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1064"><span class="linenos">1064</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1065"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1065"><span class="linenos">1065</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1066"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1066"><span class="linenos">1066</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1067"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1067"><span class="linenos">1067</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1068"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1068"><span class="linenos">1068</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1069"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1069"><span class="linenos">1069</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1070"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1070"><span class="linenos">1070</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1071"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1071"><span class="linenos">1071</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1072"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1072"><span class="linenos">1072</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1073"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1073"><span class="linenos">1073</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1074"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1074"><span class="linenos">1074</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1075"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1075"><span class="linenos">1075</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1076"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1076"><span class="linenos">1076</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1077"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1077"><span class="linenos">1077</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1078"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1078"><span class="linenos">1078</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1079"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1079"><span class="linenos">1079</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1080"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1080"><span class="linenos">1080</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1081"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1081"><span class="linenos">1081</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1082"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1082"><span class="linenos">1082</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1083"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1083"><span class="linenos">1083</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1084"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1084"><span class="linenos">1084</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1085"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1085"><span class="linenos">1085</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1086"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1086"><span class="linenos">1086</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1087"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1087"><span class="linenos">1087</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1088"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1088"><span class="linenos">1088</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1089"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1089"><span class="linenos">1089</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1090"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1090"><span class="linenos">1090</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1091"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1091"><span class="linenos">1091</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1092"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1092"><span class="linenos">1092</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1093"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1093"><span class="linenos">1093</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1094"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1094"><span class="linenos">1094</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1095"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1095"><span class="linenos">1095</span></a>			<span class="c1"># X is the arrival (or departure delay?) with respect to schedule</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1096"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1096"><span class="linenos">1096</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1097"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1097"><span class="linenos">1097</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1098"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1098"><span class="linenos">1098</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1099"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1099"><span class="linenos">1099</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1100"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1100"><span class="linenos">1100</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1101"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1101"><span class="linenos">1101</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1102"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1102"><span class="linenos">1102</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1103"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1103"><span class="linenos">1103</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1104"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1104"><span class="linenos">1104</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1105"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1105"><span class="linenos">1105</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1106"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1106"><span class="linenos">1106</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1107"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1107"><span class="linenos">1107</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1108"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1108"><span class="linenos">1108</span></a>						<span class="k">if</span> <span class="ow">not</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1109"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1109"><span class="linenos">1109</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1110"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1110"><span class="linenos">1110</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1111"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1111"><span class="linenos">1111</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1112"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1112"><span class="linenos">1112</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1113"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1113"><span class="linenos">1113</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1114"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1114"><span class="linenos">1114</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1115"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1115"><span class="linenos">1115</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1116"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1116"><span class="linenos">1116</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1117"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1117"><span class="linenos">1117</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1118"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1118"><span class="linenos">1118</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1119"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1119"><span class="linenos">1119</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1120"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1120"><span class="linenos">1120</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1121"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1121"><span class="linenos">1121</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1122"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1122"><span class="linenos">1122</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1123"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1123"><span class="linenos">1123</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1124"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1124"><span class="linenos">1124</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1125"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1125"><span class="linenos">1125</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1126"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1126"><span class="linenos">1126</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1127"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1127"><span class="linenos">1127</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1128"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1128"><span class="linenos">1128</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1129"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1129"><span class="linenos">1129</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1130"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1130"><span class="linenos">1130</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1131"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1131"><span class="linenos">1131</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1132"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1132"><span class="linenos">1132</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1133"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1133"><span class="linenos">1133</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1134"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1134"><span class="linenos">1134</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1135"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1135"><span class="linenos">1135</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1136"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1136"><span class="linenos">1136</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1137"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1137"><span class="linenos">1137</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1138"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1138"><span class="linenos">1138</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1139"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1139"><span class="linenos">1139</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1140"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1140"><span class="linenos">1140</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1141"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1141"><span class="linenos">1141</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1142"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1142"><span class="linenos">1142</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1143"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1143"><span class="linenos">1143</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1144"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1144"><span class="linenos">1144</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1145"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1145"><span class="linenos">1145</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1146"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1146"><span class="linenos">1146</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1147"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1147"><span class="linenos">1147</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1148"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1148"><span class="linenos">1148</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1149"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1149"><span class="linenos">1149</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1150"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1150"><span class="linenos">1150</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1151"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1151"><span class="linenos">1151</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1152"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1152"><span class="linenos">1152</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1153"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1153"><span class="linenos">1153</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1154"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1154"><span class="linenos">1154</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1155"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1155"><span class="linenos">1155</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1156"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1156"><span class="linenos">1156</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1157"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1157"><span class="linenos">1157</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1158"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1158"><span class="linenos">1158</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1159"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1159"><span class="linenos">1159</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1160"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1160"><span class="linenos">1160</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1161"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1161"><span class="linenos">1161</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1162"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1162"><span class="linenos">1162</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1163"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1163"><span class="linenos">1163</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1164"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1164"><span class="linenos">1164</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1165"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1165"><span class="linenos">1165</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1166"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1166"><span class="linenos">1166</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1167"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1167"><span class="linenos">1167</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic-1168"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic-1168"><span class="linenos">1168</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>This builds a cost function (function of delay with respect
to scheduled departure or scheduled arrival) for a given flight, given the last
available information. It uses a heuristic for knock-on effect</p>

<p>To facilitate computation, some (fixed) delays can be factored in already.
For instance, if one needs a function which depends only on ATFM delay,
the non-ATFM delay can be added on the fly to the function.</p>

<p>Likewise, different types of costs can be taken into account. For instance,
if one needs only the cost of of delay related to pax costs, the function
outputs only this cost.</p>

<p>'diff' is used when there is a factor in and one wants only the diff between
the cost with all</p>

<p>If 'missed_connections' is used, an estimation on the number of pax missing their next flights
is done, and the corresponding cost used, considering that they all miss their flights and
have no other itinerary.</p>

<p>Note: if implementation is too slow, can speed it up by putting the if
statements outside the function and build different functions.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_heuristic_flight</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1170"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1170"><span class="linenos">1170</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1171"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1171"><span class="linenos">1171</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1172"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1172"><span class="linenos">1172</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1173"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1173"><span class="linenos">1173</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1174"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1174"><span class="linenos">1174</span></a><span class="sd">		VERSION ONLY WITH FLIGHT COST</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1175"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1175"><span class="linenos">1175</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1176"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1176"><span class="linenos">1176</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1177"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1177"><span class="linenos">1177</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1178"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1178"><span class="linenos">1178</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1179"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1179"><span class="linenos">1179</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1180"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1180"><span class="linenos">1180</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1181"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1181"><span class="linenos">1181</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1182"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1182"><span class="linenos">1182</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1183"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1183"><span class="linenos">1183</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1184"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1184"><span class="linenos">1184</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1185"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1185"><span class="linenos">1185</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1186"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1186"><span class="linenos">1186</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1187"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1187"><span class="linenos">1187</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1188"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1188"><span class="linenos">1188</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1189"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1189"><span class="linenos">1189</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1190"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1190"><span class="linenos">1190</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1191"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1191"><span class="linenos">1191</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1192"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1192"><span class="linenos">1192</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1193"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1193"><span class="linenos">1193</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1194"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1194"><span class="linenos">1194</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1195"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1195"><span class="linenos">1195</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1196"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1196"><span class="linenos">1196</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1197"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1197"><span class="linenos">1197</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1198"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1198"><span class="linenos">1198</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1199"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1199"><span class="linenos">1199</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1200"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1200"><span class="linenos">1200</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1201"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1201"><span class="linenos">1201</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1202"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1202"><span class="linenos">1202</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1203"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1203"><span class="linenos">1203</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1204"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1204"><span class="linenos">1204</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1205"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1205"><span class="linenos">1205</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1206"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1206"><span class="linenos">1206</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1207"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1207"><span class="linenos">1207</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1208"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1208"><span class="linenos">1208</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1209"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1209"><span class="linenos">1209</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1210"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1210"><span class="linenos">1210</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1211"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1211"><span class="linenos">1211</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1212"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1212"><span class="linenos">1212</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1213"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1213"><span class="linenos">1213</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1214"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1214"><span class="linenos">1214</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1215"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1215"><span class="linenos">1215</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1216"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1216"><span class="linenos">1216</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1217"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1217"><span class="linenos">1217</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1218"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1218"><span class="linenos">1218</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1219"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1219"><span class="linenos">1219</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1220"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1220"><span class="linenos">1220</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1221"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1221"><span class="linenos">1221</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1222"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1222"><span class="linenos">1222</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1223"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1223"><span class="linenos">1223</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1224"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1224"><span class="linenos">1224</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1225"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1225"><span class="linenos">1225</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1226"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1226"><span class="linenos">1226</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1227"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1227"><span class="linenos">1227</span></a>											<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1228"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1228"><span class="linenos">1228</span></a>											<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1229"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1229"><span class="linenos">1229</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1230"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1230"><span class="linenos">1230</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1231"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1231"><span class="linenos">1231</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1232"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1232"><span class="linenos">1232</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>  <span class="c1"># + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1233"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1233"><span class="linenos">1233</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1234"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1234"><span class="linenos">1234</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1235"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1235"><span class="linenos">1235</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1236"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1236"><span class="linenos">1236</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span>  <span class="c1"># + cost_soft_cost + cost_doc + cost_compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1237"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1237"><span class="linenos">1237</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1238"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1238"><span class="linenos">1238</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1239"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1239"><span class="linenos">1239</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1240"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1240"><span class="linenos">1240</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1241"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1241"><span class="linenos">1241</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1242"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1242"><span class="linenos">1242</span></a>																										  <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1243"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1243"><span class="linenos">1243</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1244"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1244"><span class="linenos">1244</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1245"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1245"><span class="linenos">1245</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1246"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1246"><span class="linenos">1246</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1247"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1247"><span class="linenos">1247</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1248"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1248"><span class="linenos">1248</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1249"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1249"><span class="linenos">1249</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1250"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1250"><span class="linenos">1250</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1251"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1251"><span class="linenos">1251</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1252"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1252"><span class="linenos">1252</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1253"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1253"><span class="linenos">1253</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1254"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1254"><span class="linenos">1254</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1255"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1255"><span class="linenos">1255</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1256"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1256"><span class="linenos">1256</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1257"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1257"><span class="linenos">1257</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1258"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1258"><span class="linenos">1258</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1259"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1259"><span class="linenos">1259</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1260"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1260"><span class="linenos">1260</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1261"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1261"><span class="linenos">1261</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1262"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1262"><span class="linenos">1262</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1263"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1263"><span class="linenos">1263</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1264"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1264"><span class="linenos">1264</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1265"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_flight-1265"><span class="linenos">1265</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>VERSION ONLY WITH FLIGHT COST</p>

<p>This builds a cost function (function of delay with respect
to scheduled departure) for a given flight, given the last
available information. It uses a heuristic for knock-on effect</p>

<p>To facilitate computation, some (fixed) delays can be factored in already.
For instance, if one needs a function which depends only on ATFM delay,
the non-ATFM delay can be added on the fly to the function.</p>

<p>Likewise, different types of costs can be taken into account. For instance,
if one needs only the cost of of delay related to pax costs, the function
outputs only this cost.</p>

<p>'diff' is used when there is a factor in and one wants only the diff between
the cost with all</p>

<p>If 'missed_connections' is used, an estimation on the number of pax missing their next flights
is done, and the corresponding cost used, considering that they all miss their flights and
have no other itinerary.</p>

<p>Note: if implementation is too slow, can speed it up by putting the if
statements outside the function and build different functions.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_heuristic_pax</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1267"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1267"><span class="linenos">1267</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_heuristic_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1268"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1268"><span class="linenos">1268</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1269"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1269"><span class="linenos">1269</span></a>		<span class="n">multiply_flights_after</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1270"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1270"><span class="linenos">1270</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1271"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1271"><span class="linenos">1271</span></a><span class="sd">		VERSION ONLY WITH PAX COST</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1272"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1272"><span class="linenos">1272</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1273"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1273"><span class="linenos">1273</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1274"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1274"><span class="linenos">1274</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1275"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1275"><span class="linenos">1275</span></a><span class="sd">		available information. It uses a heuristic for knock-on effect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1276"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1276"><span class="linenos">1276</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1277"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1277"><span class="linenos">1277</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factored in already.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1278"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1278"><span class="linenos">1278</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1279"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1279"><span class="linenos">1279</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1280"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1280"><span class="linenos">1280</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1281"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1281"><span class="linenos">1281</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1282"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1282"><span class="linenos">1282</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1283"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1283"><span class="linenos">1283</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1284"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1284"><span class="linenos">1284</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1285"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1285"><span class="linenos">1285</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1286"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1286"><span class="linenos">1286</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1287"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1287"><span class="linenos">1287</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1288"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1288"><span class="linenos">1288</span></a><span class="sd">		If &#39;missed_connections&#39; is used, an estimation on the number of pax missing their next flights</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1289"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1289"><span class="linenos">1289</span></a><span class="sd">		is done, and the corresponding cost used, considering that they all miss their flights and</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1290"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1290"><span class="linenos">1290</span></a><span class="sd">		have no other itinerary.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1291"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1291"><span class="linenos">1291</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1292"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1292"><span class="linenos">1292</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1293"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1293"><span class="linenos">1293</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1294"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1294"><span class="linenos">1294</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1295"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1295"><span class="linenos">1295</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1296"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1296"><span class="linenos">1296</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1297"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1297"><span class="linenos">1297</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1298"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1298"><span class="linenos">1298</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1299"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1299"><span class="linenos">1299</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1300"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1300"><span class="linenos">1300</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1301"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1301"><span class="linenos">1301</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1302"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1302"><span class="linenos">1302</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1303"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1303"><span class="linenos">1303</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline_obt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1304"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1304"><span class="linenos">1304</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1305"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1305"><span class="linenos">1305</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1306"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1306"><span class="linenos">1306</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1307"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1307"><span class="linenos">1307</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1308"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1308"><span class="linenos">1308</span></a>			<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1309"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1309"><span class="linenos">1309</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1310"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1310"><span class="linenos">1310</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1311"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1311"><span class="linenos">1311</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1312"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1312"><span class="linenos">1312</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1313"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1313"><span class="linenos">1313</span></a>			<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1314"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1314"><span class="linenos">1314</span></a>				<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1315"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1315"><span class="linenos">1315</span></a>				<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1316"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1316"><span class="linenos">1316</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1317"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1317"><span class="linenos">1317</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1318"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1318"><span class="linenos">1318</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1319"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1319"><span class="linenos">1319</span></a>		<span class="c1"># Get buffer size and flight potentially hitting the curfew.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1320"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1320"><span class="linenos">1320</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1321"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1321"><span class="linenos">1321</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1322"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1322"><span class="linenos">1322</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1323"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1323"><span class="linenos">1323</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1324"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1324"><span class="linenos">1324</span></a>				<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1325"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1325"><span class="linenos">1325</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1326"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1326"><span class="linenos">1326</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1327"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1327"><span class="linenos">1327</span></a>				<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1328"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1328"><span class="linenos">1328</span></a>				<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1329"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1329"><span class="linenos">1329</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1330"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1330"><span class="linenos">1330</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1331"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1331"><span class="linenos">1331</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1332"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1332"><span class="linenos">1332</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1333"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1333"><span class="linenos">1333</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1334"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1334"><span class="linenos">1334</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1335"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1335"><span class="linenos">1335</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1336"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1336"><span class="linenos">1336</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1337"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1337"><span class="linenos">1337</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1338"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1338"><span class="linenos">1338</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1339"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1339"><span class="linenos">1339</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1340"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1340"><span class="linenos">1340</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1341"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1341"><span class="linenos">1341</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1342"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1342"><span class="linenos">1342</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BOUM&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1343"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1343"><span class="linenos">1343</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1344"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1344"><span class="linenos">1344</span></a>						<span class="n">lf_it</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_flight_attribute</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="s1">&#39;flight_db_id&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1345"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1345"><span class="linenos">1345</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;flights in itinerary:&#39;</span><span class="p">,</span> <span class="n">lf_it</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1346"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1346"><span class="linenos">1346</span></a>						<span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1347"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1347"><span class="linenos">1347</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1348"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1348"><span class="linenos">1348</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1349"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1349"><span class="linenos">1349</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1350"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1350"><span class="linenos">1350</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1351"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1351"><span class="linenos">1351</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1352"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1352"><span class="linenos">1352</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1353"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1353"><span class="linenos">1353</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1354"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1354"><span class="linenos">1354</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1355"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1355"><span class="linenos">1355</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1356"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1356"><span class="linenos">1356</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1357"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1357"><span class="linenos">1357</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1358"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1358"><span class="linenos">1358</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1359"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1359"><span class="linenos">1359</span></a>				<span class="c1"># cost_curfew = self.agent.afp.cost_non_pax_curfew(flight_uid_curfew) + self.agent.afp.estimate_pax_curfew_cost(flight_uid_curfew)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1360"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1360"><span class="linenos">1360</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1361"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1361"><span class="linenos">1361</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1362"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1362"><span class="linenos">1362</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1363"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1363"><span class="linenos">1363</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1364"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1364"><span class="linenos">1364</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1365"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1365"><span class="linenos">1365</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1366"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1366"><span class="linenos">1366</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1367"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1367"><span class="linenos">1367</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1368"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1368"><span class="linenos">1368</span></a>				<span class="k">if</span> <span class="n">multiply_flights_after</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1369"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1369"><span class="linenos">1369</span></a>					<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1370"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1370"><span class="linenos">1370</span></a>					<span class="n">cost</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1371"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1371"><span class="linenos">1371</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1372"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1372"><span class="linenos">1372</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1373"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1373"><span class="linenos">1373</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1374"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1374"><span class="linenos">1374</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1375"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1375"><span class="linenos">1375</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1376"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1376"><span class="linenos">1376</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1377"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1377"><span class="linenos">1377</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1378"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1378"><span class="linenos">1378</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1379"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1379"><span class="linenos">1379</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1380"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1380"><span class="linenos">1380</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1381"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1381"><span class="linenos">1381</span></a>			<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1382"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1382"><span class="linenos">1382</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1383"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1383"><span class="linenos">1383</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1384"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1384"><span class="linenos">1384</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1385"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1385"><span class="linenos">1385</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1386"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1386"><span class="linenos">1386</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_swap&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1387"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1387"><span class="linenos">1387</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1388"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1388"><span class="linenos">1388</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1389"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1389"><span class="linenos">1389</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1390"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1390"><span class="linenos">1390</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1391"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1391"><span class="linenos">1391</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1392"><a href="#AirlineFlightPlanner.build_delay_cost_functions_heuristic_pax-1392"><span class="linenos">1392</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>VERSION ONLY WITH PAX COST</p>

<p>This builds a cost function (function of delay with respect
to scheduled departure) for a given flight, given the last
available information. It uses a heuristic for knock-on effect</p>

<p>To facilitate computation, some (fixed) delays can be factored in already.
For instance, if one needs a function which depends only on ATFM delay,
the non-ATFM delay can be added on the fly to the function.</p>

<p>Likewise, different types of costs can be taken into account. For instance,
if one needs only the cost of of delay related to pax costs, the function
outputs only this cost.</p>

<p>'diff' is used when there is a factor in and one wants only the diff between
the cost with all</p>

<p>If 'missed_connections' is used, an estimation on the number of pax missing their next flights
is done, and the corresponding cost used, considering that they all miss their flights and
have no other itinerary.</p>

<p>Note: if implementation is too slow, can speed it up by putting the if
statements outside the function and build different functions.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_air_heuristic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1394"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1394"><span class="linenos">1394</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1395"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1395"><span class="linenos">1395</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1396"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1396"><span class="linenos">1396</span></a><span class="sd">		This is based on build_delay_cost_functions_heuristic</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1397"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1397"><span class="linenos">1397</span></a><span class="sd">		simplified to keep minimum required to compute cost of delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1398"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1398"><span class="linenos">1398</span></a><span class="sd">		based on arrival total delay with respect to sibt.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1399"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1399"><span class="linenos">1399</span></a><span class="sd">		You call the function passing the total delay at arrival.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1400"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1400"><span class="linenos">1400</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1401"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1401"><span class="linenos">1401</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1402"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1402"><span class="linenos">1402</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1403"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1403"><span class="linenos">1403</span></a>		<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1404"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1404"><span class="linenos">1404</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1405"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1405"><span class="linenos">1405</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1406"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1406"><span class="linenos">1406</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1407"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1407"><span class="linenos">1407</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1408"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1408"><span class="linenos">1408</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1409"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1409"><span class="linenos">1409</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1410"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1410"><span class="linenos">1410</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1411"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1411"><span class="linenos">1411</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1412"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1412"><span class="linenos">1412</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1413"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1413"><span class="linenos">1413</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1414"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1414"><span class="linenos">1414</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_missed_connections&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1415"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1415"><span class="linenos">1415</span></a>				<span class="k">if</span> <span class="ow">not</span> <span class="n">missed_connections</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1416"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1416"><span class="linenos">1416</span></a>					<span class="c1"># delays = [X * self.agent.heuristic_knock_on_factor for i in range(len(paxs))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1417"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1417"><span class="linenos">1417</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paxs</span><span class="p">))]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1418"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1418"><span class="linenos">1418</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1419"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1419"><span class="linenos">1419</span></a>					<span class="n">delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1420"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1420"><span class="linenos">1420</span></a>					<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1421"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1421"><span class="linenos">1421</span></a>						<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1422"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1422"><span class="linenos">1422</span></a>						<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1423"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1423"><span class="linenos">1423</span></a>							<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1424"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1424"><span class="linenos">1424</span></a>																					<span class="n">next_flight</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1425"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1425"><span class="linenos">1425</span></a>																					<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1426"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1426"><span class="linenos">1426</span></a>							<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">from_time</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1427"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1427"><span class="linenos">1427</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1428"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1428"><span class="linenos">1428</span></a>							<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1429"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1429"><span class="linenos">1429</span></a>								<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1430"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1430"><span class="linenos">1430</span></a>						<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1431"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1431"><span class="linenos">1431</span></a>							<span class="n">delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1432"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1432"><span class="linenos">1432</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1433"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1433"><span class="linenos">1433</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest1&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1434"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1434"><span class="linenos">1434</span></a>				<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1435"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1435"><span class="linenos">1435</span></a>				<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1436"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1436"><span class="linenos">1436</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1437"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1437"><span class="linenos">1437</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;air_heuristic_cost_rest2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1438"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1438"><span class="linenos">1438</span></a>				<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1439"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1439"><span class="linenos">1439</span></a>				<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paxs</span><span class="p">)])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1440"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1440"><span class="linenos">1440</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1441"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1441"><span class="linenos">1441</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1442"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1442"><span class="linenos">1442</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1443"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1443"><span class="linenos">1443</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1444"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1444"><span class="linenos">1444</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1445"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1445"><span class="linenos">1445</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1446"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1446"><span class="linenos">1446</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1447"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1447"><span class="linenos">1447</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1448"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1448"><span class="linenos">1448</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1449"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1449"><span class="linenos">1449</span></a>			<span class="c1"># Multiply this cost by the number of flights after this one</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1450"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1450"><span class="linenos">1450</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1451"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1451"><span class="linenos">1451</span></a>				<span class="n">flights_after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1452"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1452"><span class="linenos">1452</span></a>				<span class="n">cost</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flights_after</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1453"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1453"><span class="linenos">1453</span></a>				<span class="n">cost</span> <span class="o">+=</span> <span class="n">cost_curfew</span>  <span class="c1"># Curfew costs added afterwards so it doesn&#39;t multiply per flights after</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1454"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1454"><span class="linenos">1454</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1455"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1455"><span class="linenos">1455</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1456"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1456"><span class="linenos">1456</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1457"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1457"><span class="linenos">1457</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1458"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1458"><span class="linenos">1458</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1459"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1459"><span class="linenos">1459</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="n">aircraft</span><span class="p">)</span>  <span class="c1"># , aircraft.get_queue_uids(include_current_user=True))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1460"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1460"><span class="linenos">1460</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">queue</span><span class="p">],</span> <span class="p">[</span><span class="n">req</span><span class="o">.</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1461"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1461"><span class="linenos">1461</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1462"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1462"><span class="linenos">1462</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1463"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1463"><span class="linenos">1463</span></a>			<span class="c1"># TODO: this is strange, there should always be at list one flight in this list</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1464"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1464"><span class="linenos">1464</span></a>			<span class="c1"># if len(flights_after)&gt;0:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1465"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1465"><span class="linenos">1465</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1466"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1466"><span class="linenos">1466</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1467"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1467"><span class="linenos">1467</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1468"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1468"><span class="linenos">1468</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1469"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1469"><span class="linenos">1469</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1470"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1470"><span class="linenos">1470</span></a>				<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1471"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1471"><span class="linenos">1471</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1472"><a href="#AirlineFlightPlanner.build_delay_cost_functions_air_heuristic-1472"><span class="linenos">1472</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>This is based on build_delay_cost_functions_heuristic
simplified to keep minimum required to compute cost of delay
based on arrival total delay with respect to sibt.
You call the function passing the total delay at arrival.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.compute_reactionary_delays" class="classattr">
                                        <input id="AirlineFlightPlanner.compute_reactionary_delays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reactionary_delays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.compute_reactionary_delays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_reactionary_delays"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.compute_reactionary_delays-1474"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1474"><span class="linenos">1474</span></a>	<span class="k">def</span> <span class="nf">compute_reactionary_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1475"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1475"><span class="linenos">1475</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1476"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1476"><span class="linenos">1476</span></a><span class="sd">		Computes all the delays in the next flights of the day</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1477"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1477"><span class="linenos">1477</span></a><span class="sd">		using the same aircraft than flight_uid.</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1478"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1478"><span class="linenos">1478</span></a>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1479"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1479"><span class="linenos">1479</span></a><span class="sd">		Parameters</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1480"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1480"><span class="linenos">1480</span></a><span class="sd">		==========</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1481"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1481"><span class="linenos">1481</span></a><span class="sd">		flight_uid: int,</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1482"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1482"><span class="linenos">1482</span></a><span class="sd">			uid of the flight having the delay</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1483"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1483"><span class="linenos">1483</span></a><span class="sd">		x: float,</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1484"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1484"><span class="linenos">1484</span></a><span class="sd">			primary delay of the flight flight_uid</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1485"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1485"><span class="linenos">1485</span></a>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1486"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1486"><span class="linenos">1486</span></a><span class="sd">		Returns</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1487"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1487"><span class="linenos">1487</span></a><span class="sd">		=======</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1488"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1488"><span class="linenos">1488</span></a><span class="sd">		delay: list,</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1489"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1489"><span class="linenos">1489</span></a><span class="sd">			Amount of delay of each flight of the day.</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1490"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1490"><span class="linenos">1490</span></a><span class="sd">			These delay are between 0 (buffers are large enough)</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1491"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1491"><span class="linenos">1491</span></a><span class="sd">			and x (no buffer).</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1492"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1492"><span class="linenos">1492</span></a>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1493"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1493"><span class="linenos">1493</span></a><span class="sd">		Note: assumes no recovery strategy.</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1494"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1494"><span class="linenos">1494</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1495"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1495"><span class="linenos">1495</span></a>		<span class="c1"># flights_aircraft = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_queue_uids(include_current_user=True)</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1496"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1496"><span class="linenos">1496</span></a>		<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1497"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1497"><span class="linenos">1497</span></a>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1498"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1498"><span class="linenos">1498</span></a>		<span class="c1"># Compute buffers between each pair of flights</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1499"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1499"><span class="linenos">1499</span></a>		<span class="n">buffs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1500"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1500"><span class="linenos">1500</span></a>							<span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1501"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1501"><span class="linenos">1501</span></a>								<span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span> <span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])))</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1502"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1502"><span class="linenos">1502</span></a>							<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flights_aircraft</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1503"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1503"><span class="linenos">1503</span></a>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1504"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1504"><span class="linenos">1504</span></a>		<span class="n">delays</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1505"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1505"><span class="linenos">1505</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buffs</span><span class="p">)):</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1506"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1506"><span class="linenos">1506</span></a>			<span class="c1"># delay for each fight is delay of previous minus the buffer.</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1507"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1507"><span class="linenos">1507</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1508"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1508"><span class="linenos">1508</span></a>				<span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">flights_aircraft</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">buffs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1509"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1509"><span class="linenos">1509</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1510"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1510"><span class="linenos">1510</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">flights_aircraft</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1511"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1511"><span class="linenos">1511</span></a>				<span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">delays</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1512"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1512"><span class="linenos">1512</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.compute_reactionary_delays-1513"><a href="#AirlineFlightPlanner.compute_reactionary_delays-1513"><span class="linenos">1513</span></a>		<span class="k">return</span> <span class="n">delays</span>
</span></pre></div>


            <div class="docstring"><p>Computes all the delays in the next flights of the day
using the same aircraft than flight_uid.</p>

<h1 id="parameters">Parameters</h1>

<p>flight_uid: int,
        uid of the flight having the delay
x: float,
        primary delay of the flight flight_uid</p>

<h1 id="returns">Returns</h1>

<p>delay: list,
        Amount of delay of each flight of the day.
        These delay are between 0 (buffers are large enough)
        and x (no buffer).</p>

<p>Note: assumes no recovery strategy.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.compute_time_propagate_delay" class="classattr">
                                        <input id="AirlineFlightPlanner.compute_time_propagate_delay-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_time_propagate_delay</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.compute_time_propagate_delay-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_time_propagate_delay"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1515"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1515"><span class="linenos">1515</span></a>	<span class="k">def</span> <span class="nf">compute_time_propagate_delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1516"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1516"><span class="linenos">1516</span></a>		<span class="n">next_flights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1517"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1517"><span class="linenos">1517</span></a>		<span class="n">time_prop</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1518"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1518"><span class="linenos">1518</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_flights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1519"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1519"><span class="linenos">1519</span></a>			<span class="n">time_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_tat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">next_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.compute_time_propagate_delay-1520"><a href="#AirlineFlightPlanner.compute_time_propagate_delay-1520"><span class="linenos">1520</span></a>		<span class="k">return</span> <span class="n">time_prop</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.return_propagation_delay_time" class="classattr">
                                        <input id="AirlineFlightPlanner.return_propagation_delay_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">return_propagation_delay_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.return_propagation_delay_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.return_propagation_delay_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.return_propagation_delay_time-1522"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1522"><span class="linenos">1522</span></a>	<span class="k">def</span> <span class="nf">return_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1523"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1523"><span class="linenos">1523</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1524"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1524"><span class="linenos">1524</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1525"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1525"><span class="linenos">1525</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1526"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1526"><span class="linenos">1526</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;propagation_delay_time&#39;</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1527"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1527"><span class="linenos">1527</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_prop&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_propagate_delay</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)}</span>
</span><span id="AirlineFlightPlanner.return_propagation_delay_time-1528"><a href="#AirlineFlightPlanner.return_propagation_delay_time-1528"><span class="linenos">1528</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_request_propagation_delay_time" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_request_propagation_delay_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_request_propagation_delay_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_request_propagation_delay_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_request_propagation_delay_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_request_propagation_delay_time-1530"><a href="#AirlineFlightPlanner.wait_for_request_propagation_delay_time-1530"><span class="linenos">1530</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_propagation_delay_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_request_propagation_delay_time-1531"><a href="#AirlineFlightPlanner.wait_for_request_propagation_delay_time-1531"><span class="linenos">1531</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_propagation_delay_time</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.compute_cost_delay_function_air" class="classattr">
                                        <input id="AirlineFlightPlanner.compute_cost_delay_function_air-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_cost_delay_function_air</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.compute_cost_delay_function_air-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.compute_cost_delay_function_air"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.compute_cost_delay_function_air-1533"><a href="#AirlineFlightPlanner.compute_cost_delay_function_air-1533"><span class="linenos">1533</span></a>	<span class="k">def</span> <span class="nf">compute_cost_delay_function_air</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.compute_cost_delay_function_air-1534"><a href="#AirlineFlightPlanner.compute_cost_delay_function_air-1534"><span class="linenos">1534</span></a>		<span class="c1"># TODO: remove this function?</span>
</span><span id="AirlineFlightPlanner.compute_cost_delay_function_air-1535"><a href="#AirlineFlightPlanner.compute_cost_delay_function_air-1535"><span class="linenos">1535</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_air_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.return_cost_delay_function" class="classattr">
                                        <input id="AirlineFlightPlanner.return_cost_delay_function-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">return_cost_delay_function</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">dest_uid</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.return_cost_delay_function-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.return_cost_delay_function"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.return_cost_delay_function-1537"><a href="#AirlineFlightPlanner.return_cost_delay_function-1537"><span class="linenos">1537</span></a>	<span class="k">def</span> <span class="nf">return_cost_delay_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1538"><a href="#AirlineFlightPlanner.return_cost_delay_function-1538"><span class="linenos">1538</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1539"><a href="#AirlineFlightPlanner.return_cost_delay_function-1539"><span class="linenos">1539</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest_uid</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1540"><a href="#AirlineFlightPlanner.return_cost_delay_function-1540"><span class="linenos">1540</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1541"><a href="#AirlineFlightPlanner.return_cost_delay_function-1541"><span class="linenos">1541</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_delay_function&#39;</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1542"><a href="#AirlineFlightPlanner.return_cost_delay_function-1542"><span class="linenos">1542</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_delay_func&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_cost_delay_function_air</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1543"><a href="#AirlineFlightPlanner.return_cost_delay_function-1543"><span class="linenos">1543</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span><span class="n">flight_uid</span><span class="p">}</span>                        
</span><span id="AirlineFlightPlanner.return_cost_delay_function-1544"><a href="#AirlineFlightPlanner.return_cost_delay_function-1544"><span class="linenos">1544</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_cost_delay_function_request" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_cost_delay_function_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_cost_delay_function_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_cost_delay_function_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_cost_delay_function_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1546"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1546"><span class="linenos">1546</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_delay_function_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1547"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1547"><span class="linenos">1547</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1548"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1548"><span class="linenos">1548</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;initial_sender&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1549"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1549"><span class="linenos">1549</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1550"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1550"><span class="linenos">1550</span></a>			<span class="n">dest</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1551"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1551"><span class="linenos">1551</span></a>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1552"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1552"><span class="linenos">1552</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1553"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1553"><span class="linenos">1553</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1554"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1554"><span class="linenos">1554</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1555"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1555"><span class="linenos">1555</span></a>			<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1556"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1556"><span class="linenos">1556</span></a>
</span><span id="AirlineFlightPlanner.wait_for_cost_delay_function_request-1557"><a href="#AirlineFlightPlanner.wait_for_cost_delay_function_request-1557"><span class="linenos">1557</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">return_cost_delay_function</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_advanced" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_advanced-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_advanced</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">factor_in</span><span class="o">=</span><span class="p">[]</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_advanced-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_advanced"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1559"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1559"><span class="linenos">1559</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_advanced</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1560"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1560"><span class="linenos">1560</span></a>		<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1561"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1561"><span class="linenos">1561</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1562"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1562"><span class="linenos">1562</span></a><span class="sd">		This builds a cost function (function of delay with respect</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1563"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1563"><span class="linenos">1563</span></a><span class="sd">		to scheduled departure) for a given flight, given the last</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1564"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1564"><span class="linenos">1564</span></a><span class="sd">		available information. It uses explicit information on aircraft</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1565"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1565"><span class="linenos">1565</span></a><span class="sd">		and passenger for knock-on effects.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1566"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1566"><span class="linenos">1566</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1567"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1567"><span class="linenos">1567</span></a><span class="sd">		To facilitate computation, some (fixed) delays can be factorbuild_delay_cost_functionsed in already.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1568"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1568"><span class="linenos">1568</span></a><span class="sd">		For instance, if one needs a function which depends only on ATFM delay,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1569"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1569"><span class="linenos">1569</span></a><span class="sd">		the non-ATFM delay can be added on the fly to the function.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1570"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1570"><span class="linenos">1570</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1571"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1571"><span class="linenos">1571</span></a><span class="sd">		Likewise, different types of costs can be taken into account. For instance,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1572"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1572"><span class="linenos">1572</span></a><span class="sd">		if one needs only the cost of of delay related to pax costs, the function</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1573"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1573"><span class="linenos">1573</span></a><span class="sd">		outputs only this cost.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1574"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1574"><span class="linenos">1574</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1575"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1575"><span class="linenos">1575</span></a><span class="sd">		&#39;diff&#39; is used when there is a factor in and one wants only the diff between</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1576"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1576"><span class="linenos">1576</span></a><span class="sd">		the cost with all</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1577"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1577"><span class="linenos">1577</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1578"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1578"><span class="linenos">1578</span></a><span class="sd">		Note: if implementation is too slow, can speed it up by putting the if</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1579"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1579"><span class="linenos">1579</span></a><span class="sd">		statements outside the function and build different functions.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1580"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1580"><span class="linenos">1580</span></a><span class="sd">		Note: this is probably slow.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1581"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1581"><span class="linenos">1581</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1582"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1582"><span class="linenos">1582</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1583"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1583"><span class="linenos">1583</span></a>		<span class="k">if</span> <span class="n">factor_in</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1584"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1584"><span class="linenos">1584</span></a>			<span class="n">factor_in</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1585"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1585"><span class="linenos">1585</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1586"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1586"><span class="linenos">1586</span></a>		<span class="c1"># For non-pax cost, consider that all the delay is at gate.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1587"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1587"><span class="linenos">1587</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_building&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1588"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1588"><span class="linenos">1588</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1589"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1589"><span class="linenos">1589</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1590"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1590"><span class="linenos">1590</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1591"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1591"><span class="linenos">1591</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1592"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1592"><span class="linenos">1592</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1593"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1593"><span class="linenos">1593</span></a>				<span class="n">baseline_ibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1594"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1594"><span class="linenos">1594</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;non_atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;delay_non_atfm&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1595"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1595"><span class="linenos">1595</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1596"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1596"><span class="linenos">1596</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1597"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1597"><span class="linenos">1597</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1598"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1598"><span class="linenos">1598</span></a>				<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atfm_delay&#39;</span> <span class="ow">in</span> <span class="n">factor_in</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">has_atfm_delay</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1599"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1599"><span class="linenos">1599</span></a>					<span class="n">x0</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1600"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1600"><span class="linenos">1600</span></a>					<span class="n">baseline_ibt</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">atfm_delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1601"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1601"><span class="linenos">1601</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1602"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1602"><span class="linenos">1602</span></a>			<span class="c1"># Get all passengers on the flights using in the future using the same aircraft</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1603"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1603"><span class="linenos">1603</span></a>			<span class="c1"># than the current flight.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1604"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1604"><span class="linenos">1604</span></a>			<span class="c1"># These passengers cannot miss a flight, by definition!</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1605"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1605"><span class="linenos">1605</span></a>			<span class="n">flights_aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_flights_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">include_flight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1606"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1606"><span class="linenos">1606</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1607"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1607"><span class="linenos">1607</span></a>			<span class="c1"># Rmk: maybe some pax are on different flights...</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1608"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1608"><span class="linenos">1608</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="p">{</span><span class="n">pax</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flights_aircraft</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1609"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1609"><span class="linenos">1609</span></a>								<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1610"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1610"><span class="linenos">1610</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1611"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1611"><span class="linenos">1611</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1612"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1612"><span class="linenos">1612</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1613"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1613"><span class="linenos">1613</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1614"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1614"><span class="linenos">1614</span></a>			<span class="n">from_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1615"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1615"><span class="linenos">1615</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1616"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1616"><span class="linenos">1616</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1617"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1617"><span class="linenos">1617</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot; Non diff version&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1618"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1618"><span class="linenos">1618</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1619"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1619"><span class="linenos">1619</span></a>												<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1620"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1620"><span class="linenos">1620</span></a>												<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1621"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1621"><span class="linenos">1621</span></a>			<span class="c1"># Their cost is simply due to delay, taking buffers into account.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1622"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1622"><span class="linenos">1622</span></a>			<span class="c1"># Assumes paxs can always make it if the aircraft is below its min tat.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1623"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1623"><span class="linenos">1623</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1624"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1624"><span class="linenos">1624</span></a>			<span class="c1"># Compute reactionary delays for all flights of the day</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1625"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1625"><span class="linenos">1625</span></a>			<span class="n">delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reactionary_delays</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1626"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1626"><span class="linenos">1626</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1627"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1627"><span class="linenos">1627</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1628"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1628"><span class="linenos">1628</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1629"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1629"><span class="linenos">1629</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1630"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1630"><span class="linenos">1630</span></a>			<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1631"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1631"><span class="linenos">1631</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1632"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1632"><span class="linenos">1632</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1633"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1633"><span class="linenos">1633</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1634"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1634"><span class="linenos">1634</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delays</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">paxs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1635"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1635"><span class="linenos">1635</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1636"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1636"><span class="linenos">1636</span></a>			<span class="c1"># aprint(&#39;First part of costs in cost function for&#39;, flight_str(flight_uid), &#39;:&#39;, cost_np, cost_soft_cost,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1637"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1637"><span class="linenos">1637</span></a>			<span class="c1">#         cost_doc, cost_compensation, &#39;(x0+x=&#39;, X, &#39;, number of pax:&#39;, len(paxs), &#39;)&#39;)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1638"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1638"><span class="linenos">1638</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1639"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1639"><span class="linenos">1639</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1640"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1640"><span class="linenos">1640</span></a>			<span class="c1"># Second part: pax on this flight which have a connection afterwards</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1641"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1641"><span class="linenos">1641</span></a>			<span class="c1"># Only takes into account direct flights from the same company.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1642"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1642"><span class="linenos">1642</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1643"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1643"><span class="linenos">1643</span></a>			<span class="c1"># Check if pax have a flight after this one</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1644"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1644"><span class="linenos">1644</span></a>			<span class="n">paxs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pax</span><span class="o">.</span><span class="n">is_last_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1645"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1645"><span class="linenos">1645</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1646"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1646"><span class="linenos">1646</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs2</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1647"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1647"><span class="linenos">1647</span></a>				<span class="n">from_time</span> <span class="o">=</span> <span class="n">baseline_ibt</span> <span class="o">+</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1648"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1648"><span class="linenos">1648</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">get_flight_after</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1649"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1649"><span class="linenos">1649</span></a>																<span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1650"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1650"><span class="linenos">1650</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1651"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1651"><span class="linenos">1651</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing1&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1652"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1652"><span class="linenos">1652</span></a>					<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1653"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1653"><span class="linenos">1653</span></a>					<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1654"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1654"><span class="linenos">1654</span></a>					<span class="c1"># now (like the one it missed).</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1655"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1655"><span class="linenos">1655</span></a>					<span class="c1"># Note: this can include the original flight intented (pax.get_flight_after(flight_uid))</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1656"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1656"><span class="linenos">1656</span></a>					<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1657"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1657"><span class="linenos">1657</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1658"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1658"><span class="linenos">1658</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1659"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1659"><span class="linenos">1659</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1660"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1660"><span class="linenos">1660</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1661"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1661"><span class="linenos">1661</span></a>					<span class="c1"># outbound_flights = [f for f in self.agent.flights_per_origin[from_airport]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1662"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1662"><span class="linenos">1662</span></a>					<span class="c1">#                             if (self.agent.get_obt(f) &gt; from_time + 1)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1663"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1663"><span class="linenos">1663</span></a>					<span class="c1">#                                 and self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1664"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1664"><span class="linenos">1664</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1665"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1665"><span class="linenos">1665</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1666"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1666"><span class="linenos">1666</span></a>					<span class="c1"># Select direct itineraries</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1667"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1667"><span class="linenos">1667</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1668"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1668"><span class="linenos">1668</span></a>													<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1669"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1669"><span class="linenos">1669</span></a>													<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1670"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1670"><span class="linenos">1670</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1671"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1671"><span class="linenos">1671</span></a>					<span class="c1"># itineraries = [((f, self.agent.uid), ) for f in self.agent.flights_per_destination[pax.destination_uid]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1672"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1672"><span class="linenos">1672</span></a>					<span class="c1">#                                 if self.agent.get_status(f)!=&#39;cancelled&#39;]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1673"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1673"><span class="linenos">1673</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1674"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1674"><span class="linenos">1674</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing3&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1675"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1675"><span class="linenos">1675</span></a>					<span class="n">itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1676"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1676"><span class="linenos">1676</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1677"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1677"><span class="linenos">1677</span></a>				<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing4&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1678"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1678"><span class="linenos">1678</span></a>					<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1679"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1679"><span class="linenos">1679</span></a>						<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1680"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1680"><span class="linenos">1680</span></a>						<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1681"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1681"><span class="linenos">1681</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1682"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1682"><span class="linenos">1682</span></a>						<span class="n">soft_cost_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1683"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1683"><span class="linenos">1683</span></a>						<span class="n">compensation_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">arrival_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1684"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1684"><span class="linenos">1684</span></a>						<span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">dt</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">departure_times</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1685"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1685"><span class="linenos">1685</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1686"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1686"><span class="linenos">1686</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="p">(</span><span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1687"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1687"><span class="linenos">1687</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1688"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1688"><span class="linenos">1688</span></a>						<span class="n">cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1689"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1689"><span class="linenos">1689</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1690"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1690"><span class="linenos">1690</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1691"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1691"><span class="linenos">1691</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1692"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1692"><span class="linenos">1692</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1693"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1693"><span class="linenos">1693</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1694"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1694"><span class="linenos">1694</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1695"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1695"><span class="linenos">1695</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1696"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1696"><span class="linenos">1696</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1697"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1697"><span class="linenos">1697</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1698"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1698"><span class="linenos">1698</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_advanced-1699"><a href="#AirlineFlightPlanner.build_delay_cost_functions_advanced-1699"><span class="linenos">1699</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>This builds a cost function (function of delay with respect
to scheduled departure) for a given flight, given the last
available information. It uses explicit information on aircraft
and passenger for knock-on effects.</p>

<p>To facilitate computation, some (fixed) delays can be factorbuild_delay_cost_functionsed in already.
For instance, if one needs a function which depends only on ATFM delay,
the non-ATFM delay can be added on the fly to the function.</p>

<p>Likewise, different types of costs can be taken into account. For instance,
if one needs only the cost of of delay related to pax costs, the function
outputs only this cost.</p>

<p>'diff' is used when there is a factor in and one wants only the diff between
the cost with all</p>

<p>Note: if implementation is too slow, can speed it up by putting the if
statements outside the function and build different functions.
Note: this is probably slow.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.decide_options_alternatives" class="classattr">
                                        <input id="AirlineFlightPlanner.decide_options_alternatives-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">decide_options_alternatives</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">fp_options</span>, </span><span class="param"><span class="n">current_option</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.decide_options_alternatives-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.decide_options_alternatives"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.decide_options_alternatives-1701"><a href="#AirlineFlightPlanner.decide_options_alternatives-1701"><span class="linenos">1701</span></a>	<span class="k">def</span> <span class="nf">decide_options_alternatives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">current_option</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1702"><a href="#AirlineFlightPlanner.decide_options_alternatives-1702"><span class="linenos">1702</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1703"><a href="#AirlineFlightPlanner.decide_options_alternatives-1703"><span class="linenos">1703</span></a><span class="sd">		Options is decided based on delay and estimated fuel consumption.</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1704"><a href="#AirlineFlightPlanner.decide_options_alternatives-1704"><span class="linenos">1704</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1705"><a href="#AirlineFlightPlanner.decide_options_alternatives-1705"><span class="linenos">1705</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1706"><a href="#AirlineFlightPlanner.decide_options_alternatives-1706"><span class="linenos">1706</span></a>			<span class="c1"># print(&#39;STOP1 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1707"><a href="#AirlineFlightPlanner.decide_options_alternatives-1707"><span class="linenos">1707</span></a>		<span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1708"><a href="#AirlineFlightPlanner.decide_options_alternatives-1708"><span class="linenos">1708</span></a>		<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1709"><a href="#AirlineFlightPlanner.decide_options_alternatives-1709"><span class="linenos">1709</span></a>		<span class="n">option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1710"><a href="#AirlineFlightPlanner.decide_options_alternatives-1710"><span class="linenos">1710</span></a>		<span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1711"><a href="#AirlineFlightPlanner.decide_options_alternatives-1711"><span class="linenos">1711</span></a>		<span class="n">fp_options_orig</span> <span class="o">=</span> <span class="n">fp_options</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1712"><a href="#AirlineFlightPlanner.decide_options_alternatives-1712"><span class="linenos">1712</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1713"><a href="#AirlineFlightPlanner.decide_options_alternatives-1713"><span class="linenos">1713</span></a>		<span class="c1"># Keep the following line for tests.</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1714"><a href="#AirlineFlightPlanner.decide_options_alternatives-1714"><span class="linenos">1714</span></a>		<span class="c1"># cancellation = len(fp_options)==2</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1715"><a href="#AirlineFlightPlanner.decide_options_alternatives-1715"><span class="linenos">1715</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1716"><a href="#AirlineFlightPlanner.decide_options_alternatives-1716"><span class="linenos">1716</span></a>		<span class="c1"># Keep only fp_options with eibt earlier than the curfew</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1717"><a href="#AirlineFlightPlanner.decide_options_alternatives-1717"><span class="linenos">1717</span></a>		<span class="n">options_respect_curfew</span> <span class="o">=</span> <span class="p">[</span><span class="n">fp</span><span class="o">.</span><span class="n">eibt</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1718"><a href="#AirlineFlightPlanner.decide_options_alternatives-1718"><span class="linenos">1718</span></a>		<span class="c1"># costs = np.asarray(list(compress(costs, options_respect_curfew)))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1719"><a href="#AirlineFlightPlanner.decide_options_alternatives-1719"><span class="linenos">1719</span></a>		<span class="n">fp_options</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">fp_options</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1720"><a href="#AirlineFlightPlanner.decide_options_alternatives-1720"><span class="linenos">1720</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1721"><a href="#AirlineFlightPlanner.decide_options_alternatives-1721"><span class="linenos">1721</span></a>		<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1722"><a href="#AirlineFlightPlanner.decide_options_alternatives-1722"><span class="linenos">1722</span></a>			<span class="c1"># Converting current_option to tis new index</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1723"><a href="#AirlineFlightPlanner.decide_options_alternatives-1723"><span class="linenos">1723</span></a>			<span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fp_options_orig</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1724"><a href="#AirlineFlightPlanner.decide_options_alternatives-1724"><span class="linenos">1724</span></a>			<span class="n">new_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compress</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">options_respect_curfew</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1725"><a href="#AirlineFlightPlanner.decide_options_alternatives-1725"><span class="linenos">1725</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">current_option</span> <span class="ow">in</span> <span class="n">new_indices</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1726"><a href="#AirlineFlightPlanner.decide_options_alternatives-1726"><span class="linenos">1726</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="n">new_indices</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">current_option</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1727"><a href="#AirlineFlightPlanner.decide_options_alternatives-1727"><span class="linenos">1727</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1728"><a href="#AirlineFlightPlanner.decide_options_alternatives-1728"><span class="linenos">1728</span></a>				<span class="n">current_option</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1729"><a href="#AirlineFlightPlanner.decide_options_alternatives-1729"><span class="linenos">1729</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1730"><a href="#AirlineFlightPlanner.decide_options_alternatives-1730"><span class="linenos">1730</span></a>		<span class="c1"># print(&#39;STOP1.5 {} (fp_options length: {}, current_option: {})&#39;.format(flight_uid, len(fp_options), current_option))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1731"><a href="#AirlineFlightPlanner.decide_options_alternatives-1731"><span class="linenos">1731</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1732"><a href="#AirlineFlightPlanner.decide_options_alternatives-1732"><span class="linenos">1732</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1733"><a href="#AirlineFlightPlanner.decide_options_alternatives-1733"><span class="linenos">1733</span></a>			<span class="c1"># There are no options which meet the curfew. Cancel the flight</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1734"><a href="#AirlineFlightPlanner.decide_options_alternatives-1734"><span class="linenos">1734</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1735"><a href="#AirlineFlightPlanner.decide_options_alternatives-1735"><span class="linenos">1735</span></a>			<span class="n">cancellation</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1736"><a href="#AirlineFlightPlanner.decide_options_alternatives-1736"><span class="linenos">1736</span></a>			<span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;CANCEL_CF&quot;</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1737"><a href="#AirlineFlightPlanner.decide_options_alternatives-1737"><span class="linenos">1737</span></a>			<span class="c1"># Select as option the one which would arrive earlier to the destination</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1738"><a href="#AirlineFlightPlanner.decide_options_alternatives-1738"><span class="linenos">1738</span></a>			<span class="n">list_eibt</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">eibt</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fp_options_orig</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1739"><a href="#AirlineFlightPlanner.decide_options_alternatives-1739"><span class="linenos">1739</span></a>			<span class="n">fp_options</span> <span class="o">=</span> <span class="n">fp_options_orig</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1740"><a href="#AirlineFlightPlanner.decide_options_alternatives-1740"><span class="linenos">1740</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="n">list_eibt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">list_eibt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1741"><a href="#AirlineFlightPlanner.decide_options_alternatives-1741"><span class="linenos">1741</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1742"><a href="#AirlineFlightPlanner.decide_options_alternatives-1742"><span class="linenos">1742</span></a>			<span class="c1"># Estimated fuel consumption</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1743"><a href="#AirlineFlightPlanner.decide_options_alternatives-1743"><span class="linenos">1743</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">get_estimated_fuel_consumption</span><span class="p">()</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1744"><a href="#AirlineFlightPlanner.decide_options_alternatives-1744"><span class="linenos">1744</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1745"><a href="#AirlineFlightPlanner.decide_options_alternatives-1745"><span class="linenos">1745</span></a>			<span class="c1"># CRCO costs</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1746"><a href="#AirlineFlightPlanner.decide_options_alternatives-1746"><span class="linenos">1746</span></a>			<span class="n">crco_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fp</span><span class="o">.</span><span class="n">crco_cost_EUR</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1747"><a href="#AirlineFlightPlanner.decide_options_alternatives-1747"><span class="linenos">1747</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1748"><a href="#AirlineFlightPlanner.decide_options_alternatives-1748"><span class="linenos">1748</span></a>			<span class="c1"># Estimated delay cost</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1749"><a href="#AirlineFlightPlanner.decide_options_alternatives-1749"><span class="linenos">1749</span></a>			<span class="n">delay_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">average_cost_function</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">())</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">fp_options</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1750"><a href="#AirlineFlightPlanner.decide_options_alternatives-1750"><span class="linenos">1750</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1751"><a href="#AirlineFlightPlanner.decide_options_alternatives-1751"><span class="linenos">1751</span></a>			<span class="n">costs</span> <span class="o">=</span> <span class="n">fuel_cost</span> <span class="o">+</span> <span class="n">delay_cost</span> <span class="o">+</span> <span class="n">crco_cost</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1752"><a href="#AirlineFlightPlanner.decide_options_alternatives-1752"><span class="linenos">1752</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1753"><a href="#AirlineFlightPlanner.decide_options_alternatives-1753"><span class="linenos">1753</span></a>			<span class="k">if</span> <span class="n">current_option</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">current_option</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1754"><a href="#AirlineFlightPlanner.decide_options_alternatives-1754"><span class="linenos">1754</span></a>				<span class="n">costs</span><span class="p">[</span><span class="n">current_option</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fp_anchor</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1755"><a href="#AirlineFlightPlanner.decide_options_alternatives-1755"><span class="linenos">1755</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1756"><a href="#AirlineFlightPlanner.decide_options_alternatives-1756"><span class="linenos">1756</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1757"><a href="#AirlineFlightPlanner.decide_options_alternatives-1757"><span class="linenos">1757</span></a>				<span class="c1"># print(&#39;STOP2 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1758"><a href="#AirlineFlightPlanner.decide_options_alternatives-1758"><span class="linenos">1758</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1759"><a href="#AirlineFlightPlanner.decide_options_alternatives-1759"><span class="linenos">1759</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fp_options</span><span class="p">),</span> <span class="s1">&#39;options&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1760"><a href="#AirlineFlightPlanner.decide_options_alternatives-1760"><span class="linenos">1760</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1761"><a href="#AirlineFlightPlanner.decide_options_alternatives-1761"><span class="linenos">1761</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1762"><a href="#AirlineFlightPlanner.decide_options_alternatives-1762"><span class="linenos">1762</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1763"><a href="#AirlineFlightPlanner.decide_options_alternatives-1763"><span class="linenos">1763</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1764"><a href="#AirlineFlightPlanner.decide_options_alternatives-1764"><span class="linenos">1764</span></a>				<span class="c1"># print(&#39;STOP3 {} (fp_options length: {})&#39;.format(flight_uid, len(fp_options)))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1765"><a href="#AirlineFlightPlanner.decide_options_alternatives-1765"><span class="linenos">1765</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1766"><a href="#AirlineFlightPlanner.decide_options_alternatives-1766"><span class="linenos">1766</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fuel_cost&#39;</span><span class="p">:</span> <span class="n">fuel_cost</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1767"><a href="#AirlineFlightPlanner.decide_options_alternatives-1767"><span class="linenos">1767</span></a>																				   <span class="s1">&#39;delay_cost&#39;</span><span class="p">:</span> <span class="n">delay_cost</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1768"><a href="#AirlineFlightPlanner.decide_options_alternatives-1768"><span class="linenos">1768</span></a>																				   <span class="s1">&#39;crco_cost&#39;</span><span class="p">:</span> <span class="n">crco_cost</span><span class="p">}))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1769"><a href="#AirlineFlightPlanner.decide_options_alternatives-1769"><span class="linenos">1769</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1770"><a href="#AirlineFlightPlanner.decide_options_alternatives-1770"><span class="linenos">1770</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1771"><a href="#AirlineFlightPlanner.decide_options_alternatives-1771"><span class="linenos">1771</span></a>				<span class="c1"># print(&#39;STOP4 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1772"><a href="#AirlineFlightPlanner.decide_options_alternatives-1772"><span class="linenos">1772</span></a>			<span class="n">option</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1773"><a href="#AirlineFlightPlanner.decide_options_alternatives-1773"><span class="linenos">1773</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1774"><a href="#AirlineFlightPlanner.decide_options_alternatives-1774"><span class="linenos">1774</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1775"><a href="#AirlineFlightPlanner.decide_options_alternatives-1775"><span class="linenos">1775</span></a>				<span class="k">if</span> <span class="n">fp_options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;submitted&#39;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1776"><a href="#AirlineFlightPlanner.decide_options_alternatives-1776"><span class="linenos">1776</span></a>					<span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1777"><a href="#AirlineFlightPlanner.decide_options_alternatives-1777"><span class="linenos">1777</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1778"><a href="#AirlineFlightPlanner.decide_options_alternatives-1778"><span class="linenos">1778</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PROBLEM:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1779"><a href="#AirlineFlightPlanner.decide_options_alternatives-1779"><span class="linenos">1779</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1780"><a href="#AirlineFlightPlanner.decide_options_alternatives-1780"><span class="linenos">1780</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1781"><a href="#AirlineFlightPlanner.decide_options_alternatives-1781"><span class="linenos">1781</span></a>			<span class="n">found</span> <span class="o">=</span> <span class="n">found</span> <span class="ow">or</span> <span class="n">cancellation</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1782"><a href="#AirlineFlightPlanner.decide_options_alternatives-1782"><span class="linenos">1782</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1783"><a href="#AirlineFlightPlanner.decide_options_alternatives-1783"><span class="linenos">1783</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1784"><a href="#AirlineFlightPlanner.decide_options_alternatives-1784"><span class="linenos">1784</span></a>		<span class="c1"># 	print(&#39;STOP5 {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1785"><a href="#AirlineFlightPlanner.decide_options_alternatives-1785"><span class="linenos">1785</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1786"><a href="#AirlineFlightPlanner.decide_options_alternatives-1786"><span class="linenos">1786</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has decided this found:&#39;</span><span class="p">,</span> <span class="n">found</span><span class="p">,</span> <span class="s1">&#39;cancel:&#39;</span><span class="p">,</span> <span class="n">cancellation</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1787"><a href="#AirlineFlightPlanner.decide_options_alternatives-1787"><span class="linenos">1787</span></a>			   <span class="s1">&#39;option:&#39;</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1788"><a href="#AirlineFlightPlanner.decide_options_alternatives-1788"><span class="linenos">1788</span></a>			   <span class="s1">&#39;reason:&#39;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="s1">&#39;fp_options:&#39;</span><span class="p">,</span> <span class="n">fp_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1789"><a href="#AirlineFlightPlanner.decide_options_alternatives-1789"><span class="linenos">1789</span></a>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1790"><a href="#AirlineFlightPlanner.decide_options_alternatives-1790"><span class="linenos">1790</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;found&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">found</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1791"><a href="#AirlineFlightPlanner.decide_options_alternatives-1791"><span class="linenos">1791</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;cancellation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cancellation</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1792"><a href="#AirlineFlightPlanner.decide_options_alternatives-1792"><span class="linenos">1792</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1793"><a href="#AirlineFlightPlanner.decide_options_alternatives-1793"><span class="linenos">1793</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="AirlineFlightPlanner.decide_options_alternatives-1794"><a href="#AirlineFlightPlanner.decide_options_alternatives-1794"><span class="linenos">1794</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">dict_decide_options</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp_options</span>
</span></pre></div>


            <div class="docstring"><p>Options is decided based on delay and estimated fuel consumption.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.get_option" class="classattr">
                                        <input id="AirlineFlightPlanner.get_option-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_option</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">cost_options</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.get_option-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.get_option"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.get_option-1796"><a href="#AirlineFlightPlanner.get_option-1796"><span class="linenos">1796</span></a>	<span class="k">def</span> <span class="nf">get_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.get_option-1797"><a href="#AirlineFlightPlanner.get_option-1797"><span class="linenos">1797</span></a>		<span class="n">received_option_selection_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.get_option-1798"><a href="#AirlineFlightPlanner.get_option-1798"><span class="linenos">1798</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">received_option_selection_message_event</span>
</span><span id="AirlineFlightPlanner.get_option-1799"><a href="#AirlineFlightPlanner.get_option-1799"><span class="linenos">1799</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_request_select_option</span><span class="p">(</span><span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.get_option-1800"><a href="#AirlineFlightPlanner.get_option-1800"><span class="linenos">1800</span></a>		<span class="k">yield</span> <span class="n">received_option_selection_message_event</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.check_pax_ready_to_board" class="classattr">
                                        <input id="AirlineFlightPlanner.check_pax_ready_to_board-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_pax_ready_to_board</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">pax_check_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.check_pax_ready_to_board-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.check_pax_ready_to_board"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1802"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1802"><span class="linenos">1802</span></a>	<span class="k">def</span> <span class="nf">check_pax_ready_to_board</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax_check_event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1803"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1803"><span class="linenos">1803</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1804"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1804"><span class="linenos">1804</span></a>		<span class="k">yield</span> <span class="n">pax_check_event</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1805"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1805"><span class="linenos">1805</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1806"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1806"><span class="linenos">1806</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1807"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1807"><span class="linenos">1807</span></a>		<span class="c1"># 	print(&quot;{} checks  performs check for pax not ready to board flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1808"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1808"><span class="linenos">1808</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs check for pax not ready to board the&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1809"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1809"><span class="linenos">1809</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1810"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1810"><span class="linenos">1810</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1811"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1811"><span class="linenos">1811</span></a><span class="sd">		Check pax readiness to board, 5 minutes before pushback_ready.</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1812"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1812"><span class="linenos">1812</span></a><span class="sd">		pax_ready_to_board_checklist - list of pax who are estimated to be at the gate in 5min and ready to board</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1813"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1813"><span class="linenos">1813</span></a><span class="sd">		pax_to_wait_checklist - list of pax not est. to be at the gate in time for boarding --&gt; potential wait</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1814"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1814"><span class="linenos">1814</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1815"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1815"><span class="linenos">1815</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1816"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1816"><span class="linenos">1816</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1817"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1817"><span class="linenos">1817</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_already_performed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># make sure to perform wait for pax once per flight</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1818"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1818"><span class="linenos">1818</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1819"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1819"><span class="linenos">1819</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1820"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1820"><span class="linenos">1820</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1821"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1821"><span class="linenos">1821</span></a>				<span class="n">previous_flight_idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1822"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1822"><span class="linenos">1822</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1823"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1823"><span class="linenos">1823</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1824"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1824"><span class="linenos">1824</span></a>				<span class="k">if</span> <span class="n">previous_flight_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># pax with no previous flight in their itinerary</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1825"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1825"><span class="linenos">1825</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1826"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1826"><span class="linenos">1826</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1827"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1827"><span class="linenos">1827</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1828"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1828"><span class="linenos">1828</span></a>				<span class="k">elif</span> <span class="n">previous_flight_idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1829"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1829"><span class="linenos">1829</span></a>					<span class="c1"># calculate MCT</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1830"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1830"><span class="linenos">1830</span></a>					<span class="n">ft1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1831"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1831"><span class="linenos">1831</span></a>					<span class="n">ft2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1832"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1832"><span class="linenos">1832</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">ft2</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1833"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1833"><span class="linenos">1833</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1834"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1834"><span class="linenos">1834</span></a>					<span class="n">origin_airport_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1835"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1835"><span class="linenos">1835</span></a>					<span class="n">mcts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_airports_info</span><span class="p">[</span><span class="n">origin_airport_uid</span><span class="p">][</span><span class="s1">&#39;mcts&#39;</span><span class="p">][</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1836"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1836"><span class="linenos">1836</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">mcts</span><span class="p">[(</span><span class="n">ft1</span><span class="p">,</span> <span class="n">ft2</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1837"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1837"><span class="linenos">1837</span></a>					<span class="c1"># self.agent.aph.request_connecting_times(pax, (ft1, ft2))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1838"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1838"><span class="linenos">1838</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1839"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1839"><span class="linenos">1839</span></a>					<span class="c1"># check if ft1 is from the same company as ft2 and calc. its in-block time</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1840"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1840"><span class="linenos">1840</span></a>					<span class="c1"># if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1841"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1841"><span class="linenos">1841</span></a>					<span class="c1">#     #print(&quot;It&#39;s not the same company.&quot;)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1842"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1842"><span class="linenos">1842</span></a>					<span class="c1">#     self.send_request_flight_plan(previous_flight)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1843"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1843"><span class="linenos">1843</span></a>					<span class="c1">#     previous_eibt = self.agent.get_obt(previous_flight) #self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1844"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1844"><span class="linenos">1844</span></a>					<span class="c1"># else:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1845"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1845"><span class="linenos">1845</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1846"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1846"><span class="linenos">1846</span></a>						<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>  <span class="c1"># self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1847"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1847"><span class="linenos">1847</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1848"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1848"><span class="linenos">1848</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1849"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1849"><span class="linenos">1849</span></a>						<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1850"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1850"><span class="linenos">1850</span></a>						<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1851"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1851"><span class="linenos">1851</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1852"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1852"><span class="linenos">1852</span></a>					<span class="k">if</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1853"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1853"><span class="linenos">1853</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1854"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1854"><span class="linenos">1854</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1855"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1855"><span class="linenos">1855</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1856"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1856"><span class="linenos">1856</span></a>						<span class="c1"># pax who won&#39;t make it in time</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1857"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1857"><span class="linenos">1857</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1858"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1858"><span class="linenos">1858</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1859"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1859"><span class="linenos">1859</span></a>						<span class="c1"># TESTING</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1860"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1860"><span class="linenos">1860</span></a>						<span class="c1"># print(&quot;This passenger&#39;s connecting time is: &quot;, pax.ct, &quot; and minimum CT is: &quot;, pax.mct)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1861"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1861"><span class="linenos">1861</span></a>						<span class="c1"># print(&quot;Time now: &quot;, self.agent.env.now)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1862"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1862"><span class="linenos">1862</span></a>						<span class="c1"># print(&quot;This passenger&#39;s previous flight will land at: &quot;, self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1863"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1863"><span class="linenos">1863</span></a>						<span class="c1"># print(&quot;Them missing &quot;, pax.pax_type)</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1864"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1864"><span class="linenos">1864</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1865"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1865"><span class="linenos">1865</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;The passengers not making their connecting&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; are: &quot;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1866"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1866"><span class="linenos">1866</span></a>				   <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1867"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1867"><span class="linenos">1867</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Passengers ready to board&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;are: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1868"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1868"><span class="linenos">1868</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1869"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1869"><span class="linenos">1869</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; states there are no missing passengers for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1870"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1870"><span class="linenos">1870</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1871"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1871"><span class="linenos">1871</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39; asks: Should we wait for missing pax on flight &#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1872"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1872"><span class="linenos">1872</span></a>
</span><span id="AirlineFlightPlanner.check_pax_ready_to_board-1873"><a href="#AirlineFlightPlanner.check_pax_ready_to_board-1873"><span class="linenos">1873</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">consider_waiting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_wait_checklist&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.consider_waiting_pax" class="classattr">
                                        <input id="AirlineFlightPlanner.consider_waiting_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">consider_waiting_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">missing_pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.consider_waiting_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.consider_waiting_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.consider_waiting_pax-1875"><a href="#AirlineFlightPlanner.consider_waiting_pax-1875"><span class="linenos">1875</span></a>	<span class="k">def</span> <span class="nf">consider_waiting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1876"><a href="#AirlineFlightPlanner.consider_waiting_pax-1876"><span class="linenos">1876</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is considering to wait pax that are up to 15 minutes away.&quot;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1877"><a href="#AirlineFlightPlanner.consider_waiting_pax-1877"><span class="linenos">1877</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1878"><a href="#AirlineFlightPlanner.consider_waiting_pax-1878"><span class="linenos">1878</span></a>		<span class="n">wait_time</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1879"><a href="#AirlineFlightPlanner.consider_waiting_pax-1879"><span class="linenos">1879</span></a>		<span class="n">num_missing_pax_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1880"><a href="#AirlineFlightPlanner.consider_waiting_pax-1880"><span class="linenos">1880</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1881"><a href="#AirlineFlightPlanner.consider_waiting_pax-1881"><span class="linenos">1881</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1882"><a href="#AirlineFlightPlanner.consider_waiting_pax-1882"><span class="linenos">1882</span></a>		<span class="k">if</span> <span class="n">num_missing_pax_groups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1883"><a href="#AirlineFlightPlanner.consider_waiting_pax-1883"><span class="linenos">1883</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1884"><a href="#AirlineFlightPlanner.consider_waiting_pax-1884"><span class="linenos">1884</span></a>				<span class="n">current_eobt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1885"><a href="#AirlineFlightPlanner.consider_waiting_pax-1885"><span class="linenos">1885</span></a>			<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1886"><a href="#AirlineFlightPlanner.consider_waiting_pax-1886"><span class="linenos">1886</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1887"><a href="#AirlineFlightPlanner.consider_waiting_pax-1887"><span class="linenos">1887</span></a>				<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1888"><a href="#AirlineFlightPlanner.consider_waiting_pax-1888"><span class="linenos">1888</span></a>				<span class="k">raise</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1889"><a href="#AirlineFlightPlanner.consider_waiting_pax-1889"><span class="linenos">1889</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1890"><a href="#AirlineFlightPlanner.consider_waiting_pax-1890"><span class="linenos">1890</span></a>			<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1891"><a href="#AirlineFlightPlanner.consider_waiting_pax-1891"><span class="linenos">1891</span></a>				<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1892"><a href="#AirlineFlightPlanner.consider_waiting_pax-1892"><span class="linenos">1892</span></a>				<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1893"><a href="#AirlineFlightPlanner.consider_waiting_pax-1893"><span class="linenos">1893</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1894"><a href="#AirlineFlightPlanner.consider_waiting_pax-1894"><span class="linenos">1894</span></a>				<span class="n">pax_delay</span> <span class="o">=</span> <span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1895"><a href="#AirlineFlightPlanner.consider_waiting_pax-1895"><span class="linenos">1895</span></a>				<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1896"><a href="#AirlineFlightPlanner.consider_waiting_pax-1896"><span class="linenos">1896</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax_delay</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">wait_for_passenger_thr</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1897"><a href="#AirlineFlightPlanner.consider_waiting_pax-1897"><span class="linenos">1897</span></a>					<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>  <span class="c1"># total wait time for this flight</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1898"><a href="#AirlineFlightPlanner.consider_waiting_pax-1898"><span class="linenos">1898</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1899"><a href="#AirlineFlightPlanner.consider_waiting_pax-1899"><span class="linenos">1899</span></a>			<span class="c1"># for saving</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1900"><a href="#AirlineFlightPlanner.consider_waiting_pax-1900"><span class="linenos">1900</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1901"><a href="#AirlineFlightPlanner.consider_waiting_pax-1901"><span class="linenos">1901</span></a>			<span class="n">wait_time_max</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pax_delays</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1902"><a href="#AirlineFlightPlanner.consider_waiting_pax-1902"><span class="linenos">1902</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1903"><a href="#AirlineFlightPlanner.consider_waiting_pax-1903"><span class="linenos">1903</span></a>			<span class="n">wait_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">wait_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1904"><a href="#AirlineFlightPlanner.consider_waiting_pax-1904"><span class="linenos">1904</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1905"><a href="#AirlineFlightPlanner.consider_waiting_pax-1905"><span class="linenos">1905</span></a>			<span class="c1"># delay sobt of flight_uid for wait_time</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1906"><a href="#AirlineFlightPlanner.consider_waiting_pax-1906"><span class="linenos">1906</span></a>			<span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1907"><a href="#AirlineFlightPlanner.consider_waiting_pax-1907"><span class="linenos">1907</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="n">current_eobt</span> <span class="o">+</span> <span class="n">wait_time</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1908"><a href="#AirlineFlightPlanner.consider_waiting_pax-1908"><span class="linenos">1908</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is requesting departing reassessment in order to wait for pax, wait time: &quot;</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1909"><a href="#AirlineFlightPlanner.consider_waiting_pax-1909"><span class="linenos">1909</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1910"><a href="#AirlineFlightPlanner.consider_waiting_pax-1910"><span class="linenos">1910</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1911"><a href="#AirlineFlightPlanner.consider_waiting_pax-1911"><span class="linenos">1911</span></a>				<span class="c1"># 	print(&quot;{} will request a departing reassessment because it considers waiting pax for flight {} (t={})&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1912"><a href="#AirlineFlightPlanner.consider_waiting_pax-1912"><span class="linenos">1912</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">tro</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1913"><a href="#AirlineFlightPlanner.consider_waiting_pax-1913"><span class="linenos">1913</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1914"><a href="#AirlineFlightPlanner.consider_waiting_pax-1914"><span class="linenos">1914</span></a>				<span class="c1"># EOBT changed: update eobt processes</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1915"><a href="#AirlineFlightPlanner.consider_waiting_pax-1915"><span class="linenos">1915</span></a>				<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1916"><a href="#AirlineFlightPlanner.consider_waiting_pax-1916"><span class="linenos">1916</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1917"><a href="#AirlineFlightPlanner.consider_waiting_pax-1917"><span class="linenos">1917</span></a>			<span class="c1"># for saving</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1918"><a href="#AirlineFlightPlanner.consider_waiting_pax-1918"><span class="linenos">1918</span></a>			<span class="n">wait_time_min</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1919"><a href="#AirlineFlightPlanner.consider_waiting_pax-1919"><span class="linenos">1919</span></a>			<span class="n">wait_time_max</span><span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1920"><a href="#AirlineFlightPlanner.consider_waiting_pax-1920"><span class="linenos">1920</span></a>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1921"><a href="#AirlineFlightPlanner.consider_waiting_pax-1921"><span class="linenos">1921</span></a>		<span class="c1"># save the wfp info</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1922"><a href="#AirlineFlightPlanner.consider_waiting_pax-1922"><span class="linenos">1922</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_missing_pax_groups</span><span class="p">,</span> <span class="n">wait_time_min</span><span class="p">,</span> <span class="n">wait_time_max</span><span class="p">,</span> <span class="n">wait_time</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.consider_waiting_pax-1923"><a href="#AirlineFlightPlanner.consider_waiting_pax-1923"><span class="linenos">1923</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_wfp_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.save_wfp_info" class="classattr">
                                        <input id="AirlineFlightPlanner.save_wfp_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_wfp_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">params</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.save_wfp_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.save_wfp_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.save_wfp_info-1925"><a href="#AirlineFlightPlanner.save_wfp_info-1925"><span class="linenos">1925</span></a>	<span class="k">def</span> <span class="nf">save_wfp_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1926"><a href="#AirlineFlightPlanner.save_wfp_info-1926"><span class="linenos">1926</span></a>		<span class="n">wfp_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_missing_pax_groups&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1927"><a href="#AirlineFlightPlanner.save_wfp_info-1927"><span class="linenos">1927</span></a>						<span class="s1">&#39;wait_time_min&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1928"><a href="#AirlineFlightPlanner.save_wfp_info-1928"><span class="linenos">1928</span></a>						<span class="s1">&#39;wait_time_max&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1929"><a href="#AirlineFlightPlanner.save_wfp_info-1929"><span class="linenos">1929</span></a>						<span class="s1">&#39;wait_time_chosen&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1930"><a href="#AirlineFlightPlanner.save_wfp_info-1930"><span class="linenos">1930</span></a>						<span class="p">}</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1931"><a href="#AirlineFlightPlanner.save_wfp_info-1931"><span class="linenos">1931</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1932"><a href="#AirlineFlightPlanner.save_wfp_info-1932"><span class="linenos">1932</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">wfp_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wfp_decision</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1933"><a href="#AirlineFlightPlanner.save_wfp_info-1933"><span class="linenos">1933</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1934"><a href="#AirlineFlightPlanner.save_wfp_info-1934"><span class="linenos">1934</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;t=</span><span class="si">{}</span><span class="s1">, PROBLEM, FP MISSING FOR FLIGHT </span><span class="si">{}</span><span class="s1"> WITH SOBT: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]))</span>
</span><span id="AirlineFlightPlanner.save_wfp_info-1935"><a href="#AirlineFlightPlanner.save_wfp_info-1935"><span class="linenos">1935</span></a>			<span class="k">raise</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_dci_l2_old</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1937"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1937"><span class="linenos">1937</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1938"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1938"><span class="linenos">1938</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1939"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1939"><span class="linenos">1939</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1940"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1940"><span class="linenos">1940</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1941"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1941"><span class="linenos">1941</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1942"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1942"><span class="linenos">1942</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1943"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1943"><span class="linenos">1943</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1944"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1944"><span class="linenos">1944</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1945"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1945"><span class="linenos">1945</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1946"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1946"><span class="linenos">1946</span></a><span class="sd">			- Up to EOBT: I have only potentital cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1947"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1947"><span class="linenos">1947</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1948"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1948"><span class="linenos">1948</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1949"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1949"><span class="linenos">1949</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1950"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1950"><span class="linenos">1950</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1951"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1951"><span class="linenos">1951</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1952"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1952"><span class="linenos">1952</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1953"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1953"><span class="linenos">1953</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1954"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1954"><span class="linenos">1954</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1955"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1955"><span class="linenos">1955</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1956"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1956"><span class="linenos">1956</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1957"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1957"><span class="linenos">1957</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1958"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1958"><span class="linenos">1958</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1959"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1959"><span class="linenos">1959</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1960"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1960"><span class="linenos">1960</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1961"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1961"><span class="linenos">1961</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1962"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1962"><span class="linenos">1962</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1963"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1963"><span class="linenos">1963</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1964"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1964"><span class="linenos">1964</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1965"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1965"><span class="linenos">1965</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1966"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1966"><span class="linenos">1966</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1967"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1967"><span class="linenos">1967</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1968"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1968"><span class="linenos">1968</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1969"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1969"><span class="linenos">1969</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1970"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1970"><span class="linenos">1970</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1971"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1971"><span class="linenos">1971</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1972"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1972"><span class="linenos">1972</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1973"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1973"><span class="linenos">1973</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1974"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1974"><span class="linenos">1974</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1975"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1975"><span class="linenos">1975</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1976"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1976"><span class="linenos">1976</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1977"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1977"><span class="linenos">1977</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1978"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1978"><span class="linenos">1978</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1979"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1979"><span class="linenos">1979</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1980"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1980"><span class="linenos">1980</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1981"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1981"><span class="linenos">1981</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1982"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1982"><span class="linenos">1982</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1983"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1983"><span class="linenos">1983</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1984"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1984"><span class="linenos">1984</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1985"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1985"><span class="linenos">1985</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1986"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1986"><span class="linenos">1986</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1987"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1987"><span class="linenos">1987</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1988"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1988"><span class="linenos">1988</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1989"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1989"><span class="linenos">1989</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1990"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1990"><span class="linenos">1990</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1991"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1991"><span class="linenos">1991</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1992"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1992"><span class="linenos">1992</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1993"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1993"><span class="linenos">1993</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1994"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1994"><span class="linenos">1994</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1995"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1995"><span class="linenos">1995</span></a>				<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1996"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1996"><span class="linenos">1996</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1997"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1997"><span class="linenos">1997</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1998"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1998"><span class="linenos">1998</span></a>				<span class="c1"># DOC</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1999"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-1999"><span class="linenos">1999</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2000"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2000"><span class="linenos">2000</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2001"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2001"><span class="linenos">2001</span></a>				<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2002"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2002"><span class="linenos">2002</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2003"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2003"><span class="linenos">2003</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2004"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2004"><span class="linenos">2004</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2005"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2005"><span class="linenos">2005</span></a>				<span class="c1"># cost_transfer0 = 0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2006"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2006"><span class="linenos">2006</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2007"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2007"><span class="linenos">2007</span></a>				<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2008"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2008"><span class="linenos">2008</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2009"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2009"><span class="linenos">2009</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2010"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2010"><span class="linenos">2010</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2011"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2011"><span class="linenos">2011</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2012"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2012"><span class="linenos">2012</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2013"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2013"><span class="linenos">2013</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2014"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2014"><span class="linenos">2014</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2015"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2015"><span class="linenos">2015</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2016"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2016"><span class="linenos">2016</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2017"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2017"><span class="linenos">2017</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2018"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2018"><span class="linenos">2018</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2019"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2019"><span class="linenos">2019</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2020"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2_old-2020"><span class="linenos">2020</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>Used to assess cost of not recovering some delay coupling wait for pax and
departure delay at pushback_ready - 5.</p>

<p>waited_pax - passenger that are going to be waited for, in order to estimate the cost better
as those are now considered on board the aircraft</p>

<p>This cost function built by segments:
        - Up to EOBT: I have only potentital cost of dep. delay (if SOBT &lt; EOBT)
        - After EOBT: I have potentially more delay by waiting a pax group.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2" class="classattr">
                                        <input id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_dci_l2</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">flight_uid</span>,</span><span class="param">	<span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">diff</span><span class="o">=</span><span class="kc">True</span>,</span><span class="param">	<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2022"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2022"><span class="linenos">2022</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">waited_pax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2023"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2023"><span class="linenos">2023</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2024"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2024"><span class="linenos">2024</span></a><span class="sd">		Used to assess cost of not recovering some delay coupling wait for pax and</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2025"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2025"><span class="linenos">2025</span></a><span class="sd">		departure delay at pushback_ready - 5.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2026"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2026"><span class="linenos">2026</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2027"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2027"><span class="linenos">2027</span></a><span class="sd">		waited_pax - passenger that are going to be waited for, in order to estimate the cost better</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2028"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2028"><span class="linenos">2028</span></a><span class="sd">		as those are now considered on board the aircraft</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2029"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2029"><span class="linenos">2029</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2030"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2030"><span class="linenos">2030</span></a><span class="sd">		This cost function built by segments:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2031"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2031"><span class="linenos">2031</span></a><span class="sd">			- Up to EOBT: I have only potential cost of dep. delay (if SOBT &lt; EOBT)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2032"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2032"><span class="linenos">2032</span></a><span class="sd">			- After EOBT: I have potentially more delay by waiting a pax group.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2033"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2033"><span class="linenos">2033</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2034"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2034"><span class="linenos">2034</span></a>		<span class="k">if</span> <span class="n">waited_pax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2035"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2035"><span class="linenos">2035</span></a>			<span class="n">waited_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2036"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2036"><span class="linenos">2036</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2037"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2037"><span class="linenos">2037</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2038"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2038"><span class="linenos">2038</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2039"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2039"><span class="linenos">2039</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>  <span class="c1"># this is departure delay</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2040"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2040"><span class="linenos">2040</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2041"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2041"><span class="linenos">2041</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2042"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2042"><span class="linenos">2042</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_ready_to_board_checklist&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">waited_pax</span>  <span class="c1"># those are surely flying</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2043"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2043"><span class="linenos">2043</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2044"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2044"><span class="linenos">2044</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2045"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2045"><span class="linenos">2045</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2046"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2046"><span class="linenos">2046</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2047"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2047"><span class="linenos">2047</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2048"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2048"><span class="linenos">2048</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2049"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2049"><span class="linenos">2049</span></a>									<span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2050"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2050"><span class="linenos">2050</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2051"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2051"><span class="linenos">2051</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2052"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2052"><span class="linenos">2052</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2053"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2053"><span class="linenos">2053</span></a>			<span class="c1"># Soft cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2054"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2054"><span class="linenos">2054</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2055"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2055"><span class="linenos">2055</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2056"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2056"><span class="linenos">2056</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2057"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2057"><span class="linenos">2057</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2058"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2058"><span class="linenos">2058</span></a>			<span class="c1"># Compensation</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2059"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2059"><span class="linenos">2059</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2060"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2060"><span class="linenos">2060</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2061"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2061"><span class="linenos">2061</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2062"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2062"><span class="linenos">2062</span></a>			<span class="c1"># cost_transfer = 0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2063"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2063"><span class="linenos">2063</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2064"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2064"><span class="linenos">2064</span></a>			<span class="c1"># Curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2065"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2065"><span class="linenos">2065</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2066"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2066"><span class="linenos">2066</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2067"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2067"><span class="linenos">2067</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2068"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2068"><span class="linenos">2068</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2069"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2069"><span class="linenos">2069</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2070"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2070"><span class="linenos">2070</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2071"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2071"><span class="linenos">2071</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2072"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2072"><span class="linenos">2072</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2073"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2073"><span class="linenos">2073</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2074"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2074"><span class="linenos">2074</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2075"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2075"><span class="linenos">2075</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l2&#39;</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2076"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2076"><span class="linenos">2076</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2077"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2077"><span class="linenos">2077</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2078"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2078"><span class="linenos">2078</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2079"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2079"><span class="linenos">2079</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2080"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2080"><span class="linenos">2080</span></a>
</span><span id="AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2081"><a href="#AirlineFlightPlanner.build_delay_cost_functions_dci_l2-2081"><span class="linenos">2081</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>Used to assess cost of not recovering some delay coupling wait for pax and
departure delay at pushback_ready - 5.</p>

<p>waited_pax - passenger that are going to be waited for, in order to estimate the cost better
as those are now considered on board the aircraft</p>

<p>This cost function built by segments:
        - Up to EOBT: I have only potential cost of dep. delay (if SOBT &lt; EOBT)
        - After EOBT: I have potentially more delay by waiting a pax group.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.calculate_missing_pax_delays" class="classattr">
                                        <input id="AirlineFlightPlanner.calculate_missing_pax_delays-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_missing_pax_delays</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">missing_pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.calculate_missing_pax_delays-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.calculate_missing_pax_delays"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2083"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2083"><span class="linenos">2083</span></a>	<span class="k">def</span> <span class="nf">calculate_missing_pax_delays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2084"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2084"><span class="linenos">2084</span></a>		<span class="n">pax_delays</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># how long needed to wait for all pax in missing_pax</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2085"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2085"><span class="linenos">2085</span></a>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2086"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2086"><span class="linenos">2086</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">missing_pax</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2087"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2087"><span class="linenos">2087</span></a>			<span class="n">previous_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()[</span><span class="nb">max</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2088"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2088"><span class="linenos">2088</span></a>			<span class="n">previous_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">previous_flight</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2089"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2089"><span class="linenos">2089</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2090"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2090"><span class="linenos">2090</span></a><span class="sd">			if previous_flight not in self.agent.aoc_flights_info.keys():</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2091"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2091"><span class="linenos">2091</span></a><span class="sd">				previous_eibt = self.agent.other_aoc_flight_plans[previous_flight].eibt</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2092"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2092"><span class="linenos">2092</span></a><span class="sd">			else:</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2093"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2093"><span class="linenos">2093</span></a><span class="sd">				previous_eibt = self.agent.aoc_flights_info[previous_flight][&#39;FP&#39;].eibt</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2094"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2094"><span class="linenos">2094</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2095"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2095"><span class="linenos">2095</span></a>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2096"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2096"><span class="linenos">2096</span></a>			<span class="n">pax_delays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">previous_eibt</span> <span class="o">+</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2097"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2097"><span class="linenos">2097</span></a>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2098"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2098"><span class="linenos">2098</span></a>		<span class="c1"># tuples of pax groups and their estimated delays (times they need to be waited for)</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2099"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2099"><span class="linenos">2099</span></a>		<span class="n">delayed_pax_groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delays</span><span class="p">)]</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2100"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2100"><span class="linenos">2100</span></a>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2101"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2101"><span class="linenos">2101</span></a>		<span class="c1"># sort from the smallest delay</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2102"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2102"><span class="linenos">2102</span></a>		<span class="n">delayed_pax_sorted</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">delayed_pax_groups</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2103"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2103"><span class="linenos">2103</span></a>
</span><span id="AirlineFlightPlanner.calculate_missing_pax_delays-2104"><a href="#AirlineFlightPlanner.calculate_missing_pax_delays-2104"><span class="linenos">2104</span></a>		<span class="k">return</span> <span class="n">delayed_pax_sorted</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.cost_wait_for_pax_group" class="classattr">
                                        <input id="AirlineFlightPlanner.cost_wait_for_pax_group-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cost_wait_for_pax_group</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">pax_delay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.cost_wait_for_pax_group-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.cost_wait_for_pax_group"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2106"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2106"><span class="linenos">2106</span></a>	<span class="k">def</span> <span class="nf">cost_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2107"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2107"><span class="linenos">2107</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2108"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2108"><span class="linenos">2108</span></a><span class="sd">		Cost of waiting for pax group for pax_delay time, i.e. cost of delaying</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2109"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2109"><span class="linenos">2109</span></a><span class="sd">		flight_uid for pax_delay time</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2110"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2110"><span class="linenos">2110</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2111"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2111"><span class="linenos">2111</span></a>		<span class="n">cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">factor_in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;non_atfm_delay&#39;</span><span class="p">],</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2112"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2112"><span class="linenos">2112</span></a>
</span><span id="AirlineFlightPlanner.cost_wait_for_pax_group-2113"><a href="#AirlineFlightPlanner.cost_wait_for_pax_group-2113"><span class="linenos">2113</span></a>		<span class="k">return</span> <span class="n">cost_func</span><span class="p">(</span><span class="n">pax_delay</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Cost of waiting for pax group for pax_delay time, i.e. cost of delaying
flight_uid for pax_delay time</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.cost_not_wait_for_pax_group" class="classattr">
                                        <input id="AirlineFlightPlanner.cost_not_wait_for_pax_group-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cost_not_wait_for_pax_group</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">missing_pax</span>, </span><span class="param"><span class="n">pax_delay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.cost_not_wait_for_pax_group-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.cost_not_wait_for_pax_group"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2115"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2115"><span class="linenos">2115</span></a>	<span class="k">def</span> <span class="nf">cost_not_wait_for_pax_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2116"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2116"><span class="linenos">2116</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2117"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2117"><span class="linenos">2117</span></a><span class="sd">		Cost of not waiting for pax groups &quot;missing_pax</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2118"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2118"><span class="linenos">2118</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2119"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2119"><span class="linenos">2119</span></a><span class="sd">		If I don&#39;t wait for a pax group, I will have to deal with the following potential costs:</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2120"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2120"><span class="linenos">2120</span></a><span class="sd">			- rebooking them (transfer costs) - definitely</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2121"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2121"><span class="linenos">2121</span></a><span class="sd">			- soft costs</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2122"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2122"><span class="linenos">2122</span></a><span class="sd">			- compensation</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2123"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2123"><span class="linenos">2123</span></a><span class="sd">			- duty of care</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2124"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2124"><span class="linenos">2124</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2125"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2125"><span class="linenos">2125</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2126"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2126"><span class="linenos">2126</span></a>		<span class="n">not_wait_cost</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2127"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2127"><span class="linenos">2127</span></a>		<span class="k">for</span> <span class="n">pax</span><span class="p">,</span> <span class="n">delay</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">missing_pax</span><span class="p">,</span> <span class="n">pax_delay</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2128"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2128"><span class="linenos">2128</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2129"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2129"><span class="linenos">2129</span></a>							<span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># DELAY ALREADY ACCOUNTS FOR MCT!!</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2130"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2130"><span class="linenos">2130</span></a>							<span class="n">from_airport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2131"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2131"><span class="linenos">2131</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2132"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2132"><span class="linenos">2132</span></a>			<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2133"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2133"><span class="linenos">2133</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2134"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2134"><span class="linenos">2134</span></a>			<span class="c1"># itineraries_cost_matrix = np.concatenate((soft_cost_pp, transfer_costs_pp, compensation_costs_pp, doc_costs_pp), axis=0)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2135"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2135"><span class="linenos">2135</span></a>			<span class="c1"># print(&quot;Itineraries costs are: &quot;, soft_cost_pp.shape, transfer_costs_pp.shape, compensation_costs_pp, doc_costs_pp)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2136"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2136"><span class="linenos">2136</span></a>			<span class="c1"># print(&quot;Itinerary cost matrix is: &quot;, itineraries_cost_matrix)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2137"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2137"><span class="linenos">2137</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2138"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2138"><span class="linenos">2138</span></a>			<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2139"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2139"><span class="linenos">2139</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2140"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2140"><span class="linenos">2140</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2141"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2141"><span class="linenos">2141</span></a>				<span class="c1"># print(&quot;Total cost pp is: &quot;, total_cost_pp)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2142"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2142"><span class="linenos">2142</span></a>				<span class="c1"># print(&quot;Foud reallocation options for &quot;, pax, &quot; are: &quot;, reallocation_options)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2143"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2143"><span class="linenos">2143</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2144"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2144"><span class="linenos">2144</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2145"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2145"><span class="linenos">2145</span></a>				<span class="c1"># print(&quot;There are no found itineraries. Cost of the overnight stay!&quot;)</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2146"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2146"><span class="linenos">2146</span></a>				<span class="c1"># pax has to be cared for overnight</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2147"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2147"><span class="linenos">2147</span></a>				<span class="n">not_wait_cost</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_overnight_care</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span> <span class="o">*</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2148"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2148"><span class="linenos">2148</span></a>
</span><span id="AirlineFlightPlanner.cost_not_wait_for_pax_group-2149"><a href="#AirlineFlightPlanner.cost_not_wait_for_pax_group-2149"><span class="linenos">2149</span></a>		<span class="k">return</span> <span class="n">not_wait_cost</span>
</span></pre></div>


            <div class="docstring"><p>Cost of not waiting for pax groups "missing_pax</p>

<p>If I don't wait for a pax group, I will have to deal with the following potential costs:
        - rebooking them (transfer costs) - definitely
        - soft costs
        - compensation
        - duty of care</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.cost_non_pax_curfew" class="classattr">
                                        <input id="AirlineFlightPlanner.cost_non_pax_curfew-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cost_non_pax_curfew</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.cost_non_pax_curfew-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.cost_non_pax_curfew"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.cost_non_pax_curfew-2151"><a href="#AirlineFlightPlanner.cost_non_pax_curfew-2151"><span class="linenos">2151</span></a>	<span class="k">def</span> <span class="nf">cost_non_pax_curfew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.cost_non_pax_curfew-2152"><a href="#AirlineFlightPlanner.cost_non_pax_curfew-2152"><span class="linenos">2152</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.cost_non_pax_curfew-2153"><a href="#AirlineFlightPlanner.cost_non_pax_curfew-2153"><span class="linenos">2153</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="AirlineFlightPlanner.cost_non_pax_curfew-2154"><a href="#AirlineFlightPlanner.cost_non_pax_curfew-2154"><span class="linenos">2154</span></a>		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_nonpax_cost</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.estimate_pax_curfew_cost" class="classattr">
                                        <input id="AirlineFlightPlanner.estimate_pax_curfew_cost-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">estimate_pax_curfew_cost</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.estimate_pax_curfew_cost-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.estimate_pax_curfew_cost"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2156"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2156"><span class="linenos">2156</span></a>	<span class="k">def</span> <span class="nf">estimate_pax_curfew_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2157"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2157"><span class="linenos">2157</span></a>		<span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">get_aircraft</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2158"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2158"><span class="linenos">2158</span></a>		<span class="n">wtc</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">wtc</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2159"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2159"><span class="linenos">2159</span></a>		<span class="n">dict_estimated_costs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wtc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dict_curfew_estimated_pax_avg_costs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2160"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2160"><span class="linenos">2160</span></a>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2161"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2161"><span class="linenos">2161</span></a>		<span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_duty_of_care&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2162"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2162"><span class="linenos">2162</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_soft_cost&#39;</span><span class="p">]</span> <span class="o">+</span> \
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2163"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2163"><span class="linenos">2163</span></a>						<span class="n">dict_estimated_costs</span><span class="p">[</span><span class="s1">&#39;avg_transfer_cost&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2164"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2164"><span class="linenos">2164</span></a>						<span class="c1">#avg_compensation_cost</span>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2165"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2165"><span class="linenos">2165</span></a>
</span><span id="AirlineFlightPlanner.estimate_pax_curfew_cost-2166"><a href="#AirlineFlightPlanner.estimate_pax_curfew_cost-2166"><span class="linenos">2166</span></a>		<span class="k">return</span> <span class="n">estimated_cost</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.calculate_overnight_care" class="classattr">
                                        <input id="AirlineFlightPlanner.calculate_overnight_care-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">calculate_overnight_care</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">delay</span>, </span><span class="param"><span class="n">pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.calculate_overnight_care-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.calculate_overnight_care"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.calculate_overnight_care-2168"><a href="#AirlineFlightPlanner.calculate_overnight_care-2168"><span class="linenos">2168</span></a>	<span class="k">def</span> <span class="nf">calculate_overnight_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.calculate_overnight_care-2169"><a href="#AirlineFlightPlanner.calculate_overnight_care-2169"><span class="linenos">2169</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.calculate_overnight_care-2170"><a href="#AirlineFlightPlanner.calculate_overnight_care-2170"><span class="linenos">2170</span></a>
</span><span id="AirlineFlightPlanner.calculate_overnight_care-2171"><a href="#AirlineFlightPlanner.calculate_overnight_care-2171"><span class="linenos">2171</span></a>		<span class="k">return</span> <span class="n">doc</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.plot_wait_pax_costs" class="classattr">
                                        <input id="AirlineFlightPlanner.plot_wait_pax_costs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">plot_wait_pax_costs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wait_costs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.plot_wait_pax_costs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.plot_wait_pax_costs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2173"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2173"><span class="linenos">2173</span></a>	<span class="nd">@staticmethod</span>
</span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2174"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2174"><span class="linenos">2174</span></a>	<span class="k">def</span> <span class="nf">plot_wait_pax_costs</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2175"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2175"><span class="linenos">2175</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wait_costs</span><span class="p">)),</span> <span class="n">wait_costs</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2176"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2176"><span class="linenos">2176</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost of wait/no-wait options: no-wait + each pax group wait&quot;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2177"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2177"><span class="linenos">2177</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.plot_wait_pax_costs-2178"><a href="#AirlineFlightPlanner.plot_wait_pax_costs-2178"><span class="linenos">2178</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.reassess_departure_turnaround" class="classattr">
                                        <input id="AirlineFlightPlanner.reassess_departure_turnaround-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reassess_departure_turnaround</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">ac_ready_at_time</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.reassess_departure_turnaround-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.reassess_departure_turnaround"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2180"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2180"><span class="linenos">2180</span></a>	<span class="k">def</span> <span class="nf">reassess_departure_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2181"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2181"><span class="linenos">2181</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2182"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2182"><span class="linenos">2182</span></a><span class="sd">		!!!Black magic warning!!!</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2183"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2183"><span class="linenos">2183</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2184"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2184"><span class="linenos">2184</span></a><span class="sd">		This function is tricky to understand and should not be changed lightly.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2185"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2185"><span class="linenos">2185</span></a><span class="sd">		In short, it checks if the ac_ready_time is after the eobt. If not,</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2186"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2186"><span class="linenos">2186</span></a><span class="sd">		the flight tries to pull the eobt as close as possible to the sobt.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2187"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2187"><span class="linenos">2187</span></a><span class="sd">		If the ac_ready_time is indeed after the eobt, the flight requests</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2188"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2188"><span class="linenos">2188</span></a><span class="sd">		another ATFM slot if missed its own. After it got another slot (or not),</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2189"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2189"><span class="linenos">2189</span></a><span class="sd">		it completely recomputes its options if the delay is big enough (30 minutes),</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2190"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2190"><span class="linenos">2190</span></a><span class="sd">		or just resubmits its delayed flight plan to the NM otherwise.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2191"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2191"><span class="linenos">2191</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2192"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2192"><span class="linenos">2192</span></a><span class="sd">		In any case, if the eobt is changed, the flight plan is resubmitted.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2193"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2193"><span class="linenos">2193</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2194"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2194"><span class="linenos">2194</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2195"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2195"><span class="linenos">2195</span></a>		<span class="n">aoc_flight_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2196"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2196"><span class="linenos">2196</span></a>		<span class="c1"># try:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2197"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2197"><span class="linenos">2197</span></a>		<span class="c1"># 	fp = aoc_flight_info[&#39;fp_options&#39;][aoc_flight_info[&#39;fp_option&#39;]]</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2198"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2198"><span class="linenos">2198</span></a>		<span class="c1"># except:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2199"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2199"><span class="linenos">2199</span></a>		<span class="c1"># 	print(flight_uid)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2200"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2200"><span class="linenos">2200</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_option&#39;])</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2201"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2201"><span class="linenos">2201</span></a>		<span class="c1"># 	print(aoc_flight_info[&#39;fp_options&#39;])</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2202"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2202"><span class="linenos">2202</span></a>		<span class="c1"># 	raise</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2203"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2203"><span class="linenos">2203</span></a>		<span class="n">fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2204"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2204"><span class="linenos">2204</span></a>		<span class="n">sobt</span> <span class="o">=</span> <span class="n">aoc_flight_info</span><span class="p">[</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2205"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2205"><span class="linenos">2205</span></a>		<span class="n">eobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">eobt</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2206"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2206"><span class="linenos">2206</span></a>		<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2207"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2207"><span class="linenos">2207</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2208"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2208"><span class="linenos">2208</span></a>		<span class="n">reactionary_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ac_ready_at_time</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2209"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2209"><span class="linenos">2209</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2210"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2210"><span class="linenos">2210</span></a>		<span class="c1"># 	print(&#39;AOC is reassessing the TAT for {}. Reactionary delay: {}; EOBT {}&#39;.format(flight_uid, reactionary_delay, eobt))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2211"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2211"><span class="linenos">2211</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2212"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2212"><span class="linenos">2212</span></a>		<span class="n">extra_delay</span> <span class="o">=</span> <span class="n">reactionary_delay</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2213"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2213"><span class="linenos">2213</span></a>		<span class="k">if</span> <span class="n">reactionary_delay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2214"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2214"><span class="linenos">2214</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2215"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2215"><span class="linenos">2215</span></a>			<span class="c1"># 	print(&#39;AOC did not find any reactionary delay for flight {} with {}, it will adjust the EOBT and resubmit if needed&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2216"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2216"><span class="linenos">2216</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2217"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2217"><span class="linenos">2217</span></a>			<span class="c1"># There is no extra delay, so just update the eobt with the current to do the</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2218"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2218"><span class="linenos">2218</span></a>			<span class="c1"># wait_for_push_back_ready</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2219"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2219"><span class="linenos">2219</span></a>			<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2220"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2220"><span class="linenos">2220</span></a>				<span class="c1"># Try to bring closer the eobt</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2221"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2221"><span class="linenos">2221</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">sobt</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2222"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2222"><span class="linenos">2222</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2223"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2223"><span class="linenos">2223</span></a>				<span class="k">if</span> <span class="n">new_eobt</span><span class="o">!=</span><span class="n">eobt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2224"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2224"><span class="linenos">2224</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;updates eobt and send a flight plan submission&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2225"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2225"><span class="linenos">2225</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2226"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2226"><span class="linenos">2226</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2227"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2227"><span class="linenos">2227</span></a>					<span class="c1"># 	print(&#39;AOC has updated the EOBT based on the aircraft ready time and is resubmitting the {} for flight {}&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2228"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2228"><span class="linenos">2228</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2229"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2229"><span class="linenos">2229</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2230"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2230"><span class="linenos">2230</span></a>					<span class="c1"># This is the only place where &quot;manually&quot; we need to</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2231"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2231"><span class="linenos">2231</span></a>					<span class="c1"># update_eobt_processes as fp is the same (we don&#39;t resubmit it)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2232"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2232"><span class="linenos">2232</span></a>					<span class="c1"># everywhere else we resubmit the fp and as we &quot;own&quot; the ac</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2233"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2233"><span class="linenos">2233</span></a>					<span class="c1"># that triggers the update_eobt_process via send_flight_plan_submission</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2234"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2234"><span class="linenos">2234</span></a>					<span class="c1"># self.update_eobt_processes(flight_uid, new_eobt)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2235"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2235"><span class="linenos">2235</span></a>					<span class="c1"># aprint(flight_str(flight_uid), &#39;does not do anything&#39;)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2236"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2236"><span class="linenos">2236</span></a>					<span class="k">pass</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2237"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2237"><span class="linenos">2237</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2238"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2238"><span class="linenos">2238</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2239"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2239"><span class="linenos">2239</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2240"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2240"><span class="linenos">2240</span></a>			<span class="c1"># 	print(&#39;AOC found some reactionary delay for flight {} with {}, it will reassess how bad the situation is&#39;.format(fp, flight_uid))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2241"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2241"><span class="linenos">2241</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2242"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2242"><span class="linenos">2242</span></a>			<span class="c1"># There has been an additional delay, reassess where we are.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2243"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2243"><span class="linenos">2243</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2244"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2244"><span class="linenos">2244</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has an extra delay of:&#39;</span><span class="p">,</span> <span class="n">extra_delay</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2245"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2245"><span class="linenos">2245</span></a>						<span class="s1">&#39;and is regulated (missed the ATFM slot)&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2246"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2246"><span class="linenos">2246</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2247"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2247"><span class="linenos">2247</span></a>				<span class="c1"># We missed the ATFM slot</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2248"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2248"><span class="linenos">2248</span></a>				<span class="n">received_atfm_message_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2249"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2249"><span class="linenos">2249</span></a>				<span class="c1"># self.agent.fp_waiting_atfm[fp.get_unique_id()] = received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2250"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2250"><span class="linenos">2250</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2251"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2251"><span class="linenos">2251</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2252"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2252"><span class="linenos">2252</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_ATFM_request</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">received_atfm_message_event</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2253"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2253"><span class="linenos">2253</span></a>				<span class="k">yield</span> <span class="n">received_atfm_message_event</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2254"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2254"><span class="linenos">2254</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2255"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2255"><span class="linenos">2255</span></a>				<span class="n">cobt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">cobt</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2256"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2256"><span class="linenos">2256</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2257"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2257"><span class="linenos">2257</span></a>				<span class="k">if</span> <span class="n">cobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2258"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2258"><span class="linenos">2258</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">cobt</span> <span class="o">-</span> <span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2259"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2259"><span class="linenos">2259</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2260"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2260"><span class="linenos">2260</span></a>					<span class="c1"># This could happen if prevoulsy flight has regulation at airport</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2261"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2261"><span class="linenos">2261</span></a>					<span class="c1"># and not it&#39;s so late that it&#39;s not regulated anymore. cobt will be None</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2262"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2262"><span class="linenos">2262</span></a>					<span class="n">extra_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2263"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2263"><span class="linenos">2263</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2264"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2264"><span class="linenos">2264</span></a>				<span class="c1"># mprint(flight_str(flight_uid), &#39;has an extra delay of:&#39;, extra_delay,</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2265"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2265"><span class="linenos">2265</span></a>				<span class="c1"># 		&#39;and a cobt of&#39;, cobt)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2266"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2266"><span class="linenos">2266</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2267"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2267"><span class="linenos">2267</span></a>			<span class="c1"># Whether or not you got a new slot, you kept it, or you did not have one,</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2268"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2268"><span class="linenos">2268</span></a>			<span class="c1"># you check if the delay is greater than 30. If so, you recompute a completely</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2269"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2269"><span class="linenos">2269</span></a>			<span class="c1"># new FP. Otherwise you just resubmit the same FP with a new eobt.</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2270"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2270"><span class="linenos">2270</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2271"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2271"><span class="linenos">2271</span></a>			<span class="c1"># print(&#39;IN AOC CHECKING STUFF FOR FLIGHT {} (with ELT {}, extra_delay: {})&#39;.format(flight_uid, fp.get_estimated_landing_time(), extra_delay))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2272"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2272"><span class="linenos">2272</span></a>			<span class="k">if</span> <span class="n">extra_delay</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">min_time_for_FP_recomputation</span><span class="p">:</span>  <span class="c1"># TODO: no need to recompute if not in ATFM regulation, check that...</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2273"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2273"><span class="linenos">2273</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;asks for a recomputation of the FP&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2274"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2274"><span class="linenos">2274</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2275"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2275"><span class="linenos">2275</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2276"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2276"><span class="linenos">2276</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time and is asking for a complete recomputation of the flight plan for flight {} (ac_ready_at_time: {})&#39;.format(flight_uid, ac_ready_at_time))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2277"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2277"><span class="linenos">2277</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2278"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2278"><span class="linenos">2278</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2279"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2279"><span class="linenos">2279</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">=</span><span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2280"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2280"><span class="linenos">2280</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2281"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2281"><span class="linenos">2281</span></a>				<span class="c1"># PROBLEM: cobt can be before ac_ready_at_time!!!</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2282"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2282"><span class="linenos">2282</span></a>				<span class="n">new_eobt</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ac_ready_at_time</span><span class="p">,</span> <span class="n">eobt</span> <span class="o">+</span> <span class="n">extra_delay</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2283"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2283"><span class="linenos">2283</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;sets new eobt of fp to&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;, then resubmit the flight plan&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2284"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2284"><span class="linenos">2284</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2285"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2285"><span class="linenos">2285</span></a>				<span class="c1"># 	print(&#39;AOC reassessed the departure time, updated the EOBT and resubmit the same flight plan ({}) for flight {} (new EOBT: {})&#39;.format(fp, flight_uid, new_eobt))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2286"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2286"><span class="linenos">2286</span></a>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2287"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2287"><span class="linenos">2287</span></a>				<span class="n">fp</span><span class="o">.</span><span class="n">update_eobt</span><span class="p">(</span><span class="n">new_eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2288"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2288"><span class="linenos">2288</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2289"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2289"><span class="linenos">2289</span></a>				<span class="c1">#    print(&#39;IN AOC SUBMITTING FLIGHT PLAN FOR FLIGHT 4 {} (with ELT {})&#39;.format(flight_uid, fp.get_estimated_landing_time()))</span>
</span><span id="AirlineFlightPlanner.reassess_departure_turnaround-2290"><a href="#AirlineFlightPlanner.reassess_departure_turnaround-2290"><span class="linenos">2290</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_flight_plan_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>  <span class="c1"># if missed curfew pick up by NM</span>
</span></pre></div>


            <div class="docstring"><p>!!!Black magic warning!!!</p>

<p>This function is tricky to understand and should not be changed lightly.
In short, it checks if the ac_ready_time is after the eobt. If not,
the flight tries to pull the eobt as close as possible to the sobt.
If the ac_ready_time is indeed after the eobt, the flight requests
another ATFM slot if missed its own. After it got another slot (or not),
it completely recomputes its options if the delay is big enough (30 minutes),
or just resubmits its delayed flight plan to the NM otherwise.</p>

<p>In any case, if the eobt is changed, the flight plan is resubmitted.</p>
</div>


                            </div>
                            <div id="AirlineFlightPlanner.send_request_select_option" class="classattr">
                                        <input id="AirlineFlightPlanner.send_request_select_option-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_request_select_option</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cost_options</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_request_select_option-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_request_select_option"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_request_select_option-2292"><a href="#AirlineFlightPlanner.send_request_select_option-2292"><span class="linenos">2292</span></a>	<span class="k">def</span> <span class="nf">send_request_select_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cost_options</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_request_select_option-2293"><a href="#AirlineFlightPlanner.send_request_select_option-2293"><span class="linenos">2293</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_request_select_option-2294"><a href="#AirlineFlightPlanner.send_request_select_option-2294"><span class="linenos">2294</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner.send_request_select_option-2295"><a href="#AirlineFlightPlanner.send_request_select_option-2295"><span class="linenos">2295</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;select_flight_option_request&#39;</span>
</span><span id="AirlineFlightPlanner.send_request_select_option-2296"><a href="#AirlineFlightPlanner.send_request_select_option-2296"><span class="linenos">2296</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost_options&#39;</span><span class="p">:</span> <span class="n">cost_options</span><span class="p">,</span> <span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_request_select_option-2297"><a href="#AirlineFlightPlanner.send_request_select_option-2297"><span class="linenos">2297</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_ATFM_request" class="classattr">
                                        <input id="AirlineFlightPlanner.send_ATFM_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_ATFM_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">FP</span>, </span><span class="param"><span class="n">event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_ATFM_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_ATFM_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_ATFM_request-2299"><a href="#AirlineFlightPlanner.send_ATFM_request-2299"><span class="linenos">2299</span></a>	<span class="k">def</span> <span class="nf">send_ATFM_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2300"><a href="#AirlineFlightPlanner.send_ATFM_request-2300"><span class="linenos">2300</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2301"><a href="#AirlineFlightPlanner.send_ATFM_request-2301"><span class="linenos">2301</span></a>		<span class="c1"># 	print(&#39;send_ATFM_request for {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2302"><a href="#AirlineFlightPlanner.send_ATFM_request-2302"><span class="linenos">2302</span></a>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2303"><a href="#AirlineFlightPlanner.send_ATFM_request-2303"><span class="linenos">2303</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2304"><a href="#AirlineFlightPlanner.send_ATFM_request-2304"><span class="linenos">2304</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2305"><a href="#AirlineFlightPlanner.send_ATFM_request-2305"><span class="linenos">2305</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ATFM_request&#39;</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2306"><a href="#AirlineFlightPlanner.send_ATFM_request-2306"><span class="linenos">2306</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2307"><a href="#AirlineFlightPlanner.send_ATFM_request-2307"><span class="linenos">2307</span></a>						<span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2308"><a href="#AirlineFlightPlanner.send_ATFM_request-2308"><span class="linenos">2308</span></a>
</span><span id="AirlineFlightPlanner.send_ATFM_request-2309"><a href="#AirlineFlightPlanner.send_ATFM_request-2309"><span class="linenos">2309</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_flight_plan_update_no_compute" class="classattr">
                                        <input id="AirlineFlightPlanner.send_flight_plan_update_no_compute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_flight_plan_update_no_compute</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">FP</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_flight_plan_update_no_compute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_flight_plan_update_no_compute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2311"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2311"><span class="linenos">2311</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_update_no_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2312"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2312"><span class="linenos">2312</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2313"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2313"><span class="linenos">2313</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2314"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2314"><span class="linenos">2314</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_assigned_no_compute&#39;</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2315"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2315"><span class="linenos">2315</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_update_no_compute-2316"><a href="#AirlineFlightPlanner.send_flight_plan_update_no_compute-2316"><span class="linenos">2316</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_cancellation_flight_message" class="classattr">
                                        <input id="AirlineFlightPlanner.send_cancellation_flight_message-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_cancellation_flight_message</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_cancellation_flight_message-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_cancellation_flight_message"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2318"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2318"><span class="linenos">2318</span></a>	<span class="k">def</span> <span class="nf">send_cancellation_flight_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2319"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2319"><span class="linenos">2319</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2320"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2320"><span class="linenos">2320</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2321"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2321"><span class="linenos">2321</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_cancellation&#39;</span>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2322"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2322"><span class="linenos">2322</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2323"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2323"><span class="linenos">2323</span></a>
</span><span id="AirlineFlightPlanner.send_cancellation_flight_message-2324"><a href="#AirlineFlightPlanner.send_cancellation_flight_message-2324"><span class="linenos">2324</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_flight_plan_submission" class="classattr">
                                        <input id="AirlineFlightPlanner.send_flight_plan_submission-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_flight_plan_submission</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">FP</span>, </span><span class="param"><span class="n">reception_event</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_flight_plan_submission-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_flight_plan_submission"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_flight_plan_submission-2326"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2326"><span class="linenos">2326</span></a>	<span class="k">def</span> <span class="nf">send_flight_plan_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> <span class="n">reception_event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2327"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2327"><span class="linenos">2327</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;curfew&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2328"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2328"><span class="linenos">2328</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2329"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2329"><span class="linenos">2329</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2330"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2330"><span class="linenos">2330</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_submission&#39;</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2331"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2331"><span class="linenos">2331</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2332"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2332"><span class="linenos">2332</span></a>						<span class="s1">&#39;reception_event&#39;</span><span class="p">:</span> <span class="n">reception_event</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2333"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2333"><span class="linenos">2333</span></a>		<span class="c1"># print(self.agent, &#39;is submitting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2334"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2334"><span class="linenos">2334</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2335"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2335"><span class="linenos">2335</span></a>		<span class="c1">#  	print(&#39;t= {} ; IN AOC SENDING FLIGHT PLAN SUBMISSION FOR {} WITH ELT {} (WITHOUT ATFM DELAY {})&#39;.format(self.agent.env.now,</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2336"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2336"><span class="linenos">2336</span></a>		<span class="c1"># 				flight_uid,</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2337"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2337"><span class="linenos">2337</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2338"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2338"><span class="linenos">2338</span></a>		<span class="c1"># 				self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_eta_wo_atfm(),</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2339"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2339"><span class="linenos">2339</span></a>		<span class="c1"># 				))</span>
</span><span id="AirlineFlightPlanner.send_flight_plan_submission-2340"><a href="#AirlineFlightPlanner.send_flight_plan_submission-2340"><span class="linenos">2340</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_FP_update" class="classattr">
                                        <input id="AirlineFlightPlanner.send_FP_update-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_FP_update</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">FP</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_FP_update-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_FP_update"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_FP_update-2342"><a href="#AirlineFlightPlanner.send_FP_update-2342"><span class="linenos">2342</span></a>	<span class="k">def</span> <span class="nf">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">FP</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_FP_update-2343"><a href="#AirlineFlightPlanner.send_FP_update-2343"><span class="linenos">2343</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_FP_update-2344"><a href="#AirlineFlightPlanner.send_FP_update-2344"><span class="linenos">2344</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.send_FP_update-2345"><a href="#AirlineFlightPlanner.send_FP_update-2345"><span class="linenos">2345</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flight_plan_update&#39;</span>
</span><span id="AirlineFlightPlanner.send_FP_update-2346"><a href="#AirlineFlightPlanner.send_FP_update-2346"><span class="linenos">2346</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;FP&#39;</span><span class="p">:</span> <span class="n">FP</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_FP_update-2347"><a href="#AirlineFlightPlanner.send_FP_update-2347"><span class="linenos">2347</span></a>
</span><span id="AirlineFlightPlanner.send_FP_update-2348"><a href="#AirlineFlightPlanner.send_FP_update-2348"><span class="linenos">2348</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_reallocation_pax_request" class="classattr">
                                        <input id="AirlineFlightPlanner.send_reallocation_pax_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_reallocation_pax_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paxs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_reallocation_pax_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_reallocation_pax_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2350"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2350"><span class="linenos">2350</span></a>	<span class="k">def</span> <span class="nf">send_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2351"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2351"><span class="linenos">2351</span></a>		<span class="c1"># This is an intra-agent message, so we use direct memory access</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2352"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2352"><span class="linenos">2352</span></a>		<span class="c1"># for optimsation.</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2353"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2353"><span class="linenos">2353</span></a>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2354"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2354"><span class="linenos">2354</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2355"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2355"><span class="linenos">2355</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2356"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2356"><span class="linenos">2356</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2357"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2357"><span class="linenos">2357</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2358"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2358"><span class="linenos">2358</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2359"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2359"><span class="linenos">2359</span></a>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2360"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2360"><span class="linenos">2360</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(AFP role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2361"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2361"><span class="linenos">2361</span></a>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2362"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2362"><span class="linenos">2362</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2363"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2363"><span class="linenos">2363</span></a>
</span><span id="AirlineFlightPlanner.send_reallocation_pax_request-2364"><a href="#AirlineFlightPlanner.send_reallocation_pax_request-2364"><span class="linenos">2364</span></a>		<span class="c1"># self.send(msg) # uncomment this to use the messaging server</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.update_eobt_processes" class="classattr">
                                        <input id="AirlineFlightPlanner.update_eobt_processes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_eobt_processes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">new_eobt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.update_eobt_processes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.update_eobt_processes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.update_eobt_processes-2366"><a href="#AirlineFlightPlanner.update_eobt_processes-2366"><span class="linenos">2366</span></a>	<span class="k">def</span> <span class="nf">update_eobt_processes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2367"><a href="#AirlineFlightPlanner.update_eobt_processes-2367"><span class="linenos">2367</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;EOBT update for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;(new_eobt:&#39;</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2368"><a href="#AirlineFlightPlanner.update_eobt_processes-2368"><span class="linenos">2368</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2369"><a href="#AirlineFlightPlanner.update_eobt_processes-2369"><span class="linenos">2369</span></a>		<span class="c1"># 	print(&quot;{} updates EOBT for flight {} (new_eobt: {})&quot;.format(self.agent, flight_uid, new_eobt))</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2370"><a href="#AirlineFlightPlanner.update_eobt_processes-2370"><span class="linenos">2370</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2371"><a href="#AirlineFlightPlanner.update_eobt_processes-2371"><span class="linenos">2371</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2372"><a href="#AirlineFlightPlanner.update_eobt_processes-2372"><span class="linenos">2372</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_FP_submission_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_FP_submission</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2373"><a href="#AirlineFlightPlanner.update_eobt_processes-2373"><span class="linenos">2373</span></a>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2374"><a href="#AirlineFlightPlanner.update_eobt_processes-2374"><span class="linenos">2374</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2375"><a href="#AirlineFlightPlanner.update_eobt_processes-2375"><span class="linenos">2375</span></a>			<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2376"><a href="#AirlineFlightPlanner.update_eobt_processes-2376"><span class="linenos">2376</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2377"><a href="#AirlineFlightPlanner.update_eobt_processes-2377"><span class="linenos">2377</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_delay_estimation_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_delay_estimation</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2378"><a href="#AirlineFlightPlanner.update_eobt_processes-2378"><span class="linenos">2378</span></a>			<span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2379"><a href="#AirlineFlightPlanner.update_eobt_processes-2379"><span class="linenos">2379</span></a>				<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;Delay estimation process has already been terminated, cannot interrupt it.&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2380"><a href="#AirlineFlightPlanner.update_eobt_processes-2380"><span class="linenos">2380</span></a>				<span class="k">pass</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2381"><a href="#AirlineFlightPlanner.update_eobt_processes-2381"><span class="linenos">2381</span></a>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2382"><a href="#AirlineFlightPlanner.update_eobt_processes-2382"><span class="linenos">2382</span></a>		<span class="c1"># Check if aircraft is already available for the flight</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2383"><a href="#AirlineFlightPlanner.update_eobt_processes-2383"><span class="linenos">2383</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2384"><a href="#AirlineFlightPlanner.update_eobt_processes-2384"><span class="linenos">2384</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2385"><a href="#AirlineFlightPlanner.update_eobt_processes-2385"><span class="linenos">2385</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_push_back_ready_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_push_back_ready</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2386"><a href="#AirlineFlightPlanner.update_eobt_processes-2386"><span class="linenos">2386</span></a>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2387"><a href="#AirlineFlightPlanner.update_eobt_processes-2387"><span class="linenos">2387</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">triggered</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2388"><a href="#AirlineFlightPlanner.update_eobt_processes-2388"><span class="linenos">2388</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interrupt</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.update_eobt_processes-2389"><a href="#AirlineFlightPlanner.update_eobt_processes-2389"><span class="linenos">2389</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;wait_until_pax_check_proc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_until_pax_check</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">new_eobt</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_atfm_slot" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_atfm_slot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_atfm_slot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_atfm_slot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_atfm_slot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2391"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2391"><span class="linenos">2391</span></a>	<span class="k">def</span> <span class="nf">wait_for_atfm_slot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2392"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2392"><span class="linenos">2392</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2393"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2393"><span class="linenos">2393</span></a>		<span class="k">if</span> <span class="s1">&#39;fp_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2394"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2394"><span class="linenos">2394</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;fp_uid&#39;</span><span class="p">]]</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2395"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2395"><span class="linenos">2395</span></a>		<span class="k">elif</span> <span class="s1">&#39;flight_uid&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2396"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2396"><span class="linenos">2396</span></a>			<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2397"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2397"><span class="linenos">2397</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2398"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2398"><span class="linenos">2398</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2399"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2399"><span class="linenos">2399</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2400"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2400"><span class="linenos">2400</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2401"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2401"><span class="linenos">2401</span></a>		<span class="n">FP</span><span class="o">.</span><span class="n">set_atfm_delay</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2402"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2402"><span class="linenos">2402</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2403"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2403"><span class="linenos">2403</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2404"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2404"><span class="linenos">2404</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 2 {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2405"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2405"><span class="linenos">2405</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2406"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2406"><span class="linenos">2406</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2407"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2407"><span class="linenos">2407</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2408"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2408"><span class="linenos">2408</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2409"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2409"><span class="linenos">2409</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2410"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2410"><span class="linenos">2410</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received ATFM slot for fp&#39;</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2411"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2411"><span class="linenos">2411</span></a>					<span class="n">flight_str</span><span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;with atfm delay&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2412"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2412"><span class="linenos">2412</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2413"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2413"><span class="linenos">2413</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">regulation</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2414"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2414"><span class="linenos">2414</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;atfm_delay&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">excempt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2415"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2415"><span class="linenos">2415</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2416"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2416"><span class="linenos">2416</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2417"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2417"><span class="linenos">2417</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 3 {}&#39;.format(FP.flight_uid))</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2418"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2418"><span class="linenos">2418</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2419"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2419"><span class="linenos">2419</span></a>		<span class="k">if</span> <span class="s1">&#39;event&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2420"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2420"><span class="linenos">2420</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2421"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2421"><span class="linenos">2421</span></a>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2422"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2422"><span class="linenos">2422</span></a>		<span class="c1"># if FP.flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_atfm_slot-2423"><a href="#AirlineFlightPlanner.wait_for_atfm_slot-2423"><span class="linenos">2423</span></a>		<span class="c1"># 	print(&#39;SETTING ATFM SLOT 4 {}&#39;.format(FP.flight_uid))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_FP_acceptance" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_FP_acceptance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_FP_acceptance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_FP_acceptance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_FP_acceptance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2425"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2425"><span class="linenos">2425</span></a>	<span class="k">def</span> <span class="nf">wait_for_FP_acceptance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2426"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2426"><span class="linenos">2426</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2427"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2427"><span class="linenos">2427</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2428"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2428"><span class="linenos">2428</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2429"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2429"><span class="linenos">2429</span></a>			<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reception_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2430"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2430"><span class="linenos">2430</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2431"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2431"><span class="linenos">2431</span></a>		<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;accepted&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2432"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2432"><span class="linenos">2432</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2433"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2433"><span class="linenos">2433</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight plan&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">],</span> <span class="s2">&quot;for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has been accepted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2434"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2434"><span class="linenos">2434</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s2">&quot;Flight plan aoc thinks FP for&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2435"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2435"><span class="linenos">2435</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2436"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2436"><span class="linenos">2436</span></a>			<span class="c1"># Clean other FP data in case they are re-used in the future</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2437"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2437"><span class="linenos">2437</span></a>			<span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">]:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2438"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2438"><span class="linenos">2438</span></a>				<span class="k">if</span> <span class="n">fp</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">!=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique_id</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2439"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2439"><span class="linenos">2439</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;non-submitted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2440"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2440"><span class="linenos">2440</span></a>					<span class="n">fp</span><span class="o">.</span><span class="n">atfm_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2441"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2441"><span class="linenos">2441</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2442"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2442"><span class="linenos">2442</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2443"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2443"><span class="linenos">2443</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;accepted&#39;</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2444"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2444"><span class="linenos">2444</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s1">&#39;accepted&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2445"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2445"><span class="linenos">2445</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prepare_accepted_fp</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2446"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2446"><span class="linenos">2446</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2447"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2447"><span class="linenos">2447</span></a>			<span class="c1"># 	print(&#39;AOC triggers FP update for flight {}&#39;.format(flight_uid))</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2448"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2448"><span class="linenos">2448</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_FP_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">])</span>  <span class="c1"># msg[&#39;body&#39;][&#39;FP&#39;])</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2449"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2449"><span class="linenos">2449</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">update_eobt_processes</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2450"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2450"><span class="linenos">2450</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2451"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2451"><span class="linenos">2451</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2452"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2452"><span class="linenos">2452</span></a>			<span class="c1"># 	print(&#39;AOC records have been updated for flight {} with FP {}\n&#39;.format(flight_uid, msg[&#39;body&#39;][&#39;FP&#39;]))</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2453"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2453"><span class="linenos">2453</span></a>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2454"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2454"><span class="linenos">2454</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2455"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2455"><span class="linenos">2455</span></a>			<span class="c1"># Flight plan has not been accepted: curfew missed</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2456"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2456"><span class="linenos">2456</span></a>			<span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;reason&#39;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;CURFEW&quot;</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2457"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2457"><span class="linenos">2457</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;FP for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;rejected due to curfew&#39;</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2458"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2458"><span class="linenos">2458</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2459"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2459"><span class="linenos">2459</span></a>				<span class="c1"># Try other options</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2460"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2460"><span class="linenos">2460</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_FP</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2461"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2461"><span class="linenos">2461</span></a>														<span class="n">fp_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_options&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.wait_for_FP_acceptance-2462"><a href="#AirlineFlightPlanner.wait_for_FP_acceptance-2462"><span class="linenos">2462</span></a>														<span class="n">ac_ready_at_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_departing_reassessment_turnaround_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2468"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2468"><span class="linenos">2468</span></a>	<span class="k">def</span> <span class="nf">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2469"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2469"><span class="linenos">2469</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Received departing reassessment request from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]))</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2470"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2470"><span class="linenos">2470</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2471"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2471"><span class="linenos">2471</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2472"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2472"><span class="linenos">2472</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2473"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2473"><span class="linenos">2473</span></a>		<span class="c1"># 	print(&quot;{} received a departing reassessment request from {} for flight {}&quot;.format(self.agent, msg[&#39;from&#39;], flight_uid))</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2474"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2474"><span class="linenos">2474</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2475"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2475"><span class="linenos">2475</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2476"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2476"><span class="linenos">2476</span></a>				<span class="c1"># We have already sent the fp for that flight so reassess</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2477"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2477"><span class="linenos">2477</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;fp_option&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2478"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2478"><span class="linenos">2478</span></a>					<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;should have fligtht plan but option is None, fp status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2479"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2479"><span class="linenos">2479</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reassess_departure_turnaround</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2480"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2480"><span class="linenos">2480</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2481"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2481"><span class="linenos">2481</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2482"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2482"><span class="linenos">2482</span></a>			<span class="n">aprint</span><span class="p">(</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">icao</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2483"><a href="#AirlineFlightPlanner.wait_for_departing_reassessment_turnaround_request-2483"><span class="linenos">2483</span></a>			<span class="k">raise</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_until_delay_estimation" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_until_delay_estimation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_until_delay_estimation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">eobt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_until_delay_estimation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_until_delay_estimation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2485"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2485"><span class="linenos">2485</span></a>	<span class="k">def</span> <span class="nf">wait_until_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2486"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2486"><span class="linenos">2486</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2487"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2487"><span class="linenos">2487</span></a>		<span class="c1"># interrupted = False</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2488"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2488"><span class="linenos">2488</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2489"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2489"><span class="linenos">2489</span></a>			<span class="c1"># aprint(&#39;Non-ATFM delay estimation event created for&#39;, flight_str(flight_uid), &#39;at t=&#39;, self.agent.env.now)</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2490"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2490"><span class="linenos">2490</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2491"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2491"><span class="linenos">2491</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Non-ATFM delay estimation triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2492"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2492"><span class="linenos">2492</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_estimation_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2493"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2493"><span class="linenos">2493</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2494"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2494"><span class="linenos">2494</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2495"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2495"><span class="linenos">2495</span></a>			<span class="c1"># 	print(&#39;ALERT!!!&#39;)</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2496"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2496"><span class="linenos">2496</span></a>			<span class="k">pass</span>
</span><span id="AirlineFlightPlanner.wait_until_delay_estimation-2497"><a href="#AirlineFlightPlanner.wait_until_delay_estimation-2497"><span class="linenos">2497</span></a>			<span class="c1"># aprint(&#39;wait_until_delay_estimation process interrupted for&#39;, flight_str(flight_uid))</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_until_FP_submission" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_until_FP_submission-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_until_FP_submission</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">eobt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_until_FP_submission-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_until_FP_submission"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_until_FP_submission-2499"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2499"><span class="linenos">2499</span></a>	<span class="k">def</span> <span class="nf">wait_until_FP_submission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2500"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2500"><span class="linenos">2500</span></a>		<span class="c1"># the end of the following timeout corresponds to the FP_submission event</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2501"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2501"><span class="linenos">2501</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2502"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2502"><span class="linenos">2502</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">180</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2503"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2503"><span class="linenos">2503</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;starts flight plan submission for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2504"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2504"><span class="linenos">2504</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP_submission_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2505"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2505"><span class="linenos">2505</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_FP_submission-2506"><a href="#AirlineFlightPlanner.wait_until_FP_submission-2506"><span class="linenos">2506</span></a>			<span class="k">pass</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_until_push_back_ready" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_until_push_back_ready-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_until_push_back_ready</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">eobt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_until_push_back_ready-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_until_push_back_ready"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2508"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2508"><span class="linenos">2508</span></a>	<span class="k">def</span> <span class="nf">wait_until_push_back_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2509"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2509"><span class="linenos">2509</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2510"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2510"><span class="linenos">2510</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2511"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2511"><span class="linenos">2511</span></a>			<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2512"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2512"><span class="linenos">2512</span></a>			<span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft_request&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2513"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2513"><span class="linenos">2513</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is ready to go but waits on the&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;to be released at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2514"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2514"><span class="linenos">2514</span></a>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2515"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2515"><span class="linenos">2515</span></a>			<span class="k">assert</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_queue_req</span><span class="p">(</span><span class="n">include_current_user</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2516"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2516"><span class="linenos">2516</span></a>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2517"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2517"><span class="linenos">2517</span></a>			<span class="k">yield</span> <span class="n">request</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2518"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2518"><span class="linenos">2518</span></a>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2519"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2519"><span class="linenos">2519</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft is ready, push-back ready triggered for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2520"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2520"><span class="linenos">2520</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;push_back_ready_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2521"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2521"><span class="linenos">2521</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pushed-back&#39;</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2522"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2522"><span class="linenos">2522</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2523"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2523"><span class="linenos">2523</span></a>			<span class="k">pass</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2524"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2524"><span class="linenos">2524</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_push_back_ready-2525"><a href="#AirlineFlightPlanner.wait_until_push_back_ready-2525"><span class="linenos">2525</span></a>			<span class="k">raise</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_request_flight_plan" class="classattr">
                                        <input id="AirlineFlightPlanner.send_request_flight_plan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_request_flight_plan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_request_flight_plan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_request_flight_plan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_request_flight_plan-2527"><a href="#AirlineFlightPlanner.send_request_flight_plan-2527"><span class="linenos">2527</span></a>	<span class="k">def</span> <span class="nf">send_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2528"><a href="#AirlineFlightPlanner.send_request_flight_plan-2528"><span class="linenos">2528</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2529"><a href="#AirlineFlightPlanner.send_request_flight_plan-2529"><span class="linenos">2529</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2530"><a href="#AirlineFlightPlanner.send_request_flight_plan-2530"><span class="linenos">2530</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;request_flight_plan&#39;</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2531"><a href="#AirlineFlightPlanner.send_request_flight_plan-2531"><span class="linenos">2531</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aoc2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2532"><a href="#AirlineFlightPlanner.send_request_flight_plan-2532"><span class="linenos">2532</span></a>					   <span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2533"><a href="#AirlineFlightPlanner.send_request_flight_plan-2533"><span class="linenos">2533</span></a>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2534"><a href="#AirlineFlightPlanner.send_request_flight_plan-2534"><span class="linenos">2534</span></a>		<span class="c1"># print(self.agent, &#39;is requesting a flight plan for&#39;, flight_str(flight_uid))</span>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2535"><a href="#AirlineFlightPlanner.send_request_flight_plan-2535"><span class="linenos">2535</span></a>
</span><span id="AirlineFlightPlanner.send_request_flight_plan-2536"><a href="#AirlineFlightPlanner.send_request_flight_plan-2536"><span class="linenos">2536</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_request_flight_plan" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_request_flight_plan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_request_flight_plan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_request_flight_plan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_request_flight_plan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2538"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2538"><span class="linenos">2538</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2539"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2539"><span class="linenos">2539</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Agent &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot; received flight plan request from&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">],</span> <span class="s2">&quot;for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2540"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2540"><span class="linenos">2540</span></a>		<span class="c1"># print(&quot;Received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2541"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2541"><span class="linenos">2541</span></a>		<span class="n">fplan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2542"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2542"><span class="linenos">2542</span></a>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2543"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2543"><span class="linenos">2543</span></a>		<span class="c1"># send the flight plan back to the AOC who requested it</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2544"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2544"><span class="linenos">2544</span></a>		<span class="c1"># print(&quot;Agent &quot;, self.agent.uid, &quot; received flight plan request from&quot;, msg[&#39;body&#39;][&#39;aoc2&#39;], &quot;for flight&quot;, msg[&#39;body&#39;][&#39;flight&#39;])</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2545"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2545"><span class="linenos">2545</span></a>		<span class="n">msg2</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2546"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2546"><span class="linenos">2546</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;aoc2&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2547"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2547"><span class="linenos">2547</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;return_requested_flight_plan&#39;</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2548"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2548"><span class="linenos">2548</span></a>		<span class="n">msg2</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2549"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2549"><span class="linenos">2549</span></a>					   <span class="s1">&#39;flight_plan&#39;</span><span class="p">:</span> <span class="n">fplan</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2550"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2550"><span class="linenos">2550</span></a>
</span><span id="AirlineFlightPlanner.wait_for_request_flight_plan-2551"><a href="#AirlineFlightPlanner.wait_for_request_flight_plan-2551"><span class="linenos">2551</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg2</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_return_requested_flight_plan" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_return_requested_flight_plan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_return_requested_flight_plan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_return_requested_flight_plan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_return_requested_flight_plan-2553"><a href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan-2553"><span class="linenos">2553</span></a>	<span class="k">def</span> <span class="nf">wait_for_return_requested_flight_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_return_requested_flight_plan-2554"><a href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan-2554"><span class="linenos">2554</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Received requested flight plan for flight&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.wait_for_return_requested_flight_plan-2555"><a href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan-2555"><span class="linenos">2555</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">other_aoc_flight_plans</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_plan&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_return_requested_flight_plan-2556"><a href="#AirlineFlightPlanner.wait_for_return_requested_flight_plan-2556"><span class="linenos">2556</span></a>		<span class="c1"># the AOC that originally requested this flight plan should now have it</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_fp_option_selection" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_fp_option_selection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_fp_option_selection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_fp_option_selection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_fp_option_selection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2558"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2558"><span class="linenos">2558</span></a>	<span class="k">def</span> <span class="nf">wait_for_fp_option_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2559"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2559"><span class="linenos">2559</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">option_selected_for_fp</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;option_selected_fp&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2560"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2560"><span class="linenos">2560</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2561"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2561"><span class="linenos">2561</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">fp_waiting_option_events</span><span class="p">[</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2562"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2562"><span class="linenos">2562</span></a>		<span class="k">except</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2563"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2563"><span class="linenos">2563</span></a>			<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Issue with flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.wait_for_fp_option_selection-2564"><a href="#AirlineFlightPlanner.wait_for_fp_option_selection-2564"><span class="linenos">2564</span></a>			<span class="k">raise</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_for_request_hotspot_decision" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_for_request_hotspot_decision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_request_hotspot_decision</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_for_request_hotspot_decision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_for_request_hotspot_decision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_for_request_hotspot_decision-2566"><a href="#AirlineFlightPlanner.wait_for_request_hotspot_decision-2566"><span class="linenos">2566</span></a>	<span class="k">def</span> <span class="nf">wait_for_request_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_for_request_hotspot_decision-2567"><a href="#AirlineFlightPlanner.wait_for_request_hotspot_decision-2567"><span class="linenos">2567</span></a>		<span class="c1"># self.agent.env.process(self.make_hotspot_decision(msg[&#39;body&#39;][&#39;regulation_info&#39;], msg[&#39;body&#39;][&#39;event&#39;]))</span>
</span><span id="AirlineFlightPlanner.wait_for_request_hotspot_decision-2568"><a href="#AirlineFlightPlanner.wait_for_request_hotspot_decision-2568"><span class="linenos">2568</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">make_hotspot_decision</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;regulation_info&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;event&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.make_hotspot_decision" class="classattr">
                                        <input id="AirlineFlightPlanner.make_hotspot_decision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">make_hotspot_decision</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">regulation_info</span>, </span><span class="param"><span class="n">event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.make_hotspot_decision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.make_hotspot_decision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.make_hotspot_decision-2570"><a href="#AirlineFlightPlanner.make_hotspot_decision-2570"><span class="linenos">2570</span></a>	<span class="k">def</span> <span class="nf">make_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_info</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2571"><a href="#AirlineFlightPlanner.make_hotspot_decision-2571"><span class="linenos">2571</span></a>		<span class="c1"># if regulation_info[&#39;solver&#39;]==&#39;udpp_merge&#39;:</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2572"><a href="#AirlineFlightPlanner.make_hotspot_decision-2572"><span class="linenos">2572</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_cost_vect[regulation_info[&#39;solver&#39;]]</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2573"><a href="#AirlineFlightPlanner.make_hotspot_decision-2573"><span class="linenos">2573</span></a>		<span class="c1"># else:</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2574"><a href="#AirlineFlightPlanner.make_hotspot_decision-2574"><span class="linenos">2574</span></a>		<span class="c1"># 	algo_local = hspt.models_correspondence_approx[regulation_info[&#39;solver&#39;]]</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2575"><a href="#AirlineFlightPlanner.make_hotspot_decision-2575"><span class="linenos">2575</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2576"><a href="#AirlineFlightPlanner.make_hotspot_decision-2576"><span class="linenos">2576</span></a>		<span class="n">engine_local</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">LocalEngine</span><span class="p">(</span><span class="n">algo</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;solver&#39;</span><span class="p">])</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2577"><a href="#AirlineFlightPlanner.make_hotspot_decision-2577"><span class="linenos">2577</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2578"><a href="#AirlineFlightPlanner.make_hotspot_decision-2578"><span class="linenos">2578</span></a>		<span class="n">hh</span> <span class="o">=</span> <span class="n">hspt</span><span class="o">.</span><span class="n">HotspotHandler</span><span class="p">(</span><span class="n">engine</span><span class="o">=</span><span class="n">engine_local</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2579"><a href="#AirlineFlightPlanner.make_hotspot_decision-2579"><span class="linenos">2579</span></a>								<span class="n">cost_func_archetype</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;archetype_cost_function&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2580"><a href="#AirlineFlightPlanner.make_hotspot_decision-2580"><span class="linenos">2580</span></a>								<span class="n">alternative_allocation_rule</span><span class="o">=</span><span class="kc">True</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2581"><a href="#AirlineFlightPlanner.make_hotspot_decision-2581"><span class="linenos">2581</span></a>								<span class="p">)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2582"><a href="#AirlineFlightPlanner.make_hotspot_decision-2582"><span class="linenos">2582</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2583"><a href="#AirlineFlightPlanner.make_hotspot_decision-2583"><span class="linenos">2583</span></a>		<span class="c1"># Note: here we are not using the most up to date ETA for this FP.</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2584"><a href="#AirlineFlightPlanner.make_hotspot_decision-2584"><span class="linenos">2584</span></a>		<span class="c1"># Instead, we use the one recorded in the regulation when the FP</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2585"><a href="#AirlineFlightPlanner.make_hotspot_decision-2585"><span class="linenos">2585</span></a>		<span class="c1"># was accepted by the NM. The up to date ETA can be different from</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2586"><a href="#AirlineFlightPlanner.make_hotspot_decision-2586"><span class="linenos">2586</span></a>		<span class="c1"># the latter because the flight does not need to resubmit a FP if the</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2587"><a href="#AirlineFlightPlanner.make_hotspot_decision-2587"><span class="linenos">2587</span></a>		<span class="c1"># ETA does not change by more than -5, +10 minutes.</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2588"><a href="#AirlineFlightPlanner.make_hotspot_decision-2588"><span class="linenos">2588</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2589"><a href="#AirlineFlightPlanner.make_hotspot_decision-2589"><span class="linenos">2589</span></a>		<span class="c1"># This gives the cost as a function of the delay with respect to scheduled in block time</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2590"><a href="#AirlineFlightPlanner.make_hotspot_decision-2590"><span class="linenos">2590</span></a>		<span class="n">cfs_old</span> <span class="o">=</span> <span class="p">{</span><span class="n">flight_uid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2591"><a href="#AirlineFlightPlanner.make_hotspot_decision-2591"><span class="linenos">2591</span></a>														<span class="n">factor_in</span><span class="o">=</span><span class="p">[],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2592"><a href="#AirlineFlightPlanner.make_hotspot_decision-2592"><span class="linenos">2592</span></a>														<span class="n">diff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2593"><a href="#AirlineFlightPlanner.make_hotspot_decision-2593"><span class="linenos">2593</span></a>														<span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2594"><a href="#AirlineFlightPlanner.make_hotspot_decision-2594"><span class="linenos">2594</span></a>														<span class="n">up_to_date_baseline_obt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2595"><a href="#AirlineFlightPlanner.make_hotspot_decision-2595"><span class="linenos">2595</span></a>														<span class="n">missed_connections</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2596"><a href="#AirlineFlightPlanner.make_hotspot_decision-2596"><span class="linenos">2596</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2597"><a href="#AirlineFlightPlanner.make_hotspot_decision-2597"><span class="linenos">2597</span></a>		<span class="c1"># We transform the functions to have the cost as a function of delay w.r.t. to eta,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2598"><a href="#AirlineFlightPlanner.make_hotspot_decision-2598"><span class="linenos">2598</span></a>		<span class="c1"># estimated landing.</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2599"><a href="#AirlineFlightPlanner.make_hotspot_decision-2599"><span class="linenos">2599</span></a>		<span class="k">def</span> <span class="nf">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">sibt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2600"><a href="#AirlineFlightPlanner.make_hotspot_decision-2600"><span class="linenos">2600</span></a>			<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2601"><a href="#AirlineFlightPlanner.make_hotspot_decision-2601"><span class="linenos">2601</span></a>				<span class="k">return</span> <span class="n">cf</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">sibt</span><span class="p">)))</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2602"><a href="#AirlineFlightPlanner.make_hotspot_decision-2602"><span class="linenos">2602</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2603"><a href="#AirlineFlightPlanner.make_hotspot_decision-2603"><span class="linenos">2603</span></a>			<span class="k">return</span> <span class="n">f</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2604"><a href="#AirlineFlightPlanner.make_hotspot_decision-2604"><span class="linenos">2604</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2605"><a href="#AirlineFlightPlanner.make_hotspot_decision-2605"><span class="linenos">2605</span></a>		<span class="n">cfs</span> <span class="o">=</span> <span class="p">{</span><span class="n">fid</span><span class="p">:</span> <span class="n">build_f</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2606"><a href="#AirlineFlightPlanner.make_hotspot_decision-2606"><span class="linenos">2606</span></a>							<span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">][</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;eta&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2607"><a href="#AirlineFlightPlanner.make_hotspot_decision-2607"><span class="linenos">2607</span></a>							<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">fid</span><span class="p">][</span><span class="s1">&#39;sibt&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">cf</span> <span class="ow">in</span> <span class="n">cfs_old</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2608"><a href="#AirlineFlightPlanner.make_hotspot_decision-2608"><span class="linenos">2608</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2609"><a href="#AirlineFlightPlanner.make_hotspot_decision-2609"><span class="linenos">2609</span></a>		<span class="n">flights_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;flight_name&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2610"><a href="#AirlineFlightPlanner.make_hotspot_decision-2610"><span class="linenos">2610</span></a>						<span class="s1">&#39;airline_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2611"><a href="#AirlineFlightPlanner.make_hotspot_decision-2611"><span class="linenos">2611</span></a>						<span class="c1"># &#39;eta&#39;: self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].get_estimated_landing_time(),</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2612"><a href="#AirlineFlightPlanner.make_hotspot_decision-2612"><span class="linenos">2612</span></a>						<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_eta_wo_atfm</span><span class="p">(),</span>  <span class="c1"># int(d[&#39;eta&#39;]),</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2613"><a href="#AirlineFlightPlanner.make_hotspot_decision-2613"><span class="linenos">2613</span></a>						<span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="n">cfs</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2614"><a href="#AirlineFlightPlanner.make_hotspot_decision-2614"><span class="linenos">2614</span></a>						<span class="s1">&#39;slot&#39;</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2615"><a href="#AirlineFlightPlanner.make_hotspot_decision-2615"><span class="linenos">2615</span></a>						<span class="p">}</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;flights&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2616"><a href="#AirlineFlightPlanner.make_hotspot_decision-2616"><span class="linenos">2616</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2617"><a href="#AirlineFlightPlanner.make_hotspot_decision-2617"><span class="linenos">2617</span></a>		<span class="c1"># Here we pass directly the real cost function, because we want to ask for an approximation</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2618"><a href="#AirlineFlightPlanner.make_hotspot_decision-2618"><span class="linenos">2618</span></a>		<span class="c1"># computed by the udpp_local engine.</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2619"><a href="#AirlineFlightPlanner.make_hotspot_decision-2619"><span class="linenos">2619</span></a>		<span class="c1"># print(&#39;SLOTS in AOC (&#39;, len(regulation_info[&#39;slots&#39;]), &#39;):&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2620"><a href="#AirlineFlightPlanner.make_hotspot_decision-2620"><span class="linenos">2620</span></a>		<span class="c1"># print(&#39;flights_dict in {}:&#39;.format(msg[&#39;body&#39;][&#39;regulation_info&#39;][&#39;regulation_uid&#39;]))</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2621"><a href="#AirlineFlightPlanner.make_hotspot_decision-2621"><span class="linenos">2621</span></a>		<span class="c1"># for d in flights_dict:</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2622"><a href="#AirlineFlightPlanner.make_hotspot_decision-2622"><span class="linenos">2622</span></a>		<span class="c1"># 	print(d)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2623"><a href="#AirlineFlightPlanner.make_hotspot_decision-2623"><span class="linenos">2623</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2624"><a href="#AirlineFlightPlanner.make_hotspot_decision-2624"><span class="linenos">2624</span></a>		<span class="n">_</span><span class="p">,</span> <span class="n">flights_airline</span> <span class="o">=</span> <span class="n">hh</span><span class="o">.</span><span class="n">prepare_hotspot_from_dict</span><span class="p">(</span><span class="n">attr_list</span><span class="o">=</span><span class="n">flights_dict</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2625"><a href="#AirlineFlightPlanner.make_hotspot_decision-2625"><span class="linenos">2625</span></a>															<span class="n">slots</span><span class="o">=</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;slots&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2626"><a href="#AirlineFlightPlanner.make_hotspot_decision-2626"><span class="linenos">2626</span></a>															<span class="n">set_cost_function_with</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cost_function&#39;</span><span class="p">:</span> <span class="s1">&#39;cost_function&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2627"><a href="#AirlineFlightPlanner.make_hotspot_decision-2627"><span class="linenos">2627</span></a>																					<span class="s1">&#39;kind&#39;</span><span class="p">:</span> <span class="s1">&#39;lambda&#39;</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2628"><a href="#AirlineFlightPlanner.make_hotspot_decision-2628"><span class="linenos">2628</span></a>																					<span class="s1">&#39;absolute&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2629"><a href="#AirlineFlightPlanner.make_hotspot_decision-2629"><span class="linenos">2629</span></a>																					<span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="s1">&#39;eta&#39;</span><span class="p">},</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2630"><a href="#AirlineFlightPlanner.make_hotspot_decision-2630"><span class="linenos">2630</span></a>															<span class="p">)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2631"><a href="#AirlineFlightPlanner.make_hotspot_decision-2631"><span class="linenos">2631</span></a>		<span class="c1"># Prepare flights for engine</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2632"><a href="#AirlineFlightPlanner.make_hotspot_decision-2632"><span class="linenos">2632</span></a>		<span class="n">hh</span><span class="o">.</span><span class="n">prepare_all_flights</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2633"><a href="#AirlineFlightPlanner.make_hotspot_decision-2633"><span class="linenos">2633</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2634"><a href="#AirlineFlightPlanner.make_hotspot_decision-2634"><span class="linenos">2634</span></a>		<span class="c1"># Use following code to save costs for external use</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2635"><a href="#AirlineFlightPlanner.make_hotspot_decision-2635"><span class="linenos">2635</span></a>		<span class="c1"># import pandas as pd</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2636"><a href="#AirlineFlightPlanner.make_hotspot_decision-2636"><span class="linenos">2636</span></a>		<span class="c1"># try:</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2637"><a href="#AirlineFlightPlanner.make_hotspot_decision-2637"><span class="linenos">2637</span></a>		<span class="c1"># 	df = pd.read_csv(&#39;cost_matrix_before.csv&#39;, index_col=0)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2638"><a href="#AirlineFlightPlanner.make_hotspot_decision-2638"><span class="linenos">2638</span></a>		<span class="c1"># except:</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2639"><a href="#AirlineFlightPlanner.make_hotspot_decision-2639"><span class="linenos">2639</span></a>		<span class="c1"># 	df = pd.DataFrame([], columns=regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2640"><a href="#AirlineFlightPlanner.make_hotspot_decision-2640"><span class="linenos">2640</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2641"><a href="#AirlineFlightPlanner.make_hotspot_decision-2641"><span class="linenos">2641</span></a>		<span class="c1"># for flight in hh.get_flight_list():</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2642"><a href="#AirlineFlightPlanner.make_hotspot_decision-2642"><span class="linenos">2642</span></a>		<span class="c1"># 	df.loc[flight.name, :] = flight.costVect</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2643"><a href="#AirlineFlightPlanner.make_hotspot_decision-2643"><span class="linenos">2643</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2644"><a href="#AirlineFlightPlanner.make_hotspot_decision-2644"><span class="linenos">2644</span></a>		<span class="c1"># df.to_csv(&#39;cost_matrix_before.csv&#39;)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2645"><a href="#AirlineFlightPlanner.make_hotspot_decision-2645"><span class="linenos">2645</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2646"><a href="#AirlineFlightPlanner.make_hotspot_decision-2646"><span class="linenos">2646</span></a>		<span class="c1"># print(&#39;SLOTS:&#39;, regulation_info[&#39;slots&#39;])</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2647"><a href="#AirlineFlightPlanner.make_hotspot_decision-2647"><span class="linenos">2647</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2648"><a href="#AirlineFlightPlanner.make_hotspot_decision-2648"><span class="linenos">2648</span></a>		<span class="c1"># print(&#39;Flight characs before computing local optimisation in AOC:&#39;, [(f.name, f.eta, f.costVect[-3:]) for f in hh.get_flight_list()])</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2649"><a href="#AirlineFlightPlanner.make_hotspot_decision-2649"><span class="linenos">2649</span></a>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2650"><a href="#AirlineFlightPlanner.make_hotspot_decision-2650"><span class="linenos">2650</span></a>		<span class="c1"># print(&#39;Hotspot summary in airline {}&#39;.format(self.agent))</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2651"><a href="#AirlineFlightPlanner.make_hotspot_decision-2651"><span class="linenos">2651</span></a>		<span class="c1"># hh.print_summary()</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2652"><a href="#AirlineFlightPlanner.make_hotspot_decision-2652"><span class="linenos">2652</span></a>		<span class="c1"># Compute preferences (parameters approximating the cost function)</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2653"><a href="#AirlineFlightPlanner.make_hotspot_decision-2653"><span class="linenos">2653</span></a>		<span class="n">preferences</span> <span class="o">=</span> <span class="n">engine_local</span><span class="o">.</span><span class="n">compute_optimal_parameters</span><span class="p">(</span><span class="n">hotspot_handler</span><span class="o">=</span><span class="n">hh</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2654"><a href="#AirlineFlightPlanner.make_hotspot_decision-2654"><span class="linenos">2654</span></a>																<span class="n">kwargs_init</span><span class="o">=</span><span class="p">{})</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2655"><a href="#AirlineFlightPlanner.make_hotspot_decision-2655"><span class="linenos">2655</span></a>		<span class="c1"># print(&#39;PREFERENCES FROM HOTSPOT ({}): {}&#39;.format(self.agent.icao, preferences))</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2656"><a href="#AirlineFlightPlanner.make_hotspot_decision-2656"><span class="linenos">2656</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send_hotspot_decision</span><span class="p">(</span><span class="n">regulation_info</span><span class="p">[</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">],</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2657"><a href="#AirlineFlightPlanner.make_hotspot_decision-2657"><span class="linenos">2657</span></a>									<span class="n">event</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2658"><a href="#AirlineFlightPlanner.make_hotspot_decision-2658"><span class="linenos">2658</span></a>									<span class="n">preferences</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.make_hotspot_decision-2659"><a href="#AirlineFlightPlanner.make_hotspot_decision-2659"><span class="linenos">2659</span></a>									<span class="n">real_cost_funcs</span><span class="o">=</span><span class="n">cfs</span><span class="p">)</span>  <span class="c1"># Just for metrics, TODO we need to build metrics computers</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.send_hotspot_decision" class="classattr">
                                        <input id="AirlineFlightPlanner.send_hotspot_decision-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_hotspot_decision</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">regulation_id</span>, </span><span class="param"><span class="n">event</span>, </span><span class="param"><span class="n">decision</span>, </span><span class="param"><span class="n">real_cost_funcs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.send_hotspot_decision-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.send_hotspot_decision"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.send_hotspot_decision-2661"><a href="#AirlineFlightPlanner.send_hotspot_decision-2661"><span class="linenos">2661</span></a>	<span class="k">def</span> <span class="nf">send_hotspot_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regulation_id</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">decision</span><span class="p">,</span> <span class="n">real_cost_funcs</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2662"><a href="#AirlineFlightPlanner.send_hotspot_decision-2662"><span class="linenos">2662</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2663"><a href="#AirlineFlightPlanner.send_hotspot_decision-2663"><span class="linenos">2663</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">nm_uid</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2664"><a href="#AirlineFlightPlanner.send_hotspot_decision-2664"><span class="linenos">2664</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;hotspot_decision&#39;</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2665"><a href="#AirlineFlightPlanner.send_hotspot_decision-2665"><span class="linenos">2665</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;regulation_uid&#39;</span><span class="p">:</span> <span class="n">regulation_id</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2666"><a href="#AirlineFlightPlanner.send_hotspot_decision-2666"><span class="linenos">2666</span></a>					   <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2667"><a href="#AirlineFlightPlanner.send_hotspot_decision-2667"><span class="linenos">2667</span></a>					   <span class="s1">&#39;hotspot_decision&#39;</span><span class="p">:</span> <span class="n">decision</span><span class="p">,</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2668"><a href="#AirlineFlightPlanner.send_hotspot_decision-2668"><span class="linenos">2668</span></a>					   <span class="s1">&#39;real_cost_funcs&#39;</span><span class="p">:</span> <span class="n">real_cost_funcs</span><span class="p">}</span>
</span><span id="AirlineFlightPlanner.send_hotspot_decision-2669"><a href="#AirlineFlightPlanner.send_hotspot_decision-2669"><span class="linenos">2669</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlineFlightPlanner.wait_until_pax_check" class="classattr">
                                        <input id="AirlineFlightPlanner.wait_until_pax_check-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_until_pax_check</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">eobt</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlineFlightPlanner.wait_until_pax_check-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlineFlightPlanner.wait_until_pax_check"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlineFlightPlanner.wait_until_pax_check-2671"><a href="#AirlineFlightPlanner.wait_until_pax_check-2671"><span class="linenos">2671</span></a>	<span class="k">def</span> <span class="nf">wait_until_pax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">eobt</span><span class="p">):</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2672"><a href="#AirlineFlightPlanner.wait_until_pax_check-2672"><span class="linenos">2672</span></a>		<span class="c1"># checking for missing passengers 5 minutes before push_back_ready</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2673"><a href="#AirlineFlightPlanner.wait_until_pax_check-2673"><span class="linenos">2673</span></a>		<span class="k">try</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2674"><a href="#AirlineFlightPlanner.wait_until_pax_check-2674"><span class="linenos">2674</span></a>			<span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">eobt</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">5</span><span class="p">))</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2675"><a href="#AirlineFlightPlanner.wait_until_pax_check-2675"><span class="linenos">2675</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;performs pre-check for missing passengers on&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2676"><a href="#AirlineFlightPlanner.wait_until_pax_check-2676"><span class="linenos">2676</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_check_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">succeed</span><span class="p">()</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2677"><a href="#AirlineFlightPlanner.wait_until_pax_check-2677"><span class="linenos">2677</span></a>		<span class="k">except</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">:</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2678"><a href="#AirlineFlightPlanner.wait_until_pax_check-2678"><span class="linenos">2678</span></a>			<span class="c1"># aprint(&#39;wait_until_pax_check interrupted&#39;)</span>
</span><span id="AirlineFlightPlanner.wait_until_pax_check-2679"><a href="#AirlineFlightPlanner.wait_until_pax_check-2679"><span class="linenos">2679</span></a>			<span class="k">pass</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="AirlineFlightPlanner.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="AirlineFlightPlanner.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DynamicCostIndexComputer">
                            <input id="DynamicCostIndexComputer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DynamicCostIndexComputer</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="DynamicCostIndexComputer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer-2682"><a href="#DynamicCostIndexComputer-2682"><span class="linenos">2682</span></a><span class="k">class</span> <span class="nc">DynamicCostIndexComputer</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2683"><a href="#DynamicCostIndexComputer-2683"><span class="linenos">2683</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2684"><a href="#DynamicCostIndexComputer-2684"><span class="linenos">2684</span></a><span class="sd">	DCIC</span>
</span><span id="DynamicCostIndexComputer-2685"><a href="#DynamicCostIndexComputer-2685"><span class="linenos">2685</span></a>
</span><span id="DynamicCostIndexComputer-2686"><a href="#DynamicCostIndexComputer-2686"><span class="linenos">2686</span></a><span class="sd">	Description: Compute the new cost index of a given flight. It communicates</span>
</span><span id="DynamicCostIndexComputer-2687"><a href="#DynamicCostIndexComputer-2687"><span class="linenos">2687</span></a><span class="sd">	with the role PotentialDelayRecoveryProvider (in Flight, PDRP), to get options for speeding up.</span>
</span><span id="DynamicCostIndexComputer-2688"><a href="#DynamicCostIndexComputer-2688"><span class="linenos">2688</span></a>
</span><span id="DynamicCostIndexComputer-2689"><a href="#DynamicCostIndexComputer-2689"><span class="linenos">2689</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2690"><a href="#DynamicCostIndexComputer-2690"><span class="linenos">2690</span></a>
</span><span id="DynamicCostIndexComputer-2691"><a href="#DynamicCostIndexComputer-2691"><span class="linenos">2691</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">TA</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2692"><a href="#DynamicCostIndexComputer-2692"><span class="linenos">2692</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2693"><a href="#DynamicCostIndexComputer-2693"><span class="linenos">2693</span></a>
</span><span id="DynamicCostIndexComputer-2694"><a href="#DynamicCostIndexComputer-2694"><span class="linenos">2694</span></a>		<span class="k">if</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2695"><a href="#DynamicCostIndexComputer-2695"><span class="linenos">2695</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span>
</span><span id="DynamicCostIndexComputer-2696"><a href="#DynamicCostIndexComputer-2696"><span class="linenos">2696</span></a>		<span class="k">elif</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2697"><a href="#DynamicCostIndexComputer-2697"><span class="linenos">2697</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA2</span>
</span><span id="DynamicCostIndexComputer-2698"><a href="#DynamicCostIndexComputer-2698"><span class="linenos">2698</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2699"><a href="#DynamicCostIndexComputer-2699"><span class="linenos">2699</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA0</span>
</span><span id="DynamicCostIndexComputer-2700"><a href="#DynamicCostIndexComputer-2700"><span class="linenos">2700</span></a>
</span><span id="DynamicCostIndexComputer-2701"><a href="#DynamicCostIndexComputer-2701"><span class="linenos">2701</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="DynamicCostIndexComputer-2702"><a href="#DynamicCostIndexComputer-2702"><span class="linenos">2702</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">toc_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>  <span class="c1"># not used for now (just msgs)</span>
</span><span id="DynamicCostIndexComputer-2703"><a href="#DynamicCostIndexComputer-2703"><span class="linenos">2703</span></a>
</span><span id="DynamicCostIndexComputer-2704"><a href="#DynamicCostIndexComputer-2704"><span class="linenos">2704</span></a>	<span class="k">def</span> <span class="nf">request_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2705"><a href="#DynamicCostIndexComputer-2705"><span class="linenos">2705</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2706"><a href="#DynamicCostIndexComputer-2706"><span class="linenos">2706</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="DynamicCostIndexComputer-2707"><a href="#DynamicCostIndexComputer-2707"><span class="linenos">2707</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;potential_delay_recovery_request&#39;</span>
</span><span id="DynamicCostIndexComputer-2708"><a href="#DynamicCostIndexComputer-2708"><span class="linenos">2708</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;use_dci_landing&#39;</span><span class="p">:</span> <span class="n">use_dci_landing</span><span class="p">}</span>
</span><span id="DynamicCostIndexComputer-2709"><a href="#DynamicCostIndexComputer-2709"><span class="linenos">2709</span></a>
</span><span id="DynamicCostIndexComputer-2710"><a href="#DynamicCostIndexComputer-2710"><span class="linenos">2710</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2711"><a href="#DynamicCostIndexComputer-2711"><span class="linenos">2711</span></a>
</span><span id="DynamicCostIndexComputer-2712"><a href="#DynamicCostIndexComputer-2712"><span class="linenos">2712</span></a>	<span class="k">def</span> <span class="nf">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2713"><a href="#DynamicCostIndexComputer-2713"><span class="linenos">2713</span></a>		<span class="c1"># dictionary with potential delay recovery info received from a flight</span>
</span><span id="DynamicCostIndexComputer-2714"><a href="#DynamicCostIndexComputer-2714"><span class="linenos">2714</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-2715"><a href="#DynamicCostIndexComputer-2715"><span class="linenos">2715</span></a>		<span class="n">delay_recovery_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;potential_delay_recovery&#39;</span><span class="p">]</span>  <span class="c1"># dictionary</span>
</span><span id="DynamicCostIndexComputer-2716"><a href="#DynamicCostIndexComputer-2716"><span class="linenos">2716</span></a>
</span><span id="DynamicCostIndexComputer-2717"><a href="#DynamicCostIndexComputer-2717"><span class="linenos">2717</span></a>		<span class="c1"># save dictionary into aoc_delay_recovery_info --&gt; it can be accessed just with flight_uid then</span>
</span><span id="DynamicCostIndexComputer-2718"><a href="#DynamicCostIndexComputer-2718"><span class="linenos">2718</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay_recovery_info</span>
</span><span id="DynamicCostIndexComputer-2719"><a href="#DynamicCostIndexComputer-2719"><span class="linenos">2719</span></a>
</span><span id="DynamicCostIndexComputer-2720"><a href="#DynamicCostIndexComputer-2720"><span class="linenos">2720</span></a>		<span class="c1"># TESTING</span>
</span><span id="DynamicCostIndexComputer-2721"><a href="#DynamicCostIndexComputer-2721"><span class="linenos">2721</span></a>		<span class="c1"># print(&quot;Delay information dictionary for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-2722"><a href="#DynamicCostIndexComputer-2722"><span class="linenos">2722</span></a>		<span class="c1"># print(self.agent.aoc_delay_recovery_info[flight_uid])</span>
</span><span id="DynamicCostIndexComputer-2723"><a href="#DynamicCostIndexComputer-2723"><span class="linenos">2723</span></a>
</span><span id="DynamicCostIndexComputer-2724"><a href="#DynamicCostIndexComputer-2724"><span class="linenos">2724</span></a>	<span class="k">def</span> <span class="nf">wait_for_toc_reached_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2725"><a href="#DynamicCostIndexComputer-2725"><span class="linenos">2725</span></a>		<span class="k">pass</span>
</span><span id="DynamicCostIndexComputer-2726"><a href="#DynamicCostIndexComputer-2726"><span class="linenos">2726</span></a>
</span><span id="DynamicCostIndexComputer-2727"><a href="#DynamicCostIndexComputer-2727"><span class="linenos">2727</span></a>	<span class="k">def</span> <span class="nf">cost_index_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_ready_event</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2728"><a href="#DynamicCostIndexComputer-2728"><span class="linenos">2728</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2729"><a href="#DynamicCostIndexComputer-2729"><span class="linenos">2729</span></a><span class="sd">		Decides how the CI assessment is done depending on the level.</span>
</span><span id="DynamicCostIndexComputer-2730"><a href="#DynamicCostIndexComputer-2730"><span class="linenos">2730</span></a><span class="sd">		Level 0: only at pushback ready</span>
</span><span id="DynamicCostIndexComputer-2731"><a href="#DynamicCostIndexComputer-2731"><span class="linenos">2731</span></a><span class="sd">		Level 1: at top of climb (and therefore not needed at pushback ready? Or is it?</span>
</span><span id="DynamicCostIndexComputer-2732"><a href="#DynamicCostIndexComputer-2732"><span class="linenos">2732</span></a><span class="sd">		CHANGE IF TURNS OUT THAT ALSO NEEDED AT PUSHBACK READY.</span>
</span><span id="DynamicCostIndexComputer-2733"><a href="#DynamicCostIndexComputer-2733"><span class="linenos">2733</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2734"><a href="#DynamicCostIndexComputer-2734"><span class="linenos">2734</span></a>
</span><span id="DynamicCostIndexComputer-2735"><a href="#DynamicCostIndexComputer-2735"><span class="linenos">2735</span></a>		<span class="c1"># if self.agent.TA == 0:</span>
</span><span id="DynamicCostIndexComputer-2736"><a href="#DynamicCostIndexComputer-2736"><span class="linenos">2736</span></a>		<span class="k">yield</span> <span class="n">push_back_ready_event</span>
</span><span id="DynamicCostIndexComputer-2737"><a href="#DynamicCostIndexComputer-2737"><span class="linenos">2737</span></a>		<span class="c1"># print(&quot;Checking cost index at pushback ready.&quot;)</span>
</span><span id="DynamicCostIndexComputer-2738"><a href="#DynamicCostIndexComputer-2738"><span class="linenos">2738</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2739"><a href="#DynamicCostIndexComputer-2739"><span class="linenos">2739</span></a>		<span class="c1"># else:</span>
</span><span id="DynamicCostIndexComputer-2740"><a href="#DynamicCostIndexComputer-2740"><span class="linenos">2740</span></a>		<span class="c1"># 	#do nothing - wait for top of climb.</span>
</span><span id="DynamicCostIndexComputer-2741"><a href="#DynamicCostIndexComputer-2741"><span class="linenos">2741</span></a>		<span class="c1"># 	#yield self.toc_event</span>
</span><span id="DynamicCostIndexComputer-2742"><a href="#DynamicCostIndexComputer-2742"><span class="linenos">2742</span></a>		<span class="c1"># 	pass</span>
</span><span id="DynamicCostIndexComputer-2743"><a href="#DynamicCostIndexComputer-2743"><span class="linenos">2743</span></a>
</span><span id="DynamicCostIndexComputer-2744"><a href="#DynamicCostIndexComputer-2744"><span class="linenos">2744</span></a>	<span class="k">def</span> <span class="nf">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2745"><a href="#DynamicCostIndexComputer-2745"><span class="linenos">2745</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2746"><a href="#DynamicCostIndexComputer-2746"><span class="linenos">2746</span></a><span class="sd">		Probabilistically decide whether the flight is performing delay recovery</span>
</span><span id="DynamicCostIndexComputer-2747"><a href="#DynamicCostIndexComputer-2747"><span class="linenos">2747</span></a><span class="sd">		for the amount of delay &quot;delay&quot;.</span>
</span><span id="DynamicCostIndexComputer-2748"><a href="#DynamicCostIndexComputer-2748"><span class="linenos">2748</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2749"><a href="#DynamicCostIndexComputer-2749"><span class="linenos">2749</span></a>
</span><span id="DynamicCostIndexComputer-2750"><a href="#DynamicCostIndexComputer-2750"><span class="linenos">2750</span></a>		<span class="n">min_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_min_delay</span>  <span class="c1"># gray area: below this value never recover</span>
</span><span id="DynamicCostIndexComputer-2751"><a href="#DynamicCostIndexComputer-2751"><span class="linenos">2751</span></a>		<span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_max_delay</span>  <span class="c1"># above this value always recover</span>
</span><span id="DynamicCostIndexComputer-2752"><a href="#DynamicCostIndexComputer-2752"><span class="linenos">2752</span></a>		<span class="n">p_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_p_bias</span>  <span class="c1"># minimum probability of delay recovery (from min_delay)</span>
</span><span id="DynamicCostIndexComputer-2753"><a href="#DynamicCostIndexComputer-2753"><span class="linenos">2753</span></a>
</span><span id="DynamicCostIndexComputer-2754"><a href="#DynamicCostIndexComputer-2754"><span class="linenos">2754</span></a>		<span class="c1"># probability of performing delay recovery: p</span>
</span><span id="DynamicCostIndexComputer-2755"><a href="#DynamicCostIndexComputer-2755"><span class="linenos">2755</span></a>		<span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="n">min_delay</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2756"><a href="#DynamicCostIndexComputer-2756"><span class="linenos">2756</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># never recover</span>
</span><span id="DynamicCostIndexComputer-2757"><a href="#DynamicCostIndexComputer-2757"><span class="linenos">2757</span></a>		<span class="k">elif</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">max_delay</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2758"><a href="#DynamicCostIndexComputer-2758"><span class="linenos">2758</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DynamicCostIndexComputer-2759"><a href="#DynamicCostIndexComputer-2759"><span class="linenos">2759</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2760"><a href="#DynamicCostIndexComputer-2760"><span class="linenos">2760</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">max_delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_bias</span>
</span><span id="DynamicCostIndexComputer-2761"><a href="#DynamicCostIndexComputer-2761"><span class="linenos">2761</span></a>
</span><span id="DynamicCostIndexComputer-2762"><a href="#DynamicCostIndexComputer-2762"><span class="linenos">2762</span></a>		<span class="c1"># decision on performing delay recovery</span>
</span><span id="DynamicCostIndexComputer-2763"><a href="#DynamicCostIndexComputer-2763"><span class="linenos">2763</span></a>		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-2764"><a href="#DynamicCostIndexComputer-2764"><span class="linenos">2764</span></a>		<span class="n">do_it</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">p</span>
</span><span id="DynamicCostIndexComputer-2765"><a href="#DynamicCostIndexComputer-2765"><span class="linenos">2765</span></a>
</span><span id="DynamicCostIndexComputer-2766"><a href="#DynamicCostIndexComputer-2766"><span class="linenos">2766</span></a>		<span class="c1"># print(&quot;For the delay &quot;, delay, &quot; this flight is performing delay recovery: &quot;, do_it, &quot; with the probability &quot;, p)</span>
</span><span id="DynamicCostIndexComputer-2767"><a href="#DynamicCostIndexComputer-2767"><span class="linenos">2767</span></a>
</span><span id="DynamicCostIndexComputer-2768"><a href="#DynamicCostIndexComputer-2768"><span class="linenos">2768</span></a>		<span class="k">return</span> <span class="n">do_it</span>
</span><span id="DynamicCostIndexComputer-2769"><a href="#DynamicCostIndexComputer-2769"><span class="linenos">2769</span></a>
</span><span id="DynamicCostIndexComputer-2770"><a href="#DynamicCostIndexComputer-2770"><span class="linenos">2770</span></a>	<span class="nd">@staticmethod</span>
</span><span id="DynamicCostIndexComputer-2771"><a href="#DynamicCostIndexComputer-2771"><span class="linenos">2771</span></a>	<span class="k">def</span> <span class="nf">plot_costs_dci</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2772"><a href="#DynamicCostIndexComputer-2772"><span class="linenos">2772</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2773"><a href="#DynamicCostIndexComputer-2773"><span class="linenos">2773</span></a><span class="sd">		If one wants to plot cost functions used to make dci decisions.</span>
</span><span id="DynamicCostIndexComputer-2774"><a href="#DynamicCostIndexComputer-2774"><span class="linenos">2774</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2775"><a href="#DynamicCostIndexComputer-2775"><span class="linenos">2775</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2776"><a href="#DynamicCostIndexComputer-2776"><span class="linenos">2776</span></a>		<span class="c1"># FUEL COST</span>
</span><span id="DynamicCostIndexComputer-2777"><a href="#DynamicCostIndexComputer-2777"><span class="linenos">2777</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2778"><a href="#DynamicCostIndexComputer-2778"><span class="linenos">2778</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">fuel</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2779"><a href="#DynamicCostIndexComputer-2779"><span class="linenos">2779</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Fuel cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2780"><a href="#DynamicCostIndexComputer-2780"><span class="linenos">2780</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2781"><a href="#DynamicCostIndexComputer-2781"><span class="linenos">2781</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2782"><a href="#DynamicCostIndexComputer-2782"><span class="linenos">2782</span></a>
</span><span id="DynamicCostIndexComputer-2783"><a href="#DynamicCostIndexComputer-2783"><span class="linenos">2783</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2784"><a href="#DynamicCostIndexComputer-2784"><span class="linenos">2784</span></a>		<span class="c1"># TIME COST</span>
</span><span id="DynamicCostIndexComputer-2785"><a href="#DynamicCostIndexComputer-2785"><span class="linenos">2785</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2786"><a href="#DynamicCostIndexComputer-2786"><span class="linenos">2786</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2787"><a href="#DynamicCostIndexComputer-2787"><span class="linenos">2787</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2788"><a href="#DynamicCostIndexComputer-2788"><span class="linenos">2788</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2789"><a href="#DynamicCostIndexComputer-2789"><span class="linenos">2789</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2790"><a href="#DynamicCostIndexComputer-2790"><span class="linenos">2790</span></a>
</span><span id="DynamicCostIndexComputer-2791"><a href="#DynamicCostIndexComputer-2791"><span class="linenos">2791</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2792"><a href="#DynamicCostIndexComputer-2792"><span class="linenos">2792</span></a>		<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="DynamicCostIndexComputer-2793"><a href="#DynamicCostIndexComputer-2793"><span class="linenos">2793</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-2794"><a href="#DynamicCostIndexComputer-2794"><span class="linenos">2794</span></a>		<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">fuel</span>
</span><span id="DynamicCostIndexComputer-2795"><a href="#DynamicCostIndexComputer-2795"><span class="linenos">2795</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">total_cost</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2796"><a href="#DynamicCostIndexComputer-2796"><span class="linenos">2796</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost function (delta_t): time + fuel&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2797"><a href="#DynamicCostIndexComputer-2797"><span class="linenos">2797</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2798"><a href="#DynamicCostIndexComputer-2798"><span class="linenos">2798</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2799"><a href="#DynamicCostIndexComputer-2799"><span class="linenos">2799</span></a>
</span><span id="DynamicCostIndexComputer-2800"><a href="#DynamicCostIndexComputer-2800"><span class="linenos">2800</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2801"><a href="#DynamicCostIndexComputer-2801"><span class="linenos">2801</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2802"><a href="#DynamicCostIndexComputer-2802"><span class="linenos">2802</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="DynamicCostIndexComputer-2803"><a href="#DynamicCostIndexComputer-2803"><span class="linenos">2803</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="DynamicCostIndexComputer-2804"><a href="#DynamicCostIndexComputer-2804"><span class="linenos">2804</span></a>
</span><span id="DynamicCostIndexComputer-2805"><a href="#DynamicCostIndexComputer-2805"><span class="linenos">2805</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="DynamicCostIndexComputer-2806"><a href="#DynamicCostIndexComputer-2806"><span class="linenos">2806</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2807"><a href="#DynamicCostIndexComputer-2807"><span class="linenos">2807</span></a>
</span><span id="DynamicCostIndexComputer-2808"><a href="#DynamicCostIndexComputer-2808"><span class="linenos">2808</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2809"><a href="#DynamicCostIndexComputer-2809"><span class="linenos">2809</span></a>
</span><span id="DynamicCostIndexComputer-2810"><a href="#DynamicCostIndexComputer-2810"><span class="linenos">2810</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2811"><a href="#DynamicCostIndexComputer-2811"><span class="linenos">2811</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2812"><a href="#DynamicCostIndexComputer-2812"><span class="linenos">2812</span></a>
</span><span id="DynamicCostIndexComputer-2813"><a href="#DynamicCostIndexComputer-2813"><span class="linenos">2813</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2814"><a href="#DynamicCostIndexComputer-2814"><span class="linenos">2814</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-2815"><a href="#DynamicCostIndexComputer-2815"><span class="linenos">2815</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2816"><a href="#DynamicCostIndexComputer-2816"><span class="linenos">2816</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer-2817"><a href="#DynamicCostIndexComputer-2817"><span class="linenos">2817</span></a><span class="sd">				if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="DynamicCostIndexComputer-2818"><a href="#DynamicCostIndexComputer-2818"><span class="linenos">2818</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="DynamicCostIndexComputer-2819"><a href="#DynamicCostIndexComputer-2819"><span class="linenos">2819</span></a>
</span><span id="DynamicCostIndexComputer-2820"><a href="#DynamicCostIndexComputer-2820"><span class="linenos">2820</span></a><span class="sd">				if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="DynamicCostIndexComputer-2821"><a href="#DynamicCostIndexComputer-2821"><span class="linenos">2821</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="DynamicCostIndexComputer-2822"><a href="#DynamicCostIndexComputer-2822"><span class="linenos">2822</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2823"><a href="#DynamicCostIndexComputer-2823"><span class="linenos">2823</span></a>
</span><span id="DynamicCostIndexComputer-2824"><a href="#DynamicCostIndexComputer-2824"><span class="linenos">2824</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-2825"><a href="#DynamicCostIndexComputer-2825"><span class="linenos">2825</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer-2826"><a href="#DynamicCostIndexComputer-2826"><span class="linenos">2826</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="DynamicCostIndexComputer-2827"><a href="#DynamicCostIndexComputer-2827"><span class="linenos">2827</span></a>
</span><span id="DynamicCostIndexComputer-2828"><a href="#DynamicCostIndexComputer-2828"><span class="linenos">2828</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="DynamicCostIndexComputer-2829"><a href="#DynamicCostIndexComputer-2829"><span class="linenos">2829</span></a>
</span><span id="DynamicCostIndexComputer-2830"><a href="#DynamicCostIndexComputer-2830"><span class="linenos">2830</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer-2831"><a href="#DynamicCostIndexComputer-2831"><span class="linenos">2831</span></a>
</span><span id="DynamicCostIndexComputer-2832"><a href="#DynamicCostIndexComputer-2832"><span class="linenos">2832</span></a>			<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer-2833"><a href="#DynamicCostIndexComputer-2833"><span class="linenos">2833</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2834"><a href="#DynamicCostIndexComputer-2834"><span class="linenos">2834</span></a>
</span><span id="DynamicCostIndexComputer-2835"><a href="#DynamicCostIndexComputer-2835"><span class="linenos">2835</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2836"><a href="#DynamicCostIndexComputer-2836"><span class="linenos">2836</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="DynamicCostIndexComputer-2837"><a href="#DynamicCostIndexComputer-2837"><span class="linenos">2837</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="DynamicCostIndexComputer-2838"><a href="#DynamicCostIndexComputer-2838"><span class="linenos">2838</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="DynamicCostIndexComputer-2839"><a href="#DynamicCostIndexComputer-2839"><span class="linenos">2839</span></a>
</span><span id="DynamicCostIndexComputer-2840"><a href="#DynamicCostIndexComputer-2840"><span class="linenos">2840</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="DynamicCostIndexComputer-2841"><a href="#DynamicCostIndexComputer-2841"><span class="linenos">2841</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="DynamicCostIndexComputer-2842"><a href="#DynamicCostIndexComputer-2842"><span class="linenos">2842</span></a>
</span><span id="DynamicCostIndexComputer-2843"><a href="#DynamicCostIndexComputer-2843"><span class="linenos">2843</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="DynamicCostIndexComputer-2844"><a href="#DynamicCostIndexComputer-2844"><span class="linenos">2844</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="DynamicCostIndexComputer-2845"><a href="#DynamicCostIndexComputer-2845"><span class="linenos">2845</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="DynamicCostIndexComputer-2846"><a href="#DynamicCostIndexComputer-2846"><span class="linenos">2846</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="DynamicCostIndexComputer-2847"><a href="#DynamicCostIndexComputer-2847"><span class="linenos">2847</span></a>
</span><span id="DynamicCostIndexComputer-2848"><a href="#DynamicCostIndexComputer-2848"><span class="linenos">2848</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="DynamicCostIndexComputer-2849"><a href="#DynamicCostIndexComputer-2849"><span class="linenos">2849</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="DynamicCostIndexComputer-2850"><a href="#DynamicCostIndexComputer-2850"><span class="linenos">2850</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="DynamicCostIndexComputer-2851"><a href="#DynamicCostIndexComputer-2851"><span class="linenos">2851</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="DynamicCostIndexComputer-2852"><a href="#DynamicCostIndexComputer-2852"><span class="linenos">2852</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer-2853"><a href="#DynamicCostIndexComputer-2853"><span class="linenos">2853</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="DynamicCostIndexComputer-2854"><a href="#DynamicCostIndexComputer-2854"><span class="linenos">2854</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="DynamicCostIndexComputer-2855"><a href="#DynamicCostIndexComputer-2855"><span class="linenos">2855</span></a>
</span><span id="DynamicCostIndexComputer-2856"><a href="#DynamicCostIndexComputer-2856"><span class="linenos">2856</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer-2857"><a href="#DynamicCostIndexComputer-2857"><span class="linenos">2857</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2858"><a href="#DynamicCostIndexComputer-2858"><span class="linenos">2858</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2859"><a href="#DynamicCostIndexComputer-2859"><span class="linenos">2859</span></a>
</span><span id="DynamicCostIndexComputer-2860"><a href="#DynamicCostIndexComputer-2860"><span class="linenos">2860</span></a>			<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer-2861"><a href="#DynamicCostIndexComputer-2861"><span class="linenos">2861</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2862"><a href="#DynamicCostIndexComputer-2862"><span class="linenos">2862</span></a>
</span><span id="DynamicCostIndexComputer-2863"><a href="#DynamicCostIndexComputer-2863"><span class="linenos">2863</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer-2864"><a href="#DynamicCostIndexComputer-2864"><span class="linenos">2864</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2865"><a href="#DynamicCostIndexComputer-2865"><span class="linenos">2865</span></a>
</span><span id="DynamicCostIndexComputer-2866"><a href="#DynamicCostIndexComputer-2866"><span class="linenos">2866</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer-2867"><a href="#DynamicCostIndexComputer-2867"><span class="linenos">2867</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2868"><a href="#DynamicCostIndexComputer-2868"><span class="linenos">2868</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2869"><a href="#DynamicCostIndexComputer-2869"><span class="linenos">2869</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2870"><a href="#DynamicCostIndexComputer-2870"><span class="linenos">2870</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2871"><a href="#DynamicCostIndexComputer-2871"><span class="linenos">2871</span></a>
</span><span id="DynamicCostIndexComputer-2872"><a href="#DynamicCostIndexComputer-2872"><span class="linenos">2872</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="DynamicCostIndexComputer-2873"><a href="#DynamicCostIndexComputer-2873"><span class="linenos">2873</span></a>
</span><span id="DynamicCostIndexComputer-2874"><a href="#DynamicCostIndexComputer-2874"><span class="linenos">2874</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2875"><a href="#DynamicCostIndexComputer-2875"><span class="linenos">2875</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-2876"><a href="#DynamicCostIndexComputer-2876"><span class="linenos">2876</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer-2877"><a href="#DynamicCostIndexComputer-2877"><span class="linenos">2877</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2878"><a href="#DynamicCostIndexComputer-2878"><span class="linenos">2878</span></a>
</span><span id="DynamicCostIndexComputer-2879"><a href="#DynamicCostIndexComputer-2879"><span class="linenos">2879</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer-2880"><a href="#DynamicCostIndexComputer-2880"><span class="linenos">2880</span></a>
</span><span id="DynamicCostIndexComputer-2881"><a href="#DynamicCostIndexComputer-2881"><span class="linenos">2881</span></a>				<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer-2882"><a href="#DynamicCostIndexComputer-2882"><span class="linenos">2882</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2883"><a href="#DynamicCostIndexComputer-2883"><span class="linenos">2883</span></a>
</span><span id="DynamicCostIndexComputer-2884"><a href="#DynamicCostIndexComputer-2884"><span class="linenos">2884</span></a>				<span class="c1"># DOC</span>
</span><span id="DynamicCostIndexComputer-2885"><a href="#DynamicCostIndexComputer-2885"><span class="linenos">2885</span></a>				<span class="c1"># cost_doc0 = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer-2886"><a href="#DynamicCostIndexComputer-2886"><span class="linenos">2886</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2887"><a href="#DynamicCostIndexComputer-2887"><span class="linenos">2887</span></a>
</span><span id="DynamicCostIndexComputer-2888"><a href="#DynamicCostIndexComputer-2888"><span class="linenos">2888</span></a>				<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer-2889"><a href="#DynamicCostIndexComputer-2889"><span class="linenos">2889</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2890"><a href="#DynamicCostIndexComputer-2890"><span class="linenos">2890</span></a>
</span><span id="DynamicCostIndexComputer-2891"><a href="#DynamicCostIndexComputer-2891"><span class="linenos">2891</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer-2892"><a href="#DynamicCostIndexComputer-2892"><span class="linenos">2892</span></a>				<span class="n">cost_transfer0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2893"><a href="#DynamicCostIndexComputer-2893"><span class="linenos">2893</span></a>
</span><span id="DynamicCostIndexComputer-2894"><a href="#DynamicCostIndexComputer-2894"><span class="linenos">2894</span></a>				<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer-2895"><a href="#DynamicCostIndexComputer-2895"><span class="linenos">2895</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2896"><a href="#DynamicCostIndexComputer-2896"><span class="linenos">2896</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2897"><a href="#DynamicCostIndexComputer-2897"><span class="linenos">2897</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2898"><a href="#DynamicCostIndexComputer-2898"><span class="linenos">2898</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2899"><a href="#DynamicCostIndexComputer-2899"><span class="linenos">2899</span></a>
</span><span id="DynamicCostIndexComputer-2900"><a href="#DynamicCostIndexComputer-2900"><span class="linenos">2900</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_transfer0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="DynamicCostIndexComputer-2901"><a href="#DynamicCostIndexComputer-2901"><span class="linenos">2901</span></a>
</span><span id="DynamicCostIndexComputer-2902"><a href="#DynamicCostIndexComputer-2902"><span class="linenos">2902</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="DynamicCostIndexComputer-2903"><a href="#DynamicCostIndexComputer-2903"><span class="linenos">2903</span></a>
</span><span id="DynamicCostIndexComputer-2904"><a href="#DynamicCostIndexComputer-2904"><span class="linenos">2904</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2905"><a href="#DynamicCostIndexComputer-2905"><span class="linenos">2905</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="DynamicCostIndexComputer-2906"><a href="#DynamicCostIndexComputer-2906"><span class="linenos">2906</span></a>
</span><span id="DynamicCostIndexComputer-2907"><a href="#DynamicCostIndexComputer-2907"><span class="linenos">2907</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="DynamicCostIndexComputer-2908"><a href="#DynamicCostIndexComputer-2908"><span class="linenos">2908</span></a>
</span><span id="DynamicCostIndexComputer-2909"><a href="#DynamicCostIndexComputer-2909"><span class="linenos">2909</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2910"><a href="#DynamicCostIndexComputer-2910"><span class="linenos">2910</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2911"><a href="#DynamicCostIndexComputer-2911"><span class="linenos">2911</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="DynamicCostIndexComputer-2912"><a href="#DynamicCostIndexComputer-2912"><span class="linenos">2912</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="DynamicCostIndexComputer-2913"><a href="#DynamicCostIndexComputer-2913"><span class="linenos">2913</span></a>
</span><span id="DynamicCostIndexComputer-2914"><a href="#DynamicCostIndexComputer-2914"><span class="linenos">2914</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="DynamicCostIndexComputer-2915"><a href="#DynamicCostIndexComputer-2915"><span class="linenos">2915</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2916"><a href="#DynamicCostIndexComputer-2916"><span class="linenos">2916</span></a>
</span><span id="DynamicCostIndexComputer-2917"><a href="#DynamicCostIndexComputer-2917"><span class="linenos">2917</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2918"><a href="#DynamicCostIndexComputer-2918"><span class="linenos">2918</span></a>
</span><span id="DynamicCostIndexComputer-2919"><a href="#DynamicCostIndexComputer-2919"><span class="linenos">2919</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2920"><a href="#DynamicCostIndexComputer-2920"><span class="linenos">2920</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-2921"><a href="#DynamicCostIndexComputer-2921"><span class="linenos">2921</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2922"><a href="#DynamicCostIndexComputer-2922"><span class="linenos">2922</span></a><span class="sd">		else:</span>
</span><span id="DynamicCostIndexComputer-2923"><a href="#DynamicCostIndexComputer-2923"><span class="linenos">2923</span></a><span class="sd">			if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="DynamicCostIndexComputer-2924"><a href="#DynamicCostIndexComputer-2924"><span class="linenos">2924</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="DynamicCostIndexComputer-2925"><a href="#DynamicCostIndexComputer-2925"><span class="linenos">2925</span></a>
</span><span id="DynamicCostIndexComputer-2926"><a href="#DynamicCostIndexComputer-2926"><span class="linenos">2926</span></a><span class="sd">			if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="DynamicCostIndexComputer-2927"><a href="#DynamicCostIndexComputer-2927"><span class="linenos">2927</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="DynamicCostIndexComputer-2928"><a href="#DynamicCostIndexComputer-2928"><span class="linenos">2928</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2929"><a href="#DynamicCostIndexComputer-2929"><span class="linenos">2929</span></a>
</span><span id="DynamicCostIndexComputer-2930"><a href="#DynamicCostIndexComputer-2930"><span class="linenos">2930</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="DynamicCostIndexComputer-2931"><a href="#DynamicCostIndexComputer-2931"><span class="linenos">2931</span></a>
</span><span id="DynamicCostIndexComputer-2932"><a href="#DynamicCostIndexComputer-2932"><span class="linenos">2932</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2933"><a href="#DynamicCostIndexComputer-2933"><span class="linenos">2933</span></a>
</span><span id="DynamicCostIndexComputer-2934"><a href="#DynamicCostIndexComputer-2934"><span class="linenos">2934</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2935"><a href="#DynamicCostIndexComputer-2935"><span class="linenos">2935</span></a>
</span><span id="DynamicCostIndexComputer-2936"><a href="#DynamicCostIndexComputer-2936"><span class="linenos">2936</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-2937"><a href="#DynamicCostIndexComputer-2937"><span class="linenos">2937</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer-2938"><a href="#DynamicCostIndexComputer-2938"><span class="linenos">2938</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="DynamicCostIndexComputer-2939"><a href="#DynamicCostIndexComputer-2939"><span class="linenos">2939</span></a>
</span><span id="DynamicCostIndexComputer-2940"><a href="#DynamicCostIndexComputer-2940"><span class="linenos">2940</span></a>
</span><span id="DynamicCostIndexComputer-2941"><a href="#DynamicCostIndexComputer-2941"><span class="linenos">2941</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer-2942"><a href="#DynamicCostIndexComputer-2942"><span class="linenos">2942</span></a>
</span><span id="DynamicCostIndexComputer-2943"><a href="#DynamicCostIndexComputer-2943"><span class="linenos">2943</span></a>			<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer-2944"><a href="#DynamicCostIndexComputer-2944"><span class="linenos">2944</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2945"><a href="#DynamicCostIndexComputer-2945"><span class="linenos">2945</span></a>
</span><span id="DynamicCostIndexComputer-2946"><a href="#DynamicCostIndexComputer-2946"><span class="linenos">2946</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2947"><a href="#DynamicCostIndexComputer-2947"><span class="linenos">2947</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="DynamicCostIndexComputer-2948"><a href="#DynamicCostIndexComputer-2948"><span class="linenos">2948</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="DynamicCostIndexComputer-2949"><a href="#DynamicCostIndexComputer-2949"><span class="linenos">2949</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="DynamicCostIndexComputer-2950"><a href="#DynamicCostIndexComputer-2950"><span class="linenos">2950</span></a>
</span><span id="DynamicCostIndexComputer-2951"><a href="#DynamicCostIndexComputer-2951"><span class="linenos">2951</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="DynamicCostIndexComputer-2952"><a href="#DynamicCostIndexComputer-2952"><span class="linenos">2952</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="DynamicCostIndexComputer-2953"><a href="#DynamicCostIndexComputer-2953"><span class="linenos">2953</span></a>
</span><span id="DynamicCostIndexComputer-2954"><a href="#DynamicCostIndexComputer-2954"><span class="linenos">2954</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="DynamicCostIndexComputer-2955"><a href="#DynamicCostIndexComputer-2955"><span class="linenos">2955</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="DynamicCostIndexComputer-2956"><a href="#DynamicCostIndexComputer-2956"><span class="linenos">2956</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="DynamicCostIndexComputer-2957"><a href="#DynamicCostIndexComputer-2957"><span class="linenos">2957</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="DynamicCostIndexComputer-2958"><a href="#DynamicCostIndexComputer-2958"><span class="linenos">2958</span></a>
</span><span id="DynamicCostIndexComputer-2959"><a href="#DynamicCostIndexComputer-2959"><span class="linenos">2959</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="DynamicCostIndexComputer-2960"><a href="#DynamicCostIndexComputer-2960"><span class="linenos">2960</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="DynamicCostIndexComputer-2961"><a href="#DynamicCostIndexComputer-2961"><span class="linenos">2961</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="DynamicCostIndexComputer-2962"><a href="#DynamicCostIndexComputer-2962"><span class="linenos">2962</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="DynamicCostIndexComputer-2963"><a href="#DynamicCostIndexComputer-2963"><span class="linenos">2963</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer-2964"><a href="#DynamicCostIndexComputer-2964"><span class="linenos">2964</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="DynamicCostIndexComputer-2965"><a href="#DynamicCostIndexComputer-2965"><span class="linenos">2965</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="DynamicCostIndexComputer-2966"><a href="#DynamicCostIndexComputer-2966"><span class="linenos">2966</span></a>
</span><span id="DynamicCostIndexComputer-2967"><a href="#DynamicCostIndexComputer-2967"><span class="linenos">2967</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer-2968"><a href="#DynamicCostIndexComputer-2968"><span class="linenos">2968</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2969"><a href="#DynamicCostIndexComputer-2969"><span class="linenos">2969</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2970"><a href="#DynamicCostIndexComputer-2970"><span class="linenos">2970</span></a>
</span><span id="DynamicCostIndexComputer-2971"><a href="#DynamicCostIndexComputer-2971"><span class="linenos">2971</span></a>			<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer-2972"><a href="#DynamicCostIndexComputer-2972"><span class="linenos">2972</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-2973"><a href="#DynamicCostIndexComputer-2973"><span class="linenos">2973</span></a>
</span><span id="DynamicCostIndexComputer-2974"><a href="#DynamicCostIndexComputer-2974"><span class="linenos">2974</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer-2975"><a href="#DynamicCostIndexComputer-2975"><span class="linenos">2975</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2976"><a href="#DynamicCostIndexComputer-2976"><span class="linenos">2976</span></a>
</span><span id="DynamicCostIndexComputer-2977"><a href="#DynamicCostIndexComputer-2977"><span class="linenos">2977</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer-2978"><a href="#DynamicCostIndexComputer-2978"><span class="linenos">2978</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2979"><a href="#DynamicCostIndexComputer-2979"><span class="linenos">2979</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2980"><a href="#DynamicCostIndexComputer-2980"><span class="linenos">2980</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2981"><a href="#DynamicCostIndexComputer-2981"><span class="linenos">2981</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer-2982"><a href="#DynamicCostIndexComputer-2982"><span class="linenos">2982</span></a>
</span><span id="DynamicCostIndexComputer-2983"><a href="#DynamicCostIndexComputer-2983"><span class="linenos">2983</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="DynamicCostIndexComputer-2984"><a href="#DynamicCostIndexComputer-2984"><span class="linenos">2984</span></a>
</span><span id="DynamicCostIndexComputer-2985"><a href="#DynamicCostIndexComputer-2985"><span class="linenos">2985</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="DynamicCostIndexComputer-2986"><a href="#DynamicCostIndexComputer-2986"><span class="linenos">2986</span></a>
</span><span id="DynamicCostIndexComputer-2987"><a href="#DynamicCostIndexComputer-2987"><span class="linenos">2987</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2988"><a href="#DynamicCostIndexComputer-2988"><span class="linenos">2988</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l1&#39;</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2989"><a href="#DynamicCostIndexComputer-2989"><span class="linenos">2989</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2990"><a href="#DynamicCostIndexComputer-2990"><span class="linenos">2990</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2991"><a href="#DynamicCostIndexComputer-2991"><span class="linenos">2991</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-2992"><a href="#DynamicCostIndexComputer-2992"><span class="linenos">2992</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-2993"><a href="#DynamicCostIndexComputer-2993"><span class="linenos">2993</span></a>
</span><span id="DynamicCostIndexComputer-2994"><a href="#DynamicCostIndexComputer-2994"><span class="linenos">2994</span></a>		<span class="k">return</span> <span class="n">f</span>
</span><span id="DynamicCostIndexComputer-2995"><a href="#DynamicCostIndexComputer-2995"><span class="linenos">2995</span></a>
</span><span id="DynamicCostIndexComputer-2996"><a href="#DynamicCostIndexComputer-2996"><span class="linenos">2996</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-2997"><a href="#DynamicCostIndexComputer-2997"><span class="linenos">2997</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-2998"><a href="#DynamicCostIndexComputer-2998"><span class="linenos">2998</span></a><span class="sd">		RULE OF THUMB FOR LEVEL 0:</span>
</span><span id="DynamicCostIndexComputer-2999"><a href="#DynamicCostIndexComputer-2999"><span class="linenos">2999</span></a><span class="sd">			The cost index is assessed only pre-departure (at pushback_ready), there is no dynamic changing (DCI).</span>
</span><span id="DynamicCostIndexComputer-3000"><a href="#DynamicCostIndexComputer-3000"><span class="linenos">3000</span></a><span class="sd">			Departure delays greater than 60 minutes always try to be amortised. Lower than 15 - never.</span>
</span><span id="DynamicCostIndexComputer-3001"><a href="#DynamicCostIndexComputer-3001"><span class="linenos">3001</span></a><span class="sd">			If between, probabilistic decision is made according to a linear prob. distribution (from 20% at 15 mins).</span>
</span><span id="DynamicCostIndexComputer-3002"><a href="#DynamicCostIndexComputer-3002"><span class="linenos">3002</span></a><span class="sd">			As a general rule, we try to reduce the delay as much as possible to 5 minutes.</span>
</span><span id="DynamicCostIndexComputer-3003"><a href="#DynamicCostIndexComputer-3003"><span class="linenos">3003</span></a>
</span><span id="DynamicCostIndexComputer-3004"><a href="#DynamicCostIndexComputer-3004"><span class="linenos">3004</span></a><span class="sd">			Therefore, if enough fuel - reduce delay to 5 minutes. If not enough fuel to reduce to 5,</span>
</span><span id="DynamicCostIndexComputer-3005"><a href="#DynamicCostIndexComputer-3005"><span class="linenos">3005</span></a><span class="sd">			use max_fuel to achieve maximum possible delay reduction.</span>
</span><span id="DynamicCostIndexComputer-3006"><a href="#DynamicCostIndexComputer-3006"><span class="linenos">3006</span></a>
</span><span id="DynamicCostIndexComputer-3007"><a href="#DynamicCostIndexComputer-3007"><span class="linenos">3007</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3008"><a href="#DynamicCostIndexComputer-3008"><span class="linenos">3008</span></a>
</span><span id="DynamicCostIndexComputer-3009"><a href="#DynamicCostIndexComputer-3009"><span class="linenos">3009</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 0 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-3010"><a href="#DynamicCostIndexComputer-3010"><span class="linenos">3010</span></a>
</span><span id="DynamicCostIndexComputer-3011"><a href="#DynamicCostIndexComputer-3011"><span class="linenos">3011</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3012"><a href="#DynamicCostIndexComputer-3012"><span class="linenos">3012</span></a>
</span><span id="DynamicCostIndexComputer-3013"><a href="#DynamicCostIndexComputer-3013"><span class="linenos">3013</span></a>		<span class="c1"># retrieve cost dictionary for the flight provided by pdrp</span>
</span><span id="DynamicCostIndexComputer-3014"><a href="#DynamicCostIndexComputer-3014"><span class="linenos">3014</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3015"><a href="#DynamicCostIndexComputer-3015"><span class="linenos">3015</span></a>
</span><span id="DynamicCostIndexComputer-3016"><a href="#DynamicCostIndexComputer-3016"><span class="linenos">3016</span></a>		<span class="c1"># init - needed if not speed change is going to occur, for saving to DB</span>
</span><span id="DynamicCostIndexComputer-3017"><a href="#DynamicCostIndexComputer-3017"><span class="linenos">3017</span></a>		<span class="n">dep_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3018"><a href="#DynamicCostIndexComputer-3018"><span class="linenos">3018</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3019"><a href="#DynamicCostIndexComputer-3019"><span class="linenos">3019</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3020"><a href="#DynamicCostIndexComputer-3020"><span class="linenos">3020</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3021"><a href="#DynamicCostIndexComputer-3021"><span class="linenos">3021</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3022"><a href="#DynamicCostIndexComputer-3022"><span class="linenos">3022</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3023"><a href="#DynamicCostIndexComputer-3023"><span class="linenos">3023</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3024"><a href="#DynamicCostIndexComputer-3024"><span class="linenos">3024</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3025"><a href="#DynamicCostIndexComputer-3025"><span class="linenos">3025</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3026"><a href="#DynamicCostIndexComputer-3026"><span class="linenos">3026</span></a>
</span><span id="DynamicCostIndexComputer-3027"><a href="#DynamicCostIndexComputer-3027"><span class="linenos">3027</span></a>		<span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3028"><a href="#DynamicCostIndexComputer-3028"><span class="linenos">3028</span></a>			<span class="c1"># We can change the speed</span>
</span><span id="DynamicCostIndexComputer-3029"><a href="#DynamicCostIndexComputer-3029"><span class="linenos">3029</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;We can change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;before departure.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3030"><a href="#DynamicCostIndexComputer-3030"><span class="linenos">3030</span></a>
</span><span id="DynamicCostIndexComputer-3031"><a href="#DynamicCostIndexComputer-3031"><span class="linenos">3031</span></a>			<span class="c1"># check departure delay at pushback ready</span>
</span><span id="DynamicCostIndexComputer-3032"><a href="#DynamicCostIndexComputer-3032"><span class="linenos">3032</span></a>			<span class="n">dep_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sobt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3033"><a href="#DynamicCostIndexComputer-3033"><span class="linenos">3033</span></a>
</span><span id="DynamicCostIndexComputer-3034"><a href="#DynamicCostIndexComputer-3034"><span class="linenos">3034</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3035"><a href="#DynamicCostIndexComputer-3035"><span class="linenos">3035</span></a>
</span><span id="DynamicCostIndexComputer-3036"><a href="#DynamicCostIndexComputer-3036"><span class="linenos">3036</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3037"><a href="#DynamicCostIndexComputer-3037"><span class="linenos">3037</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">dep_delay</span> <span class="o">-</span> <span class="mi">5</span>  <span class="c1"># 5 minutes delay never recovered. delta_t is now the time a flight would like to recover.</span>
</span><span id="DynamicCostIndexComputer-3038"><a href="#DynamicCostIndexComputer-3038"><span class="linenos">3038</span></a>
</span><span id="DynamicCostIndexComputer-3039"><a href="#DynamicCostIndexComputer-3039"><span class="linenos">3039</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>  <span class="c1"># if what I want to recover is larger than max time I can recover</span>
</span><span id="DynamicCostIndexComputer-3040"><a href="#DynamicCostIndexComputer-3040"><span class="linenos">3040</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># then recover maximum time possible</span>
</span><span id="DynamicCostIndexComputer-3041"><a href="#DynamicCostIndexComputer-3041"><span class="linenos">3041</span></a>				<span class="c1"># otherwise recover full delta_t. delta_t is now true time I can and want to recover with the fuel I have</span>
</span><span id="DynamicCostIndexComputer-3042"><a href="#DynamicCostIndexComputer-3042"><span class="linenos">3042</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3043"><a href="#DynamicCostIndexComputer-3043"><span class="linenos">3043</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># delta_t is now the max time a flight can recover (it&#39;s negative now!)</span>
</span><span id="DynamicCostIndexComputer-3044"><a href="#DynamicCostIndexComputer-3044"><span class="linenos">3044</span></a>
</span><span id="DynamicCostIndexComputer-3045"><a href="#DynamicCostIndexComputer-3045"><span class="linenos">3045</span></a>				<span class="c1"># delta_t CAN STILL CHANGE due to the fact we limit perc_selected to 0.9</span>
</span><span id="DynamicCostIndexComputer-3046"><a href="#DynamicCostIndexComputer-3046"><span class="linenos">3046</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)))),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># new speed capped at 0.9*nominal</span>
</span><span id="DynamicCostIndexComputer-3047"><a href="#DynamicCostIndexComputer-3047"><span class="linenos">3047</span></a>
</span><span id="DynamicCostIndexComputer-3048"><a href="#DynamicCostIndexComputer-3048"><span class="linenos">3048</span></a>				<span class="k">if</span> <span class="n">perc_selected</span> <span class="o">==</span> <span class="mf">0.9</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3049"><a href="#DynamicCostIndexComputer-3049"><span class="linenos">3049</span></a>					<span class="c1"># use triangle similarity to find REAL delta_t</span>
</span><span id="DynamicCostIndexComputer-3050"><a href="#DynamicCostIndexComputer-3050"><span class="linenos">3050</span></a>					<span class="n">p1_time</span> <span class="o">=</span> <span class="n">delta_t</span><span class="o">-</span><span class="mi">10</span>
</span><span id="DynamicCostIndexComputer-3051"><a href="#DynamicCostIndexComputer-3051"><span class="linenos">3051</span></a>					<span class="n">p1</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">p1_time</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3052"><a href="#DynamicCostIndexComputer-3052"><span class="linenos">3052</span></a>					<span class="n">p2</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3053"><a href="#DynamicCostIndexComputer-3053"><span class="linenos">3053</span></a>					<span class="n">real_delta_t</span> <span class="o">=</span> <span class="p">((</span><span class="n">p2</span> <span class="o">-</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1_time</span> <span class="o">-</span> <span class="n">delta_t</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_t</span>
</span><span id="DynamicCostIndexComputer-3054"><a href="#DynamicCostIndexComputer-3054"><span class="linenos">3054</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">real_delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3055"><a href="#DynamicCostIndexComputer-3055"><span class="linenos">3055</span></a>
</span><span id="DynamicCostIndexComputer-3056"><a href="#DynamicCostIndexComputer-3056"><span class="linenos">3056</span></a>				<span class="c1"># If after checking with the fuel function, a flight cannot recover more than 5 minutes, do not recover anything</span>
</span><span id="DynamicCostIndexComputer-3057"><a href="#DynamicCostIndexComputer-3057"><span class="linenos">3057</span></a>				<span class="c1"># AND limit the usage of extra fuel to self.agent.max_extra_fuel_used percent of extra_fuel_available</span>
</span><span id="DynamicCostIndexComputer-3058"><a href="#DynamicCostIndexComputer-3058"><span class="linenos">3058</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># the extra fuel needed to recover delta_t</span>
</span><span id="DynamicCostIndexComputer-3059"><a href="#DynamicCostIndexComputer-3059"><span class="linenos">3059</span></a>				<span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dfuel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">max_extra_fuel_used</span> <span class="o">*</span> <span class="n">extra_fuel_available</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3060"><a href="#DynamicCostIndexComputer-3060"><span class="linenos">3060</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3061"><a href="#DynamicCostIndexComputer-3061"><span class="linenos">3061</span></a>					<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3062"><a href="#DynamicCostIndexComputer-3062"><span class="linenos">3062</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3063"><a href="#DynamicCostIndexComputer-3063"><span class="linenos">3063</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="DynamicCostIndexComputer-3064"><a href="#DynamicCostIndexComputer-3064"><span class="linenos">3064</span></a>					<span class="c1"># 	print(&quot;Recovering delay of &quot;, delta_t, &quot;minutes, with % of fuel &quot;, round(dfuel/extra_fuel_available*100, 2))</span>
</span><span id="DynamicCostIndexComputer-3065"><a href="#DynamicCostIndexComputer-3065"><span class="linenos">3065</span></a>					<span class="c1"># 	print(&quot;I got a perc from tfsc: &quot;, tfsc[&#39;perc_variation_func&#39;](delta_t))</span>
</span><span id="DynamicCostIndexComputer-3066"><a href="#DynamicCostIndexComputer-3066"><span class="linenos">3066</span></a>					<span class="c1"># 	print(&quot;Flight &quot;, flight_uid, &quot;is deciding to speed up with selected perc &quot;, perc_selected*100)</span>
</span><span id="DynamicCostIndexComputer-3067"><a href="#DynamicCostIndexComputer-3067"><span class="linenos">3067</span></a>
</span><span id="DynamicCostIndexComputer-3068"><a href="#DynamicCostIndexComputer-3068"><span class="linenos">3068</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer-3069"><a href="#DynamicCostIndexComputer-3069"><span class="linenos">3069</span></a>						   <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; before take-off. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3070"><a href="#DynamicCostIndexComputer-3070"><span class="linenos">3070</span></a>
</span><span id="DynamicCostIndexComputer-3071"><a href="#DynamicCostIndexComputer-3071"><span class="linenos">3071</span></a>					<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="DynamicCostIndexComputer-3072"><a href="#DynamicCostIndexComputer-3072"><span class="linenos">3072</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3073"><a href="#DynamicCostIndexComputer-3073"><span class="linenos">3073</span></a>
</span><span id="DynamicCostIndexComputer-3074"><a href="#DynamicCostIndexComputer-3074"><span class="linenos">3074</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3075"><a href="#DynamicCostIndexComputer-3075"><span class="linenos">3075</span></a>
</span><span id="DynamicCostIndexComputer-3076"><a href="#DynamicCostIndexComputer-3076"><span class="linenos">3076</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="DynamicCostIndexComputer-3077"><a href="#DynamicCostIndexComputer-3077"><span class="linenos">3077</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pushback_ready&#39;</span><span class="p">,</span> <span class="n">dep_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3078"><a href="#DynamicCostIndexComputer-3078"><span class="linenos">3078</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3079"><a href="#DynamicCostIndexComputer-3079"><span class="linenos">3079</span></a>
</span><span id="DynamicCostIndexComputer-3080"><a href="#DynamicCostIndexComputer-3080"><span class="linenos">3080</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3081"><a href="#DynamicCostIndexComputer-3081"><span class="linenos">3081</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3082"><a href="#DynamicCostIndexComputer-3082"><span class="linenos">3082</span></a><span class="sd">		On level 1, the first time CI is assessed is at top of the climb.</span>
</span><span id="DynamicCostIndexComputer-3083"><a href="#DynamicCostIndexComputer-3083"><span class="linenos">3083</span></a>
</span><span id="DynamicCostIndexComputer-3084"><a href="#DynamicCostIndexComputer-3084"><span class="linenos">3084</span></a><span class="sd">		From deliverable: Dynamic cost indexing for flights, with a simplified in-flight delay and</span>
</span><span id="DynamicCostIndexComputer-3085"><a href="#DynamicCostIndexComputer-3085"><span class="linenos">3085</span></a><span class="sd">		cost estimation based on heuristics and general cost of delay rules.</span>
</span><span id="DynamicCostIndexComputer-3086"><a href="#DynamicCostIndexComputer-3086"><span class="linenos">3086</span></a>
</span><span id="DynamicCostIndexComputer-3087"><a href="#DynamicCostIndexComputer-3087"><span class="linenos">3087</span></a><span class="sd">		At TOC: Estimate times I can recover and fuel needed. Compute time and fuel costs, and choose</span>
</span><span id="DynamicCostIndexComputer-3088"><a href="#DynamicCostIndexComputer-3088"><span class="linenos">3088</span></a><span class="sd">		the cheapest option.</span>
</span><span id="DynamicCostIndexComputer-3089"><a href="#DynamicCostIndexComputer-3089"><span class="linenos">3089</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3090"><a href="#DynamicCostIndexComputer-3090"><span class="linenos">3090</span></a>
</span><span id="DynamicCostIndexComputer-3091"><a href="#DynamicCostIndexComputer-3091"><span class="linenos">3091</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-3092"><a href="#DynamicCostIndexComputer-3092"><span class="linenos">3092</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3093"><a href="#DynamicCostIndexComputer-3093"><span class="linenos">3093</span></a>
</span><span id="DynamicCostIndexComputer-3094"><a href="#DynamicCostIndexComputer-3094"><span class="linenos">3094</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3095"><a href="#DynamicCostIndexComputer-3095"><span class="linenos">3095</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3096"><a href="#DynamicCostIndexComputer-3096"><span class="linenos">3096</span></a>
</span><span id="DynamicCostIndexComputer-3097"><a href="#DynamicCostIndexComputer-3097"><span class="linenos">3097</span></a>		<span class="n">estimated_delay</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># fill with exp_arr_delay when estimation is done</span>
</span><span id="DynamicCostIndexComputer-3098"><a href="#DynamicCostIndexComputer-3098"><span class="linenos">3098</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3099"><a href="#DynamicCostIndexComputer-3099"><span class="linenos">3099</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3100"><a href="#DynamicCostIndexComputer-3100"><span class="linenos">3100</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3101"><a href="#DynamicCostIndexComputer-3101"><span class="linenos">3101</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3102"><a href="#DynamicCostIndexComputer-3102"><span class="linenos">3102</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3103"><a href="#DynamicCostIndexComputer-3103"><span class="linenos">3103</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3104"><a href="#DynamicCostIndexComputer-3104"><span class="linenos">3104</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3105"><a href="#DynamicCostIndexComputer-3105"><span class="linenos">3105</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3106"><a href="#DynamicCostIndexComputer-3106"><span class="linenos">3106</span></a>
</span><span id="DynamicCostIndexComputer-3107"><a href="#DynamicCostIndexComputer-3107"><span class="linenos">3107</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3108"><a href="#DynamicCostIndexComputer-3108"><span class="linenos">3108</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3109"><a href="#DynamicCostIndexComputer-3109"><span class="linenos">3109</span></a>
</span><span id="DynamicCostIndexComputer-3110"><a href="#DynamicCostIndexComputer-3110"><span class="linenos">3110</span></a>			<span class="c1"># Assess expected arrival delay at TOC</span>
</span><span id="DynamicCostIndexComputer-3111"><a href="#DynamicCostIndexComputer-3111"><span class="linenos">3111</span></a>			<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-3112"><a href="#DynamicCostIndexComputer-3112"><span class="linenos">3112</span></a>
</span><span id="DynamicCostIndexComputer-3113"><a href="#DynamicCostIndexComputer-3113"><span class="linenos">3113</span></a>			<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3114"><a href="#DynamicCostIndexComputer-3114"><span class="linenos">3114</span></a>			<span class="n">estimated_delay</span> <span class="o">=</span> <span class="n">exp_arr_delay</span>  <span class="c1"># for saving</span>
</span><span id="DynamicCostIndexComputer-3115"><a href="#DynamicCostIndexComputer-3115"><span class="linenos">3115</span></a>			<span class="c1"># print(&quot;Expected arrival delay is &quot;, exp_arr_delay)</span>
</span><span id="DynamicCostIndexComputer-3116"><a href="#DynamicCostIndexComputer-3116"><span class="linenos">3116</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;estimates at TOC that the expected arrival delay is&quot;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="s2">&quot; minutes.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3117"><a href="#DynamicCostIndexComputer-3117"><span class="linenos">3117</span></a>
</span><span id="DynamicCostIndexComputer-3118"><a href="#DynamicCostIndexComputer-3118"><span class="linenos">3118</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3119"><a href="#DynamicCostIndexComputer-3119"><span class="linenos">3119</span></a>			<span class="c1"># FUEL COST</span>
</span><span id="DynamicCostIndexComputer-3120"><a href="#DynamicCostIndexComputer-3120"><span class="linenos">3120</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3121"><a href="#DynamicCostIndexComputer-3121"><span class="linenos">3121</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3122"><a href="#DynamicCostIndexComputer-3122"><span class="linenos">3122</span></a><span class="sd">			x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="DynamicCostIndexComputer-3123"><a href="#DynamicCostIndexComputer-3123"><span class="linenos">3123</span></a><span class="sd">			plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="DynamicCostIndexComputer-3124"><a href="#DynamicCostIndexComputer-3124"><span class="linenos">3124</span></a><span class="sd">			plt.show()</span>
</span><span id="DynamicCostIndexComputer-3125"><a href="#DynamicCostIndexComputer-3125"><span class="linenos">3125</span></a><span class="sd">			plt.clf()</span>
</span><span id="DynamicCostIndexComputer-3126"><a href="#DynamicCostIndexComputer-3126"><span class="linenos">3126</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3127"><a href="#DynamicCostIndexComputer-3127"><span class="linenos">3127</span></a>
</span><span id="DynamicCostIndexComputer-3128"><a href="#DynamicCostIndexComputer-3128"><span class="linenos">3128</span></a>			<span class="n">fuel_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3129"><a href="#DynamicCostIndexComputer-3129"><span class="linenos">3129</span></a>			<span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">])),</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3130"><a href="#DynamicCostIndexComputer-3130"><span class="linenos">3130</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">fuel_cost_func</span><span class="p">(</span><span class="o">-</span><span class="n">x_cont</span><span class="p">)</span>  <span class="c1"># for recovering -fuel cost needs negative values</span>
</span><span id="DynamicCostIndexComputer-3131"><a href="#DynamicCostIndexComputer-3131"><span class="linenos">3131</span></a>
</span><span id="DynamicCostIndexComputer-3132"><a href="#DynamicCostIndexComputer-3132"><span class="linenos">3132</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3133"><a href="#DynamicCostIndexComputer-3133"><span class="linenos">3133</span></a>			<span class="c1"># TIME COST</span>
</span><span id="DynamicCostIndexComputer-3134"><a href="#DynamicCostIndexComputer-3134"><span class="linenos">3134</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3135"><a href="#DynamicCostIndexComputer-3135"><span class="linenos">3135</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3136"><a href="#DynamicCostIndexComputer-3136"><span class="linenos">3136</span></a><span class="sd">			ABOUT TIME COST FUNCTION</span>
</span><span id="DynamicCostIndexComputer-3137"><a href="#DynamicCostIndexComputer-3137"><span class="linenos">3137</span></a>
</span><span id="DynamicCostIndexComputer-3138"><a href="#DynamicCostIndexComputer-3138"><span class="linenos">3138</span></a><span class="sd">			Time cost function is a function of the recovered delay, i.e. on x-axis we have</span>
</span><span id="DynamicCostIndexComputer-3139"><a href="#DynamicCostIndexComputer-3139"><span class="linenos">3139</span></a><span class="sd">			minutes of delay a flight decides to recover by speeding up.</span>
</span><span id="DynamicCostIndexComputer-3140"><a href="#DynamicCostIndexComputer-3140"><span class="linenos">3140</span></a><span class="sd">			E.g. Let&#39;s say a flight, at TOC, estimates arrival delay of 20 minutes</span>
</span><span id="DynamicCostIndexComputer-3141"><a href="#DynamicCostIndexComputer-3141"><span class="linenos">3141</span></a><span class="sd">			and decides to recover 3 minutes. time_cost(3) is the cost  when the flight decides to speed up</span>
</span><span id="DynamicCostIndexComputer-3142"><a href="#DynamicCostIndexComputer-3142"><span class="linenos">3142</span></a><span class="sd">			so to recover 3 minutes, so it is the cost of the 17 minutes delay that is left.</span>
</span><span id="DynamicCostIndexComputer-3143"><a href="#DynamicCostIndexComputer-3143"><span class="linenos">3143</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3144"><a href="#DynamicCostIndexComputer-3144"><span class="linenos">3144</span></a>
</span><span id="DynamicCostIndexComputer-3145"><a href="#DynamicCostIndexComputer-3145"><span class="linenos">3145</span></a>			<span class="n">time_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3146"><a href="#DynamicCostIndexComputer-3146"><span class="linenos">3146</span></a>			<span class="n">time_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cost_func</span><span class="p">(</span><span class="n">exp_arr_delay</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_cont</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3147"><a href="#DynamicCostIndexComputer-3147"><span class="linenos">3147</span></a>
</span><span id="DynamicCostIndexComputer-3148"><a href="#DynamicCostIndexComputer-3148"><span class="linenos">3148</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3149"><a href="#DynamicCostIndexComputer-3149"><span class="linenos">3149</span></a>			<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="DynamicCostIndexComputer-3150"><a href="#DynamicCostIndexComputer-3150"><span class="linenos">3150</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer-3151"><a href="#DynamicCostIndexComputer-3151"><span class="linenos">3151</span></a>			<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time_cost</span> <span class="o">+</span> <span class="n">fuel_cost</span>
</span><span id="DynamicCostIndexComputer-3152"><a href="#DynamicCostIndexComputer-3152"><span class="linenos">3152</span></a>
</span><span id="DynamicCostIndexComputer-3153"><a href="#DynamicCostIndexComputer-3153"><span class="linenos">3153</span></a>			<span class="n">delay_to_recover</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_cont</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">total_cost</span><span class="p">)])</span>  <span class="c1"># recover with a resolution of one minute</span>
</span><span id="DynamicCostIndexComputer-3154"><a href="#DynamicCostIndexComputer-3154"><span class="linenos">3154</span></a>
</span><span id="DynamicCostIndexComputer-3155"><a href="#DynamicCostIndexComputer-3155"><span class="linenos">3155</span></a>			<span class="c1"># print(flight_str(flight_uid), &quot; decides to recover &quot;, delay_to_recover, &quot; minutes.&quot;)</span>
</span><span id="DynamicCostIndexComputer-3156"><a href="#DynamicCostIndexComputer-3156"><span class="linenos">3156</span></a>
</span><span id="DynamicCostIndexComputer-3157"><a href="#DynamicCostIndexComputer-3157"><span class="linenos">3157</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3158"><a href="#DynamicCostIndexComputer-3158"><span class="linenos">3158</span></a><span class="sd">			#### PLOT THE COST FUNCs - uncomment for plotting costs when flight recovers some delay</span>
</span><span id="DynamicCostIndexComputer-3159"><a href="#DynamicCostIndexComputer-3159"><span class="linenos">3159</span></a><span class="sd">			if delay_to_recover &gt; 0:</span>
</span><span id="DynamicCostIndexComputer-3160"><a href="#DynamicCostIndexComputer-3160"><span class="linenos">3160</span></a><span class="sd">				self.plot_costs_dci(time_cost, fuel_cost, x_cont)</span>
</span><span id="DynamicCostIndexComputer-3161"><a href="#DynamicCostIndexComputer-3161"><span class="linenos">3161</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3162"><a href="#DynamicCostIndexComputer-3162"><span class="linenos">3162</span></a>
</span><span id="DynamicCostIndexComputer-3163"><a href="#DynamicCostIndexComputer-3163"><span class="linenos">3163</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="n">delay_to_recover</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3164"><a href="#DynamicCostIndexComputer-3164"><span class="linenos">3164</span></a>
</span><span id="DynamicCostIndexComputer-3165"><a href="#DynamicCostIndexComputer-3165"><span class="linenos">3165</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3166"><a href="#DynamicCostIndexComputer-3166"><span class="linenos">3166</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">delay_to_recover</span>
</span><span id="DynamicCostIndexComputer-3167"><a href="#DynamicCostIndexComputer-3167"><span class="linenos">3167</span></a>
</span><span id="DynamicCostIndexComputer-3168"><a href="#DynamicCostIndexComputer-3168"><span class="linenos">3168</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>
</span><span id="DynamicCostIndexComputer-3169"><a href="#DynamicCostIndexComputer-3169"><span class="linenos">3169</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3170"><a href="#DynamicCostIndexComputer-3170"><span class="linenos">3170</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3171"><a href="#DynamicCostIndexComputer-3171"><span class="linenos">3171</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3172"><a href="#DynamicCostIndexComputer-3172"><span class="linenos">3172</span></a>
</span><span id="DynamicCostIndexComputer-3173"><a href="#DynamicCostIndexComputer-3173"><span class="linenos">3173</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3174"><a href="#DynamicCostIndexComputer-3174"><span class="linenos">3174</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot;is deciding to speed up with selected perc &quot;, perc_selected)</span>
</span><span id="DynamicCostIndexComputer-3175"><a href="#DynamicCostIndexComputer-3175"><span class="linenos">3175</span></a>
</span><span id="DynamicCostIndexComputer-3176"><a href="#DynamicCostIndexComputer-3176"><span class="linenos">3176</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3177"><a href="#DynamicCostIndexComputer-3177"><span class="linenos">3177</span></a>				<span class="c1"># print(&quot;The price of the extra fuel &quot;, dfuel, &quot; is &quot;, dfuel * self.agent.fuel_price, &quot; with fuel price set to &quot;, self.agent.fuel_price)</span>
</span><span id="DynamicCostIndexComputer-3178"><a href="#DynamicCostIndexComputer-3178"><span class="linenos">3178</span></a>
</span><span id="DynamicCostIndexComputer-3179"><a href="#DynamicCostIndexComputer-3179"><span class="linenos">3179</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; at top of climb. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3180"><a href="#DynamicCostIndexComputer-3180"><span class="linenos">3180</span></a>
</span><span id="DynamicCostIndexComputer-3181"><a href="#DynamicCostIndexComputer-3181"><span class="linenos">3181</span></a>				<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="DynamicCostIndexComputer-3182"><a href="#DynamicCostIndexComputer-3182"><span class="linenos">3182</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3183"><a href="#DynamicCostIndexComputer-3183"><span class="linenos">3183</span></a>
</span><span id="DynamicCostIndexComputer-3184"><a href="#DynamicCostIndexComputer-3184"><span class="linenos">3184</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3185"><a href="#DynamicCostIndexComputer-3185"><span class="linenos">3185</span></a>
</span><span id="DynamicCostIndexComputer-3186"><a href="#DynamicCostIndexComputer-3186"><span class="linenos">3186</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="DynamicCostIndexComputer-3187"><a href="#DynamicCostIndexComputer-3187"><span class="linenos">3187</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb&#39;</span><span class="p">,</span> <span class="n">estimated_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3188"><a href="#DynamicCostIndexComputer-3188"><span class="linenos">3188</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3189"><a href="#DynamicCostIndexComputer-3189"><span class="linenos">3189</span></a>		<span class="c1"># print(&quot;Reassessment of  cost index FINISHED for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-3190"><a href="#DynamicCostIndexComputer-3190"><span class="linenos">3190</span></a>
</span><span id="DynamicCostIndexComputer-3191"><a href="#DynamicCostIndexComputer-3191"><span class="linenos">3191</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3192"><a href="#DynamicCostIndexComputer-3192"><span class="linenos">3192</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 2 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-3193"><a href="#DynamicCostIndexComputer-3193"><span class="linenos">3193</span></a>
</span><span id="DynamicCostIndexComputer-3194"><a href="#DynamicCostIndexComputer-3194"><span class="linenos">3194</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3195"><a href="#DynamicCostIndexComputer-3195"><span class="linenos">3195</span></a><span class="sd">		Doing the same as on level 1, but allowing to slow down if estimated arrival</span>
</span><span id="DynamicCostIndexComputer-3196"><a href="#DynamicCostIndexComputer-3196"><span class="linenos">3196</span></a><span class="sd">		more than 15 minutes earlier than scheduled. Slow down to 15 minutes.</span>
</span><span id="DynamicCostIndexComputer-3197"><a href="#DynamicCostIndexComputer-3197"><span class="linenos">3197</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3198"><a href="#DynamicCostIndexComputer-3198"><span class="linenos">3198</span></a>
</span><span id="DynamicCostIndexComputer-3199"><a href="#DynamicCostIndexComputer-3199"><span class="linenos">3199</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer-3200"><a href="#DynamicCostIndexComputer-3200"><span class="linenos">3200</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3201"><a href="#DynamicCostIndexComputer-3201"><span class="linenos">3201</span></a>
</span><span id="DynamicCostIndexComputer-3202"><a href="#DynamicCostIndexComputer-3202"><span class="linenos">3202</span></a>		<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-3203"><a href="#DynamicCostIndexComputer-3203"><span class="linenos">3203</span></a>		<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># allow it to be negative to detect early arrivals</span>
</span><span id="DynamicCostIndexComputer-3204"><a href="#DynamicCostIndexComputer-3204"><span class="linenos">3204</span></a>
</span><span id="DynamicCostIndexComputer-3205"><a href="#DynamicCostIndexComputer-3205"><span class="linenos">3205</span></a>		<span class="k">if</span> <span class="n">exp_arr_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3206"><a href="#DynamicCostIndexComputer-3206"><span class="linenos">3206</span></a>			<span class="c1"># do the same as on level 1: try to speed up further</span>
</span><span id="DynamicCostIndexComputer-3207"><a href="#DynamicCostIndexComputer-3207"><span class="linenos">3207</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3208"><a href="#DynamicCostIndexComputer-3208"><span class="linenos">3208</span></a>
</span><span id="DynamicCostIndexComputer-3209"><a href="#DynamicCostIndexComputer-3209"><span class="linenos">3209</span></a>		<span class="k">elif</span> <span class="n">exp_arr_delay</span> <span class="o">&lt;=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span><span class="p">:</span> <span class="c1"># default -30, arriving more than 30 minutes earlier than planned</span>
</span><span id="DynamicCostIndexComputer-3210"><a href="#DynamicCostIndexComputer-3210"><span class="linenos">3210</span></a>			<span class="c1"># print(&quot;Flight &quot;, flight_uid ,&quot; expects to arrive &quot;, abs(exp_arr_delay), &quot; minutes earlier than scheduled.&quot;)</span>
</span><span id="DynamicCostIndexComputer-3211"><a href="#DynamicCostIndexComputer-3211"><span class="linenos">3211</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; expects to arrive &quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="s2">&quot; minutes earlier than scheduled.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3212"><a href="#DynamicCostIndexComputer-3212"><span class="linenos">3212</span></a>
</span><span id="DynamicCostIndexComputer-3213"><a href="#DynamicCostIndexComputer-3213"><span class="linenos">3213</span></a>			<span class="c1"># add add_mins minutes to the flight</span>
</span><span id="DynamicCostIndexComputer-3214"><a href="#DynamicCostIndexComputer-3214"><span class="linenos">3214</span></a>			<span class="n">add_mins</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span>
</span><span id="DynamicCostIndexComputer-3215"><a href="#DynamicCostIndexComputer-3215"><span class="linenos">3215</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3216"><a href="#DynamicCostIndexComputer-3216"><span class="linenos">3216</span></a>			<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3217"><a href="#DynamicCostIndexComputer-3217"><span class="linenos">3217</span></a>
</span><span id="DynamicCostIndexComputer-3218"><a href="#DynamicCostIndexComputer-3218"><span class="linenos">3218</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3219"><a href="#DynamicCostIndexComputer-3219"><span class="linenos">3219</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3220"><a href="#DynamicCostIndexComputer-3220"><span class="linenos">3220</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3221"><a href="#DynamicCostIndexComputer-3221"><span class="linenos">3221</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3222"><a href="#DynamicCostIndexComputer-3222"><span class="linenos">3222</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3223"><a href="#DynamicCostIndexComputer-3223"><span class="linenos">3223</span></a>
</span><span id="DynamicCostIndexComputer-3224"><a href="#DynamicCostIndexComputer-3224"><span class="linenos">3224</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3225"><a href="#DynamicCostIndexComputer-3225"><span class="linenos">3225</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to decrease the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3226"><a href="#DynamicCostIndexComputer-3226"><span class="linenos">3226</span></a>
</span><span id="DynamicCostIndexComputer-3227"><a href="#DynamicCostIndexComputer-3227"><span class="linenos">3227</span></a><span class="w">				</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3228"><a href="#DynamicCostIndexComputer-3228"><span class="linenos">3228</span></a><span class="sd">				x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="DynamicCostIndexComputer-3229"><a href="#DynamicCostIndexComputer-3229"><span class="linenos">3229</span></a><span class="sd">				plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="DynamicCostIndexComputer-3230"><a href="#DynamicCostIndexComputer-3230"><span class="linenos">3230</span></a><span class="sd">				plt.show()</span>
</span><span id="DynamicCostIndexComputer-3231"><a href="#DynamicCostIndexComputer-3231"><span class="linenos">3231</span></a><span class="sd">				plt.clf()</span>
</span><span id="DynamicCostIndexComputer-3232"><a href="#DynamicCostIndexComputer-3232"><span class="linenos">3232</span></a><span class="sd">				&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3233"><a href="#DynamicCostIndexComputer-3233"><span class="linenos">3233</span></a>
</span><span id="DynamicCostIndexComputer-3234"><a href="#DynamicCostIndexComputer-3234"><span class="linenos">3234</span></a>				<span class="c1"># real extra minutes that are going to be added to the flight - depends on max_time_w_fuel</span>
</span><span id="DynamicCostIndexComputer-3235"><a href="#DynamicCostIndexComputer-3235"><span class="linenos">3235</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">],</span> <span class="n">add_mins</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3236"><a href="#DynamicCostIndexComputer-3236"><span class="linenos">3236</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot; decides to add &quot;, delta_t, &quot; minutes as the maximum is &quot;, tfsc[&#39;max_time_w_fuel&#39;])</span>
</span><span id="DynamicCostIndexComputer-3237"><a href="#DynamicCostIndexComputer-3237"><span class="linenos">3237</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3238"><a href="#DynamicCostIndexComputer-3238"><span class="linenos">3238</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3239"><a href="#DynamicCostIndexComputer-3239"><span class="linenos">3239</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is adding&quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot;minutes to the flying time at top of climb. Saving&quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg of fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3240"><a href="#DynamicCostIndexComputer-3240"><span class="linenos">3240</span></a>
</span><span id="DynamicCostIndexComputer-3241"><a href="#DynamicCostIndexComputer-3241"><span class="linenos">3241</span></a>				<span class="c1"># send msg to flight plan updater to update speed - USE DCI_TOD_LANDING</span>
</span><span id="DynamicCostIndexComputer-3242"><a href="#DynamicCostIndexComputer-3242"><span class="linenos">3242</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3243"><a href="#DynamicCostIndexComputer-3243"><span class="linenos">3243</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage&quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3244"><a href="#DynamicCostIndexComputer-3244"><span class="linenos">3244</span></a>				<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3245"><a href="#DynamicCostIndexComputer-3245"><span class="linenos">3245</span></a>
</span><span id="DynamicCostIndexComputer-3246"><a href="#DynamicCostIndexComputer-3246"><span class="linenos">3246</span></a>				<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="DynamicCostIndexComputer-3247"><a href="#DynamicCostIndexComputer-3247"><span class="linenos">3247</span></a>				<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3248"><a href="#DynamicCostIndexComputer-3248"><span class="linenos">3248</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3249"><a href="#DynamicCostIndexComputer-3249"><span class="linenos">3249</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer-3250"><a href="#DynamicCostIndexComputer-3250"><span class="linenos">3250</span></a>			<span class="c1"># just save the info (flight didn&#39;t do anything on TOC)</span>
</span><span id="DynamicCostIndexComputer-3251"><a href="#DynamicCostIndexComputer-3251"><span class="linenos">3251</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3252"><a href="#DynamicCostIndexComputer-3252"><span class="linenos">3252</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3253"><a href="#DynamicCostIndexComputer-3253"><span class="linenos">3253</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3254"><a href="#DynamicCostIndexComputer-3254"><span class="linenos">3254</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer-3255"><a href="#DynamicCostIndexComputer-3255"><span class="linenos">3255</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer-3256"><a href="#DynamicCostIndexComputer-3256"><span class="linenos">3256</span></a>			<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3257"><a href="#DynamicCostIndexComputer-3257"><span class="linenos">3257</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3258"><a href="#DynamicCostIndexComputer-3258"><span class="linenos">3258</span></a>
</span><span id="DynamicCostIndexComputer-3259"><a href="#DynamicCostIndexComputer-3259"><span class="linenos">3259</span></a>		<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="DynamicCostIndexComputer-3260"><a href="#DynamicCostIndexComputer-3260"><span class="linenos">3260</span></a>		<span class="c1"># params = [&#39;top_of_climb_slow_down&#39;, exp_arr_delay, -delta_t, perc_selected, dfuel, extra_fuel_available, recoverable_delay]</span>
</span><span id="DynamicCostIndexComputer-3261"><a href="#DynamicCostIndexComputer-3261"><span class="linenos">3261</span></a>		<span class="c1"># self.save_dci_decision_info(flight_uid, params)</span>
</span><span id="DynamicCostIndexComputer-3262"><a href="#DynamicCostIndexComputer-3262"><span class="linenos">3262</span></a>
</span><span id="DynamicCostIndexComputer-3263"><a href="#DynamicCostIndexComputer-3263"><span class="linenos">3263</span></a>	<span class="k">def</span> <span class="nf">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3264"><a href="#DynamicCostIndexComputer-3264"><span class="linenos">3264</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3265"><a href="#DynamicCostIndexComputer-3265"><span class="linenos">3265</span></a><span class="sd">		Sends a message to the flight plan updater who updates the speed by</span>
</span><span id="DynamicCostIndexComputer-3266"><a href="#DynamicCostIndexComputer-3266"><span class="linenos">3266</span></a><span class="sd">		increasing it by perc_selected.</span>
</span><span id="DynamicCostIndexComputer-3267"><a href="#DynamicCostIndexComputer-3267"><span class="linenos">3267</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer-3268"><a href="#DynamicCostIndexComputer-3268"><span class="linenos">3268</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer-3269"><a href="#DynamicCostIndexComputer-3269"><span class="linenos">3269</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="DynamicCostIndexComputer-3270"><a href="#DynamicCostIndexComputer-3270"><span class="linenos">3270</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;speed_update&#39;</span>
</span><span id="DynamicCostIndexComputer-3271"><a href="#DynamicCostIndexComputer-3271"><span class="linenos">3271</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">perc_selected</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer-3272"><a href="#DynamicCostIndexComputer-3272"><span class="linenos">3272</span></a>					   <span class="s1">&#39;change_tod_dci&#39;</span><span class="p">:</span> <span class="n">change_tod_dci</span><span class="p">}</span>
</span><span id="DynamicCostIndexComputer-3273"><a href="#DynamicCostIndexComputer-3273"><span class="linenos">3273</span></a>
</span><span id="DynamicCostIndexComputer-3274"><a href="#DynamicCostIndexComputer-3274"><span class="linenos">3274</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3275"><a href="#DynamicCostIndexComputer-3275"><span class="linenos">3275</span></a>
</span><span id="DynamicCostIndexComputer-3276"><a href="#DynamicCostIndexComputer-3276"><span class="linenos">3276</span></a>	<span class="k">def</span> <span class="nf">save_dci_decision_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer-3277"><a href="#DynamicCostIndexComputer-3277"><span class="linenos">3277</span></a>		<span class="n">dci_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dci_check_timestamp&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3278"><a href="#DynamicCostIndexComputer-3278"><span class="linenos">3278</span></a>						<span class="s1">&#39;estimated_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3279"><a href="#DynamicCostIndexComputer-3279"><span class="linenos">3279</span></a>						<span class="s1">&#39;recovering_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3280"><a href="#DynamicCostIndexComputer-3280"><span class="linenos">3280</span></a>						<span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3281"><a href="#DynamicCostIndexComputer-3281"><span class="linenos">3281</span></a>						<span class="s1">&#39;dfuel&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3282"><a href="#DynamicCostIndexComputer-3282"><span class="linenos">3282</span></a>						<span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer-3283"><a href="#DynamicCostIndexComputer-3283"><span class="linenos">3283</span></a>						<span class="s1">&#39;recoverable_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer-3284"><a href="#DynamicCostIndexComputer-3284"><span class="linenos">3284</span></a>						<span class="p">}</span>
</span><span id="DynamicCostIndexComputer-3285"><a href="#DynamicCostIndexComputer-3285"><span class="linenos">3285</span></a>
</span><span id="DynamicCostIndexComputer-3286"><a href="#DynamicCostIndexComputer-3286"><span class="linenos">3286</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dci_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dci_decision</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer-3287"><a href="#DynamicCostIndexComputer-3287"><span class="linenos">3287</span></a>
</span><span id="DynamicCostIndexComputer-3288"><a href="#DynamicCostIndexComputer-3288"><span class="linenos">3288</span></a>		<span class="c1"># test</span>
</span><span id="DynamicCostIndexComputer-3289"><a href="#DynamicCostIndexComputer-3289"><span class="linenos">3289</span></a>		<span class="c1"># print(self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].dci_decisions)</span>
</span></pre></div>


            <div class="docstring"><p>DCIC</p>

<p>Description: Compute the new cost index of a given flight. It communicates
with the role PotentialDelayRecoveryProvider (in Flight, PDRP), to get options for speeding up.</p>
</div>


                            <div id="DynamicCostIndexComputer.__init__" class="classattr">
                                        <input id="DynamicCostIndexComputer.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DynamicCostIndexComputer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">agent</span>, </span><span class="param"><span class="n">TA</span><span class="o">=</span><span class="mi">0</span></span>)</span>

                <label class="view-source-button" for="DynamicCostIndexComputer.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.__init__-2691"><a href="#DynamicCostIndexComputer.__init__-2691"><span class="linenos">2691</span></a>	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">TA</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.__init__-2692"><a href="#DynamicCostIndexComputer.__init__-2692"><span class="linenos">2692</span></a>		<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">agent</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.__init__-2693"><a href="#DynamicCostIndexComputer.__init__-2693"><span class="linenos">2693</span></a>
</span><span id="DynamicCostIndexComputer.__init__-2694"><a href="#DynamicCostIndexComputer.__init__-2694"><span class="linenos">2694</span></a>		<span class="k">if</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.__init__-2695"><a href="#DynamicCostIndexComputer.__init__-2695"><span class="linenos">2695</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span>
</span><span id="DynamicCostIndexComputer.__init__-2696"><a href="#DynamicCostIndexComputer.__init__-2696"><span class="linenos">2696</span></a>		<span class="k">elif</span> <span class="n">TA</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.__init__-2697"><a href="#DynamicCostIndexComputer.__init__-2697"><span class="linenos">2697</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA2</span>
</span><span id="DynamicCostIndexComputer.__init__-2698"><a href="#DynamicCostIndexComputer.__init__-2698"><span class="linenos">2698</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.__init__-2699"><a href="#DynamicCostIndexComputer.__init__-2699"><span class="linenos">2699</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA0</span>
</span><span id="DynamicCostIndexComputer.__init__-2700"><a href="#DynamicCostIndexComputer.__init__-2700"><span class="linenos">2700</span></a>
</span><span id="DynamicCostIndexComputer.__init__-2701"><a href="#DynamicCostIndexComputer.__init__-2701"><span class="linenos">2701</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">build_delay_cost_functions_heuristic</span>
</span><span id="DynamicCostIndexComputer.__init__-2702"><a href="#DynamicCostIndexComputer.__init__-2702"><span class="linenos">2702</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">toc_event</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>  <span class="c1"># not used for now (just msgs)</span>
</span></pre></div>


            <div class="docstring"><p>On initialisation of a Role, it gets a pointer to the Agent it belongs to.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.build_delay_cost_functions" class="classattr">
                                <div class="attr variable">
            <span class="name">build_delay_cost_functions</span>

        
    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.build_delay_cost_functions"></a>
    
    

                            </div>
                            <div id="DynamicCostIndexComputer.toc_event" class="classattr">
                                <div class="attr variable">
            <span class="name">toc_event</span>

        
    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.toc_event"></a>
    
    

                            </div>
                            <div id="DynamicCostIndexComputer.request_potential_delay_recovery_info" class="classattr">
                                        <input id="DynamicCostIndexComputer.request_potential_delay_recovery_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_potential_delay_recovery_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.request_potential_delay_recovery_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.request_potential_delay_recovery_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2704"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2704"><span class="linenos">2704</span></a>	<span class="k">def</span> <span class="nf">request_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2705"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2705"><span class="linenos">2705</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2706"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2706"><span class="linenos">2706</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2707"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2707"><span class="linenos">2707</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;potential_delay_recovery_request&#39;</span>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2708"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2708"><span class="linenos">2708</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;use_dci_landing&#39;</span><span class="p">:</span> <span class="n">use_dci_landing</span><span class="p">}</span>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2709"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2709"><span class="linenos">2709</span></a>
</span><span id="DynamicCostIndexComputer.request_potential_delay_recovery_info-2710"><a href="#DynamicCostIndexComputer.request_potential_delay_recovery_info-2710"><span class="linenos">2710</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info" class="classattr">
                                        <input id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_potential_delay_recovery_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2712"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2712"><span class="linenos">2712</span></a>	<span class="k">def</span> <span class="nf">wait_for_potential_delay_recovery_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2713"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2713"><span class="linenos">2713</span></a>		<span class="c1"># dictionary with potential delay recovery info received from a flight</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2714"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2714"><span class="linenos">2714</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2715"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2715"><span class="linenos">2715</span></a>		<span class="n">delay_recovery_info</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;potential_delay_recovery&#39;</span><span class="p">]</span>  <span class="c1"># dictionary</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2716"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2716"><span class="linenos">2716</span></a>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2717"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2717"><span class="linenos">2717</span></a>		<span class="c1"># save dictionary into aoc_delay_recovery_info --&gt; it can be accessed just with flight_uid then</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2718"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2718"><span class="linenos">2718</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay_recovery_info</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2719"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2719"><span class="linenos">2719</span></a>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2720"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2720"><span class="linenos">2720</span></a>		<span class="c1"># TESTING</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2721"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2721"><span class="linenos">2721</span></a>		<span class="c1"># print(&quot;Delay information dictionary for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2722"><a href="#DynamicCostIndexComputer.wait_for_potential_delay_recovery_info-2722"><span class="linenos">2722</span></a>		<span class="c1"># print(self.agent.aoc_delay_recovery_info[flight_uid])</span>
</span></pre></div>


    

                            </div>
                            <div id="DynamicCostIndexComputer.wait_for_toc_reached_message" class="classattr">
                                        <input id="DynamicCostIndexComputer.wait_for_toc_reached_message-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_toc_reached_message</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.wait_for_toc_reached_message-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.wait_for_toc_reached_message"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.wait_for_toc_reached_message-2724"><a href="#DynamicCostIndexComputer.wait_for_toc_reached_message-2724"><span class="linenos">2724</span></a>	<span class="k">def</span> <span class="nf">wait_for_toc_reached_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.wait_for_toc_reached_message-2725"><a href="#DynamicCostIndexComputer.wait_for_toc_reached_message-2725"><span class="linenos">2725</span></a>		<span class="k">pass</span>
</span></pre></div>


    

                            </div>
                            <div id="DynamicCostIndexComputer.cost_index_assessment" class="classattr">
                                        <input id="DynamicCostIndexComputer.cost_index_assessment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cost_index_assessment</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">push_back_ready_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.cost_index_assessment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.cost_index_assessment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.cost_index_assessment-2727"><a href="#DynamicCostIndexComputer.cost_index_assessment-2727"><span class="linenos">2727</span></a>	<span class="k">def</span> <span class="nf">cost_index_assessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_ready_event</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2728"><a href="#DynamicCostIndexComputer.cost_index_assessment-2728"><span class="linenos">2728</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2729"><a href="#DynamicCostIndexComputer.cost_index_assessment-2729"><span class="linenos">2729</span></a><span class="sd">		Decides how the CI assessment is done depending on the level.</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2730"><a href="#DynamicCostIndexComputer.cost_index_assessment-2730"><span class="linenos">2730</span></a><span class="sd">		Level 0: only at pushback ready</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2731"><a href="#DynamicCostIndexComputer.cost_index_assessment-2731"><span class="linenos">2731</span></a><span class="sd">		Level 1: at top of climb (and therefore not needed at pushback ready? Or is it?</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2732"><a href="#DynamicCostIndexComputer.cost_index_assessment-2732"><span class="linenos">2732</span></a><span class="sd">		CHANGE IF TURNS OUT THAT ALSO NEEDED AT PUSHBACK READY.</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2733"><a href="#DynamicCostIndexComputer.cost_index_assessment-2733"><span class="linenos">2733</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2734"><a href="#DynamicCostIndexComputer.cost_index_assessment-2734"><span class="linenos">2734</span></a>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2735"><a href="#DynamicCostIndexComputer.cost_index_assessment-2735"><span class="linenos">2735</span></a>		<span class="c1"># if self.agent.TA == 0:</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2736"><a href="#DynamicCostIndexComputer.cost_index_assessment-2736"><span class="linenos">2736</span></a>		<span class="k">yield</span> <span class="n">push_back_ready_event</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2737"><a href="#DynamicCostIndexComputer.cost_index_assessment-2737"><span class="linenos">2737</span></a>		<span class="c1"># print(&quot;Checking cost index at pushback ready.&quot;)</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2738"><a href="#DynamicCostIndexComputer.cost_index_assessment-2738"><span class="linenos">2738</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2739"><a href="#DynamicCostIndexComputer.cost_index_assessment-2739"><span class="linenos">2739</span></a>		<span class="c1"># else:</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2740"><a href="#DynamicCostIndexComputer.cost_index_assessment-2740"><span class="linenos">2740</span></a>		<span class="c1"># 	#do nothing - wait for top of climb.</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2741"><a href="#DynamicCostIndexComputer.cost_index_assessment-2741"><span class="linenos">2741</span></a>		<span class="c1"># 	#yield self.toc_event</span>
</span><span id="DynamicCostIndexComputer.cost_index_assessment-2742"><a href="#DynamicCostIndexComputer.cost_index_assessment-2742"><span class="linenos">2742</span></a>		<span class="c1"># 	pass</span>
</span></pre></div>


            <div class="docstring"><p>Decides how the CI assessment is done depending on the level.
Level 0: only at pushback ready
Level 1: at top of climb (and therefore not needed at pushback ready? Or is it?
CHANGE IF TURNS OUT THAT ALSO NEEDED AT PUSHBACK READY.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.decide_if_delay_recovery_performed" class="classattr">
                                        <input id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">decide_if_delay_recovery_performed</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">delay</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.decide_if_delay_recovery_performed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2744"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2744"><span class="linenos">2744</span></a>	<span class="k">def</span> <span class="nf">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2745"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2745"><span class="linenos">2745</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2746"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2746"><span class="linenos">2746</span></a><span class="sd">		Probabilistically decide whether the flight is performing delay recovery</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2747"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2747"><span class="linenos">2747</span></a><span class="sd">		for the amount of delay &quot;delay&quot;.</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2748"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2748"><span class="linenos">2748</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2749"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2749"><span class="linenos">2749</span></a>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2750"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2750"><span class="linenos">2750</span></a>		<span class="n">min_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_min_delay</span>  <span class="c1"># gray area: below this value never recover</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2751"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2751"><span class="linenos">2751</span></a>		<span class="n">max_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_max_delay</span>  <span class="c1"># above this value always recover</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2752"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2752"><span class="linenos">2752</span></a>		<span class="n">p_bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">dci_p_bias</span>  <span class="c1"># minimum probability of delay recovery (from min_delay)</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2753"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2753"><span class="linenos">2753</span></a>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2754"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2754"><span class="linenos">2754</span></a>		<span class="c1"># probability of performing delay recovery: p</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2755"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2755"><span class="linenos">2755</span></a>		<span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="n">min_delay</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2756"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2756"><span class="linenos">2756</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># never recover</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2757"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2757"><span class="linenos">2757</span></a>		<span class="k">elif</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">max_delay</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2758"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2758"><span class="linenos">2758</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2759"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2759"><span class="linenos">2759</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2760"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2760"><span class="linenos">2760</span></a>			<span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">max_delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">delay</span> <span class="o">-</span> <span class="n">min_delay</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_bias</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2761"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2761"><span class="linenos">2761</span></a>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2762"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2762"><span class="linenos">2762</span></a>		<span class="c1"># decision on performing delay recovery</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2763"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2763"><span class="linenos">2763</span></a>		<span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2764"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2764"><span class="linenos">2764</span></a>		<span class="n">do_it</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">p</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2765"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2765"><span class="linenos">2765</span></a>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2766"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2766"><span class="linenos">2766</span></a>		<span class="c1"># print(&quot;For the delay &quot;, delay, &quot; this flight is performing delay recovery: &quot;, do_it, &quot; with the probability &quot;, p)</span>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2767"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2767"><span class="linenos">2767</span></a>
</span><span id="DynamicCostIndexComputer.decide_if_delay_recovery_performed-2768"><a href="#DynamicCostIndexComputer.decide_if_delay_recovery_performed-2768"><span class="linenos">2768</span></a>		<span class="k">return</span> <span class="n">do_it</span>
</span></pre></div>


            <div class="docstring"><p>Probabilistically decide whether the flight is performing delay recovery
for the amount of delay "delay".</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.plot_costs_dci" class="classattr">
                                        <input id="DynamicCostIndexComputer.plot_costs_dci-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">plot_costs_dci</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">time</span>, </span><span class="param"><span class="n">fuel</span>, </span><span class="param"><span class="n">x_cont</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.plot_costs_dci-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.plot_costs_dci"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.plot_costs_dci-2770"><a href="#DynamicCostIndexComputer.plot_costs_dci-2770"><span class="linenos">2770</span></a>	<span class="nd">@staticmethod</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2771"><a href="#DynamicCostIndexComputer.plot_costs_dci-2771"><span class="linenos">2771</span></a>	<span class="k">def</span> <span class="nf">plot_costs_dci</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">fuel</span><span class="p">,</span> <span class="n">x_cont</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2772"><a href="#DynamicCostIndexComputer.plot_costs_dci-2772"><span class="linenos">2772</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2773"><a href="#DynamicCostIndexComputer.plot_costs_dci-2773"><span class="linenos">2773</span></a><span class="sd">		If one wants to plot cost functions used to make dci decisions.</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2774"><a href="#DynamicCostIndexComputer.plot_costs_dci-2774"><span class="linenos">2774</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2775"><a href="#DynamicCostIndexComputer.plot_costs_dci-2775"><span class="linenos">2775</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2776"><a href="#DynamicCostIndexComputer.plot_costs_dci-2776"><span class="linenos">2776</span></a>		<span class="c1"># FUEL COST</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2777"><a href="#DynamicCostIndexComputer.plot_costs_dci-2777"><span class="linenos">2777</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2778"><a href="#DynamicCostIndexComputer.plot_costs_dci-2778"><span class="linenos">2778</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">fuel</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2779"><a href="#DynamicCostIndexComputer.plot_costs_dci-2779"><span class="linenos">2779</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Fuel cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2780"><a href="#DynamicCostIndexComputer.plot_costs_dci-2780"><span class="linenos">2780</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2781"><a href="#DynamicCostIndexComputer.plot_costs_dci-2781"><span class="linenos">2781</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2782"><a href="#DynamicCostIndexComputer.plot_costs_dci-2782"><span class="linenos">2782</span></a>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2783"><a href="#DynamicCostIndexComputer.plot_costs_dci-2783"><span class="linenos">2783</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2784"><a href="#DynamicCostIndexComputer.plot_costs_dci-2784"><span class="linenos">2784</span></a>		<span class="c1"># TIME COST</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2785"><a href="#DynamicCostIndexComputer.plot_costs_dci-2785"><span class="linenos">2785</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2786"><a href="#DynamicCostIndexComputer.plot_costs_dci-2786"><span class="linenos">2786</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2787"><a href="#DynamicCostIndexComputer.plot_costs_dci-2787"><span class="linenos">2787</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time cost function (delta_t)&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2788"><a href="#DynamicCostIndexComputer.plot_costs_dci-2788"><span class="linenos">2788</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2789"><a href="#DynamicCostIndexComputer.plot_costs_dci-2789"><span class="linenos">2789</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2790"><a href="#DynamicCostIndexComputer.plot_costs_dci-2790"><span class="linenos">2790</span></a>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2791"><a href="#DynamicCostIndexComputer.plot_costs_dci-2791"><span class="linenos">2791</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2792"><a href="#DynamicCostIndexComputer.plot_costs_dci-2792"><span class="linenos">2792</span></a>		<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2793"><a href="#DynamicCostIndexComputer.plot_costs_dci-2793"><span class="linenos">2793</span></a>		<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2794"><a href="#DynamicCostIndexComputer.plot_costs_dci-2794"><span class="linenos">2794</span></a>		<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">fuel</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2795"><a href="#DynamicCostIndexComputer.plot_costs_dci-2795"><span class="linenos">2795</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_cont</span><span class="p">,</span> <span class="n">total_cost</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2796"><a href="#DynamicCostIndexComputer.plot_costs_dci-2796"><span class="linenos">2796</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Total cost function (delta_t): time + fuel&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2797"><a href="#DynamicCostIndexComputer.plot_costs_dci-2797"><span class="linenos">2797</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.plot_costs_dci-2798"><a href="#DynamicCostIndexComputer.plot_costs_dci-2798"><span class="linenos">2798</span></a>		<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>If one wants to plot cost functions used to make dci decisions.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old" class="classattr">
                                        <input id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_dci_l1_old</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">diff</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2800"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2800"><span class="linenos">2800</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2801"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2801"><span class="linenos">2801</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2802"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2802"><span class="linenos">2802</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2803"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2803"><span class="linenos">2803</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2804"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2804"><span class="linenos">2804</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2805"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2805"><span class="linenos">2805</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2806"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2806"><span class="linenos">2806</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2807"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2807"><span class="linenos">2807</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2808"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2808"><span class="linenos">2808</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2809"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2809"><span class="linenos">2809</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2810"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2810"><span class="linenos">2810</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2811"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2811"><span class="linenos">2811</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2812"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2812"><span class="linenos">2812</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2813"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2813"><span class="linenos">2813</span></a>			<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2814"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2814"><span class="linenos">2814</span></a>				<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2815"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2815"><span class="linenos">2815</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2816"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2816"><span class="linenos">2816</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2817"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2817"><span class="linenos">2817</span></a><span class="sd">				if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2818"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2818"><span class="linenos">2818</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2819"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2819"><span class="linenos">2819</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2820"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2820"><span class="linenos">2820</span></a><span class="sd">				if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2821"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2821"><span class="linenos">2821</span></a><span class="sd">					x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2822"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2822"><span class="linenos">2822</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2823"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2823"><span class="linenos">2823</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2824"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2824"><span class="linenos">2824</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2825"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2825"><span class="linenos">2825</span></a>									<span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2826"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2826"><span class="linenos">2826</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2827"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2827"><span class="linenos">2827</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2828"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2828"><span class="linenos">2828</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2829"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2829"><span class="linenos">2829</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2830"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2830"><span class="linenos">2830</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2831"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2831"><span class="linenos">2831</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2832"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2832"><span class="linenos">2832</span></a>			<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2833"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2833"><span class="linenos">2833</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2834"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2834"><span class="linenos">2834</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2835"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2835"><span class="linenos">2835</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2836"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2836"><span class="linenos">2836</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2837"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2837"><span class="linenos">2837</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2838"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2838"><span class="linenos">2838</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2839"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2839"><span class="linenos">2839</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2840"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2840"><span class="linenos">2840</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2841"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2841"><span class="linenos">2841</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2842"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2842"><span class="linenos">2842</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2843"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2843"><span class="linenos">2843</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2844"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2844"><span class="linenos">2844</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2845"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2845"><span class="linenos">2845</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2846"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2846"><span class="linenos">2846</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2847"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2847"><span class="linenos">2847</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2848"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2848"><span class="linenos">2848</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2849"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2849"><span class="linenos">2849</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2850"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2850"><span class="linenos">2850</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2851"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2851"><span class="linenos">2851</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2852"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2852"><span class="linenos">2852</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2853"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2853"><span class="linenos">2853</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2854"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2854"><span class="linenos">2854</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2855"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2855"><span class="linenos">2855</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2856"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2856"><span class="linenos">2856</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2857"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2857"><span class="linenos">2857</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2858"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2858"><span class="linenos">2858</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2859"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2859"><span class="linenos">2859</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2860"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2860"><span class="linenos">2860</span></a>			<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2861"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2861"><span class="linenos">2861</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2862"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2862"><span class="linenos">2862</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2863"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2863"><span class="linenos">2863</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2864"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2864"><span class="linenos">2864</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2865"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2865"><span class="linenos">2865</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2866"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2866"><span class="linenos">2866</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2867"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2867"><span class="linenos">2867</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2868"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2868"><span class="linenos">2868</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2869"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2869"><span class="linenos">2869</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2870"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2870"><span class="linenos">2870</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2871"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2871"><span class="linenos">2871</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2872"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2872"><span class="linenos">2872</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2873"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2873"><span class="linenos">2873</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2874"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2874"><span class="linenos">2874</span></a>			<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2875"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2875"><span class="linenos">2875</span></a>				<span class="n">cost_np0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2876"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2876"><span class="linenos">2876</span></a>									<span class="n">x0</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2877"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2877"><span class="linenos">2877</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2878"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2878"><span class="linenos">2878</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2879"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2879"><span class="linenos">2879</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2880"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2880"><span class="linenos">2880</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2881"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2881"><span class="linenos">2881</span></a>				<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2882"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2882"><span class="linenos">2882</span></a>				<span class="n">cost_soft_cost0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2883"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2883"><span class="linenos">2883</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2884"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2884"><span class="linenos">2884</span></a>				<span class="c1"># DOC</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2885"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2885"><span class="linenos">2885</span></a>				<span class="c1"># cost_doc0 = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2886"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2886"><span class="linenos">2886</span></a>				<span class="n">cost_doc0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2887"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2887"><span class="linenos">2887</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2888"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2888"><span class="linenos">2888</span></a>				<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2889"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2889"><span class="linenos">2889</span></a>				<span class="n">cost_compensation0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2890"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2890"><span class="linenos">2890</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2891"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2891"><span class="linenos">2891</span></a>				<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2892"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2892"><span class="linenos">2892</span></a>				<span class="n">cost_transfer0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2893"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2893"><span class="linenos">2893</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2894"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2894"><span class="linenos">2894</span></a>				<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2895"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2895"><span class="linenos">2895</span></a>				<span class="k">if</span> <span class="n">delay</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2896"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2896"><span class="linenos">2896</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2897"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2897"><span class="linenos">2897</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2898"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2898"><span class="linenos">2898</span></a>					<span class="n">cost_curfew0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2899"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2899"><span class="linenos">2899</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2900"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2900"><span class="linenos">2900</span></a>				<span class="n">cost0</span> <span class="o">=</span> <span class="n">cost_np0</span> <span class="o">+</span> <span class="n">cost_soft_cost0</span> <span class="o">+</span> <span class="n">cost_doc0</span> <span class="o">+</span> <span class="n">cost_compensation0</span> <span class="o">+</span> <span class="n">cost_transfer0</span> <span class="o">+</span> <span class="n">cost_curfew0</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2901"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2901"><span class="linenos">2901</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2902"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2902"><span class="linenos">2902</span></a>				<span class="k">return</span> <span class="n">cost</span> <span class="o">-</span> <span class="n">cost0</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2903"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2903"><span class="linenos">2903</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2904"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2904"><span class="linenos">2904</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2905"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2905"><span class="linenos">2905</span></a>				<span class="k">return</span> <span class="n">cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2906"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2906"><span class="linenos">2906</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2907"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1_old-2907"><span class="linenos">2907</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>A (slightly) modified build_delay_cost_functions_heuristic fnc to
fit the dci needs.</p>

<p>default options for diff = True for dci.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1" class="classattr">
                                        <input id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">build_delay_cost_functions_dci_l1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">diff</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2909"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2909"><span class="linenos">2909</span></a>	<span class="k">def</span> <span class="nf">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2910"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2910"><span class="linenos">2910</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2911"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2911"><span class="linenos">2911</span></a><span class="sd">		A (slightly) modified build_delay_cost_functions_heuristic fnc to</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2912"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2912"><span class="linenos">2912</span></a><span class="sd">		fit the dci needs.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2913"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2913"><span class="linenos">2913</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2914"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2914"><span class="linenos">2914</span></a><span class="sd">		default options for diff = True for dci.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2915"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2915"><span class="linenos">2915</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2916"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2916"><span class="linenos">2916</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2917"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2917"><span class="linenos">2917</span></a>		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2918"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2918"><span class="linenos">2918</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2919"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2919"><span class="linenos">2919</span></a>		<span class="k">if</span> <span class="n">up_to_date_baseline</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2920"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2920"><span class="linenos">2920</span></a>			<span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2921"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2921"><span class="linenos">2921</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2922"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2922"><span class="linenos">2922</span></a><span class="sd">		else:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2923"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2923"><span class="linenos">2923</span></a><span class="sd">			if (&#39;non_atfm_delay&#39; in factor_in) and (&#39;delay_non_atfm&#39; in self.agent.aoc_flights_info[flight_uid].keys()):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2924"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2924"><span class="linenos">2924</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;delay_non_atfm&#39;]</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2925"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2925"><span class="linenos">2925</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2926"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2926"><span class="linenos">2926</span></a><span class="sd">			if (&#39;atfm_delay&#39; in factor_in) and self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].has_atfm_delay():</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2927"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2927"><span class="linenos">2927</span></a><span class="sd">				x0 += self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay.atfm_delay</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2928"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2928"><span class="linenos">2928</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2929"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2929"><span class="linenos">2929</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2930"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2930"><span class="linenos">2930</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>  <span class="c1"># here I need pax that are on board already</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2931"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2931"><span class="linenos">2931</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2932"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2932"><span class="linenos">2932</span></a>		<span class="n">buf</span><span class="p">,</span> <span class="n">flight_uid_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_curfew_buffer</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2933"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2933"><span class="linenos">2933</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2934"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2934"><span class="linenos">2934</span></a>		<span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2935"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2935"><span class="linenos">2935</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2936"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2936"><span class="linenos">2936</span></a>			<span class="n">cost_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2937"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2937"><span class="linenos">2937</span></a>									<span class="n">X</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2938"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2938"><span class="linenos">2938</span></a>									<span class="s1">&#39;airborne&#39;</span><span class="p">)</span>  <span class="c1"># here I account for airborne delay</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2939"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2939"><span class="linenos">2939</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2940"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2940"><span class="linenos">2940</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2941"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2941"><span class="linenos">2941</span></a>			<span class="n">delay</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">heuristic_knock_on_factor</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2942"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2942"><span class="linenos">2942</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2943"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2943"><span class="linenos">2943</span></a>			<span class="c1"># Soft cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2944"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2944"><span class="linenos">2944</span></a>			<span class="n">cost_soft_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2945"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2945"><span class="linenos">2945</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2946"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2946"><span class="linenos">2946</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2947"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2947"><span class="linenos">2947</span></a><span class="sd">			# DOC does not apply for the passenger who are on this flight as it is already flying.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2948"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2948"><span class="linenos">2948</span></a><span class="sd">			It does apply on the passengers scheduled on the next flight using the same aircraft,</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2949"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2949"><span class="linenos">2949</span></a><span class="sd">			but that should be taken into account through the heuristic knock on factor.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2950"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2950"><span class="linenos">2950</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2951"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2951"><span class="linenos">2951</span></a><span class="sd">			In future, DOC could be calculated explicitly for the next rotation</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2952"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2952"><span class="linenos">2952</span></a><span class="sd">			using total number of pax on the next flight with that aircraft and expected delay.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2953"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2953"><span class="linenos">2953</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2954"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2954"><span class="linenos">2954</span></a><span class="sd">			# DOC: applies to passengers who are going to the next aircraft rotation flight</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2955"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2955"><span class="linenos">2955</span></a><span class="sd">			# get next flight that is using this aircraft</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2956"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2956"><span class="linenos">2956</span></a><span class="sd">			ac_next_flight_uid = self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].get_next_flight()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2957"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2957"><span class="linenos">2957</span></a><span class="sd">			print(&quot;Next flight using aircraft &quot;, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;], &quot; is &quot;, ac_next_flight_uid)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2958"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2958"><span class="linenos">2958</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2959"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2959"><span class="linenos">2959</span></a><span class="sd">			if ac_next_flight_uid is not None:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2960"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2960"><span class="linenos">2960</span></a><span class="sd">				#print(&quot; Next flight with this aircraft is &quot;, self.agent.aoc_flights_info[ac_next_flight_uid][&#39;FP&#39;].unique_id)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2961"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2961"><span class="linenos">2961</span></a><span class="sd">				paxs_next_flight = self.agent.aoc_flights_info[ac_next_flight_uid][&#39;pax_to_board&#39;] #should be the same AOC agent (same aircraft, so..)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2962"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2962"><span class="linenos">2962</span></a><span class="sd">				#print(&quot;Paxs on board of the next flight: &quot;, paxs_next_flight)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2963"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2963"><span class="linenos">2963</span></a><span class="sd">			else:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2964"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2964"><span class="linenos">2964</span></a><span class="sd">				#print(&quot;No next flight.&quot;)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2965"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2965"><span class="linenos">2965</span></a><span class="sd">				paxs_next_flight = []</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2966"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2966"><span class="linenos">2966</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2967"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2967"><span class="linenos">2967</span></a><span class="sd">			cost_doc = np.array([self.agent.duty_of_care(pax, delay) for pax in paxs_next_flight]).sum()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2968"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2968"><span class="linenos">2968</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2969"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2969"><span class="linenos">2969</span></a>			<span class="n">cost_doc</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2970"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2970"><span class="linenos">2970</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2971"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2971"><span class="linenos">2971</span></a>			<span class="c1"># Compensation</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2972"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2972"><span class="linenos">2972</span></a>			<span class="n">cost_compensation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2973"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2973"><span class="linenos">2973</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2974"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2974"><span class="linenos">2974</span></a>			<span class="c1"># transfer_cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2975"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2975"><span class="linenos">2975</span></a>			<span class="n">cost_transfer</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2976"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2976"><span class="linenos">2976</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2977"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2977"><span class="linenos">2977</span></a>			<span class="c1"># Curfew costs</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2978"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2978"><span class="linenos">2978</span></a>			<span class="k">if</span> <span class="n">X</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2979"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2979"><span class="linenos">2979</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cost_non_pax_curfew</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">estimate_pax_curfew_cost</span><span class="p">(</span><span class="n">flight_uid_curfew</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2980"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2980"><span class="linenos">2980</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2981"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2981"><span class="linenos">2981</span></a>				<span class="n">cost_curfew</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2982"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2982"><span class="linenos">2982</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2983"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2983"><span class="linenos">2983</span></a>			<span class="n">cost</span> <span class="o">=</span> <span class="n">cost_np</span> <span class="o">+</span> <span class="n">cost_soft_cost</span> <span class="o">+</span> <span class="n">cost_doc</span> <span class="o">+</span> <span class="n">cost_compensation</span> <span class="o">+</span> <span class="n">cost_transfer</span> <span class="o">+</span> <span class="n">cost_curfew</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2984"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2984"><span class="linenos">2984</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2985"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2985"><span class="linenos">2985</span></a>			<span class="k">return</span> <span class="n">cost</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2986"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2986"><span class="linenos">2986</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2987"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2987"><span class="linenos">2987</span></a>		<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2988"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2988"><span class="linenos">2988</span></a>			<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cost_computing_dci_l1&#39;</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2989"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2989"><span class="linenos">2989</span></a>				<span class="k">if</span> <span class="n">diff</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2990"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2990"><span class="linenos">2990</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2991"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2991"><span class="linenos">2991</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2992"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2992"><span class="linenos">2992</span></a>					<span class="k">return</span> <span class="n">_f</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2993"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2993"><span class="linenos">2993</span></a>
</span><span id="DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2994"><a href="#DynamicCostIndexComputer.build_delay_cost_functions_dci_l1-2994"><span class="linenos">2994</span></a>		<span class="k">return</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>A (slightly) modified build_delay_cost_functions_heuristic fnc to
fit the dci needs.</p>

<p>default options for diff = True for dci.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.reassess_cost_index_TA0" class="classattr">
                                        <input id="DynamicCostIndexComputer.reassess_cost_index_TA0-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reassess_cost_index_TA0</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.reassess_cost_index_TA0-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.reassess_cost_index_TA0"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-2996"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-2996"><span class="linenos">2996</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-2997"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-2997"><span class="linenos">2997</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-2998"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-2998"><span class="linenos">2998</span></a><span class="sd">		RULE OF THUMB FOR LEVEL 0:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-2999"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-2999"><span class="linenos">2999</span></a><span class="sd">			The cost index is assessed only pre-departure (at pushback_ready), there is no dynamic changing (DCI).</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3000"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3000"><span class="linenos">3000</span></a><span class="sd">			Departure delays greater than 60 minutes always try to be amortised. Lower than 15 - never.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3001"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3001"><span class="linenos">3001</span></a><span class="sd">			If between, probabilistic decision is made according to a linear prob. distribution (from 20% at 15 mins).</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3002"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3002"><span class="linenos">3002</span></a><span class="sd">			As a general rule, we try to reduce the delay as much as possible to 5 minutes.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3003"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3003"><span class="linenos">3003</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3004"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3004"><span class="linenos">3004</span></a><span class="sd">			Therefore, if enough fuel - reduce delay to 5 minutes. If not enough fuel to reduce to 5,</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3005"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3005"><span class="linenos">3005</span></a><span class="sd">			use max_fuel to achieve maximum possible delay reduction.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3006"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3006"><span class="linenos">3006</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3007"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3007"><span class="linenos">3007</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3008"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3008"><span class="linenos">3008</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3009"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3009"><span class="linenos">3009</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 0 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3010"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3010"><span class="linenos">3010</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3011"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3011"><span class="linenos">3011</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3012"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3012"><span class="linenos">3012</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3013"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3013"><span class="linenos">3013</span></a>		<span class="c1"># retrieve cost dictionary for the flight provided by pdrp</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3014"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3014"><span class="linenos">3014</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3015"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3015"><span class="linenos">3015</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3016"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3016"><span class="linenos">3016</span></a>		<span class="c1"># init - needed if not speed change is going to occur, for saving to DB</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3017"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3017"><span class="linenos">3017</span></a>		<span class="n">dep_delay</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3018"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3018"><span class="linenos">3018</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3019"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3019"><span class="linenos">3019</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3020"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3020"><span class="linenos">3020</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3021"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3021"><span class="linenos">3021</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3022"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3022"><span class="linenos">3022</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3023"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3023"><span class="linenos">3023</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3024"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3024"><span class="linenos">3024</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3025"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3025"><span class="linenos">3025</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3026"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3026"><span class="linenos">3026</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3027"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3027"><span class="linenos">3027</span></a>		<span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3028"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3028"><span class="linenos">3028</span></a>			<span class="c1"># We can change the speed</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3029"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3029"><span class="linenos">3029</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;We can change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;before departure.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3030"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3030"><span class="linenos">3030</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3031"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3031"><span class="linenos">3031</span></a>			<span class="c1"># check departure delay at pushback ready</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3032"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3032"><span class="linenos">3032</span></a>			<span class="n">dep_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">eobt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sobt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3033"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3033"><span class="linenos">3033</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3034"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3034"><span class="linenos">3034</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decide_if_delay_recovery_performed</span><span class="p">(</span><span class="n">dep_delay</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3035"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3035"><span class="linenos">3035</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3036"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3036"><span class="linenos">3036</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3037"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3037"><span class="linenos">3037</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">dep_delay</span> <span class="o">-</span> <span class="mi">5</span>  <span class="c1"># 5 minutes delay never recovered. delta_t is now the time a flight would like to recover.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3038"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3038"><span class="linenos">3038</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3039"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3039"><span class="linenos">3039</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>  <span class="c1"># if what I want to recover is larger than max time I can recover</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3040"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3040"><span class="linenos">3040</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># then recover maximum time possible</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3041"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3041"><span class="linenos">3041</span></a>				<span class="c1"># otherwise recover full delta_t. delta_t is now true time I can and want to recover with the fuel I have</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3042"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3042"><span class="linenos">3042</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3043"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3043"><span class="linenos">3043</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># delta_t is now the max time a flight can recover (it&#39;s negative now!)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3044"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3044"><span class="linenos">3044</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3045"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3045"><span class="linenos">3045</span></a>				<span class="c1"># delta_t CAN STILL CHANGE due to the fact we limit perc_selected to 0.9</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3046"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3046"><span class="linenos">3046</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)))),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># new speed capped at 0.9*nominal</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3047"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3047"><span class="linenos">3047</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3048"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3048"><span class="linenos">3048</span></a>				<span class="k">if</span> <span class="n">perc_selected</span> <span class="o">==</span> <span class="mf">0.9</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3049"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3049"><span class="linenos">3049</span></a>					<span class="c1"># use triangle similarity to find REAL delta_t</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3050"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3050"><span class="linenos">3050</span></a>					<span class="n">p1_time</span> <span class="o">=</span> <span class="n">delta_t</span><span class="o">-</span><span class="mi">10</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3051"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3051"><span class="linenos">3051</span></a>					<span class="n">p1</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">p1_time</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3052"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3052"><span class="linenos">3052</span></a>					<span class="n">p2</span> <span class="o">=</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3053"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3053"><span class="linenos">3053</span></a>					<span class="n">real_delta_t</span> <span class="o">=</span> <span class="p">((</span><span class="n">p2</span> <span class="o">-</span> <span class="mf">0.9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">p1_time</span> <span class="o">-</span> <span class="n">delta_t</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">p2</span><span class="o">-</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_t</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3054"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3054"><span class="linenos">3054</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">real_delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3055"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3055"><span class="linenos">3055</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3056"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3056"><span class="linenos">3056</span></a>				<span class="c1"># If after checking with the fuel function, a flight cannot recover more than 5 minutes, do not recover anything</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3057"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3057"><span class="linenos">3057</span></a>				<span class="c1"># AND limit the usage of extra fuel to self.agent.max_extra_fuel_used percent of extra_fuel_available</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3058"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3058"><span class="linenos">3058</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># the extra fuel needed to recover delta_t</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3059"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3059"><span class="linenos">3059</span></a>				<span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta_t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dfuel</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">max_extra_fuel_used</span> <span class="o">*</span> <span class="n">extra_fuel_available</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3060"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3060"><span class="linenos">3060</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3061"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3061"><span class="linenos">3061</span></a>					<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3062"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3062"><span class="linenos">3062</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3063"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3063"><span class="linenos">3063</span></a>					<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3064"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3064"><span class="linenos">3064</span></a>					<span class="c1"># 	print(&quot;Recovering delay of &quot;, delta_t, &quot;minutes, with % of fuel &quot;, round(dfuel/extra_fuel_available*100, 2))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3065"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3065"><span class="linenos">3065</span></a>					<span class="c1"># 	print(&quot;I got a perc from tfsc: &quot;, tfsc[&#39;perc_variation_func&#39;](delta_t))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3066"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3066"><span class="linenos">3066</span></a>					<span class="c1"># 	print(&quot;Flight &quot;, flight_uid, &quot;is deciding to speed up with selected perc &quot;, perc_selected*100)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3067"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3067"><span class="linenos">3067</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3068"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3068"><span class="linenos">3068</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3069"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3069"><span class="linenos">3069</span></a>						   <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; before take-off. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3070"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3070"><span class="linenos">3070</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3071"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3071"><span class="linenos">3071</span></a>					<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3072"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3072"><span class="linenos">3072</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3073"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3073"><span class="linenos">3073</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3074"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3074"><span class="linenos">3074</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3075"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3075"><span class="linenos">3075</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3076"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3076"><span class="linenos">3076</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3077"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3077"><span class="linenos">3077</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pushback_ready&#39;</span><span class="p">,</span> <span class="n">dep_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA0-3078"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA0-3078"><span class="linenos">3078</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>RULE OF THUMB FOR LEVEL 0:
        The cost index is assessed only pre-departure (at pushback_ready), there is no dynamic changing (DCI).
        Departure delays greater than 60 minutes always try to be amortised. Lower than 15 - never.
        If between, probabilistic decision is made according to a linear prob. distribution (from 20% at 15 mins).
        As a general rule, we try to reduce the delay as much as possible to 5 minutes.</p>

<pre><code>    Therefore, if enough fuel - reduce delay to 5 minutes. If not enough fuel to reduce to 5,
    use max_fuel to achieve maximum possible delay reduction.
</code></pre>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.reassess_cost_index_TA1" class="classattr">
                                        <input id="DynamicCostIndexComputer.reassess_cost_index_TA1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reassess_cost_index_TA1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.reassess_cost_index_TA1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.reassess_cost_index_TA1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3080"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3080"><span class="linenos">3080</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3081"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3081"><span class="linenos">3081</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3082"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3082"><span class="linenos">3082</span></a><span class="sd">		On level 1, the first time CI is assessed is at top of the climb.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3083"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3083"><span class="linenos">3083</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3084"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3084"><span class="linenos">3084</span></a><span class="sd">		From deliverable: Dynamic cost indexing for flights, with a simplified in-flight delay and</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3085"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3085"><span class="linenos">3085</span></a><span class="sd">		cost estimation based on heuristics and general cost of delay rules.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3086"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3086"><span class="linenos">3086</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3087"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3087"><span class="linenos">3087</span></a><span class="sd">		At TOC: Estimate times I can recover and fuel needed. Compute time and fuel costs, and choose</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3088"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3088"><span class="linenos">3088</span></a><span class="sd">		the cheapest option.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3089"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3089"><span class="linenos">3089</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3090"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3090"><span class="linenos">3090</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3091"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3091"><span class="linenos">3091</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3092"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3092"><span class="linenos">3092</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3093"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3093"><span class="linenos">3093</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3094"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3094"><span class="linenos">3094</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3095"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3095"><span class="linenos">3095</span></a>		<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3096"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3096"><span class="linenos">3096</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3097"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3097"><span class="linenos">3097</span></a>		<span class="n">estimated_delay</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># fill with exp_arr_delay when estimation is done</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3098"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3098"><span class="linenos">3098</span></a>		<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3099"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3099"><span class="linenos">3099</span></a>		<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3100"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3100"><span class="linenos">3100</span></a>		<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3101"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3101"><span class="linenos">3101</span></a>		<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3102"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3102"><span class="linenos">3102</span></a>		<span class="k">if</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3103"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3103"><span class="linenos">3103</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3104"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3104"><span class="linenos">3104</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3105"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3105"><span class="linenos">3105</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3106"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3106"><span class="linenos">3106</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3107"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3107"><span class="linenos">3107</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3108"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3108"><span class="linenos">3108</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to change the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3109"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3109"><span class="linenos">3109</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3110"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3110"><span class="linenos">3110</span></a>			<span class="c1"># Assess expected arrival delay at TOC</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3111"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3111"><span class="linenos">3111</span></a>			<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3112"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3112"><span class="linenos">3112</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3113"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3113"><span class="linenos">3113</span></a>			<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3114"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3114"><span class="linenos">3114</span></a>			<span class="n">estimated_delay</span> <span class="o">=</span> <span class="n">exp_arr_delay</span>  <span class="c1"># for saving</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3115"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3115"><span class="linenos">3115</span></a>			<span class="c1"># print(&quot;Expected arrival delay is &quot;, exp_arr_delay)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3116"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3116"><span class="linenos">3116</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;estimates at TOC that the expected arrival delay is&quot;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="s2">&quot; minutes.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3117"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3117"><span class="linenos">3117</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3118"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3118"><span class="linenos">3118</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3119"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3119"><span class="linenos">3119</span></a>			<span class="c1"># FUEL COST</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3120"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3120"><span class="linenos">3120</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3121"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3121"><span class="linenos">3121</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3122"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3122"><span class="linenos">3122</span></a><span class="sd">			x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3123"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3123"><span class="linenos">3123</span></a><span class="sd">			plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3124"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3124"><span class="linenos">3124</span></a><span class="sd">			plt.show()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3125"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3125"><span class="linenos">3125</span></a><span class="sd">			plt.clf()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3126"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3126"><span class="linenos">3126</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3127"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3127"><span class="linenos">3127</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3128"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3128"><span class="linenos">3128</span></a>			<span class="n">fuel_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">fuel_price</span> <span class="o">*</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3129"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3129"><span class="linenos">3129</span></a>			<span class="n">x_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">])),</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3130"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3130"><span class="linenos">3130</span></a>			<span class="n">fuel_cost</span> <span class="o">=</span> <span class="n">fuel_cost_func</span><span class="p">(</span><span class="o">-</span><span class="n">x_cont</span><span class="p">)</span>  <span class="c1"># for recovering -fuel cost needs negative values</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3131"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3131"><span class="linenos">3131</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3132"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3132"><span class="linenos">3132</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3133"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3133"><span class="linenos">3133</span></a>			<span class="c1"># TIME COST</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3134"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3134"><span class="linenos">3134</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3135"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3135"><span class="linenos">3135</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3136"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3136"><span class="linenos">3136</span></a><span class="sd">			ABOUT TIME COST FUNCTION</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3137"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3137"><span class="linenos">3137</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3138"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3138"><span class="linenos">3138</span></a><span class="sd">			Time cost function is a function of the recovered delay, i.e. on x-axis we have</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3139"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3139"><span class="linenos">3139</span></a><span class="sd">			minutes of delay a flight decides to recover by speeding up.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3140"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3140"><span class="linenos">3140</span></a><span class="sd">			E.g. Let&#39;s say a flight, at TOC, estimates arrival delay of 20 minutes</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3141"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3141"><span class="linenos">3141</span></a><span class="sd">			and decides to recover 3 minutes. time_cost(3) is the cost  when the flight decides to speed up</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3142"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3142"><span class="linenos">3142</span></a><span class="sd">			so to recover 3 minutes, so it is the cost of the 17 minutes delay that is left.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3143"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3143"><span class="linenos">3143</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3144"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3144"><span class="linenos">3144</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3145"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3145"><span class="linenos">3145</span></a>			<span class="n">time_cost_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_delay_cost_functions_dci_l1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">up_to_date_baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3146"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3146"><span class="linenos">3146</span></a>			<span class="n">time_cost</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_cost_func</span><span class="p">(</span><span class="n">exp_arr_delay</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_cont</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3147"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3147"><span class="linenos">3147</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3148"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3148"><span class="linenos">3148</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3149"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3149"><span class="linenos">3149</span></a>			<span class="c1"># SUM: FUEL COST + TIME COST, on domain of expected delay</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3150"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3150"><span class="linenos">3150</span></a>			<span class="c1">#####################</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3151"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3151"><span class="linenos">3151</span></a>			<span class="n">total_cost</span> <span class="o">=</span> <span class="n">time_cost</span> <span class="o">+</span> <span class="n">fuel_cost</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3152"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3152"><span class="linenos">3152</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3153"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3153"><span class="linenos">3153</span></a>			<span class="n">delay_to_recover</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">x_cont</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">total_cost</span><span class="p">)])</span>  <span class="c1"># recover with a resolution of one minute</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3154"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3154"><span class="linenos">3154</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3155"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3155"><span class="linenos">3155</span></a>			<span class="c1"># print(flight_str(flight_uid), &quot; decides to recover &quot;, delay_to_recover, &quot; minutes.&quot;)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3156"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3156"><span class="linenos">3156</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3157"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3157"><span class="linenos">3157</span></a><span class="w">			</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3158"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3158"><span class="linenos">3158</span></a><span class="sd">			#### PLOT THE COST FUNCs - uncomment for plotting costs when flight recovers some delay</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3159"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3159"><span class="linenos">3159</span></a><span class="sd">			if delay_to_recover &gt; 0:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3160"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3160"><span class="linenos">3160</span></a><span class="sd">				self.plot_costs_dci(time_cost, fuel_cost, x_cont)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3161"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3161"><span class="linenos">3161</span></a><span class="sd">			&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3162"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3162"><span class="linenos">3162</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3163"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3163"><span class="linenos">3163</span></a>			<span class="n">perform_delay_recovery</span> <span class="o">=</span> <span class="n">delay_to_recover</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3164"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3164"><span class="linenos">3164</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3165"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3165"><span class="linenos">3165</span></a>			<span class="k">if</span> <span class="n">perform_delay_recovery</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3166"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3166"><span class="linenos">3166</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="n">delay_to_recover</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3167"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3167"><span class="linenos">3167</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3168"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3168"><span class="linenos">3168</span></a>				<span class="k">if</span> <span class="n">delta_t</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">]):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3169"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3169"><span class="linenos">3169</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;min_time_w_fuel&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3170"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3170"><span class="linenos">3170</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3171"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3171"><span class="linenos">3171</span></a>					<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3172"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3172"><span class="linenos">3172</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3173"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3173"><span class="linenos">3173</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3174"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3174"><span class="linenos">3174</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot;is deciding to speed up with selected perc &quot;, perc_selected)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3175"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3175"><span class="linenos">3175</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3176"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3176"><span class="linenos">3176</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3177"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3177"><span class="linenos">3177</span></a>				<span class="c1"># print(&quot;The price of the extra fuel &quot;, dfuel, &quot; is &quot;, dfuel * self.agent.fuel_price, &quot; with fuel price set to &quot;, self.agent.fuel_price)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3178"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3178"><span class="linenos">3178</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3179"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3179"><span class="linenos">3179</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; absorbing &quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot; minutes of delay by changing speed to &quot;</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="s2">&quot; at top of climb. Using &quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg extra fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3180"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3180"><span class="linenos">3180</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3181"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3181"><span class="linenos">3181</span></a>				<span class="c1"># send msg to flight plan updater to update speed</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3182"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3182"><span class="linenos">3182</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3183"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3183"><span class="linenos">3183</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3184"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3184"><span class="linenos">3184</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage &quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3185"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3185"><span class="linenos">3185</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3186"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3186"><span class="linenos">3186</span></a>		<span class="c1"># save the dci decision info</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3187"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3187"><span class="linenos">3187</span></a>		<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb&#39;</span><span class="p">,</span> <span class="n">estimated_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3188"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3188"><span class="linenos">3188</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA1-3189"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA1-3189"><span class="linenos">3189</span></a>		<span class="c1"># print(&quot;Reassessment of  cost index FINISHED for&quot;, flight_str(flight_uid))</span>
</span></pre></div>


            <div class="docstring"><p>On level 1, the first time CI is assessed is at top of the climb.</p>

<p>From deliverable: Dynamic cost indexing for flights, with a simplified in-flight delay and
cost estimation based on heuristics and general cost of delay rules.</p>

<p>At TOC: Estimate times I can recover and fuel needed. Compute time and fuel costs, and choose
the cheapest option.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.reassess_cost_index_TA2" class="classattr">
                                        <input id="DynamicCostIndexComputer.reassess_cost_index_TA2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reassess_cost_index_TA2</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.reassess_cost_index_TA2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.reassess_cost_index_TA2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3191"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3191"><span class="linenos">3191</span></a>	<span class="k">def</span> <span class="nf">reassess_cost_index_TA2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3192"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3192"><span class="linenos">3192</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 2 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3193"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3193"><span class="linenos">3193</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3194"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3194"><span class="linenos">3194</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3195"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3195"><span class="linenos">3195</span></a><span class="sd">		Doing the same as on level 1, but allowing to slow down if estimated arrival</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3196"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3196"><span class="linenos">3196</span></a><span class="sd">		more than 15 minutes earlier than scheduled. Slow down to 15 minutes.</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3197"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3197"><span class="linenos">3197</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3198"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3198"><span class="linenos">3198</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3199"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3199"><span class="linenos">3199</span></a>		<span class="c1"># print(&quot;Reassessing cost index on level 1 for&quot;, flight_str(flight_uid))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3200"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3200"><span class="linenos">3200</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is assessing the cost index at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3201"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3201"><span class="linenos">3201</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3202"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3202"><span class="linenos">3202</span></a>		<span class="n">current_eibt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_current_eibt</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3203"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3203"><span class="linenos">3203</span></a>		<span class="n">exp_arr_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">current_eibt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sibt</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># allow it to be negative to detect early arrivals</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3204"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3204"><span class="linenos">3204</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3205"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3205"><span class="linenos">3205</span></a>		<span class="k">if</span> <span class="n">exp_arr_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3206"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3206"><span class="linenos">3206</span></a>			<span class="c1"># do the same as on level 1: try to speed up further</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3207"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3207"><span class="linenos">3207</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">reassess_cost_index_TA1</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3208"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3208"><span class="linenos">3208</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3209"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3209"><span class="linenos">3209</span></a>		<span class="k">elif</span> <span class="n">exp_arr_delay</span> <span class="o">&lt;=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span><span class="p">:</span> <span class="c1"># default -30, arriving more than 30 minutes earlier than planned</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3210"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3210"><span class="linenos">3210</span></a>			<span class="c1"># print(&quot;Flight &quot;, flight_uid ,&quot; expects to arrive &quot;, abs(exp_arr_delay), &quot; minutes earlier than scheduled.&quot;)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3211"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3211"><span class="linenos">3211</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;Flight &quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot; expects to arrive &quot;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">),</span> <span class="s2">&quot; minutes earlier than scheduled.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3212"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3212"><span class="linenos">3212</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3213"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3213"><span class="linenos">3213</span></a>			<span class="c1"># add add_mins minutes to the flight</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3214"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3214"><span class="linenos">3214</span></a>			<span class="n">add_mins</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">exp_arr_delay</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">slow_down_th</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3215"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3215"><span class="linenos">3215</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_potential_delay_recovery_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">use_dci_landing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3216"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3216"><span class="linenos">3216</span></a>			<span class="n">tfsc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_delay_recovery_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3217"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3217"><span class="linenos">3217</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3218"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3218"><span class="linenos">3218</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3219"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3219"><span class="linenos">3219</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3220"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3220"><span class="linenos">3220</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3221"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3221"><span class="linenos">3221</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3222"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3222"><span class="linenos">3222</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3223"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3223"><span class="linenos">3223</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3224"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3224"><span class="linenos">3224</span></a>			<span class="k">if</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_zero_fuel&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3225"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3225"><span class="linenos">3225</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s2">&quot;It is possible to decrease the speed of&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;at the top of the climb.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3226"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3226"><span class="linenos">3226</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3227"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3227"><span class="linenos">3227</span></a><span class="w">				</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3228"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3228"><span class="linenos">3228</span></a><span class="sd">				x_cont = np.linspace(tfsc[&#39;min_time&#39;], tfsc[&#39;max_time&#39;], 100)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3229"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3229"><span class="linenos">3229</span></a><span class="sd">				plt.plot(x_cont, tfsc[&#39;time_fuel_func&#39;](x_cont))</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3230"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3230"><span class="linenos">3230</span></a><span class="sd">				plt.show()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3231"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3231"><span class="linenos">3231</span></a><span class="sd">				plt.clf()</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3232"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3232"><span class="linenos">3232</span></a><span class="sd">				&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3233"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3233"><span class="linenos">3233</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3234"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3234"><span class="linenos">3234</span></a>				<span class="c1"># real extra minutes that are going to be added to the flight - depends on max_time_w_fuel</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3235"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3235"><span class="linenos">3235</span></a>				<span class="n">delta_t</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;max_time_w_fuel&#39;</span><span class="p">],</span> <span class="n">add_mins</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3236"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3236"><span class="linenos">3236</span></a>				<span class="c1"># print(flight_str(flight_uid), &quot; decides to add &quot;, delta_t, &quot; minutes as the maximum is &quot;, tfsc[&#39;max_time_w_fuel&#39;])</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3237"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3237"><span class="linenos">3237</span></a>				<span class="n">perc_selected</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;perc_variation_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">))),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3238"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3238"><span class="linenos">3238</span></a>				<span class="n">dfuel</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;time_fuel_func&#39;</span><span class="p">](</span><span class="n">delta_t</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3239"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3239"><span class="linenos">3239</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;is adding&quot;</span><span class="p">,</span> <span class="n">delta_t</span><span class="p">,</span> <span class="s2">&quot;minutes to the flying time at top of climb. Saving&quot;</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="s2">&quot;kg of fuel.&quot;</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3240"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3240"><span class="linenos">3240</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3241"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3241"><span class="linenos">3241</span></a>				<span class="c1"># send msg to flight plan updater to update speed - USE DCI_TOD_LANDING</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3242"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3242"><span class="linenos">3242</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3243"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3243"><span class="linenos">3243</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s2">&quot;sent message to flight plan updater to update speed by percentage&quot;</span><span class="p">,</span> <span class="n">perc_selected</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3244"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3244"><span class="linenos">3244</span></a>				<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">tfsc</span><span class="p">[</span><span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3245"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3245"><span class="linenos">3245</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3246"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3246"><span class="linenos">3246</span></a>				<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3247"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3247"><span class="linenos">3247</span></a>				<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3248"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3248"><span class="linenos">3248</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3249"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3249"><span class="linenos">3249</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3250"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3250"><span class="linenos">3250</span></a>			<span class="c1"># just save the info (flight didn&#39;t do anything on TOC)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3251"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3251"><span class="linenos">3251</span></a>			<span class="n">recoverable_delay</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3252"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3252"><span class="linenos">3252</span></a>			<span class="n">extra_fuel_available</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3253"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3253"><span class="linenos">3253</span></a>			<span class="n">delta_t</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3254"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3254"><span class="linenos">3254</span></a>			<span class="n">perc_selected</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3255"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3255"><span class="linenos">3255</span></a>			<span class="n">dfuel</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3256"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3256"><span class="linenos">3256</span></a>			<span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;top_of_climb_slow_down&#39;</span><span class="p">,</span> <span class="n">exp_arr_delay</span><span class="p">,</span> <span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">dfuel</span><span class="p">,</span> <span class="n">extra_fuel_available</span><span class="p">,</span> <span class="n">recoverable_delay</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3257"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3257"><span class="linenos">3257</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">save_dci_decision_info</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3258"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3258"><span class="linenos">3258</span></a>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3259"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3259"><span class="linenos">3259</span></a>		<span class="c1"># save the dci decision info on slowing down</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3260"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3260"><span class="linenos">3260</span></a>		<span class="c1"># params = [&#39;top_of_climb_slow_down&#39;, exp_arr_delay, -delta_t, perc_selected, dfuel, extra_fuel_available, recoverable_delay]</span>
</span><span id="DynamicCostIndexComputer.reassess_cost_index_TA2-3261"><a href="#DynamicCostIndexComputer.reassess_cost_index_TA2-3261"><span class="linenos">3261</span></a>		<span class="c1"># self.save_dci_decision_info(flight_uid, params)</span>
</span></pre></div>


            <div class="docstring"><p>Doing the same as on level 1, but allowing to slow down if estimated arrival
more than 15 minutes earlier than scheduled. Slow down to 15 minutes.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu" class="classattr">
                                        <input id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_speed_up_msg_to_fpu</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">perc_selected</span>, </span><span class="param"><span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3263"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3263"><span class="linenos">3263</span></a>	<span class="k">def</span> <span class="nf">send_speed_up_msg_to_fpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">perc_selected</span><span class="p">,</span> <span class="n">change_tod_dci</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3264"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3264"><span class="linenos">3264</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3265"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3265"><span class="linenos">3265</span></a><span class="sd">		Sends a message to the flight plan updater who updates the speed by</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3266"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3266"><span class="linenos">3266</span></a><span class="sd">		increasing it by perc_selected.</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3267"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3267"><span class="linenos">3267</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3268"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3268"><span class="linenos">3268</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3269"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3269"><span class="linenos">3269</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3270"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3270"><span class="linenos">3270</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;speed_update&#39;</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3271"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3271"><span class="linenos">3271</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">perc_selected</span><span class="p">,</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3272"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3272"><span class="linenos">3272</span></a>					   <span class="s1">&#39;change_tod_dci&#39;</span><span class="p">:</span> <span class="n">change_tod_dci</span><span class="p">}</span>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3273"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3273"><span class="linenos">3273</span></a>
</span><span id="DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3274"><a href="#DynamicCostIndexComputer.send_speed_up_msg_to_fpu-3274"><span class="linenos">3274</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sends a message to the flight plan updater who updates the speed by
increasing it by perc_selected.</p>
</div>


                            </div>
                            <div id="DynamicCostIndexComputer.save_dci_decision_info" class="classattr">
                                        <input id="DynamicCostIndexComputer.save_dci_decision_info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_dci_decision_info</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">params</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="DynamicCostIndexComputer.save_dci_decision_info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DynamicCostIndexComputer.save_dci_decision_info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DynamicCostIndexComputer.save_dci_decision_info-3276"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3276"><span class="linenos">3276</span></a>	<span class="k">def</span> <span class="nf">save_dci_decision_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3277"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3277"><span class="linenos">3277</span></a>		<span class="n">dci_decision</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dci_check_timestamp&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3278"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3278"><span class="linenos">3278</span></a>						<span class="s1">&#39;estimated_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3279"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3279"><span class="linenos">3279</span></a>						<span class="s1">&#39;recovering_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3280"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3280"><span class="linenos">3280</span></a>						<span class="s1">&#39;perc_selected&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3281"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3281"><span class="linenos">3281</span></a>						<span class="s1">&#39;dfuel&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3282"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3282"><span class="linenos">3282</span></a>						<span class="s1">&#39;extra_fuel_available&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3283"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3283"><span class="linenos">3283</span></a>						<span class="s1">&#39;recoverable_delay&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3284"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3284"><span class="linenos">3284</span></a>						<span class="p">}</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3285"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3285"><span class="linenos">3285</span></a>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3286"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3286"><span class="linenos">3286</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dci_decisions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dci_decision</span><span class="p">)</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3287"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3287"><span class="linenos">3287</span></a>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3288"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3288"><span class="linenos">3288</span></a>		<span class="c1"># test</span>
</span><span id="DynamicCostIndexComputer.save_dci_decision_info-3289"><a href="#DynamicCostIndexComputer.save_dci_decision_info-3289"><span class="linenos">3289</span></a>		<span class="c1"># print(self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].dci_decisions)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="DynamicCostIndexComputer.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="DynamicCostIndexComputer.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="PassengerReallocation">
                            <input id="PassengerReallocation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">PassengerReallocation</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="PassengerReallocation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation-3292"><a href="#PassengerReallocation-3292"><span class="linenos">3292</span></a><span class="k">class</span> <span class="nc">PassengerReallocation</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="PassengerReallocation-3293"><a href="#PassengerReallocation-3293"><span class="linenos">3293</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3294"><a href="#PassengerReallocation-3294"><span class="linenos">3294</span></a><span class="sd">	PR</span>
</span><span id="PassengerReallocation-3295"><a href="#PassengerReallocation-3295"><span class="linenos">3295</span></a>
</span><span id="PassengerReallocation-3296"><a href="#PassengerReallocation-3296"><span class="linenos">3296</span></a><span class="sd">	Description: Decide how to manage connecting passengers when a flight has left.</span>
</span><span id="PassengerReallocation-3297"><a href="#PassengerReallocation-3297"><span class="linenos">3297</span></a><span class="sd">	1. Check passenger that should have been in the flight that has left and have missed their connection</span>
</span><span id="PassengerReallocation-3298"><a href="#PassengerReallocation-3298"><span class="linenos">3298</span></a><span class="sd">	2. Rebook them onto following flights to destination, compensate compute_missed_connecting_paxand return them to destination, pay for care, and potentially put them in hotels by checking preferences with passengers.</span>
</span><span id="PassengerReallocation-3299"><a href="#PassengerReallocation-3299"><span class="linenos">3299</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3300"><a href="#PassengerReallocation-3300"><span class="linenos">3300</span></a>
</span><span id="PassengerReallocation-3301"><a href="#PassengerReallocation-3301"><span class="linenos">3301</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="PassengerReallocation-3302"><a href="#PassengerReallocation-3302"><span class="linenos">3302</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="PassengerReallocation-3303"><a href="#PassengerReallocation-3303"><span class="linenos">3303</span></a>
</span><span id="PassengerReallocation-3304"><a href="#PassengerReallocation-3304"><span class="linenos">3304</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="PassengerReallocation-3305"><a href="#PassengerReallocation-3305"><span class="linenos">3305</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_missed_connecting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3306"><a href="#PassengerReallocation-3306"><span class="linenos">3306</span></a>
</span><span id="PassengerReallocation-3307"><a href="#PassengerReallocation-3307"><span class="linenos">3307</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from check_push_back of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3308"><a href="#PassengerReallocation-3308"><span class="linenos">3308</span></a>
</span><span id="PassengerReallocation-3309"><a href="#PassengerReallocation-3309"><span class="linenos">3309</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">paxs</span><span class="p">)</span>
</span><span id="PassengerReallocation-3310"><a href="#PassengerReallocation-3310"><span class="linenos">3310</span></a>
</span><span id="PassengerReallocation-3311"><a href="#PassengerReallocation-3311"><span class="linenos">3311</span></a>	<span class="k">def</span> <span class="nf">compute_missed_connecting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3312"><a href="#PassengerReallocation-3312"><span class="linenos">3312</span></a>		<span class="n">pax_needing_reallocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3313"><a href="#PassengerReallocation-3313"><span class="linenos">3313</span></a>									<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="PassengerReallocation-3314"><a href="#PassengerReallocation-3314"><span class="linenos">3314</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_needing_reallocation</span><span class="p">:</span>
</span><span id="PassengerReallocation-3315"><a href="#PassengerReallocation-3315"><span class="linenos">3315</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3316"><a href="#PassengerReallocation-3316"><span class="linenos">3316</span></a>
</span><span id="PassengerReallocation-3317"><a href="#PassengerReallocation-3317"><span class="linenos">3317</span></a>			<span class="c1"># Check if pax has taken more time than what the airline was expecting</span>
</span><span id="PassengerReallocation-3318"><a href="#PassengerReallocation-3318"><span class="linenos">3318</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="o">&gt;</span><span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">:</span>
</span><span id="PassengerReallocation-3319"><a href="#PassengerReallocation-3319"><span class="linenos">3319</span></a>				<span class="c1"># If so, blame the pax for any compensation</span>
</span><span id="PassengerReallocation-3320"><a href="#PassengerReallocation-3320"><span class="linenos">3320</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has taken&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="p">,</span> <span class="s1">&#39;as connecting time vs. an MCT of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">,</span>
</span><span id="PassengerReallocation-3321"><a href="#PassengerReallocation-3321"><span class="linenos">3321</span></a>						<span class="s1">&#39;; it blames itself for any future compensation&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation-3322"><a href="#PassengerReallocation-3322"><span class="linenos">3322</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="s1">&#39;self&#39;</span>
</span><span id="PassengerReallocation-3323"><a href="#PassengerReallocation-3323"><span class="linenos">3323</span></a>
</span><span id="PassengerReallocation-3324"><a href="#PassengerReallocation-3324"><span class="linenos">3324</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax already at airport left behind by&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">pax_needing_reallocation</span><span class="p">)</span>
</span><span id="PassengerReallocation-3325"><a href="#PassengerReallocation-3325"><span class="linenos">3325</span></a>
</span><span id="PassengerReallocation-3326"><a href="#PassengerReallocation-3326"><span class="linenos">3326</span></a>		<span class="k">return</span> <span class="n">pax_needing_reallocation</span>
</span><span id="PassengerReallocation-3327"><a href="#PassengerReallocation-3327"><span class="linenos">3327</span></a>
</span><span id="PassengerReallocation-3328"><a href="#PassengerReallocation-3328"><span class="linenos">3328</span></a>	<span class="k">def</span> <span class="nf">compute_reallocation_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PassengerReallocation-3329"><a href="#PassengerReallocation-3329"><span class="linenos">3329</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3330"><a href="#PassengerReallocation-3330"><span class="linenos">3330</span></a><span class="sd">		Note: only direct flights and flights with one connection</span>
</span><span id="PassengerReallocation-3331"><a href="#PassengerReallocation-3331"><span class="linenos">3331</span></a><span class="sd">		are considered.</span>
</span><span id="PassengerReallocation-3332"><a href="#PassengerReallocation-3332"><span class="linenos">3332</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3333"><a href="#PassengerReallocation-3333"><span class="linenos">3333</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;compute_reallocation_options&#39;</span><span class="p">):</span>
</span><span id="PassengerReallocation-3334"><a href="#PassengerReallocation-3334"><span class="linenos">3334</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3335"><a href="#PassengerReallocation-3335"><span class="linenos">3335</span></a>			<span class="n">itineraries</span><span class="p">,</span> <span class="n">travelling_times</span><span class="p">,</span> <span class="n">capacities</span><span class="p">,</span> <span class="n">arrival_times</span><span class="p">,</span> <span class="n">departure_times</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="PassengerReallocation-3336"><a href="#PassengerReallocation-3336"><span class="linenos">3336</span></a>			<span class="n">transfer_costs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PassengerReallocation-3337"><a href="#PassengerReallocation-3337"><span class="linenos">3337</span></a>
</span><span id="PassengerReallocation-3338"><a href="#PassengerReallocation-3338"><span class="linenos">3338</span></a>			<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="PassengerReallocation-3339"><a href="#PassengerReallocation-3339"><span class="linenos">3339</span></a>			<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="PassengerReallocation-3340"><a href="#PassengerReallocation-3340"><span class="linenos">3340</span></a>			<span class="c1"># now (like the one it missed).</span>
</span><span id="PassengerReallocation-3341"><a href="#PassengerReallocation-3341"><span class="linenos">3341</span></a>			<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PassengerReallocation-3342"><a href="#PassengerReallocation-3342"><span class="linenos">3342</span></a>										<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">from_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation-3343"><a href="#PassengerReallocation-3343"><span class="linenos">3343</span></a>										<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PassengerReallocation-3344"><a href="#PassengerReallocation-3344"><span class="linenos">3344</span></a>										<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3345"><a href="#PassengerReallocation-3345"><span class="linenos">3345</span></a>
</span><span id="PassengerReallocation-3346"><a href="#PassengerReallocation-3346"><span class="linenos">3346</span></a>			<span class="c1"># First select direct itineraries</span>
</span><span id="PassengerReallocation-3347"><a href="#PassengerReallocation-3347"><span class="linenos">3347</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation-3348"><a href="#PassengerReallocation-3348"><span class="linenos">3348</span></a>											<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3349"><a href="#PassengerReallocation-3349"><span class="linenos">3349</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3350"><a href="#PassengerReallocation-3350"><span class="linenos">3350</span></a>
</span><span id="PassengerReallocation-3351"><a href="#PassengerReallocation-3351"><span class="linenos">3351</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation-3352"><a href="#PassengerReallocation-3352"><span class="linenos">3352</span></a>
</span><span id="PassengerReallocation-3353"><a href="#PassengerReallocation-3353"><span class="linenos">3353</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3354"><a href="#PassengerReallocation-3354"><span class="linenos">3354</span></a>
</span><span id="PassengerReallocation-3355"><a href="#PassengerReallocation-3355"><span class="linenos">3355</span></a>			<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="PassengerReallocation-3356"><a href="#PassengerReallocation-3356"><span class="linenos">3356</span></a>			<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3357"><a href="#PassengerReallocation-3357"><span class="linenos">3357</span></a>			<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3358"><a href="#PassengerReallocation-3358"><span class="linenos">3358</span></a>			<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3359"><a href="#PassengerReallocation-3359"><span class="linenos">3359</span></a>			<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3360"><a href="#PassengerReallocation-3360"><span class="linenos">3360</span></a>			<span class="c1"># aprint(&#39;capacity:&#39;, sum(capacities))</span>
</span><span id="PassengerReallocation-3361"><a href="#PassengerReallocation-3361"><span class="linenos">3361</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation-3362"><a href="#PassengerReallocation-3362"><span class="linenos">3362</span></a>				<span class="c1"># Then search indirect itineraries</span>
</span><span id="PassengerReallocation-3363"><a href="#PassengerReallocation-3363"><span class="linenos">3363</span></a>				<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="PassengerReallocation-3364"><a href="#PassengerReallocation-3364"><span class="linenos">3364</span></a>				<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PassengerReallocation-3365"><a href="#PassengerReallocation-3365"><span class="linenos">3365</span></a>											<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3366"><a href="#PassengerReallocation-3366"><span class="linenos">3366</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="PassengerReallocation-3367"><a href="#PassengerReallocation-3367"><span class="linenos">3367</span></a>											<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3368"><a href="#PassengerReallocation-3368"><span class="linenos">3368</span></a>
</span><span id="PassengerReallocation-3369"><a href="#PassengerReallocation-3369"><span class="linenos">3369</span></a>				<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="PassengerReallocation-3370"><a href="#PassengerReallocation-3370"><span class="linenos">3370</span></a>
</span><span id="PassengerReallocation-3371"><a href="#PassengerReallocation-3371"><span class="linenos">3371</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span> <span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">outbound_flights</span> <span class="k">for</span> <span class="n">f2</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="PassengerReallocation-3372"><a href="#PassengerReallocation-3372"><span class="linenos">3372</span></a>											<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3373"><a href="#PassengerReallocation-3373"><span class="linenos">3373</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3374"><a href="#PassengerReallocation-3374"><span class="linenos">3374</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="PassengerReallocation-3375"><a href="#PassengerReallocation-3375"><span class="linenos">3375</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3376"><a href="#PassengerReallocation-3376"><span class="linenos">3376</span></a>
</span><span id="PassengerReallocation-3377"><a href="#PassengerReallocation-3377"><span class="linenos">3377</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation-3378"><a href="#PassengerReallocation-3378"><span class="linenos">3378</span></a>
</span><span id="PassengerReallocation-3379"><a href="#PassengerReallocation-3379"><span class="linenos">3379</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential indirect flights:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3380"><a href="#PassengerReallocation-3380"><span class="linenos">3380</span></a>
</span><span id="PassengerReallocation-3381"><a href="#PassengerReallocation-3381"><span class="linenos">3381</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="PassengerReallocation-3382"><a href="#PassengerReallocation-3382"><span class="linenos">3382</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3383"><a href="#PassengerReallocation-3383"><span class="linenos">3383</span></a>				<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3384"><a href="#PassengerReallocation-3384"><span class="linenos">3384</span></a>				<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3385"><a href="#PassengerReallocation-3385"><span class="linenos">3385</span></a>				<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3386"><a href="#PassengerReallocation-3386"><span class="linenos">3386</span></a>				<span class="c1"># aprint(&#39;capacity:&#39;, sum(self.capacities))</span>
</span><span id="PassengerReallocation-3387"><a href="#PassengerReallocation-3387"><span class="linenos">3387</span></a>
</span><span id="PassengerReallocation-3388"><a href="#PassengerReallocation-3388"><span class="linenos">3388</span></a>			<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation-3389"><a href="#PassengerReallocation-3389"><span class="linenos">3389</span></a>			<span class="c1"># capacity_functions += [self.agent.get_number_seats_itinerary]*len(itineraries)</span>
</span><span id="PassengerReallocation-3390"><a href="#PassengerReallocation-3390"><span class="linenos">3390</span></a>
</span><span id="PassengerReallocation-3391"><a href="#PassengerReallocation-3391"><span class="linenos">3391</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation-3392"><a href="#PassengerReallocation-3392"><span class="linenos">3392</span></a>				<span class="c1"># Look for itineraries within alliance and outside of alliance.</span>
</span><span id="PassengerReallocation-3393"><a href="#PassengerReallocation-3393"><span class="linenos">3393</span></a>
</span><span id="PassengerReallocation-3394"><a href="#PassengerReallocation-3394"><span class="linenos">3394</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;looks for more itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3395"><a href="#PassengerReallocation-3395"><span class="linenos">3395</span></a>
</span><span id="PassengerReallocation-3396"><a href="#PassengerReallocation-3396"><span class="linenos">3396</span></a>				<span class="n">capacity_needed</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span>
</span><span id="PassengerReallocation-3397"><a href="#PassengerReallocation-3397"><span class="linenos">3397</span></a>
</span><span id="PassengerReallocation-3398"><a href="#PassengerReallocation-3398"><span class="linenos">3398</span></a>				<span class="c1"># First try intra-alliance itineraries</span>
</span><span id="PassengerReallocation-3399"><a href="#PassengerReallocation-3399"><span class="linenos">3399</span></a>				<span class="c1"># Outbound flights (including the initial airline&#39;s)</span>
</span><span id="PassengerReallocation-3400"><a href="#PassengerReallocation-3400"><span class="linenos">3400</span></a>				<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>  <span class="c1"># self.airlines[aoc_uid2][&#39;aoc&#39;])</span>
</span><span id="PassengerReallocation-3401"><a href="#PassengerReallocation-3401"><span class="linenos">3401</span></a>										<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="PassengerReallocation-3402"><a href="#PassengerReallocation-3402"><span class="linenos">3402</span></a>											<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3403"><a href="#PassengerReallocation-3403"><span class="linenos">3403</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation-3404"><a href="#PassengerReallocation-3404"><span class="linenos">3404</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PassengerReallocation-3405"><a href="#PassengerReallocation-3405"><span class="linenos">3405</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3406"><a href="#PassengerReallocation-3406"><span class="linenos">3406</span></a>
</span><span id="PassengerReallocation-3407"><a href="#PassengerReallocation-3407"><span class="linenos">3407</span></a>				<span class="c1"># Select direct flights</span>
</span><span id="PassengerReallocation-3408"><a href="#PassengerReallocation-3408"><span class="linenos">3408</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation-3409"><a href="#PassengerReallocation-3409"><span class="linenos">3409</span></a>												<span class="k">if</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3410"><a href="#PassengerReallocation-3410"><span class="linenos">3410</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3411"><a href="#PassengerReallocation-3411"><span class="linenos">3411</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation-3412"><a href="#PassengerReallocation-3412"><span class="linenos">3412</span></a>
</span><span id="PassengerReallocation-3413"><a href="#PassengerReallocation-3413"><span class="linenos">3413</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="PassengerReallocation-3414"><a href="#PassengerReallocation-3414"><span class="linenos">3414</span></a>				<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">direct_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation-3415"><a href="#PassengerReallocation-3415"><span class="linenos">3415</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance direct flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">direct_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation-3416"><a href="#PassengerReallocation-3416"><span class="linenos">3416</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3417"><a href="#PassengerReallocation-3417"><span class="linenos">3417</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3418"><a href="#PassengerReallocation-3418"><span class="linenos">3418</span></a>
</span><span id="PassengerReallocation-3419"><a href="#PassengerReallocation-3419"><span class="linenos">3419</span></a>				<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">:</span>
</span><span id="PassengerReallocation-3420"><a href="#PassengerReallocation-3420"><span class="linenos">3420</span></a>
</span><span id="PassengerReallocation-3421"><a href="#PassengerReallocation-3421"><span class="linenos">3421</span></a>					<span class="c1"># Search indirect flights</span>
</span><span id="PassengerReallocation-3422"><a href="#PassengerReallocation-3422"><span class="linenos">3422</span></a>					<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="PassengerReallocation-3423"><a href="#PassengerReallocation-3423"><span class="linenos">3423</span></a>					<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3424"><a href="#PassengerReallocation-3424"><span class="linenos">3424</span></a>											<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="PassengerReallocation-3425"><a href="#PassengerReallocation-3425"><span class="linenos">3425</span></a>											 <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3426"><a href="#PassengerReallocation-3426"><span class="linenos">3426</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3427"><a href="#PassengerReallocation-3427"><span class="linenos">3427</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="PassengerReallocation-3428"><a href="#PassengerReallocation-3428"><span class="linenos">3428</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3429"><a href="#PassengerReallocation-3429"><span class="linenos">3429</span></a>
</span><span id="PassengerReallocation-3430"><a href="#PassengerReallocation-3430"><span class="linenos">3430</span></a>					<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="PassengerReallocation-3431"><a href="#PassengerReallocation-3431"><span class="linenos">3431</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">))</span>
</span><span id="PassengerReallocation-3432"><a href="#PassengerReallocation-3432"><span class="linenos">3432</span></a>												<span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation-3433"><a href="#PassengerReallocation-3433"><span class="linenos">3433</span></a>												<span class="k">for</span> <span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="PassengerReallocation-3434"><a href="#PassengerReallocation-3434"><span class="linenos">3434</span></a>												<span class="k">if</span> <span class="p">((</span><span class="n">aoc1_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
</span><span id="PassengerReallocation-3435"><a href="#PassengerReallocation-3435"><span class="linenos">3435</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3436"><a href="#PassengerReallocation-3436"><span class="linenos">3436</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation-3437"><a href="#PassengerReallocation-3437"><span class="linenos">3437</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="PassengerReallocation-3438"><a href="#PassengerReallocation-3438"><span class="linenos">3438</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation-3439"><a href="#PassengerReallocation-3439"><span class="linenos">3439</span></a>
</span><span id="PassengerReallocation-3440"><a href="#PassengerReallocation-3440"><span class="linenos">3440</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation-3441"><a href="#PassengerReallocation-3441"><span class="linenos">3441</span></a>
</span><span id="PassengerReallocation-3442"><a href="#PassengerReallocation-3442"><span class="linenos">3442</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance indirect flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation-3443"><a href="#PassengerReallocation-3443"><span class="linenos">3443</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3444"><a href="#PassengerReallocation-3444"><span class="linenos">3444</span></a>
</span><span id="PassengerReallocation-3445"><a href="#PassengerReallocation-3445"><span class="linenos">3445</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="PassengerReallocation-3446"><a href="#PassengerReallocation-3446"><span class="linenos">3446</span></a>					<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">indirect_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation-3447"><a href="#PassengerReallocation-3447"><span class="linenos">3447</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3448"><a href="#PassengerReallocation-3448"><span class="linenos">3448</span></a>
</span><span id="PassengerReallocation-3449"><a href="#PassengerReallocation-3449"><span class="linenos">3449</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">):</span>
</span><span id="PassengerReallocation-3450"><a href="#PassengerReallocation-3450"><span class="linenos">3450</span></a>					<span class="c1"># Try airlines outside of alliance. Check only direct flights. Compute the price of rebooking.</span>
</span><span id="PassengerReallocation-3451"><a href="#PassengerReallocation-3451"><span class="linenos">3451</span></a>					<span class="n">indirect_outside_itineraries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PassengerReallocation-3452"><a href="#PassengerReallocation-3452"><span class="linenos">3452</span></a>					<span class="k">for</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">():</span>
</span><span id="PassengerReallocation-3453"><a href="#PassengerReallocation-3453"><span class="linenos">3453</span></a>						<span class="k">if</span> <span class="n">aoc2_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">():</span>
</span><span id="PassengerReallocation-3454"><a href="#PassengerReallocation-3454"><span class="linenos">3454</span></a>							<span class="c1"># for flight_uid, flight_info in self.airlines[aoc2_uid][&#39;aoc&#39;].aoc_flights_info.items():</span>
</span><span id="PassengerReallocation-3455"><a href="#PassengerReallocation-3455"><span class="linenos">3455</span></a>							<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc2_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3456"><a href="#PassengerReallocation-3456"><span class="linenos">3456</span></a>								<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>\
</span><span id="PassengerReallocation-3457"><a href="#PassengerReallocation-3457"><span class="linenos">3457</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>\
</span><span id="PassengerReallocation-3458"><a href="#PassengerReallocation-3458"><span class="linenos">3458</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>\
</span><span id="PassengerReallocation-3459"><a href="#PassengerReallocation-3459"><span class="linenos">3459</span></a>									<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">:</span>
</span><span id="PassengerReallocation-3460"><a href="#PassengerReallocation-3460"><span class="linenos">3460</span></a>										<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation-3461"><a href="#PassengerReallocation-3461"><span class="linenos">3461</span></a>											<span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3462"><a href="#PassengerReallocation-3462"><span class="linenos">3462</span></a>											<span class="n">indirect_outside_itineraries</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span>
</span><span id="PassengerReallocation-3463"><a href="#PassengerReallocation-3463"><span class="linenos">3463</span></a>											<span class="n">transfer_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
</span><span id="PassengerReallocation-3464"><a href="#PassengerReallocation-3464"><span class="linenos">3464</span></a>
</span><span id="PassengerReallocation-3465"><a href="#PassengerReallocation-3465"><span class="linenos">3465</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights outside of alliance for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_outside_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation-3466"><a href="#PassengerReallocation-3466"><span class="linenos">3466</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3467"><a href="#PassengerReallocation-3467"><span class="linenos">3467</span></a>
</span><span id="PassengerReallocation-3468"><a href="#PassengerReallocation-3468"><span class="linenos">3468</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_outside_itineraries</span>
</span><span id="PassengerReallocation-3469"><a href="#PassengerReallocation-3469"><span class="linenos">3469</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3470"><a href="#PassengerReallocation-3470"><span class="linenos">3470</span></a>
</span><span id="PassengerReallocation-3471"><a href="#PassengerReallocation-3471"><span class="linenos">3471</span></a>				<span class="n">travelling_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3472"><a href="#PassengerReallocation-3472"><span class="linenos">3472</span></a>				<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3473"><a href="#PassengerReallocation-3473"><span class="linenos">3473</span></a>				<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation-3474"><a href="#PassengerReallocation-3474"><span class="linenos">3474</span></a>
</span><span id="PassengerReallocation-3475"><a href="#PassengerReallocation-3475"><span class="linenos">3475</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3476"><a href="#PassengerReallocation-3476"><span class="linenos">3476</span></a>
</span><span id="PassengerReallocation-3477"><a href="#PassengerReallocation-3477"><span class="linenos">3477</span></a>			<span class="n">capacity_functions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation-3478"><a href="#PassengerReallocation-3478"><span class="linenos">3478</span></a>
</span><span id="PassengerReallocation-3479"><a href="#PassengerReallocation-3479"><span class="linenos">3479</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;itineraries&#39;</span><span class="p">:</span> <span class="n">itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation-3480"><a href="#PassengerReallocation-3480"><span class="linenos">3480</span></a>									<span class="s1">&#39;capacities&#39;</span><span class="p">:</span> <span class="n">capacities</span><span class="p">,</span>
</span><span id="PassengerReallocation-3481"><a href="#PassengerReallocation-3481"><span class="linenos">3481</span></a>									<span class="s1">&#39;travelling_times&#39;</span><span class="p">:</span> <span class="n">travelling_times</span><span class="p">,</span>
</span><span id="PassengerReallocation-3482"><a href="#PassengerReallocation-3482"><span class="linenos">3482</span></a>									<span class="s1">&#39;transfer_costs&#39;</span><span class="p">:</span> <span class="n">transfer_costs</span><span class="p">,</span>
</span><span id="PassengerReallocation-3483"><a href="#PassengerReallocation-3483"><span class="linenos">3483</span></a>									<span class="s1">&#39;arrival_times&#39;</span><span class="p">:</span> <span class="n">arrival_times</span><span class="p">,</span>
</span><span id="PassengerReallocation-3484"><a href="#PassengerReallocation-3484"><span class="linenos">3484</span></a>									<span class="s1">&#39;departure_times&#39;</span><span class="p">:</span> <span class="n">departure_times</span><span class="p">,</span>
</span><span id="PassengerReallocation-3485"><a href="#PassengerReallocation-3485"><span class="linenos">3485</span></a>									<span class="s1">&#39;capacity_functions&#39;</span><span class="p">:</span> <span class="n">capacity_functions</span><span class="p">}</span>
</span><span id="PassengerReallocation-3486"><a href="#PassengerReallocation-3486"><span class="linenos">3486</span></a>
</span><span id="PassengerReallocation-3487"><a href="#PassengerReallocation-3487"><span class="linenos">3487</span></a>		<span class="k">return</span> <span class="n">reallocation_options</span>
</span><span id="PassengerReallocation-3488"><a href="#PassengerReallocation-3488"><span class="linenos">3488</span></a>
</span><span id="PassengerReallocation-3489"><a href="#PassengerReallocation-3489"><span class="linenos">3489</span></a>	<span class="k">def</span> <span class="nf">do_reallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="PassengerReallocation-3490"><a href="#PassengerReallocation-3490"><span class="linenos">3490</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3491"><a href="#PassengerReallocation-3491"><span class="linenos">3491</span></a><span class="sd">		Note: I added that to have processes to wait for answer from itinerary provider.</span>
</span><span id="PassengerReallocation-3492"><a href="#PassengerReallocation-3492"><span class="linenos">3492</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3493"><a href="#PassengerReallocation-3493"><span class="linenos">3493</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="PassengerReallocation-3494"><a href="#PassengerReallocation-3494"><span class="linenos">3494</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3495"><a href="#PassengerReallocation-3495"><span class="linenos">3495</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation-3496"><a href="#PassengerReallocation-3496"><span class="linenos">3496</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Options for reallocation for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3497"><a href="#PassengerReallocation-3497"><span class="linenos">3497</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Capacities of pot. new itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3498"><a href="#PassengerReallocation-3498"><span class="linenos">3498</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation-3499"><a href="#PassengerReallocation-3499"><span class="linenos">3499</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">reallocate_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="PassengerReallocation-3500"><a href="#PassengerReallocation-3500"><span class="linenos">3500</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation-3501"><a href="#PassengerReallocation-3501"><span class="linenos">3501</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;could not find any other itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3502"><a href="#PassengerReallocation-3502"><span class="linenos">3502</span></a>				<span class="c1"># Remove passengers from boarding lists of all remaining flights.</span>
</span><span id="PassengerReallocation-3503"><a href="#PassengerReallocation-3503"><span class="linenos">3503</span></a>				<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flights</span><span class="p">():</span>
</span><span id="PassengerReallocation-3504"><a href="#PassengerReallocation-3504"><span class="linenos">3504</span></a>					<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="PassengerReallocation-3505"><a href="#PassengerReallocation-3505"><span class="linenos">3505</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3506"><a href="#PassengerReallocation-3506"><span class="linenos">3506</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation-3507"><a href="#PassengerReallocation-3507"><span class="linenos">3507</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3508"><a href="#PassengerReallocation-3508"><span class="linenos">3508</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="PassengerReallocation-3509"><a href="#PassengerReallocation-3509"><span class="linenos">3509</span></a>
</span><span id="PassengerReallocation-3510"><a href="#PassengerReallocation-3510"><span class="linenos">3510</span></a>	<span class="k">def</span> <span class="nf">_cost_of_itineraries_pp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">):</span>
</span><span id="PassengerReallocation-3511"><a href="#PassengerReallocation-3511"><span class="linenos">3511</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3512"><a href="#PassengerReallocation-3512"><span class="linenos">3512</span></a><span class="sd">		Requires that the self.agent.aoc_pax_info[pax.id] dict has been filled already.</span>
</span><span id="PassengerReallocation-3513"><a href="#PassengerReallocation-3513"><span class="linenos">3513</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3514"><a href="#PassengerReallocation-3514"><span class="linenos">3514</span></a>
</span><span id="PassengerReallocation-3515"><a href="#PassengerReallocation-3515"><span class="linenos">3515</span></a>		<span class="n">soft_cost_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;arrival_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="PassengerReallocation-3516"><a href="#PassengerReallocation-3516"><span class="linenos">3516</span></a>		<span class="n">transfer_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;transfer_costs&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3517"><a href="#PassengerReallocation-3517"><span class="linenos">3517</span></a>		<span class="n">compensation_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">at</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;arrival_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="PassengerReallocation-3518"><a href="#PassengerReallocation-3518"><span class="linenos">3518</span></a>		<span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">dt</span><span class="o">-</span><span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;departure_times&#39;</span><span class="p">]])</span><span class="o">/</span><span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="PassengerReallocation-3519"><a href="#PassengerReallocation-3519"><span class="linenos">3519</span></a>
</span><span id="PassengerReallocation-3520"><a href="#PassengerReallocation-3520"><span class="linenos">3520</span></a>		<span class="k">return</span> <span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span>
</span><span id="PassengerReallocation-3521"><a href="#PassengerReallocation-3521"><span class="linenos">3521</span></a>
</span><span id="PassengerReallocation-3522"><a href="#PassengerReallocation-3522"><span class="linenos">3522</span></a>	<span class="k">def</span> <span class="nf">reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">):</span>
</span><span id="PassengerReallocation-3523"><a href="#PassengerReallocation-3523"><span class="linenos">3523</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3524"><a href="#PassengerReallocation-3524"><span class="linenos">3524</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3525"><a href="#PassengerReallocation-3525"><span class="linenos">3525</span></a>		<span class="c1"># Reallocate passengers</span>
</span><span id="PassengerReallocation-3526"><a href="#PassengerReallocation-3526"><span class="linenos">3526</span></a>		<span class="c1"># For duty of care, take only into account current wait</span>
</span><span id="PassengerReallocation-3527"><a href="#PassengerReallocation-3527"><span class="linenos">3527</span></a>		<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="PassengerReallocation-3528"><a href="#PassengerReallocation-3528"><span class="linenos">3528</span></a>
</span><span id="PassengerReallocation-3529"><a href="#PassengerReallocation-3529"><span class="linenos">3529</span></a>		<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="PassengerReallocation-3530"><a href="#PassengerReallocation-3530"><span class="linenos">3530</span></a>
</span><span id="PassengerReallocation-3531"><a href="#PassengerReallocation-3531"><span class="linenos">3531</span></a>		<span class="c1"># Sort options</span>
</span><span id="PassengerReallocation-3532"><a href="#PassengerReallocation-3532"><span class="linenos">3532</span></a>		<span class="n">idx_ranked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span>
</span><span id="PassengerReallocation-3533"><a href="#PassengerReallocation-3533"><span class="linenos">3533</span></a>		<span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation-3534"><a href="#PassengerReallocation-3534"><span class="linenos">3534</span></a>		<span class="n">capacities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>  <span class="c1"># These are theoretical capacities!</span>
</span><span id="PassengerReallocation-3535"><a href="#PassengerReallocation-3535"><span class="linenos">3535</span></a>		<span class="n">transfer_costs_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation-3536"><a href="#PassengerReallocation-3536"><span class="linenos">3536</span></a>		<span class="n">capacity_functions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacity_functions&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation-3537"><a href="#PassengerReallocation-3537"><span class="linenos">3537</span></a>
</span><span id="PassengerReallocation-3538"><a href="#PassengerReallocation-3538"><span class="linenos">3538</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="PassengerReallocation-3539"><a href="#PassengerReallocation-3539"><span class="linenos">3539</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked capacities for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">)</span>
</span><span id="PassengerReallocation-3540"><a href="#PassengerReallocation-3540"><span class="linenos">3540</span></a>
</span><span id="PassengerReallocation-3541"><a href="#PassengerReallocation-3541"><span class="linenos">3541</span></a>		<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="PassengerReallocation-3542"><a href="#PassengerReallocation-3542"><span class="linenos">3542</span></a>
</span><span id="PassengerReallocation-3543"><a href="#PassengerReallocation-3543"><span class="linenos">3543</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;reallocates&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3544"><a href="#PassengerReallocation-3544"><span class="linenos">3544</span></a>		<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PassengerReallocation-3545"><a href="#PassengerReallocation-3545"><span class="linenos">3545</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)):</span>
</span><span id="PassengerReallocation-3546"><a href="#PassengerReallocation-3546"><span class="linenos">3546</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; before update:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3547"><a href="#PassengerReallocation-3547"><span class="linenos">3547</span></a>			<span class="n">available_seats</span> <span class="o">=</span> <span class="n">capacity_functions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># self.agent.get_number_seats_itinerary(options[i])</span>
</span><span id="PassengerReallocation-3548"><a href="#PassengerReallocation-3548"><span class="linenos">3548</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; after update:&#39;</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3549"><a href="#PassengerReallocation-3549"><span class="linenos">3549</span></a>
</span><span id="PassengerReallocation-3550"><a href="#PassengerReallocation-3550"><span class="linenos">3550</span></a>			<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation-3551"><a href="#PassengerReallocation-3551"><span class="linenos">3551</span></a>				<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation-3552"><a href="#PassengerReallocation-3552"><span class="linenos">3552</span></a>					<span class="c1"># All remaining passengers can be fitted into this itinerary</span>
</span><span id="PassengerReallocation-3553"><a href="#PassengerReallocation-3553"><span class="linenos">3553</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Putting all remaining pax in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;in itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="PassengerReallocation-3554"><a href="#PassengerReallocation-3554"><span class="linenos">3554</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">pax</span>
</span><span id="PassengerReallocation-3555"><a href="#PassengerReallocation-3555"><span class="linenos">3555</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PassengerReallocation-3556"><a href="#PassengerReallocation-3556"><span class="linenos">3556</span></a>					<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PassengerReallocation-3557"><a href="#PassengerReallocation-3557"><span class="linenos">3557</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation-3558"><a href="#PassengerReallocation-3558"><span class="linenos">3558</span></a>					<span class="c1"># Split passengers</span>
</span><span id="PassengerReallocation-3559"><a href="#PassengerReallocation-3559"><span class="linenos">3559</span></a>					<span class="n">new_pax</span> <span class="o">=</span> <span class="n">clone_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">)</span>
</span><span id="PassengerReallocation-3560"><a href="#PassengerReallocation-3560"><span class="linenos">3560</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">new_paxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3561"><a href="#PassengerReallocation-3561"><span class="linenos">3561</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-=</span> <span class="n">available_seats</span>
</span><span id="PassengerReallocation-3562"><a href="#PassengerReallocation-3562"><span class="linenos">3562</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Splitting pax. New clone of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">new_pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3563"><a href="#PassengerReallocation-3563"><span class="linenos">3563</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Remaining pax:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3564"><a href="#PassengerReallocation-3564"><span class="linenos">3564</span></a>
</span><span id="PassengerReallocation-3565"><a href="#PassengerReallocation-3565"><span class="linenos">3565</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">new_pax</span>
</span><span id="PassengerReallocation-3566"><a href="#PassengerReallocation-3566"><span class="linenos">3566</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PassengerReallocation-3567"><a href="#PassengerReallocation-3567"><span class="linenos">3567</span></a>
</span><span id="PassengerReallocation-3568"><a href="#PassengerReallocation-3568"><span class="linenos">3568</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_reallocate_pax_to_itinerary</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">)</span>
</span><span id="PassengerReallocation-3569"><a href="#PassengerReallocation-3569"><span class="linenos">3569</span></a>
</span><span id="PassengerReallocation-3570"><a href="#PassengerReallocation-3570"><span class="linenos">3570</span></a>				<span class="k">if</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PassengerReallocation-3571"><a href="#PassengerReallocation-3571"><span class="linenos">3571</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">)</span>
</span><span id="PassengerReallocation-3572"><a href="#PassengerReallocation-3572"><span class="linenos">3572</span></a>					<span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">last_flight</span>
</span><span id="PassengerReallocation-3573"><a href="#PassengerReallocation-3573"><span class="linenos">3573</span></a>
</span><span id="PassengerReallocation-3574"><a href="#PassengerReallocation-3574"><span class="linenos">3574</span></a>				<span class="n">transfer_cost</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="PassengerReallocation-3575"><a href="#PassengerReallocation-3575"><span class="linenos">3575</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">transfer_cost</span><span class="p">,</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation-3576"><a href="#PassengerReallocation-3576"><span class="linenos">3576</span></a>
</span><span id="PassengerReallocation-3577"><a href="#PassengerReallocation-3577"><span class="linenos">3577</span></a>				<span class="k">if</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="PassengerReallocation-3578"><a href="#PassengerReallocation-3578"><span class="linenos">3578</span></a>					<span class="k">break</span>
</span><span id="PassengerReallocation-3579"><a href="#PassengerReallocation-3579"><span class="linenos">3579</span></a>
</span><span id="PassengerReallocation-3580"><a href="#PassengerReallocation-3580"><span class="linenos">3580</span></a>		<span class="c1"># If some passengers are remaining, maybe they could be reallocated in</span>
</span><span id="PassengerReallocation-3581"><a href="#PassengerReallocation-3581"><span class="linenos">3581</span></a>		<span class="c1"># further, so redo a round</span>
</span><span id="PassengerReallocation-3582"><a href="#PassengerReallocation-3582"><span class="linenos">3582</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="PassengerReallocation-3583"><a href="#PassengerReallocation-3583"><span class="linenos">3583</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;No more capacity for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;, so&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;retries a complete recomputation of itineraries&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation-3584"><a href="#PassengerReallocation-3584"><span class="linenos">3584</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">([</span><span class="n">pax</span><span class="p">])</span>
</span><span id="PassengerReallocation-3585"><a href="#PassengerReallocation-3585"><span class="linenos">3585</span></a>
</span><span id="PassengerReallocation-3586"><a href="#PassengerReallocation-3586"><span class="linenos">3586</span></a>	<span class="k">def</span> <span class="nf">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3587"><a href="#PassengerReallocation-3587"><span class="linenos">3587</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;removes&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;boarding list&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation-3588"><a href="#PassengerReallocation-3588"><span class="linenos">3588</span></a>		<span class="c1"># aprint(self.agent.aoc_flights_info[flight_uid][&#39;push_back_event&#39;].triggered)</span>
</span><span id="PassengerReallocation-3589"><a href="#PassengerReallocation-3589"><span class="linenos">3589</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3590"><a href="#PassengerReallocation-3590"><span class="linenos">3590</span></a>
</span><span id="PassengerReallocation-3591"><a href="#PassengerReallocation-3591"><span class="linenos">3591</span></a>	<span class="k">def</span> <span class="nf">_reallocate_pax_to_itinerary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="PassengerReallocation-3592"><a href="#PassengerReallocation-3592"><span class="linenos">3592</span></a>		<span class="c1"># Take out aoc_uids from itinerary</span>
</span><span id="PassengerReallocation-3593"><a href="#PassengerReallocation-3593"><span class="linenos">3593</span></a>		<span class="n">itinerary_flights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">itinerary</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation-3594"><a href="#PassengerReallocation-3594"><span class="linenos">3594</span></a>
</span><span id="PassengerReallocation-3595"><a href="#PassengerReallocation-3595"><span class="linenos">3595</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is reallocating&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;to itinerary&#39;</span><span class="p">,</span> <span class="n">itinerary</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3596"><a href="#PassengerReallocation-3596"><span class="linenos">3596</span></a>
</span><span id="PassengerReallocation-3597"><a href="#PassengerReallocation-3597"><span class="linenos">3597</span></a>		<span class="c1"># Reallocate pax to option</span>
</span><span id="PassengerReallocation-3598"><a href="#PassengerReallocation-3598"><span class="linenos">3598</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span>  <span class="c1"># to make sure that they don&#39;t miss the new flight</span>
</span><span id="PassengerReallocation-3599"><a href="#PassengerReallocation-3599"><span class="linenos">3599</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">copy</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)]</span>
</span><span id="PassengerReallocation-3600"><a href="#PassengerReallocation-3600"><span class="linenos">3600</span></a>
</span><span id="PassengerReallocation-3601"><a href="#PassengerReallocation-3601"><span class="linenos">3601</span></a>		<span class="c1"># Remove passengers from boarding listing of flights in old itinerary</span>
</span><span id="PassengerReallocation-3602"><a href="#PassengerReallocation-3602"><span class="linenos">3602</span></a>		<span class="c1"># which have not departed already.</span>
</span><span id="PassengerReallocation-3603"><a href="#PassengerReallocation-3603"><span class="linenos">3603</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">new</span><span class="p">:</span>
</span><span id="PassengerReallocation-3604"><a href="#PassengerReallocation-3604"><span class="linenos">3604</span></a>			<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flights</span><span class="p">():</span>
</span><span id="PassengerReallocation-3605"><a href="#PassengerReallocation-3605"><span class="linenos">3605</span></a>				<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="PassengerReallocation-3606"><a href="#PassengerReallocation-3606"><span class="linenos">3606</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;local boarding list removal for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3607"><a href="#PassengerReallocation-3607"><span class="linenos">3607</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3608"><a href="#PassengerReallocation-3608"><span class="linenos">3608</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation-3609"><a href="#PassengerReallocation-3609"><span class="linenos">3609</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3610"><a href="#PassengerReallocation-3610"><span class="linenos">3610</span></a>
</span><span id="PassengerReallocation-3611"><a href="#PassengerReallocation-3611"><span class="linenos">3611</span></a>		<span class="c1"># aprint(&#39;old itinerary:&#39;, pax.itinerary)</span>
</span><span id="PassengerReallocation-3612"><a href="#PassengerReallocation-3612"><span class="linenos">3612</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary_from_last_flight</span><span class="p">(</span><span class="n">itinerary_flights</span><span class="p">)</span>
</span><span id="PassengerReallocation-3613"><a href="#PassengerReallocation-3613"><span class="linenos">3613</span></a>
</span><span id="PassengerReallocation-3614"><a href="#PassengerReallocation-3614"><span class="linenos">3614</span></a>		<span class="c1"># aprint(&#39;DEBUG&#39;, &#39;new itinerary:&#39;, list(pax.itinerary[:pax.idx_current_flight]) + list(itinerary_flights))</span>
</span><span id="PassengerReallocation-3615"><a href="#PassengerReallocation-3615"><span class="linenos">3615</span></a>
</span><span id="PassengerReallocation-3616"><a href="#PassengerReallocation-3616"><span class="linenos">3616</span></a>		<span class="c1"># pax.active_flight = itinerary_flights[0]</span>
</span><span id="PassengerReallocation-3617"><a href="#PassengerReallocation-3617"><span class="linenos">3617</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="PassengerReallocation-3618"><a href="#PassengerReallocation-3618"><span class="linenos">3618</span></a>
</span><span id="PassengerReallocation-3619"><a href="#PassengerReallocation-3619"><span class="linenos">3619</span></a>		<span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid</span> <span class="ow">in</span> <span class="n">itinerary</span><span class="p">:</span>
</span><span id="PassengerReallocation-3620"><a href="#PassengerReallocation-3620"><span class="linenos">3620</span></a>			<span class="k">if</span> <span class="n">aoc_uid</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
</span><span id="PassengerReallocation-3621"><a href="#PassengerReallocation-3621"><span class="linenos">3621</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;local boarding list addition for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3622"><a href="#PassengerReallocation-3622"><span class="linenos">3622</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_add_pax_to_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3623"><a href="#PassengerReallocation-3623"><span class="linenos">3623</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation-3624"><a href="#PassengerReallocation-3624"><span class="linenos">3624</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_allocation_pax_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation-3625"><a href="#PassengerReallocation-3625"><span class="linenos">3625</span></a>
</span><span id="PassengerReallocation-3626"><a href="#PassengerReallocation-3626"><span class="linenos">3626</span></a>	<span class="k">def</span> <span class="nf">_add_pax_to_boarding_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3627"><a href="#PassengerReallocation-3627"><span class="linenos">3627</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;adds&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;to boarding list of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="PassengerReallocation-3628"><a href="#PassengerReallocation-3628"><span class="linenos">3628</span></a>		<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="PassengerReallocation-3629"><a href="#PassengerReallocation-3629"><span class="linenos">3629</span></a>				<span class="s1">&#39;pax to board before (capacity is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3630"><a href="#PassengerReallocation-3630"><span class="linenos">3630</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation-3631"><a href="#PassengerReallocation-3631"><span class="linenos">3631</span></a>		<span class="n">aprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;has&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_n_pax_to_board</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="PassengerReallocation-3632"><a href="#PassengerReallocation-3632"><span class="linenos">3632</span></a>				<span class="s1">&#39;pax to board after (capacity is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">seats</span><span class="p">,</span> <span class="s1">&#39;) at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3633"><a href="#PassengerReallocation-3633"><span class="linenos">3633</span></a>		<span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;n_pax_to_board&#39;] += pax.n_pax</span>
</span><span id="PassengerReallocation-3634"><a href="#PassengerReallocation-3634"><span class="linenos">3634</span></a>
</span><span id="PassengerReallocation-3635"><a href="#PassengerReallocation-3635"><span class="linenos">3635</span></a>	<span class="k">def</span> <span class="nf">send_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3636"><a href="#PassengerReallocation-3636"><span class="linenos">3636</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3637"><a href="#PassengerReallocation-3637"><span class="linenos">3637</span></a><span class="sd">		Used to ask another airline to put a pax group on the list of</span>
</span><span id="PassengerReallocation-3638"><a href="#PassengerReallocation-3638"><span class="linenos">3638</span></a><span class="sd">		pax to board.</span>
</span><span id="PassengerReallocation-3639"><a href="#PassengerReallocation-3639"><span class="linenos">3639</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3640"><a href="#PassengerReallocation-3640"><span class="linenos">3640</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="PassengerReallocation-3641"><a href="#PassengerReallocation-3641"><span class="linenos">3641</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="PassengerReallocation-3642"><a href="#PassengerReallocation-3642"><span class="linenos">3642</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;allocation_pax_request&#39;</span>
</span><span id="PassengerReallocation-3643"><a href="#PassengerReallocation-3643"><span class="linenos">3643</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="PassengerReallocation-3644"><a href="#PassengerReallocation-3644"><span class="linenos">3644</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="PassengerReallocation-3645"><a href="#PassengerReallocation-3645"><span class="linenos">3645</span></a>
</span><span id="PassengerReallocation-3646"><a href="#PassengerReallocation-3646"><span class="linenos">3646</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PassengerReallocation-3647"><a href="#PassengerReallocation-3647"><span class="linenos">3647</span></a>
</span><span id="PassengerReallocation-3648"><a href="#PassengerReallocation-3648"><span class="linenos">3648</span></a>	<span class="k">def</span> <span class="nf">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation-3649"><a href="#PassengerReallocation-3649"><span class="linenos">3649</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;sends a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation-3650"><a href="#PassengerReallocation-3650"><span class="linenos">3650</span></a>				<span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;to airline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="PassengerReallocation-3651"><a href="#PassengerReallocation-3651"><span class="linenos">3651</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="PassengerReallocation-3652"><a href="#PassengerReallocation-3652"><span class="linenos">3652</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>  <span class="c1"># self.agent.itinerary_provider_uid</span>
</span><span id="PassengerReallocation-3653"><a href="#PassengerReallocation-3653"><span class="linenos">3653</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span>
</span><span id="PassengerReallocation-3654"><a href="#PassengerReallocation-3654"><span class="linenos">3654</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="PassengerReallocation-3655"><a href="#PassengerReallocation-3655"><span class="linenos">3655</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="PassengerReallocation-3656"><a href="#PassengerReallocation-3656"><span class="linenos">3656</span></a>
</span><span id="PassengerReallocation-3657"><a href="#PassengerReallocation-3657"><span class="linenos">3657</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="PassengerReallocation-3658"><a href="#PassengerReallocation-3658"><span class="linenos">3658</span></a>
</span><span id="PassengerReallocation-3659"><a href="#PassengerReallocation-3659"><span class="linenos">3659</span></a>	<span class="k">def</span> <span class="nf">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation-3660"><a href="#PassengerReallocation-3660"><span class="linenos">3660</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3661"><a href="#PassengerReallocation-3661"><span class="linenos">3661</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="PassengerReallocation-3662"><a href="#PassengerReallocation-3662"><span class="linenos">3662</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3663"><a href="#PassengerReallocation-3663"><span class="linenos">3663</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation-3664"><a href="#PassengerReallocation-3664"><span class="linenos">3664</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3665"><a href="#PassengerReallocation-3665"><span class="linenos">3665</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Old itineraries of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation-3666"><a href="#PassengerReallocation-3666"><span class="linenos">3666</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Newest itinerary of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="PassengerReallocation-3667"><a href="#PassengerReallocation-3667"><span class="linenos">3667</span></a>
</span><span id="PassengerReallocation-3668"><a href="#PassengerReallocation-3668"><span class="linenos">3668</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3669"><a href="#PassengerReallocation-3669"><span class="linenos">3669</span></a>		<span class="c1"># self.agent.env.process(self._remove_pax_from_boarding_list(msg[&#39;body&#39;][&#39;pax&#39;], msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span><span id="PassengerReallocation-3670"><a href="#PassengerReallocation-3670"><span class="linenos">3670</span></a>
</span><span id="PassengerReallocation-3671"><a href="#PassengerReallocation-3671"><span class="linenos">3671</span></a>	<span class="k">def</span> <span class="nf">wait_for_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation-3672"><a href="#PassengerReallocation-3672"><span class="linenos">3672</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3673"><a href="#PassengerReallocation-3673"><span class="linenos">3673</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="PassengerReallocation-3674"><a href="#PassengerReallocation-3674"><span class="linenos">3674</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3675"><a href="#PassengerReallocation-3675"><span class="linenos">3675</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_add_pax_to_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation-3676"><a href="#PassengerReallocation-3676"><span class="linenos">3676</span></a>
</span><span id="PassengerReallocation-3677"><a href="#PassengerReallocation-3677"><span class="linenos">3677</span></a>	<span class="k">def</span> <span class="nf">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation-3678"><a href="#PassengerReallocation-3678"><span class="linenos">3678</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3679"><a href="#PassengerReallocation-3679"><span class="linenos">3679</span></a><span class="sd">		Note: ok with creating a process here? ANSWER: PROBABLY.</span>
</span><span id="PassengerReallocation-3680"><a href="#PassengerReallocation-3680"><span class="linenos">3680</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation-3681"><a href="#PassengerReallocation-3681"><span class="linenos">3681</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from wait_for_reallocation_pax_request for paxs:&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation-3682"><a href="#PassengerReallocation-3682"><span class="linenos">3682</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation-3683"><a href="#PassengerReallocation-3683"><span class="linenos">3683</span></a>		<span class="c1"># self.agent.env.process(self.do_reallocation(msg[&#39;body&#39;][&#39;paxs&#39;]))</span>
</span><span id="PassengerReallocation-3684"><a href="#PassengerReallocation-3684"><span class="linenos">3684</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>PR</p>

<p>Description: Decide how to manage connecting passengers when a flight has left.</p>

<ol>
<li>Check passenger that should have been in the flight that has left and have missed their connection</li>
<li>Rebook them onto following flights to destination, compensate compute_missed_connecting_paxand return them to destination, pay for care, and potentially put them in hotels by checking preferences with passengers.</li>
</ol>
</div>


                            <div id="PassengerReallocation.check_push_back" class="classattr">
                                        <input id="PassengerReallocation.check_push_back-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_push_back</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">push_back_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.check_push_back-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.check_push_back"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.check_push_back-3301"><a href="#PassengerReallocation.check_push_back-3301"><span class="linenos">3301</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="PassengerReallocation.check_push_back-3302"><a href="#PassengerReallocation.check_push_back-3302"><span class="linenos">3302</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="PassengerReallocation.check_push_back-3303"><a href="#PassengerReallocation.check_push_back-3303"><span class="linenos">3303</span></a>
</span><span id="PassengerReallocation.check_push_back-3304"><a href="#PassengerReallocation.check_push_back-3304"><span class="linenos">3304</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="PassengerReallocation.check_push_back-3305"><a href="#PassengerReallocation.check_push_back-3305"><span class="linenos">3305</span></a>			<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_missed_connecting_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.check_push_back-3306"><a href="#PassengerReallocation.check_push_back-3306"><span class="linenos">3306</span></a>
</span><span id="PassengerReallocation.check_push_back-3307"><a href="#PassengerReallocation.check_push_back-3307"><span class="linenos">3307</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from check_push_back of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.check_push_back-3308"><a href="#PassengerReallocation.check_push_back-3308"><span class="linenos">3308</span></a>
</span><span id="PassengerReallocation.check_push_back-3309"><a href="#PassengerReallocation.check_push_back-3309"><span class="linenos">3309</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">paxs</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PassengerReallocation.compute_missed_connecting_pax" class="classattr">
                                        <input id="PassengerReallocation.compute_missed_connecting_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_missed_connecting_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.compute_missed_connecting_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.compute_missed_connecting_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.compute_missed_connecting_pax-3311"><a href="#PassengerReallocation.compute_missed_connecting_pax-3311"><span class="linenos">3311</span></a>	<span class="k">def</span> <span class="nf">compute_missed_connecting_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3312"><a href="#PassengerReallocation.compute_missed_connecting_pax-3312"><span class="linenos">3312</span></a>		<span class="n">pax_needing_reallocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">pax</span> <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3313"><a href="#PassengerReallocation.compute_missed_connecting_pax-3313"><span class="linenos">3313</span></a>									<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3314"><a href="#PassengerReallocation.compute_missed_connecting_pax-3314"><span class="linenos">3314</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_needing_reallocation</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3315"><a href="#PassengerReallocation.compute_missed_connecting_pax-3315"><span class="linenos">3315</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3316"><a href="#PassengerReallocation.compute_missed_connecting_pax-3316"><span class="linenos">3316</span></a>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3317"><a href="#PassengerReallocation.compute_missed_connecting_pax-3317"><span class="linenos">3317</span></a>			<span class="c1"># Check if pax has taken more time than what the airline was expecting</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3318"><a href="#PassengerReallocation.compute_missed_connecting_pax-3318"><span class="linenos">3318</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="o">&gt;</span><span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3319"><a href="#PassengerReallocation.compute_missed_connecting_pax-3319"><span class="linenos">3319</span></a>				<span class="c1"># If so, blame the pax for any compensation</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3320"><a href="#PassengerReallocation.compute_missed_connecting_pax-3320"><span class="linenos">3320</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has taken&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">ct</span><span class="p">,</span> <span class="s1">&#39;as connecting time vs. an MCT of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">mct</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3321"><a href="#PassengerReallocation.compute_missed_connecting_pax-3321"><span class="linenos">3321</span></a>						<span class="s1">&#39;; it blames itself for any future compensation&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3322"><a href="#PassengerReallocation.compute_missed_connecting_pax-3322"><span class="linenos">3322</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="s1">&#39;self&#39;</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3323"><a href="#PassengerReallocation.compute_missed_connecting_pax-3323"><span class="linenos">3323</span></a>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3324"><a href="#PassengerReallocation.compute_missed_connecting_pax-3324"><span class="linenos">3324</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax already at airport left behind by&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">pax_needing_reallocation</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3325"><a href="#PassengerReallocation.compute_missed_connecting_pax-3325"><span class="linenos">3325</span></a>
</span><span id="PassengerReallocation.compute_missed_connecting_pax-3326"><a href="#PassengerReallocation.compute_missed_connecting_pax-3326"><span class="linenos">3326</span></a>		<span class="k">return</span> <span class="n">pax_needing_reallocation</span>
</span></pre></div>


    

                            </div>
                            <div id="PassengerReallocation.compute_reallocation_options" class="classattr">
                                        <input id="PassengerReallocation.compute_reallocation_options-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_reallocation_options</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">from_time</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">from_airport</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.compute_reallocation_options-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.compute_reallocation_options"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.compute_reallocation_options-3328"><a href="#PassengerReallocation.compute_reallocation_options-3328"><span class="linenos">3328</span></a>	<span class="k">def</span> <span class="nf">compute_reallocation_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3329"><a href="#PassengerReallocation.compute_reallocation_options-3329"><span class="linenos">3329</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3330"><a href="#PassengerReallocation.compute_reallocation_options-3330"><span class="linenos">3330</span></a><span class="sd">		Note: only direct flights and flights with one connection</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3331"><a href="#PassengerReallocation.compute_reallocation_options-3331"><span class="linenos">3331</span></a><span class="sd">		are considered.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3332"><a href="#PassengerReallocation.compute_reallocation_options-3332"><span class="linenos">3332</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3333"><a href="#PassengerReallocation.compute_reallocation_options-3333"><span class="linenos">3333</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;compute_reallocation_options&#39;</span><span class="p">):</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3334"><a href="#PassengerReallocation.compute_reallocation_options-3334"><span class="linenos">3334</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3335"><a href="#PassengerReallocation.compute_reallocation_options-3335"><span class="linenos">3335</span></a>			<span class="n">itineraries</span><span class="p">,</span> <span class="n">travelling_times</span><span class="p">,</span> <span class="n">capacities</span><span class="p">,</span> <span class="n">arrival_times</span><span class="p">,</span> <span class="n">departure_times</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3336"><a href="#PassengerReallocation.compute_reallocation_options-3336"><span class="linenos">3336</span></a>			<span class="n">transfer_costs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3337"><a href="#PassengerReallocation.compute_reallocation_options-3337"><span class="linenos">3337</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3338"><a href="#PassengerReallocation.compute_reallocation_options-3338"><span class="linenos">3338</span></a>			<span class="c1"># List of outbound flights of the current airports departing after now.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3339"><a href="#PassengerReallocation.compute_reallocation_options-3339"><span class="linenos">3339</span></a>			<span class="c1"># Added +1 in the now below to be sure that the pax does not select a flight which is departing</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3340"><a href="#PassengerReallocation.compute_reallocation_options-3340"><span class="linenos">3340</span></a>			<span class="c1"># now (like the one it missed).</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3341"><a href="#PassengerReallocation.compute_reallocation_options-3341"><span class="linenos">3341</span></a>			<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3342"><a href="#PassengerReallocation.compute_reallocation_options-3342"><span class="linenos">3342</span></a>										<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">from_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3343"><a href="#PassengerReallocation.compute_reallocation_options-3343"><span class="linenos">3343</span></a>										<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3344"><a href="#PassengerReallocation.compute_reallocation_options-3344"><span class="linenos">3344</span></a>										<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3345"><a href="#PassengerReallocation.compute_reallocation_options-3345"><span class="linenos">3345</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3346"><a href="#PassengerReallocation.compute_reallocation_options-3346"><span class="linenos">3346</span></a>			<span class="c1"># First select direct itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3347"><a href="#PassengerReallocation.compute_reallocation_options-3347"><span class="linenos">3347</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3348"><a href="#PassengerReallocation.compute_reallocation_options-3348"><span class="linenos">3348</span></a>											<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3349"><a href="#PassengerReallocation.compute_reallocation_options-3349"><span class="linenos">3349</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3350"><a href="#PassengerReallocation.compute_reallocation_options-3350"><span class="linenos">3350</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3351"><a href="#PassengerReallocation.compute_reallocation_options-3351"><span class="linenos">3351</span></a>			<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3352"><a href="#PassengerReallocation.compute_reallocation_options-3352"><span class="linenos">3352</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3353"><a href="#PassengerReallocation.compute_reallocation_options-3353"><span class="linenos">3353</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3354"><a href="#PassengerReallocation.compute_reallocation_options-3354"><span class="linenos">3354</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3355"><a href="#PassengerReallocation.compute_reallocation_options-3355"><span class="linenos">3355</span></a>			<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3356"><a href="#PassengerReallocation.compute_reallocation_options-3356"><span class="linenos">3356</span></a>			<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3357"><a href="#PassengerReallocation.compute_reallocation_options-3357"><span class="linenos">3357</span></a>			<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3358"><a href="#PassengerReallocation.compute_reallocation_options-3358"><span class="linenos">3358</span></a>			<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3359"><a href="#PassengerReallocation.compute_reallocation_options-3359"><span class="linenos">3359</span></a>			<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3360"><a href="#PassengerReallocation.compute_reallocation_options-3360"><span class="linenos">3360</span></a>			<span class="c1"># aprint(&#39;capacity:&#39;, sum(capacities))</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3361"><a href="#PassengerReallocation.compute_reallocation_options-3361"><span class="linenos">3361</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3362"><a href="#PassengerReallocation.compute_reallocation_options-3362"><span class="linenos">3362</span></a>				<span class="c1"># Then search indirect itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3363"><a href="#PassengerReallocation.compute_reallocation_options-3363"><span class="linenos">3363</span></a>				<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3364"><a href="#PassengerReallocation.compute_reallocation_options-3364"><span class="linenos">3364</span></a>				<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[</span><span class="n">flight_uid</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">flight_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3365"><a href="#PassengerReallocation.compute_reallocation_options-3365"><span class="linenos">3365</span></a>											<span class="k">if</span> <span class="p">(</span><span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3366"><a href="#PassengerReallocation.compute_reallocation_options-3366"><span class="linenos">3366</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3367"><a href="#PassengerReallocation.compute_reallocation_options-3367"><span class="linenos">3367</span></a>											<span class="ow">and</span> <span class="n">flight_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3368"><a href="#PassengerReallocation.compute_reallocation_options-3368"><span class="linenos">3368</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3369"><a href="#PassengerReallocation.compute_reallocation_options-3369"><span class="linenos">3369</span></a>				<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3370"><a href="#PassengerReallocation.compute_reallocation_options-3370"><span class="linenos">3370</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3371"><a href="#PassengerReallocation.compute_reallocation_options-3371"><span class="linenos">3371</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span> <span class="k">for</span> <span class="n">f1</span> <span class="ow">in</span> <span class="n">outbound_flights</span> <span class="k">for</span> <span class="n">f2</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3372"><a href="#PassengerReallocation.compute_reallocation_options-3372"><span class="linenos">3372</span></a>											<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;origin_airport_uid&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3373"><a href="#PassengerReallocation.compute_reallocation_options-3373"><span class="linenos">3373</span></a>											<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3374"><a href="#PassengerReallocation.compute_reallocation_options-3374"><span class="linenos">3374</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f1</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3375"><a href="#PassengerReallocation.compute_reallocation_options-3375"><span class="linenos">3375</span></a>											<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">f2</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3376"><a href="#PassengerReallocation.compute_reallocation_options-3376"><span class="linenos">3376</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3377"><a href="#PassengerReallocation.compute_reallocation_options-3377"><span class="linenos">3377</span></a>				<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3378"><a href="#PassengerReallocation.compute_reallocation_options-3378"><span class="linenos">3378</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3379"><a href="#PassengerReallocation.compute_reallocation_options-3379"><span class="linenos">3379</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential indirect flights:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3380"><a href="#PassengerReallocation.compute_reallocation_options-3380"><span class="linenos">3380</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3381"><a href="#PassengerReallocation.compute_reallocation_options-3381"><span class="linenos">3381</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3382"><a href="#PassengerReallocation.compute_reallocation_options-3382"><span class="linenos">3382</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3383"><a href="#PassengerReallocation.compute_reallocation_options-3383"><span class="linenos">3383</span></a>				<span class="n">travelling_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3384"><a href="#PassengerReallocation.compute_reallocation_options-3384"><span class="linenos">3384</span></a>				<span class="n">arrival_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3385"><a href="#PassengerReallocation.compute_reallocation_options-3385"><span class="linenos">3385</span></a>				<span class="n">departure_times</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3386"><a href="#PassengerReallocation.compute_reallocation_options-3386"><span class="linenos">3386</span></a>				<span class="c1"># aprint(&#39;capacity:&#39;, sum(self.capacities))</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3387"><a href="#PassengerReallocation.compute_reallocation_options-3387"><span class="linenos">3387</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3388"><a href="#PassengerReallocation.compute_reallocation_options-3388"><span class="linenos">3388</span></a>			<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3389"><a href="#PassengerReallocation.compute_reallocation_options-3389"><span class="linenos">3389</span></a>			<span class="c1"># capacity_functions += [self.agent.get_number_seats_itinerary]*len(itineraries)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3390"><a href="#PassengerReallocation.compute_reallocation_options-3390"><span class="linenos">3390</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3391"><a href="#PassengerReallocation.compute_reallocation_options-3391"><span class="linenos">3391</span></a>			<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3392"><a href="#PassengerReallocation.compute_reallocation_options-3392"><span class="linenos">3392</span></a>				<span class="c1"># Look for itineraries within alliance and outside of alliance.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3393"><a href="#PassengerReallocation.compute_reallocation_options-3393"><span class="linenos">3393</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3394"><a href="#PassengerReallocation.compute_reallocation_options-3394"><span class="linenos">3394</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;looks for more itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3395"><a href="#PassengerReallocation.compute_reallocation_options-3395"><span class="linenos">3395</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3396"><a href="#PassengerReallocation.compute_reallocation_options-3396"><span class="linenos">3396</span></a>				<span class="n">capacity_needed</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3397"><a href="#PassengerReallocation.compute_reallocation_options-3397"><span class="linenos">3397</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3398"><a href="#PassengerReallocation.compute_reallocation_options-3398"><span class="linenos">3398</span></a>				<span class="c1"># First try intra-alliance itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3399"><a href="#PassengerReallocation.compute_reallocation_options-3399"><span class="linenos">3399</span></a>				<span class="c1"># Outbound flights (including the initial airline&#39;s)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3400"><a href="#PassengerReallocation.compute_reallocation_options-3400"><span class="linenos">3400</span></a>				<span class="n">outbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>  <span class="c1"># self.airlines[aoc_uid2][&#39;aoc&#39;])</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3401"><a href="#PassengerReallocation.compute_reallocation_options-3401"><span class="linenos">3401</span></a>										<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3402"><a href="#PassengerReallocation.compute_reallocation_options-3402"><span class="linenos">3402</span></a>											<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3403"><a href="#PassengerReallocation.compute_reallocation_options-3403"><span class="linenos">3403</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3404"><a href="#PassengerReallocation.compute_reallocation_options-3404"><span class="linenos">3404</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">from_time</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3405"><a href="#PassengerReallocation.compute_reallocation_options-3405"><span class="linenos">3405</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3406"><a href="#PassengerReallocation.compute_reallocation_options-3406"><span class="linenos">3406</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3407"><a href="#PassengerReallocation.compute_reallocation_options-3407"><span class="linenos">3407</span></a>				<span class="c1"># Select direct flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3408"><a href="#PassengerReallocation.compute_reallocation_options-3408"><span class="linenos">3408</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">)</span> <span class="k">for</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3409"><a href="#PassengerReallocation.compute_reallocation_options-3409"><span class="linenos">3409</span></a>												<span class="k">if</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3410"><a href="#PassengerReallocation.compute_reallocation_options-3410"><span class="linenos">3410</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3411"><a href="#PassengerReallocation.compute_reallocation_options-3411"><span class="linenos">3411</span></a>				<span class="n">direct_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">direct_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3412"><a href="#PassengerReallocation.compute_reallocation_options-3412"><span class="linenos">3412</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3413"><a href="#PassengerReallocation.compute_reallocation_options-3413"><span class="linenos">3413</span></a>				<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">direct_itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3414"><a href="#PassengerReallocation.compute_reallocation_options-3414"><span class="linenos">3414</span></a>				<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">direct_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3415"><a href="#PassengerReallocation.compute_reallocation_options-3415"><span class="linenos">3415</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance direct flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">direct_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3416"><a href="#PassengerReallocation.compute_reallocation_options-3416"><span class="linenos">3416</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3417"><a href="#PassengerReallocation.compute_reallocation_options-3417"><span class="linenos">3417</span></a>				<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">direct_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3418"><a href="#PassengerReallocation.compute_reallocation_options-3418"><span class="linenos">3418</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3419"><a href="#PassengerReallocation.compute_reallocation_options-3419"><span class="linenos">3419</span></a>				<span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3420"><a href="#PassengerReallocation.compute_reallocation_options-3420"><span class="linenos">3420</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3421"><a href="#PassengerReallocation.compute_reallocation_options-3421"><span class="linenos">3421</span></a>					<span class="c1"># Search indirect flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3422"><a href="#PassengerReallocation.compute_reallocation_options-3422"><span class="linenos">3422</span></a>					<span class="c1"># List of inbound flights of the final destination departing after now.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3423"><a href="#PassengerReallocation.compute_reallocation_options-3423"><span class="linenos">3423</span></a>					<span class="n">inbound_flights</span> <span class="o">=</span> <span class="p">[(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3424"><a href="#PassengerReallocation.compute_reallocation_options-3424"><span class="linenos">3424</span></a>											<span class="k">for</span> <span class="n">aoc_uid2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">()</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3425"><a href="#PassengerReallocation.compute_reallocation_options-3425"><span class="linenos">3425</span></a>											 <span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc_uid2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3426"><a href="#PassengerReallocation.compute_reallocation_options-3426"><span class="linenos">3426</span></a>												<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3427"><a href="#PassengerReallocation.compute_reallocation_options-3427"><span class="linenos">3427</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3428"><a href="#PassengerReallocation.compute_reallocation_options-3428"><span class="linenos">3428</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3429"><a href="#PassengerReallocation.compute_reallocation_options-3429"><span class="linenos">3429</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3430"><a href="#PassengerReallocation.compute_reallocation_options-3430"><span class="linenos">3430</span></a>					<span class="c1"># Select the pairs for which the inbound flight obt is later than the outbound flight&#39;s arrival</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3431"><a href="#PassengerReallocation.compute_reallocation_options-3431"><span class="linenos">3431</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span><span class="p">),</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">))</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3432"><a href="#PassengerReallocation.compute_reallocation_options-3432"><span class="linenos">3432</span></a>												<span class="k">for</span> <span class="n">f1</span><span class="p">,</span> <span class="n">aoc1_uid</span> <span class="ow">in</span> <span class="n">outbound_flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3433"><a href="#PassengerReallocation.compute_reallocation_options-3433"><span class="linenos">3433</span></a>												<span class="k">for</span> <span class="n">f2</span><span class="p">,</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="n">inbound_flights</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3434"><a href="#PassengerReallocation.compute_reallocation_options-3434"><span class="linenos">3434</span></a>												<span class="k">if</span> <span class="p">((</span><span class="n">aoc1_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">aoc2_uid</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span><span class="p">))</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3435"><a href="#PassengerReallocation.compute_reallocation_options-3435"><span class="linenos">3435</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3436"><a href="#PassengerReallocation.compute_reallocation_options-3436"><span class="linenos">3436</span></a>												<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_mct</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3437"><a href="#PassengerReallocation.compute_reallocation_options-3437"><span class="linenos">3437</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3438"><a href="#PassengerReallocation.compute_reallocation_options-3438"><span class="linenos">3438</span></a>												<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">f2</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3439"><a href="#PassengerReallocation.compute_reallocation_options-3439"><span class="linenos">3439</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3440"><a href="#PassengerReallocation.compute_reallocation_options-3440"><span class="linenos">3440</span></a>					<span class="n">indirect_itineraries</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3441"><a href="#PassengerReallocation.compute_reallocation_options-3441"><span class="linenos">3441</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3442"><a href="#PassengerReallocation.compute_reallocation_options-3442"><span class="linenos">3442</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential intra-alliance indirect flights for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3443"><a href="#PassengerReallocation.compute_reallocation_options-3443"><span class="linenos">3443</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3444"><a href="#PassengerReallocation.compute_reallocation_options-3444"><span class="linenos">3444</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3445"><a href="#PassengerReallocation.compute_reallocation_options-3445"><span class="linenos">3445</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3446"><a href="#PassengerReallocation.compute_reallocation_options-3446"><span class="linenos">3446</span></a>					<span class="n">transfer_costs</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">indirect_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3447"><a href="#PassengerReallocation.compute_reallocation_options-3447"><span class="linenos">3447</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3448"><a href="#PassengerReallocation.compute_reallocation_options-3448"><span class="linenos">3448</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3449"><a href="#PassengerReallocation.compute_reallocation_options-3449"><span class="linenos">3449</span></a>				<span class="k">if</span> <span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">pax_type</span> <span class="o">==</span> <span class="s1">&#39;flex&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">capacities</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">capacity_needed</span><span class="p">):</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3450"><a href="#PassengerReallocation.compute_reallocation_options-3450"><span class="linenos">3450</span></a>					<span class="c1"># Try airlines outside of alliance. Check only direct flights. Compute the price of rebooking.</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3451"><a href="#PassengerReallocation.compute_reallocation_options-3451"><span class="linenos">3451</span></a>					<span class="n">indirect_outside_itineraries</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3452"><a href="#PassengerReallocation.compute_reallocation_options-3452"><span class="linenos">3452</span></a>					<span class="k">for</span> <span class="n">aoc2_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_all_airlines</span><span class="p">():</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3453"><a href="#PassengerReallocation.compute_reallocation_options-3453"><span class="linenos">3453</span></a>						<span class="k">if</span> <span class="n">aoc2_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airlines_in_alliance</span><span class="p">():</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3454"><a href="#PassengerReallocation.compute_reallocation_options-3454"><span class="linenos">3454</span></a>							<span class="c1"># for flight_uid, flight_info in self.airlines[aoc2_uid][&#39;aoc&#39;].aoc_flights_info.items():</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3455"><a href="#PassengerReallocation.compute_reallocation_options-3455"><span class="linenos">3455</span></a>							<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_flights</span><span class="p">(</span><span class="n">aoc2_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3456"><a href="#PassengerReallocation.compute_reallocation_options-3456"><span class="linenos">3456</span></a>								<span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_origin</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">from_airport</span><span class="p">)</span>\
</span><span id="PassengerReallocation.compute_reallocation_options-3457"><a href="#PassengerReallocation.compute_reallocation_options-3457"><span class="linenos">3457</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_uid</span><span class="p">)</span>\
</span><span id="PassengerReallocation.compute_reallocation_options-3458"><a href="#PassengerReallocation.compute_reallocation_options-3458"><span class="linenos">3458</span></a>									<span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">from_time</span><span class="p">)</span>\
</span><span id="PassengerReallocation.compute_reallocation_options-3459"><a href="#PassengerReallocation.compute_reallocation_options-3459"><span class="linenos">3459</span></a>									<span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3460"><a href="#PassengerReallocation.compute_reallocation_options-3460"><span class="linenos">3460</span></a>										<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3461"><a href="#PassengerReallocation.compute_reallocation_options-3461"><span class="linenos">3461</span></a>											<span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_average_price_on_leg</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3462"><a href="#PassengerReallocation.compute_reallocation_options-3462"><span class="linenos">3462</span></a>											<span class="n">indirect_outside_itineraries</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">aoc2_uid</span><span class="p">),</span> <span class="p">))</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3463"><a href="#PassengerReallocation.compute_reallocation_options-3463"><span class="linenos">3463</span></a>											<span class="n">transfer_costs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3464"><a href="#PassengerReallocation.compute_reallocation_options-3464"><span class="linenos">3464</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3465"><a href="#PassengerReallocation.compute_reallocation_options-3465"><span class="linenos">3465</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Potential direct flights outside of alliance for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">indirect_outside_itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3466"><a href="#PassengerReallocation.compute_reallocation_options-3466"><span class="linenos">3466</span></a>						<span class="s1">&#39;with capacities:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3467"><a href="#PassengerReallocation.compute_reallocation_options-3467"><span class="linenos">3467</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3468"><a href="#PassengerReallocation.compute_reallocation_options-3468"><span class="linenos">3468</span></a>					<span class="n">itineraries</span> <span class="o">+=</span> <span class="n">indirect_outside_itineraries</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3469"><a href="#PassengerReallocation.compute_reallocation_options-3469"><span class="linenos">3469</span></a>					<span class="n">capacities</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">(</span><span class="n">itinerary</span><span class="p">)</span> <span class="k">for</span> <span class="n">itinerary</span> <span class="ow">in</span> <span class="n">indirect_outside_itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3470"><a href="#PassengerReallocation.compute_reallocation_options-3470"><span class="linenos">3470</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3471"><a href="#PassengerReallocation.compute_reallocation_options-3471"><span class="linenos">3471</span></a>				<span class="n">travelling_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_total_travelling_time</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3472"><a href="#PassengerReallocation.compute_reallocation_options-3472"><span class="linenos">3472</span></a>				<span class="n">arrival_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_last_ibt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3473"><a href="#PassengerReallocation.compute_reallocation_options-3473"><span class="linenos">3473</span></a>				<span class="n">departure_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_first_obt</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">itineraries</span><span class="p">]</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3474"><a href="#PassengerReallocation.compute_reallocation_options-3474"><span class="linenos">3474</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3475"><a href="#PassengerReallocation.compute_reallocation_options-3475"><span class="linenos">3475</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;computes reallocation options for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3476"><a href="#PassengerReallocation.compute_reallocation_options-3476"><span class="linenos">3476</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3477"><a href="#PassengerReallocation.compute_reallocation_options-3477"><span class="linenos">3477</span></a>			<span class="n">capacity_functions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_number_seats_itinerary</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3478"><a href="#PassengerReallocation.compute_reallocation_options-3478"><span class="linenos">3478</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3479"><a href="#PassengerReallocation.compute_reallocation_options-3479"><span class="linenos">3479</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;itineraries&#39;</span><span class="p">:</span> <span class="n">itineraries</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3480"><a href="#PassengerReallocation.compute_reallocation_options-3480"><span class="linenos">3480</span></a>									<span class="s1">&#39;capacities&#39;</span><span class="p">:</span> <span class="n">capacities</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3481"><a href="#PassengerReallocation.compute_reallocation_options-3481"><span class="linenos">3481</span></a>									<span class="s1">&#39;travelling_times&#39;</span><span class="p">:</span> <span class="n">travelling_times</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3482"><a href="#PassengerReallocation.compute_reallocation_options-3482"><span class="linenos">3482</span></a>									<span class="s1">&#39;transfer_costs&#39;</span><span class="p">:</span> <span class="n">transfer_costs</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3483"><a href="#PassengerReallocation.compute_reallocation_options-3483"><span class="linenos">3483</span></a>									<span class="s1">&#39;arrival_times&#39;</span><span class="p">:</span> <span class="n">arrival_times</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3484"><a href="#PassengerReallocation.compute_reallocation_options-3484"><span class="linenos">3484</span></a>									<span class="s1">&#39;departure_times&#39;</span><span class="p">:</span> <span class="n">departure_times</span><span class="p">,</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3485"><a href="#PassengerReallocation.compute_reallocation_options-3485"><span class="linenos">3485</span></a>									<span class="s1">&#39;capacity_functions&#39;</span><span class="p">:</span> <span class="n">capacity_functions</span><span class="p">}</span>
</span><span id="PassengerReallocation.compute_reallocation_options-3486"><a href="#PassengerReallocation.compute_reallocation_options-3486"><span class="linenos">3486</span></a>
</span><span id="PassengerReallocation.compute_reallocation_options-3487"><a href="#PassengerReallocation.compute_reallocation_options-3487"><span class="linenos">3487</span></a>		<span class="k">return</span> <span class="n">reallocation_options</span>
</span></pre></div>


            <div class="docstring"><p>Note: only direct flights and flights with one connection
are considered.</p>
</div>


                            </div>
                            <div id="PassengerReallocation.do_reallocation" class="classattr">
                                        <input id="PassengerReallocation.do_reallocation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_reallocation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paxs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.do_reallocation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.do_reallocation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.do_reallocation-3489"><a href="#PassengerReallocation.do_reallocation-3489"><span class="linenos">3489</span></a>	<span class="k">def</span> <span class="nf">do_reallocation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="PassengerReallocation.do_reallocation-3490"><a href="#PassengerReallocation.do_reallocation-3490"><span class="linenos">3490</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.do_reallocation-3491"><a href="#PassengerReallocation.do_reallocation-3491"><span class="linenos">3491</span></a><span class="sd">		Note: I added that to have processes to wait for answer from itinerary provider.</span>
</span><span id="PassengerReallocation.do_reallocation-3492"><a href="#PassengerReallocation.do_reallocation-3492"><span class="linenos">3492</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.do_reallocation-3493"><a href="#PassengerReallocation.do_reallocation-3493"><span class="linenos">3493</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="PassengerReallocation.do_reallocation-3494"><a href="#PassengerReallocation.do_reallocation-3494"><span class="linenos">3494</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3495"><a href="#PassengerReallocation.do_reallocation-3495"><span class="linenos">3495</span></a>			<span class="n">reallocation_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_reallocation_options</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">from_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">from_airport</span><span class="o">=</span><span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3496"><a href="#PassengerReallocation.do_reallocation-3496"><span class="linenos">3496</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Options for reallocation for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation.do_reallocation-3497"><a href="#PassengerReallocation.do_reallocation-3497"><span class="linenos">3497</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Capacities of pot. new itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation.do_reallocation-3498"><a href="#PassengerReallocation.do_reallocation-3498"><span class="linenos">3498</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation.do_reallocation-3499"><a href="#PassengerReallocation.do_reallocation-3499"><span class="linenos">3499</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">reallocate_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3500"><a href="#PassengerReallocation.do_reallocation-3500"><span class="linenos">3500</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation.do_reallocation-3501"><a href="#PassengerReallocation.do_reallocation-3501"><span class="linenos">3501</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;could not find any other itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3502"><a href="#PassengerReallocation.do_reallocation-3502"><span class="linenos">3502</span></a>				<span class="c1"># Remove passengers from boarding lists of all remaining flights.</span>
</span><span id="PassengerReallocation.do_reallocation-3503"><a href="#PassengerReallocation.do_reallocation-3503"><span class="linenos">3503</span></a>				<span class="k">for</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flights</span><span class="p">():</span>
</span><span id="PassengerReallocation.do_reallocation-3504"><a href="#PassengerReallocation.do_reallocation-3504"><span class="linenos">3504</span></a>					<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="PassengerReallocation.do_reallocation-3505"><a href="#PassengerReallocation.do_reallocation-3505"><span class="linenos">3505</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3506"><a href="#PassengerReallocation.do_reallocation-3506"><span class="linenos">3506</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation.do_reallocation-3507"><a href="#PassengerReallocation.do_reallocation-3507"><span class="linenos">3507</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">)</span>
</span><span id="PassengerReallocation.do_reallocation-3508"><a href="#PassengerReallocation.do_reallocation-3508"><span class="linenos">3508</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note: I added that to have processes to wait for answer from itinerary provider.</p>
</div>


                            </div>
                            <div id="PassengerReallocation.reallocate_pax" class="classattr">
                                        <input id="PassengerReallocation.reallocate_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reallocate_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">reallocation_options</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.reallocate_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.reallocate_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.reallocate_pax-3522"><a href="#PassengerReallocation.reallocate_pax-3522"><span class="linenos">3522</span></a>	<span class="k">def</span> <span class="nf">reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">):</span>
</span><span id="PassengerReallocation.reallocate_pax-3523"><a href="#PassengerReallocation.reallocate_pax-3523"><span class="linenos">3523</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.reallocate_pax-3524"><a href="#PassengerReallocation.reallocate_pax-3524"><span class="linenos">3524</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.reallocate_pax-3525"><a href="#PassengerReallocation.reallocate_pax-3525"><span class="linenos">3525</span></a>		<span class="c1"># Reallocate passengers</span>
</span><span id="PassengerReallocation.reallocate_pax-3526"><a href="#PassengerReallocation.reallocate_pax-3526"><span class="linenos">3526</span></a>		<span class="c1"># For duty of care, take only into account current wait</span>
</span><span id="PassengerReallocation.reallocate_pax-3527"><a href="#PassengerReallocation.reallocate_pax-3527"><span class="linenos">3527</span></a>		<span class="n">soft_cost_pp</span><span class="p">,</span> <span class="n">transfer_costs_pp</span><span class="p">,</span> <span class="n">compensation_costs_pp</span><span class="p">,</span> <span class="n">doc_costs_pp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cost_of_itineraries_pp</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">reallocation_options</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3528"><a href="#PassengerReallocation.reallocate_pax-3528"><span class="linenos">3528</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3529"><a href="#PassengerReallocation.reallocate_pax-3529"><span class="linenos">3529</span></a>		<span class="n">total_cost_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span> <span class="o">+</span> <span class="n">soft_cost_pp</span> <span class="o">+</span> <span class="n">compensation_costs_pp</span> <span class="o">+</span> <span class="n">doc_costs_pp</span>
</span><span id="PassengerReallocation.reallocate_pax-3530"><a href="#PassengerReallocation.reallocate_pax-3530"><span class="linenos">3530</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3531"><a href="#PassengerReallocation.reallocate_pax-3531"><span class="linenos">3531</span></a>		<span class="c1"># Sort options</span>
</span><span id="PassengerReallocation.reallocate_pax-3532"><a href="#PassengerReallocation.reallocate_pax-3532"><span class="linenos">3532</span></a>		<span class="n">idx_ranked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">total_cost_pp</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3533"><a href="#PassengerReallocation.reallocate_pax-3533"><span class="linenos">3533</span></a>		<span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;itineraries&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation.reallocate_pax-3534"><a href="#PassengerReallocation.reallocate_pax-3534"><span class="linenos">3534</span></a>		<span class="n">capacities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacities&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>  <span class="c1"># These are theoretical capacities!</span>
</span><span id="PassengerReallocation.reallocate_pax-3535"><a href="#PassengerReallocation.reallocate_pax-3535"><span class="linenos">3535</span></a>		<span class="n">transfer_costs_pp</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation.reallocate_pax-3536"><a href="#PassengerReallocation.reallocate_pax-3536"><span class="linenos">3536</span></a>		<span class="n">capacity_functions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reallocation_options</span><span class="p">[</span><span class="s1">&#39;capacity_functions&#39;</span><span class="p">])[</span><span class="n">idx_ranked</span><span class="p">]</span>
</span><span id="PassengerReallocation.reallocate_pax-3537"><a href="#PassengerReallocation.reallocate_pax-3537"><span class="linenos">3537</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3538"><a href="#PassengerReallocation.reallocate_pax-3538"><span class="linenos">3538</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked itineraries for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3539"><a href="#PassengerReallocation.reallocate_pax-3539"><span class="linenos">3539</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Ranked capacities for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3540"><a href="#PassengerReallocation.reallocate_pax-3540"><span class="linenos">3540</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3541"><a href="#PassengerReallocation.reallocate_pax-3541"><span class="linenos">3541</span></a>		<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="PassengerReallocation.reallocate_pax-3542"><a href="#PassengerReallocation.reallocate_pax-3542"><span class="linenos">3542</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3543"><a href="#PassengerReallocation.reallocate_pax-3543"><span class="linenos">3543</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;reallocates&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3544"><a href="#PassengerReallocation.reallocate_pax-3544"><span class="linenos">3544</span></a>		<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PassengerReallocation.reallocate_pax-3545"><a href="#PassengerReallocation.reallocate_pax-3545"><span class="linenos">3545</span></a>		<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)):</span>
</span><span id="PassengerReallocation.reallocate_pax-3546"><a href="#PassengerReallocation.reallocate_pax-3546"><span class="linenos">3546</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; before update:&#39;</span><span class="p">,</span> <span class="n">capacities</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3547"><a href="#PassengerReallocation.reallocate_pax-3547"><span class="linenos">3547</span></a>			<span class="n">available_seats</span> <span class="o">=</span> <span class="n">capacity_functions</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># self.agent.get_number_seats_itinerary(options[i])</span>
</span><span id="PassengerReallocation.reallocate_pax-3548"><a href="#PassengerReallocation.reallocate_pax-3548"><span class="linenos">3548</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Available seats for itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39; after update:&#39;</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3549"><a href="#PassengerReallocation.reallocate_pax-3549"><span class="linenos">3549</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3550"><a href="#PassengerReallocation.reallocate_pax-3550"><span class="linenos">3550</span></a>			<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3551"><a href="#PassengerReallocation.reallocate_pax-3551"><span class="linenos">3551</span></a>				<span class="k">if</span> <span class="n">available_seats</span> <span class="o">&gt;=</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3552"><a href="#PassengerReallocation.reallocate_pax-3552"><span class="linenos">3552</span></a>					<span class="c1"># All remaining passengers can be fitted into this itinerary</span>
</span><span id="PassengerReallocation.reallocate_pax-3553"><a href="#PassengerReallocation.reallocate_pax-3553"><span class="linenos">3553</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Putting all remaining pax in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;in itinerary&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="PassengerReallocation.reallocate_pax-3554"><a href="#PassengerReallocation.reallocate_pax-3554"><span class="linenos">3554</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">pax</span>
</span><span id="PassengerReallocation.reallocate_pax-3555"><a href="#PassengerReallocation.reallocate_pax-3555"><span class="linenos">3555</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="PassengerReallocation.reallocate_pax-3556"><a href="#PassengerReallocation.reallocate_pax-3556"><span class="linenos">3556</span></a>					<span class="n">everyone_allocated</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PassengerReallocation.reallocate_pax-3557"><a href="#PassengerReallocation.reallocate_pax-3557"><span class="linenos">3557</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3558"><a href="#PassengerReallocation.reallocate_pax-3558"><span class="linenos">3558</span></a>					<span class="c1"># Split passengers</span>
</span><span id="PassengerReallocation.reallocate_pax-3559"><a href="#PassengerReallocation.reallocate_pax-3559"><span class="linenos">3559</span></a>					<span class="n">new_pax</span> <span class="o">=</span> <span class="n">clone_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">available_seats</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3560"><a href="#PassengerReallocation.reallocate_pax-3560"><span class="linenos">3560</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">new_paxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3561"><a href="#PassengerReallocation.reallocate_pax-3561"><span class="linenos">3561</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span> <span class="o">-=</span> <span class="n">available_seats</span>
</span><span id="PassengerReallocation.reallocate_pax-3562"><a href="#PassengerReallocation.reallocate_pax-3562"><span class="linenos">3562</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Splitting pax. New clone of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="n">new_pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3563"><a href="#PassengerReallocation.reallocate_pax-3563"><span class="linenos">3563</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Remaining pax:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">n_pax</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3564"><a href="#PassengerReallocation.reallocate_pax-3564"><span class="linenos">3564</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3565"><a href="#PassengerReallocation.reallocate_pax-3565"><span class="linenos">3565</span></a>					<span class="n">pax_to_consider</span> <span class="o">=</span> <span class="n">new_pax</span>
</span><span id="PassengerReallocation.reallocate_pax-3566"><a href="#PassengerReallocation.reallocate_pax-3566"><span class="linenos">3566</span></a>					<span class="n">new</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="PassengerReallocation.reallocate_pax-3567"><a href="#PassengerReallocation.reallocate_pax-3567"><span class="linenos">3567</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3568"><a href="#PassengerReallocation.reallocate_pax-3568"><span class="linenos">3568</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_reallocate_pax_to_itinerary</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new</span><span class="o">=</span><span class="n">new</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3569"><a href="#PassengerReallocation.reallocate_pax-3569"><span class="linenos">3569</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3570"><a href="#PassengerReallocation.reallocate_pax-3570"><span class="linenos">3570</span></a>				<span class="k">if</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3571"><a href="#PassengerReallocation.reallocate_pax-3571"><span class="linenos">3571</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="s1">&#39;now blames transfer costs on flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3572"><a href="#PassengerReallocation.reallocate_pax-3572"><span class="linenos">3572</span></a>					<span class="n">pax_to_consider</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span> <span class="o">=</span> <span class="n">last_flight</span>
</span><span id="PassengerReallocation.reallocate_pax-3573"><a href="#PassengerReallocation.reallocate_pax-3573"><span class="linenos">3573</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3574"><a href="#PassengerReallocation.reallocate_pax-3574"><span class="linenos">3574</span></a>				<span class="n">transfer_cost</span> <span class="o">=</span> <span class="n">transfer_costs_pp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">pax_to_consider</span><span class="o">.</span><span class="n">n_pax</span>
</span><span id="PassengerReallocation.reallocate_pax-3575"><a href="#PassengerReallocation.reallocate_pax-3575"><span class="linenos">3575</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax_to_consider</span><span class="p">,</span> <span class="n">transfer_cost</span><span class="p">,</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3576"><a href="#PassengerReallocation.reallocate_pax-3576"><span class="linenos">3576</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3577"><a href="#PassengerReallocation.reallocate_pax-3577"><span class="linenos">3577</span></a>				<span class="k">if</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3578"><a href="#PassengerReallocation.reallocate_pax-3578"><span class="linenos">3578</span></a>					<span class="k">break</span>
</span><span id="PassengerReallocation.reallocate_pax-3579"><a href="#PassengerReallocation.reallocate_pax-3579"><span class="linenos">3579</span></a>
</span><span id="PassengerReallocation.reallocate_pax-3580"><a href="#PassengerReallocation.reallocate_pax-3580"><span class="linenos">3580</span></a>		<span class="c1"># If some passengers are remaining, maybe they could be reallocated in</span>
</span><span id="PassengerReallocation.reallocate_pax-3581"><a href="#PassengerReallocation.reallocate_pax-3581"><span class="linenos">3581</span></a>		<span class="c1"># further, so redo a round</span>
</span><span id="PassengerReallocation.reallocate_pax-3582"><a href="#PassengerReallocation.reallocate_pax-3582"><span class="linenos">3582</span></a>		<span class="k">if</span> <span class="ow">not</span> <span class="n">everyone_allocated</span><span class="p">:</span>
</span><span id="PassengerReallocation.reallocate_pax-3583"><a href="#PassengerReallocation.reallocate_pax-3583"><span class="linenos">3583</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;No more capacity for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;, so&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;retries a complete recomputation of itineraries&#39;</span><span class="p">)</span>
</span><span id="PassengerReallocation.reallocate_pax-3584"><a href="#PassengerReallocation.reallocate_pax-3584"><span class="linenos">3584</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">([</span><span class="n">pax</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="PassengerReallocation.send_allocation_pax_request" class="classattr">
                                        <input id="PassengerReallocation.send_allocation_pax_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_allocation_pax_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">aoc_uid</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.send_allocation_pax_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.send_allocation_pax_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.send_allocation_pax_request-3635"><a href="#PassengerReallocation.send_allocation_pax_request-3635"><span class="linenos">3635</span></a>	<span class="k">def</span> <span class="nf">send_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3636"><a href="#PassengerReallocation.send_allocation_pax_request-3636"><span class="linenos">3636</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3637"><a href="#PassengerReallocation.send_allocation_pax_request-3637"><span class="linenos">3637</span></a><span class="sd">		Used to ask another airline to put a pax group on the list of</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3638"><a href="#PassengerReallocation.send_allocation_pax_request-3638"><span class="linenos">3638</span></a><span class="sd">		pax to board.</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3639"><a href="#PassengerReallocation.send_allocation_pax_request-3639"><span class="linenos">3639</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3640"><a href="#PassengerReallocation.send_allocation_pax_request-3640"><span class="linenos">3640</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3641"><a href="#PassengerReallocation.send_allocation_pax_request-3641"><span class="linenos">3641</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3642"><a href="#PassengerReallocation.send_allocation_pax_request-3642"><span class="linenos">3642</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;allocation_pax_request&#39;</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3643"><a href="#PassengerReallocation.send_allocation_pax_request-3643"><span class="linenos">3643</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3644"><a href="#PassengerReallocation.send_allocation_pax_request-3644"><span class="linenos">3644</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="PassengerReallocation.send_allocation_pax_request-3645"><a href="#PassengerReallocation.send_allocation_pax_request-3645"><span class="linenos">3645</span></a>
</span><span id="PassengerReallocation.send_allocation_pax_request-3646"><a href="#PassengerReallocation.send_allocation_pax_request-3646"><span class="linenos">3646</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Used to ask another airline to put a pax group on the list of
pax to board.</p>
</div>


                            </div>
                            <div id="PassengerReallocation.send_remove_pax_from_boarding_list_request" class="classattr">
                                        <input id="PassengerReallocation.send_remove_pax_from_boarding_list_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_remove_pax_from_boarding_list_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.send_remove_pax_from_boarding_list_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.send_remove_pax_from_boarding_list_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3648"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3648"><span class="linenos">3648</span></a>	<span class="k">def</span> <span class="nf">send_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3649"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3649"><span class="linenos">3649</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;sends a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3650"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3650"><span class="linenos">3650</span></a>				<span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;to airline&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3651"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3651"><span class="linenos">3651</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3652"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3652"><span class="linenos">3652</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>  <span class="c1"># self.agent.itinerary_provider_uid</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3653"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3653"><span class="linenos">3653</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;remove_pax_from_boarding_list&#39;</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3654"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3654"><span class="linenos">3654</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3655"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3655"><span class="linenos">3655</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3656"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3656"><span class="linenos">3656</span></a>
</span><span id="PassengerReallocation.send_remove_pax_from_boarding_list_request-3657"><a href="#PassengerReallocation.send_remove_pax_from_boarding_list_request-3657"><span class="linenos">3657</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request" class="classattr">
                                        <input id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_remove_pax_from_boarding_list_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3659"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3659"><span class="linenos">3659</span></a>	<span class="k">def</span> <span class="nf">wait_for_remove_pax_from_boarding_list_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3660"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3660"><span class="linenos">3660</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3661"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3661"><span class="linenos">3661</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3662"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3662"><span class="linenos">3662</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3663"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3663"><span class="linenos">3663</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received a remove from boarding list request for&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3664"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3664"><span class="linenos">3664</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3665"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3665"><span class="linenos">3665</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Old itineraries of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3666"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3666"><span class="linenos">3666</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Newest itinerary of&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3667"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3667"><span class="linenos">3667</span></a>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3668"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3668"><span class="linenos">3668</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_remove_pax_from_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span><span id="PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3669"><a href="#PassengerReallocation.wait_for_remove_pax_from_boarding_list_request-3669"><span class="linenos">3669</span></a>		<span class="c1"># self.agent.env.process(self._remove_pax_from_boarding_list(msg[&#39;body&#39;][&#39;pax&#39;], msg[&#39;body&#39;][&#39;flight_uid&#39;]))</span>
</span></pre></div>


            <div class="docstring"><p>This coming from another aoc.</p>
</div>


                            </div>
                            <div id="PassengerReallocation.wait_for_allocation_pax_request" class="classattr">
                                        <input id="PassengerReallocation.wait_for_allocation_pax_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_allocation_pax_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.wait_for_allocation_pax_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.wait_for_allocation_pax_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.wait_for_allocation_pax_request-3671"><a href="#PassengerReallocation.wait_for_allocation_pax_request-3671"><span class="linenos">3671</span></a>	<span class="k">def</span> <span class="nf">wait_for_allocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation.wait_for_allocation_pax_request-3672"><a href="#PassengerReallocation.wait_for_allocation_pax_request-3672"><span class="linenos">3672</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_allocation_pax_request-3673"><a href="#PassengerReallocation.wait_for_allocation_pax_request-3673"><span class="linenos">3673</span></a><span class="sd">		This coming from another aoc.</span>
</span><span id="PassengerReallocation.wait_for_allocation_pax_request-3674"><a href="#PassengerReallocation.wait_for_allocation_pax_request-3674"><span class="linenos">3674</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_allocation_pax_request-3675"><a href="#PassengerReallocation.wait_for_allocation_pax_request-3675"><span class="linenos">3675</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_add_pax_to_boarding_list</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>This coming from another aoc.</p>
</div>


                            </div>
                            <div id="PassengerReallocation.wait_for_reallocation_pax_request" class="classattr">
                                        <input id="PassengerReallocation.wait_for_reallocation_pax_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_reallocation_pax_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="PassengerReallocation.wait_for_reallocation_pax_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#PassengerReallocation.wait_for_reallocation_pax_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3677"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3677"><span class="linenos">3677</span></a>	<span class="k">def</span> <span class="nf">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3678"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3678"><span class="linenos">3678</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3679"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3679"><span class="linenos">3679</span></a><span class="sd">		Note: ok with creating a process here? ANSWER: PROBABLY.</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3680"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3680"><span class="linenos">3680</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3681"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3681"><span class="linenos">3681</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;do_reallocation triggered from wait_for_reallocation_pax_request for paxs:&#39;</span><span class="p">,</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3682"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3682"><span class="linenos">3682</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">],</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span> <span class="s1">&#39;at t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3683"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3683"><span class="linenos">3683</span></a>		<span class="c1"># self.agent.env.process(self.do_reallocation(msg[&#39;body&#39;][&#39;paxs&#39;]))</span>
</span><span id="PassengerReallocation.wait_for_reallocation_pax_request-3684"><a href="#PassengerReallocation.wait_for_reallocation_pax_request-3684"><span class="linenos">3684</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">do_reallocation</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Note: ok with creating a process here? ANSWER: PROBABLY.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="PassengerReallocation.__init__" class="function"><a href="agent_base.html#Role.__init__">Role</a></dd>
                <dd id="PassengerReallocation.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="PassengerReallocation.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TurnaroundOperations">
                            <input id="TurnaroundOperations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TurnaroundOperations</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="TurnaroundOperations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations-3687"><a href="#TurnaroundOperations-3687"><span class="linenos">3687</span></a><span class="k">class</span> <span class="nc">TurnaroundOperations</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3688"><a href="#TurnaroundOperations-3688"><span class="linenos">3688</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3689"><a href="#TurnaroundOperations-3689"><span class="linenos">3689</span></a><span class="sd">	TRO</span>
</span><span id="TurnaroundOperations-3690"><a href="#TurnaroundOperations-3690"><span class="linenos">3690</span></a>
</span><span id="TurnaroundOperations-3691"><a href="#TurnaroundOperations-3691"><span class="linenos">3691</span></a><span class="sd">	Description: When a flight arrives to the gate computes the turnaround time required, generates the ready to depart time of the subsequent flight.</span>
</span><span id="TurnaroundOperations-3692"><a href="#TurnaroundOperations-3692"><span class="linenos">3692</span></a>
</span><span id="TurnaroundOperations-3693"><a href="#TurnaroundOperations-3693"><span class="linenos">3693</span></a><span class="sd">	1. Reallocate passengers of arriving flight if needed</span>
</span><span id="TurnaroundOperations-3694"><a href="#TurnaroundOperations-3694"><span class="linenos">3694</span></a><span class="sd">	2. Computes the turnaround time.</span>
</span><span id="TurnaroundOperations-3695"><a href="#TurnaroundOperations-3695"><span class="linenos">3695</span></a><span class="sd">	3. Computes delay due to non-ATFM causes</span>
</span><span id="TurnaroundOperations-3696"><a href="#TurnaroundOperations-3696"><span class="linenos">3696</span></a><span class="sd">	4. Updates the EOBT</span>
</span><span id="TurnaroundOperations-3697"><a href="#TurnaroundOperations-3697"><span class="linenos">3697</span></a><span class="sd">	5. Requests reassessment of flight departure in case extra delay has been incurred</span>
</span><span id="TurnaroundOperations-3698"><a href="#TurnaroundOperations-3698"><span class="linenos">3698</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3699"><a href="#TurnaroundOperations-3699"><span class="linenos">3699</span></a>
</span><span id="TurnaroundOperations-3700"><a href="#TurnaroundOperations-3700"><span class="linenos">3700</span></a>	<span class="k">def</span> <span class="nf">check_arrival</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">arrival_event</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3701"><a href="#TurnaroundOperations-3701"><span class="linenos">3701</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3702"><a href="#TurnaroundOperations-3702"><span class="linenos">3702</span></a><span class="sd">		Note: keep the aircraft release at the end of this method to make sure</span>
</span><span id="TurnaroundOperations-3703"><a href="#TurnaroundOperations-3703"><span class="linenos">3703</span></a><span class="sd">		that EOBT is updated before.</span>
</span><span id="TurnaroundOperations-3704"><a href="#TurnaroundOperations-3704"><span class="linenos">3704</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3705"><a href="#TurnaroundOperations-3705"><span class="linenos">3705</span></a>
</span><span id="TurnaroundOperations-3706"><a href="#TurnaroundOperations-3706"><span class="linenos">3706</span></a>		<span class="c1"># aprint(&quot;Waiting arrival event for &quot;, flight_str(flight_uid), &quot;:&quot;, arrival_event)</span>
</span><span id="TurnaroundOperations-3707"><a href="#TurnaroundOperations-3707"><span class="linenos">3707</span></a>		<span class="k">yield</span> <span class="n">arrival_event</span>
</span><span id="TurnaroundOperations-3708"><a href="#TurnaroundOperations-3708"><span class="linenos">3708</span></a>		<span class="c1"># aprint(&quot;Arrival event for &quot;, flight_str(flight_uid), &quot;triggered&quot;)</span>
</span><span id="TurnaroundOperations-3709"><a href="#TurnaroundOperations-3709"><span class="linenos">3709</span></a>
</span><span id="TurnaroundOperations-3710"><a href="#TurnaroundOperations-3710"><span class="linenos">3710</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_arrival&#39;</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3711"><a href="#TurnaroundOperations-3711"><span class="linenos">3711</span></a>			<span class="c1"># Mark the real arrival time</span>
</span><span id="TurnaroundOperations-3712"><a href="#TurnaroundOperations-3712"><span class="linenos">3712</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aibt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
</span><span id="TurnaroundOperations-3713"><a href="#TurnaroundOperations-3713"><span class="linenos">3713</span></a>
</span><span id="TurnaroundOperations-3714"><a href="#TurnaroundOperations-3714"><span class="linenos">3714</span></a>			<span class="c1"># Take care of pax</span>
</span><span id="TurnaroundOperations-3715"><a href="#TurnaroundOperations-3715"><span class="linenos">3715</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_process_arrival_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3716"><a href="#TurnaroundOperations-3716"><span class="linenos">3716</span></a>
</span><span id="TurnaroundOperations-3717"><a href="#TurnaroundOperations-3717"><span class="linenos">3717</span></a>			<span class="c1"># Take care of aircraft</span>
</span><span id="TurnaroundOperations-3718"><a href="#TurnaroundOperations-3718"><span class="linenos">3718</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">process_following_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3719"><a href="#TurnaroundOperations-3719"><span class="linenos">3719</span></a>
</span><span id="TurnaroundOperations-3720"><a href="#TurnaroundOperations-3720"><span class="linenos">3720</span></a>	<span class="k">def</span> <span class="nf">check_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">delay_estimation_event</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3721"><a href="#TurnaroundOperations-3721"><span class="linenos">3721</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3722"><a href="#TurnaroundOperations-3722"><span class="linenos">3722</span></a><span class="sd">		This, in theory, should happen only exactly 60 minutes before most up to date EOBT.</span>
</span><span id="TurnaroundOperations-3723"><a href="#TurnaroundOperations-3723"><span class="linenos">3723</span></a><span class="sd">		Delay is added to the current now + 60 minutes,</span>
</span><span id="TurnaroundOperations-3724"><a href="#TurnaroundOperations-3724"><span class="linenos">3724</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations-3725"><a href="#TurnaroundOperations-3725"><span class="linenos">3725</span></a>		<span class="k">yield</span> <span class="n">delay_estimation_event</span>
</span><span id="TurnaroundOperations-3726"><a href="#TurnaroundOperations-3726"><span class="linenos">3726</span></a>
</span><span id="TurnaroundOperations-3727"><a href="#TurnaroundOperations-3727"><span class="linenos">3727</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations-3728"><a href="#TurnaroundOperations-3728"><span class="linenos">3728</span></a>		<span class="c1"># 	print(&quot;{} checks estimates additional delay for flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="TurnaroundOperations-3729"><a href="#TurnaroundOperations-3729"><span class="linenos">3729</span></a>
</span><span id="TurnaroundOperations-3730"><a href="#TurnaroundOperations-3730"><span class="linenos">3730</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_delay_estimation&#39;</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3731"><a href="#TurnaroundOperations-3731"><span class="linenos">3731</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">p_cancellation</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3732"><a href="#TurnaroundOperations-3732"><span class="linenos">3732</span></a>				<span class="n">non_atfm_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3733"><a href="#TurnaroundOperations-3733"><span class="linenos">3733</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Computing non-ATFM delay for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">non_atfm_delay</span><span class="p">,</span> <span class="s1">&#39;at time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3734"><a href="#TurnaroundOperations-3734"><span class="linenos">3734</span></a>
</span><span id="TurnaroundOperations-3735"><a href="#TurnaroundOperations-3735"><span class="linenos">3735</span></a>				<span class="c1"># Keep the non-atfm delay in memory for liability</span>
</span><span id="TurnaroundOperations-3736"><a href="#TurnaroundOperations-3736"><span class="linenos">3736</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_atfm_delay</span>
</span><span id="TurnaroundOperations-3737"><a href="#TurnaroundOperations-3737"><span class="linenos">3737</span></a>
</span><span id="TurnaroundOperations-3738"><a href="#TurnaroundOperations-3738"><span class="linenos">3738</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations-3739"><a href="#TurnaroundOperations-3739"><span class="linenos">3739</span></a>				<span class="c1"># if aircraft.idx_current_flight==0:</span>
</span><span id="TurnaroundOperations-3740"><a href="#TurnaroundOperations-3740"><span class="linenos">3740</span></a>				<span class="c1"># If flight first of the day with this aircraft</span>
</span><span id="TurnaroundOperations-3741"><a href="#TurnaroundOperations-3741"><span class="linenos">3741</span></a>				<span class="c1"># aprint(&#39;Requesting turnaround time for&#39;, flight_str(flight_uid), &#39;(first of the day)&#39;)</span>
</span><span id="TurnaroundOperations-3742"><a href="#TurnaroundOperations-3742"><span class="linenos">3742</span></a>				<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span> <span class="o">+</span> <span class="n">non_atfm_delay</span>
</span><span id="TurnaroundOperations-3743"><a href="#TurnaroundOperations-3743"><span class="linenos">3743</span></a>
</span><span id="TurnaroundOperations-3744"><a href="#TurnaroundOperations-3744"><span class="linenos">3744</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations-3745"><a href="#TurnaroundOperations-3745"><span class="linenos">3745</span></a>				<span class="c1"># 	print(&quot;{} requests a departing reassessment for flight {} after the delay check estimation&quot;.format(self.agent, flight_uid))</span>
</span><span id="TurnaroundOperations-3746"><a href="#TurnaroundOperations-3746"><span class="linenos">3746</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3747"><a href="#TurnaroundOperations-3747"><span class="linenos">3747</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3748"><a href="#TurnaroundOperations-3748"><span class="linenos">3748</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;CANCEL&quot;</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3749"><a href="#TurnaroundOperations-3749"><span class="linenos">3749</span></a>
</span><span id="TurnaroundOperations-3750"><a href="#TurnaroundOperations-3750"><span class="linenos">3750</span></a>	<span class="k">def</span> <span class="nf">process_following_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3751"><a href="#TurnaroundOperations-3751"><span class="linenos">3751</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations-3752"><a href="#TurnaroundOperations-3752"><span class="linenos">3752</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations-3753"><a href="#TurnaroundOperations-3753"><span class="linenos">3753</span></a>
</span><span id="TurnaroundOperations-3754"><a href="#TurnaroundOperations-3754"><span class="linenos">3754</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;checks if there is a next flight after&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations-3755"><a href="#TurnaroundOperations-3755"><span class="linenos">3755</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">FP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3756"><a href="#TurnaroundOperations-3756"><span class="linenos">3756</span></a>			<span class="c1"># Compute delays and cost of delays</span>
</span><span id="TurnaroundOperations-3757"><a href="#TurnaroundOperations-3757"><span class="linenos">3757</span></a>			<span class="c1"># Compute delay spent at gate</span>
</span><span id="TurnaroundOperations-3758"><a href="#TurnaroundOperations-3758"><span class="linenos">3758</span></a>			<span class="n">delay_at_gate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">sobt</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3759"><a href="#TurnaroundOperations-3759"><span class="linenos">3759</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_at_gate</span><span class="p">,</span> <span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3760"><a href="#TurnaroundOperations-3760"><span class="linenos">3760</span></a>
</span><span id="TurnaroundOperations-3761"><a href="#TurnaroundOperations-3761"><span class="linenos">3761</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="TurnaroundOperations-3762"><a href="#TurnaroundOperations-3762"><span class="linenos">3762</span></a>
</span><span id="TurnaroundOperations-3763"><a href="#TurnaroundOperations-3763"><span class="linenos">3763</span></a>			<span class="c1"># sch_taxi_duration = FP.points[&#39;takeoff&#39;].time_min - FP.sobt</span>
</span><span id="TurnaroundOperations-3764"><a href="#TurnaroundOperations-3764"><span class="linenos">3764</span></a>			<span class="c1"># actual_taxi_duration = FP.points_executed[&#39;takeoff&#39;].time_min - FP.aobt</span>
</span><span id="TurnaroundOperations-3765"><a href="#TurnaroundOperations-3765"><span class="linenos">3765</span></a>			<span class="c1"># delay_taxi = actual_taxi_duration - sch_taxi_duration</span>
</span><span id="TurnaroundOperations-3766"><a href="#TurnaroundOperations-3766"><span class="linenos">3766</span></a>			<span class="c1"># delay_taxi = 0</span>
</span><span id="TurnaroundOperations-3767"><a href="#TurnaroundOperations-3767"><span class="linenos">3767</span></a>			<span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;non_pax_cost&#39;] += self.agent.non_pax_cost(aircraft, delay_taxi, &#39;taxi&#39;)</span>
</span><span id="TurnaroundOperations-3768"><a href="#TurnaroundOperations-3768"><span class="linenos">3768</span></a>
</span><span id="TurnaroundOperations-3769"><a href="#TurnaroundOperations-3769"><span class="linenos">3769</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="TurnaroundOperations-3770"><a href="#TurnaroundOperations-3770"><span class="linenos">3770</span></a>			<span class="n">sch_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;landing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;takeoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="TurnaroundOperations-3771"><a href="#TurnaroundOperations-3771"><span class="linenos">3771</span></a>			<span class="n">actual_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="TurnaroundOperations-3772"><a href="#TurnaroundOperations-3772"><span class="linenos">3772</span></a>			<span class="n">delay_airborne</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">actual_air_duration</span> <span class="o">-</span> <span class="n">sch_air_duration</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3773"><a href="#TurnaroundOperations-3773"><span class="linenos">3773</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_airborne</span><span class="p">,</span> <span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3774"><a href="#TurnaroundOperations-3774"><span class="linenos">3774</span></a>
</span><span id="TurnaroundOperations-3775"><a href="#TurnaroundOperations-3775"><span class="linenos">3775</span></a>		<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="TurnaroundOperations-3776"><a href="#TurnaroundOperations-3776"><span class="linenos">3776</span></a>
</span><span id="TurnaroundOperations-3777"><a href="#TurnaroundOperations-3777"><span class="linenos">3777</span></a>		<span class="k">if</span> <span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3778"><a href="#TurnaroundOperations-3778"><span class="linenos">3778</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations-3779"><a href="#TurnaroundOperations-3779"><span class="linenos">3779</span></a>			<span class="c1"># 	print(&quot;{} request turnaround time for aircraft {} after flight {} and before flight {}&quot;.format(self.agent, aircraft, flight_uid, next_flight_uid))</span>
</span><span id="TurnaroundOperations-3780"><a href="#TurnaroundOperations-3780"><span class="linenos">3780</span></a>			<span class="c1"># There is a next flight with this aircraft</span>
</span><span id="TurnaroundOperations-3781"><a href="#TurnaroundOperations-3781"><span class="linenos">3781</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;requests turnaround operations for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;and before flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations-3782"><a href="#TurnaroundOperations-3782"><span class="linenos">3782</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_turnaround</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3783"><a href="#TurnaroundOperations-3783"><span class="linenos">3783</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3784"><a href="#TurnaroundOperations-3784"><span class="linenos">3784</span></a>			<span class="c1"># Flight was the last one of the day for the aircraft</span>
</span><span id="TurnaroundOperations-3785"><a href="#TurnaroundOperations-3785"><span class="linenos">3785</span></a>			<span class="c1"># Release resource to clean queue</span>
</span><span id="TurnaroundOperations-3786"><a href="#TurnaroundOperations-3786"><span class="linenos">3786</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;: there is no more flight for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations-3787"><a href="#TurnaroundOperations-3787"><span class="linenos">3787</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="TurnaroundOperations-3788"><a href="#TurnaroundOperations-3788"><span class="linenos">3788</span></a>
</span><span id="TurnaroundOperations-3789"><a href="#TurnaroundOperations-3789"><span class="linenos">3789</span></a>	<span class="k">def</span> <span class="nf">request_process_arrival_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3790"><a href="#TurnaroundOperations-3790"><span class="linenos">3790</span></a>		<span class="c1"># This is an internal message</span>
</span><span id="TurnaroundOperations-3791"><a href="#TurnaroundOperations-3791"><span class="linenos">3791</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations-3792"><a href="#TurnaroundOperations-3792"><span class="linenos">3792</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations-3793"><a href="#TurnaroundOperations-3793"><span class="linenos">3793</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span>
</span><span id="TurnaroundOperations-3794"><a href="#TurnaroundOperations-3794"><span class="linenos">3794</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="TurnaroundOperations-3795"><a href="#TurnaroundOperations-3795"><span class="linenos">3795</span></a>
</span><span id="TurnaroundOperations-3796"><a href="#TurnaroundOperations-3796"><span class="linenos">3796</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3797"><a href="#TurnaroundOperations-3797"><span class="linenos">3797</span></a>
</span><span id="TurnaroundOperations-3798"><a href="#TurnaroundOperations-3798"><span class="linenos">3798</span></a>		<span class="c1"># self.send(msg) # uncomment this to use messaging server</span>
</span><span id="TurnaroundOperations-3799"><a href="#TurnaroundOperations-3799"><span class="linenos">3799</span></a>
</span><span id="TurnaroundOperations-3800"><a href="#TurnaroundOperations-3800"><span class="linenos">3800</span></a>	<span class="k">def</span> <span class="nf">request_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="n">last_flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3801"><a href="#TurnaroundOperations-3801"><span class="linenos">3801</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations-3802"><a href="#TurnaroundOperations-3802"><span class="linenos">3802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;turnaround_request&#39;</span>
</span><span id="TurnaroundOperations-3803"><a href="#TurnaroundOperations-3803"><span class="linenos">3803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">last_flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations-3804"><a href="#TurnaroundOperations-3804"><span class="linenos">3804</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="n">aircraft</span><span class="p">,</span>
</span><span id="TurnaroundOperations-3805"><a href="#TurnaroundOperations-3805"><span class="linenos">3805</span></a>						<span class="s1">&#39;ao_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">airline_type</span><span class="p">,</span>
</span><span id="TurnaroundOperations-3806"><a href="#TurnaroundOperations-3806"><span class="linenos">3806</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">next_flight_uid</span>
</span><span id="TurnaroundOperations-3807"><a href="#TurnaroundOperations-3807"><span class="linenos">3807</span></a>						<span class="p">}</span>
</span><span id="TurnaroundOperations-3808"><a href="#TurnaroundOperations-3808"><span class="linenos">3808</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3809"><a href="#TurnaroundOperations-3809"><span class="linenos">3809</span></a>
</span><span id="TurnaroundOperations-3810"><a href="#TurnaroundOperations-3810"><span class="linenos">3810</span></a>	<span class="k">def</span> <span class="nf">request_departing_reassessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3811"><a href="#TurnaroundOperations-3811"><span class="linenos">3811</span></a>		<span class="c1"># Internal message.</span>
</span><span id="TurnaroundOperations-3812"><a href="#TurnaroundOperations-3812"><span class="linenos">3812</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations-3813"><a href="#TurnaroundOperations-3813"><span class="linenos">3813</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;departing_reassessment_request&#39;</span>
</span><span id="TurnaroundOperations-3814"><a href="#TurnaroundOperations-3814"><span class="linenos">3814</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations-3815"><a href="#TurnaroundOperations-3815"><span class="linenos">3815</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations-3816"><a href="#TurnaroundOperations-3816"><span class="linenos">3816</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="TurnaroundOperations-3817"><a href="#TurnaroundOperations-3817"><span class="linenos">3817</span></a>						<span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">:</span> <span class="n">ac_ready_at_time</span><span class="p">}</span>
</span><span id="TurnaroundOperations-3818"><a href="#TurnaroundOperations-3818"><span class="linenos">3818</span></a>
</span><span id="TurnaroundOperations-3819"><a href="#TurnaroundOperations-3819"><span class="linenos">3819</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3820"><a href="#TurnaroundOperations-3820"><span class="linenos">3820</span></a>
</span><span id="TurnaroundOperations-3821"><a href="#TurnaroundOperations-3821"><span class="linenos">3821</span></a>		<span class="c1"># Uncomment the following line if you want to use the central messaging server.</span>
</span><span id="TurnaroundOperations-3822"><a href="#TurnaroundOperations-3822"><span class="linenos">3822</span></a>		<span class="c1"># self.send(msg)</span>
</span><span id="TurnaroundOperations-3823"><a href="#TurnaroundOperations-3823"><span class="linenos">3823</span></a>
</span><span id="TurnaroundOperations-3824"><a href="#TurnaroundOperations-3824"><span class="linenos">3824</span></a>	<span class="k">def</span> <span class="nf">wait_for_turnaround_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="TurnaroundOperations-3825"><a href="#TurnaroundOperations-3825"><span class="linenos">3825</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives turnaround time for flight&#39;</span><span class="p">,</span>
</span><span id="TurnaroundOperations-3826"><a href="#TurnaroundOperations-3826"><span class="linenos">3826</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">],</span>
</span><span id="TurnaroundOperations-3827"><a href="#TurnaroundOperations-3827"><span class="linenos">3827</span></a>				<span class="s1">&#39;at time t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3828"><a href="#TurnaroundOperations-3828"><span class="linenos">3828</span></a>
</span><span id="TurnaroundOperations-3829"><a href="#TurnaroundOperations-3829"><span class="linenos">3829</span></a>		<span class="n">flight_uid</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations-3830"><a href="#TurnaroundOperations-3830"><span class="linenos">3830</span></a>
</span><span id="TurnaroundOperations-3831"><a href="#TurnaroundOperations-3831"><span class="linenos">3831</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations-3832"><a href="#TurnaroundOperations-3832"><span class="linenos">3832</span></a>		<span class="c1"># 	print(&quot;{} received turnaround time for flight {}: {} (t={})&quot;.format(self.agent, flight_uid, tt, self.agent.env.now))</span>
</span><span id="TurnaroundOperations-3833"><a href="#TurnaroundOperations-3833"><span class="linenos">3833</span></a>
</span><span id="TurnaroundOperations-3834"><a href="#TurnaroundOperations-3834"><span class="linenos">3834</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">tt</span>
</span><span id="TurnaroundOperations-3835"><a href="#TurnaroundOperations-3835"><span class="linenos">3835</span></a>
</span><span id="TurnaroundOperations-3836"><a href="#TurnaroundOperations-3836"><span class="linenos">3836</span></a>		<span class="c1"># print(ac_ready_at_time, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].bada_code_ac_model)</span>
</span><span id="TurnaroundOperations-3837"><a href="#TurnaroundOperations-3837"><span class="linenos">3837</span></a>
</span><span id="TurnaroundOperations-3838"><a href="#TurnaroundOperations-3838"><span class="linenos">3838</span></a>		<span class="n">reactionar_del</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="TurnaroundOperations-3839"><a href="#TurnaroundOperations-3839"><span class="linenos">3839</span></a>
</span><span id="TurnaroundOperations-3840"><a href="#TurnaroundOperations-3840"><span class="linenos">3840</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3841"><a href="#TurnaroundOperations-3841"><span class="linenos">3841</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="TurnaroundOperations-3842"><a href="#TurnaroundOperations-3842"><span class="linenos">3842</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac_ready_at_time</span>
</span><span id="TurnaroundOperations-3843"><a href="#TurnaroundOperations-3843"><span class="linenos">3843</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations-3844"><a href="#TurnaroundOperations-3844"><span class="linenos">3844</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="TurnaroundOperations-3845"><a href="#TurnaroundOperations-3845"><span class="linenos">3845</span></a>
</span><span id="TurnaroundOperations-3846"><a href="#TurnaroundOperations-3846"><span class="linenos">3846</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft will be ready for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span>
</span><span id="TurnaroundOperations-3847"><a href="#TurnaroundOperations-3847"><span class="linenos">3847</span></a>				<span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3848"><a href="#TurnaroundOperations-3848"><span class="linenos">3848</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Flight has&#39;</span><span class="p">,</span> <span class="n">reactionar_del</span><span class="p">,</span> <span class="s1">&#39;of reactionary_delay.&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations-3849"><a href="#TurnaroundOperations-3849"><span class="linenos">3849</span></a>
</span><span id="TurnaroundOperations-3850"><a href="#TurnaroundOperations-3850"><span class="linenos">3850</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations-3851"><a href="#TurnaroundOperations-3851"><span class="linenos">3851</span></a>		<span class="c1"># 	print(&quot;{} requests departing reassessment for flight {} with ac_ready_at_time {}&quot;.format(self.agent, flight_uid, ac_ready_at_time))</span>
</span><span id="TurnaroundOperations-3852"><a href="#TurnaroundOperations-3852"><span class="linenos">3852</span></a>
</span><span id="TurnaroundOperations-3853"><a href="#TurnaroundOperations-3853"><span class="linenos">3853</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>TRO</p>

<p>Description: When a flight arrives to the gate computes the turnaround time required, generates the ready to depart time of the subsequent flight.</p>

<ol>
<li>Reallocate passengers of arriving flight if needed</li>
<li>Computes the turnaround time.</li>
<li>Computes delay due to non-ATFM causes</li>
<li>Updates the EOBT</li>
<li>Requests reassessment of flight departure in case extra delay has been incurred</li>
</ol>
</div>


                            <div id="TurnaroundOperations.check_arrival" class="classattr">
                                        <input id="TurnaroundOperations.check_arrival-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_arrival</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">arrival_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.check_arrival-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.check_arrival"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.check_arrival-3700"><a href="#TurnaroundOperations.check_arrival-3700"><span class="linenos">3700</span></a>	<span class="k">def</span> <span class="nf">check_arrival</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">arrival_event</span><span class="p">):</span>
</span><span id="TurnaroundOperations.check_arrival-3701"><a href="#TurnaroundOperations.check_arrival-3701"><span class="linenos">3701</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations.check_arrival-3702"><a href="#TurnaroundOperations.check_arrival-3702"><span class="linenos">3702</span></a><span class="sd">		Note: keep the aircraft release at the end of this method to make sure</span>
</span><span id="TurnaroundOperations.check_arrival-3703"><a href="#TurnaroundOperations.check_arrival-3703"><span class="linenos">3703</span></a><span class="sd">		that EOBT is updated before.</span>
</span><span id="TurnaroundOperations.check_arrival-3704"><a href="#TurnaroundOperations.check_arrival-3704"><span class="linenos">3704</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations.check_arrival-3705"><a href="#TurnaroundOperations.check_arrival-3705"><span class="linenos">3705</span></a>
</span><span id="TurnaroundOperations.check_arrival-3706"><a href="#TurnaroundOperations.check_arrival-3706"><span class="linenos">3706</span></a>		<span class="c1"># aprint(&quot;Waiting arrival event for &quot;, flight_str(flight_uid), &quot;:&quot;, arrival_event)</span>
</span><span id="TurnaroundOperations.check_arrival-3707"><a href="#TurnaroundOperations.check_arrival-3707"><span class="linenos">3707</span></a>		<span class="k">yield</span> <span class="n">arrival_event</span>
</span><span id="TurnaroundOperations.check_arrival-3708"><a href="#TurnaroundOperations.check_arrival-3708"><span class="linenos">3708</span></a>		<span class="c1"># aprint(&quot;Arrival event for &quot;, flight_str(flight_uid), &quot;triggered&quot;)</span>
</span><span id="TurnaroundOperations.check_arrival-3709"><a href="#TurnaroundOperations.check_arrival-3709"><span class="linenos">3709</span></a>
</span><span id="TurnaroundOperations.check_arrival-3710"><a href="#TurnaroundOperations.check_arrival-3710"><span class="linenos">3710</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_arrival&#39;</span><span class="p">):</span>
</span><span id="TurnaroundOperations.check_arrival-3711"><a href="#TurnaroundOperations.check_arrival-3711"><span class="linenos">3711</span></a>			<span class="c1"># Mark the real arrival time</span>
</span><span id="TurnaroundOperations.check_arrival-3712"><a href="#TurnaroundOperations.check_arrival-3712"><span class="linenos">3712</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aibt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>
</span><span id="TurnaroundOperations.check_arrival-3713"><a href="#TurnaroundOperations.check_arrival-3713"><span class="linenos">3713</span></a>
</span><span id="TurnaroundOperations.check_arrival-3714"><a href="#TurnaroundOperations.check_arrival-3714"><span class="linenos">3714</span></a>			<span class="c1"># Take care of pax</span>
</span><span id="TurnaroundOperations.check_arrival-3715"><a href="#TurnaroundOperations.check_arrival-3715"><span class="linenos">3715</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_process_arrival_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="TurnaroundOperations.check_arrival-3716"><a href="#TurnaroundOperations.check_arrival-3716"><span class="linenos">3716</span></a>
</span><span id="TurnaroundOperations.check_arrival-3717"><a href="#TurnaroundOperations.check_arrival-3717"><span class="linenos">3717</span></a>			<span class="c1"># Take care of aircraft</span>
</span><span id="TurnaroundOperations.check_arrival-3718"><a href="#TurnaroundOperations.check_arrival-3718"><span class="linenos">3718</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">process_following_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note: keep the aircraft release at the end of this method to make sure
that EOBT is updated before.</p>
</div>


                            </div>
                            <div id="TurnaroundOperations.check_delay_estimation" class="classattr">
                                        <input id="TurnaroundOperations.check_delay_estimation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_delay_estimation</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">delay_estimation_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.check_delay_estimation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.check_delay_estimation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.check_delay_estimation-3720"><a href="#TurnaroundOperations.check_delay_estimation-3720"><span class="linenos">3720</span></a>	<span class="k">def</span> <span class="nf">check_delay_estimation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">delay_estimation_event</span><span class="p">):</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3721"><a href="#TurnaroundOperations.check_delay_estimation-3721"><span class="linenos">3721</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3722"><a href="#TurnaroundOperations.check_delay_estimation-3722"><span class="linenos">3722</span></a><span class="sd">		This, in theory, should happen only exactly 60 minutes before most up to date EOBT.</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3723"><a href="#TurnaroundOperations.check_delay_estimation-3723"><span class="linenos">3723</span></a><span class="sd">		Delay is added to the current now + 60 minutes,</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3724"><a href="#TurnaroundOperations.check_delay_estimation-3724"><span class="linenos">3724</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3725"><a href="#TurnaroundOperations.check_delay_estimation-3725"><span class="linenos">3725</span></a>		<span class="k">yield</span> <span class="n">delay_estimation_event</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3726"><a href="#TurnaroundOperations.check_delay_estimation-3726"><span class="linenos">3726</span></a>
</span><span id="TurnaroundOperations.check_delay_estimation-3727"><a href="#TurnaroundOperations.check_delay_estimation-3727"><span class="linenos">3727</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3728"><a href="#TurnaroundOperations.check_delay_estimation-3728"><span class="linenos">3728</span></a>		<span class="c1"># 	print(&quot;{} checks estimates additional delay for flight {} at t={}&quot;.format(self.agent, flight_uid, self.agent.env.now))</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3729"><a href="#TurnaroundOperations.check_delay_estimation-3729"><span class="linenos">3729</span></a>
</span><span id="TurnaroundOperations.check_delay_estimation-3730"><a href="#TurnaroundOperations.check_delay_estimation-3730"><span class="linenos">3730</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_delay_estimation&#39;</span><span class="p">):</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3731"><a href="#TurnaroundOperations.check_delay_estimation-3731"><span class="linenos">3731</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">p_cancellation</span><span class="p">:</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3732"><a href="#TurnaroundOperations.check_delay_estimation-3732"><span class="linenos">3732</span></a>				<span class="n">non_atfm_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_atfm_delay_dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">rs</span><span class="p">)</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3733"><a href="#TurnaroundOperations.check_delay_estimation-3733"><span class="linenos">3733</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Computing non-ATFM delay for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">non_atfm_delay</span><span class="p">,</span> <span class="s1">&#39;at time&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3734"><a href="#TurnaroundOperations.check_delay_estimation-3734"><span class="linenos">3734</span></a>
</span><span id="TurnaroundOperations.check_delay_estimation-3735"><a href="#TurnaroundOperations.check_delay_estimation-3735"><span class="linenos">3735</span></a>				<span class="c1"># Keep the non-atfm delay in memory for liability</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3736"><a href="#TurnaroundOperations.check_delay_estimation-3736"><span class="linenos">3736</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_atfm_delay</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3737"><a href="#TurnaroundOperations.check_delay_estimation-3737"><span class="linenos">3737</span></a>
</span><span id="TurnaroundOperations.check_delay_estimation-3738"><a href="#TurnaroundOperations.check_delay_estimation-3738"><span class="linenos">3738</span></a>				<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3739"><a href="#TurnaroundOperations.check_delay_estimation-3739"><span class="linenos">3739</span></a>				<span class="c1"># if aircraft.idx_current_flight==0:</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3740"><a href="#TurnaroundOperations.check_delay_estimation-3740"><span class="linenos">3740</span></a>				<span class="c1"># If flight first of the day with this aircraft</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3741"><a href="#TurnaroundOperations.check_delay_estimation-3741"><span class="linenos">3741</span></a>				<span class="c1"># aprint(&#39;Requesting turnaround time for&#39;, flight_str(flight_uid), &#39;(first of the day)&#39;)</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3742"><a href="#TurnaroundOperations.check_delay_estimation-3742"><span class="linenos">3742</span></a>				<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">delay_estimation_lag</span> <span class="o">+</span> <span class="n">non_atfm_delay</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3743"><a href="#TurnaroundOperations.check_delay_estimation-3743"><span class="linenos">3743</span></a>
</span><span id="TurnaroundOperations.check_delay_estimation-3744"><a href="#TurnaroundOperations.check_delay_estimation-3744"><span class="linenos">3744</span></a>				<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3745"><a href="#TurnaroundOperations.check_delay_estimation-3745"><span class="linenos">3745</span></a>				<span class="c1"># 	print(&quot;{} requests a departing reassessment for flight {} after the delay check estimation&quot;.format(self.agent, flight_uid))</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3746"><a href="#TurnaroundOperations.check_delay_estimation-3746"><span class="linenos">3746</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3747"><a href="#TurnaroundOperations.check_delay_estimation-3747"><span class="linenos">3747</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations.check_delay_estimation-3748"><a href="#TurnaroundOperations.check_delay_estimation-3748"><span class="linenos">3748</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">cancel_flight</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;CANCEL&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This, in theory, should happen only exactly 60 minutes before most up to date EOBT.
Delay is added to the current now + 60 minutes,</p>
</div>


                            </div>
                            <div id="TurnaroundOperations.process_following_flight" class="classattr">
                                        <input id="TurnaroundOperations.process_following_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">process_following_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.process_following_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.process_following_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.process_following_flight-3750"><a href="#TurnaroundOperations.process_following_flight-3750"><span class="linenos">3750</span></a>	<span class="k">def</span> <span class="nf">process_following_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations.process_following_flight-3751"><a href="#TurnaroundOperations.process_following_flight-3751"><span class="linenos">3751</span></a>		<span class="n">aircraft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations.process_following_flight-3752"><a href="#TurnaroundOperations.process_following_flight-3752"><span class="linenos">3752</span></a>		<span class="n">FP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations.process_following_flight-3753"><a href="#TurnaroundOperations.process_following_flight-3753"><span class="linenos">3753</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3754"><a href="#TurnaroundOperations.process_following_flight-3754"><span class="linenos">3754</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s2">&quot;checks if there is a next flight after&quot;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations.process_following_flight-3755"><a href="#TurnaroundOperations.process_following_flight-3755"><span class="linenos">3755</span></a>		<span class="k">if</span> <span class="p">(</span><span class="n">FP</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TurnaroundOperations.process_following_flight-3756"><a href="#TurnaroundOperations.process_following_flight-3756"><span class="linenos">3756</span></a>			<span class="c1"># Compute delays and cost of delays</span>
</span><span id="TurnaroundOperations.process_following_flight-3757"><a href="#TurnaroundOperations.process_following_flight-3757"><span class="linenos">3757</span></a>			<span class="c1"># Compute delay spent at gate</span>
</span><span id="TurnaroundOperations.process_following_flight-3758"><a href="#TurnaroundOperations.process_following_flight-3758"><span class="linenos">3758</span></a>			<span class="n">delay_at_gate</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">FP</span><span class="o">.</span><span class="n">aobt</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">sobt</span><span class="p">)</span>
</span><span id="TurnaroundOperations.process_following_flight-3759"><a href="#TurnaroundOperations.process_following_flight-3759"><span class="linenos">3759</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_at_gate</span><span class="p">,</span> <span class="s1">&#39;at_gate&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations.process_following_flight-3760"><a href="#TurnaroundOperations.process_following_flight-3760"><span class="linenos">3760</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3761"><a href="#TurnaroundOperations.process_following_flight-3761"><span class="linenos">3761</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="TurnaroundOperations.process_following_flight-3762"><a href="#TurnaroundOperations.process_following_flight-3762"><span class="linenos">3762</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3763"><a href="#TurnaroundOperations.process_following_flight-3763"><span class="linenos">3763</span></a>			<span class="c1"># sch_taxi_duration = FP.points[&#39;takeoff&#39;].time_min - FP.sobt</span>
</span><span id="TurnaroundOperations.process_following_flight-3764"><a href="#TurnaroundOperations.process_following_flight-3764"><span class="linenos">3764</span></a>			<span class="c1"># actual_taxi_duration = FP.points_executed[&#39;takeoff&#39;].time_min - FP.aobt</span>
</span><span id="TurnaroundOperations.process_following_flight-3765"><a href="#TurnaroundOperations.process_following_flight-3765"><span class="linenos">3765</span></a>			<span class="c1"># delay_taxi = actual_taxi_duration - sch_taxi_duration</span>
</span><span id="TurnaroundOperations.process_following_flight-3766"><a href="#TurnaroundOperations.process_following_flight-3766"><span class="linenos">3766</span></a>			<span class="c1"># delay_taxi = 0</span>
</span><span id="TurnaroundOperations.process_following_flight-3767"><a href="#TurnaroundOperations.process_following_flight-3767"><span class="linenos">3767</span></a>			<span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;non_pax_cost&#39;] += self.agent.non_pax_cost(aircraft, delay_taxi, &#39;taxi&#39;)</span>
</span><span id="TurnaroundOperations.process_following_flight-3768"><a href="#TurnaroundOperations.process_following_flight-3768"><span class="linenos">3768</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3769"><a href="#TurnaroundOperations.process_following_flight-3769"><span class="linenos">3769</span></a>			<span class="c1"># Compute airborne delay</span>
</span><span id="TurnaroundOperations.process_following_flight-3770"><a href="#TurnaroundOperations.process_following_flight-3770"><span class="linenos">3770</span></a>			<span class="n">sch_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;landing&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_original_planned</span><span class="p">[</span><span class="s1">&#39;takeoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="TurnaroundOperations.process_following_flight-3771"><a href="#TurnaroundOperations.process_following_flight-3771"><span class="linenos">3771</span></a>			<span class="n">actual_air_duration</span> <span class="o">=</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span> <span class="o">-</span> <span class="n">FP</span><span class="o">.</span><span class="n">points_executed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time_min</span>
</span><span id="TurnaroundOperations.process_following_flight-3772"><a href="#TurnaroundOperations.process_following_flight-3772"><span class="linenos">3772</span></a>			<span class="n">delay_airborne</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">actual_air_duration</span> <span class="o">-</span> <span class="n">sch_air_duration</span><span class="p">)</span>
</span><span id="TurnaroundOperations.process_following_flight-3773"><a href="#TurnaroundOperations.process_following_flight-3773"><span class="linenos">3773</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;non_pax_cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">non_pax_cost</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">delay_airborne</span><span class="p">,</span> <span class="s1">&#39;airborne&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations.process_following_flight-3774"><a href="#TurnaroundOperations.process_following_flight-3774"><span class="linenos">3774</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3775"><a href="#TurnaroundOperations.process_following_flight-3775"><span class="linenos">3775</span></a>		<span class="n">next_flight_uid</span> <span class="o">=</span> <span class="n">aircraft</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="TurnaroundOperations.process_following_flight-3776"><a href="#TurnaroundOperations.process_following_flight-3776"><span class="linenos">3776</span></a>
</span><span id="TurnaroundOperations.process_following_flight-3777"><a href="#TurnaroundOperations.process_following_flight-3777"><span class="linenos">3777</span></a>		<span class="k">if</span> <span class="n">next_flight_uid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TurnaroundOperations.process_following_flight-3778"><a href="#TurnaroundOperations.process_following_flight-3778"><span class="linenos">3778</span></a>			<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations.process_following_flight-3779"><a href="#TurnaroundOperations.process_following_flight-3779"><span class="linenos">3779</span></a>			<span class="c1"># 	print(&quot;{} request turnaround time for aircraft {} after flight {} and before flight {}&quot;.format(self.agent, aircraft, flight_uid, next_flight_uid))</span>
</span><span id="TurnaroundOperations.process_following_flight-3780"><a href="#TurnaroundOperations.process_following_flight-3780"><span class="linenos">3780</span></a>			<span class="c1"># There is a next flight with this aircraft</span>
</span><span id="TurnaroundOperations.process_following_flight-3781"><a href="#TurnaroundOperations.process_following_flight-3781"><span class="linenos">3781</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;requests turnaround operations for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;and before flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations.process_following_flight-3782"><a href="#TurnaroundOperations.process_following_flight-3782"><span class="linenos">3782</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_turnaround</span><span class="p">(</span><span class="n">aircraft</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">)</span>
</span><span id="TurnaroundOperations.process_following_flight-3783"><a href="#TurnaroundOperations.process_following_flight-3783"><span class="linenos">3783</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations.process_following_flight-3784"><a href="#TurnaroundOperations.process_following_flight-3784"><span class="linenos">3784</span></a>			<span class="c1"># Flight was the last one of the day for the aircraft</span>
</span><span id="TurnaroundOperations.process_following_flight-3785"><a href="#TurnaroundOperations.process_following_flight-3785"><span class="linenos">3785</span></a>			<span class="c1"># Release resource to clean queue</span>
</span><span id="TurnaroundOperations.process_following_flight-3786"><a href="#TurnaroundOperations.process_following_flight-3786"><span class="linenos">3786</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;: there is no more flight for&#39;</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="s1">&#39;after&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="TurnaroundOperations.process_following_flight-3787"><a href="#TurnaroundOperations.process_following_flight-3787"><span class="linenos">3787</span></a>			<span class="n">aircraft</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">aircraft</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="TurnaroundOperations.request_process_arrival_pax" class="classattr">
                                        <input id="TurnaroundOperations.request_process_arrival_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_process_arrival_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.request_process_arrival_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.request_process_arrival_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.request_process_arrival_pax-3789"><a href="#TurnaroundOperations.request_process_arrival_pax-3789"><span class="linenos">3789</span></a>	<span class="k">def</span> <span class="nf">request_process_arrival_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3790"><a href="#TurnaroundOperations.request_process_arrival_pax-3790"><span class="linenos">3790</span></a>		<span class="c1"># This is an internal message</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3791"><a href="#TurnaroundOperations.request_process_arrival_pax-3791"><span class="linenos">3791</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3792"><a href="#TurnaroundOperations.request_process_arrival_pax-3792"><span class="linenos">3792</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3793"><a href="#TurnaroundOperations.request_process_arrival_pax-3793"><span class="linenos">3793</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;process_arrival_pax_request&#39;</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3794"><a href="#TurnaroundOperations.request_process_arrival_pax-3794"><span class="linenos">3794</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">}</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3795"><a href="#TurnaroundOperations.request_process_arrival_pax-3795"><span class="linenos">3795</span></a>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3796"><a href="#TurnaroundOperations.request_process_arrival_pax-3796"><span class="linenos">3796</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aph</span><span class="o">.</span><span class="n">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3797"><a href="#TurnaroundOperations.request_process_arrival_pax-3797"><span class="linenos">3797</span></a>
</span><span id="TurnaroundOperations.request_process_arrival_pax-3798"><a href="#TurnaroundOperations.request_process_arrival_pax-3798"><span class="linenos">3798</span></a>		<span class="c1"># self.send(msg) # uncomment this to use messaging server</span>
</span></pre></div>


    

                            </div>
                            <div id="TurnaroundOperations.request_turnaround" class="classattr">
                                        <input id="TurnaroundOperations.request_turnaround-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_turnaround</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">aircraft</span>, </span><span class="param"><span class="n">last_flight_uid</span>, </span><span class="param"><span class="n">next_flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.request_turnaround-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.request_turnaround"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.request_turnaround-3800"><a href="#TurnaroundOperations.request_turnaround-3800"><span class="linenos">3800</span></a>	<span class="k">def</span> <span class="nf">request_turnaround</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aircraft</span><span class="p">,</span> <span class="n">last_flight_uid</span><span class="p">,</span> <span class="n">next_flight_uid</span><span class="p">):</span>
</span><span id="TurnaroundOperations.request_turnaround-3801"><a href="#TurnaroundOperations.request_turnaround-3801"><span class="linenos">3801</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations.request_turnaround-3802"><a href="#TurnaroundOperations.request_turnaround-3802"><span class="linenos">3802</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;turnaround_request&#39;</span>
</span><span id="TurnaroundOperations.request_turnaround-3803"><a href="#TurnaroundOperations.request_turnaround-3803"><span class="linenos">3803</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">last_flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations.request_turnaround-3804"><a href="#TurnaroundOperations.request_turnaround-3804"><span class="linenos">3804</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aircraft&#39;</span><span class="p">:</span> <span class="n">aircraft</span><span class="p">,</span>
</span><span id="TurnaroundOperations.request_turnaround-3805"><a href="#TurnaroundOperations.request_turnaround-3805"><span class="linenos">3805</span></a>						<span class="s1">&#39;ao_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">airline_type</span><span class="p">,</span>
</span><span id="TurnaroundOperations.request_turnaround-3806"><a href="#TurnaroundOperations.request_turnaround-3806"><span class="linenos">3806</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">next_flight_uid</span>
</span><span id="TurnaroundOperations.request_turnaround-3807"><a href="#TurnaroundOperations.request_turnaround-3807"><span class="linenos">3807</span></a>						<span class="p">}</span>
</span><span id="TurnaroundOperations.request_turnaround-3808"><a href="#TurnaroundOperations.request_turnaround-3808"><span class="linenos">3808</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="TurnaroundOperations.request_departing_reassessment" class="classattr">
                                        <input id="TurnaroundOperations.request_departing_reassessment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_departing_reassessment</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">ac_ready_at_time</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.request_departing_reassessment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.request_departing_reassessment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.request_departing_reassessment-3810"><a href="#TurnaroundOperations.request_departing_reassessment-3810"><span class="linenos">3810</span></a>	<span class="k">def</span> <span class="nf">request_departing_reassessment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">):</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3811"><a href="#TurnaroundOperations.request_departing_reassessment-3811"><span class="linenos">3811</span></a>		<span class="c1"># Internal message.</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3812"><a href="#TurnaroundOperations.request_departing_reassessment-3812"><span class="linenos">3812</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3813"><a href="#TurnaroundOperations.request_departing_reassessment-3813"><span class="linenos">3813</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;departing_reassessment_request&#39;</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3814"><a href="#TurnaroundOperations.request_departing_reassessment-3814"><span class="linenos">3814</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3815"><a href="#TurnaroundOperations.request_departing_reassessment-3815"><span class="linenos">3815</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3816"><a href="#TurnaroundOperations.request_departing_reassessment-3816"><span class="linenos">3816</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3817"><a href="#TurnaroundOperations.request_departing_reassessment-3817"><span class="linenos">3817</span></a>						<span class="s1">&#39;ac_ready_at_time&#39;</span><span class="p">:</span> <span class="n">ac_ready_at_time</span><span class="p">}</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3818"><a href="#TurnaroundOperations.request_departing_reassessment-3818"><span class="linenos">3818</span></a>
</span><span id="TurnaroundOperations.request_departing_reassessment-3819"><a href="#TurnaroundOperations.request_departing_reassessment-3819"><span class="linenos">3819</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">afp</span><span class="o">.</span><span class="n">wait_for_departing_reassessment_turnaround_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3820"><a href="#TurnaroundOperations.request_departing_reassessment-3820"><span class="linenos">3820</span></a>
</span><span id="TurnaroundOperations.request_departing_reassessment-3821"><a href="#TurnaroundOperations.request_departing_reassessment-3821"><span class="linenos">3821</span></a>		<span class="c1"># Uncomment the following line if you want to use the central messaging server.</span>
</span><span id="TurnaroundOperations.request_departing_reassessment-3822"><a href="#TurnaroundOperations.request_departing_reassessment-3822"><span class="linenos">3822</span></a>		<span class="c1"># self.send(msg)</span>
</span></pre></div>


    

                            </div>
                            <div id="TurnaroundOperations.wait_for_turnaround_time" class="classattr">
                                        <input id="TurnaroundOperations.wait_for_turnaround_time-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_turnaround_time</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TurnaroundOperations.wait_for_turnaround_time-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TurnaroundOperations.wait_for_turnaround_time"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TurnaroundOperations.wait_for_turnaround_time-3824"><a href="#TurnaroundOperations.wait_for_turnaround_time-3824"><span class="linenos">3824</span></a>	<span class="k">def</span> <span class="nf">wait_for_turnaround_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3825"><a href="#TurnaroundOperations.wait_for_turnaround_time-3825"><span class="linenos">3825</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives turnaround time for flight&#39;</span><span class="p">,</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3826"><a href="#TurnaroundOperations.wait_for_turnaround_time-3826"><span class="linenos">3826</span></a>				<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">],</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3827"><a href="#TurnaroundOperations.wait_for_turnaround_time-3827"><span class="linenos">3827</span></a>				<span class="s1">&#39;at time t=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3828"><a href="#TurnaroundOperations.wait_for_turnaround_time-3828"><span class="linenos">3828</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3829"><a href="#TurnaroundOperations.wait_for_turnaround_time-3829"><span class="linenos">3829</span></a>		<span class="n">flight_uid</span><span class="p">,</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;turnaround_time&#39;</span><span class="p">]</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3830"><a href="#TurnaroundOperations.wait_for_turnaround_time-3830"><span class="linenos">3830</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3831"><a href="#TurnaroundOperations.wait_for_turnaround_time-3831"><span class="linenos">3831</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3832"><a href="#TurnaroundOperations.wait_for_turnaround_time-3832"><span class="linenos">3832</span></a>		<span class="c1"># 	print(&quot;{} received turnaround time for flight {}: {} (t={})&quot;.format(self.agent, flight_uid, tt, self.agent.env.now))</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3833"><a href="#TurnaroundOperations.wait_for_turnaround_time-3833"><span class="linenos">3833</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3834"><a href="#TurnaroundOperations.wait_for_turnaround_time-3834"><span class="linenos">3834</span></a>		<span class="n">ac_ready_at_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">tt</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3835"><a href="#TurnaroundOperations.wait_for_turnaround_time-3835"><span class="linenos">3835</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3836"><a href="#TurnaroundOperations.wait_for_turnaround_time-3836"><span class="linenos">3836</span></a>		<span class="c1"># print(ac_ready_at_time, self.agent.aoc_flights_info[flight_uid][&#39;aircraft&#39;].bada_code_ac_model)</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3837"><a href="#TurnaroundOperations.wait_for_turnaround_time-3837"><span class="linenos">3837</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3838"><a href="#TurnaroundOperations.wait_for_turnaround_time-3838"><span class="linenos">3838</span></a>		<span class="n">reactionar_del</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">])</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3839"><a href="#TurnaroundOperations.wait_for_turnaround_time-3839"><span class="linenos">3839</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3840"><a href="#TurnaroundOperations.wait_for_turnaround_time-3840"><span class="linenos">3840</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3841"><a href="#TurnaroundOperations.wait_for_turnaround_time-3841"><span class="linenos">3841</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;reactionary_delay_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3842"><a href="#TurnaroundOperations.wait_for_turnaround_time-3842"><span class="linenos">3842</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;ac_ready_time_prior_FP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ac_ready_at_time</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3843"><a href="#TurnaroundOperations.wait_for_turnaround_time-3843"><span class="linenos">3843</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3844"><a href="#TurnaroundOperations.wait_for_turnaround_time-3844"><span class="linenos">3844</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span> <span class="o">=</span> <span class="n">reactionar_del</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3845"><a href="#TurnaroundOperations.wait_for_turnaround_time-3845"><span class="linenos">3845</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3846"><a href="#TurnaroundOperations.wait_for_turnaround_time-3846"><span class="linenos">3846</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Aircraft will be ready for flight&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3847"><a href="#TurnaroundOperations.wait_for_turnaround_time-3847"><span class="linenos">3847</span></a>				<span class="s1">&#39;at&#39;</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3848"><a href="#TurnaroundOperations.wait_for_turnaround_time-3848"><span class="linenos">3848</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Flight has&#39;</span><span class="p">,</span> <span class="n">reactionar_del</span><span class="p">,</span> <span class="s1">&#39;of reactionary_delay.&#39;</span><span class="p">)</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3849"><a href="#TurnaroundOperations.wait_for_turnaround_time-3849"><span class="linenos">3849</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3850"><a href="#TurnaroundOperations.wait_for_turnaround_time-3850"><span class="linenos">3850</span></a>		<span class="c1"># if flight_uid in flight_uid_DEBUG:</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3851"><a href="#TurnaroundOperations.wait_for_turnaround_time-3851"><span class="linenos">3851</span></a>		<span class="c1"># 	print(&quot;{} requests departing reassessment for flight {} with ac_ready_at_time {}&quot;.format(self.agent, flight_uid, ac_ready_at_time))</span>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3852"><a href="#TurnaroundOperations.wait_for_turnaround_time-3852"><span class="linenos">3852</span></a>
</span><span id="TurnaroundOperations.wait_for_turnaround_time-3853"><a href="#TurnaroundOperations.wait_for_turnaround_time-3853"><span class="linenos">3853</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">request_departing_reassessment</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">ac_ready_at_time</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="TurnaroundOperations.__init__" class="function"><a href="agent_base.html#Role.__init__">Role</a></dd>
                <dd id="TurnaroundOperations.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="TurnaroundOperations.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AirlinePaxHandler">
                            <input id="AirlinePaxHandler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AirlinePaxHandler</span><wbr>(<span class="base"><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></span>):

                <label class="view-source-button" for="AirlinePaxHandler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler-3856"><a href="#AirlinePaxHandler-3856"><span class="linenos">3856</span></a><span class="k">class</span> <span class="nc">AirlinePaxHandler</span><span class="p">(</span><span class="n">Role</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3857"><a href="#AirlinePaxHandler-3857"><span class="linenos">3857</span></a><span class="w">	</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3858"><a href="#AirlinePaxHandler-3858"><span class="linenos">3858</span></a><span class="sd">	APH</span>
</span><span id="AirlinePaxHandler-3859"><a href="#AirlinePaxHandler-3859"><span class="linenos">3859</span></a>
</span><span id="AirlinePaxHandler-3860"><a href="#AirlinePaxHandler-3860"><span class="linenos">3860</span></a><span class="sd">	Description: When a flight arrives direct passengers to connecting flights. All passengers connecting to flight that have already left are requested to be rebooked.</span>
</span><span id="AirlinePaxHandler-3861"><a href="#AirlinePaxHandler-3861"><span class="linenos">3861</span></a>
</span><span id="AirlinePaxHandler-3862"><a href="#AirlinePaxHandler-3862"><span class="linenos">3862</span></a><span class="sd">	Added from D4.1 description:</span>
</span><span id="AirlinePaxHandler-3863"><a href="#AirlinePaxHandler-3863"><span class="linenos">3863</span></a><span class="sd">	Embark passengers ready to be embarked.</span>
</span><span id="AirlinePaxHandler-3864"><a href="#AirlinePaxHandler-3864"><span class="linenos">3864</span></a><span class="sd">	&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3865"><a href="#AirlinePaxHandler-3865"><span class="linenos">3865</span></a>
</span><span id="AirlinePaxHandler-3866"><a href="#AirlinePaxHandler-3866"><span class="linenos">3866</span></a>	<span class="k">def</span> <span class="nf">_assume_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3867"><a href="#AirlinePaxHandler-3867"><span class="linenos">3867</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;pays&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">,</span> <span class="s1">&#39;for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-3868"><a href="#AirlinePaxHandler-3868"><span class="linenos">3868</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="n">cost_type</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cost</span>
</span><span id="AirlinePaxHandler-3869"><a href="#AirlinePaxHandler-3869"><span class="linenos">3869</span></a>
</span><span id="AirlinePaxHandler-3870"><a href="#AirlinePaxHandler-3870"><span class="linenos">3870</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3871"><a href="#AirlinePaxHandler-3871"><span class="linenos">3871</span></a>		<span class="c1"># Added from D4.1</span>
</span><span id="AirlinePaxHandler-3872"><a href="#AirlinePaxHandler-3872"><span class="linenos">3872</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="AirlinePaxHandler-3873"><a href="#AirlinePaxHandler-3873"><span class="linenos">3873</span></a>
</span><span id="AirlinePaxHandler-3874"><a href="#AirlinePaxHandler-3874"><span class="linenos">3874</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3875"><a href="#AirlinePaxHandler-3875"><span class="linenos">3875</span></a>			<span class="c1"># Compute main cause of delays</span>
</span><span id="AirlinePaxHandler-3876"><a href="#AirlinePaxHandler-3876"><span class="linenos">3876</span></a>			<span class="c1"># Non-ATFM</span>
</span><span id="AirlinePaxHandler-3877"><a href="#AirlinePaxHandler-3877"><span class="linenos">3877</span></a>			<span class="n">delay_non_atfm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-3878"><a href="#AirlinePaxHandler-3878"><span class="linenos">3878</span></a>
</span><span id="AirlinePaxHandler-3879"><a href="#AirlinePaxHandler-3879"><span class="linenos">3879</span></a>			<span class="c1"># ATFM</span>
</span><span id="AirlinePaxHandler-3880"><a href="#AirlinePaxHandler-3880"><span class="linenos">3880</span></a>			<span class="n">delay_ATFM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-3881"><a href="#AirlinePaxHandler-3881"><span class="linenos">3881</span></a>
</span><span id="AirlinePaxHandler-3882"><a href="#AirlinePaxHandler-3882"><span class="linenos">3882</span></a>			<span class="c1"># Reactionary delay</span>
</span><span id="AirlinePaxHandler-3883"><a href="#AirlinePaxHandler-3883"><span class="linenos">3883</span></a>			<span class="n">delay_reac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span>
</span><span id="AirlinePaxHandler-3884"><a href="#AirlinePaxHandler-3884"><span class="linenos">3884</span></a>
</span><span id="AirlinePaxHandler-3885"><a href="#AirlinePaxHandler-3885"><span class="linenos">3885</span></a>			<span class="k">if</span> <span class="n">delay_non_atfm</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_ATFM</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_reac</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3886"><a href="#AirlinePaxHandler-3886"><span class="linenos">3886</span></a>				<span class="c1"># Find out the biggest delay</span>
</span><span id="AirlinePaxHandler-3887"><a href="#AirlinePaxHandler-3887"><span class="linenos">3887</span></a>				<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-3888"><a href="#AirlinePaxHandler-3888"><span class="linenos">3888</span></a>
</span><span id="AirlinePaxHandler-3889"><a href="#AirlinePaxHandler-3889"><span class="linenos">3889</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;finds its biggest delay among:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-3890"><a href="#AirlinePaxHandler-3890"><span class="linenos">3890</span></a>
</span><span id="AirlinePaxHandler-3891"><a href="#AirlinePaxHandler-3891"><span class="linenos">3891</span></a>				<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3892"><a href="#AirlinePaxHandler-3892"><span class="linenos">3892</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TA&#39;</span>  <span class="c1"># for turnaround</span>
</span><span id="AirlinePaxHandler-3893"><a href="#AirlinePaxHandler-3893"><span class="linenos">3893</span></a>				<span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3894"><a href="#AirlinePaxHandler-3894"><span class="linenos">3894</span></a>					<span class="c1"># if not self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay is None:</span>
</span><span id="AirlinePaxHandler-3895"><a href="#AirlinePaxHandler-3895"><span class="linenos">3895</span></a>					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3896"><a href="#AirlinePaxHandler-3896"><span class="linenos">3896</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
</span><span id="AirlinePaxHandler-3897"><a href="#AirlinePaxHandler-3897"><span class="linenos">3897</span></a>					<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;C_AP&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3898"><a href="#AirlinePaxHandler-3898"><span class="linenos">3898</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
</span><span id="AirlinePaxHandler-3899"><a href="#AirlinePaxHandler-3899"><span class="linenos">3899</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3900"><a href="#AirlinePaxHandler-3900"><span class="linenos">3900</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ER&#39;</span>  <span class="c1"># for en-route</span>
</span><span id="AirlinePaxHandler-3901"><a href="#AirlinePaxHandler-3901"><span class="linenos">3901</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3902"><a href="#AirlinePaxHandler-3902"><span class="linenos">3902</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RD&#39;</span>  <span class="c1"># for reactionary delay</span>
</span><span id="AirlinePaxHandler-3903"><a href="#AirlinePaxHandler-3903"><span class="linenos">3903</span></a>
</span><span id="AirlinePaxHandler-3904"><a href="#AirlinePaxHandler-3904"><span class="linenos">3904</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">board_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3905"><a href="#AirlinePaxHandler-3905"><span class="linenos">3905</span></a>
</span><span id="AirlinePaxHandler-3906"><a href="#AirlinePaxHandler-3906"><span class="linenos">3906</span></a>	<span class="k">def</span> <span class="nf">check_delay_liability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3907"><a href="#AirlinePaxHandler-3907"><span class="linenos">3907</span></a>		<span class="k">if</span> <span class="n">current_flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3908"><a href="#AirlinePaxHandler-3908"><span class="linenos">3908</span></a>			<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-3909"><a href="#AirlinePaxHandler-3909"><span class="linenos">3909</span></a>
</span><span id="AirlinePaxHandler-3910"><a href="#AirlinePaxHandler-3910"><span class="linenos">3910</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TA&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3911"><a href="#AirlinePaxHandler-3911"><span class="linenos">3911</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3912"><a href="#AirlinePaxHandler-3912"><span class="linenos">3912</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3913"><a href="#AirlinePaxHandler-3913"><span class="linenos">3913</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3914"><a href="#AirlinePaxHandler-3914"><span class="linenos">3914</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler-3915"><a href="#AirlinePaxHandler-3915"><span class="linenos">3915</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3916"><a href="#AirlinePaxHandler-3916"><span class="linenos">3916</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3917"><a href="#AirlinePaxHandler-3917"><span class="linenos">3917</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler-3918"><a href="#AirlinePaxHandler-3918"><span class="linenos">3918</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler-3919"><a href="#AirlinePaxHandler-3919"><span class="linenos">3919</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3920"><a href="#AirlinePaxHandler-3920"><span class="linenos">3920</span></a>			<span class="c1"># pax.entitled = pax.reac_entitled</span>
</span><span id="AirlinePaxHandler-3921"><a href="#AirlinePaxHandler-3921"><span class="linenos">3921</span></a>			<span class="c1"># This could be better done by understanding the main reason for this flight to</span>
</span><span id="AirlinePaxHandler-3922"><a href="#AirlinePaxHandler-3922"><span class="linenos">3922</span></a>			<span class="c1"># be cancelled.</span>
</span><span id="AirlinePaxHandler-3923"><a href="#AirlinePaxHandler-3923"><span class="linenos">3923</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3924"><a href="#AirlinePaxHandler-3924"><span class="linenos">3924</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3925"><a href="#AirlinePaxHandler-3925"><span class="linenos">3925</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3926"><a href="#AirlinePaxHandler-3926"><span class="linenos">3926</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3927"><a href="#AirlinePaxHandler-3927"><span class="linenos">3927</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler-3928"><a href="#AirlinePaxHandler-3928"><span class="linenos">3928</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3929"><a href="#AirlinePaxHandler-3929"><span class="linenos">3929</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span>
</span><span id="AirlinePaxHandler-3930"><a href="#AirlinePaxHandler-3930"><span class="linenos">3930</span></a>
</span><span id="AirlinePaxHandler-3931"><a href="#AirlinePaxHandler-3931"><span class="linenos">3931</span></a>	<span class="k">def</span> <span class="nf">do_pax_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3932"><a href="#AirlinePaxHandler-3932"><span class="linenos">3932</span></a>		<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-3933"><a href="#AirlinePaxHandler-3933"><span class="linenos">3933</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3934"><a href="#AirlinePaxHandler-3934"><span class="linenos">3934</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">+=</span> <span class="n">doc</span>
</span><span id="AirlinePaxHandler-3935"><a href="#AirlinePaxHandler-3935"><span class="linenos">3935</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;blames&#39;</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="p">,</span> <span class="s1">&#39;for the DOC cost:&#39;</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-3936"><a href="#AirlinePaxHandler-3936"><span class="linenos">3936</span></a>				<span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3937"><a href="#AirlinePaxHandler-3937"><span class="linenos">3937</span></a>
</span><span id="AirlinePaxHandler-3938"><a href="#AirlinePaxHandler-3938"><span class="linenos">3938</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;DOC&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="n">current_flight_uid</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3939"><a href="#AirlinePaxHandler-3939"><span class="linenos">3939</span></a>		<span class="c1"># if current_flight_uid in self.agent.own_flights():</span>
</span><span id="AirlinePaxHandler-3940"><a href="#AirlinePaxHandler-3940"><span class="linenos">3940</span></a>		<span class="c1">#     self.agent.aoc_flights_info[current_flight_uid][&#39;DOC&#39;] += doc</span>
</span><span id="AirlinePaxHandler-3941"><a href="#AirlinePaxHandler-3941"><span class="linenos">3941</span></a>		<span class="c1"># else:</span>
</span><span id="AirlinePaxHandler-3942"><a href="#AirlinePaxHandler-3942"><span class="linenos">3942</span></a>		<span class="c1">#     self.agent.aph.send_cost_blame(current_flight_uid, doc, &#39;DOC&#39;)</span>
</span><span id="AirlinePaxHandler-3943"><a href="#AirlinePaxHandler-3943"><span class="linenos">3943</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has been cared for (&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;euros in total) for a delay of &#39;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3944"><a href="#AirlinePaxHandler-3944"><span class="linenos">3944</span></a>
</span><span id="AirlinePaxHandler-3945"><a href="#AirlinePaxHandler-3945"><span class="linenos">3945</span></a>	<span class="k">def</span> <span class="nf">board_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3946"><a href="#AirlinePaxHandler-3946"><span class="linenos">3946</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3947"><a href="#AirlinePaxHandler-3947"><span class="linenos">3947</span></a><span class="sd">		Note: added from D4.1</span>
</span><span id="AirlinePaxHandler-3948"><a href="#AirlinePaxHandler-3948"><span class="linenos">3948</span></a><span class="sd">		Note: duty of care is now given to passengers just before their boarding,</span>
</span><span id="AirlinePaxHandler-3949"><a href="#AirlinePaxHandler-3949"><span class="linenos">3949</span></a><span class="sd">		based on how much they waited to depart. Note that end of boarding</span>
</span><span id="AirlinePaxHandler-3950"><a href="#AirlinePaxHandler-3950"><span class="linenos">3950</span></a><span class="sd">		coincides with off-block, so we now exactly how long they waited up</span>
</span><span id="AirlinePaxHandler-3951"><a href="#AirlinePaxHandler-3951"><span class="linenos">3951</span></a><span class="sd">		until their real departure.</span>
</span><span id="AirlinePaxHandler-3952"><a href="#AirlinePaxHandler-3952"><span class="linenos">3952</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3953"><a href="#AirlinePaxHandler-3953"><span class="linenos">3953</span></a>		<span class="n">pax_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler-3954"><a href="#AirlinePaxHandler-3954"><span class="linenos">3954</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax to board for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-3955"><a href="#AirlinePaxHandler-3955"><span class="linenos">3955</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlinePaxHandler-3956"><a href="#AirlinePaxHandler-3956"><span class="linenos">3956</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span> <span class="ow">and</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3957"><a href="#AirlinePaxHandler-3957"><span class="linenos">3957</span></a>				<span class="c1"># pax ready to board</span>
</span><span id="AirlinePaxHandler-3958"><a href="#AirlinePaxHandler-3958"><span class="linenos">3958</span></a>				<span class="n">pax_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3959"><a href="#AirlinePaxHandler-3959"><span class="linenos">3959</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3960"><a href="#AirlinePaxHandler-3960"><span class="linenos">3960</span></a>
</span><span id="AirlinePaxHandler-3961"><a href="#AirlinePaxHandler-3961"><span class="linenos">3961</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">board_next_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-3962"><a href="#AirlinePaxHandler-3962"><span class="linenos">3962</span></a>
</span><span id="AirlinePaxHandler-3963"><a href="#AirlinePaxHandler-3963"><span class="linenos">3963</span></a>				<span class="c1"># Check duty of care</span>
</span><span id="AirlinePaxHandler-3964"><a href="#AirlinePaxHandler-3964"><span class="linenos">3964</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span>  <span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;]</span>
</span><span id="AirlinePaxHandler-3965"><a href="#AirlinePaxHandler-3965"><span class="linenos">3965</span></a>
</span><span id="AirlinePaxHandler-3966"><a href="#AirlinePaxHandler-3966"><span class="linenos">3966</span></a>				<span class="c1"># Do pax care</span>
</span><span id="AirlinePaxHandler-3967"><a href="#AirlinePaxHandler-3967"><span class="linenos">3967</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3968"><a href="#AirlinePaxHandler-3968"><span class="linenos">3968</span></a>
</span><span id="AirlinePaxHandler-3969"><a href="#AirlinePaxHandler-3969"><span class="linenos">3969</span></a>				<span class="c1"># Check for future compensation entitlement</span>
</span><span id="AirlinePaxHandler-3970"><a href="#AirlinePaxHandler-3970"><span class="linenos">3970</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3971"><a href="#AirlinePaxHandler-3971"><span class="linenos">3971</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3972"><a href="#AirlinePaxHandler-3972"><span class="linenos">3972</span></a>				<span class="c1"># pax not ready to board</span>
</span><span id="AirlinePaxHandler-3973"><a href="#AirlinePaxHandler-3973"><span class="linenos">3973</span></a>				<span class="c1"># The passenger reallocation role picks them up and reallocate them</span>
</span><span id="AirlinePaxHandler-3974"><a href="#AirlinePaxHandler-3974"><span class="linenos">3974</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is not ready to board:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;; arrival time at gate:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3975"><a href="#AirlinePaxHandler-3975"><span class="linenos">3975</span></a>				<span class="c1"># pax.idx_current_flight -= 1</span>
</span><span id="AirlinePaxHandler-3976"><a href="#AirlinePaxHandler-3976"><span class="linenos">3976</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="AirlinePaxHandler-3977"><a href="#AirlinePaxHandler-3977"><span class="linenos">3977</span></a>				<span class="c1"># mprint(pax, &#39;active flight is reverted to previous one:&#39;, pax.active_flight)</span>
</span><span id="AirlinePaxHandler-3978"><a href="#AirlinePaxHandler-3978"><span class="linenos">3978</span></a>
</span><span id="AirlinePaxHandler-3979"><a href="#AirlinePaxHandler-3979"><span class="linenos">3979</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_to_remove</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3980"><a href="#AirlinePaxHandler-3980"><span class="linenos">3980</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3981"><a href="#AirlinePaxHandler-3981"><span class="linenos">3981</span></a>
</span><span id="AirlinePaxHandler-3982"><a href="#AirlinePaxHandler-3982"><span class="linenos">3982</span></a>	<span class="k">def</span> <span class="nf">arrive_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-3983"><a href="#AirlinePaxHandler-3983"><span class="linenos">3983</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3984"><a href="#AirlinePaxHandler-3984"><span class="linenos">3984</span></a><span class="sd">		If overnight is True, the passenger need to be cared for for the night.</span>
</span><span id="AirlinePaxHandler-3985"><a href="#AirlinePaxHandler-3985"><span class="linenos">3985</span></a><span class="sd">		WARNING: this method assumes that it is executed exactly when at the in-block</span>
</span><span id="AirlinePaxHandler-3986"><a href="#AirlinePaxHandler-3986"><span class="linenos">3986</span></a><span class="sd">		time of the last flight.</span>
</span><span id="AirlinePaxHandler-3987"><a href="#AirlinePaxHandler-3987"><span class="linenos">3987</span></a><span class="sd">		Note: paxs are paid first, then costs for airlines are computed.</span>
</span><span id="AirlinePaxHandler-3988"><a href="#AirlinePaxHandler-3988"><span class="linenos">3988</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler-3989"><a href="#AirlinePaxHandler-3989"><span class="linenos">3989</span></a>		<span class="c1"># Passengers arrived</span>
</span><span id="AirlinePaxHandler-3990"><a href="#AirlinePaxHandler-3990"><span class="linenos">3990</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;arrived&#39;</span>
</span><span id="AirlinePaxHandler-3991"><a href="#AirlinePaxHandler-3991"><span class="linenos">3991</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has finished their journey.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3992"><a href="#AirlinePaxHandler-3992"><span class="linenos">3992</span></a>
</span><span id="AirlinePaxHandler-3993"><a href="#AirlinePaxHandler-3993"><span class="linenos">3993</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3994"><a href="#AirlinePaxHandler-3994"><span class="linenos">3994</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-3995"><a href="#AirlinePaxHandler-3995"><span class="linenos">3995</span></a>			<span class="c1"># mprint(pax, &#39;has an initial_aobt:&#39;, pax.initial_aobt)</span>
</span><span id="AirlinePaxHandler-3996"><a href="#AirlinePaxHandler-3996"><span class="linenos">3996</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-3997"><a href="#AirlinePaxHandler-3997"><span class="linenos">3997</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler-3998"><a href="#AirlinePaxHandler-3998"><span class="linenos">3998</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has not taken any flight.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-3999"><a href="#AirlinePaxHandler-3999"><span class="linenos">3999</span></a>
</span><span id="AirlinePaxHandler-4000"><a href="#AirlinePaxHandler-4000"><span class="linenos">4000</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4001"><a href="#AirlinePaxHandler-4001"><span class="linenos">4001</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4002"><a href="#AirlinePaxHandler-4002"><span class="linenos">4002</span></a>			<span class="c1"># mprint(pax, &#39;has an final_aibt:&#39;, pax.final_aibt)</span>
</span><span id="AirlinePaxHandler-4003"><a href="#AirlinePaxHandler-4003"><span class="linenos">4003</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4004"><a href="#AirlinePaxHandler-4004"><span class="linenos">4004</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler-4005"><a href="#AirlinePaxHandler-4005"><span class="linenos">4005</span></a>			<span class="c1"># mprint(pax, &#39;has not taken any flight (bis).&#39;)</span>
</span><span id="AirlinePaxHandler-4006"><a href="#AirlinePaxHandler-4006"><span class="linenos">4006</span></a>
</span><span id="AirlinePaxHandler-4007"><a href="#AirlinePaxHandler-4007"><span class="linenos">4007</span></a>		<span class="n">it_so_far</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4008"><a href="#AirlinePaxHandler-4008"><span class="linenos">4008</span></a>
</span><span id="AirlinePaxHandler-4009"><a href="#AirlinePaxHandler-4009"><span class="linenos">4009</span></a>		<span class="k">if</span> <span class="n">overnight</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4010"><a href="#AirlinePaxHandler-4010"><span class="linenos">4010</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span id="AirlinePaxHandler-4011"><a href="#AirlinePaxHandler-4011"><span class="linenos">4011</span></a>			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="AirlinePaxHandler-4012"><a href="#AirlinePaxHandler-4012"><span class="linenos">4012</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4013"><a href="#AirlinePaxHandler-4013"><span class="linenos">4013</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4014"><a href="#AirlinePaxHandler-4014"><span class="linenos">4014</span></a>
</span><span id="AirlinePaxHandler-4015"><a href="#AirlinePaxHandler-4015"><span class="linenos">4015</span></a>			<span class="c1"># Duty of care here (because there is no more flight!)</span>
</span><span id="AirlinePaxHandler-4016"><a href="#AirlinePaxHandler-4016"><span class="linenos">4016</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4017"><a href="#AirlinePaxHandler-4017"><span class="linenos">4017</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4018"><a href="#AirlinePaxHandler-4018"><span class="linenos">4018</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4019"><a href="#AirlinePaxHandler-4019"><span class="linenos">4019</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span>
</span><span id="AirlinePaxHandler-4020"><a href="#AirlinePaxHandler-4020"><span class="linenos">4020</span></a>
</span><span id="AirlinePaxHandler-4021"><a href="#AirlinePaxHandler-4021"><span class="linenos">4021</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="n">tot_arrival_delay</span>
</span><span id="AirlinePaxHandler-4022"><a href="#AirlinePaxHandler-4022"><span class="linenos">4022</span></a>
</span><span id="AirlinePaxHandler-4023"><a href="#AirlinePaxHandler-4023"><span class="linenos">4023</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">final_destination_reached</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_airport</span>
</span><span id="AirlinePaxHandler-4024"><a href="#AirlinePaxHandler-4024"><span class="linenos">4024</span></a>
</span><span id="AirlinePaxHandler-4025"><a href="#AirlinePaxHandler-4025"><span class="linenos">4025</span></a>		<span class="c1"># Soft cost is payed with compensation, during the blame</span>
</span><span id="AirlinePaxHandler-4026"><a href="#AirlinePaxHandler-4026"><span class="linenos">4026</span></a>		<span class="n">soft_cost</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4027"><a href="#AirlinePaxHandler-4027"><span class="linenos">4027</span></a>
</span><span id="AirlinePaxHandler-4028"><a href="#AirlinePaxHandler-4028"><span class="linenos">4028</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="n">soft_cost</span>
</span><span id="AirlinePaxHandler-4029"><a href="#AirlinePaxHandler-4029"><span class="linenos">4029</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has triggered a soft cost for delay (&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4030"><a href="#AirlinePaxHandler-4030"><span class="linenos">4030</span></a>
</span><span id="AirlinePaxHandler-4031"><a href="#AirlinePaxHandler-4031"><span class="linenos">4031</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="ow">or</span> <span class="n">pax</span><span class="o">.</span><span class="n">force_entitled</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4032"><a href="#AirlinePaxHandler-4032"><span class="linenos">4032</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is entitled to compensation. Total arrival delay:&#39;</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="s1">&#39;with a distance:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4033"><a href="#AirlinePaxHandler-4033"><span class="linenos">4033</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">)</span>  <span class="c1"># * pax.n_pax * self.agent.compensation_uptake`</span>
</span><span id="AirlinePaxHandler-4034"><a href="#AirlinePaxHandler-4034"><span class="linenos">4034</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4035"><a href="#AirlinePaxHandler-4035"><span class="linenos">4035</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlinePaxHandler-4036"><a href="#AirlinePaxHandler-4036"><span class="linenos">4036</span></a>
</span><span id="AirlinePaxHandler-4037"><a href="#AirlinePaxHandler-4037"><span class="linenos">4037</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">compensation</span>
</span><span id="AirlinePaxHandler-4038"><a href="#AirlinePaxHandler-4038"><span class="linenos">4038</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;have been compensated for delay (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4039"><a href="#AirlinePaxHandler-4039"><span class="linenos">4039</span></a>
</span><span id="AirlinePaxHandler-4040"><a href="#AirlinePaxHandler-4040"><span class="linenos">4040</span></a>		<span class="k">if</span> <span class="n">compensation</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">soft_cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4041"><a href="#AirlinePaxHandler-4041"><span class="linenos">4041</span></a>			<span class="c1"># Find out who is mainly responsible for the compensation</span>
</span><span id="AirlinePaxHandler-4042"><a href="#AirlinePaxHandler-4042"><span class="linenos">4042</span></a>			<span class="c1"># Note: if it is because of a cancelled flight,</span>
</span><span id="AirlinePaxHandler-4043"><a href="#AirlinePaxHandler-4043"><span class="linenos">4043</span></a>			<span class="c1"># the blame is already given.</span>
</span><span id="AirlinePaxHandler-4044"><a href="#AirlinePaxHandler-4044"><span class="linenos">4044</span></a>			<span class="c1"># The following function is cancelling the compensation if it finds</span>
</span><span id="AirlinePaxHandler-4045"><a href="#AirlinePaxHandler-4045"><span class="linenos">4045</span></a>			<span class="c1"># that the pax is ultimately responsible for its delay.</span>
</span><span id="AirlinePaxHandler-4046"><a href="#AirlinePaxHandler-4046"><span class="linenos">4046</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4047"><a href="#AirlinePaxHandler-4047"><span class="linenos">4047</span></a>
</span><span id="AirlinePaxHandler-4048"><a href="#AirlinePaxHandler-4048"><span class="linenos">4048</span></a>		<span class="c1"># Record the real itinerary. `If&#39; is here to avoid flag modified if true itinerary.</span>
</span><span id="AirlinePaxHandler-4049"><a href="#AirlinePaxHandler-4049"><span class="linenos">4049</span></a>		<span class="c1"># KEEP THIS BIT AT THE END THE METHOD UNLESS YOU KNOW WHAT YOU ARE DOING</span>
</span><span id="AirlinePaxHandler-4050"><a href="#AirlinePaxHandler-4050"><span class="linenos">4050</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4051"><a href="#AirlinePaxHandler-4051"><span class="linenos">4051</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">())</span>
</span><span id="AirlinePaxHandler-4052"><a href="#AirlinePaxHandler-4052"><span class="linenos">4052</span></a>
</span><span id="AirlinePaxHandler-4053"><a href="#AirlinePaxHandler-4053"><span class="linenos">4053</span></a>	<span class="k">def</span> <span class="nf">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4054"><a href="#AirlinePaxHandler-4054"><span class="linenos">4054</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;tries to find the flight to blame for compensation and soft cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4055"><a href="#AirlinePaxHandler-4055"><span class="linenos">4055</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4056"><a href="#AirlinePaxHandler-4056"><span class="linenos">4056</span></a>			<span class="c1"># if should be entered only if pax was not on a flight which has</span>
</span><span id="AirlinePaxHandler-4057"><a href="#AirlinePaxHandler-4057"><span class="linenos">4057</span></a>			<span class="c1"># been cancelled</span>
</span><span id="AirlinePaxHandler-4058"><a href="#AirlinePaxHandler-4058"><span class="linenos">4058</span></a>			<span class="c1"># if len(pax.old_itineraries) == 0 or :</span>
</span><span id="AirlinePaxHandler-4059"><a href="#AirlinePaxHandler-4059"><span class="linenos">4059</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4060"><a href="#AirlinePaxHandler-4060"><span class="linenos">4060</span></a>				<span class="c1"># Passenger has followed its planned itinerary</span>
</span><span id="AirlinePaxHandler-4061"><a href="#AirlinePaxHandler-4061"><span class="linenos">4061</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;did not miss a flight, it tries to blame its last flight first (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4062"><a href="#AirlinePaxHandler-4062"><span class="linenos">4062</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4063"><a href="#AirlinePaxHandler-4063"><span class="linenos">4063</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4064"><a href="#AirlinePaxHandler-4064"><span class="linenos">4064</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;missed at least a flight, it tries to blame the last flight of the original itinerary first&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4065"><a href="#AirlinePaxHandler-4065"><span class="linenos">4065</span></a>				<span class="c1"># Passenger has missed a flight at some point. Two cases can happen: either</span>
</span><span id="AirlinePaxHandler-4066"><a href="#AirlinePaxHandler-4066"><span class="linenos">4066</span></a>				<span class="c1"># they were reallocated, or they were not.</span>
</span><span id="AirlinePaxHandler-4067"><a href="#AirlinePaxHandler-4067"><span class="linenos">4067</span></a>				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4068"><a href="#AirlinePaxHandler-4068"><span class="linenos">4068</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has at least one old itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4069"><a href="#AirlinePaxHandler-4069"><span class="linenos">4069</span></a>					<span class="c1"># In this case, the pax has been reallocated at least once.</span>
</span><span id="AirlinePaxHandler-4070"><a href="#AirlinePaxHandler-4070"><span class="linenos">4070</span></a>					<span class="c1"># Find the last flight taken by the pax in the original itinerary</span>
</span><span id="AirlinePaxHandler-4071"><a href="#AirlinePaxHandler-4071"><span class="linenos">4071</span></a>					<span class="n">original_itinerary</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4072"><a href="#AirlinePaxHandler-4072"><span class="linenos">4072</span></a>					<span class="c1"># Find idx of first flight different in original and actual itinerary</span>
</span><span id="AirlinePaxHandler-4073"><a href="#AirlinePaxHandler-4073"><span class="linenos">4073</span></a>					<span class="c1"># #idx = next(i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]!=pax.itinerary[i])</span>
</span><span id="AirlinePaxHandler-4074"><a href="#AirlinePaxHandler-4074"><span class="linenos">4074</span></a>					<span class="c1"># try:</span>
</span><span id="AirlinePaxHandler-4075"><a href="#AirlinePaxHandler-4075"><span class="linenos">4075</span></a>					<span class="c1">#     idxs = [i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]==pax.itinerary[i]]</span>
</span><span id="AirlinePaxHandler-4076"><a href="#AirlinePaxHandler-4076"><span class="linenos">4076</span></a>					<span class="c1">#     idx = idxs[-1]</span>
</span><span id="AirlinePaxHandler-4077"><a href="#AirlinePaxHandler-4077"><span class="linenos">4077</span></a>					<span class="c1"># except:</span>
</span><span id="AirlinePaxHandler-4078"><a href="#AirlinePaxHandler-4078"><span class="linenos">4078</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;, original_itinerary, pax.itinerary, pax.old_itineraries)</span>
</span><span id="AirlinePaxHandler-4079"><a href="#AirlinePaxHandler-4079"><span class="linenos">4079</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;)</span>
</span><span id="AirlinePaxHandler-4080"><a href="#AirlinePaxHandler-4080"><span class="linenos">4080</span></a>					<span class="c1">#     raise</span>
</span><span id="AirlinePaxHandler-4081"><a href="#AirlinePaxHandler-4081"><span class="linenos">4081</span></a>
</span><span id="AirlinePaxHandler-4082"><a href="#AirlinePaxHandler-4082"><span class="linenos">4082</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlinePaxHandler-4083"><a href="#AirlinePaxHandler-4083"><span class="linenos">4083</span></a>					<span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_itinerary</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">))))</span> <span class="ow">and</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
</span><span id="AirlinePaxHandler-4084"><a href="#AirlinePaxHandler-4084"><span class="linenos">4084</span></a>						<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AirlinePaxHandler-4085"><a href="#AirlinePaxHandler-4085"><span class="linenos">4085</span></a>					<span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="AirlinePaxHandler-4086"><a href="#AirlinePaxHandler-4086"><span class="linenos">4086</span></a>
</span><span id="AirlinePaxHandler-4087"><a href="#AirlinePaxHandler-4087"><span class="linenos">4087</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4088"><a href="#AirlinePaxHandler-4088"><span class="linenos">4088</span></a>						<span class="k">assert</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="AirlinePaxHandler-4089"><a href="#AirlinePaxHandler-4089"><span class="linenos">4089</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4090"><a href="#AirlinePaxHandler-4090"><span class="linenos">4090</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">original_itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4091"><a href="#AirlinePaxHandler-4091"><span class="linenos">4091</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4092"><a href="#AirlinePaxHandler-4092"><span class="linenos">4092</span></a>						<span class="k">raise</span>
</span><span id="AirlinePaxHandler-4093"><a href="#AirlinePaxHandler-4093"><span class="linenos">4093</span></a>					<span class="c1"># Rmq: idx should not be -1, because it would mean that they missed the first</span>
</span><span id="AirlinePaxHandler-4094"><a href="#AirlinePaxHandler-4094"><span class="linenos">4094</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="AirlinePaxHandler-4095"><a href="#AirlinePaxHandler-4095"><span class="linenos">4095</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="AirlinePaxHandler-4096"><a href="#AirlinePaxHandler-4096"><span class="linenos">4096</span></a>
</span><span id="AirlinePaxHandler-4097"><a href="#AirlinePaxHandler-4097"><span class="linenos">4097</span></a>					<span class="c1"># Last common flight between origin and actual itinerary</span>
</span><span id="AirlinePaxHandler-4098"><a href="#AirlinePaxHandler-4098"><span class="linenos">4098</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># [idx-1]</span>
</span><span id="AirlinePaxHandler-4099"><a href="#AirlinePaxHandler-4099"><span class="linenos">4099</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4100"><a href="#AirlinePaxHandler-4100"><span class="linenos">4100</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has no old itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4101"><a href="#AirlinePaxHandler-4101"><span class="linenos">4101</span></a>					<span class="c1"># In this case, the pax has not been reallocated once (it missed its flight and)</span>
</span><span id="AirlinePaxHandler-4102"><a href="#AirlinePaxHandler-4102"><span class="linenos">4102</span></a>					<span class="c1"># could not find a suitable replacement.</span>
</span><span id="AirlinePaxHandler-4103"><a href="#AirlinePaxHandler-4103"><span class="linenos">4103</span></a>					<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>    <span class="c1"># this list should have exactly one element</span>
</span><span id="AirlinePaxHandler-4104"><a href="#AirlinePaxHandler-4104"><span class="linenos">4104</span></a>
</span><span id="AirlinePaxHandler-4105"><a href="#AirlinePaxHandler-4105"><span class="linenos">4105</span></a>					<span class="c1"># Find the idx of the missed flight.</span>
</span><span id="AirlinePaxHandler-4106"><a href="#AirlinePaxHandler-4106"><span class="linenos">4106</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4107"><a href="#AirlinePaxHandler-4107"><span class="linenos">4107</span></a>					<span class="c1"># Rmq: idx should not be 0, because it would mean that they missed the first</span>
</span><span id="AirlinePaxHandler-4108"><a href="#AirlinePaxHandler-4108"><span class="linenos">4108</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="AirlinePaxHandler-4109"><a href="#AirlinePaxHandler-4109"><span class="linenos">4109</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="AirlinePaxHandler-4110"><a href="#AirlinePaxHandler-4110"><span class="linenos">4110</span></a>					<span class="c1"># The last flight taken is the one before the missed flight.</span>
</span><span id="AirlinePaxHandler-4111"><a href="#AirlinePaxHandler-4111"><span class="linenos">4111</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4112"><a href="#AirlinePaxHandler-4112"><span class="linenos">4112</span></a>
</span><span id="AirlinePaxHandler-4113"><a href="#AirlinePaxHandler-4113"><span class="linenos">4113</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;took the flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">,</span> <span class="s1">&#39;last in its original itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4114"><a href="#AirlinePaxHandler-4114"><span class="linenos">4114</span></a>
</span><span id="AirlinePaxHandler-4115"><a href="#AirlinePaxHandler-4115"><span class="linenos">4115</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">last_flight</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4116"><a href="#AirlinePaxHandler-4116"><span class="linenos">4116</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4117"><a href="#AirlinePaxHandler-4117"><span class="linenos">4117</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4118"><a href="#AirlinePaxHandler-4118"><span class="linenos">4118</span></a>				<span class="c1"># self.blame_compensation_of_pax(pax, compensation)</span>
</span><span id="AirlinePaxHandler-4119"><a href="#AirlinePaxHandler-4119"><span class="linenos">4119</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4120"><a href="#AirlinePaxHandler-4120"><span class="linenos">4120</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4121"><a href="#AirlinePaxHandler-4121"><span class="linenos">4121</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4122"><a href="#AirlinePaxHandler-4122"><span class="linenos">4122</span></a>				<span class="c1"># Remove the compensation from the pax, it should not have it!</span>
</span><span id="AirlinePaxHandler-4123"><a href="#AirlinePaxHandler-4123"><span class="linenos">4123</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlinePaxHandler-4124"><a href="#AirlinePaxHandler-4124"><span class="linenos">4124</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlinePaxHandler-4125"><a href="#AirlinePaxHandler-4125"><span class="linenos">4125</span></a>
</span><span id="AirlinePaxHandler-4126"><a href="#AirlinePaxHandler-4126"><span class="linenos">4126</span></a>	<span class="k">def</span> <span class="nf">pay_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4127"><a href="#AirlinePaxHandler-4127"><span class="linenos">4127</span></a>		<span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4128"><a href="#AirlinePaxHandler-4128"><span class="linenos">4128</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4129"><a href="#AirlinePaxHandler-4129"><span class="linenos">4129</span></a>				<span class="k">if</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4130"><a href="#AirlinePaxHandler-4130"><span class="linenos">4130</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span>
</span><span id="AirlinePaxHandler-4131"><a href="#AirlinePaxHandler-4131"><span class="linenos">4131</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4132"><a href="#AirlinePaxHandler-4132"><span class="linenos">4132</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span>
</span><span id="AirlinePaxHandler-4133"><a href="#AirlinePaxHandler-4133"><span class="linenos">4133</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4134"><a href="#AirlinePaxHandler-4134"><span class="linenos">4134</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span>
</span><span id="AirlinePaxHandler-4135"><a href="#AirlinePaxHandler-4135"><span class="linenos">4135</span></a>
</span><span id="AirlinePaxHandler-4136"><a href="#AirlinePaxHandler-4136"><span class="linenos">4136</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">():</span>
</span><span id="AirlinePaxHandler-4137"><a href="#AirlinePaxHandler-4137"><span class="linenos">4137</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4138"><a href="#AirlinePaxHandler-4138"><span class="linenos">4138</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4139"><a href="#AirlinePaxHandler-4139"><span class="linenos">4139</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_cost_blame</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4140"><a href="#AirlinePaxHandler-4140"><span class="linenos">4140</span></a>
</span><span id="AirlinePaxHandler-4141"><a href="#AirlinePaxHandler-4141"><span class="linenos">4141</span></a>	<span class="k">def</span> <span class="nf">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4142"><a href="#AirlinePaxHandler-4142"><span class="linenos">4142</span></a>		<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlinePaxHandler-4143"><a href="#AirlinePaxHandler-4143"><span class="linenos">4143</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_follow_blame_request</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4144"><a href="#AirlinePaxHandler-4144"><span class="linenos">4144</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4145"><a href="#AirlinePaxHandler-4145"><span class="linenos">4145</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4146"><a href="#AirlinePaxHandler-4146"><span class="linenos">4146</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The main reason for delay of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4147"><a href="#AirlinePaxHandler-4147"><span class="linenos">4147</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RD&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4148"><a href="#AirlinePaxHandler-4148"><span class="linenos">4148</span></a>					<span class="c1"># If main cause is reactionary delay, find previous flight using the</span>
</span><span id="AirlinePaxHandler-4149"><a href="#AirlinePaxHandler-4149"><span class="linenos">4149</span></a>					<span class="c1"># same aircraft and redo the same procedure</span>
</span><span id="AirlinePaxHandler-4150"><a href="#AirlinePaxHandler-4150"><span class="linenos">4150</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4151"><a href="#AirlinePaxHandler-4151"><span class="linenos">4151</span></a>					<span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4152"><a href="#AirlinePaxHandler-4152"><span class="linenos">4152</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;tries to blame the previous flight (&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4153"><a href="#AirlinePaxHandler-4153"><span class="linenos">4153</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="AirlinePaxHandler-4154"><a href="#AirlinePaxHandler-4154"><span class="linenos">4154</span></a>												<span class="n">pax</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4155"><a href="#AirlinePaxHandler-4155"><span class="linenos">4155</span></a>												<span class="n">compensation</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4156"><a href="#AirlinePaxHandler-4156"><span class="linenos">4156</span></a>												<span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4157"><a href="#AirlinePaxHandler-4157"><span class="linenos">4157</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4158"><a href="#AirlinePaxHandler-4158"><span class="linenos">4158</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was the first one, it gets the blame&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4159"><a href="#AirlinePaxHandler-4159"><span class="linenos">4159</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4160"><a href="#AirlinePaxHandler-4160"><span class="linenos">4160</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4161"><a href="#AirlinePaxHandler-4161"><span class="linenos">4161</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4162"><a href="#AirlinePaxHandler-4162"><span class="linenos">4162</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4163"><a href="#AirlinePaxHandler-4163"><span class="linenos">4163</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4164"><a href="#AirlinePaxHandler-4164"><span class="linenos">4164</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;gets the blame&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4165"><a href="#AirlinePaxHandler-4165"><span class="linenos">4165</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4166"><a href="#AirlinePaxHandler-4166"><span class="linenos">4166</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4167"><a href="#AirlinePaxHandler-4167"><span class="linenos">4167</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4168"><a href="#AirlinePaxHandler-4168"><span class="linenos">4168</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4169"><a href="#AirlinePaxHandler-4169"><span class="linenos">4169</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4170"><a href="#AirlinePaxHandler-4170"><span class="linenos">4170</span></a>				<span class="c1"># This can happen either if the flight was cancelled of if it did not have</span>
</span><span id="AirlinePaxHandler-4171"><a href="#AirlinePaxHandler-4171"><span class="linenos">4171</span></a>				<span class="c1"># any delay at departure.</span>
</span><span id="AirlinePaxHandler-4172"><a href="#AirlinePaxHandler-4172"><span class="linenos">4172</span></a>				<span class="c1"># assert self.agent.aoc_flights_info[flight_uid][&#39;status&#39;] == &#39;cancelled&#39;</span>
</span><span id="AirlinePaxHandler-4173"><a href="#AirlinePaxHandler-4173"><span class="linenos">4173</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was cancelled, so it gets the blame.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4174"><a href="#AirlinePaxHandler-4174"><span class="linenos">4174</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4175"><a href="#AirlinePaxHandler-4175"><span class="linenos">4175</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4176"><a href="#AirlinePaxHandler-4176"><span class="linenos">4176</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4177"><a href="#AirlinePaxHandler-4177"><span class="linenos">4177</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4178"><a href="#AirlinePaxHandler-4178"><span class="linenos">4178</span></a>
</span><span id="AirlinePaxHandler-4179"><a href="#AirlinePaxHandler-4179"><span class="linenos">4179</span></a>	<span class="k">def</span> <span class="nf">request_reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4180"><a href="#AirlinePaxHandler-4180"><span class="linenos">4180</span></a>		<span class="c1"># This is an internal message.</span>
</span><span id="AirlinePaxHandler-4181"><a href="#AirlinePaxHandler-4181"><span class="linenos">4181</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4182"><a href="#AirlinePaxHandler-4182"><span class="linenos">4182</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlinePaxHandler-4183"><a href="#AirlinePaxHandler-4183"><span class="linenos">4183</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlinePaxHandler-4184"><a href="#AirlinePaxHandler-4184"><span class="linenos">4184</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="AirlinePaxHandler-4185"><a href="#AirlinePaxHandler-4185"><span class="linenos">4185</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="AirlinePaxHandler-4186"><a href="#AirlinePaxHandler-4186"><span class="linenos">4186</span></a>
</span><span id="AirlinePaxHandler-4187"><a href="#AirlinePaxHandler-4187"><span class="linenos">4187</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(APH role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4188"><a href="#AirlinePaxHandler-4188"><span class="linenos">4188</span></a>
</span><span id="AirlinePaxHandler-4189"><a href="#AirlinePaxHandler-4189"><span class="linenos">4189</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4190"><a href="#AirlinePaxHandler-4190"><span class="linenos">4190</span></a>
</span><span id="AirlinePaxHandler-4191"><a href="#AirlinePaxHandler-4191"><span class="linenos">4191</span></a>		<span class="c1"># Uncomment the following line if you want to use central server.</span>
</span><span id="AirlinePaxHandler-4192"><a href="#AirlinePaxHandler-4192"><span class="linenos">4192</span></a>		<span class="c1"># self.send(msg)</span>
</span><span id="AirlinePaxHandler-4193"><a href="#AirlinePaxHandler-4193"><span class="linenos">4193</span></a>
</span><span id="AirlinePaxHandler-4194"><a href="#AirlinePaxHandler-4194"><span class="linenos">4194</span></a>	<span class="k">def</span> <span class="nf">request_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">connection_type</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4195"><a href="#AirlinePaxHandler-4195"><span class="linenos">4195</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4196"><a href="#AirlinePaxHandler-4196"><span class="linenos">4196</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span>
</span><span id="AirlinePaxHandler-4197"><a href="#AirlinePaxHandler-4197"><span class="linenos">4197</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;connecting_times_request&#39;</span>
</span><span id="AirlinePaxHandler-4198"><a href="#AirlinePaxHandler-4198"><span class="linenos">4198</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4199"><a href="#AirlinePaxHandler-4199"><span class="linenos">4199</span></a>						<span class="s1">&#39;connection_type&#39;</span><span class="p">:</span> <span class="n">connection_type</span><span class="p">}</span>
</span><span id="AirlinePaxHandler-4200"><a href="#AirlinePaxHandler-4200"><span class="linenos">4200</span></a>
</span><span id="AirlinePaxHandler-4201"><a href="#AirlinePaxHandler-4201"><span class="linenos">4201</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4202"><a href="#AirlinePaxHandler-4202"><span class="linenos">4202</span></a>
</span><span id="AirlinePaxHandler-4203"><a href="#AirlinePaxHandler-4203"><span class="linenos">4203</span></a>	<span class="k">def</span> <span class="nf">request_pax_connection_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4204"><a href="#AirlinePaxHandler-4204"><span class="linenos">4204</span></a>		<span class="n">pax_per_aoc</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlinePaxHandler-4205"><a href="#AirlinePaxHandler-4205"><span class="linenos">4205</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4206"><a href="#AirlinePaxHandler-4206"><span class="linenos">4206</span></a>			<span class="c1"># aoc_uid = self.flight_registery[pax.itinerary[pax.idx_current_flight+1]][&#39;aoc_uid&#39;]</span>
</span><span id="AirlinePaxHandler-4207"><a href="#AirlinePaxHandler-4207"><span class="linenos">4207</span></a>			<span class="n">aoc_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">())</span>
</span><span id="AirlinePaxHandler-4208"><a href="#AirlinePaxHandler-4208"><span class="linenos">4208</span></a>			<span class="n">pax_per_aoc</span><span class="p">[</span><span class="n">aoc_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">pax</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4209"><a href="#AirlinePaxHandler-4209"><span class="linenos">4209</span></a>
</span><span id="AirlinePaxHandler-4210"><a href="#AirlinePaxHandler-4210"><span class="linenos">4210</span></a>		<span class="k">for</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">paxs2</span> <span class="ow">in</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AirlinePaxHandler-4211"><a href="#AirlinePaxHandler-4211"><span class="linenos">4211</span></a>			<span class="n">new_msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4212"><a href="#AirlinePaxHandler-4212"><span class="linenos">4212</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pax_connection_handling&#39;</span>
</span><span id="AirlinePaxHandler-4213"><a href="#AirlinePaxHandler-4213"><span class="linenos">4213</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="AirlinePaxHandler-4214"><a href="#AirlinePaxHandler-4214"><span class="linenos">4214</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs2</span><span class="p">}</span>
</span><span id="AirlinePaxHandler-4215"><a href="#AirlinePaxHandler-4215"><span class="linenos">4215</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending pax connection handling request for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs2</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4216"><a href="#AirlinePaxHandler-4216"><span class="linenos">4216</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new_msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4217"><a href="#AirlinePaxHandler-4217"><span class="linenos">4217</span></a>
</span><span id="AirlinePaxHandler-4218"><a href="#AirlinePaxHandler-4218"><span class="linenos">4218</span></a>	<span class="k">def</span> <span class="nf">handle_pax_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4219"><a href="#AirlinePaxHandler-4219"><span class="linenos">4219</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles the paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4220"><a href="#AirlinePaxHandler-4220"><span class="linenos">4220</span></a>
</span><span id="AirlinePaxHandler-4221"><a href="#AirlinePaxHandler-4221"><span class="linenos">4221</span></a>		<span class="n">missed_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler-4222"><a href="#AirlinePaxHandler-4222"><span class="linenos">4222</span></a>
</span><span id="AirlinePaxHandler-4223"><a href="#AirlinePaxHandler-4223"><span class="linenos">4223</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler-4224"><a href="#AirlinePaxHandler-4224"><span class="linenos">4224</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4225"><a href="#AirlinePaxHandler-4225"><span class="linenos">4225</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4226"><a href="#AirlinePaxHandler-4226"><span class="linenos">4226</span></a>			<span class="c1"># Remember the theoretical departure for duty of care</span>
</span><span id="AirlinePaxHandler-4227"><a href="#AirlinePaxHandler-4227"><span class="linenos">4227</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4228"><a href="#AirlinePaxHandler-4228"><span class="linenos">4228</span></a>
</span><span id="AirlinePaxHandler-4229"><a href="#AirlinePaxHandler-4229"><span class="linenos">4229</span></a>			<span class="c1"># Compute the connecting times for these pax.</span>
</span><span id="AirlinePaxHandler-4230"><a href="#AirlinePaxHandler-4230"><span class="linenos">4230</span></a>			<span class="n">int1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4231"><a href="#AirlinePaxHandler-4231"><span class="linenos">4231</span></a>			<span class="n">int2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4232"><a href="#AirlinePaxHandler-4232"><span class="linenos">4232</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">int2</span>
</span><span id="AirlinePaxHandler-4233"><a href="#AirlinePaxHandler-4233"><span class="linenos">4233</span></a>
</span><span id="AirlinePaxHandler-4234"><a href="#AirlinePaxHandler-4234"><span class="linenos">4234</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_connecting_times</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="p">(</span><span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4235"><a href="#AirlinePaxHandler-4235"><span class="linenos">4235</span></a>
</span><span id="AirlinePaxHandler-4236"><a href="#AirlinePaxHandler-4236"><span class="linenos">4236</span></a>			<span class="c1"># Check next flight has already departed or is cancelled.</span>
</span><span id="AirlinePaxHandler-4237"><a href="#AirlinePaxHandler-4237"><span class="linenos">4237</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span> \
</span><span id="AirlinePaxHandler-4238"><a href="#AirlinePaxHandler-4238"><span class="linenos">4238</span></a>				<span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4239"><a href="#AirlinePaxHandler-4239"><span class="linenos">4239</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is added to pax with missed connection list for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight</span><span class="p">),</span>
</span><span id="AirlinePaxHandler-4240"><a href="#AirlinePaxHandler-4240"><span class="linenos">4240</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4241"><a href="#AirlinePaxHandler-4241"><span class="linenos">4241</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4242"><a href="#AirlinePaxHandler-4242"><span class="linenos">4242</span></a>				<span class="n">missed_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4243"><a href="#AirlinePaxHandler-4243"><span class="linenos">4243</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4244"><a href="#AirlinePaxHandler-4244"><span class="linenos">4244</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4245"><a href="#AirlinePaxHandler-4245"><span class="linenos">4245</span></a>				<span class="c1"># Try to make it to the next flight. The active flight is reverted to the</span>
</span><span id="AirlinePaxHandler-4246"><a href="#AirlinePaxHandler-4246"><span class="linenos">4246</span></a>				<span class="c1"># previous one if the pax does not make it.</span>
</span><span id="AirlinePaxHandler-4247"><a href="#AirlinePaxHandler-4247"><span class="linenos">4247</span></a>				<span class="c1"># pax.idx_current_flight += 1</span>
</span><span id="AirlinePaxHandler-4248"><a href="#AirlinePaxHandler-4248"><span class="linenos">4248</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="AirlinePaxHandler-4249"><a href="#AirlinePaxHandler-4249"><span class="linenos">4249</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">=</span> <span class="n">next_flight</span>
</span><span id="AirlinePaxHandler-4250"><a href="#AirlinePaxHandler-4250"><span class="linenos">4250</span></a>
</span><span id="AirlinePaxHandler-4251"><a href="#AirlinePaxHandler-4251"><span class="linenos">4251</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4252"><a href="#AirlinePaxHandler-4252"><span class="linenos">4252</span></a>			<span class="c1"># mprint(&#39;Pax who missed their connection at arrival of flight&#39;, missed_connecting_pax[0].itinerary[missed_connecting_pax[0].idx_current_flight], &#39;:&#39;, missed_connecting_pax)</span>
</span><span id="AirlinePaxHandler-4253"><a href="#AirlinePaxHandler-4253"><span class="linenos">4253</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax who missed their connection at arrival of flight&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">(),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">missed_connecting_pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4254"><a href="#AirlinePaxHandler-4254"><span class="linenos">4254</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_reallocate_pax</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4255"><a href="#AirlinePaxHandler-4255"><span class="linenos">4255</span></a>
</span><span id="AirlinePaxHandler-4256"><a href="#AirlinePaxHandler-4256"><span class="linenos">4256</span></a>	<span class="k">def</span> <span class="nf">send_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4257"><a href="#AirlinePaxHandler-4257"><span class="linenos">4257</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending cost blame to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for cost:&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4258"><a href="#AirlinePaxHandler-4258"><span class="linenos">4258</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4259"><a href="#AirlinePaxHandler-4259"><span class="linenos">4259</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4260"><a href="#AirlinePaxHandler-4260"><span class="linenos">4260</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_blame&#39;</span>
</span><span id="AirlinePaxHandler-4261"><a href="#AirlinePaxHandler-4261"><span class="linenos">4261</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4262"><a href="#AirlinePaxHandler-4262"><span class="linenos">4262</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4263"><a href="#AirlinePaxHandler-4263"><span class="linenos">4263</span></a>						<span class="s1">&#39;cost_type&#39;</span><span class="p">:</span> <span class="n">cost_type</span><span class="p">}</span>
</span><span id="AirlinePaxHandler-4264"><a href="#AirlinePaxHandler-4264"><span class="linenos">4264</span></a>
</span><span id="AirlinePaxHandler-4265"><a href="#AirlinePaxHandler-4265"><span class="linenos">4265</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4266"><a href="#AirlinePaxHandler-4266"><span class="linenos">4266</span></a>
</span><span id="AirlinePaxHandler-4267"><a href="#AirlinePaxHandler-4267"><span class="linenos">4267</span></a>	<span class="k">def</span> <span class="nf">send_follow_blame_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4268"><a href="#AirlinePaxHandler-4268"><span class="linenos">4268</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending follow blame request to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlinePaxHandler-4269"><a href="#AirlinePaxHandler-4269"><span class="linenos">4269</span></a>				<span class="s1">&#39;for compensation:&#39;</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;and soft cost:&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;of &#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4270"><a href="#AirlinePaxHandler-4270"><span class="linenos">4270</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4271"><a href="#AirlinePaxHandler-4271"><span class="linenos">4271</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler-4272"><a href="#AirlinePaxHandler-4272"><span class="linenos">4272</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;follow_blame&#39;</span>
</span><span id="AirlinePaxHandler-4273"><a href="#AirlinePaxHandler-4273"><span class="linenos">4273</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;compensation&#39;</span><span class="p">:</span> <span class="n">compensation</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4274"><a href="#AirlinePaxHandler-4274"><span class="linenos">4274</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4275"><a href="#AirlinePaxHandler-4275"><span class="linenos">4275</span></a>						<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="n">soft_cost</span><span class="p">,</span>
</span><span id="AirlinePaxHandler-4276"><a href="#AirlinePaxHandler-4276"><span class="linenos">4276</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="AirlinePaxHandler-4277"><a href="#AirlinePaxHandler-4277"><span class="linenos">4277</span></a>
</span><span id="AirlinePaxHandler-4278"><a href="#AirlinePaxHandler-4278"><span class="linenos">4278</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4279"><a href="#AirlinePaxHandler-4279"><span class="linenos">4279</span></a>
</span><span id="AirlinePaxHandler-4280"><a href="#AirlinePaxHandler-4280"><span class="linenos">4280</span></a>	<span class="k">def</span> <span class="nf">wait_for_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4281"><a href="#AirlinePaxHandler-4281"><span class="linenos">4281</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4282"><a href="#AirlinePaxHandler-4282"><span class="linenos">4282</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives connecting times for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4283"><a href="#AirlinePaxHandler-4283"><span class="linenos">4283</span></a>		<span class="c1"># pax.mcts.append(msg[&#39;body&#39;][&#39;mct&#39;])</span>
</span><span id="AirlinePaxHandler-4284"><a href="#AirlinePaxHandler-4284"><span class="linenos">4284</span></a>		<span class="c1"># pax.cts.append(msg[&#39;body&#39;][&#39;ct&#39;])</span>
</span><span id="AirlinePaxHandler-4285"><a href="#AirlinePaxHandler-4285"><span class="linenos">4285</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;mct&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4286"><a href="#AirlinePaxHandler-4286"><span class="linenos">4286</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4287"><a href="#AirlinePaxHandler-4287"><span class="linenos">4287</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4288"><a href="#AirlinePaxHandler-4288"><span class="linenos">4288</span></a>
</span><span id="AirlinePaxHandler-4289"><a href="#AirlinePaxHandler-4289"><span class="linenos">4289</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4290"><a href="#AirlinePaxHandler-4290"><span class="linenos">4290</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_type&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4291"><a href="#AirlinePaxHandler-4291"><span class="linenos">4291</span></a>
</span><span id="AirlinePaxHandler-4292"><a href="#AirlinePaxHandler-4292"><span class="linenos">4292</span></a>	<span class="k">def</span> <span class="nf">wait_for_follow_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4293"><a href="#AirlinePaxHandler-4293"><span class="linenos">4293</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;compensation&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;soft_cost&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4294"><a href="#AirlinePaxHandler-4294"><span class="linenos">4294</span></a>
</span><span id="AirlinePaxHandler-4295"><a href="#AirlinePaxHandler-4295"><span class="linenos">4295</span></a>	<span class="k">def</span> <span class="nf">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4296"><a href="#AirlinePaxHandler-4296"><span class="linenos">4296</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received pax connection handling request from IP for paxs:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4297"><a href="#AirlinePaxHandler-4297"><span class="linenos">4297</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler-4298"><a href="#AirlinePaxHandler-4298"><span class="linenos">4298</span></a>
</span><span id="AirlinePaxHandler-4299"><a href="#AirlinePaxHandler-4299"><span class="linenos">4299</span></a>	<span class="k">def</span> <span class="nf">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler-4300"><a href="#AirlinePaxHandler-4300"><span class="linenos">4300</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4301"><a href="#AirlinePaxHandler-4301"><span class="linenos">4301</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is considering arrival pax request for flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4302"><a href="#AirlinePaxHandler-4302"><span class="linenos">4302</span></a>		<span class="n">connecting_pax_other_company</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler-4303"><a href="#AirlinePaxHandler-4303"><span class="linenos">4303</span></a>		<span class="n">own_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler-4304"><a href="#AirlinePaxHandler-4304"><span class="linenos">4304</span></a>
</span><span id="AirlinePaxHandler-4305"><a href="#AirlinePaxHandler-4305"><span class="linenos">4305</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4306"><a href="#AirlinePaxHandler-4306"><span class="linenos">4306</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4307"><a href="#AirlinePaxHandler-4307"><span class="linenos">4307</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">unboard_from_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4308"><a href="#AirlinePaxHandler-4308"><span class="linenos">4308</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler-4309"><a href="#AirlinePaxHandler-4309"><span class="linenos">4309</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler-4310"><a href="#AirlinePaxHandler-4310"><span class="linenos">4310</span></a>
</span><span id="AirlinePaxHandler-4311"><a href="#AirlinePaxHandler-4311"><span class="linenos">4311</span></a>			<span class="c1"># Check if pax has a next flight</span>
</span><span id="AirlinePaxHandler-4312"><a href="#AirlinePaxHandler-4312"><span class="linenos">4312</span></a>			<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4313"><a href="#AirlinePaxHandler-4313"><span class="linenos">4313</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is connecting&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4314"><a href="#AirlinePaxHandler-4314"><span class="linenos">4314</span></a>
</span><span id="AirlinePaxHandler-4315"><a href="#AirlinePaxHandler-4315"><span class="linenos">4315</span></a>				<span class="c1"># Check if next flight belongs to this company</span>
</span><span id="AirlinePaxHandler-4316"><a href="#AirlinePaxHandler-4316"><span class="linenos">4316</span></a>				<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlinePaxHandler-4317"><a href="#AirlinePaxHandler-4317"><span class="linenos">4317</span></a>					<span class="n">own_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4318"><a href="#AirlinePaxHandler-4318"><span class="linenos">4318</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4319"><a href="#AirlinePaxHandler-4319"><span class="linenos">4319</span></a>					<span class="c1"># Find the company operating the next flight</span>
</span><span id="AirlinePaxHandler-4320"><a href="#AirlinePaxHandler-4320"><span class="linenos">4320</span></a>					<span class="n">connecting_pax_other_company</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4321"><a href="#AirlinePaxHandler-4321"><span class="linenos">4321</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4322"><a href="#AirlinePaxHandler-4322"><span class="linenos">4322</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4323"><a href="#AirlinePaxHandler-4323"><span class="linenos">4323</span></a>
</span><span id="AirlinePaxHandler-4324"><a href="#AirlinePaxHandler-4324"><span class="linenos">4324</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles his own connecting paxs&#39;</span><span class="p">,</span> <span class="n">own_connecting_pax</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4325"><a href="#AirlinePaxHandler-4325"><span class="linenos">4325</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4326"><a href="#AirlinePaxHandler-4326"><span class="linenos">4326</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler-4327"><a href="#AirlinePaxHandler-4327"><span class="linenos">4327</span></a>
</span><span id="AirlinePaxHandler-4328"><a href="#AirlinePaxHandler-4328"><span class="linenos">4328</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;will request connection handling for the paxs&#39;</span><span class="p">,</span> <span class="n">connecting_pax_other_company</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler-4329"><a href="#AirlinePaxHandler-4329"><span class="linenos">4329</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler-4330"><a href="#AirlinePaxHandler-4330"><span class="linenos">4330</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_pax_connection_handling</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>APH</p>

<p>Description: When a flight arrives direct passengers to connecting flights. All passengers connecting to flight that have already left are requested to be rebooked.</p>

<p>Added from D4.1 description:
Embark passengers ready to be embarked.</p>
</div>


                            <div id="AirlinePaxHandler.check_push_back" class="classattr">
                                        <input id="AirlinePaxHandler.check_push_back-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_push_back</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">push_back_event</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.check_push_back-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.check_push_back"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.check_push_back-3870"><a href="#AirlinePaxHandler.check_push_back-3870"><span class="linenos">3870</span></a>	<span class="k">def</span> <span class="nf">check_push_back</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">push_back_event</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.check_push_back-3871"><a href="#AirlinePaxHandler.check_push_back-3871"><span class="linenos">3871</span></a>		<span class="c1"># Added from D4.1</span>
</span><span id="AirlinePaxHandler.check_push_back-3872"><a href="#AirlinePaxHandler.check_push_back-3872"><span class="linenos">3872</span></a>		<span class="k">yield</span> <span class="n">push_back_event</span>
</span><span id="AirlinePaxHandler.check_push_back-3873"><a href="#AirlinePaxHandler.check_push_back-3873"><span class="linenos">3873</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3874"><a href="#AirlinePaxHandler.check_push_back-3874"><span class="linenos">3874</span></a>		<span class="k">with</span> <span class="n">keep_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;check_push_back&#39;</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.check_push_back-3875"><a href="#AirlinePaxHandler.check_push_back-3875"><span class="linenos">3875</span></a>			<span class="c1"># Compute main cause of delays</span>
</span><span id="AirlinePaxHandler.check_push_back-3876"><a href="#AirlinePaxHandler.check_push_back-3876"><span class="linenos">3876</span></a>			<span class="c1"># Non-ATFM</span>
</span><span id="AirlinePaxHandler.check_push_back-3877"><a href="#AirlinePaxHandler.check_push_back-3877"><span class="linenos">3877</span></a>			<span class="n">delay_non_atfm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;delay_non_atfm&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.check_push_back-3878"><a href="#AirlinePaxHandler.check_push_back-3878"><span class="linenos">3878</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3879"><a href="#AirlinePaxHandler.check_push_back-3879"><span class="linenos">3879</span></a>			<span class="c1"># ATFM</span>
</span><span id="AirlinePaxHandler.check_push_back-3880"><a href="#AirlinePaxHandler.check_push_back-3880"><span class="linenos">3880</span></a>			<span class="n">delay_ATFM</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_atfm_delay</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.check_push_back-3881"><a href="#AirlinePaxHandler.check_push_back-3881"><span class="linenos">3881</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3882"><a href="#AirlinePaxHandler.check_push_back-3882"><span class="linenos">3882</span></a>			<span class="c1"># Reactionary delay</span>
</span><span id="AirlinePaxHandler.check_push_back-3883"><a href="#AirlinePaxHandler.check_push_back-3883"><span class="linenos">3883</span></a>			<span class="n">delay_reac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reactionary_delay</span>
</span><span id="AirlinePaxHandler.check_push_back-3884"><a href="#AirlinePaxHandler.check_push_back-3884"><span class="linenos">3884</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3885"><a href="#AirlinePaxHandler.check_push_back-3885"><span class="linenos">3885</span></a>			<span class="k">if</span> <span class="n">delay_non_atfm</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_ATFM</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">delay_reac</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3886"><a href="#AirlinePaxHandler.check_push_back-3886"><span class="linenos">3886</span></a>				<span class="c1"># Find out the biggest delay</span>
</span><span id="AirlinePaxHandler.check_push_back-3887"><a href="#AirlinePaxHandler.check_push_back-3887"><span class="linenos">3887</span></a>				<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.check_push_back-3888"><a href="#AirlinePaxHandler.check_push_back-3888"><span class="linenos">3888</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3889"><a href="#AirlinePaxHandler.check_push_back-3889"><span class="linenos">3889</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;finds its biggest delay among:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">delay_non_atfm</span><span class="p">,</span> <span class="n">delay_ATFM</span><span class="p">,</span> <span class="n">delay_reac</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.check_push_back-3890"><a href="#AirlinePaxHandler.check_push_back-3890"><span class="linenos">3890</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3891"><a href="#AirlinePaxHandler.check_push_back-3891"><span class="linenos">3891</span></a>				<span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3892"><a href="#AirlinePaxHandler.check_push_back-3892"><span class="linenos">3892</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TA&#39;</span>  <span class="c1"># for turnaround</span>
</span><span id="AirlinePaxHandler.check_push_back-3893"><a href="#AirlinePaxHandler.check_push_back-3893"><span class="linenos">3893</span></a>				<span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3894"><a href="#AirlinePaxHandler.check_push_back-3894"><span class="linenos">3894</span></a>					<span class="c1"># if not self.agent.aoc_flights_info[flight_uid][&#39;FP&#39;].atfm_delay is None:</span>
</span><span id="AirlinePaxHandler.check_push_back-3895"><a href="#AirlinePaxHandler.check_push_back-3895"><span class="linenos">3895</span></a>					<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3896"><a href="#AirlinePaxHandler.check_push_back-3896"><span class="linenos">3896</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;W&#39;</span>
</span><span id="AirlinePaxHandler.check_push_back-3897"><a href="#AirlinePaxHandler.check_push_back-3897"><span class="linenos">3897</span></a>					<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;FP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">atfm_delay</span><span class="o">.</span><span class="n">reason</span> <span class="o">==</span> <span class="s1">&#39;C_AP&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3898"><a href="#AirlinePaxHandler.check_push_back-3898"><span class="linenos">3898</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
</span><span id="AirlinePaxHandler.check_push_back-3899"><a href="#AirlinePaxHandler.check_push_back-3899"><span class="linenos">3899</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3900"><a href="#AirlinePaxHandler.check_push_back-3900"><span class="linenos">3900</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ER&#39;</span>  <span class="c1"># for en-route</span>
</span><span id="AirlinePaxHandler.check_push_back-3901"><a href="#AirlinePaxHandler.check_push_back-3901"><span class="linenos">3901</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_push_back-3902"><a href="#AirlinePaxHandler.check_push_back-3902"><span class="linenos">3902</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RD&#39;</span>  <span class="c1"># for reactionary delay</span>
</span><span id="AirlinePaxHandler.check_push_back-3903"><a href="#AirlinePaxHandler.check_push_back-3903"><span class="linenos">3903</span></a>
</span><span id="AirlinePaxHandler.check_push_back-3904"><a href="#AirlinePaxHandler.check_push_back-3904"><span class="linenos">3904</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">board_pax</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.check_delay_liability" class="classattr">
                                        <input id="AirlinePaxHandler.check_delay_liability-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_delay_liability</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">current_flight_uid</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.check_delay_liability-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.check_delay_liability"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.check_delay_liability-3906"><a href="#AirlinePaxHandler.check_delay_liability-3906"><span class="linenos">3906</span></a>	<span class="k">def</span> <span class="nf">check_delay_liability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3907"><a href="#AirlinePaxHandler.check_delay_liability-3907"><span class="linenos">3907</span></a>		<span class="k">if</span> <span class="n">current_flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3908"><a href="#AirlinePaxHandler.check_delay_liability-3908"><span class="linenos">3908</span></a>			<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3909"><a href="#AirlinePaxHandler.check_delay_liability-3909"><span class="linenos">3909</span></a>
</span><span id="AirlinePaxHandler.check_delay_liability-3910"><a href="#AirlinePaxHandler.check_delay_liability-3910"><span class="linenos">3910</span></a>		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TA&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3911"><a href="#AirlinePaxHandler.check_delay_liability-3911"><span class="linenos">3911</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3912"><a href="#AirlinePaxHandler.check_delay_liability-3912"><span class="linenos">3912</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3913"><a href="#AirlinePaxHandler.check_delay_liability-3913"><span class="linenos">3913</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3914"><a href="#AirlinePaxHandler.check_delay_liability-3914"><span class="linenos">3914</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3915"><a href="#AirlinePaxHandler.check_delay_liability-3915"><span class="linenos">3915</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3916"><a href="#AirlinePaxHandler.check_delay_liability-3916"><span class="linenos">3916</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3917"><a href="#AirlinePaxHandler.check_delay_liability-3917"><span class="linenos">3917</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3918"><a href="#AirlinePaxHandler.check_delay_liability-3918"><span class="linenos">3918</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3919"><a href="#AirlinePaxHandler.check_delay_liability-3919"><span class="linenos">3919</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL_CF&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3920"><a href="#AirlinePaxHandler.check_delay_liability-3920"><span class="linenos">3920</span></a>			<span class="c1"># pax.entitled = pax.reac_entitled</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3921"><a href="#AirlinePaxHandler.check_delay_liability-3921"><span class="linenos">3921</span></a>			<span class="c1"># This could be better done by understanding the main reason for this flight to</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3922"><a href="#AirlinePaxHandler.check_delay_liability-3922"><span class="linenos">3922</span></a>			<span class="c1"># be cancelled.</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3923"><a href="#AirlinePaxHandler.check_delay_liability-3923"><span class="linenos">3923</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3924"><a href="#AirlinePaxHandler.check_delay_liability-3924"><span class="linenos">3924</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3925"><a href="#AirlinePaxHandler.check_delay_liability-3925"><span class="linenos">3925</span></a>		<span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">current_flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CANCEL&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3926"><a href="#AirlinePaxHandler.check_delay_liability-3926"><span class="linenos">3926</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3927"><a href="#AirlinePaxHandler.check_delay_liability-3927"><span class="linenos">3927</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3928"><a href="#AirlinePaxHandler.check_delay_liability-3928"><span class="linenos">3928</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.check_delay_liability-3929"><a href="#AirlinePaxHandler.check_delay_liability-3929"><span class="linenos">3929</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">reac_entitled</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.do_pax_care" class="classattr">
                                        <input id="AirlinePaxHandler.do_pax_care-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_pax_care</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">delay</span>, </span><span class="param"><span class="n">pax</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.do_pax_care-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.do_pax_care"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.do_pax_care-3931"><a href="#AirlinePaxHandler.do_pax_care-3931"><span class="linenos">3931</span></a>	<span class="k">def</span> <span class="nf">do_pax_care</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.do_pax_care-3932"><a href="#AirlinePaxHandler.do_pax_care-3932"><span class="linenos">3932</span></a>		<span class="n">current_flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.do_pax_care-3933"><a href="#AirlinePaxHandler.do_pax_care-3933"><span class="linenos">3933</span></a>		<span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">duty_of_care</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.do_pax_care-3934"><a href="#AirlinePaxHandler.do_pax_care-3934"><span class="linenos">3934</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">duty_of_care</span> <span class="o">+=</span> <span class="n">doc</span>
</span><span id="AirlinePaxHandler.do_pax_care-3935"><a href="#AirlinePaxHandler.do_pax_care-3935"><span class="linenos">3935</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;blames&#39;</span><span class="p">,</span> <span class="n">current_flight_uid</span><span class="p">,</span> <span class="s1">&#39;for the DOC cost:&#39;</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.do_pax_care-3936"><a href="#AirlinePaxHandler.do_pax_care-3936"><span class="linenos">3936</span></a>				<span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.do_pax_care-3937"><a href="#AirlinePaxHandler.do_pax_care-3937"><span class="linenos">3937</span></a>
</span><span id="AirlinePaxHandler.do_pax_care-3938"><a href="#AirlinePaxHandler.do_pax_care-3938"><span class="linenos">3938</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;DOC&#39;</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="n">current_flight_uid</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.do_pax_care-3939"><a href="#AirlinePaxHandler.do_pax_care-3939"><span class="linenos">3939</span></a>		<span class="c1"># if current_flight_uid in self.agent.own_flights():</span>
</span><span id="AirlinePaxHandler.do_pax_care-3940"><a href="#AirlinePaxHandler.do_pax_care-3940"><span class="linenos">3940</span></a>		<span class="c1">#     self.agent.aoc_flights_info[current_flight_uid][&#39;DOC&#39;] += doc</span>
</span><span id="AirlinePaxHandler.do_pax_care-3941"><a href="#AirlinePaxHandler.do_pax_care-3941"><span class="linenos">3941</span></a>		<span class="c1"># else:</span>
</span><span id="AirlinePaxHandler.do_pax_care-3942"><a href="#AirlinePaxHandler.do_pax_care-3942"><span class="linenos">3942</span></a>		<span class="c1">#     self.agent.aph.send_cost_blame(current_flight_uid, doc, &#39;DOC&#39;)</span>
</span><span id="AirlinePaxHandler.do_pax_care-3943"><a href="#AirlinePaxHandler.do_pax_care-3943"><span class="linenos">3943</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has been cared for (&#39;</span><span class="p">,</span> <span class="n">doc</span><span class="p">,</span> <span class="s1">&#39;euros in total) for a delay of &#39;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.board_pax" class="classattr">
                                        <input id="AirlinePaxHandler.board_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">board_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.board_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.board_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.board_pax-3945"><a href="#AirlinePaxHandler.board_pax-3945"><span class="linenos">3945</span></a>	<span class="k">def</span> <span class="nf">board_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.board_pax-3946"><a href="#AirlinePaxHandler.board_pax-3946"><span class="linenos">3946</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler.board_pax-3947"><a href="#AirlinePaxHandler.board_pax-3947"><span class="linenos">3947</span></a><span class="sd">		Note: added from D4.1</span>
</span><span id="AirlinePaxHandler.board_pax-3948"><a href="#AirlinePaxHandler.board_pax-3948"><span class="linenos">3948</span></a><span class="sd">		Note: duty of care is now given to passengers just before their boarding,</span>
</span><span id="AirlinePaxHandler.board_pax-3949"><a href="#AirlinePaxHandler.board_pax-3949"><span class="linenos">3949</span></a><span class="sd">		based on how much they waited to depart. Note that end of boarding</span>
</span><span id="AirlinePaxHandler.board_pax-3950"><a href="#AirlinePaxHandler.board_pax-3950"><span class="linenos">3950</span></a><span class="sd">		coincides with off-block, so we now exactly how long they waited up</span>
</span><span id="AirlinePaxHandler.board_pax-3951"><a href="#AirlinePaxHandler.board_pax-3951"><span class="linenos">3951</span></a><span class="sd">		until their real departure.</span>
</span><span id="AirlinePaxHandler.board_pax-3952"><a href="#AirlinePaxHandler.board_pax-3952"><span class="linenos">3952</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler.board_pax-3953"><a href="#AirlinePaxHandler.board_pax-3953"><span class="linenos">3953</span></a>		<span class="n">pax_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler.board_pax-3954"><a href="#AirlinePaxHandler.board_pax-3954"><span class="linenos">3954</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax to board for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.board_pax-3955"><a href="#AirlinePaxHandler.board_pax-3955"><span class="linenos">3955</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]:</span>
</span><span id="AirlinePaxHandler.board_pax-3956"><a href="#AirlinePaxHandler.board_pax-3956"><span class="linenos">3956</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">==</span> <span class="n">flight_uid</span> <span class="ow">and</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.board_pax-3957"><a href="#AirlinePaxHandler.board_pax-3957"><span class="linenos">3957</span></a>				<span class="c1"># pax ready to board</span>
</span><span id="AirlinePaxHandler.board_pax-3958"><a href="#AirlinePaxHandler.board_pax-3958"><span class="linenos">3958</span></a>				<span class="n">pax_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.board_pax-3959"><a href="#AirlinePaxHandler.board_pax-3959"><span class="linenos">3959</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.board_pax-3960"><a href="#AirlinePaxHandler.board_pax-3960"><span class="linenos">3960</span></a>
</span><span id="AirlinePaxHandler.board_pax-3961"><a href="#AirlinePaxHandler.board_pax-3961"><span class="linenos">3961</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">board_next_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_obt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.board_pax-3962"><a href="#AirlinePaxHandler.board_pax-3962"><span class="linenos">3962</span></a>
</span><span id="AirlinePaxHandler.board_pax-3963"><a href="#AirlinePaxHandler.board_pax-3963"><span class="linenos">3963</span></a>				<span class="c1"># Check duty of care</span>
</span><span id="AirlinePaxHandler.board_pax-3964"><a href="#AirlinePaxHandler.board_pax-3964"><span class="linenos">3964</span></a>				<span class="n">delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span>  <span class="c1"># self.agent.aoc_flights_info[flight_uid][&#39;sobt&#39;]</span>
</span><span id="AirlinePaxHandler.board_pax-3965"><a href="#AirlinePaxHandler.board_pax-3965"><span class="linenos">3965</span></a>
</span><span id="AirlinePaxHandler.board_pax-3966"><a href="#AirlinePaxHandler.board_pax-3966"><span class="linenos">3966</span></a>				<span class="c1"># Do pax care</span>
</span><span id="AirlinePaxHandler.board_pax-3967"><a href="#AirlinePaxHandler.board_pax-3967"><span class="linenos">3967</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.board_pax-3968"><a href="#AirlinePaxHandler.board_pax-3968"><span class="linenos">3968</span></a>
</span><span id="AirlinePaxHandler.board_pax-3969"><a href="#AirlinePaxHandler.board_pax-3969"><span class="linenos">3969</span></a>				<span class="c1"># Check for future compensation entitlement</span>
</span><span id="AirlinePaxHandler.board_pax-3970"><a href="#AirlinePaxHandler.board_pax-3970"><span class="linenos">3970</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">check_delay_liability</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.board_pax-3971"><a href="#AirlinePaxHandler.board_pax-3971"><span class="linenos">3971</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.board_pax-3972"><a href="#AirlinePaxHandler.board_pax-3972"><span class="linenos">3972</span></a>				<span class="c1"># pax not ready to board</span>
</span><span id="AirlinePaxHandler.board_pax-3973"><a href="#AirlinePaxHandler.board_pax-3973"><span class="linenos">3973</span></a>				<span class="c1"># The passenger reallocation role picks them up and reallocate them</span>
</span><span id="AirlinePaxHandler.board_pax-3974"><a href="#AirlinePaxHandler.board_pax-3974"><span class="linenos">3974</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is not ready to board:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;; arrival time at gate:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.board_pax-3975"><a href="#AirlinePaxHandler.board_pax-3975"><span class="linenos">3975</span></a>				<span class="c1"># pax.idx_current_flight -= 1</span>
</span><span id="AirlinePaxHandler.board_pax-3976"><a href="#AirlinePaxHandler.board_pax-3976"><span class="linenos">3976</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="AirlinePaxHandler.board_pax-3977"><a href="#AirlinePaxHandler.board_pax-3977"><span class="linenos">3977</span></a>				<span class="c1"># mprint(pax, &#39;active flight is reverted to previous one:&#39;, pax.active_flight)</span>
</span><span id="AirlinePaxHandler.board_pax-3978"><a href="#AirlinePaxHandler.board_pax-3978"><span class="linenos">3978</span></a>
</span><span id="AirlinePaxHandler.board_pax-3979"><a href="#AirlinePaxHandler.board_pax-3979"><span class="linenos">3979</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">pax_to_remove</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.board_pax-3980"><a href="#AirlinePaxHandler.board_pax-3980"><span class="linenos">3980</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_to_board&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Note: added from D4.1
Note: duty of care is now given to passengers just before their boarding,
based on how much they waited to depart. Note that end of boarding
coincides with off-block, so we now exactly how long they waited up
until their real departure.</p>
</div>


                            </div>
                            <div id="AirlinePaxHandler.arrive_pax" class="classattr">
                                        <input id="AirlinePaxHandler.arrive_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">arrive_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">overnight</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.arrive_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.arrive_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.arrive_pax-3982"><a href="#AirlinePaxHandler.arrive_pax-3982"><span class="linenos">3982</span></a>	<span class="k">def</span> <span class="nf">arrive_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">overnight</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.arrive_pax-3983"><a href="#AirlinePaxHandler.arrive_pax-3983"><span class="linenos">3983</span></a><span class="w">		</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler.arrive_pax-3984"><a href="#AirlinePaxHandler.arrive_pax-3984"><span class="linenos">3984</span></a><span class="sd">		If overnight is True, the passenger need to be cared for for the night.</span>
</span><span id="AirlinePaxHandler.arrive_pax-3985"><a href="#AirlinePaxHandler.arrive_pax-3985"><span class="linenos">3985</span></a><span class="sd">		WARNING: this method assumes that it is executed exactly when at the in-block</span>
</span><span id="AirlinePaxHandler.arrive_pax-3986"><a href="#AirlinePaxHandler.arrive_pax-3986"><span class="linenos">3986</span></a><span class="sd">		time of the last flight.</span>
</span><span id="AirlinePaxHandler.arrive_pax-3987"><a href="#AirlinePaxHandler.arrive_pax-3987"><span class="linenos">3987</span></a><span class="sd">		Note: paxs are paid first, then costs for airlines are computed.</span>
</span><span id="AirlinePaxHandler.arrive_pax-3988"><a href="#AirlinePaxHandler.arrive_pax-3988"><span class="linenos">3988</span></a><span class="sd">		&quot;&quot;&quot;</span>
</span><span id="AirlinePaxHandler.arrive_pax-3989"><a href="#AirlinePaxHandler.arrive_pax-3989"><span class="linenos">3989</span></a>		<span class="c1"># Passengers arrived</span>
</span><span id="AirlinePaxHandler.arrive_pax-3990"><a href="#AirlinePaxHandler.arrive_pax-3990"><span class="linenos">3990</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;arrived&#39;</span>
</span><span id="AirlinePaxHandler.arrive_pax-3991"><a href="#AirlinePaxHandler.arrive_pax-3991"><span class="linenos">3991</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has finished their journey.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-3992"><a href="#AirlinePaxHandler.arrive_pax-3992"><span class="linenos">3992</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-3993"><a href="#AirlinePaxHandler.arrive_pax-3993"><span class="linenos">3993</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-3994"><a href="#AirlinePaxHandler.arrive_pax-3994"><span class="linenos">3994</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.arrive_pax-3995"><a href="#AirlinePaxHandler.arrive_pax-3995"><span class="linenos">3995</span></a>			<span class="c1"># mprint(pax, &#39;has an initial_aobt:&#39;, pax.initial_aobt)</span>
</span><span id="AirlinePaxHandler.arrive_pax-3996"><a href="#AirlinePaxHandler.arrive_pax-3996"><span class="linenos">3996</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-3997"><a href="#AirlinePaxHandler.arrive_pax-3997"><span class="linenos">3997</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">initial_aobt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler.arrive_pax-3998"><a href="#AirlinePaxHandler.arrive_pax-3998"><span class="linenos">3998</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has not taken any flight.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-3999"><a href="#AirlinePaxHandler.arrive_pax-3999"><span class="linenos">3999</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4000"><a href="#AirlinePaxHandler.arrive_pax-4000"><span class="linenos">4000</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4001"><a href="#AirlinePaxHandler.arrive_pax-4001"><span class="linenos">4001</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.arrive_pax-4002"><a href="#AirlinePaxHandler.arrive_pax-4002"><span class="linenos">4002</span></a>			<span class="c1"># mprint(pax, &#39;has an final_aibt:&#39;, pax.final_aibt)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4003"><a href="#AirlinePaxHandler.arrive_pax-4003"><span class="linenos">4003</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4004"><a href="#AirlinePaxHandler.arrive_pax-4004"><span class="linenos">4004</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">final_aibt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler.arrive_pax-4005"><a href="#AirlinePaxHandler.arrive_pax-4005"><span class="linenos">4005</span></a>			<span class="c1"># mprint(pax, &#39;has not taken any flight (bis).&#39;)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4006"><a href="#AirlinePaxHandler.arrive_pax-4006"><span class="linenos">4006</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4007"><a href="#AirlinePaxHandler.arrive_pax-4007"><span class="linenos">4007</span></a>		<span class="n">it_so_far</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.arrive_pax-4008"><a href="#AirlinePaxHandler.arrive_pax-4008"><span class="linenos">4008</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4009"><a href="#AirlinePaxHandler.arrive_pax-4009"><span class="linenos">4009</span></a>		<span class="k">if</span> <span class="n">overnight</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4010"><a href="#AirlinePaxHandler.arrive_pax-4010"><span class="linenos">4010</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="mi">10000</span>
</span><span id="AirlinePaxHandler.arrive_pax-4011"><a href="#AirlinePaxHandler.arrive_pax-4011"><span class="linenos">4011</span></a>			<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">)):</span>
</span><span id="AirlinePaxHandler.arrive_pax-4012"><a href="#AirlinePaxHandler.arrive_pax-4012"><span class="linenos">4012</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aobts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4013"><a href="#AirlinePaxHandler.arrive_pax-4013"><span class="linenos">4013</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">aibts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4014"><a href="#AirlinePaxHandler.arrive_pax-4014"><span class="linenos">4014</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4015"><a href="#AirlinePaxHandler.arrive_pax-4015"><span class="linenos">4015</span></a>			<span class="c1"># Duty of care here (because there is no more flight!)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4016"><a href="#AirlinePaxHandler.arrive_pax-4016"><span class="linenos">4016</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">do_pax_care</span><span class="p">(</span><span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4017"><a href="#AirlinePaxHandler.arrive_pax-4017"><span class="linenos">4017</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4018"><a href="#AirlinePaxHandler.arrive_pax-4018"><span class="linenos">4018</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4019"><a href="#AirlinePaxHandler.arrive_pax-4019"><span class="linenos">4019</span></a>			<span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">pax</span><span class="o">.</span><span class="n">final_sibt</span>
</span><span id="AirlinePaxHandler.arrive_pax-4020"><a href="#AirlinePaxHandler.arrive_pax-4020"><span class="linenos">4020</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4021"><a href="#AirlinePaxHandler.arrive_pax-4021"><span class="linenos">4021</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">tot_arrival_delay</span> <span class="o">=</span> <span class="n">tot_arrival_delay</span>
</span><span id="AirlinePaxHandler.arrive_pax-4022"><a href="#AirlinePaxHandler.arrive_pax-4022"><span class="linenos">4022</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4023"><a href="#AirlinePaxHandler.arrive_pax-4023"><span class="linenos">4023</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">final_destination_reached</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">it_so_far</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">destination_airport</span>
</span><span id="AirlinePaxHandler.arrive_pax-4024"><a href="#AirlinePaxHandler.arrive_pax-4024"><span class="linenos">4024</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4025"><a href="#AirlinePaxHandler.arrive_pax-4025"><span class="linenos">4025</span></a>		<span class="c1"># Soft cost is payed with compensation, during the blame</span>
</span><span id="AirlinePaxHandler.arrive_pax-4026"><a href="#AirlinePaxHandler.arrive_pax-4026"><span class="linenos">4026</span></a>		<span class="n">soft_cost</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">soft_cost_func</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">300.</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.arrive_pax-4027"><a href="#AirlinePaxHandler.arrive_pax-4027"><span class="linenos">4027</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4028"><a href="#AirlinePaxHandler.arrive_pax-4028"><span class="linenos">4028</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="n">soft_cost</span>
</span><span id="AirlinePaxHandler.arrive_pax-4029"><a href="#AirlinePaxHandler.arrive_pax-4029"><span class="linenos">4029</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has triggered a soft cost for delay (&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4030"><a href="#AirlinePaxHandler.arrive_pax-4030"><span class="linenos">4030</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4031"><a href="#AirlinePaxHandler.arrive_pax-4031"><span class="linenos">4031</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">entitled</span> <span class="ow">or</span> <span class="n">pax</span><span class="o">.</span><span class="n">force_entitled</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4032"><a href="#AirlinePaxHandler.arrive_pax-4032"><span class="linenos">4032</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is entitled to compensation. Total arrival delay:&#39;</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">,</span> <span class="s1">&#39;with a distance:&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">distance</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4033"><a href="#AirlinePaxHandler.arrive_pax-4033"><span class="linenos">4033</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">compensation</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">tot_arrival_delay</span><span class="p">)</span>  <span class="c1"># * pax.n_pax * self.agent.compensation_uptake`</span>
</span><span id="AirlinePaxHandler.arrive_pax-4034"><a href="#AirlinePaxHandler.arrive_pax-4034"><span class="linenos">4034</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4035"><a href="#AirlinePaxHandler.arrive_pax-4035"><span class="linenos">4035</span></a>			<span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlinePaxHandler.arrive_pax-4036"><a href="#AirlinePaxHandler.arrive_pax-4036"><span class="linenos">4036</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4037"><a href="#AirlinePaxHandler.arrive_pax-4037"><span class="linenos">4037</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="n">compensation</span>
</span><span id="AirlinePaxHandler.arrive_pax-4038"><a href="#AirlinePaxHandler.arrive_pax-4038"><span class="linenos">4038</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;have been compensated for delay (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;euros in total)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4039"><a href="#AirlinePaxHandler.arrive_pax-4039"><span class="linenos">4039</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4040"><a href="#AirlinePaxHandler.arrive_pax-4040"><span class="linenos">4040</span></a>		<span class="k">if</span> <span class="n">compensation</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">soft_cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4041"><a href="#AirlinePaxHandler.arrive_pax-4041"><span class="linenos">4041</span></a>			<span class="c1"># Find out who is mainly responsible for the compensation</span>
</span><span id="AirlinePaxHandler.arrive_pax-4042"><a href="#AirlinePaxHandler.arrive_pax-4042"><span class="linenos">4042</span></a>			<span class="c1"># Note: if it is because of a cancelled flight,</span>
</span><span id="AirlinePaxHandler.arrive_pax-4043"><a href="#AirlinePaxHandler.arrive_pax-4043"><span class="linenos">4043</span></a>			<span class="c1"># the blame is already given.</span>
</span><span id="AirlinePaxHandler.arrive_pax-4044"><a href="#AirlinePaxHandler.arrive_pax-4044"><span class="linenos">4044</span></a>			<span class="c1"># The following function is cancelling the compensation if it finds</span>
</span><span id="AirlinePaxHandler.arrive_pax-4045"><a href="#AirlinePaxHandler.arrive_pax-4045"><span class="linenos">4045</span></a>			<span class="c1"># that the pax is ultimately responsible for its delay.</span>
</span><span id="AirlinePaxHandler.arrive_pax-4046"><a href="#AirlinePaxHandler.arrive_pax-4046"><span class="linenos">4046</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.arrive_pax-4047"><a href="#AirlinePaxHandler.arrive_pax-4047"><span class="linenos">4047</span></a>
</span><span id="AirlinePaxHandler.arrive_pax-4048"><a href="#AirlinePaxHandler.arrive_pax-4048"><span class="linenos">4048</span></a>		<span class="c1"># Record the real itinerary. `If&#39; is here to avoid flag modified if true itinerary.</span>
</span><span id="AirlinePaxHandler.arrive_pax-4049"><a href="#AirlinePaxHandler.arrive_pax-4049"><span class="linenos">4049</span></a>		<span class="c1"># KEEP THIS BIT AT THE END THE METHOD UNLESS YOU KNOW WHAT YOU ARE DOING</span>
</span><span id="AirlinePaxHandler.arrive_pax-4050"><a href="#AirlinePaxHandler.arrive_pax-4050"><span class="linenos">4050</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">()</span> <span class="o">!=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.arrive_pax-4051"><a href="#AirlinePaxHandler.arrive_pax-4051"><span class="linenos">4051</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">give_new_itinerary</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_itinerary_so_far</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>If overnight is True, the passenger need to be cared for for the night.
WARNING: this method assumes that it is executed exactly when at the in-block
time of the last flight.
Note: paxs are paid first, then costs for airlines are computed.</p>
</div>


                            </div>
                            <div id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost" class="classattr">
                                        <input id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_blame_for_compensation_and_soft_cost</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">compensation</span>, </span><span class="param"><span class="n">soft_cost</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4053"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4053"><span class="linenos">4053</span></a>	<span class="k">def</span> <span class="nf">find_blame_for_compensation_and_soft_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4054"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4054"><span class="linenos">4054</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;tries to find the flight to blame for compensation and soft cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4055"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4055"><span class="linenos">4055</span></a>		<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4056"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4056"><span class="linenos">4056</span></a>			<span class="c1"># if should be entered only if pax was not on a flight which has</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4057"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4057"><span class="linenos">4057</span></a>			<span class="c1"># been cancelled</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4058"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4058"><span class="linenos">4058</span></a>			<span class="c1"># if len(pax.old_itineraries) == 0 or :</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4059"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4059"><span class="linenos">4059</span></a>			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4060"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4060"><span class="linenos">4060</span></a>				<span class="c1"># Passenger has followed its planned itinerary</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4061"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4061"><span class="linenos">4061</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;did not miss a flight, it tries to blame its last flight first (&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4062"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4062"><span class="linenos">4062</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4063"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4063"><span class="linenos">4063</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4064"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4064"><span class="linenos">4064</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;missed at least a flight, it tries to blame the last flight of the original itinerary first&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4065"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4065"><span class="linenos">4065</span></a>				<span class="c1"># Passenger has missed a flight at some point. Two cases can happen: either</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4066"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4066"><span class="linenos">4066</span></a>				<span class="c1"># they were reallocated, or they were not.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4067"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4067"><span class="linenos">4067</span></a>				<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4068"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4068"><span class="linenos">4068</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has at least one old itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4069"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4069"><span class="linenos">4069</span></a>					<span class="c1"># In this case, the pax has been reallocated at least once.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4070"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4070"><span class="linenos">4070</span></a>					<span class="c1"># Find the last flight taken by the pax in the original itinerary</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4071"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4071"><span class="linenos">4071</span></a>					<span class="n">original_itinerary</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4072"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4072"><span class="linenos">4072</span></a>					<span class="c1"># Find idx of first flight different in original and actual itinerary</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4073"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4073"><span class="linenos">4073</span></a>					<span class="c1"># #idx = next(i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]!=pax.itinerary[i])</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4074"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4074"><span class="linenos">4074</span></a>					<span class="c1"># try:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4075"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4075"><span class="linenos">4075</span></a>					<span class="c1">#     idxs = [i for i in range(min(len(original_itinerary), len(pax.itinerary))) if original_itinerary[i]==pax.itinerary[i]]</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4076"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4076"><span class="linenos">4076</span></a>					<span class="c1">#     idx = idxs[-1]</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4077"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4077"><span class="linenos">4077</span></a>					<span class="c1"># except:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4078"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4078"><span class="linenos">4078</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;, original_itinerary, pax.itinerary, pax.old_itineraries)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4079"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4079"><span class="linenos">4079</span></a>					<span class="c1">#     aprint(pax, &#39;BAM&#39;)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4080"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4080"><span class="linenos">4080</span></a>					<span class="c1">#     raise</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4081"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4081"><span class="linenos">4081</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4082"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4082"><span class="linenos">4082</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4083"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4083"><span class="linenos">4083</span></a>					<span class="k">while</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">original_itinerary</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">))))</span> <span class="ow">and</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4084"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4084"><span class="linenos">4084</span></a>						<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4085"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4085"><span class="linenos">4085</span></a>					<span class="n">idx</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4086"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4086"><span class="linenos">4086</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4087"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4087"><span class="linenos">4087</span></a>					<span class="k">try</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4088"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4088"><span class="linenos">4088</span></a>						<span class="k">assert</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4089"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4089"><span class="linenos">4089</span></a>					<span class="k">except</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4090"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4090"><span class="linenos">4090</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">original_itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">old_itineraries</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4091"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4091"><span class="linenos">4091</span></a>						<span class="n">aprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;DEBUG&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4092"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4092"><span class="linenos">4092</span></a>						<span class="k">raise</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4093"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4093"><span class="linenos">4093</span></a>					<span class="c1"># Rmq: idx should not be -1, because it would mean that they missed the first</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4094"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4094"><span class="linenos">4094</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4095"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4095"><span class="linenos">4095</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4096"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4096"><span class="linenos">4096</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4097"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4097"><span class="linenos">4097</span></a>					<span class="c1"># Last common flight between origin and actual itinerary</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4098"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4098"><span class="linenos">4098</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">original_itinerary</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>  <span class="c1"># [idx-1]</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4099"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4099"><span class="linenos">4099</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4100"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4100"><span class="linenos">4100</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;has no old itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4101"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4101"><span class="linenos">4101</span></a>					<span class="c1"># In this case, the pax has not been reallocated once (it missed its flight and)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4102"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4102"><span class="linenos">4102</span></a>					<span class="c1"># could not find a suitable replacement.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4103"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4103"><span class="linenos">4103</span></a>					<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>    <span class="c1"># this list should have exactly one element</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4104"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4104"><span class="linenos">4104</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4105"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4105"><span class="linenos">4105</span></a>					<span class="c1"># Find the idx of the missed flight.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4106"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4106"><span class="linenos">4106</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4107"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4107"><span class="linenos">4107</span></a>					<span class="c1"># Rmq: idx should not be 0, because it would mean that they missed the first</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4108"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4108"><span class="linenos">4108</span></a>					<span class="c1"># flight, which is only possible if it has been cancelled. In the latter case,</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4109"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4109"><span class="linenos">4109</span></a>					<span class="c1"># the cancelled flight has already been blamed.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4110"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4110"><span class="linenos">4110</span></a>					<span class="c1"># The last flight taken is the one before the missed flight.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4111"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4111"><span class="linenos">4111</span></a>					<span class="n">last_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">itinerary</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4112"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4112"><span class="linenos">4112</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4113"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4113"><span class="linenos">4113</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;took the flight&#39;</span><span class="p">,</span> <span class="n">last_flight</span><span class="p">,</span> <span class="s1">&#39;last in its original itinerary&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4114"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4114"><span class="linenos">4114</span></a>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4115"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4115"><span class="linenos">4115</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">last_flight</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4116"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4116"><span class="linenos">4116</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4117"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4117"><span class="linenos">4117</span></a>			<span class="k">if</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">!=</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4118"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4118"><span class="linenos">4118</span></a>				<span class="c1"># self.blame_compensation_of_pax(pax, compensation)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4119"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4119"><span class="linenos">4119</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4120"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4120"><span class="linenos">4120</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4121"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4121"><span class="linenos">4121</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4122"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4122"><span class="linenos">4122</span></a>				<span class="c1"># Remove the compensation from the pax, it should not have it!</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4123"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4123"><span class="linenos">4123</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">compensation</span> <span class="o">=</span> <span class="mf">0.</span>
</span><span id="AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4124"><a href="#AirlinePaxHandler.find_blame_for_compensation_and_soft_cost-4124"><span class="linenos">4124</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">soft_cost</span> <span class="o">=</span> <span class="mf">0.</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.pay_pax_cost" class="classattr">
                                        <input id="AirlinePaxHandler.pay_pax_cost-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pay_pax_cost</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">cost</span>, </span><span class="param"><span class="n">cost_type</span>, </span><span class="param"><span class="n">flight_uid</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.pay_pax_cost-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.pay_pax_cost"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.pay_pax_cost-4126"><a href="#AirlinePaxHandler.pay_pax_cost-4126"><span class="linenos">4126</span></a>	<span class="k">def</span> <span class="nf">pay_pax_cost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">,</span> <span class="n">flight_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4127"><a href="#AirlinePaxHandler.pay_pax_cost-4127"><span class="linenos">4127</span></a>		<span class="k">if</span> <span class="n">cost</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4128"><a href="#AirlinePaxHandler.pay_pax_cost-4128"><span class="linenos">4128</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4129"><a href="#AirlinePaxHandler.pay_pax_cost-4129"><span class="linenos">4129</span></a>				<span class="k">if</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4130"><a href="#AirlinePaxHandler.pay_pax_cost-4130"><span class="linenos">4130</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4131"><a href="#AirlinePaxHandler.pay_pax_cost-4131"><span class="linenos">4131</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;transfer_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4132"><a href="#AirlinePaxHandler.pay_pax_cost-4132"><span class="linenos">4132</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_transfer_cost_on</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4133"><a href="#AirlinePaxHandler.pay_pax_cost-4133"><span class="linenos">4133</span></a>				<span class="k">elif</span> <span class="n">cost_type</span> <span class="o">==</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4134"><a href="#AirlinePaxHandler.pay_pax_cost-4134"><span class="linenos">4134</span></a>					<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4135"><a href="#AirlinePaxHandler.pay_pax_cost-4135"><span class="linenos">4135</span></a>
</span><span id="AirlinePaxHandler.pay_pax_cost-4136"><a href="#AirlinePaxHandler.pay_pax_cost-4136"><span class="linenos">4136</span></a>			<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">own_flights</span><span class="p">():</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4137"><a href="#AirlinePaxHandler.pay_pax_cost-4137"><span class="linenos">4137</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4138"><a href="#AirlinePaxHandler.pay_pax_cost-4138"><span class="linenos">4138</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.pay_pax_cost-4139"><a href="#AirlinePaxHandler.pay_pax_cost-4139"><span class="linenos">4139</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">send_cost_blame</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.follow_blame_flight" class="classattr">
                                        <input id="AirlinePaxHandler.follow_blame_flight-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">follow_blame_flight</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">compensation</span>, </span><span class="param"><span class="n">soft_cost</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.follow_blame_flight-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.follow_blame_flight"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.follow_blame_flight-4141"><a href="#AirlinePaxHandler.follow_blame_flight-4141"><span class="linenos">4141</span></a>	<span class="k">def</span> <span class="nf">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4142"><a href="#AirlinePaxHandler.follow_blame_flight-4142"><span class="linenos">4142</span></a>		<span class="k">if</span> <span class="n">flight_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4143"><a href="#AirlinePaxHandler.follow_blame_flight-4143"><span class="linenos">4143</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send_follow_blame_request</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4144"><a href="#AirlinePaxHandler.follow_blame_flight-4144"><span class="linenos">4144</span></a>		<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4145"><a href="#AirlinePaxHandler.follow_blame_flight-4145"><span class="linenos">4145</span></a>			<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4146"><a href="#AirlinePaxHandler.follow_blame_flight-4146"><span class="linenos">4146</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The main reason for delay of&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4147"><a href="#AirlinePaxHandler.follow_blame_flight-4147"><span class="linenos">4147</span></a>				<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;main_reason_delay&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;RD&#39;</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4148"><a href="#AirlinePaxHandler.follow_blame_flight-4148"><span class="linenos">4148</span></a>					<span class="c1"># If main cause is reactionary delay, find previous flight using the</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4149"><a href="#AirlinePaxHandler.follow_blame_flight-4149"><span class="linenos">4149</span></a>					<span class="c1"># same aircraft and redo the same procedure</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4150"><a href="#AirlinePaxHandler.follow_blame_flight-4150"><span class="linenos">4150</span></a>					<span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4151"><a href="#AirlinePaxHandler.follow_blame_flight-4151"><span class="linenos">4151</span></a>					<span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4152"><a href="#AirlinePaxHandler.follow_blame_flight-4152"><span class="linenos">4152</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;tries to blame the previous flight (&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4153"><a href="#AirlinePaxHandler.follow_blame_flight-4153"><span class="linenos">4153</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;aircraft&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">planned_queue_uids</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4154"><a href="#AirlinePaxHandler.follow_blame_flight-4154"><span class="linenos">4154</span></a>												<span class="n">pax</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4155"><a href="#AirlinePaxHandler.follow_blame_flight-4155"><span class="linenos">4155</span></a>												<span class="n">compensation</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4156"><a href="#AirlinePaxHandler.follow_blame_flight-4156"><span class="linenos">4156</span></a>												<span class="n">soft_cost</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4157"><a href="#AirlinePaxHandler.follow_blame_flight-4157"><span class="linenos">4157</span></a>					<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4158"><a href="#AirlinePaxHandler.follow_blame_flight-4158"><span class="linenos">4158</span></a>						<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was the first one, it gets the blame&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4159"><a href="#AirlinePaxHandler.follow_blame_flight-4159"><span class="linenos">4159</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4160"><a href="#AirlinePaxHandler.follow_blame_flight-4160"><span class="linenos">4160</span></a>						<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4161"><a href="#AirlinePaxHandler.follow_blame_flight-4161"><span class="linenos">4161</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4162"><a href="#AirlinePaxHandler.follow_blame_flight-4162"><span class="linenos">4162</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4163"><a href="#AirlinePaxHandler.follow_blame_flight-4163"><span class="linenos">4163</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4164"><a href="#AirlinePaxHandler.follow_blame_flight-4164"><span class="linenos">4164</span></a>					<span class="n">mprint</span><span class="p">(</span><span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;gets the blame&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4165"><a href="#AirlinePaxHandler.follow_blame_flight-4165"><span class="linenos">4165</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4166"><a href="#AirlinePaxHandler.follow_blame_flight-4166"><span class="linenos">4166</span></a>					<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4167"><a href="#AirlinePaxHandler.follow_blame_flight-4167"><span class="linenos">4167</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4168"><a href="#AirlinePaxHandler.follow_blame_flight-4168"><span class="linenos">4168</span></a>					<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4169"><a href="#AirlinePaxHandler.follow_blame_flight-4169"><span class="linenos">4169</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4170"><a href="#AirlinePaxHandler.follow_blame_flight-4170"><span class="linenos">4170</span></a>				<span class="c1"># This can happen either if the flight was cancelled of if it did not have</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4171"><a href="#AirlinePaxHandler.follow_blame_flight-4171"><span class="linenos">4171</span></a>				<span class="c1"># any delay at departure.</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4172"><a href="#AirlinePaxHandler.follow_blame_flight-4172"><span class="linenos">4172</span></a>				<span class="c1"># assert self.agent.aoc_flights_info[flight_uid][&#39;status&#39;] == &#39;cancelled&#39;</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4173"><a href="#AirlinePaxHandler.follow_blame_flight-4173"><span class="linenos">4173</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;The&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;was cancelled, so it gets the blame.&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4174"><a href="#AirlinePaxHandler.follow_blame_flight-4174"><span class="linenos">4174</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_compensation_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4175"><a href="#AirlinePaxHandler.follow_blame_flight-4175"><span class="linenos">4175</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">blame_soft_cost_on</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4176"><a href="#AirlinePaxHandler.follow_blame_flight-4176"><span class="linenos">4176</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;compensation_cost&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.follow_blame_flight-4177"><a href="#AirlinePaxHandler.follow_blame_flight-4177"><span class="linenos">4177</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">pay_pax_cost</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;soft_cost&#39;</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.request_reallocate_pax" class="classattr">
                                        <input id="AirlinePaxHandler.request_reallocate_pax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_reallocate_pax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paxs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.request_reallocate_pax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.request_reallocate_pax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.request_reallocate_pax-4179"><a href="#AirlinePaxHandler.request_reallocate_pax-4179"><span class="linenos">4179</span></a>	<span class="k">def</span> <span class="nf">request_reallocate_pax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4180"><a href="#AirlinePaxHandler.request_reallocate_pax-4180"><span class="linenos">4180</span></a>		<span class="c1"># This is an internal message.</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4181"><a href="#AirlinePaxHandler.request_reallocate_pax-4181"><span class="linenos">4181</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4182"><a href="#AirlinePaxHandler.request_reallocate_pax-4182"><span class="linenos">4182</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4183"><a href="#AirlinePaxHandler.request_reallocate_pax-4183"><span class="linenos">4183</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">uid</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4184"><a href="#AirlinePaxHandler.request_reallocate_pax-4184"><span class="linenos">4184</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;reallocation_pax_request&#39;</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4185"><a href="#AirlinePaxHandler.request_reallocate_pax-4185"><span class="linenos">4185</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs</span><span class="p">}</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4186"><a href="#AirlinePaxHandler.request_reallocate_pax-4186"><span class="linenos">4186</span></a>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4187"><a href="#AirlinePaxHandler.request_reallocate_pax-4187"><span class="linenos">4187</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;(APH role) sends (to itself) a reallocation pax request for paxs&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4188"><a href="#AirlinePaxHandler.request_reallocate_pax-4188"><span class="linenos">4188</span></a>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4189"><a href="#AirlinePaxHandler.request_reallocate_pax-4189"><span class="linenos">4189</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">wait_for_reallocation_pax_request</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4190"><a href="#AirlinePaxHandler.request_reallocate_pax-4190"><span class="linenos">4190</span></a>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4191"><a href="#AirlinePaxHandler.request_reallocate_pax-4191"><span class="linenos">4191</span></a>		<span class="c1"># Uncomment the following line if you want to use central server.</span>
</span><span id="AirlinePaxHandler.request_reallocate_pax-4192"><a href="#AirlinePaxHandler.request_reallocate_pax-4192"><span class="linenos">4192</span></a>		<span class="c1"># self.send(msg)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.request_connecting_times" class="classattr">
                                        <input id="AirlinePaxHandler.request_connecting_times-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_connecting_times</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">connection_type</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.request_connecting_times-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.request_connecting_times"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.request_connecting_times-4194"><a href="#AirlinePaxHandler.request_connecting_times-4194"><span class="linenos">4194</span></a>	<span class="k">def</span> <span class="nf">request_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">connection_type</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4195"><a href="#AirlinePaxHandler.request_connecting_times-4195"><span class="linenos">4195</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4196"><a href="#AirlinePaxHandler.request_connecting_times-4196"><span class="linenos">4196</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4197"><a href="#AirlinePaxHandler.request_connecting_times-4197"><span class="linenos">4197</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;connecting_times_request&#39;</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4198"><a href="#AirlinePaxHandler.request_connecting_times-4198"><span class="linenos">4198</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4199"><a href="#AirlinePaxHandler.request_connecting_times-4199"><span class="linenos">4199</span></a>						<span class="s1">&#39;connection_type&#39;</span><span class="p">:</span> <span class="n">connection_type</span><span class="p">}</span>
</span><span id="AirlinePaxHandler.request_connecting_times-4200"><a href="#AirlinePaxHandler.request_connecting_times-4200"><span class="linenos">4200</span></a>
</span><span id="AirlinePaxHandler.request_connecting_times-4201"><a href="#AirlinePaxHandler.request_connecting_times-4201"><span class="linenos">4201</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.request_pax_connection_handling" class="classattr">
                                        <input id="AirlinePaxHandler.request_pax_connection_handling-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">request_pax_connection_handling</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paxs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.request_pax_connection_handling-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.request_pax_connection_handling"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.request_pax_connection_handling-4203"><a href="#AirlinePaxHandler.request_pax_connection_handling-4203"><span class="linenos">4203</span></a>	<span class="k">def</span> <span class="nf">request_pax_connection_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4204"><a href="#AirlinePaxHandler.request_pax_connection_handling-4204"><span class="linenos">4204</span></a>		<span class="n">pax_per_aoc</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4205"><a href="#AirlinePaxHandler.request_pax_connection_handling-4205"><span class="linenos">4205</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4206"><a href="#AirlinePaxHandler.request_pax_connection_handling-4206"><span class="linenos">4206</span></a>			<span class="c1"># aoc_uid = self.flight_registery[pax.itinerary[pax.idx_current_flight+1]][&#39;aoc_uid&#39;]</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4207"><a href="#AirlinePaxHandler.request_pax_connection_handling-4207"><span class="linenos">4207</span></a>			<span class="n">aoc_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_airline_of_flight</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">())</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4208"><a href="#AirlinePaxHandler.request_pax_connection_handling-4208"><span class="linenos">4208</span></a>			<span class="n">pax_per_aoc</span><span class="p">[</span><span class="n">aoc_uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aoc_uid</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">pax</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4209"><a href="#AirlinePaxHandler.request_pax_connection_handling-4209"><span class="linenos">4209</span></a>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4210"><a href="#AirlinePaxHandler.request_pax_connection_handling-4210"><span class="linenos">4210</span></a>		<span class="k">for</span> <span class="n">aoc_uid</span><span class="p">,</span> <span class="n">paxs2</span> <span class="ow">in</span> <span class="n">pax_per_aoc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4211"><a href="#AirlinePaxHandler.request_pax_connection_handling-4211"><span class="linenos">4211</span></a>			<span class="n">new_msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4212"><a href="#AirlinePaxHandler.request_pax_connection_handling-4212"><span class="linenos">4212</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;pax_connection_handling&#39;</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4213"><a href="#AirlinePaxHandler.request_pax_connection_handling-4213"><span class="linenos">4213</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aoc_uid</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4214"><a href="#AirlinePaxHandler.request_pax_connection_handling-4214"><span class="linenos">4214</span></a>			<span class="n">new_msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paxs&#39;</span><span class="p">:</span> <span class="n">paxs2</span><span class="p">}</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4215"><a href="#AirlinePaxHandler.request_pax_connection_handling-4215"><span class="linenos">4215</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending pax connection handling request for paxs:&#39;</span><span class="p">,</span> <span class="n">paxs2</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.request_pax_connection_handling-4216"><a href="#AirlinePaxHandler.request_pax_connection_handling-4216"><span class="linenos">4216</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">new_msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.handle_pax_connection" class="classattr">
                                        <input id="AirlinePaxHandler.handle_pax_connection-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_pax_connection</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">paxs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.handle_pax_connection-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.handle_pax_connection"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.handle_pax_connection-4218"><a href="#AirlinePaxHandler.handle_pax_connection-4218"><span class="linenos">4218</span></a>	<span class="k">def</span> <span class="nf">handle_pax_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paxs</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4219"><a href="#AirlinePaxHandler.handle_pax_connection-4219"><span class="linenos">4219</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles the paxs:&#39;</span><span class="p">,</span> <span class="n">paxs</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4220"><a href="#AirlinePaxHandler.handle_pax_connection-4220"><span class="linenos">4220</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4221"><a href="#AirlinePaxHandler.handle_pax_connection-4221"><span class="linenos">4221</span></a>		<span class="n">missed_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4222"><a href="#AirlinePaxHandler.handle_pax_connection-4222"><span class="linenos">4222</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4223"><a href="#AirlinePaxHandler.handle_pax_connection-4223"><span class="linenos">4223</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4224"><a href="#AirlinePaxHandler.handle_pax_connection-4224"><span class="linenos">4224</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4225"><a href="#AirlinePaxHandler.handle_pax_connection-4225"><span class="linenos">4225</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4226"><a href="#AirlinePaxHandler.handle_pax_connection-4226"><span class="linenos">4226</span></a>			<span class="c1"># Remember the theoretical departure for duty of care</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4227"><a href="#AirlinePaxHandler.handle_pax_connection-4227"><span class="linenos">4227</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">sobt_next_flight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;sobt&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4228"><a href="#AirlinePaxHandler.handle_pax_connection-4228"><span class="linenos">4228</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4229"><a href="#AirlinePaxHandler.handle_pax_connection-4229"><span class="linenos">4229</span></a>			<span class="c1"># Compute the connecting times for these pax.</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4230"><a href="#AirlinePaxHandler.handle_pax_connection-4230"><span class="linenos">4230</span></a>			<span class="n">int1</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4231"><a href="#AirlinePaxHandler.handle_pax_connection-4231"><span class="linenos">4231</span></a>			<span class="n">int2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;international&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4232"><a href="#AirlinePaxHandler.handle_pax_connection-4232"><span class="linenos">4232</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">previous_flight_international</span> <span class="o">=</span> <span class="n">int2</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4233"><a href="#AirlinePaxHandler.handle_pax_connection-4233"><span class="linenos">4233</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4234"><a href="#AirlinePaxHandler.handle_pax_connection-4234"><span class="linenos">4234</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_connecting_times</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="p">(</span><span class="n">int1</span><span class="p">,</span> <span class="n">int2</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4235"><a href="#AirlinePaxHandler.handle_pax_connection-4235"><span class="linenos">4235</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4236"><a href="#AirlinePaxHandler.handle_pax_connection-4236"><span class="linenos">4236</span></a>			<span class="c1"># Check next flight has already departed or is cancelled.</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4237"><a href="#AirlinePaxHandler.handle_pax_connection-4237"><span class="linenos">4237</span></a>			<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span> \
</span><span id="AirlinePaxHandler.handle_pax_connection-4238"><a href="#AirlinePaxHandler.handle_pax_connection-4238"><span class="linenos">4238</span></a>				<span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4239"><a href="#AirlinePaxHandler.handle_pax_connection-4239"><span class="linenos">4239</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is added to pax with missed connection list for&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">next_flight</span><span class="p">),</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4240"><a href="#AirlinePaxHandler.handle_pax_connection-4240"><span class="linenos">4240</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;push_back_event&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">processed</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4241"><a href="#AirlinePaxHandler.handle_pax_connection-4241"><span class="linenos">4241</span></a>						<span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">next_flight</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cancelled&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4242"><a href="#AirlinePaxHandler.handle_pax_connection-4242"><span class="linenos">4242</span></a>				<span class="n">missed_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4243"><a href="#AirlinePaxHandler.handle_pax_connection-4243"><span class="linenos">4243</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">missed_flights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_flight</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4244"><a href="#AirlinePaxHandler.handle_pax_connection-4244"><span class="linenos">4244</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4245"><a href="#AirlinePaxHandler.handle_pax_connection-4245"><span class="linenos">4245</span></a>				<span class="c1"># Try to make it to the next flight. The active flight is reverted to the</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4246"><a href="#AirlinePaxHandler.handle_pax_connection-4246"><span class="linenos">4246</span></a>				<span class="c1"># previous one if the pax does not make it.</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4247"><a href="#AirlinePaxHandler.handle_pax_connection-4247"><span class="linenos">4247</span></a>				<span class="c1"># pax.idx_current_flight += 1</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4248"><a href="#AirlinePaxHandler.handle_pax_connection-4248"><span class="linenos">4248</span></a>				<span class="c1"># pax.active_flight = pax.itinerary[pax.idx_current_flight]</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4249"><a href="#AirlinePaxHandler.handle_pax_connection-4249"><span class="linenos">4249</span></a>				<span class="n">pax</span><span class="o">.</span><span class="n">in_transit_to</span> <span class="o">=</span> <span class="n">next_flight</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4250"><a href="#AirlinePaxHandler.handle_pax_connection-4250"><span class="linenos">4250</span></a>
</span><span id="AirlinePaxHandler.handle_pax_connection-4251"><a href="#AirlinePaxHandler.handle_pax_connection-4251"><span class="linenos">4251</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4252"><a href="#AirlinePaxHandler.handle_pax_connection-4252"><span class="linenos">4252</span></a>			<span class="c1"># mprint(&#39;Pax who missed their connection at arrival of flight&#39;, missed_connecting_pax[0].itinerary[missed_connecting_pax[0].idx_current_flight], &#39;:&#39;, missed_connecting_pax)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4253"><a href="#AirlinePaxHandler.handle_pax_connection-4253"><span class="linenos">4253</span></a>			<span class="n">mprint</span><span class="p">(</span><span class="s1">&#39;Pax who missed their connection at arrival of flight&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_last_flight</span><span class="p">(),</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">missed_connecting_pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.handle_pax_connection-4254"><a href="#AirlinePaxHandler.handle_pax_connection-4254"><span class="linenos">4254</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_reallocate_pax</span><span class="p">(</span><span class="n">missed_connecting_pax</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.send_cost_blame" class="classattr">
                                        <input id="AirlinePaxHandler.send_cost_blame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_cost_blame</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">cost</span>, </span><span class="param"><span class="n">cost_type</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.send_cost_blame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.send_cost_blame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.send_cost_blame-4256"><a href="#AirlinePaxHandler.send_cost_blame-4256"><span class="linenos">4256</span></a>	<span class="k">def</span> <span class="nf">send_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4257"><a href="#AirlinePaxHandler.send_cost_blame-4257"><span class="linenos">4257</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending cost blame to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span> <span class="s1">&#39;for cost:&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">,</span> <span class="n">cost_type</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4258"><a href="#AirlinePaxHandler.send_cost_blame-4258"><span class="linenos">4258</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4259"><a href="#AirlinePaxHandler.send_cost_blame-4259"><span class="linenos">4259</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4260"><a href="#AirlinePaxHandler.send_cost_blame-4260"><span class="linenos">4260</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cost_blame&#39;</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4261"><a href="#AirlinePaxHandler.send_cost_blame-4261"><span class="linenos">4261</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">cost</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4262"><a href="#AirlinePaxHandler.send_cost_blame-4262"><span class="linenos">4262</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4263"><a href="#AirlinePaxHandler.send_cost_blame-4263"><span class="linenos">4263</span></a>						<span class="s1">&#39;cost_type&#39;</span><span class="p">:</span> <span class="n">cost_type</span><span class="p">}</span>
</span><span id="AirlinePaxHandler.send_cost_blame-4264"><a href="#AirlinePaxHandler.send_cost_blame-4264"><span class="linenos">4264</span></a>
</span><span id="AirlinePaxHandler.send_cost_blame-4265"><a href="#AirlinePaxHandler.send_cost_blame-4265"><span class="linenos">4265</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.send_follow_blame_request" class="classattr">
                                        <input id="AirlinePaxHandler.send_follow_blame_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">send_follow_blame_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">flight_uid</span>, </span><span class="param"><span class="n">pax</span>, </span><span class="param"><span class="n">compensation</span>, </span><span class="param"><span class="n">soft_cost</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.send_follow_blame_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.send_follow_blame_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.send_follow_blame_request-4267"><a href="#AirlinePaxHandler.send_follow_blame_request-4267"><span class="linenos">4267</span></a>	<span class="k">def</span> <span class="nf">send_follow_blame_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flight_uid</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4268"><a href="#AirlinePaxHandler.send_follow_blame_request-4268"><span class="linenos">4268</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is sending follow blame request to:&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">),</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4269"><a href="#AirlinePaxHandler.send_follow_blame_request-4269"><span class="linenos">4269</span></a>				<span class="s1">&#39;for compensation:&#39;</span><span class="p">,</span> <span class="n">compensation</span><span class="p">,</span> <span class="s1">&#39;and soft cost:&#39;</span><span class="p">,</span> <span class="n">soft_cost</span><span class="p">,</span> <span class="s1">&#39;of &#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4270"><a href="#AirlinePaxHandler.send_follow_blame_request-4270"><span class="linenos">4270</span></a>		<span class="n">msg</span> <span class="o">=</span> <span class="n">Letter</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4271"><a href="#AirlinePaxHandler.send_follow_blame_request-4271"><span class="linenos">4271</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flight_uid</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4272"><a href="#AirlinePaxHandler.send_follow_blame_request-4272"><span class="linenos">4272</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;follow_blame&#39;</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4273"><a href="#AirlinePaxHandler.send_follow_blame_request-4273"><span class="linenos">4273</span></a>		<span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;compensation&#39;</span><span class="p">:</span> <span class="n">compensation</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4274"><a href="#AirlinePaxHandler.send_follow_blame_request-4274"><span class="linenos">4274</span></a>						<span class="s1">&#39;flight_uid&#39;</span><span class="p">:</span> <span class="n">flight_uid</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4275"><a href="#AirlinePaxHandler.send_follow_blame_request-4275"><span class="linenos">4275</span></a>						<span class="s1">&#39;soft_cost&#39;</span><span class="p">:</span> <span class="n">soft_cost</span><span class="p">,</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4276"><a href="#AirlinePaxHandler.send_follow_blame_request-4276"><span class="linenos">4276</span></a>						<span class="s1">&#39;pax&#39;</span><span class="p">:</span> <span class="n">pax</span><span class="p">}</span>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4277"><a href="#AirlinePaxHandler.send_follow_blame_request-4277"><span class="linenos">4277</span></a>
</span><span id="AirlinePaxHandler.send_follow_blame_request-4278"><a href="#AirlinePaxHandler.send_follow_blame_request-4278"><span class="linenos">4278</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.wait_for_connecting_times" class="classattr">
                                        <input id="AirlinePaxHandler.wait_for_connecting_times-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_connecting_times</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.wait_for_connecting_times-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.wait_for_connecting_times"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.wait_for_connecting_times-4280"><a href="#AirlinePaxHandler.wait_for_connecting_times-4280"><span class="linenos">4280</span></a>	<span class="k">def</span> <span class="nf">wait_for_connecting_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4281"><a href="#AirlinePaxHandler.wait_for_connecting_times-4281"><span class="linenos">4281</span></a>		<span class="n">pax</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4282"><a href="#AirlinePaxHandler.wait_for_connecting_times-4282"><span class="linenos">4282</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;receives connecting times for&#39;</span><span class="p">,</span> <span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4283"><a href="#AirlinePaxHandler.wait_for_connecting_times-4283"><span class="linenos">4283</span></a>		<span class="c1"># pax.mcts.append(msg[&#39;body&#39;][&#39;mct&#39;])</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4284"><a href="#AirlinePaxHandler.wait_for_connecting_times-4284"><span class="linenos">4284</span></a>		<span class="c1"># pax.cts.append(msg[&#39;body&#39;][&#39;ct&#39;])</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4285"><a href="#AirlinePaxHandler.wait_for_connecting_times-4285"><span class="linenos">4285</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">mct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;mct&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4286"><a href="#AirlinePaxHandler.wait_for_connecting_times-4286"><span class="linenos">4286</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">ct</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_connecting_times-4287"><a href="#AirlinePaxHandler.wait_for_connecting_times-4287"><span class="linenos">4287</span></a>		<span class="n">pax</span><span class="o">.</span><span class="n">time_at_gate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;ct&#39;</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.wait_for_cost_blame" class="classattr">
                                        <input id="AirlinePaxHandler.wait_for_cost_blame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_cost_blame</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.wait_for_cost_blame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.wait_for_cost_blame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.wait_for_cost_blame-4289"><a href="#AirlinePaxHandler.wait_for_cost_blame-4289"><span class="linenos">4289</span></a>	<span class="k">def</span> <span class="nf">wait_for_cost_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.wait_for_cost_blame-4290"><a href="#AirlinePaxHandler.wait_for_cost_blame-4290"><span class="linenos">4290</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">_assume_cost</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;cost_type&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.wait_for_follow_blame" class="classattr">
                                        <input id="AirlinePaxHandler.wait_for_follow_blame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_follow_blame</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.wait_for_follow_blame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.wait_for_follow_blame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.wait_for_follow_blame-4292"><a href="#AirlinePaxHandler.wait_for_follow_blame-4292"><span class="linenos">4292</span></a>	<span class="k">def</span> <span class="nf">wait_for_follow_blame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.wait_for_follow_blame-4293"><a href="#AirlinePaxHandler.wait_for_follow_blame-4293"><span class="linenos">4293</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">follow_blame_flight</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;pax&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;compensation&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;soft_cost&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.wait_for_pax_connection_handling_request" class="classattr">
                                        <input id="AirlinePaxHandler.wait_for_pax_connection_handling_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_pax_connection_handling_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.wait_for_pax_connection_handling_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.wait_for_pax_connection_handling_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.wait_for_pax_connection_handling_request-4295"><a href="#AirlinePaxHandler.wait_for_pax_connection_handling_request-4295"><span class="linenos">4295</span></a>	<span class="k">def</span> <span class="nf">wait_for_pax_connection_handling_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.wait_for_pax_connection_handling_request-4296"><a href="#AirlinePaxHandler.wait_for_pax_connection_handling_request-4296"><span class="linenos">4296</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;received pax connection handling request from IP for paxs:&#39;</span><span class="p">,</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span><span id="AirlinePaxHandler.wait_for_pax_connection_handling_request-4297"><a href="#AirlinePaxHandler.wait_for_pax_connection_handling_request-4297"><span class="linenos">4297</span></a>		<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;paxs&#39;</span><span class="p">])</span>
</span></pre></div>


    

                            </div>
                            <div id="AirlinePaxHandler.wait_for_process_arrival_pax_request" class="classattr">
                                        <input id="AirlinePaxHandler.wait_for_process_arrival_pax_request-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_process_arrival_pax_request</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">msg</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AirlinePaxHandler.wait_for_process_arrival_pax_request-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AirlinePaxHandler.wait_for_process_arrival_pax_request"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4299"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4299"><span class="linenos">4299</span></a>	<span class="k">def</span> <span class="nf">wait_for_process_arrival_pax_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4300"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4300"><span class="linenos">4300</span></a>		<span class="n">flight_uid</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">][</span><span class="s1">&#39;flight_uid&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4301"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4301"><span class="linenos">4301</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;is considering arrival pax request for flight&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4302"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4302"><span class="linenos">4302</span></a>		<span class="n">connecting_pax_other_company</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4303"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4303"><span class="linenos">4303</span></a>		<span class="n">own_connecting_pax</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4304"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4304"><span class="linenos">4304</span></a>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4305"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4305"><span class="linenos">4305</span></a>		<span class="n">paxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;pax_on_board&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4306"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4306"><span class="linenos">4306</span></a>		<span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">paxs</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4307"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4307"><span class="linenos">4307</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">unboard_from_flight</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">get_ibt</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4308"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4308"><span class="linenos">4308</span></a>			<span class="n">pax</span><span class="o">.</span><span class="n">active_airport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="p">[</span><span class="n">flight_uid</span><span class="p">][</span><span class="s1">&#39;destination_airport_uid&#39;</span><span class="p">]</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4309"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4309"><span class="linenos">4309</span></a>			<span class="n">next_flight</span> <span class="o">=</span> <span class="n">pax</span><span class="o">.</span><span class="n">get_next_flight</span><span class="p">()</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4310"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4310"><span class="linenos">4310</span></a>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4311"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4311"><span class="linenos">4311</span></a>			<span class="c1"># Check if pax has a next flight</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4312"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4312"><span class="linenos">4312</span></a>			<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4313"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4313"><span class="linenos">4313</span></a>				<span class="n">mprint</span><span class="p">(</span><span class="n">pax</span><span class="p">,</span> <span class="s1">&#39;is connecting&#39;</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4314"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4314"><span class="linenos">4314</span></a>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4315"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4315"><span class="linenos">4315</span></a>				<span class="c1"># Check if next flight belongs to this company</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4316"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4316"><span class="linenos">4316</span></a>				<span class="k">if</span> <span class="n">next_flight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">aoc_flights_info</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4317"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4317"><span class="linenos">4317</span></a>					<span class="n">own_connecting_pax</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4318"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4318"><span class="linenos">4318</span></a>				<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4319"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4319"><span class="linenos">4319</span></a>					<span class="c1"># Find the company operating the next flight</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4320"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4320"><span class="linenos">4320</span></a>					<span class="n">connecting_pax_other_company</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4321"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4321"><span class="linenos">4321</span></a>			<span class="k">else</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4322"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4322"><span class="linenos">4322</span></a>				<span class="bp">self</span><span class="o">.</span><span class="n">arrive_pax</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4323"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4323"><span class="linenos">4323</span></a>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4324"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4324"><span class="linenos">4324</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;handles his own connecting paxs&#39;</span><span class="p">,</span> <span class="n">own_connecting_pax</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4325"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4325"><span class="linenos">4325</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4326"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4326"><span class="linenos">4326</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">handle_pax_connection</span><span class="p">(</span><span class="n">own_connecting_pax</span><span class="p">)</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4327"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4327"><span class="linenos">4327</span></a>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4328"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4328"><span class="linenos">4328</span></a>		<span class="n">mprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">agent</span><span class="p">,</span> <span class="s1">&#39;will request connection handling for the paxs&#39;</span><span class="p">,</span> <span class="n">connecting_pax_other_company</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="n">flight_str</span><span class="p">(</span><span class="n">flight_uid</span><span class="p">))</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4329"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4329"><span class="linenos">4329</span></a>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AirlinePaxHandler.wait_for_process_arrival_pax_request-4330"><a href="#AirlinePaxHandler.wait_for_process_arrival_pax_request-4330"><span class="linenos">4330</span></a>			<span class="bp">self</span><span class="o">.</span><span class="n">request_pax_connection_handling</span><span class="p">(</span><span class="n">connecting_pax_other_company</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="agent_base.html#Role">Mercury.agents.agent_base.Role</a></dt>
                                <dd id="AirlinePaxHandler.__init__" class="function"><a href="agent_base.html#Role.__init__">Role</a></dd>
                <dd id="AirlinePaxHandler.agent" class="variable"><a href="agent_base.html#Role.agent">agent</a></dd>
                <dd id="AirlinePaxHandler.send" class="function"><a href="agent_base.html#Role.send">send</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>